(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('worker_threads')) :
	typeof define === 'function' && define.amd ? define(['worker_threads'], factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, global.WPubsubClient = factory(global.worker_threads));
})(this, (function (require$$0) { 'use strict';

	var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

	function getDefaultExportFromCjs (x) {
		return x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;
	}

	var tempBVTuoBQIcnHc3zLrftD75om4yvwaTDTMNw = {exports: {}};

	(function(module,exports){(function(global,factory){module.exports=factory(require$$0);})(commonjsGlobal,function(worker_threads){function getDefaultExportFromCjs(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,'default')?x['default']:x;}var eventemitter3={exports:{}};(function(module){var has=Object.prototype.hasOwnProperty,prefix='~';/**
			   * Constructor to create a storage for our `EE` objects.
			   * An `Events` instance is a plain object whose properties are event names.
			   *
			   * @constructor
			   * @private
			   */function Events(){}//
	// We try to not inherit from `Object.prototype`. In some engines creating an
	// instance in this way is faster than calling `Object.create(null)` directly.
	// If `Object.create(null)` is not supported we prefix the event names with a
	// character to make sure that the built-in object properties are not
	// overridden or used as an attack vector.
	//
	if(Object.create){Events.prototype=Object.create(null);//
	// This hack is needed because the `__proto__` property is still inherited in
	// some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
	//
	if(!new Events().__proto__)prefix=false;}/**
			   * Representation of a single event listener.
			   *
			   * @param {Function} fn The listener function.
			   * @param {*} context The context to invoke the listener with.
			   * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
			   * @constructor
			   * @private
			   */function EE(fn,context,once){this.fn=fn;this.context=context;this.once=once||false;}/**
			   * Add a listener for a given event.
			   *
			   * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
			   * @param {(String|Symbol)} event The event name.
			   * @param {Function} fn The listener function.
			   * @param {*} context The context to invoke the listener with.
			   * @param {Boolean} once Specify if the listener is a one-time listener.
			   * @returns {EventEmitter}
			   * @private
			   */function addListener(emitter,event,fn,context,once){if(typeof fn!=='function'){throw new TypeError('The listener must be a function');}var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;if(!emitter._events[evt])emitter._events[evt]=listener,emitter._eventsCount++;else if(!emitter._events[evt].fn)emitter._events[evt].push(listener);else emitter._events[evt]=[emitter._events[evt],listener];return emitter;}/**
			   * Clear event by name.
			   *
			   * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
			   * @param {(String|Symbol)} evt The Event name.
			   * @private
			   */function clearEvent(emitter,evt){if(--emitter._eventsCount===0)emitter._events=new Events();else delete emitter._events[evt];}/**
			   * Minimal `EventEmitter` interface that is molded against the Node.js
			   * `EventEmitter` interface.
			   *
			   * @constructor
			   * @public
			   */function EventEmitter(){this._events=new Events();this._eventsCount=0;}/**
			   * Return an array listing the events for which the emitter has registered
			   * listeners.
			   *
			   * @returns {Array}
			   * @public
			   */EventEmitter.prototype.eventNames=function eventNames(){var names=[],events,name;if(this._eventsCount===0)return names;for(name in events=this._events){if(has.call(events,name))names.push(prefix?name.slice(1):name);}if(Object.getOwnPropertySymbols){return names.concat(Object.getOwnPropertySymbols(events));}return names;};/**
			   * Return the listeners registered for a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @returns {Array} The registered listeners.
			   * @public
			   */EventEmitter.prototype.listeners=function listeners(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return [];if(handlers.fn)return [handlers.fn];for(var i=0,l=handlers.length,ee=new Array(l);i<l;i++){ee[i]=handlers[i].fn;}return ee;};/**
			   * Return the number of listeners listening to a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @returns {Number} The number of listeners.
			   * @public
			   */EventEmitter.prototype.listenerCount=function listenerCount(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];if(!listeners)return 0;if(listeners.fn)return 1;return listeners.length;};/**
			   * Calls each of the listeners registered for a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @returns {Boolean} `true` if the event had listeners, else `false`.
			   * @public
			   */EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return false;var listeners=this._events[evt],len=arguments.length,args,i;if(listeners.fn){if(listeners.once)this.removeListener(event,listeners.fn,undefined,true);switch(len){case 1:return listeners.fn.call(listeners.context),true;case 2:return listeners.fn.call(listeners.context,a1),true;case 3:return listeners.fn.call(listeners.context,a1,a2),true;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),true;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),true;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),true;}for(i=1,args=new Array(len-1);i<len;i++){args[i-1]=arguments[i];}listeners.fn.apply(listeners.context,args);}else {var length=listeners.length,j;for(i=0;i<length;i++){if(listeners[i].once)this.removeListener(event,listeners[i].fn,undefined,true);switch(len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++){args[j-1]=arguments[j];}listeners[i].fn.apply(listeners[i].context,args);}}}return true;};/**
			   * Add a listener for a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @param {Function} fn The listener function.
			   * @param {*} [context=this] The context to invoke the listener with.
			   * @returns {EventEmitter} `this`.
			   * @public
			   */EventEmitter.prototype.on=function on(event,fn,context){return addListener(this,event,fn,context,false);};/**
			   * Add a one-time listener for a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @param {Function} fn The listener function.
			   * @param {*} [context=this] The context to invoke the listener with.
			   * @returns {EventEmitter} `this`.
			   * @public
			   */EventEmitter.prototype.once=function once(event,fn,context){return addListener(this,event,fn,context,true);};/**
			   * Remove the listeners of a given event.
			   *
			   * @param {(String|Symbol)} event The event name.
			   * @param {Function} fn Only remove the listeners that match this function.
			   * @param {*} context Only remove the listeners that have this context.
			   * @param {Boolean} once Only remove one-time listeners.
			   * @returns {EventEmitter} `this`.
			   * @public
			   */EventEmitter.prototype.removeListener=function removeListener(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn){clearEvent(this,evt);return this;}var listeners=this._events[evt];if(listeners.fn){if(listeners.fn===fn&&(!once||listeners.once)&&(!context||listeners.context===context)){clearEvent(this,evt);}}else {for(var i=0,events=[],length=listeners.length;i<length;i++){if(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context){events.push(listeners[i]);}}//
	// Reset the array, or remove it completely if we have no more listeners.
	//
	if(events.length)this._events[evt]=events.length===1?events[0]:events;else clearEvent(this,evt);}return this;};/**
			   * Remove all listeners, or those of the specified event.
			   *
			   * @param {(String|Symbol)} [event] The event name.
			   * @returns {EventEmitter} `this`.
			   * @public
			   */EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){var evt;if(event){evt=prefix?prefix+event:event;if(this._events[evt])clearEvent(this,evt);}else {this._events=new Events();this._eventsCount=0;}return this;};//
	// Alias methods names because people roll like that.
	//
	EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.addListener=EventEmitter.prototype.on;//
	// Expose the prefix.
	//
	EventEmitter.prefixed=prefix;//
	// Allow `EventEmitter` to be imported as module namespace.
	//
	EventEmitter.EventEmitter=EventEmitter;//
	// Expose the module.
	//
	{module.exports=EventEmitter;}})(eventemitter3);var eventemitter3Exports=eventemitter3.exports;var EventEmitter=/*@__PURE__*/getDefaultExportFromCjs(eventemitter3Exports);function isWindow(){return typeof window!=='undefined'&&typeof window.document!=='undefined';}//ww
	let ww;function protectShell(){//cEnv
	let cEnv=isWindow()?'browser':'nodejs';//check, 後續會有Nodejs或瀏覽器依賴的API例如window.atob或Buffer, 於import階段時就先行偵測跳出
	if(cEnv!=='nodejs'){return null;}function evem(){return new EventEmitter();}function genPm(){let resolve;let reject;let p=new Promise(function(){resolve=arguments[0];reject=arguments[1];});p.resolve=resolve;p.reject=reject;return p;}function genID(){let len=arguments.length>0&&arguments[0]!==undefined?arguments[0]:10;let uuid=[];let chars='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');let radix=chars.length;for(let i=0;i<len;i++)uuid[i]=chars[0|Math.random()*radix];let r=uuid.join('');return r;}function b642str(b64){//return b64
	return Buffer.from(b64,'base64').toString('utf8');//Nodejs端使用Buffer解碼 
	}//codeShow
	//codeB64, 此處需提供worker執行程式碼, 因有特殊符號轉譯困難, 故需先轉base64再使用
	let codeB64=`CgogICAgICAgIC8vaW1wb3J0IHsgcGFyZW50UG9ydCB9IGZyb20gJ3dvcmtlcl90aHJlYWRzJwogICAgICAgIGxldCB7IHBhcmVudFBvcnQgfSA9IHJlcXVpcmUoJ3dvcmtlcl90aHJlYWRzJykgLy/lm6BwYWNrYWdlLmpzb27kuI3ntaZ0eXBlPW1vZHVsZeaVheeEoeazleaUr+aPtGVzNiBpbXBvcnQsIOW+l+S9v+eUqHJlcXVpcmUKICAgICAgICAvL+iLpeimgeaWvG5vZGVqcyB3b3JrZXLlhafkvb/nlKjnhKHms5XovYnora/nmoTljp/nlJ/lpZfku7bkvovlpoJmcywg6YG/5YWN5L2/55So6aCC5bGkaW1wb3J05Yqg6LyJ5L2/55SoLCDlm6DnhKHms5XovYnora/mnIPnm7TmjqXkv53nlZkKICAgICAgICAvL+S4puWboGltcG9ydOS9jeaWvHdvcmtlcuWkluWxpOmZkOWumueCunJlcXVpcmXljYAocGFja2FnZS5qc29u5LiN57WmdHlwZT1tb2R1bGUpLCDmlYXlh7rnj77pjK/oqqTnhKHms5XovYnora8KICAgICAgICAKCid1c2Ugc3RyaWN0JzsKCnZhciByZXF1aXJlJCQwJDQgPSByZXF1aXJlKCdzdHJlYW0nKTsKdmFyIHJlcXVpcmUkJDAkMyA9IHJlcXVpcmUoJ2J1ZmZlcicpOwp2YXIgcmVxdWlyZSQkMCQyID0gcmVxdWlyZSgnZXZlbnRzJyk7CnZhciByZXF1aXJlJCQxID0gcmVxdWlyZSgndHR5Jyk7CnZhciByZXF1aXJlJCQxJDEgPSByZXF1aXJlKCd1dGlsJyk7CnZhciByZXF1aXJlJCQwJDUgPSByZXF1aXJlKCdvcycpOwp2YXIgcmVxdWlyZSQkNyA9IHJlcXVpcmUoJ3VybCcpOwp2YXIgcmVxdWlyZSQkMSQzID0gcmVxdWlyZSgnaHR0cHMnKTsKdmFyIHJlcXVpcmUkJDIgPSByZXF1aXJlKCdodHRwJyk7CnZhciByZXF1aXJlJCQxJDQgPSByZXF1aXJlKCduZXQnKTsKdmFyIHJlcXVpcmUkJDQgPSByZXF1aXJlKCd0bHMnKTsKdmFyIHJlcXVpcmUkJDEkMiA9IHJlcXVpcmUoJ2NyeXB0bycpOwp2YXIgcmVxdWlyZSQkMCQ2ID0gcmVxdWlyZSgnemxpYicpOwp2YXIgcmVxdWlyZSQkMyA9IHJlcXVpcmUoJ2RucycpOwp2YXIgcmVxdWlyZSQkNSA9IHJlcXVpcmUoJ2Fzc2VydCcpOwoKdmFyIGNvbW1vbmpzR2xvYmFsID0gdHlwZW9mIGdsb2JhbFRoaXMgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsVGhpcyA6IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnID8gd2luZG93IDogdHlwZW9mIGdsb2JhbCAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gJ3VuZGVmaW5lZCcgPyBzZWxmIDoge307CgpmdW5jdGlvbiBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyAoeCkgewoJcmV0dXJuIHggJiYgeC5fX2VzTW9kdWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4LCAnZGVmYXVsdCcpID8geFsnZGVmYXVsdCddIDogeDsKfQoKZnVuY3Rpb24gZ2V0QXVnbWVudGVkTmFtZXNwYWNlKG4pIHsKICBpZiAobi5fX2VzTW9kdWxlKSByZXR1cm4gbjsKICB2YXIgZiA9IG4uZGVmYXVsdDsKCWlmICh0eXBlb2YgZiA9PSAiZnVuY3Rpb24iKSB7CgkJdmFyIGEgPSBmdW5jdGlvbiBhICgpIHsKCQkJaWYgKHRoaXMgaW5zdGFuY2VvZiBhKSB7CgkJCQl2YXIgYXJncyA9IFtudWxsXTsKCQkJCWFyZ3MucHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwoJCQkJdmFyIEN0b3IgPSBGdW5jdGlvbi5iaW5kLmFwcGx5KGYsIGFyZ3MpOwoJCQkJcmV0dXJuIG5ldyBDdG9yKCk7CgkJCX0KCQkJcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl9OwoJCWEucHJvdG90eXBlID0gZi5wcm90b3R5cGU7CiAgfSBlbHNlIGEgPSB7fTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYSwgJ19fZXNNb2R1bGUnLCB7dmFsdWU6IHRydWV9KTsKCU9iamVjdC5rZXlzKG4pLmZvckVhY2goZnVuY3Rpb24gKGspIHsKCQl2YXIgZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iobiwgayk7CgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGEsIGssIGQuZ2V0ID8gZCA6IHsKCQkJZW51bWVyYWJsZTogdHJ1ZSwKCQkJZ2V0OiBmdW5jdGlvbiAoKSB7CgkJCQlyZXR1cm4gbltrXTsKCQkJfQoJCX0pOwoJfSk7CglyZXR1cm4gYTsKfQoKdmFyIGJ1aWxkJDEgPSB7fTsKCnZhciBtcXR0JDIgPSB7fTsKCnZhciBjbGllbnQgPSB7fTsKCnZhciB0b3BpY0FsaWFzUmVjdiA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHRvcGljQWxpYXNSZWN2LCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY2xhc3MgVG9waWNBbGlhc1JlY3YgewogIGNvbnN0cnVjdG9yKG1heCkgewogICAgdGhpcy5hbGlhc1RvVG9waWMgPSB7fTsKICAgIHRoaXMubWF4ID0gbWF4OwogIH0KICBwdXQodG9waWMsIGFsaWFzKSB7CiAgICBpZiAoYWxpYXMgPT09IDAgfHwgYWxpYXMgPiB0aGlzLm1heCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLmFsaWFzVG9Ub3BpY1thbGlhc10gPSB0b3BpYzsKICAgIHRoaXMubGVuZ3RoID0gT2JqZWN0LmtleXModGhpcy5hbGlhc1RvVG9waWMpLmxlbmd0aDsKICAgIHJldHVybiB0cnVlOwogIH0KICBnZXRUb3BpY0J5QWxpYXMoYWxpYXMpIHsKICAgIHJldHVybiB0aGlzLmFsaWFzVG9Ub3BpY1thbGlhc107CiAgfQogIGNsZWFyKCkgewogICAgdGhpcy5hbGlhc1RvVG9waWMgPSB7fTsKICB9Cn0KdG9waWNBbGlhc1JlY3YuZGVmYXVsdCA9IFRvcGljQWxpYXNSZWN2OwoKdmFyIG1xdHQkMSA9IHt9OwoKdmFyIGJsJDEgPSB7ZXhwb3J0czoge319OwoKdmFyIG91cnMgPSB7ZXhwb3J0czoge319OwoKdmFyIHN0cmVhbSQxID0ge2V4cG9ydHM6IHt9fTsKCnZhciBwcmltb3JkaWFsczsKdmFyIGhhc1JlcXVpcmVkUHJpbW9yZGlhbHM7CmZ1bmN0aW9uIHJlcXVpcmVQcmltb3JkaWFscygpIHsKICBpZiAoaGFzUmVxdWlyZWRQcmltb3JkaWFscykgcmV0dXJuIHByaW1vcmRpYWxzOwogIGhhc1JlcXVpcmVkUHJpbW9yZGlhbHMgPSAxOwoKICAvKgogICAgVGhpcyBmaWxlIGlzIGEgcmVkdWNlZCBhbmQgYWRhcHRlZCB2ZXJzaW9uIG9mIHRoZSBtYWluIGxpYi9pbnRlcm5hbC9wZXJfY29udGV4dC9wcmltb3JkaWFscy5qcyBmaWxlIGRlZmluZWQgYXQKICAJICBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvYmxvYi9tYWluL2xpYi9pbnRlcm5hbC9wZXJfY29udGV4dC9wcmltb3JkaWFscy5qcwogIAkgIERvbid0IHRyeSB0byByZXBsYWNlIHdpdGggdGhlIG9yaWdpbmFsIGZpbGUgYW5kIGtlZXAgaXQgdXAgdG8gZGF0ZSB3aXRoIHRoZSB1cHN0cmVhbSBmaWxlLgogICovCgogIC8vIFRoaXMgaXMgYSBzaW1wbGlmaWVkIHZlcnNpb24gb2YgQWdncmVnYXRlRXJyb3IKICBjbGFzcyBBZ2dyZWdhdGVFcnJvciBleHRlbmRzIEVycm9yIHsKICAgIGNvbnN0cnVjdG9yKGVycm9ycykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZXJyb3JzKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYEV4cGVjdGVkIGlucHV0IHRvIGJlIGFuIEFycmF5LCBnb3QgJHt0eXBlb2YgZXJyb3JzfWApOwogICAgICB9CiAgICAgIGxldCBtZXNzYWdlID0gJyc7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbWVzc2FnZSArPSBgICAgICR7ZXJyb3JzW2ldLnN0YWNrfVxuYDsKICAgICAgfQogICAgICBzdXBlcihtZXNzYWdlKTsKICAgICAgdGhpcy5uYW1lID0gJ0FnZ3JlZ2F0ZUVycm9yJzsKICAgICAgdGhpcy5lcnJvcnMgPSBlcnJvcnM7CiAgICB9CiAgfQogIHByaW1vcmRpYWxzID0gewogICAgQWdncmVnYXRlRXJyb3IsCiAgICBBcnJheUlzQXJyYXkoc2VsZikgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShzZWxmKTsKICAgIH0sCiAgICBBcnJheVByb3RvdHlwZUluY2x1ZGVzKHNlbGYsIGVsKSB7CiAgICAgIHJldHVybiBzZWxmLmluY2x1ZGVzKGVsKTsKICAgIH0sCiAgICBBcnJheVByb3RvdHlwZUluZGV4T2Yoc2VsZiwgZWwpIHsKICAgICAgcmV0dXJuIHNlbGYuaW5kZXhPZihlbCk7CiAgICB9LAogICAgQXJyYXlQcm90b3R5cGVKb2luKHNlbGYsIHNlcCkgewogICAgICByZXR1cm4gc2VsZi5qb2luKHNlcCk7CiAgICB9LAogICAgQXJyYXlQcm90b3R5cGVNYXAoc2VsZiwgZm4pIHsKICAgICAgcmV0dXJuIHNlbGYubWFwKGZuKTsKICAgIH0sCiAgICBBcnJheVByb3RvdHlwZVBvcChzZWxmLCBlbCkgewogICAgICByZXR1cm4gc2VsZi5wb3AoZWwpOwogICAgfSwKICAgIEFycmF5UHJvdG90eXBlUHVzaChzZWxmLCBlbCkgewogICAgICByZXR1cm4gc2VsZi5wdXNoKGVsKTsKICAgIH0sCiAgICBBcnJheVByb3RvdHlwZVNsaWNlKHNlbGYsIHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIHNlbGYuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9LAogICAgRXJyb3IsCiAgICBGdW5jdGlvblByb3RvdHlwZUNhbGwoZm4sIHRoaXNBcmdzLCAuLi5hcmdzKSB7CiAgICAgIHJldHVybiBmbi5jYWxsKHRoaXNBcmdzLCAuLi5hcmdzKTsKICAgIH0sCiAgICBGdW5jdGlvblByb3RvdHlwZVN5bWJvbEhhc0luc3RhbmNlKHNlbGYsIGluc3RhbmNlKSB7CiAgICAgIHJldHVybiBGdW5jdGlvbi5wcm90b3R5cGVbU3ltYm9sLmhhc0luc3RhbmNlXS5jYWxsKHNlbGYsIGluc3RhbmNlKTsKICAgIH0sCiAgICBNYXRoRmxvb3I6IE1hdGguZmxvb3IsCiAgICBOdW1iZXIsCiAgICBOdW1iZXJJc0ludGVnZXI6IE51bWJlci5pc0ludGVnZXIsCiAgICBOdW1iZXJJc05hTjogTnVtYmVyLmlzTmFOLAogICAgTnVtYmVyTUFYX1NBRkVfSU5URUdFUjogTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIsCiAgICBOdW1iZXJNSU5fU0FGRV9JTlRFR0VSOiBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUiwKICAgIE51bWJlclBhcnNlSW50OiBOdW1iZXIucGFyc2VJbnQsCiAgICBPYmplY3REZWZpbmVQcm9wZXJ0aWVzKHNlbGYsIHByb3BzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzZWxmLCBwcm9wcyk7CiAgICB9LAogICAgT2JqZWN0RGVmaW5lUHJvcGVydHkoc2VsZiwgbmFtZSwgcHJvcCkgewogICAgICByZXR1cm4gT2JqZWN0LmRlZmluZVByb3BlcnR5KHNlbGYsIG5hbWUsIHByb3ApOwogICAgfSwKICAgIE9iamVjdEdldE93blByb3BlcnR5RGVzY3JpcHRvcihzZWxmLCBuYW1lKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNlbGYsIG5hbWUpOwogICAgfSwKICAgIE9iamVjdEtleXMob2JqKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopOwogICAgfSwKICAgIE9iamVjdFNldFByb3RvdHlwZU9mKHRhcmdldCwgcHJvdG8pIHsKICAgICAgcmV0dXJuIE9iamVjdC5zZXRQcm90b3R5cGVPZih0YXJnZXQsIHByb3RvKTsKICAgIH0sCiAgICBQcm9taXNlLAogICAgUHJvbWlzZVByb3RvdHlwZUNhdGNoKHNlbGYsIGZuKSB7CiAgICAgIHJldHVybiBzZWxmLmNhdGNoKGZuKTsKICAgIH0sCiAgICBQcm9taXNlUHJvdG90eXBlVGhlbihzZWxmLCB0aGVuRm4sIGNhdGNoRm4pIHsKICAgICAgcmV0dXJuIHNlbGYudGhlbih0aGVuRm4sIGNhdGNoRm4pOwogICAgfSwKICAgIFByb21pc2VSZWplY3QoZXJyKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpOwogICAgfSwKICAgIFByb21pc2VSZXNvbHZlKHZhbCkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHZhbCk7CiAgICB9LAogICAgUmVmbGVjdEFwcGx5OiBSZWZsZWN0LmFwcGx5LAogICAgUmVnRXhwUHJvdG90eXBlVGVzdChzZWxmLCB2YWx1ZSkgewogICAgICByZXR1cm4gc2VsZi50ZXN0KHZhbHVlKTsKICAgIH0sCiAgICBTYWZlU2V0OiBTZXQsCiAgICBTdHJpbmcsCiAgICBTdHJpbmdQcm90b3R5cGVTbGljZShzZWxmLCBzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBzZWxmLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgfSwKICAgIFN0cmluZ1Byb3RvdHlwZVRvTG93ZXJDYXNlKHNlbGYpIHsKICAgICAgcmV0dXJuIHNlbGYudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICBTdHJpbmdQcm90b3R5cGVUb1VwcGVyQ2FzZShzZWxmKSB7CiAgICAgIHJldHVybiBzZWxmLnRvVXBwZXJDYXNlKCk7CiAgICB9LAogICAgU3RyaW5nUHJvdG90eXBlVHJpbShzZWxmKSB7CiAgICAgIHJldHVybiBzZWxmLnRyaW0oKTsKICAgIH0sCiAgICBTeW1ib2wsCiAgICBTeW1ib2xGb3I6IFN5bWJvbC5mb3IsCiAgICBTeW1ib2xBc3luY0l0ZXJhdG9yOiBTeW1ib2wuYXN5bmNJdGVyYXRvciwKICAgIFN5bWJvbEhhc0luc3RhbmNlOiBTeW1ib2wuaGFzSW5zdGFuY2UsCiAgICBTeW1ib2xJdGVyYXRvcjogU3ltYm9sLml0ZXJhdG9yLAogICAgU3ltYm9sRGlzcG9zZTogU3ltYm9sLmRpc3Bvc2UgfHwgU3ltYm9sKCdTeW1ib2wuZGlzcG9zZScpLAogICAgU3ltYm9sQXN5bmNEaXNwb3NlOiBTeW1ib2wuYXN5bmNEaXNwb3NlIHx8IFN5bWJvbCgnU3ltYm9sLmFzeW5jRGlzcG9zZScpLAogICAgVHlwZWRBcnJheVByb3RvdHlwZVNldChzZWxmLCBidWYsIGxlbikgewogICAgICByZXR1cm4gc2VsZi5zZXQoYnVmLCBsZW4pOwogICAgfSwKICAgIEJvb2xlYW4sCiAgICBVaW50OEFycmF5CiAgfTsKICByZXR1cm4gcHJpbW9yZGlhbHM7Cn0KCnZhciB1dGlsJDIgPSB7ZXhwb3J0czoge319OwoKdmFyIGluc3BlY3Q7CnZhciBoYXNSZXF1aXJlZEluc3BlY3Q7CmZ1bmN0aW9uIHJlcXVpcmVJbnNwZWN0KCkgewogIGlmIChoYXNSZXF1aXJlZEluc3BlY3QpIHJldHVybiBpbnNwZWN0OwogIGhhc1JlcXVpcmVkSW5zcGVjdCA9IDE7CgogIC8qCiAgICBUaGlzIGZpbGUgaXMgYSByZWR1Y2VkIGFuZCBhZGFwdGVkIHZlcnNpb24gb2YgdGhlIG1haW4gbGliL2ludGVybmFsL3V0aWwvaW5zcGVjdC5qcyBmaWxlIGRlZmluZWQgYXQKICAJICBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvYmxvYi9tYWluL2xpYi9pbnRlcm5hbC91dGlsL2luc3BlY3QuanMKICAJICBEb24ndCB0cnkgdG8gcmVwbGFjZSB3aXRoIHRoZSBvcmlnaW5hbCBmaWxlIGFuZCBrZWVwIGl0IHVwIHRvIGRhdGUgd2l0aCB0aGUgdXBzdHJlYW0gZmlsZS4KICAqLwogIGluc3BlY3QgPSB7CiAgICBmb3JtYXQoZm9ybWF0LCAuLi5hcmdzKSB7CiAgICAgIC8vIFNpbXBsaWZpZWQgdmVyc2lvbiBvZiBodHRwczovL25vZGVqcy5vcmcvYXBpL3V0aWwuaHRtbCN1dGlsZm9ybWF0Zm9ybWF0LWFyZ3MKICAgICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC8lKFtzZGlmal0pL2csIGZ1bmN0aW9uICguLi5bX3VudXNlZCwgdHlwZV0pIHsKICAgICAgICBjb25zdCByZXBsYWNlbWVudCA9IGFyZ3Muc2hpZnQoKTsKICAgICAgICBpZiAodHlwZSA9PT0gJ2YnKSB7CiAgICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnQudG9GaXhlZCg2KTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdqJykgewogICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlcGxhY2VtZW50KTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdzJyAmJiB0eXBlb2YgcmVwbGFjZW1lbnQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICBjb25zdCBjdG9yID0gcmVwbGFjZW1lbnQuY29uc3RydWN0b3IgIT09IE9iamVjdCA/IHJlcGxhY2VtZW50LmNvbnN0cnVjdG9yLm5hbWUgOiAnJzsKICAgICAgICAgIHJldHVybiBgJHtjdG9yfSB7fWAudHJpbSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnQudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGluc3BlY3QodmFsdWUpIHsKICAgICAgLy8gVmFzdGx5IHNpbXBsaWZpZWQgdmVyc2lvbiBvZiBodHRwczovL25vZGVqcy5vcmcvYXBpL3V0aWwuaHRtbCN1dGlsaW5zcGVjdG9iamVjdC1vcHRpb25zCiAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgIGlmICh2YWx1ZS5pbmNsdWRlcygiJyIpKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUuaW5jbHVkZXMoJyInKSkgewogICAgICAgICAgICAgIHJldHVybiBgIiR7dmFsdWV9ImA7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXZhbHVlLmluY2x1ZGVzKCdgJykgJiYgIXZhbHVlLmluY2x1ZGVzKCckeycpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGBcYCR7dmFsdWV9XGBgOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYCcke3ZhbHVlfSdgOwogICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiAnTmFOJzsKICAgICAgICAgIH0gZWxzZSBpZiAoT2JqZWN0LmlzKHZhbHVlLCAtMCkpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgY2FzZSAnYmlnaW50JzoKICAgICAgICAgIHJldHVybiBgJHtTdHJpbmcodmFsdWUpfW5gOwogICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIGNhc2UgJ3VuZGVmaW5lZCc6CiAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgICAgICBjYXNlICdvYmplY3QnOgogICAgICAgICAgcmV0dXJuICd7fSc7CiAgICAgIH0KICAgIH0KICB9OwogIHJldHVybiBpbnNwZWN0Owp9Cgp2YXIgZXJyb3JzOwp2YXIgaGFzUmVxdWlyZWRFcnJvcnM7CmZ1bmN0aW9uIHJlcXVpcmVFcnJvcnMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkRXJyb3JzKSByZXR1cm4gZXJyb3JzOwogIGhhc1JlcXVpcmVkRXJyb3JzID0gMTsKICBjb25zdCB7CiAgICBmb3JtYXQsCiAgICBpbnNwZWN0CiAgfSA9IHJlcXVpcmVJbnNwZWN0KCk7CiAgY29uc3QgewogICAgQWdncmVnYXRlRXJyb3I6IEN1c3RvbUFnZ3JlZ2F0ZUVycm9yCiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwoKICAvKgogICAgVGhpcyBmaWxlIGlzIGEgcmVkdWNlZCBhbmQgYWRhcHRlZCB2ZXJzaW9uIG9mIHRoZSBtYWluIGxpYi9pbnRlcm5hbC9lcnJvcnMuanMgZmlsZSBkZWZpbmVkIGF0CiAgCSAgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2Jsb2IvbWFpbi9saWIvaW50ZXJuYWwvZXJyb3JzLmpzCiAgCSAgRG9uJ3QgdHJ5IHRvIHJlcGxhY2Ugd2l0aCB0aGUgb3JpZ2luYWwgZmlsZSBhbmQga2VlcCBpdCB1cCB0byBkYXRlIChzdGFydGluZyBmcm9tIEUoLi4uKSBkZWZpbml0aW9ucykKICAgIHdpdGggdGhlIHVwc3RyZWFtIGZpbGUuCiAgKi8KCiAgY29uc3QgQWdncmVnYXRlRXJyb3IgPSBnbG9iYWxUaGlzLkFnZ3JlZ2F0ZUVycm9yIHx8IEN1c3RvbUFnZ3JlZ2F0ZUVycm9yOwogIGNvbnN0IGtJc05vZGVFcnJvciA9IFN5bWJvbCgna0lzTm9kZUVycm9yJyk7CiAgY29uc3Qga1R5cGVzID0gWydzdHJpbmcnLCAnZnVuY3Rpb24nLCAnbnVtYmVyJywgJ29iamVjdCcsCiAgLy8gQWNjZXB0ICdGdW5jdGlvbicgYW5kICdPYmplY3QnIGFzIGFsdGVybmF0aXZlIHRvIHRoZSBsb3dlciBjYXNlZCB2ZXJzaW9uLgogICdGdW5jdGlvbicsICdPYmplY3QnLCAnYm9vbGVhbicsICdiaWdpbnQnLCAnc3ltYm9sJ107CiAgY29uc3QgY2xhc3NSZWdFeHAgPSAvXihbQS1aXVthLXowLTldKikrJC87CiAgY29uc3Qgbm9kZUludGVybmFsUHJlZml4ID0gJ19fbm9kZV9pbnRlcm5hbF8nOwogIGNvbnN0IGNvZGVzID0ge307CiAgZnVuY3Rpb24gYXNzZXJ0KHZhbHVlLCBtZXNzYWdlKSB7CiAgICBpZiAoIXZhbHVlKSB7CiAgICAgIHRocm93IG5ldyBjb2Rlcy5FUlJfSU5URVJOQUxfQVNTRVJUSU9OKG1lc3NhZ2UpOwogICAgfQogIH0KCiAgLy8gT25seSB1c2UgdGhpcyBmb3IgaW50ZWdlcnMhIERlY2ltYWwgbnVtYmVycyBkbyBub3Qgd29yayB3aXRoIHRoaXMgZnVuY3Rpb24uCiAgZnVuY3Rpb24gYWRkTnVtZXJpY2FsU2VwYXJhdG9yKHZhbCkgewogICAgbGV0IHJlcyA9ICcnOwogICAgbGV0IGkgPSB2YWwubGVuZ3RoOwogICAgY29uc3Qgc3RhcnQgPSB2YWxbMF0gPT09ICctJyA/IDEgOiAwOwogICAgZm9yICg7IGkgPj0gc3RhcnQgKyA0OyBpIC09IDMpIHsKICAgICAgcmVzID0gYF8ke3ZhbC5zbGljZShpIC0gMywgaSl9JHtyZXN9YDsKICAgIH0KICAgIHJldHVybiBgJHt2YWwuc2xpY2UoMCwgaSl9JHtyZXN9YDsKICB9CiAgZnVuY3Rpb24gZ2V0TWVzc2FnZShrZXksIG1zZywgYXJncykgewogICAgaWYgKHR5cGVvZiBtc2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgYXNzZXJ0KG1zZy5sZW5ndGggPD0gYXJncy5sZW5ndGgsCiAgICAgIC8vIERlZmF1bHQgb3B0aW9ucyBkbyBub3QgY291bnQuCiAgICAgIGBDb2RlOiAke2tleX07IFRoZSBwcm92aWRlZCBhcmd1bWVudHMgbGVuZ3RoICgke2FyZ3MubGVuZ3RofSkgZG9lcyBub3QgbWF0Y2ggdGhlIHJlcXVpcmVkIG9uZXMgKCR7bXNnLmxlbmd0aH0pLmApOwogICAgICByZXR1cm4gbXNnKC4uLmFyZ3MpOwogICAgfQogICAgY29uc3QgZXhwZWN0ZWRMZW5ndGggPSAobXNnLm1hdGNoKC8lW2RmaWpvT3NdL2cpIHx8IFtdKS5sZW5ndGg7CiAgICBhc3NlcnQoZXhwZWN0ZWRMZW5ndGggPT09IGFyZ3MubGVuZ3RoLCBgQ29kZTogJHtrZXl9OyBUaGUgcHJvdmlkZWQgYXJndW1lbnRzIGxlbmd0aCAoJHthcmdzLmxlbmd0aH0pIGRvZXMgbm90IG1hdGNoIHRoZSByZXF1aXJlZCBvbmVzICgke2V4cGVjdGVkTGVuZ3RofSkuYCk7CiAgICBpZiAoYXJncy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG1zZzsKICAgIH0KICAgIHJldHVybiBmb3JtYXQobXNnLCAuLi5hcmdzKTsKICB9CiAgZnVuY3Rpb24gRShjb2RlLCBtZXNzYWdlLCBCYXNlKSB7CiAgICBpZiAoIUJhc2UpIHsKICAgICAgQmFzZSA9IEVycm9yOwogICAgfQogICAgY2xhc3MgTm9kZUVycm9yIGV4dGVuZHMgQmFzZSB7CiAgICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3MpIHsKICAgICAgICBzdXBlcihnZXRNZXNzYWdlKGNvZGUsIG1lc3NhZ2UsIGFyZ3MpKTsKICAgICAgfQogICAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gYCR7dGhpcy5uYW1lfSBbJHtjb2RlfV06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgIH0KICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE5vZGVFcnJvci5wcm90b3R5cGUsIHsKICAgICAgbmFtZTogewogICAgICAgIHZhbHVlOiBCYXNlLm5hbWUsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0sCiAgICAgIHRvU3RyaW5nOiB7CiAgICAgICAgdmFsdWUoKSB7CiAgICAgICAgICByZXR1cm4gYCR7dGhpcy5uYW1lfSBbJHtjb2RlfV06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgfSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgICBOb2RlRXJyb3IucHJvdG90eXBlLmNvZGUgPSBjb2RlOwogICAgTm9kZUVycm9yLnByb3RvdHlwZVtrSXNOb2RlRXJyb3JdID0gdHJ1ZTsKICAgIGNvZGVzW2NvZGVdID0gTm9kZUVycm9yOwogIH0KICBmdW5jdGlvbiBoaWRlU3RhY2tGcmFtZXMoZm4pIHsKICAgIC8vIFdlIHJlbmFtZSB0aGUgZnVuY3Rpb25zIHRoYXQgd2lsbCBiZSBoaWRkZW4gdG8gY3V0IG9mZiB0aGUgc3RhY2t0cmFjZQogICAgLy8gYXQgdGhlIG91dGVybW9zdCBvbmUKICAgIGNvbnN0IGhpZGRlbiA9IG5vZGVJbnRlcm5hbFByZWZpeCArIGZuLm5hbWU7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZm4sICduYW1lJywgewogICAgICB2YWx1ZTogaGlkZGVuCiAgICB9KTsKICAgIHJldHVybiBmbjsKICB9CiAgZnVuY3Rpb24gYWdncmVnYXRlVHdvRXJyb3JzKGlubmVyRXJyb3IsIG91dGVyRXJyb3IpIHsKICAgIGlmIChpbm5lckVycm9yICYmIG91dGVyRXJyb3IgJiYgaW5uZXJFcnJvciAhPT0gb3V0ZXJFcnJvcikgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShvdXRlckVycm9yLmVycm9ycykpIHsKICAgICAgICAvLyBJZiBgb3V0ZXJFcnJvcmAgaXMgYWxyZWFkeSBhbiBgQWdncmVnYXRlRXJyb3JgLgogICAgICAgIG91dGVyRXJyb3IuZXJyb3JzLnB1c2goaW5uZXJFcnJvcik7CiAgICAgICAgcmV0dXJuIG91dGVyRXJyb3I7CiAgICAgIH0KICAgICAgY29uc3QgZXJyID0gbmV3IEFnZ3JlZ2F0ZUVycm9yKFtvdXRlckVycm9yLCBpbm5lckVycm9yXSwgb3V0ZXJFcnJvci5tZXNzYWdlKTsKICAgICAgZXJyLmNvZGUgPSBvdXRlckVycm9yLmNvZGU7CiAgICAgIHJldHVybiBlcnI7CiAgICB9CiAgICByZXR1cm4gaW5uZXJFcnJvciB8fCBvdXRlckVycm9yOwogIH0KICBjbGFzcyBBYm9ydEVycm9yIGV4dGVuZHMgRXJyb3IgewogICAgY29uc3RydWN0b3IobWVzc2FnZSA9ICdUaGUgb3BlcmF0aW9uIHdhcyBhYm9ydGVkJywgb3B0aW9ucyA9IHVuZGVmaW5lZCkgewogICAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvcHRpb25zICE9PSAnb2JqZWN0JykgewogICAgICAgIHRocm93IG5ldyBjb2Rlcy5FUlJfSU5WQUxJRF9BUkdfVFlQRSgnb3B0aW9ucycsICdPYmplY3QnLCBvcHRpb25zKTsKICAgICAgfQogICAgICBzdXBlcihtZXNzYWdlLCBvcHRpb25zKTsKICAgICAgdGhpcy5jb2RlID0gJ0FCT1JUX0VSUic7CiAgICAgIHRoaXMubmFtZSA9ICdBYm9ydEVycm9yJzsKICAgIH0KICB9CiAgRSgnRVJSX0FTU0VSVElPTicsICclcycsIEVycm9yKTsKICBFKCdFUlJfSU5WQUxJRF9BUkdfVFlQRScsIChuYW1lLCBleHBlY3RlZCwgYWN0dWFsKSA9PiB7CiAgICBhc3NlcnQodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnLCAiJ25hbWUnIG11c3QgYmUgYSBzdHJpbmciKTsKICAgIGlmICghQXJyYXkuaXNBcnJheShleHBlY3RlZCkpIHsKICAgICAgZXhwZWN0ZWQgPSBbZXhwZWN0ZWRdOwogICAgfQogICAgbGV0IG1zZyA9ICdUaGUgJzsKICAgIGlmIChuYW1lLmVuZHNXaXRoKCcgYXJndW1lbnQnKSkgewogICAgICAvLyBGb3IgY2FzZXMgbGlrZSAnZmlyc3QgYXJndW1lbnQnCiAgICAgIG1zZyArPSBgJHtuYW1lfSBgOwogICAgfSBlbHNlIHsKICAgICAgbXNnICs9IGAiJHtuYW1lfSIgJHtuYW1lLmluY2x1ZGVzKCcuJykgPyAncHJvcGVydHknIDogJ2FyZ3VtZW50J30gYDsKICAgIH0KICAgIG1zZyArPSAnbXVzdCBiZSAnOwogICAgY29uc3QgdHlwZXMgPSBbXTsKICAgIGNvbnN0IGluc3RhbmNlcyA9IFtdOwogICAgY29uc3Qgb3RoZXIgPSBbXTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgZXhwZWN0ZWQpIHsKICAgICAgYXNzZXJ0KHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycsICdBbGwgZXhwZWN0ZWQgZW50cmllcyBoYXZlIHRvIGJlIG9mIHR5cGUgc3RyaW5nJyk7CiAgICAgIGlmIChrVHlwZXMuaW5jbHVkZXModmFsdWUpKSB7CiAgICAgICAgdHlwZXMucHVzaCh2YWx1ZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgfSBlbHNlIGlmIChjbGFzc1JlZ0V4cC50ZXN0KHZhbHVlKSkgewogICAgICAgIGluc3RhbmNlcy5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhc3NlcnQodmFsdWUgIT09ICdvYmplY3QnLCAnVGhlIHZhbHVlICJvYmplY3QiIHNob3VsZCBiZSB3cml0dGVuIGFzICJPYmplY3QiJyk7CiAgICAgICAgb3RoZXIucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBTcGVjaWFsIGhhbmRsZSBgb2JqZWN0YCBpbiBjYXNlIG90aGVyIGluc3RhbmNlcyBhcmUgYWxsb3dlZCB0byBvdXRsaW5lCiAgICAvLyB0aGUgZGlmZmVyZW5jZXMgYmV0d2VlbiBlYWNoIG90aGVyLgogICAgaWYgKGluc3RhbmNlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHBvcyA9IHR5cGVzLmluZGV4T2YoJ29iamVjdCcpOwogICAgICBpZiAocG9zICE9PSAtMSkgewogICAgICAgIHR5cGVzLnNwbGljZSh0eXBlcywgcG9zLCAxKTsKICAgICAgICBpbnN0YW5jZXMucHVzaCgnT2JqZWN0Jyk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0eXBlcy5sZW5ndGggPiAwKSB7CiAgICAgIHN3aXRjaCAodHlwZXMubGVuZ3RoKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgbXNnICs9IGBvZiB0eXBlICR7dHlwZXNbMF19YDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIG1zZyArPSBgb25lIG9mIHR5cGUgJHt0eXBlc1swXX0gb3IgJHt0eXBlc1sxXX1gOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHsKICAgICAgICAgICAgY29uc3QgbGFzdCA9IHR5cGVzLnBvcCgpOwogICAgICAgICAgICBtc2cgKz0gYG9uZSBvZiB0eXBlICR7dHlwZXMuam9pbignLCAnKX0sIG9yICR7bGFzdH1gOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpbnN0YW5jZXMubGVuZ3RoID4gMCB8fCBvdGhlci5sZW5ndGggPiAwKSB7CiAgICAgICAgbXNnICs9ICcgb3IgJzsKICAgICAgfQogICAgfQogICAgaWYgKGluc3RhbmNlcy5sZW5ndGggPiAwKSB7CiAgICAgIHN3aXRjaCAoaW5zdGFuY2VzLmxlbmd0aCkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIG1zZyArPSBgYW4gaW5zdGFuY2Ugb2YgJHtpbnN0YW5jZXNbMF19YDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIG1zZyArPSBgYW4gaW5zdGFuY2Ugb2YgJHtpbnN0YW5jZXNbMF19IG9yICR7aW5zdGFuY2VzWzFdfWA7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgewogICAgICAgICAgICBjb25zdCBsYXN0ID0gaW5zdGFuY2VzLnBvcCgpOwogICAgICAgICAgICBtc2cgKz0gYGFuIGluc3RhbmNlIG9mICR7aW5zdGFuY2VzLmpvaW4oJywgJyl9LCBvciAke2xhc3R9YDsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAob3RoZXIubGVuZ3RoID4gMCkgewogICAgICAgIG1zZyArPSAnIG9yICc7CiAgICAgIH0KICAgIH0KICAgIHN3aXRjaCAob3RoZXIubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIGlmIChvdGhlclswXS50b0xvd2VyQ2FzZSgpICE9PSBvdGhlclswXSkgewogICAgICAgICAgbXNnICs9ICdhbiAnOwogICAgICAgIH0KICAgICAgICBtc2cgKz0gYCR7b3RoZXJbMF19YDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIG1zZyArPSBgb25lIG9mICR7b3RoZXJbMF19IG9yICR7b3RoZXJbMV19YDsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB7CiAgICAgICAgICBjb25zdCBsYXN0ID0gb3RoZXIucG9wKCk7CiAgICAgICAgICBtc2cgKz0gYG9uZSBvZiAke290aGVyLmpvaW4oJywgJyl9LCBvciAke2xhc3R9YDsKICAgICAgICB9CiAgICB9CiAgICBpZiAoYWN0dWFsID09IG51bGwpIHsKICAgICAgbXNnICs9IGAuIFJlY2VpdmVkICR7YWN0dWFsfWA7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBhY3R1YWwgPT09ICdmdW5jdGlvbicgJiYgYWN0dWFsLm5hbWUpIHsKICAgICAgbXNnICs9IGAuIFJlY2VpdmVkIGZ1bmN0aW9uICR7YWN0dWFsLm5hbWV9YDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGFjdHVhbCA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFyIF9hY3R1YWwkY29uc3RydWN0b3I7CiAgICAgIGlmICgoX2FjdHVhbCRjb25zdHJ1Y3RvciA9IGFjdHVhbC5jb25zdHJ1Y3RvcikgIT09IG51bGwgJiYgX2FjdHVhbCRjb25zdHJ1Y3RvciAhPT0gdW5kZWZpbmVkICYmIF9hY3R1YWwkY29uc3RydWN0b3IubmFtZSkgewogICAgICAgIG1zZyArPSBgLiBSZWNlaXZlZCBhbiBpbnN0YW5jZSBvZiAke2FjdHVhbC5jb25zdHJ1Y3Rvci5uYW1lfWA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaW5zcGVjdGVkID0gaW5zcGVjdChhY3R1YWwsIHsKICAgICAgICAgIGRlcHRoOiAtMQogICAgICAgIH0pOwogICAgICAgIG1zZyArPSBgLiBSZWNlaXZlZCAke2luc3BlY3RlZH1gOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsZXQgaW5zcGVjdGVkID0gaW5zcGVjdChhY3R1YWwsIHsKICAgICAgICBjb2xvcnM6IGZhbHNlCiAgICAgIH0pOwogICAgICBpZiAoaW5zcGVjdGVkLmxlbmd0aCA+IDI1KSB7CiAgICAgICAgaW5zcGVjdGVkID0gYCR7aW5zcGVjdGVkLnNsaWNlKDAsIDI1KX0uLi5gOwogICAgICB9CiAgICAgIG1zZyArPSBgLiBSZWNlaXZlZCB0eXBlICR7dHlwZW9mIGFjdHVhbH0gKCR7aW5zcGVjdGVkfSlgOwogICAgfQogICAgcmV0dXJuIG1zZzsKICB9LCBUeXBlRXJyb3IpOwogIEUoJ0VSUl9JTlZBTElEX0FSR19WQUxVRScsIChuYW1lLCB2YWx1ZSwgcmVhc29uID0gJ2lzIGludmFsaWQnKSA9PiB7CiAgICBsZXQgaW5zcGVjdGVkID0gaW5zcGVjdCh2YWx1ZSk7CiAgICBpZiAoaW5zcGVjdGVkLmxlbmd0aCA+IDEyOCkgewogICAgICBpbnNwZWN0ZWQgPSBpbnNwZWN0ZWQuc2xpY2UoMCwgMTI4KSArICcuLi4nOwogICAgfQogICAgY29uc3QgdHlwZSA9IG5hbWUuaW5jbHVkZXMoJy4nKSA/ICdwcm9wZXJ0eScgOiAnYXJndW1lbnQnOwogICAgcmV0dXJuIGBUaGUgJHt0eXBlfSAnJHtuYW1lfScgJHtyZWFzb259LiBSZWNlaXZlZCAke2luc3BlY3RlZH1gOwogIH0sIFR5cGVFcnJvcik7CiAgRSgnRVJSX0lOVkFMSURfUkVUVVJOX1ZBTFVFJywgKGlucHV0LCBuYW1lLCB2YWx1ZSkgPT4gewogICAgdmFyIF92YWx1ZSRjb25zdHJ1Y3RvcjsKICAgIGNvbnN0IHR5cGUgPSB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIChfdmFsdWUkY29uc3RydWN0b3IgPSB2YWx1ZS5jb25zdHJ1Y3RvcikgIT09IG51bGwgJiYgX3ZhbHVlJGNvbnN0cnVjdG9yICE9PSB1bmRlZmluZWQgJiYgX3ZhbHVlJGNvbnN0cnVjdG9yLm5hbWUgPyBgaW5zdGFuY2Ugb2YgJHt2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lfWAgOiBgdHlwZSAke3R5cGVvZiB2YWx1ZX1gOwogICAgcmV0dXJuIGBFeHBlY3RlZCAke2lucHV0fSB0byBiZSByZXR1cm5lZCBmcm9tIHRoZSAiJHtuYW1lfSJgICsgYCBmdW5jdGlvbiBidXQgZ290ICR7dHlwZX0uYDsKICB9LCBUeXBlRXJyb3IpOwogIEUoJ0VSUl9NSVNTSU5HX0FSR1MnLCAoLi4uYXJncykgPT4gewogICAgYXNzZXJ0KGFyZ3MubGVuZ3RoID4gMCwgJ0F0IGxlYXN0IG9uZSBhcmcgbmVlZHMgdG8gYmUgc3BlY2lmaWVkJyk7CiAgICBsZXQgbXNnOwogICAgY29uc3QgbGVuID0gYXJncy5sZW5ndGg7CiAgICBhcmdzID0gKEFycmF5LmlzQXJyYXkoYXJncykgPyBhcmdzIDogW2FyZ3NdKS5tYXAoYSA9PiBgIiR7YX0iYCkuam9pbignIG9yICcpOwogICAgc3dpdGNoIChsZW4pIHsKICAgICAgY2FzZSAxOgogICAgICAgIG1zZyArPSBgVGhlICR7YXJnc1swXX0gYXJndW1lbnRgOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgbXNnICs9IGBUaGUgJHthcmdzWzBdfSBhbmQgJHthcmdzWzFdfSBhcmd1bWVudHNgOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IGxhc3QgPSBhcmdzLnBvcCgpOwogICAgICAgICAgbXNnICs9IGBUaGUgJHthcmdzLmpvaW4oJywgJyl9LCBhbmQgJHtsYXN0fSBhcmd1bWVudHNgOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIH0KICAgIHJldHVybiBgJHttc2d9IG11c3QgYmUgc3BlY2lmaWVkYDsKICB9LCBUeXBlRXJyb3IpOwogIEUoJ0VSUl9PVVRfT0ZfUkFOR0UnLCAoc3RyLCByYW5nZSwgaW5wdXQpID0+IHsKICAgIGFzc2VydChyYW5nZSwgJ01pc3NpbmcgInJhbmdlIiBhcmd1bWVudCcpOwogICAgbGV0IHJlY2VpdmVkOwogICAgaWYgKE51bWJlci5pc0ludGVnZXIoaW5wdXQpICYmIE1hdGguYWJzKGlucHV0KSA+IDIgKiogMzIpIHsKICAgICAgcmVjZWl2ZWQgPSBhZGROdW1lcmljYWxTZXBhcmF0b3IoU3RyaW5nKGlucHV0KSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ2JpZ2ludCcpIHsKICAgICAgcmVjZWl2ZWQgPSBTdHJpbmcoaW5wdXQpOwogICAgICBjb25zdCBsaW1pdCA9IEJpZ0ludCgyKSAqKiBCaWdJbnQoMzIpOwogICAgICBpZiAoaW5wdXQgPiBsaW1pdCB8fCBpbnB1dCA8IC1saW1pdCkgewogICAgICAgIHJlY2VpdmVkID0gYWRkTnVtZXJpY2FsU2VwYXJhdG9yKHJlY2VpdmVkKTsKICAgICAgfQogICAgICByZWNlaXZlZCArPSAnbic7CiAgICB9IGVsc2UgewogICAgICByZWNlaXZlZCA9IGluc3BlY3QoaW5wdXQpOwogICAgfQogICAgcmV0dXJuIGBUaGUgdmFsdWUgb2YgIiR7c3RyfSIgaXMgb3V0IG9mIHJhbmdlLiBJdCBtdXN0IGJlICR7cmFuZ2V9LiBSZWNlaXZlZCAke3JlY2VpdmVkfWA7CiAgfSwgUmFuZ2VFcnJvcik7CiAgRSgnRVJSX01VTFRJUExFX0NBTExCQUNLJywgJ0NhbGxiYWNrIGNhbGxlZCBtdWx0aXBsZSB0aW1lcycsIEVycm9yKTsKICBFKCdFUlJfTUVUSE9EX05PVF9JTVBMRU1FTlRFRCcsICdUaGUgJXMgbWV0aG9kIGlzIG5vdCBpbXBsZW1lbnRlZCcsIEVycm9yKTsKICBFKCdFUlJfU1RSRUFNX0FMUkVBRFlfRklOSVNIRUQnLCAnQ2Fubm90IGNhbGwgJXMgYWZ0ZXIgYSBzdHJlYW0gd2FzIGZpbmlzaGVkJywgRXJyb3IpOwogIEUoJ0VSUl9TVFJFQU1fQ0FOTk9UX1BJUEUnLCAnQ2Fubm90IHBpcGUsIG5vdCByZWFkYWJsZScsIEVycm9yKTsKICBFKCdFUlJfU1RSRUFNX0RFU1RST1lFRCcsICdDYW5ub3QgY2FsbCAlcyBhZnRlciBhIHN0cmVhbSB3YXMgZGVzdHJveWVkJywgRXJyb3IpOwogIEUoJ0VSUl9TVFJFQU1fTlVMTF9WQUxVRVMnLCAnTWF5IG5vdCB3cml0ZSBudWxsIHZhbHVlcyB0byBzdHJlYW0nLCBUeXBlRXJyb3IpOwogIEUoJ0VSUl9TVFJFQU1fUFJFTUFUVVJFX0NMT1NFJywgJ1ByZW1hdHVyZSBjbG9zZScsIEVycm9yKTsKICBFKCdFUlJfU1RSRUFNX1BVU0hfQUZURVJfRU9GJywgJ3N0cmVhbS5wdXNoKCkgYWZ0ZXIgRU9GJywgRXJyb3IpOwogIEUoJ0VSUl9TVFJFQU1fVU5TSElGVF9BRlRFUl9FTkRfRVZFTlQnLCAnc3RyZWFtLnVuc2hpZnQoKSBhZnRlciBlbmQgZXZlbnQnLCBFcnJvcik7CiAgRSgnRVJSX1NUUkVBTV9XUklURV9BRlRFUl9FTkQnLCAnd3JpdGUgYWZ0ZXIgZW5kJywgRXJyb3IpOwogIEUoJ0VSUl9VTktOT1dOX0VOQ09ESU5HJywgJ1Vua25vd24gZW5jb2Rpbmc6ICVzJywgVHlwZUVycm9yKTsKICBlcnJvcnMgPSB7CiAgICBBYm9ydEVycm9yLAogICAgYWdncmVnYXRlVHdvRXJyb3JzOiBoaWRlU3RhY2tGcmFtZXMoYWdncmVnYXRlVHdvRXJyb3JzKSwKICAgIGhpZGVTdGFja0ZyYW1lcywKICAgIGNvZGVzCiAgfTsKICByZXR1cm4gZXJyb3JzOwp9CgovKioKICogQGF1dGhvciBUb3J1IE5hZ2FzaGltYSA8aHR0cHM6Ly9naXRodWIuY29tL215c3RpY2F0ZWE+CiAqIEBjb3B5cmlnaHQgMjAxNSBUb3J1IE5hZ2FzaGltYS4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogU2VlIExJQ0VOU0UgZmlsZSBpbiByb290IGRpcmVjdG9yeSBmb3IgZnVsbCBsaWNlbnNlLgogKi8KLyoqCiAqIEB0eXBlZGVmIHtvYmplY3R9IFByaXZhdGVEYXRhCiAqIEBwcm9wZXJ0eSB7RXZlbnRUYXJnZXR9IGV2ZW50VGFyZ2V0IFRoZSBldmVudCB0YXJnZXQuCiAqIEBwcm9wZXJ0eSB7e3R5cGU6c3RyaW5nfX0gZXZlbnQgVGhlIG9yaWdpbmFsIGV2ZW50IG9iamVjdC4KICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50UGhhc2UgVGhlIGN1cnJlbnQgZXZlbnQgcGhhc2UuCiAqIEBwcm9wZXJ0eSB7RXZlbnRUYXJnZXR8bnVsbH0gY3VycmVudFRhcmdldCBUaGUgY3VycmVudCBldmVudCB0YXJnZXQuCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FuY2VsZWQgVGhlIGZsYWcgdG8gcHJldmVudCBkZWZhdWx0LgogKiBAcHJvcGVydHkge2Jvb2xlYW59IHN0b3BwZWQgVGhlIGZsYWcgdG8gc3RvcCBwcm9wYWdhdGlvbi4KICogQHByb3BlcnR5IHtib29sZWFufSBpbW1lZGlhdGVTdG9wcGVkIFRoZSBmbGFnIHRvIHN0b3AgcHJvcGFnYXRpb24gaW1tZWRpYXRlbHkuCiAqIEBwcm9wZXJ0eSB7RnVuY3Rpb258bnVsbH0gcGFzc2l2ZUxpc3RlbmVyIFRoZSBsaXN0ZW5lciBpZiB0aGUgY3VycmVudCBsaXN0ZW5lciBpcyBwYXNzaXZlLiBPdGhlcndpc2UgdGhpcyBpcyBudWxsLgogKiBAcHJvcGVydHkge251bWJlcn0gdGltZVN0YW1wIFRoZSB1bml4IHRpbWUuCiAqIEBwcml2YXRlCiAqLwoKLyoqCiAqIFByaXZhdGUgZGF0YSBmb3IgZXZlbnQgd3JhcHBlcnMuCiAqIEB0eXBlIHtXZWFrTWFwPEV2ZW50LCBQcml2YXRlRGF0YT59CiAqIEBwcml2YXRlCiAqLwpjb25zdCBwcml2YXRlRGF0YSA9IG5ldyBXZWFrTWFwKCk7CgovKioKICogQ2FjaGUgZm9yIHdyYXBwZXIgY2xhc3Nlcy4KICogQHR5cGUge1dlYWtNYXA8T2JqZWN0LCBGdW5jdGlvbj59CiAqIEBwcml2YXRlCiAqLwpjb25zdCB3cmFwcGVycyA9IG5ldyBXZWFrTWFwKCk7CgovKioKICogR2V0IHByaXZhdGUgZGF0YS4KICogQHBhcmFtIHtFdmVudH0gZXZlbnQgVGhlIGV2ZW50IG9iamVjdCB0byBnZXQgcHJpdmF0ZSBkYXRhLgogKiBAcmV0dXJucyB7UHJpdmF0ZURhdGF9IFRoZSBwcml2YXRlIGRhdGEgb2YgdGhlIGV2ZW50LgogKiBAcHJpdmF0ZQogKi8KZnVuY3Rpb24gcGQoZXZlbnQpIHsKICBjb25zdCByZXR2ID0gcHJpdmF0ZURhdGEuZ2V0KGV2ZW50KTsKICBjb25zb2xlLmFzc2VydChyZXR2ICE9IG51bGwsICIndGhpcycgaXMgZXhwZWN0ZWQgYW4gRXZlbnQgb2JqZWN0LCBidXQgZ290IiwgZXZlbnQpOwogIHJldHVybiByZXR2Owp9CgovKioKICogaHR0cHM6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNzZXQtdGhlLWNhbmNlbGVkLWZsYWcKICogQHBhcmFtIGRhdGEge1ByaXZhdGVEYXRhfSBwcml2YXRlIGRhdGEuCiAqLwpmdW5jdGlvbiBzZXRDYW5jZWxGbGFnKGRhdGEpIHsKICBpZiAoZGF0YS5wYXNzaXZlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICBjb25zb2xlLmVycm9yKCJVbmFibGUgdG8gcHJldmVudERlZmF1bHQgaW5zaWRlIHBhc3NpdmUgZXZlbnQgbGlzdGVuZXIgaW52b2NhdGlvbi4iLCBkYXRhLnBhc3NpdmVMaXN0ZW5lcik7CiAgICB9CiAgICByZXR1cm47CiAgfQogIGlmICghZGF0YS5ldmVudC5jYW5jZWxhYmxlKSB7CiAgICByZXR1cm47CiAgfQogIGRhdGEuY2FuY2VsZWQgPSB0cnVlOwogIGlmICh0eXBlb2YgZGF0YS5ldmVudC5wcmV2ZW50RGVmYXVsdCA9PT0gImZ1bmN0aW9uIikgewogICAgZGF0YS5ldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogIH0KfQoKLyoqCiAqIEBzZWUgaHR0cHM6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNpbnRlcmZhY2UtZXZlbnQKICogQHByaXZhdGUKICovCi8qKgogKiBUaGUgZXZlbnQgd3JhcHBlci4KICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7RXZlbnRUYXJnZXR9IGV2ZW50VGFyZ2V0IFRoZSBldmVudCB0YXJnZXQgb2YgdGhpcyBkaXNwYXRjaGluZy4KICogQHBhcmFtIHtFdmVudHx7dHlwZTpzdHJpbmd9fSBldmVudCBUaGUgb3JpZ2luYWwgZXZlbnQgdG8gd3JhcC4KICovCmZ1bmN0aW9uIEV2ZW50KGV2ZW50VGFyZ2V0LCBldmVudCkgewogIHByaXZhdGVEYXRhLnNldCh0aGlzLCB7CiAgICBldmVudFRhcmdldCwKICAgIGV2ZW50LAogICAgZXZlbnRQaGFzZTogMiwKICAgIGN1cnJlbnRUYXJnZXQ6IGV2ZW50VGFyZ2V0LAogICAgY2FuY2VsZWQ6IGZhbHNlLAogICAgc3RvcHBlZDogZmFsc2UsCiAgICBpbW1lZGlhdGVTdG9wcGVkOiBmYWxzZSwKICAgIHBhc3NpdmVMaXN0ZW5lcjogbnVsbCwKICAgIHRpbWVTdGFtcDogZXZlbnQudGltZVN0YW1wIHx8IERhdGUubm93KCkKICB9KTsKCiAgLy8gaHR0cHM6Ly9oZXljYW0uZ2l0aHViLmlvL3dlYmlkbC8jVW5mb3JnZWFibGUKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgImlzVHJ1c3RlZCIsIHsKICAgIHZhbHVlOiBmYWxzZSwKICAgIGVudW1lcmFibGU6IHRydWUKICB9KTsKCiAgLy8gRGVmaW5lIGFjY2Vzc29ycwogIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhldmVudCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgKytpKSB7CiAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgaWYgKCEoa2V5IGluIHRoaXMpKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBrZXksIGRlZmluZVJlZGlyZWN0RGVzY3JpcHRvcihrZXkpKTsKICAgIH0KICB9Cn0KCi8vIFNob3VsZCBiZSBlbnVtZXJhYmxlLCBidXQgY2xhc3MgbWV0aG9kcyBhcmUgbm90IGVudW1lcmFibGUuCkV2ZW50LnByb3RvdHlwZSA9IHsKICAvKioKICAgKiBUaGUgdHlwZSBvZiB0aGlzIGV2ZW50LgogICAqIEB0eXBlIHtzdHJpbmd9CiAgICovCiAgZ2V0IHR5cGUoKSB7CiAgICByZXR1cm4gcGQodGhpcykuZXZlbnQudHlwZTsKICB9LAogIC8qKgogICAqIFRoZSB0YXJnZXQgb2YgdGhpcyBldmVudC4KICAgKiBAdHlwZSB7RXZlbnRUYXJnZXR9CiAgICovCiAgZ2V0IHRhcmdldCgpIHsKICAgIHJldHVybiBwZCh0aGlzKS5ldmVudFRhcmdldDsKICB9LAogIC8qKgogICAqIFRoZSB0YXJnZXQgb2YgdGhpcyBldmVudC4KICAgKiBAdHlwZSB7RXZlbnRUYXJnZXR9CiAgICovCiAgZ2V0IGN1cnJlbnRUYXJnZXQoKSB7CiAgICByZXR1cm4gcGQodGhpcykuY3VycmVudFRhcmdldDsKICB9LAogIC8qKgogICAqIEByZXR1cm5zIHtFdmVudFRhcmdldFtdfSBUaGUgY29tcG9zZWQgcGF0aCBvZiB0aGlzIGV2ZW50LgogICAqLwogIGNvbXBvc2VkUGF0aCgpIHsKICAgIGNvbnN0IGN1cnJlbnRUYXJnZXQgPSBwZCh0aGlzKS5jdXJyZW50VGFyZ2V0OwogICAgaWYgKGN1cnJlbnRUYXJnZXQgPT0gbnVsbCkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICByZXR1cm4gW2N1cnJlbnRUYXJnZXRdOwogIH0sCiAgLyoqCiAgICogQ29uc3RhbnQgb2YgTk9ORS4KICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCBOT05FKCkgewogICAgcmV0dXJuIDA7CiAgfSwKICAvKioKICAgKiBDb25zdGFudCBvZiBDQVBUVVJJTkdfUEhBU0UuCiAgICogQHR5cGUge251bWJlcn0KICAgKi8KICBnZXQgQ0FQVFVSSU5HX1BIQVNFKCkgewogICAgcmV0dXJuIDE7CiAgfSwKICAvKioKICAgKiBDb25zdGFudCBvZiBBVF9UQVJHRVQuCiAgICogQHR5cGUge251bWJlcn0KICAgKi8KICBnZXQgQVRfVEFSR0VUKCkgewogICAgcmV0dXJuIDI7CiAgfSwKICAvKioKICAgKiBDb25zdGFudCBvZiBCVUJCTElOR19QSEFTRS4KICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCBCVUJCTElOR19QSEFTRSgpIHsKICAgIHJldHVybiAzOwogIH0sCiAgLyoqCiAgICogVGhlIHRhcmdldCBvZiB0aGlzIGV2ZW50LgogICAqIEB0eXBlIHtudW1iZXJ9CiAgICovCiAgZ2V0IGV2ZW50UGhhc2UoKSB7CiAgICByZXR1cm4gcGQodGhpcykuZXZlbnRQaGFzZTsKICB9LAogIC8qKgogICAqIFN0b3AgZXZlbnQgYnViYmxpbmcuCiAgICogQHJldHVybnMge3ZvaWR9CiAgICovCiAgc3RvcFByb3BhZ2F0aW9uKCkgewogICAgY29uc3QgZGF0YSA9IHBkKHRoaXMpOwogICAgZGF0YS5zdG9wcGVkID0gdHJ1ZTsKICAgIGlmICh0eXBlb2YgZGF0YS5ldmVudC5zdG9wUHJvcGFnYXRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZGF0YS5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0KICB9LAogIC8qKgogICAqIFN0b3AgZXZlbnQgYnViYmxpbmcuCiAgICogQHJldHVybnMge3ZvaWR9CiAgICovCiAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCkgewogICAgY29uc3QgZGF0YSA9IHBkKHRoaXMpOwogICAgZGF0YS5zdG9wcGVkID0gdHJ1ZTsKICAgIGRhdGEuaW1tZWRpYXRlU3RvcHBlZCA9IHRydWU7CiAgICBpZiAodHlwZW9mIGRhdGEuZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGRhdGEuZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICB9CiAgfSwKICAvKioKICAgKiBUaGUgZmxhZyB0byBiZSBidWJibGluZy4KICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKi8KICBnZXQgYnViYmxlcygpIHsKICAgIHJldHVybiBCb29sZWFuKHBkKHRoaXMpLmV2ZW50LmJ1YmJsZXMpOwogIH0sCiAgLyoqCiAgICogVGhlIGZsYWcgdG8gYmUgY2FuY2VsYWJsZS4KICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKi8KICBnZXQgY2FuY2VsYWJsZSgpIHsKICAgIHJldHVybiBCb29sZWFuKHBkKHRoaXMpLmV2ZW50LmNhbmNlbGFibGUpOwogIH0sCiAgLyoqCiAgICogQ2FuY2VsIHRoaXMgZXZlbnQuCiAgICogQHJldHVybnMge3ZvaWR9CiAgICovCiAgcHJldmVudERlZmF1bHQoKSB7CiAgICBzZXRDYW5jZWxGbGFnKHBkKHRoaXMpKTsKICB9LAogIC8qKgogICAqIFRoZSBmbGFnIHRvIGluZGljYXRlIGNhbmNlbGxhdGlvbiBzdGF0ZS4KICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKi8KICBnZXQgZGVmYXVsdFByZXZlbnRlZCgpIHsKICAgIHJldHVybiBwZCh0aGlzKS5jYW5jZWxlZDsKICB9LAogIC8qKgogICAqIFRoZSBmbGFnIHRvIGJlIGNvbXBvc2VkLgogICAqIEB0eXBlIHtib29sZWFufQogICAqLwogIGdldCBjb21wb3NlZCgpIHsKICAgIHJldHVybiBCb29sZWFuKHBkKHRoaXMpLmV2ZW50LmNvbXBvc2VkKTsKICB9LAogIC8qKgogICAqIFRoZSB1bml4IHRpbWUgb2YgdGhpcyBldmVudC4KICAgKiBAdHlwZSB7bnVtYmVyfQogICAqLwogIGdldCB0aW1lU3RhbXAoKSB7CiAgICByZXR1cm4gcGQodGhpcykudGltZVN0YW1wOwogIH0sCiAgLyoqCiAgICogVGhlIHRhcmdldCBvZiB0aGlzIGV2ZW50LgogICAqIEB0eXBlIHtFdmVudFRhcmdldH0KICAgKiBAZGVwcmVjYXRlZAogICAqLwogIGdldCBzcmNFbGVtZW50KCkgewogICAgcmV0dXJuIHBkKHRoaXMpLmV2ZW50VGFyZ2V0OwogIH0sCiAgLyoqCiAgICogVGhlIGZsYWcgdG8gc3RvcCBldmVudCBidWJibGluZy4KICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgKiBAZGVwcmVjYXRlZAogICAqLwogIGdldCBjYW5jZWxCdWJibGUoKSB7CiAgICByZXR1cm4gcGQodGhpcykuc3RvcHBlZDsKICB9LAogIHNldCBjYW5jZWxCdWJibGUodmFsdWUpIHsKICAgIGlmICghdmFsdWUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZGF0YSA9IHBkKHRoaXMpOwogICAgZGF0YS5zdG9wcGVkID0gdHJ1ZTsKICAgIGlmICh0eXBlb2YgZGF0YS5ldmVudC5jYW5jZWxCdWJibGUgPT09ICJib29sZWFuIikgewogICAgICBkYXRhLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICB9CiAgfSwKICAvKioKICAgKiBUaGUgZmxhZyB0byBpbmRpY2F0ZSBjYW5jZWxsYXRpb24gc3RhdGUuCiAgICogQHR5cGUge2Jvb2xlYW59CiAgICogQGRlcHJlY2F0ZWQKICAgKi8KICBnZXQgcmV0dXJuVmFsdWUoKSB7CiAgICByZXR1cm4gIXBkKHRoaXMpLmNhbmNlbGVkOwogIH0sCiAgc2V0IHJldHVyblZhbHVlKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlKSB7CiAgICAgIHNldENhbmNlbEZsYWcocGQodGhpcykpOwogICAgfQogIH0sCiAgLyoqCiAgICogSW5pdGlhbGl6ZSB0aGlzIGV2ZW50IG9iamVjdC4gQnV0IGRvIG5vdGhpbmcgdW5kZXIgZXZlbnQgZGlzcGF0Y2hpbmcuCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGV2ZW50IHR5cGUuCiAgICogQHBhcmFtIHtib29sZWFufSBbYnViYmxlcz1mYWxzZV0gVGhlIGZsYWcgdG8gYmUgcG9zc2libGUgdG8gYnViYmxlIHVwLgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NhbmNlbGFibGU9ZmFsc2VdIFRoZSBmbGFnIHRvIGJlIHBvc3NpYmxlIHRvIGNhbmNlbC4KICAgKiBAZGVwcmVjYXRlZAogICAqLwogIGluaXRFdmVudCgpIHsKICAgIC8vIERvIG5vdGhpbmcuCiAgfQp9OwoKLy8gYGNvbnN0cnVjdG9yYCBpcyBub3QgZW51bWVyYWJsZS4KT2JqZWN0LmRlZmluZVByb3BlcnR5KEV2ZW50LnByb3RvdHlwZSwgImNvbnN0cnVjdG9yIiwgewogIHZhbHVlOiBFdmVudCwKICBjb25maWd1cmFibGU6IHRydWUsCiAgd3JpdGFibGU6IHRydWUKfSk7CgovLyBFbnN1cmUgYGV2ZW50IGluc3RhbmNlb2Ygd2luZG93LkV2ZW50YCBpcyBgdHJ1ZWAuCmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LkV2ZW50ICE9PSAidW5kZWZpbmVkIikgewogIE9iamVjdC5zZXRQcm90b3R5cGVPZihFdmVudC5wcm90b3R5cGUsIHdpbmRvdy5FdmVudC5wcm90b3R5cGUpOwoKICAvLyBNYWtlIGFzc29jaWF0aW9uIGZvciB3cmFwcGVycy4KICB3cmFwcGVycy5zZXQod2luZG93LkV2ZW50LnByb3RvdHlwZSwgRXZlbnQpOwp9CgovKioKICogR2V0IHRoZSBwcm9wZXJ0eSBkZXNjcmlwdG9yIHRvIHJlZGlyZWN0IGEgZ2l2ZW4gcHJvcGVydHkuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgUHJvcGVydHkgbmFtZSB0byBkZWZpbmUgcHJvcGVydHkgZGVzY3JpcHRvci4KICogQHJldHVybnMge1Byb3BlcnR5RGVzY3JpcHRvcn0gVGhlIHByb3BlcnR5IGRlc2NyaXB0b3IgdG8gcmVkaXJlY3QgdGhlIHByb3BlcnR5LgogKiBAcHJpdmF0ZQogKi8KZnVuY3Rpb24gZGVmaW5lUmVkaXJlY3REZXNjcmlwdG9yKGtleSkgewogIHJldHVybiB7CiAgICBnZXQoKSB7CiAgICAgIHJldHVybiBwZCh0aGlzKS5ldmVudFtrZXldOwogICAgfSwKICAgIHNldCh2YWx1ZSkgewogICAgICBwZCh0aGlzKS5ldmVudFtrZXldID0gdmFsdWU7CiAgICB9LAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZW51bWVyYWJsZTogdHJ1ZQogIH07Cn0KCi8qKgogKiBHZXQgdGhlIHByb3BlcnR5IGRlc2NyaXB0b3IgdG8gY2FsbCBhIGdpdmVuIG1ldGhvZCBwcm9wZXJ0eS4KICogQHBhcmFtIHtzdHJpbmd9IGtleSBQcm9wZXJ0eSBuYW1lIHRvIGRlZmluZSBwcm9wZXJ0eSBkZXNjcmlwdG9yLgogKiBAcmV0dXJucyB7UHJvcGVydHlEZXNjcmlwdG9yfSBUaGUgcHJvcGVydHkgZGVzY3JpcHRvciB0byBjYWxsIHRoZSBtZXRob2QgcHJvcGVydHkuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBkZWZpbmVDYWxsRGVzY3JpcHRvcihrZXkpIHsKICByZXR1cm4gewogICAgdmFsdWUoKSB7CiAgICAgIGNvbnN0IGV2ZW50ID0gcGQodGhpcykuZXZlbnQ7CiAgICAgIHJldHVybiBldmVudFtrZXldLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpOwogICAgfSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGVudW1lcmFibGU6IHRydWUKICB9Owp9CgovKioKICogRGVmaW5lIG5ldyB3cmFwcGVyIGNsYXNzLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBCYXNlRXZlbnQgVGhlIGJhc2Ugd3JhcHBlciBjbGFzcy4KICogQHBhcmFtIHtPYmplY3R9IHByb3RvIFRoZSBwcm90b3R5cGUgb2YgdGhlIG9yaWdpbmFsIGV2ZW50LgogKiBAcmV0dXJucyB7RnVuY3Rpb259IFRoZSBkZWZpbmVkIHdyYXBwZXIgY2xhc3MuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBkZWZpbmVXcmFwcGVyKEJhc2VFdmVudCwgcHJvdG8pIHsKICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocHJvdG8pOwogIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIEJhc2VFdmVudDsKICB9CgogIC8qKiBDdXN0b21FdmVudCAqLwogIGZ1bmN0aW9uIEN1c3RvbUV2ZW50KGV2ZW50VGFyZ2V0LCBldmVudCkgewogICAgQmFzZUV2ZW50LmNhbGwodGhpcywgZXZlbnRUYXJnZXQsIGV2ZW50KTsKICB9CiAgQ3VzdG9tRXZlbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShCYXNlRXZlbnQucHJvdG90eXBlLCB7CiAgICBjb25zdHJ1Y3RvcjogewogICAgICB2YWx1ZTogQ3VzdG9tRXZlbnQsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgd3JpdGFibGU6IHRydWUKICAgIH0KICB9KTsKCiAgLy8gRGVmaW5lIGFjY2Vzc29ycy4KICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICBpZiAoIShrZXkgaW4gQmFzZUV2ZW50LnByb3RvdHlwZSkpIHsKICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8sIGtleSk7CiAgICAgIGNvbnN0IGlzRnVuYyA9IHR5cGVvZiBkZXNjcmlwdG9yLnZhbHVlID09PSAiZnVuY3Rpb24iOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ3VzdG9tRXZlbnQucHJvdG90eXBlLCBrZXksIGlzRnVuYyA/IGRlZmluZUNhbGxEZXNjcmlwdG9yKGtleSkgOiBkZWZpbmVSZWRpcmVjdERlc2NyaXB0b3Ioa2V5KSk7CiAgICB9CiAgfQogIHJldHVybiBDdXN0b21FdmVudDsKfQoKLyoqCiAqIEdldCB0aGUgd3JhcHBlciBjbGFzcyBvZiBhIGdpdmVuIHByb3RvdHlwZS4KICogQHBhcmFtIHtPYmplY3R9IHByb3RvIFRoZSBwcm90b3R5cGUgb2YgdGhlIG9yaWdpbmFsIGV2ZW50IHRvIGdldCBpdHMgd3JhcHBlci4KICogQHJldHVybnMge0Z1bmN0aW9ufSBUaGUgd3JhcHBlciBjbGFzcy4KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIGdldFdyYXBwZXIocHJvdG8pIHsKICBpZiAocHJvdG8gPT0gbnVsbCB8fCBwcm90byA9PT0gT2JqZWN0LnByb3RvdHlwZSkgewogICAgcmV0dXJuIEV2ZW50OwogIH0KICBsZXQgd3JhcHBlciA9IHdyYXBwZXJzLmdldChwcm90byk7CiAgaWYgKHdyYXBwZXIgPT0gbnVsbCkgewogICAgd3JhcHBlciA9IGRlZmluZVdyYXBwZXIoZ2V0V3JhcHBlcihPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8pKSwgcHJvdG8pOwogICAgd3JhcHBlcnMuc2V0KHByb3RvLCB3cmFwcGVyKTsKICB9CiAgcmV0dXJuIHdyYXBwZXI7Cn0KCi8qKgogKiBXcmFwIGEgZ2l2ZW4gZXZlbnQgdG8gbWFuYWdlbWVudCBhIGRpc3BhdGNoaW5nLgogKiBAcGFyYW0ge0V2ZW50VGFyZ2V0fSBldmVudFRhcmdldCBUaGUgZXZlbnQgdGFyZ2V0IG9mIHRoaXMgZGlzcGF0Y2hpbmcuCiAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBUaGUgZXZlbnQgdG8gd3JhcC4KICogQHJldHVybnMge0V2ZW50fSBUaGUgd3JhcHBlciBpbnN0YW5jZS4KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIHdyYXBFdmVudChldmVudFRhcmdldCwgZXZlbnQpIHsKICBjb25zdCBXcmFwcGVyID0gZ2V0V3JhcHBlcihPYmplY3QuZ2V0UHJvdG90eXBlT2YoZXZlbnQpKTsKICByZXR1cm4gbmV3IFdyYXBwZXIoZXZlbnRUYXJnZXQsIGV2ZW50KTsKfQoKLyoqCiAqIEdldCB0aGUgaW1tZWRpYXRlU3RvcHBlZCBmbGFnIG9mIGEgZ2l2ZW4gZXZlbnQuCiAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IFRoZSBldmVudCB0byBnZXQuCiAqIEByZXR1cm5zIHtib29sZWFufSBUaGUgZmxhZyB0byBzdG9wIHByb3BhZ2F0aW9uIGltbWVkaWF0ZWx5LgogKiBAcHJpdmF0ZQogKi8KZnVuY3Rpb24gaXNTdG9wcGVkKGV2ZW50KSB7CiAgcmV0dXJuIHBkKGV2ZW50KS5pbW1lZGlhdGVTdG9wcGVkOwp9CgovKioKICogU2V0IHRoZSBjdXJyZW50IGV2ZW50IHBoYXNlIG9mIGEgZ2l2ZW4gZXZlbnQuCiAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IFRoZSBldmVudCB0byBzZXQgY3VycmVudCB0YXJnZXQuCiAqIEBwYXJhbSB7bnVtYmVyfSBldmVudFBoYXNlIE5ldyBldmVudCBwaGFzZS4KICogQHJldHVybnMge3ZvaWR9CiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBzZXRFdmVudFBoYXNlKGV2ZW50LCBldmVudFBoYXNlKSB7CiAgcGQoZXZlbnQpLmV2ZW50UGhhc2UgPSBldmVudFBoYXNlOwp9CgovKioKICogU2V0IHRoZSBjdXJyZW50IHRhcmdldCBvZiBhIGdpdmVuIGV2ZW50LgogKiBAcGFyYW0ge0V2ZW50fSBldmVudCBUaGUgZXZlbnQgdG8gc2V0IGN1cnJlbnQgdGFyZ2V0LgogKiBAcGFyYW0ge0V2ZW50VGFyZ2V0fG51bGx9IGN1cnJlbnRUYXJnZXQgTmV3IGN1cnJlbnQgdGFyZ2V0LgogKiBAcmV0dXJucyB7dm9pZH0KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIHNldEN1cnJlbnRUYXJnZXQoZXZlbnQsIGN1cnJlbnRUYXJnZXQpIHsKICBwZChldmVudCkuY3VycmVudFRhcmdldCA9IGN1cnJlbnRUYXJnZXQ7Cn0KCi8qKgogKiBTZXQgYSBwYXNzaXZlIGxpc3RlbmVyIG9mIGEgZ2l2ZW4gZXZlbnQuCiAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IFRoZSBldmVudCB0byBzZXQgY3VycmVudCB0YXJnZXQuCiAqIEBwYXJhbSB7RnVuY3Rpb258bnVsbH0gcGFzc2l2ZUxpc3RlbmVyIE5ldyBwYXNzaXZlIGxpc3RlbmVyLgogKiBAcmV0dXJucyB7dm9pZH0KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIHNldFBhc3NpdmVMaXN0ZW5lcihldmVudCwgcGFzc2l2ZUxpc3RlbmVyKSB7CiAgcGQoZXZlbnQpLnBhc3NpdmVMaXN0ZW5lciA9IHBhc3NpdmVMaXN0ZW5lcjsKfQoKLyoqCiAqIEB0eXBlZGVmIHtvYmplY3R9IExpc3RlbmVyTm9kZQogKiBAcHJvcGVydHkge0Z1bmN0aW9ufSBsaXN0ZW5lcgogKiBAcHJvcGVydHkgezF8MnwzfSBsaXN0ZW5lclR5cGUKICogQHByb3BlcnR5IHtib29sZWFufSBwYXNzaXZlCiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb25jZQogKiBAcHJvcGVydHkge0xpc3RlbmVyTm9kZXxudWxsfSBuZXh0CiAqIEBwcml2YXRlCiAqLwoKLyoqCiAqIEB0eXBlIHtXZWFrTWFwPG9iamVjdCwgTWFwPHN0cmluZywgTGlzdGVuZXJOb2RlPj59CiAqIEBwcml2YXRlCiAqLwpjb25zdCBsaXN0ZW5lcnNNYXAgPSBuZXcgV2Vha01hcCgpOwoKLy8gTGlzdGVuZXIgdHlwZXMKY29uc3QgQ0FQVFVSRSA9IDE7CmNvbnN0IEJVQkJMRSA9IDI7CmNvbnN0IEFUVFJJQlVURSA9IDM7CgovKioKICogQ2hlY2sgd2hldGhlciBhIGdpdmVuIHZhbHVlIGlzIGFuIG9iamVjdCBvciBub3QuCiAqIEBwYXJhbSB7YW55fSB4IFRoZSB2YWx1ZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgdmFsdWUgaXMgYW4gb2JqZWN0LgogKi8KZnVuY3Rpb24gaXNPYmplY3QkMSh4KSB7CiAgcmV0dXJuIHggIT09IG51bGwgJiYgdHlwZW9mIHggPT09ICJvYmplY3QiOyAvL2VzbGludC1kaXNhYmxlLWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXgKfQoKLyoqCiAqIEdldCBsaXN0ZW5lcnMuCiAqIEBwYXJhbSB7RXZlbnRUYXJnZXR9IGV2ZW50VGFyZ2V0IFRoZSBldmVudCB0YXJnZXQgdG8gZ2V0LgogKiBAcmV0dXJucyB7TWFwPHN0cmluZywgTGlzdGVuZXJOb2RlPn0gVGhlIGxpc3RlbmVycy4KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIGdldExpc3RlbmVycyhldmVudFRhcmdldCkgewogIGNvbnN0IGxpc3RlbmVycyA9IGxpc3RlbmVyc01hcC5nZXQoZXZlbnRUYXJnZXQpOwogIGlmIChsaXN0ZW5lcnMgPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiJ3RoaXMnIGlzIGV4cGVjdGVkIGFuIEV2ZW50VGFyZ2V0IG9iamVjdCwgYnV0IGdvdCBhbm90aGVyIHZhbHVlLiIpOwogIH0KICByZXR1cm4gbGlzdGVuZXJzOwp9CgovKioKICogR2V0IHRoZSBwcm9wZXJ0eSBkZXNjcmlwdG9yIGZvciB0aGUgZXZlbnQgYXR0cmlidXRlIG9mIGEgZ2l2ZW4gZXZlbnQuCiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgVGhlIGV2ZW50IG5hbWUgdG8gZ2V0IHByb3BlcnR5IGRlc2NyaXB0b3IuCiAqIEByZXR1cm5zIHtQcm9wZXJ0eURlc2NyaXB0b3J9IFRoZSBwcm9wZXJ0eSBkZXNjcmlwdG9yLgogKiBAcHJpdmF0ZQogKi8KZnVuY3Rpb24gZGVmaW5lRXZlbnRBdHRyaWJ1dGVEZXNjcmlwdG9yKGV2ZW50TmFtZSkgewogIHJldHVybiB7CiAgICBnZXQoKSB7CiAgICAgIGNvbnN0IGxpc3RlbmVycyA9IGdldExpc3RlbmVycyh0aGlzKTsKICAgICAgbGV0IG5vZGUgPSBsaXN0ZW5lcnMuZ2V0KGV2ZW50TmFtZSk7CiAgICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgICBpZiAobm9kZS5saXN0ZW5lclR5cGUgPT09IEFUVFJJQlVURSkgewogICAgICAgICAgcmV0dXJuIG5vZGUubGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgc2V0KGxpc3RlbmVyKSB7CiAgICAgIGlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICJmdW5jdGlvbiIgJiYgIWlzT2JqZWN0JDEobGlzdGVuZXIpKSB7CiAgICAgICAgbGlzdGVuZXIgPSBudWxsOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXBhcmFtLXJlYXNzaWduCiAgICAgIH0KICAgICAgY29uc3QgbGlzdGVuZXJzID0gZ2V0TGlzdGVuZXJzKHRoaXMpOwoKICAgICAgLy8gVHJhdmVyc2UgdG8gdGhlIHRhaWwgd2hpbGUgcmVtb3Zpbmcgb2xkIHZhbHVlLgogICAgICBsZXQgcHJldiA9IG51bGw7CiAgICAgIGxldCBub2RlID0gbGlzdGVuZXJzLmdldChldmVudE5hbWUpOwogICAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgaWYgKG5vZGUubGlzdGVuZXJUeXBlID09PSBBVFRSSUJVVEUpIHsKICAgICAgICAgIC8vIFJlbW92ZSBvbGQgdmFsdWUuCiAgICAgICAgICBpZiAocHJldiAhPT0gbnVsbCkgewogICAgICAgICAgICBwcmV2Lm5leHQgPSBub2RlLm5leHQ7CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICBsaXN0ZW5lcnMuc2V0KGV2ZW50TmFtZSwgbm9kZS5uZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3RlbmVycy5kZWxldGUoZXZlbnROYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJldiA9IG5vZGU7CiAgICAgICAgfQogICAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICAgIH0KCiAgICAgIC8vIEFkZCBuZXcgdmFsdWUuCiAgICAgIGlmIChsaXN0ZW5lciAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IG5ld05vZGUgPSB7CiAgICAgICAgICBsaXN0ZW5lciwKICAgICAgICAgIGxpc3RlbmVyVHlwZTogQVRUUklCVVRFLAogICAgICAgICAgcGFzc2l2ZTogZmFsc2UsCiAgICAgICAgICBvbmNlOiBmYWxzZSwKICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICB9OwogICAgICAgIGlmIChwcmV2ID09PSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc2V0KGV2ZW50TmFtZSwgbmV3Tm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByZXYubmV4dCA9IG5ld05vZGU7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZW51bWVyYWJsZTogdHJ1ZQogIH07Cn0KCi8qKgogKiBEZWZpbmUgYW4gZXZlbnQgYXR0cmlidXRlIChlLmcuIGBldmVudFRhcmdldC5vbmNsaWNrYCkuCiAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFRhcmdldFByb3RvdHlwZSBUaGUgZXZlbnQgdGFyZ2V0IHByb3RvdHlwZSB0byBkZWZpbmUgYW4gZXZlbnQgYXR0cmJpdGUuCiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWUgVGhlIGV2ZW50IG5hbWUgdG8gZGVmaW5lLgogKiBAcmV0dXJucyB7dm9pZH0KICovCmZ1bmN0aW9uIGRlZmluZUV2ZW50QXR0cmlidXRlKGV2ZW50VGFyZ2V0UHJvdG90eXBlLCBldmVudE5hbWUpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXZlbnRUYXJnZXRQcm90b3R5cGUsIGBvbiR7ZXZlbnROYW1lfWAsIGRlZmluZUV2ZW50QXR0cmlidXRlRGVzY3JpcHRvcihldmVudE5hbWUpKTsKfQoKLyoqCiAqIERlZmluZSBhIGN1c3RvbSBFdmVudFRhcmdldCB3aXRoIGV2ZW50IGF0dHJpYnV0ZXMuCiAqIEBwYXJhbSB7c3RyaW5nW119IGV2ZW50TmFtZXMgRXZlbnQgbmFtZXMgZm9yIGV2ZW50IGF0dHJpYnV0ZXMuCiAqIEByZXR1cm5zIHtFdmVudFRhcmdldH0gVGhlIGN1c3RvbSBFdmVudFRhcmdldC4KICogQHByaXZhdGUKICovCmZ1bmN0aW9uIGRlZmluZUN1c3RvbUV2ZW50VGFyZ2V0KGV2ZW50TmFtZXMpIHsKICAvKiogQ3VzdG9tRXZlbnRUYXJnZXQgKi8KICBmdW5jdGlvbiBDdXN0b21FdmVudFRhcmdldCgpIHsKICAgIEV2ZW50VGFyZ2V0LmNhbGwodGhpcyk7CiAgfQogIEN1c3RvbUV2ZW50VGFyZ2V0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXZlbnRUYXJnZXQucHJvdG90eXBlLCB7CiAgICBjb25zdHJ1Y3RvcjogewogICAgICB2YWx1ZTogQ3VzdG9tRXZlbnRUYXJnZXQsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgd3JpdGFibGU6IHRydWUKICAgIH0KICB9KTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50TmFtZXMubGVuZ3RoOyArK2kpIHsKICAgIGRlZmluZUV2ZW50QXR0cmlidXRlKEN1c3RvbUV2ZW50VGFyZ2V0LnByb3RvdHlwZSwgZXZlbnROYW1lc1tpXSk7CiAgfQogIHJldHVybiBDdXN0b21FdmVudFRhcmdldDsKfQoKLyoqCiAqIEV2ZW50VGFyZ2V0LgogKgogKiAtIFRoaXMgaXMgY29uc3RydWN0b3IgaWYgbm8gYXJndW1lbnRzLgogKiAtIFRoaXMgaXMgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgQ3VzdG9tRXZlbnRUYXJnZXQgY29uc3RydWN0b3IgaWYgdGhlcmUgYXJlIGFyZ3VtZW50cy4KICoKICogRm9yIGV4YW1wbGU6CiAqCiAqICAgICBjbGFzcyBBIGV4dGVuZHMgRXZlbnRUYXJnZXQge30KICogICAgIGNsYXNzIEIgZXh0ZW5kcyBFdmVudFRhcmdldCgibWVzc2FnZSIpIHt9CiAqICAgICBjbGFzcyBDIGV4dGVuZHMgRXZlbnRUYXJnZXQoIm1lc3NhZ2UiLCAiZXJyb3IiKSB7fQogKiAgICAgY2xhc3MgRCBleHRlbmRzIEV2ZW50VGFyZ2V0KFsibWVzc2FnZSIsICJlcnJvciJdKSB7fQogKi8KZnVuY3Rpb24gRXZlbnRUYXJnZXQoKSB7CiAgLyplc2xpbnQtZGlzYWJsZSBjb25zaXN0ZW50LXJldHVybiAqLwogIGlmICh0aGlzIGluc3RhbmNlb2YgRXZlbnRUYXJnZXQpIHsKICAgIGxpc3RlbmVyc01hcC5zZXQodGhpcywgbmV3IE1hcCgpKTsKICAgIHJldHVybjsKICB9CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShhcmd1bWVudHNbMF0pKSB7CiAgICByZXR1cm4gZGVmaW5lQ3VzdG9tRXZlbnRUYXJnZXQoYXJndW1lbnRzWzBdKTsKICB9CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB0eXBlcyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgIHR5cGVzW2ldID0gYXJndW1lbnRzW2ldOwogICAgfQogICAgcmV0dXJuIGRlZmluZUN1c3RvbUV2ZW50VGFyZ2V0KHR5cGVzKTsKICB9CiAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7CiAgLyplc2xpbnQtZW5hYmxlIGNvbnNpc3RlbnQtcmV0dXJuICovCn0KCi8vIFNob3VsZCBiZSBlbnVtZXJhYmxlLCBidXQgY2xhc3MgbWV0aG9kcyBhcmUgbm90IGVudW1lcmFibGUuCkV2ZW50VGFyZ2V0LnByb3RvdHlwZSA9IHsKICAvKioKICAgKiBBZGQgYSBnaXZlbiBsaXN0ZW5lciB0byB0aGlzIGV2ZW50IHRhcmdldC4KICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lIFRoZSBldmVudCBuYW1lIHRvIGFkZC4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIgdG8gYWRkLgogICAqIEBwYXJhbSB7Ym9vbGVhbnx7Y2FwdHVyZT86Ym9vbGVhbixwYXNzaXZlPzpib29sZWFuLG9uY2U/OmJvb2xlYW59fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgZm9yIHRoaXMgbGlzdGVuZXIuCiAgICogQHJldHVybnMge3ZvaWR9CiAgICovCiAgYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyLCBvcHRpb25zKSB7CiAgICBpZiAobGlzdGVuZXIgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAiZnVuY3Rpb24iICYmICFpc09iamVjdCQxKGxpc3RlbmVyKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCInbGlzdGVuZXInIHNob3VsZCBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdC4iKTsKICAgIH0KICAgIGNvbnN0IGxpc3RlbmVycyA9IGdldExpc3RlbmVycyh0aGlzKTsKICAgIGNvbnN0IG9wdGlvbnNJc09iaiA9IGlzT2JqZWN0JDEob3B0aW9ucyk7CiAgICBjb25zdCBjYXB0dXJlID0gb3B0aW9uc0lzT2JqID8gQm9vbGVhbihvcHRpb25zLmNhcHR1cmUpIDogQm9vbGVhbihvcHRpb25zKTsKICAgIGNvbnN0IGxpc3RlbmVyVHlwZSA9IGNhcHR1cmUgPyBDQVBUVVJFIDogQlVCQkxFOwogICAgY29uc3QgbmV3Tm9kZSA9IHsKICAgICAgbGlzdGVuZXIsCiAgICAgIGxpc3RlbmVyVHlwZSwKICAgICAgcGFzc2l2ZTogb3B0aW9uc0lzT2JqICYmIEJvb2xlYW4ob3B0aW9ucy5wYXNzaXZlKSwKICAgICAgb25jZTogb3B0aW9uc0lzT2JqICYmIEJvb2xlYW4ob3B0aW9ucy5vbmNlKSwKICAgICAgbmV4dDogbnVsbAogICAgfTsKCiAgICAvLyBTZXQgaXQgYXMgdGhlIGZpcnN0IG5vZGUgaWYgdGhlIGZpcnN0IG5vZGUgaXMgbnVsbC4KICAgIGxldCBub2RlID0gbGlzdGVuZXJzLmdldChldmVudE5hbWUpOwogICAgaWYgKG5vZGUgPT09IHVuZGVmaW5lZCkgewogICAgICBsaXN0ZW5lcnMuc2V0KGV2ZW50TmFtZSwgbmV3Tm9kZSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBUcmF2ZXJzZSB0byB0aGUgdGFpbCB3aGlsZSBjaGVja2luZyBkdXBsaWNhdGlvbi4uCiAgICBsZXQgcHJldiA9IG51bGw7CiAgICB3aGlsZSAobm9kZSAhPSBudWxsKSB7CiAgICAgIGlmIChub2RlLmxpc3RlbmVyID09PSBsaXN0ZW5lciAmJiBub2RlLmxpc3RlbmVyVHlwZSA9PT0gbGlzdGVuZXJUeXBlKSB7CiAgICAgICAgLy8gU2hvdWxkIGlnbm9yZSBkdXBsaWNhdGlvbi4KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcHJldiA9IG5vZGU7CiAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICB9CgogICAgLy8gQWRkIGl0LgogICAgcHJldi5uZXh0ID0gbmV3Tm9kZTsKICB9LAogIC8qKgogICAqIFJlbW92ZSBhIGdpdmVuIGxpc3RlbmVyIGZyb20gdGhpcyBldmVudCB0YXJnZXQuCiAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZSBUaGUgZXZlbnQgbmFtZSB0byByZW1vdmUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIHRvIHJlbW92ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW58e2NhcHR1cmU/OmJvb2xlYW4scGFzc2l2ZT86Ym9vbGVhbixvbmNlPzpib29sZWFufX0gW29wdGlvbnNdIFRoZSBvcHRpb25zIGZvciB0aGlzIGxpc3RlbmVyLgogICAqIEByZXR1cm5zIHt2b2lkfQogICAqLwogIHJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lciwgb3B0aW9ucykgewogICAgaWYgKGxpc3RlbmVyID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbGlzdGVuZXJzID0gZ2V0TGlzdGVuZXJzKHRoaXMpOwogICAgY29uc3QgY2FwdHVyZSA9IGlzT2JqZWN0JDEob3B0aW9ucykgPyBCb29sZWFuKG9wdGlvbnMuY2FwdHVyZSkgOiBCb29sZWFuKG9wdGlvbnMpOwogICAgY29uc3QgbGlzdGVuZXJUeXBlID0gY2FwdHVyZSA/IENBUFRVUkUgOiBCVUJCTEU7CiAgICBsZXQgcHJldiA9IG51bGw7CiAgICBsZXQgbm9kZSA9IGxpc3RlbmVycy5nZXQoZXZlbnROYW1lKTsKICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgaWYgKG5vZGUubGlzdGVuZXIgPT09IGxpc3RlbmVyICYmIG5vZGUubGlzdGVuZXJUeXBlID09PSBsaXN0ZW5lclR5cGUpIHsKICAgICAgICBpZiAocHJldiAhPT0gbnVsbCkgewogICAgICAgICAgcHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgIH0gZWxzZSBpZiAobm9kZS5uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc2V0KGV2ZW50TmFtZSwgbm9kZS5uZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGlzdGVuZXJzLmRlbGV0ZShldmVudE5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcHJldiA9IG5vZGU7CiAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICB9CiAgfSwKICAvKioKICAgKiBEaXNwYXRjaCBhIGdpdmVuIGV2ZW50LgogICAqIEBwYXJhbSB7RXZlbnR8e3R5cGU6c3RyaW5nfX0gZXZlbnQgVGhlIGV2ZW50IHRvIGRpc3BhdGNoLgogICAqIEByZXR1cm5zIHtib29sZWFufSBgZmFsc2VgIGlmIGNhbmNlbGVkLgogICAqLwogIGRpc3BhdGNoRXZlbnQoZXZlbnQpIHsKICAgIGlmIChldmVudCA9PSBudWxsIHx8IHR5cGVvZiBldmVudC50eXBlICE9PSAic3RyaW5nIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCciZXZlbnQudHlwZSIgc2hvdWxkIGJlIGEgc3RyaW5nLicpOwogICAgfQoKICAgIC8vIElmIGxpc3RlbmVycyBhcmVuJ3QgcmVnaXN0ZXJlZCwgdGVybWluYXRlLgogICAgY29uc3QgbGlzdGVuZXJzID0gZ2V0TGlzdGVuZXJzKHRoaXMpOwogICAgY29uc3QgZXZlbnROYW1lID0gZXZlbnQudHlwZTsKICAgIGxldCBub2RlID0gbGlzdGVuZXJzLmdldChldmVudE5hbWUpOwogICAgaWYgKG5vZGUgPT0gbnVsbCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLyBTaW5jZSB3ZSBjYW5ub3QgcmV3cml0ZSBzZXZlcmFsIHByb3BlcnRpZXMsIHNvIHdyYXAgb2JqZWN0LgogICAgY29uc3Qgd3JhcHBlZEV2ZW50ID0gd3JhcEV2ZW50KHRoaXMsIGV2ZW50KTsKCiAgICAvLyBUaGlzIGRvZXNuJ3QgcHJvY2VzcyBjYXB0dXJpbmcgcGhhc2UgYW5kIGJ1YmJsaW5nIHBoYXNlLgogICAgLy8gVGhpcyBpc24ndCBwYXJ0aWNpcGF0aW5nIGluIGEgdHJlZS4KICAgIGxldCBwcmV2ID0gbnVsbDsKICAgIHdoaWxlIChub2RlICE9IG51bGwpIHsKICAgICAgLy8gUmVtb3ZlIHRoaXMgbGlzdGVuZXIgaWYgaXQncyBvbmNlCiAgICAgIGlmIChub2RlLm9uY2UpIHsKICAgICAgICBpZiAocHJldiAhPT0gbnVsbCkgewogICAgICAgICAgcHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgIH0gZWxzZSBpZiAobm9kZS5uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc2V0KGV2ZW50TmFtZSwgbm9kZS5uZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGlzdGVuZXJzLmRlbGV0ZShldmVudE5hbWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBwcmV2ID0gbm9kZTsKICAgICAgfQoKICAgICAgLy8gQ2FsbCB0aGlzIGxpc3RlbmVyCiAgICAgIHNldFBhc3NpdmVMaXN0ZW5lcih3cmFwcGVkRXZlbnQsIG5vZGUucGFzc2l2ZSA/IG5vZGUubGlzdGVuZXIgOiBudWxsKTsKICAgICAgaWYgKHR5cGVvZiBub2RlLmxpc3RlbmVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG5vZGUubGlzdGVuZXIuY2FsbCh0aGlzLCB3cmFwcGVkRXZlbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5vZGUubGlzdGVuZXJUeXBlICE9PSBBVFRSSUJVVEUgJiYgdHlwZW9mIG5vZGUubGlzdGVuZXIuaGFuZGxlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBub2RlLmxpc3RlbmVyLmhhbmRsZUV2ZW50KHdyYXBwZWRFdmVudCk7CiAgICAgIH0KCiAgICAgIC8vIEJyZWFrIGlmIGBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb25gIHdhcyBjYWxsZWQuCiAgICAgIGlmIChpc1N0b3BwZWQod3JhcHBlZEV2ZW50KSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIG5vZGUgPSBub2RlLm5leHQ7CiAgICB9CiAgICBzZXRQYXNzaXZlTGlzdGVuZXIod3JhcHBlZEV2ZW50LCBudWxsKTsKICAgIHNldEV2ZW50UGhhc2Uod3JhcHBlZEV2ZW50LCAwKTsKICAgIHNldEN1cnJlbnRUYXJnZXQod3JhcHBlZEV2ZW50LCBudWxsKTsKICAgIHJldHVybiAhd3JhcHBlZEV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgfQp9OwoKLy8gYGNvbnN0cnVjdG9yYCBpcyBub3QgZW51bWVyYWJsZS4KT2JqZWN0LmRlZmluZVByb3BlcnR5KEV2ZW50VGFyZ2V0LnByb3RvdHlwZSwgImNvbnN0cnVjdG9yIiwgewogIHZhbHVlOiBFdmVudFRhcmdldCwKICBjb25maWd1cmFibGU6IHRydWUsCiAgd3JpdGFibGU6IHRydWUKfSk7CgovLyBFbnN1cmUgYGV2ZW50VGFyZ2V0IGluc3RhbmNlb2Ygd2luZG93LkV2ZW50VGFyZ2V0YCBpcyBgdHJ1ZWAuCmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LkV2ZW50VGFyZ2V0ICE9PSAidW5kZWZpbmVkIikgewogIE9iamVjdC5zZXRQcm90b3R5cGVPZihFdmVudFRhcmdldC5wcm90b3R5cGUsIHdpbmRvdy5FdmVudFRhcmdldC5wcm90b3R5cGUpOwp9CgovKioKICogQGF1dGhvciBUb3J1IE5hZ2FzaGltYSA8aHR0cHM6Ly9naXRodWIuY29tL215c3RpY2F0ZWE+CiAqIFNlZSBMSUNFTlNFIGZpbGUgaW4gcm9vdCBkaXJlY3RvcnkgZm9yIGZ1bGwgbGljZW5zZS4KICovCgovKioKICogVGhlIHNpZ25hbCBjbGFzcy4KICogQHNlZSBodHRwczovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2Fib3J0c2lnbmFsCiAqLwpjbGFzcyBBYm9ydFNpZ25hbCBleHRlbmRzIEV2ZW50VGFyZ2V0IHsKICAvKioKICAgKiBBYm9ydFNpZ25hbCBjYW5ub3QgYmUgY29uc3RydWN0ZWQgZGlyZWN0bHkuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQWJvcnRTaWduYWwgY2Fubm90IGJlIGNvbnN0cnVjdGVkIGRpcmVjdGx5Iik7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoaXMgYEFib3J0U2lnbmFsYCdzIGBBYm9ydENvbnRyb2xsZXJgIGhhcyBzaWduYWxlZCB0byBhYm9ydCwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLgogICAqLwogIGdldCBhYm9ydGVkKCkgewogICAgY29uc3QgYWJvcnRlZCA9IGFib3J0ZWRGbGFncy5nZXQodGhpcyk7CiAgICBpZiAodHlwZW9mIGFib3J0ZWQgIT09ICJib29sZWFuIikgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBFeHBlY3RlZCAndGhpcycgdG8gYmUgYW4gJ0Fib3J0U2lnbmFsJyBvYmplY3QsIGJ1dCBnb3QgJHt0aGlzID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHRoaXN9YCk7CiAgICB9CiAgICByZXR1cm4gYWJvcnRlZDsKICB9Cn0KZGVmaW5lRXZlbnRBdHRyaWJ1dGUoQWJvcnRTaWduYWwucHJvdG90eXBlLCAiYWJvcnQiKTsKLyoqCiAqIENyZWF0ZSBhbiBBYm9ydFNpZ25hbCBvYmplY3QuCiAqLwpmdW5jdGlvbiBjcmVhdGVBYm9ydFNpZ25hbCgpIHsKICBjb25zdCBzaWduYWwgPSBPYmplY3QuY3JlYXRlKEFib3J0U2lnbmFsLnByb3RvdHlwZSk7CiAgRXZlbnRUYXJnZXQuY2FsbChzaWduYWwpOwogIGFib3J0ZWRGbGFncy5zZXQoc2lnbmFsLCBmYWxzZSk7CiAgcmV0dXJuIHNpZ25hbDsKfQovKioKICogQWJvcnQgYSBnaXZlbiBzaWduYWwuCiAqLwpmdW5jdGlvbiBhYm9ydFNpZ25hbChzaWduYWwpIHsKICBpZiAoYWJvcnRlZEZsYWdzLmdldChzaWduYWwpICE9PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0KICBhYm9ydGVkRmxhZ3Muc2V0KHNpZ25hbCwgdHJ1ZSk7CiAgc2lnbmFsLmRpc3BhdGNoRXZlbnQoewogICAgdHlwZTogImFib3J0IgogIH0pOwp9Ci8qKgogKiBBYm9ydGVkIGZsYWcgZm9yIGVhY2ggaW5zdGFuY2VzLgogKi8KY29uc3QgYWJvcnRlZEZsYWdzID0gbmV3IFdlYWtNYXAoKTsKLy8gUHJvcGVydGllcyBzaG91bGQgYmUgZW51bWVyYWJsZS4KT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQWJvcnRTaWduYWwucHJvdG90eXBlLCB7CiAgYWJvcnRlZDogewogICAgZW51bWVyYWJsZTogdHJ1ZQogIH0KfSk7Ci8vIGB0b1N0cmluZygpYCBzaG91bGQgcmV0dXJuIGAiW29iamVjdCBBYm9ydFNpZ25hbF0iYAppZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLnRvU3RyaW5nVGFnID09PSAic3ltYm9sIikgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShBYm9ydFNpZ25hbC5wcm90b3R5cGUsIFN5bWJvbC50b1N0cmluZ1RhZywgewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgdmFsdWU6ICJBYm9ydFNpZ25hbCIKICB9KTsKfQoKLyoqCiAqIFRoZSBBYm9ydENvbnRyb2xsZXIuCiAqIEBzZWUgaHR0cHM6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNhYm9ydGNvbnRyb2xsZXIKICovCmNsYXNzIEFib3J0Q29udHJvbGxlciB7CiAgLyoqCiAgICogSW5pdGlhbGl6ZSB0aGlzIGNvbnRyb2xsZXIuCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgICBzaWduYWxzLnNldCh0aGlzLCBjcmVhdGVBYm9ydFNpZ25hbCgpKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgYEFib3J0U2lnbmFsYCBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMgb2JqZWN0LgogICAqLwogIGdldCBzaWduYWwoKSB7CiAgICByZXR1cm4gZ2V0U2lnbmFsKHRoaXMpOwogIH0KICAvKioKICAgKiBBYm9ydCBhbmQgc2lnbmFsIHRvIGFueSBvYnNlcnZlcnMgdGhhdCB0aGUgYXNzb2NpYXRlZCBhY3Rpdml0eSBpcyB0byBiZSBhYm9ydGVkLgogICAqLwogIGFib3J0KCkgewogICAgYWJvcnRTaWduYWwoZ2V0U2lnbmFsKHRoaXMpKTsKICB9Cn0KLyoqCiAqIEFzc29jaWF0ZWQgc2lnbmFscy4KICovCmNvbnN0IHNpZ25hbHMgPSBuZXcgV2Vha01hcCgpOwovKioKICogR2V0IHRoZSBhc3NvY2lhdGVkIHNpZ25hbCBvZiBhIGdpdmVuIGNvbnRyb2xsZXIuCiAqLwpmdW5jdGlvbiBnZXRTaWduYWwoY29udHJvbGxlcikgewogIGNvbnN0IHNpZ25hbCA9IHNpZ25hbHMuZ2V0KGNvbnRyb2xsZXIpOwogIGlmIChzaWduYWwgPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgRXhwZWN0ZWQgJ3RoaXMnIHRvIGJlIGFuICdBYm9ydENvbnRyb2xsZXInIG9iamVjdCwgYnV0IGdvdCAke2NvbnRyb2xsZXIgPT09IG51bGwgPyAibnVsbCIgOiB0eXBlb2YgY29udHJvbGxlcn1gKTsKICB9CiAgcmV0dXJuIHNpZ25hbDsKfQovLyBQcm9wZXJ0aWVzIHNob3VsZCBiZSBlbnVtZXJhYmxlLgpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhBYm9ydENvbnRyb2xsZXIucHJvdG90eXBlLCB7CiAgc2lnbmFsOiB7CiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSwKICBhYm9ydDogewogICAgZW51bWVyYWJsZTogdHJ1ZQogIH0KfSk7CmlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wudG9TdHJpbmdUYWcgPT09ICJzeW1ib2wiKSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEFib3J0Q29udHJvbGxlci5wcm90b3R5cGUsIFN5bWJvbC50b1N0cmluZ1RhZywgewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgdmFsdWU6ICJBYm9ydENvbnRyb2xsZXIiCiAgfSk7Cn0KCnZhciBhYm9ydENvbnRyb2xsZXIgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CglfX3Byb3RvX186IG51bGwsCglBYm9ydENvbnRyb2xsZXI6IEFib3J0Q29udHJvbGxlciwKCUFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbCwKCWRlZmF1bHQ6IEFib3J0Q29udHJvbGxlcgp9KTsKCnZhciByZXF1aXJlJCQwJDEgPSAvKkBfX1BVUkVfXyovZ2V0QXVnbWVudGVkTmFtZXNwYWNlKGFib3J0Q29udHJvbGxlcik7Cgp2YXIgaGFzUmVxdWlyZWRVdGlsJDE7CmZ1bmN0aW9uIHJlcXVpcmVVdGlsJDEoKSB7CiAgaWYgKGhhc1JlcXVpcmVkVXRpbCQxKSByZXR1cm4gdXRpbCQyLmV4cG9ydHM7CiAgaGFzUmVxdWlyZWRVdGlsJDEgPSAxOwogIChmdW5jdGlvbiAobW9kdWxlKSB7CgogICAgY29uc3QgYnVmZmVyTW9kdWxlID0gcmVxdWlyZSQkMCQzOwogICAgY29uc3QgewogICAgICBmb3JtYXQsCiAgICAgIGluc3BlY3QKICAgIH0gPSByZXF1aXJlSW5zcGVjdCgpOwogICAgY29uc3QgewogICAgICBjb2RlczogewogICAgICAgIEVSUl9JTlZBTElEX0FSR19UWVBFCiAgICAgIH0KICAgIH0gPSByZXF1aXJlRXJyb3JzKCk7CiAgICBjb25zdCB7CiAgICAgIGtSZXNpc3RTdG9wUHJvcGFnYXRpb24sCiAgICAgIEFnZ3JlZ2F0ZUVycm9yLAogICAgICBTeW1ib2xEaXNwb3NlCiAgICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgICBjb25zdCBBYm9ydFNpZ25hbCA9IGdsb2JhbFRoaXMuQWJvcnRTaWduYWwgfHwgcmVxdWlyZSQkMCQxLkFib3J0U2lnbmFsOwogICAgY29uc3QgQWJvcnRDb250cm9sbGVyID0gZ2xvYmFsVGhpcy5BYm9ydENvbnRyb2xsZXIgfHwgcmVxdWlyZSQkMCQxLkFib3J0Q29udHJvbGxlcjsKICAgIGNvbnN0IEFzeW5jRnVuY3Rpb24gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXN5bmMgZnVuY3Rpb24gKCkge30pLmNvbnN0cnVjdG9yOwogICAgY29uc3QgQmxvYiA9IGdsb2JhbFRoaXMuQmxvYiB8fCBidWZmZXJNb2R1bGUuQmxvYjsKICAgIC8qIGVzbGludC1kaXNhYmxlIGluZGVudCAqLwogICAgY29uc3QgaXNCbG9iID0gdHlwZW9mIEJsb2IgIT09ICd1bmRlZmluZWQnID8gZnVuY3Rpb24gaXNCbG9iKGIpIHsKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGluZGVudAogICAgICByZXR1cm4gYiBpbnN0YW5jZW9mIEJsb2I7CiAgICB9IDogZnVuY3Rpb24gaXNCbG9iKGIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICAgIC8qIGVzbGludC1lbmFibGUgaW5kZW50ICovCgogICAgY29uc3QgdmFsaWRhdGVBYm9ydFNpZ25hbCA9IChzaWduYWwsIG5hbWUpID0+IHsKICAgICAgaWYgKHNpZ25hbCAhPT0gdW5kZWZpbmVkICYmIChzaWduYWwgPT09IG51bGwgfHwgdHlwZW9mIHNpZ25hbCAhPT0gJ29iamVjdCcgfHwgISgnYWJvcnRlZCcgaW4gc2lnbmFsKSkpIHsKICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUobmFtZSwgJ0Fib3J0U2lnbmFsJywgc2lnbmFsKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHZhbGlkYXRlRnVuY3Rpb24gPSAodmFsdWUsIG5hbWUpID0+IHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnRnVuY3Rpb24nLCB2YWx1ZSk7CiAgICAgIH0KICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgQWdncmVnYXRlRXJyb3IsCiAgICAgIGtFbXB0eU9iamVjdDogT2JqZWN0LmZyZWV6ZSh7fSksCiAgICAgIG9uY2UoY2FsbGJhY2spIHsKICAgICAgICBsZXQgY2FsbGVkID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICguLi5hcmdzKSB7CiAgICAgICAgICBpZiAoY2FsbGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9LAogICAgICBjcmVhdGVEZWZlcnJlZFByb21pc2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICBsZXQgcmVzb2x2ZTsKICAgICAgICBsZXQgcmVqZWN0OwoKICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wYXJhbS1uYW1lcwogICAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHsKICAgICAgICAgIHJlc29sdmUgPSByZXM7CiAgICAgICAgICByZWplY3QgPSByZWo7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByb21pc2UsCiAgICAgICAgICByZXNvbHZlLAogICAgICAgICAgcmVqZWN0CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgcHJvbWlzaWZ5KGZuKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgIGZuKChlcnIsIC4uLmFyZ3MpID0+IHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSguLi5hcmdzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBkZWJ1Z2xvZygpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge307CiAgICAgIH0sCiAgICAgIGZvcm1hdCwKICAgICAgaW5zcGVjdCwKICAgICAgdHlwZXM6IHsKICAgICAgICBpc0FzeW5jRnVuY3Rpb24oZm4pIHsKICAgICAgICAgIHJldHVybiBmbiBpbnN0YW5jZW9mIEFzeW5jRnVuY3Rpb247CiAgICAgICAgfSwKICAgICAgICBpc0FycmF5QnVmZmVyVmlldyhhcnIpIHsKICAgICAgICAgIHJldHVybiBBcnJheUJ1ZmZlci5pc1ZpZXcoYXJyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGlzQmxvYiwKICAgICAgZGVwcmVjYXRlKGZuLCBtZXNzYWdlKSB7CiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9LAogICAgICBhZGRBYm9ydExpc3RlbmVyOiByZXF1aXJlJCQwJDIuYWRkQWJvcnRMaXN0ZW5lciB8fCBmdW5jdGlvbiBhZGRBYm9ydExpc3RlbmVyKHNpZ25hbCwgbGlzdGVuZXIpIHsKICAgICAgICBpZiAoc2lnbmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgnc2lnbmFsJywgJ0Fib3J0U2lnbmFsJywgc2lnbmFsKTsKICAgICAgICB9CiAgICAgICAgdmFsaWRhdGVBYm9ydFNpZ25hbChzaWduYWwsICdzaWduYWwnKTsKICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uKGxpc3RlbmVyLCAnbGlzdGVuZXInKTsKICAgICAgICBsZXQgcmVtb3ZlRXZlbnRMaXN0ZW5lcjsKICAgICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IGxpc3RlbmVyKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBsaXN0ZW5lciwgewogICAgICAgICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgICAgICAgIG9uY2U6IHRydWUsCiAgICAgICAgICAgIFtrUmVzaXN0U3RvcFByb3BhZ2F0aW9uXTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyID0gKCkgPT4gewogICAgICAgICAgICBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBsaXN0ZW5lcik7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgX19wcm90b19fOiBudWxsLAogICAgICAgICAgW1N5bWJvbERpc3Bvc2VdKCkgewogICAgICAgICAgICB2YXIgX3JlbW92ZUV2ZW50TGlzdGVuZXI7CiAgICAgICAgICAgIChfcmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHJlbW92ZUV2ZW50TGlzdGVuZXIpID09PSBudWxsIHx8IF9yZW1vdmVFdmVudExpc3RlbmVyID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfcmVtb3ZlRXZlbnRMaXN0ZW5lcigpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0sCiAgICAgIEFib3J0U2lnbmFsQW55OiBBYm9ydFNpZ25hbC5hbnkgfHwgZnVuY3Rpb24gQWJvcnRTaWduYWxBbnkoc2lnbmFscykgewogICAgICAgIC8vIEZhc3QgcGF0aCBpZiB0aGVyZSBpcyBvbmx5IG9uZSBzaWduYWwuCiAgICAgICAgaWYgKHNpZ25hbHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gc2lnbmFsc1swXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgY29uc3QgYWJvcnQgPSAoKSA9PiBhYy5hYm9ydCgpOwogICAgICAgIHNpZ25hbHMuZm9yRWFjaChzaWduYWwgPT4gewogICAgICAgICAgdmFsaWRhdGVBYm9ydFNpZ25hbChzaWduYWwsICdzaWduYWxzJyk7CiAgICAgICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBhYm9ydCwgewogICAgICAgICAgICBvbmNlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBhYy5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCAoKSA9PiB7CiAgICAgICAgICBzaWduYWxzLmZvckVhY2goc2lnbmFsID0+IHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCdhYm9ydCcsIGFib3J0KSk7CiAgICAgICAgfSwgewogICAgICAgICAgb25jZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBhYy5zaWduYWw7CiAgICAgIH0KICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cy5wcm9taXNpZnkuY3VzdG9tID0gU3ltYm9sLmZvcignbm9kZWpzLnV0aWwucHJvbWlzaWZ5LmN1c3RvbScpOwogIH0pKHV0aWwkMik7CiAgcmV0dXJuIHV0aWwkMi5leHBvcnRzOwp9Cgp2YXIgb3BlcmF0b3JzID0ge307CgovKiBlc2xpbnQganNkb2MvcmVxdWlyZS1qc2RvYzogImVycm9yIiAqLwp2YXIgdmFsaWRhdG9yczsKdmFyIGhhc1JlcXVpcmVkVmFsaWRhdG9yczsKZnVuY3Rpb24gcmVxdWlyZVZhbGlkYXRvcnMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkVmFsaWRhdG9ycykgcmV0dXJuIHZhbGlkYXRvcnM7CiAgaGFzUmVxdWlyZWRWYWxpZGF0b3JzID0gMTsKICBjb25zdCB7CiAgICBBcnJheUlzQXJyYXksCiAgICBBcnJheVByb3RvdHlwZUluY2x1ZGVzLAogICAgQXJyYXlQcm90b3R5cGVKb2luLAogICAgQXJyYXlQcm90b3R5cGVNYXAsCiAgICBOdW1iZXJJc0ludGVnZXIsCiAgICBOdW1iZXJJc05hTiwKICAgIE51bWJlck1BWF9TQUZFX0lOVEVHRVIsCiAgICBOdW1iZXJNSU5fU0FGRV9JTlRFR0VSLAogICAgTnVtYmVyUGFyc2VJbnQsCiAgICBPYmplY3RQcm90b3R5cGVIYXNPd25Qcm9wZXJ0eSwKICAgIFJlZ0V4cFByb3RvdHlwZUV4ZWMsCiAgICBTdHJpbmcsCiAgICBTdHJpbmdQcm90b3R5cGVUb1VwcGVyQ2FzZSwKICAgIFN0cmluZ1Byb3RvdHlwZVRyaW0KICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgY29uc3QgewogICAgaGlkZVN0YWNrRnJhbWVzLAogICAgY29kZXM6IHsKICAgICAgRVJSX1NPQ0tFVF9CQURfUE9SVCwKICAgICAgRVJSX0lOVkFMSURfQVJHX1RZUEUsCiAgICAgIEVSUl9JTlZBTElEX0FSR19WQUxVRSwKICAgICAgRVJSX09VVF9PRl9SQU5HRSwKICAgICAgRVJSX1VOS05PV05fU0lHTkFMCiAgICB9CiAgfSA9IHJlcXVpcmVFcnJvcnMoKTsKICBjb25zdCB7CiAgICBub3JtYWxpemVFbmNvZGluZwogIH0gPSByZXF1aXJlVXRpbCQxKCk7CiAgY29uc3QgewogICAgaXNBc3luY0Z1bmN0aW9uLAogICAgaXNBcnJheUJ1ZmZlclZpZXcKICB9ID0gcmVxdWlyZVV0aWwkMSgpLnR5cGVzOwogIGNvbnN0IHNpZ25hbHMgPSB7fTsKCiAgLyoqCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEByZXR1cm5zIHtib29sZWFufQogICAqLwogIGZ1bmN0aW9uIGlzSW50MzIodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gKHZhbHVlIHwgMCk7CiAgfQoKICAvKioKICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICovCiAgZnVuY3Rpb24gaXNVaW50MzIodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PT0gdmFsdWUgPj4+IDA7CiAgfQogIGNvbnN0IG9jdGFsUmVnID0gL15bMC03XSskLzsKICBjb25zdCBtb2RlRGVzYyA9ICdtdXN0IGJlIGEgMzItYml0IHVuc2lnbmVkIGludGVnZXIgb3IgYW4gb2N0YWwgc3RyaW5nJzsKCiAgLyoqCiAgICogUGFyc2UgYW5kIHZhbGlkYXRlIHZhbHVlcyB0aGF0IHdpbGwgYmUgY29udmVydGVkIGludG8gbW9kZV90ICh0aGUgU18qCiAgICogY29uc3RhbnRzKS4gT25seSB2YWxpZCBudW1iZXJzIGFuZCBvY3RhbCBzdHJpbmdzIGFyZSBhbGxvd2VkLiBUaGV5IGNvdWxkIGJlCiAgICogY29udmVydGVkIHRvIDMyLWJpdCB1bnNpZ25lZCBpbnRlZ2VycyBvciBub24tbmVnYXRpdmUgc2lnbmVkIGludGVnZXJzIGluIHRoZQogICAqIEMrKyBsYW5kLCBidXQgYW55IHZhbHVlIGhpZ2hlciB0aGFuIDBvNzc3IHdpbGwgcmVzdWx0IGluIHBsYXRmb3JtLXNwZWNpZmljCiAgICogYmVoYXZpb3JzLgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWVzIHRvIGJlIHZhbGlkYXRlZAogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGFyZ3VtZW50CiAgICogQHBhcmFtIHtudW1iZXJ9IFtkZWZdIElmIHNwZWNpZmllZCwgd2lsbCBiZSByZXR1cm5lZCBmb3IgaW52YWxpZCB2YWx1ZXMKICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwogIGZ1bmN0aW9uIHBhcnNlRmlsZU1vZGUodmFsdWUsIG5hbWUsIGRlZikgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdmFsdWUgPSBkZWY7CiAgICB9CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICBpZiAoUmVnRXhwUHJvdG90eXBlRXhlYyhvY3RhbFJlZywgdmFsdWUpID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19WQUxVRShuYW1lLCB2YWx1ZSwgbW9kZURlc2MpOwogICAgICB9CiAgICAgIHZhbHVlID0gTnVtYmVyUGFyc2VJbnQodmFsdWUsIDgpOwogICAgfQogICAgdmFsaWRhdGVVaW50MzIodmFsdWUsIG5hbWUpOwogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlSW50ZWdlcgogICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWluXQogICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4XQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIG51bWJlcn0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZUludGVnZXJ9ICovCiAgY29uc3QgdmFsaWRhdGVJbnRlZ2VyID0gaGlkZVN0YWNrRnJhbWVzKCh2YWx1ZSwgbmFtZSwgbWluID0gTnVtYmVyTUlOX1NBRkVfSU5URUdFUiwgbWF4ID0gTnVtYmVyTUFYX1NBRkVfSU5URUdFUikgPT4gewogICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnbnVtYmVyJywgdmFsdWUpOwogICAgaWYgKCFOdW1iZXJJc0ludGVnZXIodmFsdWUpKSB0aHJvdyBuZXcgRVJSX09VVF9PRl9SQU5HRShuYW1lLCAnYW4gaW50ZWdlcicsIHZhbHVlKTsKICAgIGlmICh2YWx1ZSA8IG1pbiB8fCB2YWx1ZSA+IG1heCkgdGhyb3cgbmV3IEVSUl9PVVRfT0ZfUkFOR0UobmFtZSwgYD49ICR7bWlufSAmJiA8PSAke21heH1gLCB2YWx1ZSk7CiAgfSk7CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZUludDMyCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5dCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhdCiAgICogQHJldHVybnMge2Fzc2VydHMgdmFsdWUgaXMgbnVtYmVyfQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlSW50MzJ9ICovCiAgY29uc3QgdmFsaWRhdGVJbnQzMiA9IGhpZGVTdGFja0ZyYW1lcygodmFsdWUsIG5hbWUsIG1pbiA9IC0yMTQ3NDgzNjQ4LCBtYXggPSAyMTQ3NDgzNjQ3KSA9PiB7CiAgICAvLyBUaGUgZGVmYXVsdHMgZm9yIG1pbiBhbmQgbWF4IGNvcnJlc3BvbmQgdG8gdGhlIGxpbWl0cyBvZiAzMi1iaXQgaW50ZWdlcnMuCiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUobmFtZSwgJ251bWJlcicsIHZhbHVlKTsKICAgIH0KICAgIGlmICghTnVtYmVySXNJbnRlZ2VyKHZhbHVlKSkgewogICAgICB0aHJvdyBuZXcgRVJSX09VVF9PRl9SQU5HRShuYW1lLCAnYW4gaW50ZWdlcicsIHZhbHVlKTsKICAgIH0KICAgIGlmICh2YWx1ZSA8IG1pbiB8fCB2YWx1ZSA+IG1heCkgewogICAgICB0aHJvdyBuZXcgRVJSX09VVF9PRl9SQU5HRShuYW1lLCBgPj0gJHttaW59ICYmIDw9ICR7bWF4fWAsIHZhbHVlKTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlVWludDMyCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHBhcmFtIHtudW1iZXJ8Ym9vbGVhbn0gW3Bvc2l0aXZlPWZhbHNlXQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIG51bWJlcn0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZVVpbnQzMn0gKi8KICBjb25zdCB2YWxpZGF0ZVVpbnQzMiA9IGhpZGVTdGFja0ZyYW1lcygodmFsdWUsIG5hbWUsIHBvc2l0aXZlID0gZmFsc2UpID0+IHsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnbnVtYmVyJywgdmFsdWUpOwogICAgfQogICAgaWYgKCFOdW1iZXJJc0ludGVnZXIodmFsdWUpKSB7CiAgICAgIHRocm93IG5ldyBFUlJfT1VUX09GX1JBTkdFKG5hbWUsICdhbiBpbnRlZ2VyJywgdmFsdWUpOwogICAgfQogICAgY29uc3QgbWluID0gcG9zaXRpdmUgPyAxIDogMDsKICAgIC8vIDIgKiogMzIgPT09IDQyOTQ5NjcyOTYKICAgIGNvbnN0IG1heCA9IDQyOTQ5NjcyOTU7CiAgICBpZiAodmFsdWUgPCBtaW4gfHwgdmFsdWUgPiBtYXgpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9PVVRfT0ZfUkFOR0UobmFtZSwgYD49ICR7bWlufSAmJiA8PSAke21heH1gLCB2YWx1ZSk7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZVN0cmluZwogICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIHN0cmluZ30KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZVN0cmluZ30gKi8KICBmdW5jdGlvbiB2YWxpZGF0ZVN0cmluZyh2YWx1ZSwgbmFtZSkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnc3RyaW5nJywgdmFsdWUpOwogIH0KCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlTnVtYmVyCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHBhcmFtIHtudW1iZXJ9IFttaW5dCiAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhdCiAgICogQHJldHVybnMge2Fzc2VydHMgdmFsdWUgaXMgbnVtYmVyfQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlTnVtYmVyfSAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyKHZhbHVlLCBuYW1lLCBtaW4gPSB1bmRlZmluZWQsIG1heCkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnbnVtYmVyJywgdmFsdWUpOwogICAgaWYgKG1pbiAhPSBudWxsICYmIHZhbHVlIDwgbWluIHx8IG1heCAhPSBudWxsICYmIHZhbHVlID4gbWF4IHx8IChtaW4gIT0gbnVsbCB8fCBtYXggIT0gbnVsbCkgJiYgTnVtYmVySXNOYU4odmFsdWUpKSB7CiAgICAgIHRocm93IG5ldyBFUlJfT1VUX09GX1JBTkdFKG5hbWUsIGAke21pbiAhPSBudWxsID8gYD49ICR7bWlufWAgOiAnJ30ke21pbiAhPSBudWxsICYmIG1heCAhPSBudWxsID8gJyAmJiAnIDogJyd9JHttYXggIT0gbnVsbCA/IGA8PSAke21heH1gIDogJyd9YCwgdmFsdWUpOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlT25lT2YKICAgKiBAdGVtcGxhdGUgVAogICAqIEBwYXJhbSB7VH0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEBwYXJhbSB7VFtdfSBvbmVPZgogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlT25lT2Z9ICovCiAgY29uc3QgdmFsaWRhdGVPbmVPZiA9IGhpZGVTdGFja0ZyYW1lcygodmFsdWUsIG5hbWUsIG9uZU9mKSA9PiB7CiAgICBpZiAoIUFycmF5UHJvdG90eXBlSW5jbHVkZXMob25lT2YsIHZhbHVlKSkgewogICAgICBjb25zdCBhbGxvd2VkID0gQXJyYXlQcm90b3R5cGVKb2luKEFycmF5UHJvdG90eXBlTWFwKG9uZU9mLCB2ID0+IHR5cGVvZiB2ID09PSAnc3RyaW5nJyA/IGAnJHt2fSdgIDogU3RyaW5nKHYpKSwgJywgJyk7CiAgICAgIGNvbnN0IHJlYXNvbiA9ICdtdXN0IGJlIG9uZSBvZjogJyArIGFsbG93ZWQ7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVkFMVUUobmFtZSwgdmFsdWUsIHJlYXNvbik7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZUJvb2xlYW4KICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcmV0dXJucyB7YXNzZXJ0cyB2YWx1ZSBpcyBib29sZWFufQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlQm9vbGVhbn0gKi8KICBmdW5jdGlvbiB2YWxpZGF0ZUJvb2xlYW4odmFsdWUsIG5hbWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdib29sZWFuJykgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICdib29sZWFuJywgdmFsdWUpOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHthbnl9IG9wdGlvbnMKICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5CiAgICogQHBhcmFtIHtib29sZWFufSBkZWZhdWx0VmFsdWUKICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgKi8KICBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eVZhbHVlT3JEZWZhdWx0KG9wdGlvbnMsIGtleSwgZGVmYXVsdFZhbHVlKSB7CiAgICByZXR1cm4gb3B0aW9ucyA9PSBudWxsIHx8ICFPYmplY3RQcm90b3R5cGVIYXNPd25Qcm9wZXJ0eShvcHRpb25zLCBrZXkpID8gZGVmYXVsdFZhbHVlIDogb3B0aW9uc1trZXldOwogIH0KCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlT2JqZWN0CiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHBhcmFtIHt7CiAgICogICBhbGxvd0FycmF5PzogYm9vbGVhbiwKICAgKiAgIGFsbG93RnVuY3Rpb24/OiBib29sZWFuLAogICAqICAgbnVsbGFibGU/OiBib29sZWFuCiAgICogfX0gW29wdGlvbnNdCiAgICovCgogIC8qKiBAdHlwZSB7dmFsaWRhdGVPYmplY3R9ICovCiAgY29uc3QgdmFsaWRhdGVPYmplY3QgPSBoaWRlU3RhY2tGcmFtZXMoKHZhbHVlLCBuYW1lLCBvcHRpb25zID0gbnVsbCkgPT4gewogICAgY29uc3QgYWxsb3dBcnJheSA9IGdldE93blByb3BlcnR5VmFsdWVPckRlZmF1bHQob3B0aW9ucywgJ2FsbG93QXJyYXknLCBmYWxzZSk7CiAgICBjb25zdCBhbGxvd0Z1bmN0aW9uID0gZ2V0T3duUHJvcGVydHlWYWx1ZU9yRGVmYXVsdChvcHRpb25zLCAnYWxsb3dGdW5jdGlvbicsIGZhbHNlKTsKICAgIGNvbnN0IG51bGxhYmxlID0gZ2V0T3duUHJvcGVydHlWYWx1ZU9yRGVmYXVsdChvcHRpb25zLCAnbnVsbGFibGUnLCBmYWxzZSk7CiAgICBpZiAoIW51bGxhYmxlICYmIHZhbHVlID09PSBudWxsIHx8ICFhbGxvd0FycmF5ICYmIEFycmF5SXNBcnJheSh2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JyAmJiAoIWFsbG93RnVuY3Rpb24gfHwgdHlwZW9mIHZhbHVlICE9PSAnZnVuY3Rpb24nKSkgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUobmFtZSwgJ09iamVjdCcsIHZhbHVlKTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlRGljdGlvbmFyeSAtIFdlIGFyZSB1c2luZyB0aGUgV2ViIElETCBTdGFuZGFyZCBkZWZpbml0aW9uCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mICJkaWN0aW9uYXJ5IiBoZXJlLCB3aGljaCBtZWFucyBhbnkgdmFsdWUKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hvc2UgVHlwZSBpcyBlaXRoZXIgVW5kZWZpbmVkLCBOdWxsLCBvcgogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QgKHdoaWNoIGluY2x1ZGVzIGZ1bmN0aW9ucykuCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHNlZSBodHRwczovL3dlYmlkbC5zcGVjLndoYXR3Zy5vcmcvI2VzLWRpY3Rpb25hcnkKICAgKiBAc2VlIGh0dHBzOi8vdGMzOS5lcy9lY21hMjYyLyN0YWJsZS10eXBlb2Ytb3BlcmF0b3ItcmVzdWx0cwogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlRGljdGlvbmFyeX0gKi8KICBjb25zdCB2YWxpZGF0ZURpY3Rpb25hcnkgPSBoaWRlU3RhY2tGcmFtZXMoKHZhbHVlLCBuYW1lKSA9PiB7CiAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUobmFtZSwgJ2EgZGljdGlvbmFyeScsIHZhbHVlKTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlQXJyYXkKICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcGFyYW0ge251bWJlcn0gW21pbkxlbmd0aF0KICAgKiBAcmV0dXJucyB7YXNzZXJ0cyB2YWx1ZSBpcyBhbnlbXX0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZUFycmF5fSAqLwogIGNvbnN0IHZhbGlkYXRlQXJyYXkgPSBoaWRlU3RhY2tGcmFtZXMoKHZhbHVlLCBuYW1lLCBtaW5MZW5ndGggPSAwKSA9PiB7CiAgICBpZiAoIUFycmF5SXNBcnJheSh2YWx1ZSkpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICdBcnJheScsIHZhbHVlKTsKICAgIH0KICAgIGlmICh2YWx1ZS5sZW5ndGggPCBtaW5MZW5ndGgpIHsKICAgICAgY29uc3QgcmVhc29uID0gYG11c3QgYmUgbG9uZ2VyIHRoYW4gJHttaW5MZW5ndGh9YDsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19WQUxVRShuYW1lLCB2YWx1ZSwgcmVhc29uKTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlU3RyaW5nQXJyYXkKICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcmV0dXJucyB7YXNzZXJ0cyB2YWx1ZSBpcyBzdHJpbmdbXX0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZVN0cmluZ0FycmF5fSAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nQXJyYXkodmFsdWUsIG5hbWUpIHsKICAgIHZhbGlkYXRlQXJyYXkodmFsdWUsIG5hbWUpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICB2YWxpZGF0ZVN0cmluZyh2YWx1ZVtpXSwgYCR7bmFtZX1bJHtpfV1gKTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZUJvb2xlYW5BcnJheQogICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIGJvb2xlYW5bXX0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZUJvb2xlYW5BcnJheX0gKi8KICBmdW5jdGlvbiB2YWxpZGF0ZUJvb2xlYW5BcnJheSh2YWx1ZSwgbmFtZSkgewogICAgdmFsaWRhdGVBcnJheSh2YWx1ZSwgbmFtZSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhbGlkYXRlQm9vbGVhbih2YWx1ZVtpXSwgYCR7bmFtZX1bJHtpfV1gKTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZUFib3J0U2lnbmFsQXJyYXkKICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcmV0dXJucyB7YXNzZXJ0cyB2YWx1ZSBpcyBBYm9ydFNpZ25hbFtdfQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlQWJvcnRTaWduYWxBcnJheX0gKi8KICBmdW5jdGlvbiB2YWxpZGF0ZUFib3J0U2lnbmFsQXJyYXkodmFsdWUsIG5hbWUpIHsKICAgIHZhbGlkYXRlQXJyYXkodmFsdWUsIG5hbWUpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBzaWduYWwgPSB2YWx1ZVtpXTsKICAgICAgY29uc3QgaW5kZXhlZE5hbWUgPSBgJHtuYW1lfVske2l9XWA7CiAgICAgIGlmIChzaWduYWwgPT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShpbmRleGVkTmFtZSwgJ0Fib3J0U2lnbmFsJywgc2lnbmFsKTsKICAgICAgfQogICAgICB2YWxpZGF0ZUFib3J0U2lnbmFsKHNpZ25hbCwgaW5kZXhlZE5hbWUpOwogICAgfQogIH0KCiAgLyoqCiAgICogQHBhcmFtIHsqfSBzaWduYWwKICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9J3NpZ25hbCddCiAgICogQHJldHVybnMge2Fzc2VydHMgc2lnbmFsIGlzIGtleW9mIHNpZ25hbHN9CiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVTaWduYWxOYW1lKHNpZ25hbCwgbmFtZSA9ICdzaWduYWwnKSB7CiAgICB2YWxpZGF0ZVN0cmluZyhzaWduYWwsIG5hbWUpOwogICAgaWYgKHNpZ25hbHNbc2lnbmFsXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChzaWduYWxzW1N0cmluZ1Byb3RvdHlwZVRvVXBwZXJDYXNlKHNpZ25hbCldICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRVJSX1VOS05PV05fU0lHTkFMKHNpZ25hbCArICcgKHNpZ25hbHMgbXVzdCB1c2UgYWxsIGNhcGl0YWwgbGV0dGVycyknKTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgRVJSX1VOS05PV05fU0lHTkFMKHNpZ25hbCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAY2FsbGJhY2sgdmFsaWRhdGVCdWZmZXIKICAgKiBAcGFyYW0geyp9IGJ1ZmZlcgogICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT0nYnVmZmVyJ10KICAgKiBAcmV0dXJucyB7YXNzZXJ0cyBidWZmZXIgaXMgQXJyYXlCdWZmZXJWaWV3fQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlQnVmZmVyfSAqLwogIGNvbnN0IHZhbGlkYXRlQnVmZmVyID0gaGlkZVN0YWNrRnJhbWVzKChidWZmZXIsIG5hbWUgPSAnYnVmZmVyJykgPT4gewogICAgaWYgKCFpc0FycmF5QnVmZmVyVmlldyhidWZmZXIpKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCBbJ0J1ZmZlcicsICdUeXBlZEFycmF5JywgJ0RhdGFWaWV3J10sIGJ1ZmZlcik7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhCiAgICogQHBhcmFtIHtzdHJpbmd9IGVuY29kaW5nCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVFbmNvZGluZyhkYXRhLCBlbmNvZGluZykgewogICAgY29uc3Qgbm9ybWFsaXplZEVuY29kaW5nID0gbm9ybWFsaXplRW5jb2RpbmcoZW5jb2RpbmcpOwogICAgY29uc3QgbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICBpZiAobm9ybWFsaXplZEVuY29kaW5nID09PSAnaGV4JyAmJiBsZW5ndGggJSAyICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVkFMVUUoJ2VuY29kaW5nJywgZW5jb2RpbmcsIGBpcyBpbnZhbGlkIGZvciBkYXRhIG9mIGxlbmd0aCAke2xlbmd0aH1gKTsKICAgIH0KICB9CgogIC8qKgogICAqIENoZWNrIHRoYXQgdGhlIHBvcnQgbnVtYmVyIGlzIG5vdCBOYU4gd2hlbiBjb2VyY2VkIHRvIGEgbnVtYmVyLAogICAqIGlzIGFuIGludGVnZXIgYW5kIHRoYXQgaXQgZmFsbHMgd2l0aGluIHRoZSBsZWdhbCByYW5nZSBvZiBwb3J0IG51bWJlcnMuCiAgICogQHBhcmFtIHsqfSBwb3J0CiAgICogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPSdQb3J0J10KICAgKiBAcGFyYW0ge2Jvb2xlYW59IFthbGxvd1plcm89dHJ1ZV0KICAgKiBAcmV0dXJucyB7bnVtYmVyfQogICAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlUG9ydChwb3J0LCBuYW1lID0gJ1BvcnQnLCBhbGxvd1plcm8gPSB0cnVlKSB7CiAgICBpZiAodHlwZW9mIHBvcnQgIT09ICdudW1iZXInICYmIHR5cGVvZiBwb3J0ICE9PSAnc3RyaW5nJyB8fCB0eXBlb2YgcG9ydCA9PT0gJ3N0cmluZycgJiYgU3RyaW5nUHJvdG90eXBlVHJpbShwb3J0KS5sZW5ndGggPT09IDAgfHwgK3BvcnQgIT09ICtwb3J0ID4+PiAwIHx8IHBvcnQgPiAweGZmZmYgfHwgcG9ydCA9PT0gMCAmJiAhYWxsb3daZXJvKSB7CiAgICAgIHRocm93IG5ldyBFUlJfU09DS0VUX0JBRF9QT1JUKG5hbWUsIHBvcnQsIGFsbG93WmVybyk7CiAgICB9CiAgICByZXR1cm4gcG9ydCB8IDA7CiAgfQoKICAvKioKICAgKiBAY2FsbGJhY2sgdmFsaWRhdGVBYm9ydFNpZ25hbAogICAqIEBwYXJhbSB7Kn0gc2lnbmFsCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZUFib3J0U2lnbmFsfSAqLwogIGNvbnN0IHZhbGlkYXRlQWJvcnRTaWduYWwgPSBoaWRlU3RhY2tGcmFtZXMoKHNpZ25hbCwgbmFtZSkgPT4gewogICAgaWYgKHNpZ25hbCAhPT0gdW5kZWZpbmVkICYmIChzaWduYWwgPT09IG51bGwgfHwgdHlwZW9mIHNpZ25hbCAhPT0gJ29iamVjdCcgfHwgISgnYWJvcnRlZCcgaW4gc2lnbmFsKSkpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICdBYm9ydFNpZ25hbCcsIHNpZ25hbCk7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZUZ1bmN0aW9uCiAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICogQHJldHVybnMge2Fzc2VydHMgdmFsdWUgaXMgRnVuY3Rpb259CiAgICovCgogIC8qKiBAdHlwZSB7dmFsaWRhdGVGdW5jdGlvbn0gKi8KICBjb25zdCB2YWxpZGF0ZUZ1bmN0aW9uID0gaGlkZVN0YWNrRnJhbWVzKCh2YWx1ZSwgbmFtZSkgPT4gewogICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Z1bmN0aW9uJykgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICdGdW5jdGlvbicsIHZhbHVlKTsKICB9KTsKCiAgLyoqCiAgICogQGNhbGxiYWNrIHZhbGlkYXRlUGxhaW5GdW5jdGlvbgogICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIEZ1bmN0aW9ufQogICAqLwoKICAvKiogQHR5cGUge3ZhbGlkYXRlUGxhaW5GdW5jdGlvbn0gKi8KICBjb25zdCB2YWxpZGF0ZVBsYWluRnVuY3Rpb24gPSBoaWRlU3RhY2tGcmFtZXMoKHZhbHVlLCBuYW1lKSA9PiB7CiAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnZnVuY3Rpb24nIHx8IGlzQXN5bmNGdW5jdGlvbih2YWx1ZSkpIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRShuYW1lLCAnRnVuY3Rpb24nLCB2YWx1ZSk7CiAgfSk7CgogIC8qKgogICAqIEBjYWxsYmFjayB2YWxpZGF0ZVVuZGVmaW5lZAogICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZQogICAqIEByZXR1cm5zIHthc3NlcnRzIHZhbHVlIGlzIHVuZGVmaW5lZH0KICAgKi8KCiAgLyoqIEB0eXBlIHt2YWxpZGF0ZVVuZGVmaW5lZH0gKi8KICBjb25zdCB2YWxpZGF0ZVVuZGVmaW5lZCA9IGhpZGVTdGFja0ZyYW1lcygodmFsdWUsIG5hbWUpID0+IHsKICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUobmFtZSwgJ3VuZGVmaW5lZCcsIHZhbHVlKTsKICB9KTsKCiAgLyoqCiAgICogQHRlbXBsYXRlIFQKICAgKiBAcGFyYW0ge1R9IHZhbHVlCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUKICAgKiBAcGFyYW0ge1RbXX0gdW5pb24KICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZVVuaW9uKHZhbHVlLCBuYW1lLCB1bmlvbikgewogICAgaWYgKCFBcnJheVByb3RvdHlwZUluY2x1ZGVzKHVuaW9uLCB2YWx1ZSkpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsIGAoJyR7QXJyYXlQcm90b3R5cGVKb2luKHVuaW9uLCAnfCcpfScpYCwgdmFsdWUpOwogICAgfQogIH0KCiAgLyoKICAgIFRoZSBydWxlcyBmb3IgdGhlIExpbmsgaGVhZGVyIGZpZWxkIGFyZSBkZXNjcmliZWQgaGVyZToKICAgIGh0dHBzOi8vd3d3LnJmYy1lZGl0b3Iub3JnL3JmYy9yZmM4Mjg4Lmh0bWwjc2VjdGlvbi0zCiAgCSAgVGhpcyByZWdleCB2YWxpZGF0ZXMgYW55IHN0cmluZyBzdXJyb3VuZGVkIGJ5IGFuZ2xlIGJyYWNrZXRzCiAgICAobm90IG5lY2Vzc2FyaWx5IGEgdmFsaWQgVVJJIHJlZmVyZW5jZSkgZm9sbG93ZWQgYnkgemVybyBvciBtb3JlCiAgICBsaW5rLXBhcmFtcyBzZXBhcmF0ZWQgYnkgc2VtaWNvbG9ucy4KICAqLwogIGNvbnN0IGxpbmtWYWx1ZVJlZ0V4cCA9IC9eKD86PFtePl0qPikoPzpccyo7XHMqW147IlxzXSsoPzo9KCIpP1teOyJcc10qXDEpPykqJC87CgogIC8qKgogICAqIEBwYXJhbSB7YW55fSB2YWx1ZQogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVMaW5rSGVhZGVyRm9ybWF0KHZhbHVlLCBuYW1lKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCAhUmVnRXhwUHJvdG90eXBlRXhlYyhsaW5rVmFsdWVSZWdFeHAsIHZhbHVlKSkgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1ZBTFVFKG5hbWUsIHZhbHVlLCAnbXVzdCBiZSBhbiBhcnJheSBvciBzdHJpbmcgb2YgZm9ybWF0ICI8L3N0eWxlcy5jc3M+OyByZWw9cHJlbG9hZDsgYXM9c3R5bGUiJyk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge2FueX0gaGludHMKICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVMaW5rSGVhZGVyVmFsdWUoaGludHMpIHsKICAgIGlmICh0eXBlb2YgaGludHMgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhbGlkYXRlTGlua0hlYWRlckZvcm1hdChoaW50cywgJ2hpbnRzJyk7CiAgICAgIHJldHVybiBoaW50czsKICAgIH0gZWxzZSBpZiAoQXJyYXlJc0FycmF5KGhpbnRzKSkgewogICAgICBjb25zdCBoaW50c0xlbmd0aCA9IGhpbnRzLmxlbmd0aDsKICAgICAgbGV0IHJlc3VsdCA9ICcnOwogICAgICBpZiAoaGludHNMZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGludHNMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGxpbmsgPSBoaW50c1tpXTsKICAgICAgICB2YWxpZGF0ZUxpbmtIZWFkZXJGb3JtYXQobGluaywgJ2hpbnRzJyk7CiAgICAgICAgcmVzdWx0ICs9IGxpbms7CiAgICAgICAgaWYgKGkgIT09IGhpbnRzTGVuZ3RoIC0gMSkgewogICAgICAgICAgcmVzdWx0ICs9ICcsICc7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1ZBTFVFKCdoaW50cycsIGhpbnRzLCAnbXVzdCBiZSBhbiBhcnJheSBvciBzdHJpbmcgb2YgZm9ybWF0ICI8L3N0eWxlcy5jc3M+OyByZWw9cHJlbG9hZDsgYXM9c3R5bGUiJyk7CiAgfQogIHZhbGlkYXRvcnMgPSB7CiAgICBpc0ludDMyLAogICAgaXNVaW50MzIsCiAgICBwYXJzZUZpbGVNb2RlLAogICAgdmFsaWRhdGVBcnJheSwKICAgIHZhbGlkYXRlU3RyaW5nQXJyYXksCiAgICB2YWxpZGF0ZUJvb2xlYW5BcnJheSwKICAgIHZhbGlkYXRlQWJvcnRTaWduYWxBcnJheSwKICAgIHZhbGlkYXRlQm9vbGVhbiwKICAgIHZhbGlkYXRlQnVmZmVyLAogICAgdmFsaWRhdGVEaWN0aW9uYXJ5LAogICAgdmFsaWRhdGVFbmNvZGluZywKICAgIHZhbGlkYXRlRnVuY3Rpb24sCiAgICB2YWxpZGF0ZUludDMyLAogICAgdmFsaWRhdGVJbnRlZ2VyLAogICAgdmFsaWRhdGVOdW1iZXIsCiAgICB2YWxpZGF0ZU9iamVjdCwKICAgIHZhbGlkYXRlT25lT2YsCiAgICB2YWxpZGF0ZVBsYWluRnVuY3Rpb24sCiAgICB2YWxpZGF0ZVBvcnQsCiAgICB2YWxpZGF0ZVNpZ25hbE5hbWUsCiAgICB2YWxpZGF0ZVN0cmluZywKICAgIHZhbGlkYXRlVWludDMyLAogICAgdmFsaWRhdGVVbmRlZmluZWQsCiAgICB2YWxpZGF0ZVVuaW9uLAogICAgdmFsaWRhdGVBYm9ydFNpZ25hbCwKICAgIHZhbGlkYXRlTGlua0hlYWRlclZhbHVlCiAgfTsKICByZXR1cm4gdmFsaWRhdG9yczsKfQoKdmFyIGVuZE9mU3RyZWFtID0ge2V4cG9ydHM6IHt9fTsKCnZhciBwcm9jZXNzJDE7CnZhciBoYXNSZXF1aXJlZFByb2Nlc3M7CmZ1bmN0aW9uIHJlcXVpcmVQcm9jZXNzKCkgewogIGlmIChoYXNSZXF1aXJlZFByb2Nlc3MpIHJldHVybiBwcm9jZXNzJDE7CiAgaGFzUmVxdWlyZWRQcm9jZXNzID0gMTsKICAvLyBmb3Igbm93IGp1c3QgZXhwb3NlIHRoZSBidWlsdGluIHByb2Nlc3MgZ2xvYmFsIGZyb20gbm9kZS5qcwogIHByb2Nlc3MkMSA9IGNvbW1vbmpzR2xvYmFsLnByb2Nlc3M7CiAgcmV0dXJuIHByb2Nlc3MkMTsKfQoKdmFyIHV0aWxzJDE7CnZhciBoYXNSZXF1aXJlZFV0aWxzJDE7CmZ1bmN0aW9uIHJlcXVpcmVVdGlscyQxKCkgewogIGlmIChoYXNSZXF1aXJlZFV0aWxzJDEpIHJldHVybiB1dGlscyQxOwogIGhhc1JlcXVpcmVkVXRpbHMkMSA9IDE7CiAgY29uc3QgewogICAgU3ltYm9sQXN5bmNJdGVyYXRvciwKICAgIFN5bWJvbEl0ZXJhdG9yLAogICAgU3ltYm9sRm9yCiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwoKICAvLyBXZSBuZWVkIHRvIHVzZSBTeW1ib2xGb3IgdG8gbWFrZSB0aGVzZSBnbG9iYWxseSBhdmFpbGFibGUKICAvLyBmb3IgaW50ZXJvcHQgd2l0aCByZWFkYWJsZS1zdHJlYW0sIGkuZS4gcmVhZGFibGUtc3RyZWFtCiAgLy8gYW5kIG5vZGUgY29yZSBuZWVkcyB0byBiZSBhYmxlIHRvIHJlYWQvd3JpdGUgcHJpdmF0ZSBzdGF0ZQogIC8vIGZyb20gZWFjaCBvdGhlciBmb3IgcHJvcGVyIGludGVyb3BlcmFiaWxpdHkuCiAgY29uc3Qga0lzRGVzdHJveWVkID0gU3ltYm9sRm9yKCdub2RlanMuc3RyZWFtLmRlc3Ryb3llZCcpOwogIGNvbnN0IGtJc0Vycm9yZWQgPSBTeW1ib2xGb3IoJ25vZGVqcy5zdHJlYW0uZXJyb3JlZCcpOwogIGNvbnN0IGtJc1JlYWRhYmxlID0gU3ltYm9sRm9yKCdub2RlanMuc3RyZWFtLnJlYWRhYmxlJyk7CiAgY29uc3Qga0lzV3JpdGFibGUgPSBTeW1ib2xGb3IoJ25vZGVqcy5zdHJlYW0ud3JpdGFibGUnKTsKICBjb25zdCBrSXNEaXN0dXJiZWQgPSBTeW1ib2xGb3IoJ25vZGVqcy5zdHJlYW0uZGlzdHVyYmVkJyk7CiAgY29uc3Qga0lzQ2xvc2VkUHJvbWlzZSA9IFN5bWJvbEZvcignbm9kZWpzLndlYnN0cmVhbS5pc0Nsb3NlZFByb21pc2UnKTsKICBjb25zdCBrQ29udHJvbGxlckVycm9yRnVuY3Rpb24gPSBTeW1ib2xGb3IoJ25vZGVqcy53ZWJzdHJlYW0uY29udHJvbGxlckVycm9yRnVuY3Rpb24nKTsKICBmdW5jdGlvbiBpc1JlYWRhYmxlTm9kZVN0cmVhbShvYmosIHN0cmljdCA9IGZhbHNlKSB7CiAgICB2YXIgX29iaiRfcmVhZGFibGVTdGF0ZTsKICAgIHJldHVybiAhIShvYmogJiYgdHlwZW9mIG9iai5waXBlID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmoub24gPT09ICdmdW5jdGlvbicgJiYgKCFzdHJpY3QgfHwgdHlwZW9mIG9iai5wYXVzZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2Ygb2JqLnJlc3VtZSA9PT0gJ2Z1bmN0aW9uJykgJiYgKCFvYmouX3dyaXRhYmxlU3RhdGUgfHwgKChfb2JqJF9yZWFkYWJsZVN0YXRlID0gb2JqLl9yZWFkYWJsZVN0YXRlKSA9PT0gbnVsbCB8fCBfb2JqJF9yZWFkYWJsZVN0YXRlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfb2JqJF9yZWFkYWJsZVN0YXRlLnJlYWRhYmxlKSAhPT0gZmFsc2UpICYmICgKICAgIC8vIER1cGxleAogICAgIW9iai5fd3JpdGFibGVTdGF0ZSB8fCBvYmouX3JlYWRhYmxlU3RhdGUpCiAgICAvLyBXcml0YWJsZSBoYXMgLnBpcGUuCiAgICApOwogIH0KICBmdW5jdGlvbiBpc1dyaXRhYmxlTm9kZVN0cmVhbShvYmopIHsKICAgIHZhciBfb2JqJF93cml0YWJsZVN0YXRlOwogICAgcmV0dXJuICEhKG9iaiAmJiB0eXBlb2Ygb2JqLndyaXRlID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmoub24gPT09ICdmdW5jdGlvbicgJiYgKCFvYmouX3JlYWRhYmxlU3RhdGUgfHwgKChfb2JqJF93cml0YWJsZVN0YXRlID0gb2JqLl93cml0YWJsZVN0YXRlKSA9PT0gbnVsbCB8fCBfb2JqJF93cml0YWJsZVN0YXRlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfb2JqJF93cml0YWJsZVN0YXRlLndyaXRhYmxlKSAhPT0gZmFsc2UpCiAgICAvLyBEdXBsZXgKICAgICk7CiAgfQogIGZ1bmN0aW9uIGlzRHVwbGV4Tm9kZVN0cmVhbShvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgdHlwZW9mIG9iai5waXBlID09PSAnZnVuY3Rpb24nICYmIG9iai5fcmVhZGFibGVTdGF0ZSAmJiB0eXBlb2Ygb2JqLm9uID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmoud3JpdGUgPT09ICdmdW5jdGlvbicpOwogIH0KICBmdW5jdGlvbiBpc05vZGVTdHJlYW0ob2JqKSB7CiAgICByZXR1cm4gb2JqICYmIChvYmouX3JlYWRhYmxlU3RhdGUgfHwgb2JqLl93cml0YWJsZVN0YXRlIHx8IHR5cGVvZiBvYmoud3JpdGUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIG9iai5vbiA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2Ygb2JqLnBpcGUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIG9iai5vbiA9PT0gJ2Z1bmN0aW9uJyk7CiAgfQogIGZ1bmN0aW9uIGlzUmVhZGFibGVTdHJlYW0ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmICFpc05vZGVTdHJlYW0ob2JqKSAmJiB0eXBlb2Ygb2JqLnBpcGVUaHJvdWdoID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmouZ2V0UmVhZGVyID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmouY2FuY2VsID09PSAnZnVuY3Rpb24nKTsKICB9CiAgZnVuY3Rpb24gaXNXcml0YWJsZVN0cmVhbShvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgIWlzTm9kZVN0cmVhbShvYmopICYmIHR5cGVvZiBvYmouZ2V0V3JpdGVyID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBvYmouYWJvcnQgPT09ICdmdW5jdGlvbicpOwogIH0KICBmdW5jdGlvbiBpc1RyYW5zZm9ybVN0cmVhbShvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgIWlzTm9kZVN0cmVhbShvYmopICYmIHR5cGVvZiBvYmoucmVhZGFibGUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBvYmoud3JpdGFibGUgPT09ICdvYmplY3QnKTsKICB9CiAgZnVuY3Rpb24gaXNXZWJTdHJlYW0ob2JqKSB7CiAgICByZXR1cm4gaXNSZWFkYWJsZVN0cmVhbShvYmopIHx8IGlzV3JpdGFibGVTdHJlYW0ob2JqKSB8fCBpc1RyYW5zZm9ybVN0cmVhbShvYmopOwogIH0KICBmdW5jdGlvbiBpc0l0ZXJhYmxlKG9iaiwgaXNBc3luYykgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoaXNBc3luYyA9PT0gdHJ1ZSkgcmV0dXJuIHR5cGVvZiBvYmpbU3ltYm9sQXN5bmNJdGVyYXRvcl0gPT09ICdmdW5jdGlvbic7CiAgICBpZiAoaXNBc3luYyA9PT0gZmFsc2UpIHJldHVybiB0eXBlb2Ygb2JqW1N5bWJvbEl0ZXJhdG9yXSA9PT0gJ2Z1bmN0aW9uJzsKICAgIHJldHVybiB0eXBlb2Ygb2JqW1N5bWJvbEFzeW5jSXRlcmF0b3JdID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBvYmpbU3ltYm9sSXRlcmF0b3JdID09PSAnZnVuY3Rpb24nOwogIH0KICBmdW5jdGlvbiBpc0Rlc3Ryb3llZChzdHJlYW0pIHsKICAgIGlmICghaXNOb2RlU3RyZWFtKHN0cmVhbSkpIHJldHVybiBudWxsOwogICAgY29uc3Qgd1N0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgY29uc3QgclN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgY29uc3Qgc3RhdGUgPSB3U3RhdGUgfHwgclN0YXRlOwogICAgcmV0dXJuICEhKHN0cmVhbS5kZXN0cm95ZWQgfHwgc3RyZWFtW2tJc0Rlc3Ryb3llZF0gfHwgc3RhdGUgIT09IG51bGwgJiYgc3RhdGUgIT09IHVuZGVmaW5lZCAmJiBzdGF0ZS5kZXN0cm95ZWQpOwogIH0KCiAgLy8gSGF2ZSBiZWVuIGVuZCgpOmQuCiAgZnVuY3Rpb24gaXNXcml0YWJsZUVuZGVkKHN0cmVhbSkgewogICAgaWYgKCFpc1dyaXRhYmxlTm9kZVN0cmVhbShzdHJlYW0pKSByZXR1cm4gbnVsbDsKICAgIGlmIChzdHJlYW0ud3JpdGFibGVFbmRlZCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CiAgICBjb25zdCB3U3RhdGUgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAod1N0YXRlICE9PSBudWxsICYmIHdTdGF0ZSAhPT0gdW5kZWZpbmVkICYmIHdTdGF0ZS5lcnJvcmVkKSByZXR1cm4gZmFsc2U7CiAgICBpZiAodHlwZW9mICh3U3RhdGUgPT09IG51bGwgfHwgd1N0YXRlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB3U3RhdGUuZW5kZWQpICE9PSAnYm9vbGVhbicpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHdTdGF0ZS5lbmRlZDsKICB9CgogIC8vIEhhdmUgZW1pdHRlZCAnZmluaXNoJy4KICBmdW5jdGlvbiBpc1dyaXRhYmxlRmluaXNoZWQoc3RyZWFtLCBzdHJpY3QpIHsKICAgIGlmICghaXNXcml0YWJsZU5vZGVTdHJlYW0oc3RyZWFtKSkgcmV0dXJuIG51bGw7CiAgICBpZiAoc3RyZWFtLndyaXRhYmxlRmluaXNoZWQgPT09IHRydWUpIHJldHVybiB0cnVlOwogICAgY29uc3Qgd1N0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgaWYgKHdTdGF0ZSAhPT0gbnVsbCAmJiB3U3RhdGUgIT09IHVuZGVmaW5lZCAmJiB3U3RhdGUuZXJyb3JlZCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKHR5cGVvZiAod1N0YXRlID09PSBudWxsIHx8IHdTdGF0ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogd1N0YXRlLmZpbmlzaGVkKSAhPT0gJ2Jvb2xlYW4nKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiAhISh3U3RhdGUuZmluaXNoZWQgfHwgc3RyaWN0ID09PSBmYWxzZSAmJiB3U3RhdGUuZW5kZWQgPT09IHRydWUgJiYgd1N0YXRlLmxlbmd0aCA9PT0gMCk7CiAgfQoKICAvLyBIYXZlIGJlZW4gcHVzaChudWxsKTpkLgogIGZ1bmN0aW9uIGlzUmVhZGFibGVFbmRlZChzdHJlYW0pIHsKICAgIGlmICghaXNSZWFkYWJsZU5vZGVTdHJlYW0oc3RyZWFtKSkgcmV0dXJuIG51bGw7CiAgICBpZiAoc3RyZWFtLnJlYWRhYmxlRW5kZWQgPT09IHRydWUpIHJldHVybiB0cnVlOwogICAgY29uc3QgclN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKCFyU3RhdGUgfHwgclN0YXRlLmVycm9yZWQpIHJldHVybiBmYWxzZTsKICAgIGlmICh0eXBlb2YgKHJTdGF0ZSA9PT0gbnVsbCB8fCByU3RhdGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHJTdGF0ZS5lbmRlZCkgIT09ICdib29sZWFuJykgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gclN0YXRlLmVuZGVkOwogIH0KCiAgLy8gSGF2ZSBlbWl0dGVkICdlbmQnLgogIGZ1bmN0aW9uIGlzUmVhZGFibGVGaW5pc2hlZChzdHJlYW0sIHN0cmljdCkgewogICAgaWYgKCFpc1JlYWRhYmxlTm9kZVN0cmVhbShzdHJlYW0pKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IHJTdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgIGlmIChyU3RhdGUgIT09IG51bGwgJiYgclN0YXRlICE9PSB1bmRlZmluZWQgJiYgclN0YXRlLmVycm9yZWQpIHJldHVybiBmYWxzZTsKICAgIGlmICh0eXBlb2YgKHJTdGF0ZSA9PT0gbnVsbCB8fCByU3RhdGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHJTdGF0ZS5lbmRFbWl0dGVkKSAhPT0gJ2Jvb2xlYW4nKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiAhIShyU3RhdGUuZW5kRW1pdHRlZCB8fCBzdHJpY3QgPT09IGZhbHNlICYmIHJTdGF0ZS5lbmRlZCA9PT0gdHJ1ZSAmJiByU3RhdGUubGVuZ3RoID09PSAwKTsKICB9CiAgZnVuY3Rpb24gaXNSZWFkYWJsZShzdHJlYW0pIHsKICAgIGlmIChzdHJlYW0gJiYgc3RyZWFtW2tJc1JlYWRhYmxlXSAhPSBudWxsKSByZXR1cm4gc3RyZWFtW2tJc1JlYWRhYmxlXTsKICAgIGlmICh0eXBlb2YgKHN0cmVhbSA9PT0gbnVsbCB8fCBzdHJlYW0gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHN0cmVhbS5yZWFkYWJsZSkgIT09ICdib29sZWFuJykgcmV0dXJuIG51bGw7CiAgICBpZiAoaXNEZXN0cm95ZWQoc3RyZWFtKSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIGlzUmVhZGFibGVOb2RlU3RyZWFtKHN0cmVhbSkgJiYgc3RyZWFtLnJlYWRhYmxlICYmICFpc1JlYWRhYmxlRmluaXNoZWQoc3RyZWFtKTsKICB9CiAgZnVuY3Rpb24gaXNXcml0YWJsZShzdHJlYW0pIHsKICAgIGlmIChzdHJlYW0gJiYgc3RyZWFtW2tJc1dyaXRhYmxlXSAhPSBudWxsKSByZXR1cm4gc3RyZWFtW2tJc1dyaXRhYmxlXTsKICAgIGlmICh0eXBlb2YgKHN0cmVhbSA9PT0gbnVsbCB8fCBzdHJlYW0gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHN0cmVhbS53cml0YWJsZSkgIT09ICdib29sZWFuJykgcmV0dXJuIG51bGw7CiAgICBpZiAoaXNEZXN0cm95ZWQoc3RyZWFtKSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIGlzV3JpdGFibGVOb2RlU3RyZWFtKHN0cmVhbSkgJiYgc3RyZWFtLndyaXRhYmxlICYmICFpc1dyaXRhYmxlRW5kZWQoc3RyZWFtKTsKICB9CiAgZnVuY3Rpb24gaXNGaW5pc2hlZChzdHJlYW0sIG9wdHMpIHsKICAgIGlmICghaXNOb2RlU3RyZWFtKHN0cmVhbSkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAoaXNEZXN0cm95ZWQoc3RyZWFtKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICgob3B0cyA9PT0gbnVsbCB8fCBvcHRzID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRzLnJlYWRhYmxlKSAhPT0gZmFsc2UgJiYgaXNSZWFkYWJsZShzdHJlYW0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmICgob3B0cyA9PT0gbnVsbCB8fCBvcHRzID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRzLndyaXRhYmxlKSAhPT0gZmFsc2UgJiYgaXNXcml0YWJsZShzdHJlYW0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiBpc1dyaXRhYmxlRXJyb3JlZChzdHJlYW0pIHsKICAgIHZhciBfc3RyZWFtJF93cml0YWJsZVN0YXQsIF9zdHJlYW0kX3dyaXRhYmxlU3RhdDI7CiAgICBpZiAoIWlzTm9kZVN0cmVhbShzdHJlYW0pKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHN0cmVhbS53cml0YWJsZUVycm9yZWQpIHsKICAgICAgcmV0dXJuIHN0cmVhbS53cml0YWJsZUVycm9yZWQ7CiAgICB9CiAgICByZXR1cm4gKF9zdHJlYW0kX3dyaXRhYmxlU3RhdCA9IChfc3RyZWFtJF93cml0YWJsZVN0YXQyID0gc3RyZWFtLl93cml0YWJsZVN0YXRlKSA9PT0gbnVsbCB8fCBfc3RyZWFtJF93cml0YWJsZVN0YXQyID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfc3RyZWFtJF93cml0YWJsZVN0YXQyLmVycm9yZWQpICE9PSBudWxsICYmIF9zdHJlYW0kX3dyaXRhYmxlU3RhdCAhPT0gdW5kZWZpbmVkID8gX3N0cmVhbSRfd3JpdGFibGVTdGF0IDogbnVsbDsKICB9CiAgZnVuY3Rpb24gaXNSZWFkYWJsZUVycm9yZWQoc3RyZWFtKSB7CiAgICB2YXIgX3N0cmVhbSRfcmVhZGFibGVTdGF0LCBfc3RyZWFtJF9yZWFkYWJsZVN0YXQyOwogICAgaWYgKCFpc05vZGVTdHJlYW0oc3RyZWFtKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmIChzdHJlYW0ucmVhZGFibGVFcnJvcmVkKSB7CiAgICAgIHJldHVybiBzdHJlYW0ucmVhZGFibGVFcnJvcmVkOwogICAgfQogICAgcmV0dXJuIChfc3RyZWFtJF9yZWFkYWJsZVN0YXQgPSAoX3N0cmVhbSRfcmVhZGFibGVTdGF0MiA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZSkgPT09IG51bGwgfHwgX3N0cmVhbSRfcmVhZGFibGVTdGF0MiA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogX3N0cmVhbSRfcmVhZGFibGVTdGF0Mi5lcnJvcmVkKSAhPT0gbnVsbCAmJiBfc3RyZWFtJF9yZWFkYWJsZVN0YXQgIT09IHVuZGVmaW5lZCA/IF9zdHJlYW0kX3JlYWRhYmxlU3RhdCA6IG51bGw7CiAgfQogIGZ1bmN0aW9uIGlzQ2xvc2VkKHN0cmVhbSkgewogICAgaWYgKCFpc05vZGVTdHJlYW0oc3RyZWFtKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0eXBlb2Ygc3RyZWFtLmNsb3NlZCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIHJldHVybiBzdHJlYW0uY2xvc2VkOwogICAgfQogICAgY29uc3Qgd1N0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgY29uc3QgclN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKHR5cGVvZiAod1N0YXRlID09PSBudWxsIHx8IHdTdGF0ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogd1N0YXRlLmNsb3NlZCkgPT09ICdib29sZWFuJyB8fCB0eXBlb2YgKHJTdGF0ZSA9PT0gbnVsbCB8fCByU3RhdGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHJTdGF0ZS5jbG9zZWQpID09PSAnYm9vbGVhbicpIHsKICAgICAgcmV0dXJuICh3U3RhdGUgPT09IG51bGwgfHwgd1N0YXRlID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB3U3RhdGUuY2xvc2VkKSB8fCAoclN0YXRlID09PSBudWxsIHx8IHJTdGF0ZSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogclN0YXRlLmNsb3NlZCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHN0cmVhbS5fY2xvc2VkID09PSAnYm9vbGVhbicgJiYgaXNPdXRnb2luZ01lc3NhZ2Uoc3RyZWFtKSkgewogICAgICByZXR1cm4gc3RyZWFtLl9jbG9zZWQ7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZnVuY3Rpb24gaXNPdXRnb2luZ01lc3NhZ2Uoc3RyZWFtKSB7CiAgICByZXR1cm4gdHlwZW9mIHN0cmVhbS5fY2xvc2VkID09PSAnYm9vbGVhbicgJiYgdHlwZW9mIHN0cmVhbS5fZGVmYXVsdEtlZXBBbGl2ZSA9PT0gJ2Jvb2xlYW4nICYmIHR5cGVvZiBzdHJlYW0uX3JlbW92ZWRDb25uZWN0aW9uID09PSAnYm9vbGVhbicgJiYgdHlwZW9mIHN0cmVhbS5fcmVtb3ZlZENvbnRMZW4gPT09ICdib29sZWFuJzsKICB9CiAgZnVuY3Rpb24gaXNTZXJ2ZXJSZXNwb25zZShzdHJlYW0pIHsKICAgIHJldHVybiB0eXBlb2Ygc3RyZWFtLl9zZW50MTAwID09PSAnYm9vbGVhbicgJiYgaXNPdXRnb2luZ01lc3NhZ2Uoc3RyZWFtKTsKICB9CiAgZnVuY3Rpb24gaXNTZXJ2ZXJSZXF1ZXN0KHN0cmVhbSkgewogICAgdmFyIF9zdHJlYW0kcmVxOwogICAgcmV0dXJuIHR5cGVvZiBzdHJlYW0uX2NvbnN1bWluZyA9PT0gJ2Jvb2xlYW4nICYmIHR5cGVvZiBzdHJlYW0uX2R1bXBlZCA9PT0gJ2Jvb2xlYW4nICYmICgoX3N0cmVhbSRyZXEgPSBzdHJlYW0ucmVxKSA9PT0gbnVsbCB8fCBfc3RyZWFtJHJlcSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogX3N0cmVhbSRyZXEudXBncmFkZU9yQ29ubmVjdCkgPT09IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gd2lsbEVtaXRDbG9zZShzdHJlYW0pIHsKICAgIGlmICghaXNOb2RlU3RyZWFtKHN0cmVhbSkpIHJldHVybiBudWxsOwogICAgY29uc3Qgd1N0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgY29uc3QgclN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgY29uc3Qgc3RhdGUgPSB3U3RhdGUgfHwgclN0YXRlOwogICAgcmV0dXJuICFzdGF0ZSAmJiBpc1NlcnZlclJlc3BvbnNlKHN0cmVhbSkgfHwgISEoc3RhdGUgJiYgc3RhdGUuYXV0b0Rlc3Ryb3kgJiYgc3RhdGUuZW1pdENsb3NlICYmIHN0YXRlLmNsb3NlZCA9PT0gZmFsc2UpOwogIH0KICBmdW5jdGlvbiBpc0Rpc3R1cmJlZChzdHJlYW0pIHsKICAgIHZhciBfc3RyZWFtJGtJc0Rpc3R1cmJlZDsKICAgIHJldHVybiAhIShzdHJlYW0gJiYgKChfc3RyZWFtJGtJc0Rpc3R1cmJlZCA9IHN0cmVhbVtrSXNEaXN0dXJiZWRdKSAhPT0gbnVsbCAmJiBfc3RyZWFtJGtJc0Rpc3R1cmJlZCAhPT0gdW5kZWZpbmVkID8gX3N0cmVhbSRrSXNEaXN0dXJiZWQgOiBzdHJlYW0ucmVhZGFibGVEaWRSZWFkIHx8IHN0cmVhbS5yZWFkYWJsZUFib3J0ZWQpKTsKICB9CiAgZnVuY3Rpb24gaXNFcnJvcmVkKHN0cmVhbSkgewogICAgdmFyIF9yZWYsIF9yZWYyLCBfcmVmMywgX3JlZjQsIF9yZWY1LCBfc3RyZWFtJGtJc0Vycm9yZWQsIF9zdHJlYW0kX3JlYWRhYmxlU3RhdDMsIF9zdHJlYW0kX3dyaXRhYmxlU3RhdDMsIF9zdHJlYW0kX3JlYWRhYmxlU3RhdDQsIF9zdHJlYW0kX3dyaXRhYmxlU3RhdDQ7CiAgICByZXR1cm4gISEoc3RyZWFtICYmICgoX3JlZiA9IChfcmVmMiA9IChfcmVmMyA9IChfcmVmNCA9IChfcmVmNSA9IChfc3RyZWFtJGtJc0Vycm9yZWQgPSBzdHJlYW1ba0lzRXJyb3JlZF0pICE9PSBudWxsICYmIF9zdHJlYW0ka0lzRXJyb3JlZCAhPT0gdW5kZWZpbmVkID8gX3N0cmVhbSRrSXNFcnJvcmVkIDogc3RyZWFtLnJlYWRhYmxlRXJyb3JlZCkgIT09IG51bGwgJiYgX3JlZjUgIT09IHVuZGVmaW5lZCA/IF9yZWY1IDogc3RyZWFtLndyaXRhYmxlRXJyb3JlZCkgIT09IG51bGwgJiYgX3JlZjQgIT09IHVuZGVmaW5lZCA/IF9yZWY0IDogKF9zdHJlYW0kX3JlYWRhYmxlU3RhdDMgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGUpID09PSBudWxsIHx8IF9zdHJlYW0kX3JlYWRhYmxlU3RhdDMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IF9zdHJlYW0kX3JlYWRhYmxlU3RhdDMuZXJyb3JFbWl0dGVkKSAhPT0gbnVsbCAmJiBfcmVmMyAhPT0gdW5kZWZpbmVkID8gX3JlZjMgOiAoX3N0cmVhbSRfd3JpdGFibGVTdGF0MyA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZSkgPT09IG51bGwgfHwgX3N0cmVhbSRfd3JpdGFibGVTdGF0MyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogX3N0cmVhbSRfd3JpdGFibGVTdGF0My5lcnJvckVtaXR0ZWQpICE9PSBudWxsICYmIF9yZWYyICE9PSB1bmRlZmluZWQgPyBfcmVmMiA6IChfc3RyZWFtJF9yZWFkYWJsZVN0YXQ0ID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlKSA9PT0gbnVsbCB8fCBfc3RyZWFtJF9yZWFkYWJsZVN0YXQ0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfc3RyZWFtJF9yZWFkYWJsZVN0YXQ0LmVycm9yZWQpICE9PSBudWxsICYmIF9yZWYgIT09IHVuZGVmaW5lZCA/IF9yZWYgOiAoX3N0cmVhbSRfd3JpdGFibGVTdGF0NCA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZSkgPT09IG51bGwgfHwgX3N0cmVhbSRfd3JpdGFibGVTdGF0NCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogX3N0cmVhbSRfd3JpdGFibGVTdGF0NC5lcnJvcmVkKSk7CiAgfQogIHV0aWxzJDEgPSB7CiAgICBpc0Rlc3Ryb3llZCwKICAgIGtJc0Rlc3Ryb3llZCwKICAgIGlzRGlzdHVyYmVkLAogICAga0lzRGlzdHVyYmVkLAogICAgaXNFcnJvcmVkLAogICAga0lzRXJyb3JlZCwKICAgIGlzUmVhZGFibGUsCiAgICBrSXNSZWFkYWJsZSwKICAgIGtJc0Nsb3NlZFByb21pc2UsCiAgICBrQ29udHJvbGxlckVycm9yRnVuY3Rpb24sCiAgICBrSXNXcml0YWJsZSwKICAgIGlzQ2xvc2VkLAogICAgaXNEdXBsZXhOb2RlU3RyZWFtLAogICAgaXNGaW5pc2hlZCwKICAgIGlzSXRlcmFibGUsCiAgICBpc1JlYWRhYmxlTm9kZVN0cmVhbSwKICAgIGlzUmVhZGFibGVTdHJlYW0sCiAgICBpc1JlYWRhYmxlRW5kZWQsCiAgICBpc1JlYWRhYmxlRmluaXNoZWQsCiAgICBpc1JlYWRhYmxlRXJyb3JlZCwKICAgIGlzTm9kZVN0cmVhbSwKICAgIGlzV2ViU3RyZWFtLAogICAgaXNXcml0YWJsZSwKICAgIGlzV3JpdGFibGVOb2RlU3RyZWFtLAogICAgaXNXcml0YWJsZVN0cmVhbSwKICAgIGlzV3JpdGFibGVFbmRlZCwKICAgIGlzV3JpdGFibGVGaW5pc2hlZCwKICAgIGlzV3JpdGFibGVFcnJvcmVkLAogICAgaXNTZXJ2ZXJSZXF1ZXN0LAogICAgaXNTZXJ2ZXJSZXNwb25zZSwKICAgIHdpbGxFbWl0Q2xvc2UsCiAgICBpc1RyYW5zZm9ybVN0cmVhbQogIH07CiAgcmV0dXJuIHV0aWxzJDE7Cn0KCnZhciBoYXNSZXF1aXJlZEVuZE9mU3RyZWFtOwpmdW5jdGlvbiByZXF1aXJlRW5kT2ZTdHJlYW0oKSB7CiAgaWYgKGhhc1JlcXVpcmVkRW5kT2ZTdHJlYW0pIHJldHVybiBlbmRPZlN0cmVhbS5leHBvcnRzOwogIGhhc1JlcXVpcmVkRW5kT2ZTdHJlYW0gPSAxOwoKICAvKiByZXBsYWNlbWVudCBzdGFydCAqLwoKICBjb25zdCBwcm9jZXNzID0gcmVxdWlyZVByb2Nlc3MoKTsKCiAgLyogcmVwbGFjZW1lbnQgZW5kICovCgogIGNvbnN0IHsKICAgIEFib3J0RXJyb3IsCiAgICBjb2RlcwogIH0gPSByZXF1aXJlRXJyb3JzKCk7CiAgY29uc3QgewogICAgRVJSX0lOVkFMSURfQVJHX1RZUEUsCiAgICBFUlJfU1RSRUFNX1BSRU1BVFVSRV9DTE9TRQogIH0gPSBjb2RlczsKICBjb25zdCB7CiAgICBrRW1wdHlPYmplY3QsCiAgICBvbmNlCiAgfSA9IHJlcXVpcmVVdGlsJDEoKTsKICBjb25zdCB7CiAgICB2YWxpZGF0ZUFib3J0U2lnbmFsLAogICAgdmFsaWRhdGVGdW5jdGlvbiwKICAgIHZhbGlkYXRlT2JqZWN0LAogICAgdmFsaWRhdGVCb29sZWFuCiAgfSA9IHJlcXVpcmVWYWxpZGF0b3JzKCk7CiAgY29uc3QgewogICAgUHJvbWlzZSwKICAgIFByb21pc2VQcm90b3R5cGVUaGVuLAogICAgU3ltYm9sRGlzcG9zZQogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKICBjb25zdCB7CiAgICBpc0Nsb3NlZCwKICAgIGlzUmVhZGFibGUsCiAgICBpc1JlYWRhYmxlTm9kZVN0cmVhbSwKICAgIGlzUmVhZGFibGVTdHJlYW0sCiAgICBpc1JlYWRhYmxlRmluaXNoZWQsCiAgICBpc1JlYWRhYmxlRXJyb3JlZCwKICAgIGlzV3JpdGFibGUsCiAgICBpc1dyaXRhYmxlTm9kZVN0cmVhbSwKICAgIGlzV3JpdGFibGVTdHJlYW0sCiAgICBpc1dyaXRhYmxlRmluaXNoZWQsCiAgICBpc1dyaXRhYmxlRXJyb3JlZCwKICAgIGlzTm9kZVN0cmVhbSwKICAgIHdpbGxFbWl0Q2xvc2U6IF93aWxsRW1pdENsb3NlLAogICAga0lzQ2xvc2VkUHJvbWlzZQogIH0gPSByZXF1aXJlVXRpbHMkMSgpOwogIGxldCBhZGRBYm9ydExpc3RlbmVyOwogIGZ1bmN0aW9uIGlzUmVxdWVzdChzdHJlYW0pIHsKICAgIHJldHVybiBzdHJlYW0uc2V0SGVhZGVyICYmIHR5cGVvZiBzdHJlYW0uYWJvcnQgPT09ICdmdW5jdGlvbic7CiAgfQogIGNvbnN0IG5vcCA9ICgpID0+IHt9OwogIGZ1bmN0aW9uIGVvcyhzdHJlYW0sIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgICB2YXIgX29wdGlvbnMkcmVhZGFibGUsIF9vcHRpb25zJHdyaXRhYmxlOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRpb25zOwogICAgICBvcHRpb25zID0ga0VtcHR5T2JqZWN0OwogICAgfSBlbHNlIGlmIChvcHRpb25zID09IG51bGwpIHsKICAgICAgb3B0aW9ucyA9IGtFbXB0eU9iamVjdDsKICAgIH0gZWxzZSB7CiAgICAgIHZhbGlkYXRlT2JqZWN0KG9wdGlvbnMsICdvcHRpb25zJyk7CiAgICB9CiAgICB2YWxpZGF0ZUZ1bmN0aW9uKGNhbGxiYWNrLCAnY2FsbGJhY2snKTsKICAgIHZhbGlkYXRlQWJvcnRTaWduYWwob3B0aW9ucy5zaWduYWwsICdvcHRpb25zLnNpZ25hbCcpOwogICAgY2FsbGJhY2sgPSBvbmNlKGNhbGxiYWNrKTsKICAgIGlmIChpc1JlYWRhYmxlU3RyZWFtKHN0cmVhbSkgfHwgaXNXcml0YWJsZVN0cmVhbShzdHJlYW0pKSB7CiAgICAgIHJldHVybiBlb3NXZWIoc3RyZWFtLCBvcHRpb25zLCBjYWxsYmFjayk7CiAgICB9CiAgICBpZiAoIWlzTm9kZVN0cmVhbShzdHJlYW0pKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgnc3RyZWFtJywgWydSZWFkYWJsZVN0cmVhbScsICdXcml0YWJsZVN0cmVhbScsICdTdHJlYW0nXSwgc3RyZWFtKTsKICAgIH0KICAgIGNvbnN0IHJlYWRhYmxlID0gKF9vcHRpb25zJHJlYWRhYmxlID0gb3B0aW9ucy5yZWFkYWJsZSkgIT09IG51bGwgJiYgX29wdGlvbnMkcmVhZGFibGUgIT09IHVuZGVmaW5lZCA/IF9vcHRpb25zJHJlYWRhYmxlIDogaXNSZWFkYWJsZU5vZGVTdHJlYW0oc3RyZWFtKTsKICAgIGNvbnN0IHdyaXRhYmxlID0gKF9vcHRpb25zJHdyaXRhYmxlID0gb3B0aW9ucy53cml0YWJsZSkgIT09IG51bGwgJiYgX29wdGlvbnMkd3JpdGFibGUgIT09IHVuZGVmaW5lZCA/IF9vcHRpb25zJHdyaXRhYmxlIDogaXNXcml0YWJsZU5vZGVTdHJlYW0oc3RyZWFtKTsKICAgIGNvbnN0IHdTdGF0ZSA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZTsKICAgIGNvbnN0IHJTdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IG9ubGVnYWN5ZmluaXNoID0gKCkgPT4gewogICAgICBpZiAoIXN0cmVhbS53cml0YWJsZSkgewogICAgICAgIG9uZmluaXNoKCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gVE9ETyAocm9uYWcpOiBJbXByb3ZlIHNvZnQgZGV0ZWN0aW9uIHRvIGluY2x1ZGUgY29yZSBtb2R1bGVzIGFuZAogICAgLy8gY29tbW9uIGVjb3N5c3RlbSBtb2R1bGVzIHRoYXQgZG8gcHJvcGVybHkgZW1pdCAnY2xvc2UnIGJ1dCBmYWlsCiAgICAvLyB0aGlzIGdlbmVyaWMgY2hlY2suCiAgICBsZXQgd2lsbEVtaXRDbG9zZSA9IF93aWxsRW1pdENsb3NlKHN0cmVhbSkgJiYgaXNSZWFkYWJsZU5vZGVTdHJlYW0oc3RyZWFtKSA9PT0gcmVhZGFibGUgJiYgaXNXcml0YWJsZU5vZGVTdHJlYW0oc3RyZWFtKSA9PT0gd3JpdGFibGU7CiAgICBsZXQgd3JpdGFibGVGaW5pc2hlZCA9IGlzV3JpdGFibGVGaW5pc2hlZChzdHJlYW0sIGZhbHNlKTsKICAgIGNvbnN0IG9uZmluaXNoID0gKCkgPT4gewogICAgICB3cml0YWJsZUZpbmlzaGVkID0gdHJ1ZTsKICAgICAgLy8gU3RyZWFtIHNob3VsZCBub3QgYmUgZGVzdHJveWVkIGhlcmUuIElmIGl0IGlzIHRoYXQKICAgICAgLy8gbWVhbnMgdGhhdCB1c2VyIHNwYWNlIGlzIGRvaW5nIHNvbWV0aGluZyBkaWZmZXJlbnRseSBhbmQKICAgICAgLy8gd2UgY2Fubm90IHRydXN0IHdpbGxFbWl0Q2xvc2UuCiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgd2lsbEVtaXRDbG9zZSA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmICh3aWxsRW1pdENsb3NlICYmICghc3RyZWFtLnJlYWRhYmxlIHx8IHJlYWRhYmxlKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXJlYWRhYmxlIHx8IHJlYWRhYmxlRmluaXNoZWQpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHN0cmVhbSk7CiAgICAgIH0KICAgIH07CiAgICBsZXQgcmVhZGFibGVGaW5pc2hlZCA9IGlzUmVhZGFibGVGaW5pc2hlZChzdHJlYW0sIGZhbHNlKTsKICAgIGNvbnN0IG9uZW5kID0gKCkgPT4gewogICAgICByZWFkYWJsZUZpbmlzaGVkID0gdHJ1ZTsKICAgICAgLy8gU3RyZWFtIHNob3VsZCBub3QgYmUgZGVzdHJveWVkIGhlcmUuIElmIGl0IGlzIHRoYXQKICAgICAgLy8gbWVhbnMgdGhhdCB1c2VyIHNwYWNlIGlzIGRvaW5nIHNvbWV0aGluZyBkaWZmZXJlbnRseSBhbmQKICAgICAgLy8gd2UgY2Fubm90IHRydXN0IHdpbGxFbWl0Q2xvc2UuCiAgICAgIGlmIChzdHJlYW0uZGVzdHJveWVkKSB7CiAgICAgICAgd2lsbEVtaXRDbG9zZSA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmICh3aWxsRW1pdENsb3NlICYmICghc3RyZWFtLndyaXRhYmxlIHx8IHdyaXRhYmxlKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXdyaXRhYmxlIHx8IHdyaXRhYmxlRmluaXNoZWQpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHN0cmVhbSk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBvbmVycm9yID0gZXJyID0+IHsKICAgICAgY2FsbGJhY2suY2FsbChzdHJlYW0sIGVycik7CiAgICB9OwogICAgbGV0IGNsb3NlZCA9IGlzQ2xvc2VkKHN0cmVhbSk7CiAgICBjb25zdCBvbmNsb3NlID0gKCkgPT4gewogICAgICBjbG9zZWQgPSB0cnVlOwogICAgICBjb25zdCBlcnJvcmVkID0gaXNXcml0YWJsZUVycm9yZWQoc3RyZWFtKSB8fCBpc1JlYWRhYmxlRXJyb3JlZChzdHJlYW0pOwogICAgICBpZiAoZXJyb3JlZCAmJiB0eXBlb2YgZXJyb3JlZCAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoc3RyZWFtLCBlcnJvcmVkKTsKICAgICAgfQogICAgICBpZiAocmVhZGFibGUgJiYgIXJlYWRhYmxlRmluaXNoZWQgJiYgaXNSZWFkYWJsZU5vZGVTdHJlYW0oc3RyZWFtLCB0cnVlKSkgewogICAgICAgIGlmICghaXNSZWFkYWJsZUZpbmlzaGVkKHN0cmVhbSwgZmFsc2UpKSByZXR1cm4gY2FsbGJhY2suY2FsbChzdHJlYW0sIG5ldyBFUlJfU1RSRUFNX1BSRU1BVFVSRV9DTE9TRSgpKTsKICAgICAgfQogICAgICBpZiAod3JpdGFibGUgJiYgIXdyaXRhYmxlRmluaXNoZWQpIHsKICAgICAgICBpZiAoIWlzV3JpdGFibGVGaW5pc2hlZChzdHJlYW0sIGZhbHNlKSkgcmV0dXJuIGNhbGxiYWNrLmNhbGwoc3RyZWFtLCBuZXcgRVJSX1NUUkVBTV9QUkVNQVRVUkVfQ0xPU0UoKSk7CiAgICAgIH0KICAgICAgY2FsbGJhY2suY2FsbChzdHJlYW0pOwogICAgfTsKICAgIGNvbnN0IG9uY2xvc2VkID0gKCkgPT4gewogICAgICBjbG9zZWQgPSB0cnVlOwogICAgICBjb25zdCBlcnJvcmVkID0gaXNXcml0YWJsZUVycm9yZWQoc3RyZWFtKSB8fCBpc1JlYWRhYmxlRXJyb3JlZChzdHJlYW0pOwogICAgICBpZiAoZXJyb3JlZCAmJiB0eXBlb2YgZXJyb3JlZCAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoc3RyZWFtLCBlcnJvcmVkKTsKICAgICAgfQogICAgICBjYWxsYmFjay5jYWxsKHN0cmVhbSk7CiAgICB9OwogICAgY29uc3Qgb25yZXF1ZXN0ID0gKCkgPT4gewogICAgICBzdHJlYW0ucmVxLm9uKCdmaW5pc2gnLCBvbmZpbmlzaCk7CiAgICB9OwogICAgaWYgKGlzUmVxdWVzdChzdHJlYW0pKSB7CiAgICAgIHN0cmVhbS5vbignY29tcGxldGUnLCBvbmZpbmlzaCk7CiAgICAgIGlmICghd2lsbEVtaXRDbG9zZSkgewogICAgICAgIHN0cmVhbS5vbignYWJvcnQnLCBvbmNsb3NlKTsKICAgICAgfQogICAgICBpZiAoc3RyZWFtLnJlcSkgewogICAgICAgIG9ucmVxdWVzdCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5vbigncmVxdWVzdCcsIG9ucmVxdWVzdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAod3JpdGFibGUgJiYgIXdTdGF0ZSkgewogICAgICAvLyBsZWdhY3kgc3RyZWFtcwogICAgICBzdHJlYW0ub24oJ2VuZCcsIG9ubGVnYWN5ZmluaXNoKTsKICAgICAgc3RyZWFtLm9uKCdjbG9zZScsIG9ubGVnYWN5ZmluaXNoKTsKICAgIH0KCiAgICAvLyBOb3QgYWxsIHN0cmVhbXMgd2lsbCBlbWl0ICdjbG9zZScgYWZ0ZXIgJ2Fib3J0ZWQnLgogICAgaWYgKCF3aWxsRW1pdENsb3NlICYmIHR5cGVvZiBzdHJlYW0uYWJvcnRlZCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIHN0cmVhbS5vbignYWJvcnRlZCcsIG9uY2xvc2UpOwogICAgfQogICAgc3RyZWFtLm9uKCdlbmQnLCBvbmVuZCk7CiAgICBzdHJlYW0ub24oJ2ZpbmlzaCcsIG9uZmluaXNoKTsKICAgIGlmIChvcHRpb25zLmVycm9yICE9PSBmYWxzZSkgewogICAgICBzdHJlYW0ub24oJ2Vycm9yJywgb25lcnJvcik7CiAgICB9CiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgb25jbG9zZSk7CiAgICBpZiAoY2xvc2VkKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2sob25jbG9zZSk7CiAgICB9IGVsc2UgaWYgKHdTdGF0ZSAhPT0gbnVsbCAmJiB3U3RhdGUgIT09IHVuZGVmaW5lZCAmJiB3U3RhdGUuZXJyb3JFbWl0dGVkIHx8IHJTdGF0ZSAhPT0gbnVsbCAmJiByU3RhdGUgIT09IHVuZGVmaW5lZCAmJiByU3RhdGUuZXJyb3JFbWl0dGVkKSB7CiAgICAgIGlmICghd2lsbEVtaXRDbG9zZSkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2sob25jbG9zZWQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCFyZWFkYWJsZSAmJiAoIXdpbGxFbWl0Q2xvc2UgfHwgaXNSZWFkYWJsZShzdHJlYW0pKSAmJiAod3JpdGFibGVGaW5pc2hlZCB8fCBpc1dyaXRhYmxlKHN0cmVhbSkgPT09IGZhbHNlKSkgewogICAgICBwcm9jZXNzLm5leHRUaWNrKG9uY2xvc2VkKTsKICAgIH0gZWxzZSBpZiAoIXdyaXRhYmxlICYmICghd2lsbEVtaXRDbG9zZSB8fCBpc1dyaXRhYmxlKHN0cmVhbSkpICYmIChyZWFkYWJsZUZpbmlzaGVkIHx8IGlzUmVhZGFibGUoc3RyZWFtKSA9PT0gZmFsc2UpKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2sob25jbG9zZWQpOwogICAgfSBlbHNlIGlmIChyU3RhdGUgJiYgc3RyZWFtLnJlcSAmJiBzdHJlYW0uYWJvcnRlZCkgewogICAgICBwcm9jZXNzLm5leHRUaWNrKG9uY2xvc2VkKTsKICAgIH0KICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7CiAgICAgIGNhbGxiYWNrID0gbm9wOwogICAgICBzdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Fib3J0ZWQnLCBvbmNsb3NlKTsKICAgICAgc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjb21wbGV0ZScsIG9uZmluaXNoKTsKICAgICAgc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdhYm9ydCcsIG9uY2xvc2UpOwogICAgICBzdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ3JlcXVlc3QnLCBvbnJlcXVlc3QpOwogICAgICBpZiAoc3RyZWFtLnJlcSkgc3RyZWFtLnJlcS5yZW1vdmVMaXN0ZW5lcignZmluaXNoJywgb25maW5pc2gpOwogICAgICBzdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9ubGVnYWN5ZmluaXNoKTsKICAgICAgc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9ubGVnYWN5ZmluaXNoKTsKICAgICAgc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdmaW5pc2gnLCBvbmZpbmlzaCk7CiAgICAgIHN0cmVhbS5yZW1vdmVMaXN0ZW5lcignZW5kJywgb25lbmQpOwogICAgICBzdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICAgIHN0cmVhbS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgIH07CiAgICBpZiAob3B0aW9ucy5zaWduYWwgJiYgIWNsb3NlZCkgewogICAgICBjb25zdCBhYm9ydCA9ICgpID0+IHsKICAgICAgICAvLyBLZWVwIGl0IGJlY2F1c2UgY2xlYW51cCByZW1vdmVzIGl0LgogICAgICAgIGNvbnN0IGVuZENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgY2xlYW51cCgpOwogICAgICAgIGVuZENhbGxiYWNrLmNhbGwoc3RyZWFtLCBuZXcgQWJvcnRFcnJvcih1bmRlZmluZWQsIHsKICAgICAgICAgIGNhdXNlOiBvcHRpb25zLnNpZ25hbC5yZWFzb24KICAgICAgICB9KSk7CiAgICAgIH07CiAgICAgIGlmIChvcHRpb25zLnNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhhYm9ydCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWRkQWJvcnRMaXN0ZW5lciA9IGFkZEFib3J0TGlzdGVuZXIgfHwgcmVxdWlyZVV0aWwkMSgpLmFkZEFib3J0TGlzdGVuZXI7CiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IGFkZEFib3J0TGlzdGVuZXIob3B0aW9ucy5zaWduYWwsIGFib3J0KTsKICAgICAgICBjb25zdCBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSBvbmNlKCguLi5hcmdzKSA9PiB7CiAgICAgICAgICBkaXNwb3NhYmxlW1N5bWJvbERpc3Bvc2VdKCk7CiAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmFwcGx5KHN0cmVhbSwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjbGVhbnVwOwogIH0KICBmdW5jdGlvbiBlb3NXZWIoc3RyZWFtLCBvcHRpb25zLCBjYWxsYmFjaykgewogICAgbGV0IGlzQWJvcnRlZCA9IGZhbHNlOwogICAgbGV0IGFib3J0ID0gbm9wOwogICAgaWYgKG9wdGlvbnMuc2lnbmFsKSB7CiAgICAgIGFib3J0ID0gKCkgPT4gewogICAgICAgIGlzQWJvcnRlZCA9IHRydWU7CiAgICAgICAgY2FsbGJhY2suY2FsbChzdHJlYW0sIG5ldyBBYm9ydEVycm9yKHVuZGVmaW5lZCwgewogICAgICAgICAgY2F1c2U6IG9wdGlvbnMuc2lnbmFsLnJlYXNvbgogICAgICAgIH0pKTsKICAgICAgfTsKICAgICAgaWYgKG9wdGlvbnMuc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGFib3J0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhZGRBYm9ydExpc3RlbmVyID0gYWRkQWJvcnRMaXN0ZW5lciB8fCByZXF1aXJlVXRpbCQxKCkuYWRkQWJvcnRMaXN0ZW5lcjsKICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gYWRkQWJvcnRMaXN0ZW5lcihvcHRpb25zLnNpZ25hbCwgYWJvcnQpOwogICAgICAgIGNvbnN0IG9yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICBjYWxsYmFjayA9IG9uY2UoKC4uLmFyZ3MpID0+IHsKICAgICAgICAgIGRpc3Bvc2FibGVbU3ltYm9sRGlzcG9zZV0oKTsKICAgICAgICAgIG9yaWdpbmFsQ2FsbGJhY2suYXBwbHkoc3RyZWFtLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVzb2x2ZXJGbiA9ICguLi5hcmdzKSA9PiB7CiAgICAgIGlmICghaXNBYm9ydGVkKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiBjYWxsYmFjay5hcHBseShzdHJlYW0sIGFyZ3MpKTsKICAgICAgfQogICAgfTsKICAgIFByb21pc2VQcm90b3R5cGVUaGVuKHN0cmVhbVtrSXNDbG9zZWRQcm9taXNlXS5wcm9taXNlLCByZXNvbHZlckZuLCByZXNvbHZlckZuKTsKICAgIHJldHVybiBub3A7CiAgfQogIGZ1bmN0aW9uIGZpbmlzaGVkKHN0cmVhbSwgb3B0cykgewogICAgdmFyIF9vcHRzOwogICAgbGV0IGF1dG9DbGVhbnVwID0gZmFsc2U7CiAgICBpZiAob3B0cyA9PT0gbnVsbCkgewogICAgICBvcHRzID0ga0VtcHR5T2JqZWN0OwogICAgfQogICAgaWYgKChfb3B0cyA9IG9wdHMpICE9PSBudWxsICYmIF9vcHRzICE9PSB1bmRlZmluZWQgJiYgX29wdHMuY2xlYW51cCkgewogICAgICB2YWxpZGF0ZUJvb2xlYW4ob3B0cy5jbGVhbnVwLCAnY2xlYW51cCcpOwogICAgICBhdXRvQ2xlYW51cCA9IG9wdHMuY2xlYW51cDsKICAgIH0KICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbnN0IGNsZWFudXAgPSBlb3Moc3RyZWFtLCBvcHRzLCBlcnIgPT4gewogICAgICAgIGlmIChhdXRvQ2xlYW51cCkgewogICAgICAgICAgY2xlYW51cCgpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgZW5kT2ZTdHJlYW0uZXhwb3J0cyA9IGVvczsKICBlbmRPZlN0cmVhbS5leHBvcnRzLmZpbmlzaGVkID0gZmluaXNoZWQ7CiAgcmV0dXJuIGVuZE9mU3RyZWFtLmV4cG9ydHM7Cn0KCnZhciBkZXN0cm95XzE7CnZhciBoYXNSZXF1aXJlZERlc3Ryb3k7CmZ1bmN0aW9uIHJlcXVpcmVEZXN0cm95KCkgewogIGlmIChoYXNSZXF1aXJlZERlc3Ryb3kpIHJldHVybiBkZXN0cm95XzE7CiAgaGFzUmVxdWlyZWREZXN0cm95ID0gMTsKCiAgLyogcmVwbGFjZW1lbnQgc3RhcnQgKi8KCiAgY29uc3QgcHJvY2VzcyA9IHJlcXVpcmVQcm9jZXNzKCk7CgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLwoKICBjb25zdCB7CiAgICBhZ2dyZWdhdGVUd29FcnJvcnMsCiAgICBjb2RlczogewogICAgICBFUlJfTVVMVElQTEVfQ0FMTEJBQ0sKICAgIH0sCiAgICBBYm9ydEVycm9yCiAgfSA9IHJlcXVpcmVFcnJvcnMoKTsKICBjb25zdCB7CiAgICBTeW1ib2wKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgY29uc3QgewogICAga0lzRGVzdHJveWVkLAogICAgaXNEZXN0cm95ZWQsCiAgICBpc0ZpbmlzaGVkLAogICAgaXNTZXJ2ZXJSZXF1ZXN0CiAgfSA9IHJlcXVpcmVVdGlscyQxKCk7CiAgY29uc3Qga0Rlc3Ryb3kgPSBTeW1ib2woJ2tEZXN0cm95Jyk7CiAgY29uc3Qga0NvbnN0cnVjdCA9IFN5bWJvbCgna0NvbnN0cnVjdCcpOwogIGZ1bmN0aW9uIGNoZWNrRXJyb3IoZXJyLCB3LCByKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIC8vIEF2b2lkIFY4IGxlYWssIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9wdWxsLzM0MTAzI2lzc3VlY29tbWVudC02NTIwMDIzNjQKICAgICAgZXJyLnN0YWNrOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC1leHByZXNzaW9ucwoKICAgICAgaWYgKHcgJiYgIXcuZXJyb3JlZCkgewogICAgICAgIHcuZXJyb3JlZCA9IGVycjsKICAgICAgfQogICAgICBpZiAociAmJiAhci5lcnJvcmVkKSB7CiAgICAgICAgci5lcnJvcmVkID0gZXJyOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBCYWNrd2FyZHMgY29tcGF0LiBjYigpIGlzIHVuZG9jdW1lbnRlZCBhbmQgdW51c2VkIGluIGNvcmUgYnV0CiAgLy8gdW5mb3J0dW5hdGVseSBtaWdodCBiZSB1c2VkIGJ5IG1vZHVsZXMuCiAgZnVuY3Rpb24gZGVzdHJveShlcnIsIGNiKSB7CiAgICBjb25zdCByID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IHcgPSB0aGlzLl93cml0YWJsZVN0YXRlOwogICAgLy8gV2l0aCBkdXBsZXggc3RyZWFtcyB3ZSB1c2UgdGhlIHdyaXRhYmxlIHNpZGUgZm9yIHN0YXRlLgogICAgY29uc3QgcyA9IHcgfHwgcjsKICAgIGlmICh3ICE9PSBudWxsICYmIHcgIT09IHVuZGVmaW5lZCAmJiB3LmRlc3Ryb3llZCB8fCByICE9PSBudWxsICYmIHIgIT09IHVuZGVmaW5lZCAmJiByLmRlc3Ryb3llZCkgewogICAgICBpZiAodHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2IoKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvLyBXZSBzZXQgZGVzdHJveWVkIHRvIHRydWUgYmVmb3JlIGZpcmluZyBlcnJvciBjYWxsYmFja3MgaW4gb3JkZXIKICAgIC8vIHRvIG1ha2UgaXQgcmUtZW50cmFuY2Ugc2FmZSBpbiBjYXNlIGRlc3Ryb3koKSBpcyBjYWxsZWQgd2l0aGluIGNhbGxiYWNrcwogICAgY2hlY2tFcnJvcihlcnIsIHcsIHIpOwogICAgaWYgKHcpIHsKICAgICAgdy5kZXN0cm95ZWQgPSB0cnVlOwogICAgfQogICAgaWYgKHIpIHsKICAgICAgci5kZXN0cm95ZWQgPSB0cnVlOwogICAgfQoKICAgIC8vIElmIHN0aWxsIGNvbnN0cnVjdGluZyB0aGVuIGRlZmVyIGNhbGxpbmcgX2Rlc3Ryb3kuCiAgICBpZiAoIXMuY29uc3RydWN0ZWQpIHsKICAgICAgdGhpcy5vbmNlKGtEZXN0cm95LCBmdW5jdGlvbiAoZXIpIHsKICAgICAgICBfZGVzdHJveSh0aGlzLCBhZ2dyZWdhdGVUd29FcnJvcnMoZXIsIGVyciksIGNiKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBfZGVzdHJveSh0aGlzLCBlcnIsIGNiKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBmdW5jdGlvbiBfZGVzdHJveShzZWxmLCBlcnIsIGNiKSB7CiAgICBsZXQgY2FsbGVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBvbkRlc3Ryb3koZXJyKSB7CiAgICAgIGlmIChjYWxsZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgY29uc3QgciA9IHNlbGYuX3JlYWRhYmxlU3RhdGU7CiAgICAgIGNvbnN0IHcgPSBzZWxmLl93cml0YWJsZVN0YXRlOwogICAgICBjaGVja0Vycm9yKGVyciwgdywgcik7CiAgICAgIGlmICh3KSB7CiAgICAgICAgdy5jbG9zZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChyKSB7CiAgICAgICAgci5jbG9zZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYihlcnIpOwogICAgICB9CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRFcnJvckNsb3NlTlQsIHNlbGYsIGVycik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhlbWl0Q2xvc2VOVCwgc2VsZik7CiAgICAgIH0KICAgIH0KICAgIHRyeSB7CiAgICAgIHNlbGYuX2Rlc3Ryb3koZXJyIHx8IG51bGwsIG9uRGVzdHJveSk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgb25EZXN0cm95KGVycik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVtaXRFcnJvckNsb3NlTlQoc2VsZiwgZXJyKSB7CiAgICBlbWl0RXJyb3JOVChzZWxmLCBlcnIpOwogICAgZW1pdENsb3NlTlQoc2VsZik7CiAgfQogIGZ1bmN0aW9uIGVtaXRDbG9zZU5UKHNlbGYpIHsKICAgIGNvbnN0IHIgPSBzZWxmLl9yZWFkYWJsZVN0YXRlOwogICAgY29uc3QgdyA9IHNlbGYuX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAodykgewogICAgICB3LmNsb3NlRW1pdHRlZCA9IHRydWU7CiAgICB9CiAgICBpZiAocikgewogICAgICByLmNsb3NlRW1pdHRlZCA9IHRydWU7CiAgICB9CiAgICBpZiAodyAhPT0gbnVsbCAmJiB3ICE9PSB1bmRlZmluZWQgJiYgdy5lbWl0Q2xvc2UgfHwgciAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQgJiYgci5lbWl0Q2xvc2UpIHsKICAgICAgc2VsZi5lbWl0KCdjbG9zZScpOwogICAgfQogIH0KICBmdW5jdGlvbiBlbWl0RXJyb3JOVChzZWxmLCBlcnIpIHsKICAgIGNvbnN0IHIgPSBzZWxmLl9yZWFkYWJsZVN0YXRlOwogICAgY29uc3QgdyA9IHNlbGYuX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAodyAhPT0gbnVsbCAmJiB3ICE9PSB1bmRlZmluZWQgJiYgdy5lcnJvckVtaXR0ZWQgfHwgciAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQgJiYgci5lcnJvckVtaXR0ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHcpIHsKICAgICAgdy5lcnJvckVtaXR0ZWQgPSB0cnVlOwogICAgfQogICAgaWYgKHIpIHsKICAgICAgci5lcnJvckVtaXR0ZWQgPSB0cnVlOwogICAgfQogICAgc2VsZi5lbWl0KCdlcnJvcicsIGVycik7CiAgfQogIGZ1bmN0aW9uIHVuZGVzdHJveSgpIHsKICAgIGNvbnN0IHIgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgY29uc3QgdyA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAocikgewogICAgICByLmNvbnN0cnVjdGVkID0gdHJ1ZTsKICAgICAgci5jbG9zZWQgPSBmYWxzZTsKICAgICAgci5jbG9zZUVtaXR0ZWQgPSBmYWxzZTsKICAgICAgci5kZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgci5lcnJvcmVkID0gbnVsbDsKICAgICAgci5lcnJvckVtaXR0ZWQgPSBmYWxzZTsKICAgICAgci5yZWFkaW5nID0gZmFsc2U7CiAgICAgIHIuZW5kZWQgPSByLnJlYWRhYmxlID09PSBmYWxzZTsKICAgICAgci5lbmRFbWl0dGVkID0gci5yZWFkYWJsZSA9PT0gZmFsc2U7CiAgICB9CiAgICBpZiAodykgewogICAgICB3LmNvbnN0cnVjdGVkID0gdHJ1ZTsKICAgICAgdy5kZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgdy5jbG9zZWQgPSBmYWxzZTsKICAgICAgdy5jbG9zZUVtaXR0ZWQgPSBmYWxzZTsKICAgICAgdy5lcnJvcmVkID0gbnVsbDsKICAgICAgdy5lcnJvckVtaXR0ZWQgPSBmYWxzZTsKICAgICAgdy5maW5hbENhbGxlZCA9IGZhbHNlOwogICAgICB3LnByZWZpbmlzaGVkID0gZmFsc2U7CiAgICAgIHcuZW5kZWQgPSB3LndyaXRhYmxlID09PSBmYWxzZTsKICAgICAgdy5lbmRpbmcgPSB3LndyaXRhYmxlID09PSBmYWxzZTsKICAgICAgdy5maW5pc2hlZCA9IHcud3JpdGFibGUgPT09IGZhbHNlOwogICAgfQogIH0KICBmdW5jdGlvbiBlcnJvck9yRGVzdHJveShzdHJlYW0sIGVyciwgc3luYykgewogICAgLy8gV2UgaGF2ZSB0ZXN0cyB0aGF0IHJlbHkgb24gZXJyb3JzIGJlaW5nIGVtaXR0ZWQKICAgIC8vIGluIHRoZSBzYW1lIHRpY2ssIHNvIGNoYW5naW5nIHRoaXMgaXMgc2VtdmVyIG1ham9yLgogICAgLy8gRm9yIG5vdyB3aGVuIHlvdSBvcHQtaW4gdG8gYXV0b0Rlc3Ryb3kgd2UgYWxsb3cKICAgIC8vIHRoZSBlcnJvciB0byBiZSBlbWl0dGVkIG5leHRUaWNrLiBJbiBhIGZ1dHVyZQogICAgLy8gc2VtdmVyIG1ham9yIHVwZGF0ZSB3ZSBzaG91bGQgY2hhbmdlIHRoZSBkZWZhdWx0IHRvIHRoaXMuCgogICAgY29uc3QgciA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IHcgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAodyAhPT0gbnVsbCAmJiB3ICE9PSB1bmRlZmluZWQgJiYgdy5kZXN0cm95ZWQgfHwgciAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQgJiYgci5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAociAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQgJiYgci5hdXRvRGVzdHJveSB8fCB3ICE9PSBudWxsICYmIHcgIT09IHVuZGVmaW5lZCAmJiB3LmF1dG9EZXN0cm95KSBzdHJlYW0uZGVzdHJveShlcnIpO2Vsc2UgaWYgKGVycikgewogICAgICAvLyBBdm9pZCBWOCBsZWFrLCBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvcHVsbC8zNDEwMyNpc3N1ZWNvbW1lbnQtNjUyMDAyMzY0CiAgICAgIGVyci5zdGFjazsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnMKCiAgICAgIGlmICh3ICYmICF3LmVycm9yZWQpIHsKICAgICAgICB3LmVycm9yZWQgPSBlcnI7CiAgICAgIH0KICAgICAgaWYgKHIgJiYgIXIuZXJyb3JlZCkgewogICAgICAgIHIuZXJyb3JlZCA9IGVycjsKICAgICAgfQogICAgICBpZiAoc3luYykgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdEVycm9yTlQsIHN0cmVhbSwgZXJyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbWl0RXJyb3JOVChzdHJlYW0sIGVycik7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY29uc3RydWN0KHN0cmVhbSwgY2IpIHsKICAgIGlmICh0eXBlb2Ygc3RyZWFtLl9jb25zdHJ1Y3QgIT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgciA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IHcgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAocikgewogICAgICByLmNvbnN0cnVjdGVkID0gZmFsc2U7CiAgICB9CiAgICBpZiAodykgewogICAgICB3LmNvbnN0cnVjdGVkID0gZmFsc2U7CiAgICB9CiAgICBzdHJlYW0ub25jZShrQ29uc3RydWN0LCBjYik7CiAgICBpZiAoc3RyZWFtLmxpc3RlbmVyQ291bnQoa0NvbnN0cnVjdCkgPiAxKSB7CiAgICAgIC8vIER1cGxleAogICAgICByZXR1cm47CiAgICB9CiAgICBwcm9jZXNzLm5leHRUaWNrKGNvbnN0cnVjdE5ULCBzdHJlYW0pOwogIH0KICBmdW5jdGlvbiBjb25zdHJ1Y3ROVChzdHJlYW0pIHsKICAgIGxldCBjYWxsZWQgPSBmYWxzZTsKICAgIGZ1bmN0aW9uIG9uQ29uc3RydWN0KGVycikgewogICAgICBpZiAoY2FsbGVkKSB7CiAgICAgICAgZXJyb3JPckRlc3Ryb3koc3RyZWFtLCBlcnIgIT09IG51bGwgJiYgZXJyICE9PSB1bmRlZmluZWQgPyBlcnIgOiBuZXcgRVJSX01VTFRJUExFX0NBTExCQUNLKCkpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjYWxsZWQgPSB0cnVlOwogICAgICBjb25zdCByID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgICBjb25zdCB3ID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgICBjb25zdCBzID0gdyB8fCByOwogICAgICBpZiAocikgewogICAgICAgIHIuY29uc3RydWN0ZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICh3KSB7CiAgICAgICAgdy5jb25zdHJ1Y3RlZCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKHMuZGVzdHJveWVkKSB7CiAgICAgICAgc3RyZWFtLmVtaXQoa0Rlc3Ryb3ksIGVycik7CiAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgZXJyb3JPckRlc3Ryb3koc3RyZWFtLCBlcnIsIHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdENvbnN0cnVjdE5ULCBzdHJlYW0pOwogICAgICB9CiAgICB9CiAgICB0cnkgewogICAgICBzdHJlYW0uX2NvbnN0cnVjdChlcnIgPT4gewogICAgICAgIHByb2Nlc3MubmV4dFRpY2sob25Db25zdHJ1Y3QsIGVycik7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2sob25Db25zdHJ1Y3QsIGVycik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVtaXRDb25zdHJ1Y3ROVChzdHJlYW0pIHsKICAgIHN0cmVhbS5lbWl0KGtDb25zdHJ1Y3QpOwogIH0KICBmdW5jdGlvbiBpc1JlcXVlc3Qoc3RyZWFtKSB7CiAgICByZXR1cm4gKHN0cmVhbSA9PT0gbnVsbCB8fCBzdHJlYW0gPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHN0cmVhbS5zZXRIZWFkZXIpICYmIHR5cGVvZiBzdHJlYW0uYWJvcnQgPT09ICdmdW5jdGlvbic7CiAgfQogIGZ1bmN0aW9uIGVtaXRDbG9zZUxlZ2FjeShzdHJlYW0pIHsKICAgIHN0cmVhbS5lbWl0KCdjbG9zZScpOwogIH0KICBmdW5jdGlvbiBlbWl0RXJyb3JDbG9zZUxlZ2FjeShzdHJlYW0sIGVycikgewogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdENsb3NlTGVnYWN5LCBzdHJlYW0pOwogIH0KCiAgLy8gTm9ybWFsaXplIGRlc3Ryb3kgZm9yIGxlZ2FjeS4KICBmdW5jdGlvbiBkZXN0cm95ZXIoc3RyZWFtLCBlcnIpIHsKICAgIGlmICghc3RyZWFtIHx8IGlzRGVzdHJveWVkKHN0cmVhbSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFlcnIgJiYgIWlzRmluaXNoZWQoc3RyZWFtKSkgewogICAgICBlcnIgPSBuZXcgQWJvcnRFcnJvcigpOwogICAgfQoKICAgIC8vIFRPRE86IFJlbW92ZSBpc1JlcXVlc3QgYnJhbmNoZXMuCiAgICBpZiAoaXNTZXJ2ZXJSZXF1ZXN0KHN0cmVhbSkpIHsKICAgICAgc3RyZWFtLnNvY2tldCA9IG51bGw7CiAgICAgIHN0cmVhbS5kZXN0cm95KGVycik7CiAgICB9IGVsc2UgaWYgKGlzUmVxdWVzdChzdHJlYW0pKSB7CiAgICAgIHN0cmVhbS5hYm9ydCgpOwogICAgfSBlbHNlIGlmIChpc1JlcXVlc3Qoc3RyZWFtLnJlcSkpIHsKICAgICAgc3RyZWFtLnJlcS5hYm9ydCgpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyZWFtLmRlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHsKICAgICAgc3RyZWFtLmRlc3Ryb3koZXJyKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmVhbS5jbG9zZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAvLyBUT0RPOiBEb24ndCBsb3NlIGVycj8KICAgICAgc3RyZWFtLmNsb3NlKCk7CiAgICB9IGVsc2UgaWYgKGVycikgewogICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRFcnJvckNsb3NlTGVnYWN5LCBzdHJlYW0sIGVycik7CiAgICB9IGVsc2UgewogICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRDbG9zZUxlZ2FjeSwgc3RyZWFtKTsKICAgIH0KICAgIGlmICghc3RyZWFtLmRlc3Ryb3llZCkgewogICAgICBzdHJlYW1ba0lzRGVzdHJveWVkXSA9IHRydWU7CiAgICB9CiAgfQogIGRlc3Ryb3lfMSA9IHsKICAgIGNvbnN0cnVjdCwKICAgIGRlc3Ryb3llciwKICAgIGRlc3Ryb3ksCiAgICB1bmRlc3Ryb3ksCiAgICBlcnJvck9yRGVzdHJveQogIH07CiAgcmV0dXJuIGRlc3Ryb3lfMTsKfQoKZnVuY3Rpb24gX3R5cGVvZihvKSB7CiAgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsKCiAgcmV0dXJuIF90eXBlb2YgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA/IGZ1bmN0aW9uIChvKSB7CiAgICByZXR1cm4gdHlwZW9mIG87CiAgfSA6IGZ1bmN0aW9uIChvKSB7CiAgICByZXR1cm4gbyAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgby5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG8gIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvOwogIH0sIF90eXBlb2Yobyk7Cn0KCmZ1bmN0aW9uIHRvUHJpbWl0aXZlKHQsIHIpIHsKICBpZiAoIm9iamVjdCIgIT0gX3R5cGVvZih0KSB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgciB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YoaSkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gciA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KCmZ1bmN0aW9uIHRvUHJvcGVydHlLZXkodCkgewogIHZhciBpID0gdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSBfdHlwZW9mKGkpID8gaSA6IGkgKyAiIjsKfQoKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KGUsIHIsIHQpIHsKICByZXR1cm4gKHIgPSB0b1Byb3BlcnR5S2V5KHIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIHsKICAgIHZhbHVlOiB0LAogICAgZW51bWVyYWJsZTogITAsCiAgICBjb25maWd1cmFibGU6ICEwLAogICAgd3JpdGFibGU6ICEwCiAgfSkgOiBlW3JdID0gdCwgZTsKfQoKdmFyIGxlZ2FjeTsKdmFyIGhhc1JlcXVpcmVkTGVnYWN5OwpmdW5jdGlvbiByZXF1aXJlTGVnYWN5KCkgewogIGlmIChoYXNSZXF1aXJlZExlZ2FjeSkgcmV0dXJuIGxlZ2FjeTsKICBoYXNSZXF1aXJlZExlZ2FjeSA9IDE7CiAgY29uc3QgewogICAgQXJyYXlJc0FycmF5LAogICAgT2JqZWN0U2V0UHJvdG90eXBlT2YKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgY29uc3QgewogICAgRXZlbnRFbWl0dGVyOiBFRQogIH0gPSByZXF1aXJlJCQwJDI7CiAgZnVuY3Rpb24gU3RyZWFtKG9wdHMpIHsKICAgIEVFLmNhbGwodGhpcywgb3B0cyk7CiAgfQogIE9iamVjdFNldFByb3RvdHlwZU9mKFN0cmVhbS5wcm90b3R5cGUsIEVFLnByb3RvdHlwZSk7CiAgT2JqZWN0U2V0UHJvdG90eXBlT2YoU3RyZWFtLCBFRSk7CiAgU3RyZWFtLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24gKGRlc3QsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHNvdXJjZSA9IHRoaXM7CiAgICBmdW5jdGlvbiBvbmRhdGEoY2h1bmspIHsKICAgICAgaWYgKGRlc3Qud3JpdGFibGUgJiYgZGVzdC53cml0ZShjaHVuaykgPT09IGZhbHNlICYmIHNvdXJjZS5wYXVzZSkgewogICAgICAgIHNvdXJjZS5wYXVzZSgpOwogICAgICB9CiAgICB9CiAgICBzb3VyY2Uub24oJ2RhdGEnLCBvbmRhdGEpOwogICAgZnVuY3Rpb24gb25kcmFpbigpIHsKICAgICAgaWYgKHNvdXJjZS5yZWFkYWJsZSAmJiBzb3VyY2UucmVzdW1lKSB7CiAgICAgICAgc291cmNlLnJlc3VtZSgpOwogICAgICB9CiAgICB9CiAgICBkZXN0Lm9uKCdkcmFpbicsIG9uZHJhaW4pOwoKICAgIC8vIElmIHRoZSAnZW5kJyBvcHRpb24gaXMgbm90IHN1cHBsaWVkLCBkZXN0LmVuZCgpIHdpbGwgYmUgY2FsbGVkIHdoZW4KICAgIC8vIHNvdXJjZSBnZXRzIHRoZSAnZW5kJyBvciAnY2xvc2UnIGV2ZW50cy4gIE9ubHkgZGVzdC5lbmQoKSBvbmNlLgogICAgaWYgKCFkZXN0Ll9pc1N0ZGlvICYmICghb3B0aW9ucyB8fCBvcHRpb25zLmVuZCAhPT0gZmFsc2UpKSB7CiAgICAgIHNvdXJjZS5vbignZW5kJywgb25lbmQpOwogICAgICBzb3VyY2Uub24oJ2Nsb3NlJywgb25jbG9zZSk7CiAgICB9CiAgICBsZXQgZGlkT25FbmQgPSBmYWxzZTsKICAgIGZ1bmN0aW9uIG9uZW5kKCkgewogICAgICBpZiAoZGlkT25FbmQpIHJldHVybjsKICAgICAgZGlkT25FbmQgPSB0cnVlOwogICAgICBkZXN0LmVuZCgpOwogICAgfQogICAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgICAgaWYgKGRpZE9uRW5kKSByZXR1cm47CiAgICAgIGRpZE9uRW5kID0gdHJ1ZTsKICAgICAgaWYgKHR5cGVvZiBkZXN0LmRlc3Ryb3kgPT09ICdmdW5jdGlvbicpIGRlc3QuZGVzdHJveSgpOwogICAgfQoKICAgIC8vIERvbid0IGxlYXZlIGRhbmdsaW5nIHBpcGVzIHdoZW4gdGhlcmUgYXJlIGVycm9ycy4KICAgIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgICAgY2xlYW51cCgpOwogICAgICBpZiAoRUUubGlzdGVuZXJDb3VudCh0aGlzLCAnZXJyb3InKSA9PT0gMCkgewogICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcik7CiAgICAgIH0KICAgIH0KICAgIHByZXBlbmRMaXN0ZW5lcihzb3VyY2UsICdlcnJvcicsIG9uZXJyb3IpOwogICAgcHJlcGVuZExpc3RlbmVyKGRlc3QsICdlcnJvcicsIG9uZXJyb3IpOwoKICAgIC8vIFJlbW92ZSBhbGwgdGhlIGV2ZW50IGxpc3RlbmVycyB0aGF0IHdlcmUgYWRkZWQuCiAgICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwogICAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdkcmFpbicsIG9uZHJhaW4pOwogICAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgICAgc291cmNlLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpOwogICAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignZW5kJywgY2xlYW51cCk7CiAgICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBjbGVhbnVwKTsKICAgICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBjbGVhbnVwKTsKICAgIH0KICAgIHNvdXJjZS5vbignZW5kJywgY2xlYW51cCk7CiAgICBzb3VyY2Uub24oJ2Nsb3NlJywgY2xlYW51cCk7CiAgICBkZXN0Lm9uKCdjbG9zZScsIGNsZWFudXApOwogICAgZGVzdC5lbWl0KCdwaXBlJywgc291cmNlKTsKCiAgICAvLyBBbGxvdyBmb3IgdW5peC1saWtlIHVzYWdlOiBBLnBpcGUoQikucGlwZShDKQogICAgcmV0dXJuIGRlc3Q7CiAgfTsKICBmdW5jdGlvbiBwcmVwZW5kTGlzdGVuZXIoZW1pdHRlciwgZXZlbnQsIGZuKSB7CiAgICAvLyBTYWRseSB0aGlzIGlzIG5vdCBjYWNoZWFibGUgYXMgc29tZSBsaWJyYXJpZXMgYnVuZGxlIHRoZWlyIG93bgogICAgLy8gZXZlbnQgZW1pdHRlciBpbXBsZW1lbnRhdGlvbiB3aXRoIHRoZW0uCiAgICBpZiAodHlwZW9mIGVtaXR0ZXIucHJlcGVuZExpc3RlbmVyID09PSAnZnVuY3Rpb24nKSByZXR1cm4gZW1pdHRlci5wcmVwZW5kTGlzdGVuZXIoZXZlbnQsIGZuKTsKCiAgICAvLyBUaGlzIGlzIGEgaGFjayB0byBtYWtlIHN1cmUgdGhhdCBvdXIgZXJyb3IgaGFuZGxlciBpcyBhdHRhY2hlZCBiZWZvcmUgYW55CiAgICAvLyB1c2VybGFuZCBvbmVzLiAgTkVWRVIgRE8gVEhJUy4gVGhpcyBpcyBoZXJlIG9ubHkgYmVjYXVzZSB0aGlzIGNvZGUgbmVlZHMKICAgIC8vIHRvIGNvbnRpbnVlIHRvIHdvcmsgd2l0aCBvbGRlciB2ZXJzaW9ucyBvZiBOb2RlLmpzIHRoYXQgZG8gbm90IGluY2x1ZGUKICAgIC8vIHRoZSBwcmVwZW5kTGlzdGVuZXIoKSBtZXRob2QuIFRoZSBnb2FsIGlzIHRvIGV2ZW50dWFsbHkgcmVtb3ZlIHRoaXMgaGFjay4KICAgIGlmICghZW1pdHRlci5fZXZlbnRzIHx8ICFlbWl0dGVyLl9ldmVudHNbZXZlbnRdKSBlbWl0dGVyLm9uKGV2ZW50LCBmbik7ZWxzZSBpZiAoQXJyYXlJc0FycmF5KGVtaXR0ZXIuX2V2ZW50c1tldmVudF0pKSBlbWl0dGVyLl9ldmVudHNbZXZlbnRdLnVuc2hpZnQoZm4pO2Vsc2UgZW1pdHRlci5fZXZlbnRzW2V2ZW50XSA9IFtmbiwgZW1pdHRlci5fZXZlbnRzW2V2ZW50XV07CiAgfQogIGxlZ2FjeSA9IHsKICAgIFN0cmVhbSwKICAgIHByZXBlbmRMaXN0ZW5lcgogIH07CiAgcmV0dXJuIGxlZ2FjeTsKfQoKdmFyIGFkZEFib3J0U2lnbmFsID0ge2V4cG9ydHM6IHt9fTsKCnZhciBoYXNSZXF1aXJlZEFkZEFib3J0U2lnbmFsOwpmdW5jdGlvbiByZXF1aXJlQWRkQWJvcnRTaWduYWwoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQWRkQWJvcnRTaWduYWwpIHJldHVybiBhZGRBYm9ydFNpZ25hbC5leHBvcnRzOwogIGhhc1JlcXVpcmVkQWRkQWJvcnRTaWduYWwgPSAxOwogIChmdW5jdGlvbiAobW9kdWxlKSB7CgogICAgY29uc3QgewogICAgICBTeW1ib2xEaXNwb3NlCiAgICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgICBjb25zdCB7CiAgICAgIEFib3J0RXJyb3IsCiAgICAgIGNvZGVzCiAgICB9ID0gcmVxdWlyZUVycm9ycygpOwogICAgY29uc3QgewogICAgICBpc05vZGVTdHJlYW0sCiAgICAgIGlzV2ViU3RyZWFtLAogICAgICBrQ29udHJvbGxlckVycm9yRnVuY3Rpb24KICAgIH0gPSByZXF1aXJlVXRpbHMkMSgpOwogICAgY29uc3QgZW9zID0gcmVxdWlyZUVuZE9mU3RyZWFtKCk7CiAgICBjb25zdCB7CiAgICAgIEVSUl9JTlZBTElEX0FSR19UWVBFCiAgICB9ID0gY29kZXM7CiAgICBsZXQgYWRkQWJvcnRMaXN0ZW5lcjsKCiAgICAvLyBUaGlzIG1ldGhvZCBpcyBpbmxpbmVkIGhlcmUgZm9yIHJlYWRhYmxlLXN0cmVhbQogICAgLy8gSXQgYWxzbyBkb2VzIG5vdCBhbGxvdyBmb3Igc2lnbmFsIHRvIG5vdCBleGlzdCBvbiB0aGUgc3RyZWFtCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvcHVsbC8zNjA2MSNkaXNjdXNzaW9uX3I1MzM3MTgwMjkKICAgIGNvbnN0IHZhbGlkYXRlQWJvcnRTaWduYWwgPSAoc2lnbmFsLCBuYW1lKSA9PiB7CiAgICAgIGlmICh0eXBlb2Ygc2lnbmFsICE9PSAnb2JqZWN0JyB8fCAhKCdhYm9ydGVkJyBpbiBzaWduYWwpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsICdBYm9ydFNpZ25hbCcsIHNpZ25hbCk7CiAgICAgIH0KICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cy5hZGRBYm9ydFNpZ25hbCA9IGZ1bmN0aW9uIGFkZEFib3J0U2lnbmFsKHNpZ25hbCwgc3RyZWFtKSB7CiAgICAgIHZhbGlkYXRlQWJvcnRTaWduYWwoc2lnbmFsLCAnc2lnbmFsJyk7CiAgICAgIGlmICghaXNOb2RlU3RyZWFtKHN0cmVhbSkgJiYgIWlzV2ViU3RyZWFtKHN0cmVhbSkpIHsKICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ3N0cmVhbScsIFsnUmVhZGFibGVTdHJlYW0nLCAnV3JpdGFibGVTdHJlYW0nLCAnU3RyZWFtJ10sIHN0cmVhbSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vZHVsZS5leHBvcnRzLmFkZEFib3J0U2lnbmFsTm9WYWxpZGF0ZShzaWduYWwsIHN0cmVhbSk7CiAgICB9OwogICAgbW9kdWxlLmV4cG9ydHMuYWRkQWJvcnRTaWduYWxOb1ZhbGlkYXRlID0gZnVuY3Rpb24gKHNpZ25hbCwgc3RyZWFtKSB7CiAgICAgIGlmICh0eXBlb2Ygc2lnbmFsICE9PSAnb2JqZWN0JyB8fCAhKCdhYm9ydGVkJyBpbiBzaWduYWwpKSB7CiAgICAgICAgcmV0dXJuIHN0cmVhbTsKICAgICAgfQogICAgICBjb25zdCBvbkFib3J0ID0gaXNOb2RlU3RyZWFtKHN0cmVhbSkgPyAoKSA9PiB7CiAgICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEFib3J0RXJyb3IodW5kZWZpbmVkLCB7CiAgICAgICAgICBjYXVzZTogc2lnbmFsLnJlYXNvbgogICAgICAgIH0pKTsKICAgICAgfSA6ICgpID0+IHsKICAgICAgICBzdHJlYW1ba0NvbnRyb2xsZXJFcnJvckZ1bmN0aW9uXShuZXcgQWJvcnRFcnJvcih1bmRlZmluZWQsIHsKICAgICAgICAgIGNhdXNlOiBzaWduYWwucmVhc29uCiAgICAgICAgfSkpOwogICAgICB9OwogICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICBvbkFib3J0KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWRkQWJvcnRMaXN0ZW5lciA9IGFkZEFib3J0TGlzdGVuZXIgfHwgcmVxdWlyZVV0aWwkMSgpLmFkZEFib3J0TGlzdGVuZXI7CiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IGFkZEFib3J0TGlzdGVuZXIoc2lnbmFsLCBvbkFib3J0KTsKICAgICAgICBlb3Moc3RyZWFtLCBkaXNwb3NhYmxlW1N5bWJvbERpc3Bvc2VdKTsKICAgICAgfQogICAgICByZXR1cm4gc3RyZWFtOwogICAgfTsKICB9KShhZGRBYm9ydFNpZ25hbCk7CiAgcmV0dXJuIGFkZEFib3J0U2lnbmFsLmV4cG9ydHM7Cn0KCmZ1bmN0aW9uIG93bktleXMkOShlLCByKSB7IHZhciB0ID0gT2JqZWN0LmtleXMoZSk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsgciAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uIChyKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIpLmVudW1lcmFibGU7IH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOyB9IHJldHVybiB0OyB9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQkOShlKSB7IGZvciAodmFyIHIgPSAxOyByIDwgYXJndW1lbnRzLmxlbmd0aDsgcisrKSB7IHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcl0gPyBhcmd1bWVudHNbcl0gOiB7fTsgciAlIDIgPyBvd25LZXlzJDkoT2JqZWN0KHQpLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBfZGVmaW5lUHJvcGVydHkoZSwgciwgdFtyXSk7IH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzJDkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIpKTsgfSk7IH0gcmV0dXJuIGU7IH0KdmFyIGJ1ZmZlcl9saXN0Owp2YXIgaGFzUmVxdWlyZWRCdWZmZXJfbGlzdDsKZnVuY3Rpb24gcmVxdWlyZUJ1ZmZlcl9saXN0KCkgewogIGlmIChoYXNSZXF1aXJlZEJ1ZmZlcl9saXN0KSByZXR1cm4gYnVmZmVyX2xpc3Q7CiAgaGFzUmVxdWlyZWRCdWZmZXJfbGlzdCA9IDE7CiAgY29uc3QgewogICAgU3RyaW5nUHJvdG90eXBlU2xpY2UsCiAgICBTeW1ib2xJdGVyYXRvciwKICAgIFR5cGVkQXJyYXlQcm90b3R5cGVTZXQsCiAgICBVaW50OEFycmF5CiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwogIGNvbnN0IHsKICAgIEJ1ZmZlcgogIH0gPSByZXF1aXJlJCQwJDM7CiAgY29uc3QgewogICAgaW5zcGVjdAogIH0gPSByZXF1aXJlVXRpbCQxKCk7CiAgYnVmZmVyX2xpc3QgPSBjbGFzcyBCdWZmZXJMaXN0IHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLmhlYWQgPSBudWxsOwogICAgICB0aGlzLnRhaWwgPSBudWxsOwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICB9CiAgICBwdXNoKHYpIHsKICAgICAgY29uc3QgZW50cnkgPSB7CiAgICAgICAgZGF0YTogdiwKICAgICAgICBuZXh0OiBudWxsCiAgICAgIH07CiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHRoaXMudGFpbC5uZXh0ID0gZW50cnk7ZWxzZSB0aGlzLmhlYWQgPSBlbnRyeTsKICAgICAgdGhpcy50YWlsID0gZW50cnk7CiAgICAgICsrdGhpcy5sZW5ndGg7CiAgICB9CiAgICB1bnNoaWZ0KHYpIHsKICAgICAgY29uc3QgZW50cnkgPSB7CiAgICAgICAgZGF0YTogdiwKICAgICAgICBuZXh0OiB0aGlzLmhlYWQKICAgICAgfTsKICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSB0aGlzLnRhaWwgPSBlbnRyeTsKICAgICAgdGhpcy5oZWFkID0gZW50cnk7CiAgICAgICsrdGhpcy5sZW5ndGg7CiAgICB9CiAgICBzaGlmdCgpIHsKICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm47CiAgICAgIGNvbnN0IHJldCA9IHRoaXMuaGVhZC5kYXRhOwogICAgICBpZiAodGhpcy5sZW5ndGggPT09IDEpIHRoaXMuaGVhZCA9IHRoaXMudGFpbCA9IG51bGw7ZWxzZSB0aGlzLmhlYWQgPSB0aGlzLmhlYWQubmV4dDsKICAgICAgLS10aGlzLmxlbmd0aDsKICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAgIGNsZWFyKCkgewogICAgICB0aGlzLmhlYWQgPSB0aGlzLnRhaWwgPSBudWxsOwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICB9CiAgICBqb2luKHMpIHsKICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgICAgIGxldCBwID0gdGhpcy5oZWFkOwogICAgICBsZXQgcmV0ID0gJycgKyBwLmRhdGE7CiAgICAgIHdoaWxlICgocCA9IHAubmV4dCkgIT09IG51bGwpIHJldCArPSBzICsgcC5kYXRhOwogICAgICByZXR1cm4gcmV0OwogICAgfQogICAgY29uY2F0KG4pIHsKICAgICAgaWYgKHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gQnVmZmVyLmFsbG9jKDApOwogICAgICBjb25zdCByZXQgPSBCdWZmZXIuYWxsb2NVbnNhZmUobiA+Pj4gMCk7CiAgICAgIGxldCBwID0gdGhpcy5oZWFkOwogICAgICBsZXQgaSA9IDA7CiAgICAgIHdoaWxlIChwKSB7CiAgICAgICAgVHlwZWRBcnJheVByb3RvdHlwZVNldChyZXQsIHAuZGF0YSwgaSk7CiAgICAgICAgaSArPSBwLmRhdGEubGVuZ3RoOwogICAgICAgIHAgPSBwLm5leHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICAvLyBDb25zdW1lcyBhIHNwZWNpZmllZCBhbW91bnQgb2YgYnl0ZXMgb3IgY2hhcmFjdGVycyBmcm9tIHRoZSBidWZmZXJlZCBkYXRhLgogICAgY29uc3VtZShuLCBoYXNTdHJpbmdzKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmhlYWQuZGF0YTsKICAgICAgaWYgKG4gPCBkYXRhLmxlbmd0aCkgewogICAgICAgIC8vIGBzbGljZWAgaXMgdGhlIHNhbWUgZm9yIGJ1ZmZlcnMgYW5kIHN0cmluZ3MuCiAgICAgICAgY29uc3Qgc2xpY2UgPSBkYXRhLnNsaWNlKDAsIG4pOwogICAgICAgIHRoaXMuaGVhZC5kYXRhID0gZGF0YS5zbGljZShuKTsKICAgICAgICByZXR1cm4gc2xpY2U7CiAgICAgIH0KICAgICAgaWYgKG4gPT09IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgLy8gRmlyc3QgY2h1bmsgaXMgYSBwZXJmZWN0IG1hdGNoLgogICAgICAgIHJldHVybiB0aGlzLnNoaWZ0KCk7CiAgICAgIH0KICAgICAgLy8gUmVzdWx0IHNwYW5zIG1vcmUgdGhhbiBvbmUgYnVmZmVyLgogICAgICByZXR1cm4gaGFzU3RyaW5ncyA/IHRoaXMuX2dldFN0cmluZyhuKSA6IHRoaXMuX2dldEJ1ZmZlcihuKTsKICAgIH0KICAgIGZpcnN0KCkgewogICAgICByZXR1cm4gdGhpcy5oZWFkLmRhdGE7CiAgICB9CiAgICAqW1N5bWJvbEl0ZXJhdG9yXSgpIHsKICAgICAgZm9yIChsZXQgcCA9IHRoaXMuaGVhZDsgcDsgcCA9IHAubmV4dCkgewogICAgICAgIHlpZWxkIHAuZGF0YTsKICAgICAgfQogICAgfQoKICAgIC8vIENvbnN1bWVzIGEgc3BlY2lmaWVkIGFtb3VudCBvZiBjaGFyYWN0ZXJzIGZyb20gdGhlIGJ1ZmZlcmVkIGRhdGEuCiAgICBfZ2V0U3RyaW5nKG4pIHsKICAgICAgbGV0IHJldCA9ICcnOwogICAgICBsZXQgcCA9IHRoaXMuaGVhZDsKICAgICAgbGV0IGMgPSAwOwogICAgICBkbyB7CiAgICAgICAgY29uc3Qgc3RyID0gcC5kYXRhOwogICAgICAgIGlmIChuID4gc3RyLmxlbmd0aCkgewogICAgICAgICAgcmV0ICs9IHN0cjsKICAgICAgICAgIG4gLT0gc3RyLmxlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG4gPT09IHN0ci5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0ICs9IHN0cjsKICAgICAgICAgICAgKytjOwogICAgICAgICAgICBpZiAocC5uZXh0KSB0aGlzLmhlYWQgPSBwLm5leHQ7ZWxzZSB0aGlzLmhlYWQgPSB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0ICs9IFN0cmluZ1Byb3RvdHlwZVNsaWNlKHN0ciwgMCwgbik7CiAgICAgICAgICAgIHRoaXMuaGVhZCA9IHA7CiAgICAgICAgICAgIHAuZGF0YSA9IFN0cmluZ1Byb3RvdHlwZVNsaWNlKHN0ciwgbik7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgKytjOwogICAgICB9IHdoaWxlICgocCA9IHAubmV4dCkgIT09IG51bGwpOwogICAgICB0aGlzLmxlbmd0aCAtPSBjOwogICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIC8vIENvbnN1bWVzIGEgc3BlY2lmaWVkIGFtb3VudCBvZiBieXRlcyBmcm9tIHRoZSBidWZmZXJlZCBkYXRhLgogICAgX2dldEJ1ZmZlcihuKSB7CiAgICAgIGNvbnN0IHJldCA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShuKTsKICAgICAgY29uc3QgcmV0TGVuID0gbjsKICAgICAgbGV0IHAgPSB0aGlzLmhlYWQ7CiAgICAgIGxldCBjID0gMDsKICAgICAgZG8gewogICAgICAgIGNvbnN0IGJ1ZiA9IHAuZGF0YTsKICAgICAgICBpZiAobiA+IGJ1Zi5sZW5ndGgpIHsKICAgICAgICAgIFR5cGVkQXJyYXlQcm90b3R5cGVTZXQocmV0LCBidWYsIHJldExlbiAtIG4pOwogICAgICAgICAgbiAtPSBidWYubGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobiA9PT0gYnVmLmxlbmd0aCkgewogICAgICAgICAgICBUeXBlZEFycmF5UHJvdG90eXBlU2V0KHJldCwgYnVmLCByZXRMZW4gLSBuKTsKICAgICAgICAgICAgKytjOwogICAgICAgICAgICBpZiAocC5uZXh0KSB0aGlzLmhlYWQgPSBwLm5leHQ7ZWxzZSB0aGlzLmhlYWQgPSB0aGlzLnRhaWwgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgVHlwZWRBcnJheVByb3RvdHlwZVNldChyZXQsIG5ldyBVaW50OEFycmF5KGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBuKSwgcmV0TGVuIC0gbik7CiAgICAgICAgICAgIHRoaXMuaGVhZCA9IHA7CiAgICAgICAgICAgIHAuZGF0YSA9IGJ1Zi5zbGljZShuKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICArK2M7CiAgICAgIH0gd2hpbGUgKChwID0gcC5uZXh0KSAhPT0gbnVsbCk7CiAgICAgIHRoaXMubGVuZ3RoIC09IGM7CiAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgLy8gTWFrZSBzdXJlIHRoZSBsaW5rZWQgbGlzdCBvbmx5IHNob3dzIHRoZSBtaW5pbWFsIG5lY2Vzc2FyeSBpbmZvcm1hdGlvbi4KICAgIFtTeW1ib2wuZm9yKCdub2RlanMudXRpbC5pbnNwZWN0LmN1c3RvbScpXShfLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBpbnNwZWN0KHRoaXMsIF9vYmplY3RTcHJlYWQkOShfb2JqZWN0U3ByZWFkJDkoe30sIG9wdGlvbnMpLCB7fSwgewogICAgICAgIC8vIE9ubHkgaW5zcGVjdCBvbmUgbGV2ZWwuCiAgICAgICAgZGVwdGg6IDAsCiAgICAgICAgLy8gSXQgc2hvdWxkIG5vdCByZWN1cnNlLgogICAgICAgIGN1c3RvbUluc3BlY3Q6IGZhbHNlCiAgICAgIH0pKTsKICAgIH0KICB9OwogIHJldHVybiBidWZmZXJfbGlzdDsKfQoKdmFyIHN0YXRlOwp2YXIgaGFzUmVxdWlyZWRTdGF0ZTsKZnVuY3Rpb24gcmVxdWlyZVN0YXRlKCkgewogIGlmIChoYXNSZXF1aXJlZFN0YXRlKSByZXR1cm4gc3RhdGU7CiAgaGFzUmVxdWlyZWRTdGF0ZSA9IDE7CiAgY29uc3QgewogICAgTWF0aEZsb29yLAogICAgTnVtYmVySXNJbnRlZ2VyCiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwogIGNvbnN0IHsKICAgIHZhbGlkYXRlSW50ZWdlcgogIH0gPSByZXF1aXJlVmFsaWRhdG9ycygpOwogIGNvbnN0IHsKICAgIEVSUl9JTlZBTElEX0FSR19WQUxVRQogIH0gPSByZXF1aXJlRXJyb3JzKCkuY29kZXM7CiAgbGV0IGRlZmF1bHRIaWdoV2F0ZXJNYXJrQnl0ZXMgPSAxNiAqIDEwMjQ7CiAgbGV0IGRlZmF1bHRIaWdoV2F0ZXJNYXJrT2JqZWN0TW9kZSA9IDE2OwogIGZ1bmN0aW9uIGhpZ2hXYXRlck1hcmtGcm9tKG9wdGlvbnMsIGlzRHVwbGV4LCBkdXBsZXhLZXkpIHsKICAgIHJldHVybiBvcHRpb25zLmhpZ2hXYXRlck1hcmsgIT0gbnVsbCA/IG9wdGlvbnMuaGlnaFdhdGVyTWFyayA6IGlzRHVwbGV4ID8gb3B0aW9uc1tkdXBsZXhLZXldIDogbnVsbDsKICB9CiAgZnVuY3Rpb24gZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsob2JqZWN0TW9kZSkgewogICAgcmV0dXJuIG9iamVjdE1vZGUgPyBkZWZhdWx0SGlnaFdhdGVyTWFya09iamVjdE1vZGUgOiBkZWZhdWx0SGlnaFdhdGVyTWFya0J5dGVzOwogIH0KICBmdW5jdGlvbiBzZXREZWZhdWx0SGlnaFdhdGVyTWFyayhvYmplY3RNb2RlLCB2YWx1ZSkgewogICAgdmFsaWRhdGVJbnRlZ2VyKHZhbHVlLCAndmFsdWUnLCAwKTsKICAgIGlmIChvYmplY3RNb2RlKSB7CiAgICAgIGRlZmF1bHRIaWdoV2F0ZXJNYXJrT2JqZWN0TW9kZSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgZGVmYXVsdEhpZ2hXYXRlck1hcmtCeXRlcyA9IHZhbHVlOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRIaWdoV2F0ZXJNYXJrKHN0YXRlLCBvcHRpb25zLCBkdXBsZXhLZXksIGlzRHVwbGV4KSB7CiAgICBjb25zdCBod20gPSBoaWdoV2F0ZXJNYXJrRnJvbShvcHRpb25zLCBpc0R1cGxleCwgZHVwbGV4S2V5KTsKICAgIGlmIChod20gIT0gbnVsbCkgewogICAgICBpZiAoIU51bWJlcklzSW50ZWdlcihod20pIHx8IGh3bSA8IDApIHsKICAgICAgICBjb25zdCBuYW1lID0gaXNEdXBsZXggPyBgb3B0aW9ucy4ke2R1cGxleEtleX1gIDogJ29wdGlvbnMuaGlnaFdhdGVyTWFyayc7CiAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19WQUxVRShuYW1lLCBod20pOwogICAgICB9CiAgICAgIHJldHVybiBNYXRoRmxvb3IoaHdtKTsKICAgIH0KCiAgICAvLyBEZWZhdWx0IHZhbHVlCiAgICByZXR1cm4gZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsoc3RhdGUub2JqZWN0TW9kZSk7CiAgfQogIHN0YXRlID0gewogICAgZ2V0SGlnaFdhdGVyTWFyaywKICAgIGdldERlZmF1bHRIaWdoV2F0ZXJNYXJrLAogICAgc2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsKICB9OwogIHJldHVybiBzdGF0ZTsKfQoKdmFyIHN0cmluZ19kZWNvZGVyID0ge307Cgp2YXIgc2FmZUJ1ZmZlciA9IHtleHBvcnRzOiB7fX07CgovKiEgc2FmZS1idWZmZXIuIE1JVCBMaWNlbnNlLiBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwczovL2Zlcm9zcy5vcmcvb3BlbnNvdXJjZT4gKi8KdmFyIGhhc1JlcXVpcmVkU2FmZUJ1ZmZlcjsKZnVuY3Rpb24gcmVxdWlyZVNhZmVCdWZmZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkU2FmZUJ1ZmZlcikgcmV0dXJuIHNhZmVCdWZmZXIuZXhwb3J0czsKICBoYXNSZXF1aXJlZFNhZmVCdWZmZXIgPSAxOwogIChmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAvKiBlc2xpbnQtZGlzYWJsZSBub2RlL25vLWRlcHJlY2F0ZWQtYXBpICovCiAgICB2YXIgYnVmZmVyID0gcmVxdWlyZSQkMCQzOwogICAgdmFyIEJ1ZmZlciA9IGJ1ZmZlci5CdWZmZXI7CgogICAgLy8gYWx0ZXJuYXRpdmUgdG8gdXNpbmcgT2JqZWN0LmtleXMgZm9yIG9sZCBicm93c2VycwogICAgZnVuY3Rpb24gY29weVByb3BzKHNyYywgZHN0KSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgICBpZiAoQnVmZmVyLmZyb20gJiYgQnVmZmVyLmFsbG9jICYmIEJ1ZmZlci5hbGxvY1Vuc2FmZSAmJiBCdWZmZXIuYWxsb2NVbnNhZmVTbG93KSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gYnVmZmVyOwogICAgfSBlbHNlIHsKICAgICAgLy8gQ29weSBwcm9wZXJ0aWVzIGZyb20gcmVxdWlyZSgnYnVmZmVyJykKICAgICAgY29weVByb3BzKGJ1ZmZlciwgZXhwb3J0cyk7CiAgICAgIGV4cG9ydHMuQnVmZmVyID0gU2FmZUJ1ZmZlcjsKICAgIH0KICAgIGZ1bmN0aW9uIFNhZmVCdWZmZXIoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgcmV0dXJuIEJ1ZmZlcihhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCk7CiAgICB9CiAgICBTYWZlQnVmZmVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQnVmZmVyLnByb3RvdHlwZSk7CgogICAgLy8gQ29weSBzdGF0aWMgbWV0aG9kcyBmcm9tIEJ1ZmZlcgogICAgY29weVByb3BzKEJ1ZmZlciwgU2FmZUJ1ZmZlcik7CiAgICBTYWZlQnVmZmVyLmZyb20gPSBmdW5jdGlvbiAoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBub3QgYmUgYSBudW1iZXInKTsKICAgICAgfQogICAgICByZXR1cm4gQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKTsKICAgIH07CiAgICBTYWZlQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgbnVtYmVyJyk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZiA9IEJ1ZmZlcihzaXplKTsKICAgICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWYuZmlsbChmaWxsLCBlbmNvZGluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1Zi5maWxsKGZpbGwpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBidWYuZmlsbCgwKTsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfTsKICAgIFNhZmVCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpOwogICAgICB9CiAgICAgIHJldHVybiBCdWZmZXIoc2l6ZSk7CiAgICB9OwogICAgU2FmZUJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpOwogICAgICB9CiAgICAgIHJldHVybiBidWZmZXIuU2xvd0J1ZmZlcihzaXplKTsKICAgIH07CiAgfSkoc2FmZUJ1ZmZlciwgc2FmZUJ1ZmZlci5leHBvcnRzKTsKICByZXR1cm4gc2FmZUJ1ZmZlci5leHBvcnRzOwp9Cgp2YXIgaGFzUmVxdWlyZWRTdHJpbmdfZGVjb2RlcjsKZnVuY3Rpb24gcmVxdWlyZVN0cmluZ19kZWNvZGVyKCkgewogIGlmIChoYXNSZXF1aXJlZFN0cmluZ19kZWNvZGVyKSByZXR1cm4gc3RyaW5nX2RlY29kZXI7CiAgaGFzUmVxdWlyZWRTdHJpbmdfZGVjb2RlciA9IDE7CgogIC8qPHJlcGxhY2VtZW50PiovCgogIHZhciBCdWZmZXIgPSByZXF1aXJlU2FmZUJ1ZmZlcigpLkJ1ZmZlcjsKICAvKjwvcmVwbGFjZW1lbnQ+Ki8KCiAgdmFyIGlzRW5jb2RpbmcgPSBCdWZmZXIuaXNFbmNvZGluZyB8fCBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgIGVuY29kaW5nID0gJycgKyBlbmNvZGluZzsKICAgIHN3aXRjaCAoZW5jb2RpbmcgJiYgZW5jb2RpbmcudG9Mb3dlckNhc2UoKSkgewogICAgICBjYXNlICdoZXgnOgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICBjYXNlICdhc2NpaSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIGNhc2UgJ3Jhdyc6CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CiAgZnVuY3Rpb24gX25vcm1hbGl6ZUVuY29kaW5nKGVuYykgewogICAgaWYgKCFlbmMpIHJldHVybiAndXRmOCc7CiAgICB2YXIgcmV0cmllZDsKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHN3aXRjaCAoZW5jKSB7CiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgICAgcmV0dXJuICd1dGY4JzsKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuICd1dGYxNmxlJzsKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gJ2xhdGluMSc7CiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBlbmM7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChyZXRyaWVkKSByZXR1cm47IC8vIHVuZGVmaW5lZAogICAgICAgICAgZW5jID0gKCcnICsgZW5jKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0cmllZCA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIERvIG5vdCBjYWNoZSBgQnVmZmVyLmlzRW5jb2RpbmdgIHdoZW4gY2hlY2tpbmcgZW5jb2RpbmcgbmFtZXMgYXMgc29tZQogIC8vIG1vZHVsZXMgbW9ua2V5LXBhdGNoIGl0IHRvIHN1cHBvcnQgYWRkaXRpb25hbCBlbmNvZGluZ3MKICBmdW5jdGlvbiBub3JtYWxpemVFbmNvZGluZyhlbmMpIHsKICAgIHZhciBuZW5jID0gX25vcm1hbGl6ZUVuY29kaW5nKGVuYyk7CiAgICBpZiAodHlwZW9mIG5lbmMgIT09ICdzdHJpbmcnICYmIChCdWZmZXIuaXNFbmNvZGluZyA9PT0gaXNFbmNvZGluZyB8fCAhaXNFbmNvZGluZyhlbmMpKSkgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jKTsKICAgIHJldHVybiBuZW5jIHx8IGVuYzsKICB9CgogIC8vIFN0cmluZ0RlY29kZXIgcHJvdmlkZXMgYW4gaW50ZXJmYWNlIGZvciBlZmZpY2llbnRseSBzcGxpdHRpbmcgYSBzZXJpZXMgb2YKICAvLyBidWZmZXJzIGludG8gYSBzZXJpZXMgb2YgSlMgc3RyaW5ncyB3aXRob3V0IGJyZWFraW5nIGFwYXJ0IG11bHRpLWJ5dGUKICAvLyBjaGFyYWN0ZXJzLgogIHN0cmluZ19kZWNvZGVyLlN0cmluZ0RlY29kZXIgPSBTdHJpbmdEZWNvZGVyOwogIGZ1bmN0aW9uIFN0cmluZ0RlY29kZXIoZW5jb2RpbmcpIHsKICAgIHRoaXMuZW5jb2RpbmcgPSBub3JtYWxpemVFbmNvZGluZyhlbmNvZGluZyk7CiAgICB2YXIgbmI7CiAgICBzd2l0Y2ggKHRoaXMuZW5jb2RpbmcpIHsKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgdGhpcy50ZXh0ID0gdXRmMTZUZXh0OwogICAgICAgIHRoaXMuZW5kID0gdXRmMTZFbmQ7CiAgICAgICAgbmIgPSA0OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICd1dGY4JzoKICAgICAgICB0aGlzLmZpbGxMYXN0ID0gdXRmOEZpbGxMYXN0OwogICAgICAgIG5iID0gNDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICB0aGlzLnRleHQgPSBiYXNlNjRUZXh0OwogICAgICAgIHRoaXMuZW5kID0gYmFzZTY0RW5kOwogICAgICAgIG5iID0gMzsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLndyaXRlID0gc2ltcGxlV3JpdGU7CiAgICAgICAgdGhpcy5lbmQgPSBzaW1wbGVFbmQ7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5sYXN0TmVlZCA9IDA7CiAgICB0aGlzLmxhc3RUb3RhbCA9IDA7CiAgICB0aGlzLmxhc3RDaGFyID0gQnVmZmVyLmFsbG9jVW5zYWZlKG5iKTsKICB9CiAgU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoYnVmKSB7CiAgICBpZiAoYnVmLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnOwogICAgdmFyIHI7CiAgICB2YXIgaTsKICAgIGlmICh0aGlzLmxhc3ROZWVkKSB7CiAgICAgIHIgPSB0aGlzLmZpbGxMYXN0KGJ1Zik7CiAgICAgIGlmIChyID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgaSA9IHRoaXMubGFzdE5lZWQ7CiAgICAgIHRoaXMubGFzdE5lZWQgPSAwOwogICAgfSBlbHNlIHsKICAgICAgaSA9IDA7CiAgICB9CiAgICBpZiAoaSA8IGJ1Zi5sZW5ndGgpIHJldHVybiByID8gciArIHRoaXMudGV4dChidWYsIGkpIDogdGhpcy50ZXh0KGJ1ZiwgaSk7CiAgICByZXR1cm4gciB8fCAnJzsKICB9OwogIFN0cmluZ0RlY29kZXIucHJvdG90eXBlLmVuZCA9IHV0ZjhFbmQ7CgogIC8vIFJldHVybnMgb25seSBjb21wbGV0ZSBjaGFyYWN0ZXJzIGluIGEgQnVmZmVyCiAgU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUudGV4dCA9IHV0ZjhUZXh0OwoKICAvLyBBdHRlbXB0cyB0byBjb21wbGV0ZSBhIHBhcnRpYWwgbm9uLVVURi04IGNoYXJhY3RlciB1c2luZyBieXRlcyBmcm9tIGEgQnVmZmVyCiAgU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUuZmlsbExhc3QgPSBmdW5jdGlvbiAoYnVmKSB7CiAgICBpZiAodGhpcy5sYXN0TmVlZCA8PSBidWYubGVuZ3RoKSB7CiAgICAgIGJ1Zi5jb3B5KHRoaXMubGFzdENoYXIsIHRoaXMubGFzdFRvdGFsIC0gdGhpcy5sYXN0TmVlZCwgMCwgdGhpcy5sYXN0TmVlZCk7CiAgICAgIHJldHVybiB0aGlzLmxhc3RDaGFyLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcsIDAsIHRoaXMubGFzdFRvdGFsKTsKICAgIH0KICAgIGJ1Zi5jb3B5KHRoaXMubGFzdENoYXIsIHRoaXMubGFzdFRvdGFsIC0gdGhpcy5sYXN0TmVlZCwgMCwgYnVmLmxlbmd0aCk7CiAgICB0aGlzLmxhc3ROZWVkIC09IGJ1Zi5sZW5ndGg7CiAgfTsKCiAgLy8gQ2hlY2tzIHRoZSB0eXBlIG9mIGEgVVRGLTggYnl0ZSwgd2hldGhlciBpdCdzIEFTQ0lJLCBhIGxlYWRpbmcgYnl0ZSwgb3IgYQogIC8vIGNvbnRpbnVhdGlvbiBieXRlLiBJZiBhbiBpbnZhbGlkIGJ5dGUgaXMgZGV0ZWN0ZWQsIC0yIGlzIHJldHVybmVkLgogIGZ1bmN0aW9uIHV0ZjhDaGVja0J5dGUoYnl0ZSkgewogICAgaWYgKGJ5dGUgPD0gMHg3RikgcmV0dXJuIDA7ZWxzZSBpZiAoYnl0ZSA+PiA1ID09PSAweDA2KSByZXR1cm4gMjtlbHNlIGlmIChieXRlID4+IDQgPT09IDB4MEUpIHJldHVybiAzO2Vsc2UgaWYgKGJ5dGUgPj4gMyA9PT0gMHgxRSkgcmV0dXJuIDQ7CiAgICByZXR1cm4gYnl0ZSA+PiA2ID09PSAweDAyID8gLTEgOiAtMjsKICB9CgogIC8vIENoZWNrcyBhdCBtb3N0IDMgYnl0ZXMgYXQgdGhlIGVuZCBvZiBhIEJ1ZmZlciBpbiBvcmRlciB0byBkZXRlY3QgYW4KICAvLyBpbmNvbXBsZXRlIG11bHRpLWJ5dGUgVVRGLTggY2hhcmFjdGVyLiBUaGUgdG90YWwgbnVtYmVyIG9mIGJ5dGVzICgyLCAzLCBvciA0KQogIC8vIG5lZWRlZCB0byBjb21wbGV0ZSB0aGUgVVRGLTggY2hhcmFjdGVyIChpZiBhcHBsaWNhYmxlKSBhcmUgcmV0dXJuZWQuCiAgZnVuY3Rpb24gdXRmOENoZWNrSW5jb21wbGV0ZShzZWxmLCBidWYsIGkpIHsKICAgIHZhciBqID0gYnVmLmxlbmd0aCAtIDE7CiAgICBpZiAoaiA8IGkpIHJldHVybiAwOwogICAgdmFyIG5iID0gdXRmOENoZWNrQnl0ZShidWZbal0pOwogICAgaWYgKG5iID49IDApIHsKICAgICAgaWYgKG5iID4gMCkgc2VsZi5sYXN0TmVlZCA9IG5iIC0gMTsKICAgICAgcmV0dXJuIG5iOwogICAgfQogICAgaWYgKC0taiA8IGkgfHwgbmIgPT09IC0yKSByZXR1cm4gMDsKICAgIG5iID0gdXRmOENoZWNrQnl0ZShidWZbal0pOwogICAgaWYgKG5iID49IDApIHsKICAgICAgaWYgKG5iID4gMCkgc2VsZi5sYXN0TmVlZCA9IG5iIC0gMjsKICAgICAgcmV0dXJuIG5iOwogICAgfQogICAgaWYgKC0taiA8IGkgfHwgbmIgPT09IC0yKSByZXR1cm4gMDsKICAgIG5iID0gdXRmOENoZWNrQnl0ZShidWZbal0pOwogICAgaWYgKG5iID49IDApIHsKICAgICAgaWYgKG5iID4gMCkgewogICAgICAgIGlmIChuYiA9PT0gMikgbmIgPSAwO2Vsc2Ugc2VsZi5sYXN0TmVlZCA9IG5iIC0gMzsKICAgICAgfQogICAgICByZXR1cm4gbmI7CiAgICB9CiAgICByZXR1cm4gMDsKICB9CgogIC8vIFZhbGlkYXRlcyBhcyBtYW55IGNvbnRpbnVhdGlvbiBieXRlcyBmb3IgYSBtdWx0aS1ieXRlIFVURi04IGNoYXJhY3RlciBhcwogIC8vIG5lZWRlZCBvciBhcmUgYXZhaWxhYmxlLiBJZiB3ZSBzZWUgYSBub24tY29udGludWF0aW9uIGJ5dGUgd2hlcmUgd2UgZXhwZWN0CiAgLy8gb25lLCB3ZSAicmVwbGFjZSIgdGhlIHZhbGlkYXRlZCBjb250aW51YXRpb24gYnl0ZXMgd2UndmUgc2VlbiBzbyBmYXIgd2l0aAogIC8vIGEgc2luZ2xlIFVURi04IHJlcGxhY2VtZW50IGNoYXJhY3RlciAoJ1x1ZmZmZCcpLCB0byBtYXRjaCB2OCdzIFVURi04IGRlY29kaW5nCiAgLy8gYmVoYXZpb3IuIFRoZSBjb250aW51YXRpb24gYnl0ZSBjaGVjayBpcyBpbmNsdWRlZCB0aHJlZSB0aW1lcyBpbiB0aGUgY2FzZQogIC8vIHdoZXJlIGFsbCBvZiB0aGUgY29udGludWF0aW9uIGJ5dGVzIGZvciBhIGNoYXJhY3RlciBleGlzdCBpbiB0aGUgc2FtZSBidWZmZXIuCiAgLy8gSXQgaXMgYWxzbyBkb25lIHRoaXMgd2F5IGFzIGEgc2xpZ2h0IHBlcmZvcm1hbmNlIGluY3JlYXNlIGluc3RlYWQgb2YgdXNpbmcgYQogIC8vIGxvb3AuCiAgZnVuY3Rpb24gdXRmOENoZWNrRXh0cmFCeXRlcyhzZWxmLCBidWYsIHApIHsKICAgIGlmICgoYnVmWzBdICYgMHhDMCkgIT09IDB4ODApIHsKICAgICAgc2VsZi5sYXN0TmVlZCA9IDA7CiAgICAgIHJldHVybiAnXHVmZmZkJzsKICAgIH0KICAgIGlmIChzZWxmLmxhc3ROZWVkID4gMSAmJiBidWYubGVuZ3RoID4gMSkgewogICAgICBpZiAoKGJ1ZlsxXSAmIDB4QzApICE9PSAweDgwKSB7CiAgICAgICAgc2VsZi5sYXN0TmVlZCA9IDE7CiAgICAgICAgcmV0dXJuICdcdWZmZmQnOwogICAgICB9CiAgICAgIGlmIChzZWxmLmxhc3ROZWVkID4gMiAmJiBidWYubGVuZ3RoID4gMikgewogICAgICAgIGlmICgoYnVmWzJdICYgMHhDMCkgIT09IDB4ODApIHsKICAgICAgICAgIHNlbGYubGFzdE5lZWQgPSAyOwogICAgICAgICAgcmV0dXJuICdcdWZmZmQnOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgLy8gQXR0ZW1wdHMgdG8gY29tcGxldGUgYSBtdWx0aS1ieXRlIFVURi04IGNoYXJhY3RlciB1c2luZyBieXRlcyBmcm9tIGEgQnVmZmVyLgogIGZ1bmN0aW9uIHV0ZjhGaWxsTGFzdChidWYpIHsKICAgIHZhciBwID0gdGhpcy5sYXN0VG90YWwgLSB0aGlzLmxhc3ROZWVkOwogICAgdmFyIHIgPSB1dGY4Q2hlY2tFeHRyYUJ5dGVzKHRoaXMsIGJ1Zik7CiAgICBpZiAociAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcjsKICAgIGlmICh0aGlzLmxhc3ROZWVkIDw9IGJ1Zi5sZW5ndGgpIHsKICAgICAgYnVmLmNvcHkodGhpcy5sYXN0Q2hhciwgcCwgMCwgdGhpcy5sYXN0TmVlZCk7CiAgICAgIHJldHVybiB0aGlzLmxhc3RDaGFyLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcsIDAsIHRoaXMubGFzdFRvdGFsKTsKICAgIH0KICAgIGJ1Zi5jb3B5KHRoaXMubGFzdENoYXIsIHAsIDAsIGJ1Zi5sZW5ndGgpOwogICAgdGhpcy5sYXN0TmVlZCAtPSBidWYubGVuZ3RoOwogIH0KCiAgLy8gUmV0dXJucyBhbGwgY29tcGxldGUgVVRGLTggY2hhcmFjdGVycyBpbiBhIEJ1ZmZlci4gSWYgdGhlIEJ1ZmZlciBlbmRlZCBvbiBhCiAgLy8gcGFydGlhbCBjaGFyYWN0ZXIsIHRoZSBjaGFyYWN0ZXIncyBieXRlcyBhcmUgYnVmZmVyZWQgdW50aWwgdGhlIHJlcXVpcmVkCiAgLy8gbnVtYmVyIG9mIGJ5dGVzIGFyZSBhdmFpbGFibGUuCiAgZnVuY3Rpb24gdXRmOFRleHQoYnVmLCBpKSB7CiAgICB2YXIgdG90YWwgPSB1dGY4Q2hlY2tJbmNvbXBsZXRlKHRoaXMsIGJ1ZiwgaSk7CiAgICBpZiAoIXRoaXMubGFzdE5lZWQpIHJldHVybiBidWYudG9TdHJpbmcoJ3V0ZjgnLCBpKTsKICAgIHRoaXMubGFzdFRvdGFsID0gdG90YWw7CiAgICB2YXIgZW5kID0gYnVmLmxlbmd0aCAtICh0b3RhbCAtIHRoaXMubGFzdE5lZWQpOwogICAgYnVmLmNvcHkodGhpcy5sYXN0Q2hhciwgMCwgZW5kKTsKICAgIHJldHVybiBidWYudG9TdHJpbmcoJ3V0ZjgnLCBpLCBlbmQpOwogIH0KCiAgLy8gRm9yIFVURi04LCBhIHJlcGxhY2VtZW50IGNoYXJhY3RlciBpcyBhZGRlZCB3aGVuIGVuZGluZyBvbiBhIHBhcnRpYWwKICAvLyBjaGFyYWN0ZXIuCiAgZnVuY3Rpb24gdXRmOEVuZChidWYpIHsKICAgIHZhciByID0gYnVmICYmIGJ1Zi5sZW5ndGggPyB0aGlzLndyaXRlKGJ1ZikgOiAnJzsKICAgIGlmICh0aGlzLmxhc3ROZWVkKSByZXR1cm4gciArICdcdWZmZmQnOwogICAgcmV0dXJuIHI7CiAgfQoKICAvLyBVVEYtMTZMRSB0eXBpY2FsbHkgbmVlZHMgdHdvIGJ5dGVzIHBlciBjaGFyYWN0ZXIsIGJ1dCBldmVuIGlmIHdlIGhhdmUgYW4gZXZlbgogIC8vIG51bWJlciBvZiBieXRlcyBhdmFpbGFibGUsIHdlIG5lZWQgdG8gY2hlY2sgaWYgd2UgZW5kIG9uIGEgbGVhZGluZy9oaWdoCiAgLy8gc3Vycm9nYXRlLiBJbiB0aGF0IGNhc2UsIHdlIG5lZWQgdG8gd2FpdCBmb3IgdGhlIG5leHQgdHdvIGJ5dGVzIGluIG9yZGVyIHRvCiAgLy8gZGVjb2RlIHRoZSBsYXN0IGNoYXJhY3RlciBwcm9wZXJseS4KICBmdW5jdGlvbiB1dGYxNlRleHQoYnVmLCBpKSB7CiAgICBpZiAoKGJ1Zi5sZW5ndGggLSBpKSAlIDIgPT09IDApIHsKICAgICAgdmFyIHIgPSBidWYudG9TdHJpbmcoJ3V0ZjE2bGUnLCBpKTsKICAgICAgaWYgKHIpIHsKICAgICAgICB2YXIgYyA9IHIuY2hhckNvZGVBdChyLmxlbmd0aCAtIDEpOwogICAgICAgIGlmIChjID49IDB4RDgwMCAmJiBjIDw9IDB4REJGRikgewogICAgICAgICAgdGhpcy5sYXN0TmVlZCA9IDI7CiAgICAgICAgICB0aGlzLmxhc3RUb3RhbCA9IDQ7CiAgICAgICAgICB0aGlzLmxhc3RDaGFyWzBdID0gYnVmW2J1Zi5sZW5ndGggLSAyXTsKICAgICAgICAgIHRoaXMubGFzdENoYXJbMV0gPSBidWZbYnVmLmxlbmd0aCAtIDFdOwogICAgICAgICAgcmV0dXJuIHIuc2xpY2UoMCwgLTEpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcjsKICAgIH0KICAgIHRoaXMubGFzdE5lZWQgPSAxOwogICAgdGhpcy5sYXN0VG90YWwgPSAyOwogICAgdGhpcy5sYXN0Q2hhclswXSA9IGJ1ZltidWYubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gYnVmLnRvU3RyaW5nKCd1dGYxNmxlJywgaSwgYnVmLmxlbmd0aCAtIDEpOwogIH0KCiAgLy8gRm9yIFVURi0xNkxFIHdlIGRvIG5vdCBleHBsaWNpdGx5IGFwcGVuZCBzcGVjaWFsIHJlcGxhY2VtZW50IGNoYXJhY3RlcnMgaWYgd2UKICAvLyBlbmQgb24gYSBwYXJ0aWFsIGNoYXJhY3Rlciwgd2Ugc2ltcGx5IGxldCB2OCBoYW5kbGUgdGhhdC4KICBmdW5jdGlvbiB1dGYxNkVuZChidWYpIHsKICAgIHZhciByID0gYnVmICYmIGJ1Zi5sZW5ndGggPyB0aGlzLndyaXRlKGJ1ZikgOiAnJzsKICAgIGlmICh0aGlzLmxhc3ROZWVkKSB7CiAgICAgIHZhciBlbmQgPSB0aGlzLmxhc3RUb3RhbCAtIHRoaXMubGFzdE5lZWQ7CiAgICAgIHJldHVybiByICsgdGhpcy5sYXN0Q2hhci50b1N0cmluZygndXRmMTZsZScsIDAsIGVuZCk7CiAgICB9CiAgICByZXR1cm4gcjsKICB9CiAgZnVuY3Rpb24gYmFzZTY0VGV4dChidWYsIGkpIHsKICAgIHZhciBuID0gKGJ1Zi5sZW5ndGggLSBpKSAlIDM7CiAgICBpZiAobiA9PT0gMCkgcmV0dXJuIGJ1Zi50b1N0cmluZygnYmFzZTY0JywgaSk7CiAgICB0aGlzLmxhc3ROZWVkID0gMyAtIG47CiAgICB0aGlzLmxhc3RUb3RhbCA9IDM7CiAgICBpZiAobiA9PT0gMSkgewogICAgICB0aGlzLmxhc3RDaGFyWzBdID0gYnVmW2J1Zi5sZW5ndGggLSAxXTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubGFzdENoYXJbMF0gPSBidWZbYnVmLmxlbmd0aCAtIDJdOwogICAgICB0aGlzLmxhc3RDaGFyWzFdID0gYnVmW2J1Zi5sZW5ndGggLSAxXTsKICAgIH0KICAgIHJldHVybiBidWYudG9TdHJpbmcoJ2Jhc2U2NCcsIGksIGJ1Zi5sZW5ndGggLSBuKTsKICB9CiAgZnVuY3Rpb24gYmFzZTY0RW5kKGJ1ZikgewogICAgdmFyIHIgPSBidWYgJiYgYnVmLmxlbmd0aCA/IHRoaXMud3JpdGUoYnVmKSA6ICcnOwogICAgaWYgKHRoaXMubGFzdE5lZWQpIHJldHVybiByICsgdGhpcy5sYXN0Q2hhci50b1N0cmluZygnYmFzZTY0JywgMCwgMyAtIHRoaXMubGFzdE5lZWQpOwogICAgcmV0dXJuIHI7CiAgfQoKICAvLyBQYXNzIGJ5dGVzIG9uIHRocm91Z2ggZm9yIHNpbmdsZS1ieXRlIGVuY29kaW5ncyAoZS5nLiBhc2NpaSwgbGF0aW4xLCBoZXgpCiAgZnVuY3Rpb24gc2ltcGxlV3JpdGUoYnVmKSB7CiAgICByZXR1cm4gYnVmLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcpOwogIH0KICBmdW5jdGlvbiBzaW1wbGVFbmQoYnVmKSB7CiAgICByZXR1cm4gYnVmICYmIGJ1Zi5sZW5ndGggPyB0aGlzLndyaXRlKGJ1ZikgOiAnJzsKICB9CiAgcmV0dXJuIHN0cmluZ19kZWNvZGVyOwp9CgpmdW5jdGlvbiBvd25LZXlzJDgoZSwgcikgeyB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7IHIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbiAocikgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByKS5lbnVtZXJhYmxlOyB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsgfSByZXR1cm4gdDsgfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkJDgoZSkgeyBmb3IgKHZhciByID0gMTsgciA8IGFyZ3VtZW50cy5sZW5ndGg7IHIrKykgeyB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3JdID8gYXJndW1lbnRzW3JdIDoge307IHIgJSAyID8gb3duS2V5cyQ4KE9iamVjdCh0KSwgITApLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgX2RlZmluZVByb3BlcnR5KGUsIHIsIHRbcl0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyQ4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgciwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByKSk7IH0pOyB9IHJldHVybiBlOyB9CnZhciBmcm9tXzE7CnZhciBoYXNSZXF1aXJlZEZyb207CmZ1bmN0aW9uIHJlcXVpcmVGcm9tKCkgewogIGlmIChoYXNSZXF1aXJlZEZyb20pIHJldHVybiBmcm9tXzE7CiAgaGFzUmVxdWlyZWRGcm9tID0gMTsKCiAgLyogcmVwbGFjZW1lbnQgc3RhcnQgKi8KCiAgY29uc3QgcHJvY2VzcyA9IHJlcXVpcmVQcm9jZXNzKCk7CgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLwoKICBjb25zdCB7CiAgICBQcm9taXNlUHJvdG90eXBlVGhlbiwKICAgIFN5bWJvbEFzeW5jSXRlcmF0b3IsCiAgICBTeW1ib2xJdGVyYXRvcgogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKICBjb25zdCB7CiAgICBCdWZmZXIKICB9ID0gcmVxdWlyZSQkMCQzOwogIGNvbnN0IHsKICAgIEVSUl9JTlZBTElEX0FSR19UWVBFLAogICAgRVJSX1NUUkVBTV9OVUxMX1ZBTFVFUwogIH0gPSByZXF1aXJlRXJyb3JzKCkuY29kZXM7CiAgZnVuY3Rpb24gZnJvbShSZWFkYWJsZSwgaXRlcmFibGUsIG9wdHMpIHsKICAgIGxldCBpdGVyYXRvcjsKICAgIGlmICh0eXBlb2YgaXRlcmFibGUgPT09ICdzdHJpbmcnIHx8IGl0ZXJhYmxlIGluc3RhbmNlb2YgQnVmZmVyKSB7CiAgICAgIHJldHVybiBuZXcgUmVhZGFibGUoX29iamVjdFNwcmVhZCQ4KF9vYmplY3RTcHJlYWQkOCh7CiAgICAgICAgb2JqZWN0TW9kZTogdHJ1ZQogICAgICB9LCBvcHRzKSwge30sIHsKICAgICAgICByZWFkKCkgewogICAgICAgICAgdGhpcy5wdXNoKGl0ZXJhYmxlKTsKICAgICAgICAgIHRoaXMucHVzaChudWxsKTsKICAgICAgICB9CiAgICAgIH0pKTsKICAgIH0KICAgIGxldCBpc0FzeW5jOwogICAgaWYgKGl0ZXJhYmxlICYmIGl0ZXJhYmxlW1N5bWJvbEFzeW5jSXRlcmF0b3JdKSB7CiAgICAgIGlzQXN5bmMgPSB0cnVlOwogICAgICBpdGVyYXRvciA9IGl0ZXJhYmxlW1N5bWJvbEFzeW5jSXRlcmF0b3JdKCk7CiAgICB9IGVsc2UgaWYgKGl0ZXJhYmxlICYmIGl0ZXJhYmxlW1N5bWJvbEl0ZXJhdG9yXSkgewogICAgICBpc0FzeW5jID0gZmFsc2U7CiAgICAgIGl0ZXJhdG9yID0gaXRlcmFibGVbU3ltYm9sSXRlcmF0b3JdKCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ2l0ZXJhYmxlJywgWydJdGVyYWJsZSddLCBpdGVyYWJsZSk7CiAgICB9CiAgICBjb25zdCByZWFkYWJsZSA9IG5ldyBSZWFkYWJsZShfb2JqZWN0U3ByZWFkJDgoewogICAgICBvYmplY3RNb2RlOiB0cnVlLAogICAgICBoaWdoV2F0ZXJNYXJrOiAxCiAgICB9LCBvcHRzKSk7CgogICAgLy8gRmxhZyB0byBwcm90ZWN0IGFnYWluc3QgX3JlYWQKICAgIC8vIGJlaW5nIGNhbGxlZCBiZWZvcmUgbGFzdCBpdGVyYXRpb24gY29tcGxldGlvbi4KICAgIGxldCByZWFkaW5nID0gZmFsc2U7CiAgICByZWFkYWJsZS5fcmVhZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKCFyZWFkaW5nKSB7CiAgICAgICAgcmVhZGluZyA9IHRydWU7CiAgICAgICAgbmV4dCgpOwogICAgICB9CiAgICB9OwogICAgcmVhZGFibGUuX2Rlc3Ryb3kgPSBmdW5jdGlvbiAoZXJyb3IsIGNiKSB7CiAgICAgIFByb21pc2VQcm90b3R5cGVUaGVuKGNsb3NlKGVycm9yKSwgKCkgPT4gcHJvY2Vzcy5uZXh0VGljayhjYiwgZXJyb3IpLAogICAgICAvLyBuZXh0VGljayBpcyBoZXJlIGluIGNhc2UgY2IgdGhyb3dzCiAgICAgIGUgPT4gcHJvY2Vzcy5uZXh0VGljayhjYiwgZSB8fCBlcnJvcikpOwogICAgfTsKICAgIGFzeW5jIGZ1bmN0aW9uIGNsb3NlKGVycm9yKSB7CiAgICAgIGNvbnN0IGhhZEVycm9yID0gZXJyb3IgIT09IHVuZGVmaW5lZCAmJiBlcnJvciAhPT0gbnVsbDsKICAgICAgY29uc3QgaGFzVGhyb3cgPSB0eXBlb2YgaXRlcmF0b3IudGhyb3cgPT09ICdmdW5jdGlvbic7CiAgICAgIGlmIChoYWRFcnJvciAmJiBoYXNUaHJvdykgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZG9uZQogICAgICAgIH0gPSBhd2FpdCBpdGVyYXRvci50aHJvdyhlcnJvcik7CiAgICAgICAgYXdhaXQgdmFsdWU7CiAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvci5yZXR1cm4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICB2YWx1ZQogICAgICAgIH0gPSBhd2FpdCBpdGVyYXRvci5yZXR1cm4oKTsKICAgICAgICBhd2FpdCB2YWx1ZTsKICAgICAgfQogICAgfQogICAgYXN5bmMgZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgZm9yICg7OykgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBkb25lCiAgICAgICAgICB9ID0gaXNBc3luYyA/IGF3YWl0IGl0ZXJhdG9yLm5leHQoKSA6IGl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgIHJlYWRhYmxlLnB1c2gobnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZXMgPSB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gJ2Z1bmN0aW9uJyA/IGF3YWl0IHZhbHVlIDogdmFsdWU7CiAgICAgICAgICAgIGlmIChyZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZWFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVSUl9TVFJFQU1fTlVMTF9WQUxVRVMoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFkYWJsZS5wdXNoKHJlcykpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWFkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJlYWRhYmxlLmRlc3Ryb3koZXJyKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZWFkYWJsZTsKICB9CiAgZnJvbV8xID0gZnJvbTsKICByZXR1cm4gZnJvbV8xOwp9CgpmdW5jdGlvbiBvd25LZXlzJDcoZSwgcikgeyB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7IHIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbiAocikgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByKS5lbnVtZXJhYmxlOyB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsgfSByZXR1cm4gdDsgfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkJDcoZSkgeyBmb3IgKHZhciByID0gMTsgciA8IGFyZ3VtZW50cy5sZW5ndGg7IHIrKykgeyB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3JdID8gYXJndW1lbnRzW3JdIDoge307IHIgJSAyID8gb3duS2V5cyQ3KE9iamVjdCh0KSwgITApLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgX2RlZmluZVByb3BlcnR5KGUsIHIsIHRbcl0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyQ3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgciwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByKSk7IH0pOyB9IHJldHVybiBlOyB9CnZhciByZWFkYWJsZTsKdmFyIGhhc1JlcXVpcmVkUmVhZGFibGU7CmZ1bmN0aW9uIHJlcXVpcmVSZWFkYWJsZSgpIHsKICBpZiAoaGFzUmVxdWlyZWRSZWFkYWJsZSkgcmV0dXJuIHJlYWRhYmxlOwogIGhhc1JlcXVpcmVkUmVhZGFibGUgPSAxOwoKICAvKiByZXBsYWNlbWVudCBzdGFydCAqLwoKICBjb25zdCBwcm9jZXNzID0gcmVxdWlyZVByb2Nlc3MoKTsKCiAgLyogcmVwbGFjZW1lbnQgZW5kICovCgogIGNvbnN0IHsKICAgIEFycmF5UHJvdG90eXBlSW5kZXhPZiwKICAgIE51bWJlcklzSW50ZWdlciwKICAgIE51bWJlcklzTmFOLAogICAgTnVtYmVyUGFyc2VJbnQsCiAgICBPYmplY3REZWZpbmVQcm9wZXJ0aWVzLAogICAgT2JqZWN0S2V5cywKICAgIE9iamVjdFNldFByb3RvdHlwZU9mLAogICAgUHJvbWlzZSwKICAgIFNhZmVTZXQsCiAgICBTeW1ib2xBc3luY0Rpc3Bvc2UsCiAgICBTeW1ib2xBc3luY0l0ZXJhdG9yLAogICAgU3ltYm9sCiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwogIHJlYWRhYmxlID0gUmVhZGFibGU7CiAgUmVhZGFibGUuUmVhZGFibGVTdGF0ZSA9IFJlYWRhYmxlU3RhdGU7CiAgY29uc3QgewogICAgRXZlbnRFbWl0dGVyOiBFRQogIH0gPSByZXF1aXJlJCQwJDI7CiAgY29uc3QgewogICAgU3RyZWFtLAogICAgcHJlcGVuZExpc3RlbmVyCiAgfSA9IHJlcXVpcmVMZWdhY3koKTsKICBjb25zdCB7CiAgICBCdWZmZXIKICB9ID0gcmVxdWlyZSQkMCQzOwogIGNvbnN0IHsKICAgIGFkZEFib3J0U2lnbmFsCiAgfSA9IHJlcXVpcmVBZGRBYm9ydFNpZ25hbCgpOwogIGNvbnN0IGVvcyA9IHJlcXVpcmVFbmRPZlN0cmVhbSgpOwogIGxldCBkZWJ1ZyA9IHJlcXVpcmVVdGlsJDEoKS5kZWJ1Z2xvZygnc3RyZWFtJywgZm4gPT4gewogICAgZGVidWcgPSBmbjsKICB9KTsKICBjb25zdCBCdWZmZXJMaXN0ID0gcmVxdWlyZUJ1ZmZlcl9saXN0KCk7CiAgY29uc3QgZGVzdHJveUltcGwgPSByZXF1aXJlRGVzdHJveSgpOwogIGNvbnN0IHsKICAgIGdldEhpZ2hXYXRlck1hcmssCiAgICBnZXREZWZhdWx0SGlnaFdhdGVyTWFyawogIH0gPSByZXF1aXJlU3RhdGUoKTsKICBjb25zdCB7CiAgICBhZ2dyZWdhdGVUd29FcnJvcnMsCiAgICBjb2RlczogewogICAgICBFUlJfSU5WQUxJRF9BUkdfVFlQRSwKICAgICAgRVJSX01FVEhPRF9OT1RfSU1QTEVNRU5URUQsCiAgICAgIEVSUl9PVVRfT0ZfUkFOR0UsCiAgICAgIEVSUl9TVFJFQU1fUFVTSF9BRlRFUl9FT0YsCiAgICAgIEVSUl9TVFJFQU1fVU5TSElGVF9BRlRFUl9FTkRfRVZFTlQKICAgIH0sCiAgICBBYm9ydEVycm9yCiAgfSA9IHJlcXVpcmVFcnJvcnMoKTsKICBjb25zdCB7CiAgICB2YWxpZGF0ZU9iamVjdAogIH0gPSByZXF1aXJlVmFsaWRhdG9ycygpOwogIGNvbnN0IGtQYXVzZWQgPSBTeW1ib2woJ2tQYXVzZWQnKTsKICBjb25zdCB7CiAgICBTdHJpbmdEZWNvZGVyCiAgfSA9IHJlcXVpcmVTdHJpbmdfZGVjb2RlcigpOwogIGNvbnN0IGZyb20gPSByZXF1aXJlRnJvbSgpOwogIE9iamVjdFNldFByb3RvdHlwZU9mKFJlYWRhYmxlLnByb3RvdHlwZSwgU3RyZWFtLnByb3RvdHlwZSk7CiAgT2JqZWN0U2V0UHJvdG90eXBlT2YoUmVhZGFibGUsIFN0cmVhbSk7CiAgY29uc3Qgbm9wID0gKCkgPT4ge307CiAgY29uc3QgewogICAgZXJyb3JPckRlc3Ryb3kKICB9ID0gZGVzdHJveUltcGw7CiAgY29uc3Qga09iamVjdE1vZGUgPSAxIDw8IDA7CiAgY29uc3Qga0VuZGVkID0gMSA8PCAxOwogIGNvbnN0IGtFbmRFbWl0dGVkID0gMSA8PCAyOwogIGNvbnN0IGtSZWFkaW5nID0gMSA8PCAzOwogIGNvbnN0IGtDb25zdHJ1Y3RlZCA9IDEgPDwgNDsKICBjb25zdCBrU3luYyA9IDEgPDwgNTsKICBjb25zdCBrTmVlZFJlYWRhYmxlID0gMSA8PCA2OwogIGNvbnN0IGtFbWl0dGVkUmVhZGFibGUgPSAxIDw8IDc7CiAgY29uc3Qga1JlYWRhYmxlTGlzdGVuaW5nID0gMSA8PCA4OwogIGNvbnN0IGtSZXN1bWVTY2hlZHVsZWQgPSAxIDw8IDk7CiAgY29uc3Qga0Vycm9yRW1pdHRlZCA9IDEgPDwgMTA7CiAgY29uc3Qga0VtaXRDbG9zZSA9IDEgPDwgMTE7CiAgY29uc3Qga0F1dG9EZXN0cm95ID0gMSA8PCAxMjsKICBjb25zdCBrRGVzdHJveWVkID0gMSA8PCAxMzsKICBjb25zdCBrQ2xvc2VkID0gMSA8PCAxNDsKICBjb25zdCBrQ2xvc2VFbWl0dGVkID0gMSA8PCAxNTsKICBjb25zdCBrTXVsdGlBd2FpdERyYWluID0gMSA8PCAxNjsKICBjb25zdCBrUmVhZGluZ01vcmUgPSAxIDw8IDE3OwogIGNvbnN0IGtEYXRhRW1pdHRlZCA9IDEgPDwgMTg7CgogIC8vIFRPRE8oYmVuamFtaW5ncikgaXQgaXMgbGlrZWx5IHNsb3dlciB0byBkbyBpdCB0aGlzIHdheSB0aGFuIHdpdGggZnJlZSBmdW5jdGlvbnMKICBmdW5jdGlvbiBtYWtlQml0TWFwRGVzY3JpcHRvcihiaXQpIHsKICAgIHJldHVybiB7CiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnN0YXRlICYgYml0KSAhPT0gMDsKICAgICAgfSwKICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlKSB0aGlzLnN0YXRlIHw9IGJpdDtlbHNlIHRoaXMuc3RhdGUgJj0gfmJpdDsKICAgICAgfQogICAgfTsKICB9CiAgT2JqZWN0RGVmaW5lUHJvcGVydGllcyhSZWFkYWJsZVN0YXRlLnByb3RvdHlwZSwgewogICAgb2JqZWN0TW9kZTogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa09iamVjdE1vZGUpLAogICAgZW5kZWQ6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtFbmRlZCksCiAgICBlbmRFbWl0dGVkOiBtYWtlQml0TWFwRGVzY3JpcHRvcihrRW5kRW1pdHRlZCksCiAgICByZWFkaW5nOiBtYWtlQml0TWFwRGVzY3JpcHRvcihrUmVhZGluZyksCiAgICAvLyBTdHJlYW0gaXMgc3RpbGwgYmVpbmcgY29uc3RydWN0ZWQgYW5kIGNhbm5vdCBiZQogICAgLy8gZGVzdHJveWVkIHVudGlsIGNvbnN0cnVjdGlvbiBmaW5pc2hlZCBvciBmYWlsZWQuCiAgICAvLyBBc3luYyBjb25zdHJ1Y3Rpb24gaXMgb3B0IGluLCB0aGVyZWZvcmUgd2Ugc3RhcnQgYXMKICAgIC8vIGNvbnN0cnVjdGVkLgogICAgY29uc3RydWN0ZWQ6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtDb25zdHJ1Y3RlZCksCiAgICAvLyBBIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBldmVudCAncmVhZGFibGUnLydkYXRhJyBpcyBlbWl0dGVkCiAgICAvLyBpbW1lZGlhdGVseSwgb3Igb24gYSBsYXRlciB0aWNrLiAgV2Ugc2V0IHRoaXMgdG8gdHJ1ZSBhdCBmaXJzdCwgYmVjYXVzZQogICAgLy8gYW55IGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgICAvLyBub3QgaGFwcGVuIGJlZm9yZSB0aGUgZmlyc3QgcmVhZCBjYWxsLgogICAgc3luYzogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa1N5bmMpLAogICAgLy8gV2hlbmV2ZXIgd2UgcmV0dXJuIG51bGwsIHRoZW4gd2Ugc2V0IGEgZmxhZyB0byBzYXkKICAgIC8vIHRoYXQgd2UncmUgYXdhaXRpbmcgYSAncmVhZGFibGUnIGV2ZW50IGVtaXNzaW9uLgogICAgbmVlZFJlYWRhYmxlOiBtYWtlQml0TWFwRGVzY3JpcHRvcihrTmVlZFJlYWRhYmxlKSwKICAgIGVtaXR0ZWRSZWFkYWJsZTogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa0VtaXR0ZWRSZWFkYWJsZSksCiAgICByZWFkYWJsZUxpc3RlbmluZzogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa1JlYWRhYmxlTGlzdGVuaW5nKSwKICAgIHJlc3VtZVNjaGVkdWxlZDogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa1Jlc3VtZVNjaGVkdWxlZCksCiAgICAvLyBUcnVlIGlmIHRoZSBlcnJvciB3YXMgYWxyZWFkeSBlbWl0dGVkIGFuZCBzaG91bGQgbm90IGJlIHRocm93biBhZ2Fpbi4KICAgIGVycm9yRW1pdHRlZDogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa0Vycm9yRW1pdHRlZCksCiAgICBlbWl0Q2xvc2U6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtFbWl0Q2xvc2UpLAogICAgYXV0b0Rlc3Ryb3k6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtBdXRvRGVzdHJveSksCiAgICAvLyBIYXMgaXQgYmVlbiBkZXN0cm95ZWQuCiAgICBkZXN0cm95ZWQ6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtEZXN0cm95ZWQpLAogICAgLy8gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIHN0cmVhbSBoYXMgZmluaXNoZWQgZGVzdHJveWluZy4KICAgIGNsb3NlZDogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa0Nsb3NlZCksCiAgICAvLyBUcnVlIGlmIGNsb3NlIGhhcyBiZWVuIGVtaXR0ZWQgb3Igd291bGQgaGF2ZSBiZWVuIGVtaXR0ZWQKICAgIC8vIGRlcGVuZGluZyBvbiBlbWl0Q2xvc2UuCiAgICBjbG9zZUVtaXR0ZWQ6IG1ha2VCaXRNYXBEZXNjcmlwdG9yKGtDbG9zZUVtaXR0ZWQpLAogICAgbXVsdGlBd2FpdERyYWluOiBtYWtlQml0TWFwRGVzY3JpcHRvcihrTXVsdGlBd2FpdERyYWluKSwKICAgIC8vIElmIHRydWUsIGEgbWF5YmVSZWFkTW9yZSBoYXMgYmVlbiBzY2hlZHVsZWQuCiAgICByZWFkaW5nTW9yZTogbWFrZUJpdE1hcERlc2NyaXB0b3Ioa1JlYWRpbmdNb3JlKSwKICAgIGRhdGFFbWl0dGVkOiBtYWtlQml0TWFwRGVzY3JpcHRvcihrRGF0YUVtaXR0ZWQpCiAgfSk7CiAgZnVuY3Rpb24gUmVhZGFibGVTdGF0ZShvcHRpb25zLCBzdHJlYW0sIGlzRHVwbGV4KSB7CiAgICAvLyBEdXBsZXggc3RyZWFtcyBhcmUgYm90aCByZWFkYWJsZSBhbmQgd3JpdGFibGUsIGJ1dCBzaGFyZQogICAgLy8gdGhlIHNhbWUgb3B0aW9ucyBvYmplY3QuCiAgICAvLyBIb3dldmVyLCBzb21lIGNhc2VzIHJlcXVpcmUgc2V0dGluZyBvcHRpb25zIHRvIGRpZmZlcmVudAogICAgLy8gdmFsdWVzIGZvciB0aGUgcmVhZGFibGUgYW5kIHRoZSB3cml0YWJsZSBzaWRlcyBvZiB0aGUgZHVwbGV4IHN0cmVhbS4KICAgIC8vIFRoZXNlIG9wdGlvbnMgY2FuIGJlIHByb3ZpZGVkIHNlcGFyYXRlbHkgYXMgcmVhZGFibGVYWFggYW5kIHdyaXRhYmxlWFhYLgogICAgaWYgKHR5cGVvZiBpc0R1cGxleCAhPT0gJ2Jvb2xlYW4nKSBpc0R1cGxleCA9IHN0cmVhbSBpbnN0YW5jZW9mIHJlcXVpcmVEdXBsZXgoKTsKCiAgICAvLyBCaXQgbWFwIGZpZWxkIHRvIHN0b3JlIFJlYWRhYmxlU3RhdGUgbW9yZSBlZmZjaWVudGx5IHdpdGggMSBiaXQgcGVyIGZpZWxkCiAgICAvLyBpbnN0ZWFkIG9mIGEgVjggc2xvdCBwZXIgZmllbGQuCiAgICB0aGlzLnN0YXRlID0ga0VtaXRDbG9zZSB8IGtBdXRvRGVzdHJveSB8IGtDb25zdHJ1Y3RlZCB8IGtTeW5jOwogICAgLy8gT2JqZWN0IHN0cmVhbSBmbGFnLiBVc2VkIHRvIG1ha2UgcmVhZChuKSBpZ25vcmUgbiBhbmQgdG8KICAgIC8vIG1ha2UgYWxsIHRoZSBidWZmZXIgbWVyZ2luZyBhbmQgbGVuZ3RoIGNoZWNrcyBnbyBhd2F5LgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vYmplY3RNb2RlKSB0aGlzLnN0YXRlIHw9IGtPYmplY3RNb2RlOwogICAgaWYgKGlzRHVwbGV4ICYmIG9wdGlvbnMgJiYgb3B0aW9ucy5yZWFkYWJsZU9iamVjdE1vZGUpIHRoaXMuc3RhdGUgfD0ga09iamVjdE1vZGU7CgogICAgLy8gVGhlIHBvaW50IGF0IHdoaWNoIGl0IHN0b3BzIGNhbGxpbmcgX3JlYWQoKSB0byBmaWxsIHRoZSBidWZmZXIKICAgIC8vIE5vdGU6IDAgaXMgYSB2YWxpZCB2YWx1ZSwgbWVhbnMgImRvbid0IGNhbGwgX3JlYWQgcHJlZW1wdGl2ZWx5IGV2ZXIiCiAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSBvcHRpb25zID8gZ2V0SGlnaFdhdGVyTWFyayh0aGlzLCBvcHRpb25zLCAncmVhZGFibGVIaWdoV2F0ZXJNYXJrJywgaXNEdXBsZXgpIDogZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsoZmFsc2UpOwoKICAgIC8vIEEgbGlua2VkIGxpc3QgaXMgdXNlZCB0byBzdG9yZSBkYXRhIGNodW5rcyBpbnN0ZWFkIG9mIGFuIGFycmF5IGJlY2F1c2UgdGhlCiAgICAvLyBsaW5rZWQgbGlzdCBjYW4gcmVtb3ZlIGVsZW1lbnRzIGZyb20gdGhlIGJlZ2lubmluZyBmYXN0ZXIgdGhhbgogICAgLy8gYXJyYXkuc2hpZnQoKS4KICAgIHRoaXMuYnVmZmVyID0gbmV3IEJ1ZmZlckxpc3QoKTsKICAgIHRoaXMubGVuZ3RoID0gMDsKICAgIHRoaXMucGlwZXMgPSBbXTsKICAgIHRoaXMuZmxvd2luZyA9IG51bGw7CiAgICB0aGlzW2tQYXVzZWRdID0gbnVsbDsKCiAgICAvLyBTaG91bGQgY2xvc2UgYmUgZW1pdHRlZCBvbiBkZXN0cm95LiBEZWZhdWx0cyB0byB0cnVlLgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lbWl0Q2xvc2UgPT09IGZhbHNlKSB0aGlzLnN0YXRlICY9IH5rRW1pdENsb3NlOwoKICAgIC8vIFNob3VsZCAuZGVzdHJveSgpIGJlIGNhbGxlZCBhZnRlciAnZW5kJyAoYW5kIHBvdGVudGlhbGx5ICdmaW5pc2gnKS4KICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuYXV0b0Rlc3Ryb3kgPT09IGZhbHNlKSB0aGlzLnN0YXRlICY9IH5rQXV0b0Rlc3Ryb3k7CgogICAgLy8gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIHN0cmVhbSBoYXMgZXJyb3JlZC4gV2hlbiB0cnVlIG5vIGZ1cnRoZXIKICAgIC8vIF9yZWFkIGNhbGxzLCAnZGF0YScgb3IgJ3JlYWRhYmxlJyBldmVudHMgc2hvdWxkIG9jY3VyLiBUaGlzIGlzIG5lZWRlZAogICAgLy8gc2luY2Ugd2hlbiBhdXRvRGVzdHJveSBpcyBkaXNhYmxlZCB3ZSBuZWVkIGEgd2F5IHRvIHRlbGwgd2hldGhlciB0aGUKICAgIC8vIHN0cmVhbSBoYXMgZmFpbGVkLgogICAgdGhpcy5lcnJvcmVkID0gbnVsbDsKCiAgICAvLyBDcnlwdG8gaXMga2luZCBvZiBvbGQgYW5kIGNydXN0eS4gIEhpc3RvcmljYWxseSwgaXRzIGRlZmF1bHQgc3RyaW5nCiAgICAvLyBlbmNvZGluZyBpcyAnYmluYXJ5JyBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhpcyBjb25maWd1cmFibGUuCiAgICAvLyBFdmVyeXRoaW5nIGVsc2UgaW4gdGhlIHVuaXZlcnNlIHVzZXMgJ3V0ZjgnLCB0aG91Z2guCiAgICB0aGlzLmRlZmF1bHRFbmNvZGluZyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5kZWZhdWx0RW5jb2RpbmcgfHwgJ3V0ZjgnOwoKICAgIC8vIFJlZiB0aGUgcGlwZWQgZGVzdCB3aGljaCB3ZSBuZWVkIGEgZHJhaW4gZXZlbnQgb24gaXQKICAgIC8vIHR5cGU6IG51bGwgfCBXcml0YWJsZSB8IFNldDxXcml0YWJsZT4uCiAgICB0aGlzLmF3YWl0RHJhaW5Xcml0ZXJzID0gbnVsbDsKICAgIHRoaXMuZGVjb2RlciA9IG51bGw7CiAgICB0aGlzLmVuY29kaW5nID0gbnVsbDsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZW5jb2RpbmcpIHsKICAgICAgdGhpcy5kZWNvZGVyID0gbmV3IFN0cmluZ0RlY29kZXIob3B0aW9ucy5lbmNvZGluZyk7CiAgICAgIHRoaXMuZW5jb2RpbmcgPSBvcHRpb25zLmVuY29kaW5nOwogICAgfQogIH0KICBmdW5jdGlvbiBSZWFkYWJsZShvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVhZGFibGUpKSByZXR1cm4gbmV3IFJlYWRhYmxlKG9wdGlvbnMpOwoKICAgIC8vIENoZWNraW5nIGZvciBhIFN0cmVhbS5EdXBsZXggaW5zdGFuY2UgaXMgZmFzdGVyIGhlcmUgaW5zdGVhZCBvZiBpbnNpZGUKICAgIC8vIHRoZSBSZWFkYWJsZVN0YXRlIGNvbnN0cnVjdG9yLCBhdCBsZWFzdCB3aXRoIFY4IDYuNS4KICAgIGNvbnN0IGlzRHVwbGV4ID0gdGhpcyBpbnN0YW5jZW9mIHJlcXVpcmVEdXBsZXgoKTsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUgPSBuZXcgUmVhZGFibGVTdGF0ZShvcHRpb25zLCB0aGlzLCBpc0R1cGxleCk7CiAgICBpZiAob3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMucmVhZCA9PT0gJ2Z1bmN0aW9uJykgdGhpcy5fcmVhZCA9IG9wdGlvbnMucmVhZDsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmRlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHRoaXMuX2Rlc3Ryb3kgPSBvcHRpb25zLmRlc3Ryb3k7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jb25zdHJ1Y3QgPT09ICdmdW5jdGlvbicpIHRoaXMuX2NvbnN0cnVjdCA9IG9wdGlvbnMuY29uc3RydWN0OwogICAgICBpZiAob3B0aW9ucy5zaWduYWwgJiYgIWlzRHVwbGV4KSBhZGRBYm9ydFNpZ25hbChvcHRpb25zLnNpZ25hbCwgdGhpcyk7CiAgICB9CiAgICBTdHJlYW0uY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIGRlc3Ryb3lJbXBsLmNvbnN0cnVjdCh0aGlzLCAoKSA9PiB7CiAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlLm5lZWRSZWFkYWJsZSkgewogICAgICAgIG1heWJlUmVhZE1vcmUodGhpcywgdGhpcy5fcmVhZGFibGVTdGF0ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBSZWFkYWJsZS5wcm90b3R5cGUuZGVzdHJveSA9IGRlc3Ryb3lJbXBsLmRlc3Ryb3k7CiAgUmVhZGFibGUucHJvdG90eXBlLl91bmRlc3Ryb3kgPSBkZXN0cm95SW1wbC51bmRlc3Ryb3k7CiAgUmVhZGFibGUucHJvdG90eXBlLl9kZXN0cm95ID0gZnVuY3Rpb24gKGVyciwgY2IpIHsKICAgIGNiKGVycik7CiAgfTsKICBSZWFkYWJsZS5wcm90b3R5cGVbRUUuY2FwdHVyZVJlamVjdGlvblN5bWJvbF0gPSBmdW5jdGlvbiAoZXJyKSB7CiAgICB0aGlzLmRlc3Ryb3koZXJyKTsKICB9OwogIFJlYWRhYmxlLnByb3RvdHlwZVtTeW1ib2xBc3luY0Rpc3Bvc2VdID0gZnVuY3Rpb24gKCkgewogICAgbGV0IGVycm9yOwogICAgaWYgKCF0aGlzLmRlc3Ryb3llZCkgewogICAgICBlcnJvciA9IHRoaXMucmVhZGFibGVFbmRlZCA/IG51bGwgOiBuZXcgQWJvcnRFcnJvcigpOwogICAgICB0aGlzLmRlc3Ryb3koZXJyb3IpOwogICAgfQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IGVvcyh0aGlzLCBlcnIgPT4gZXJyICYmIGVyciAhPT0gZXJyb3IgPyByZWplY3QoZXJyKSA6IHJlc29sdmUobnVsbCkpKTsKICB9OwoKICAvLyBNYW51YWxseSBzaG92ZSBzb21ldGhpbmcgaW50byB0aGUgcmVhZCgpIGJ1ZmZlci4KICAvLyBUaGlzIHJldHVybnMgdHJ1ZSBpZiB0aGUgaGlnaFdhdGVyTWFyayBoYXMgbm90IGJlZW4gaGl0IHlldCwKICAvLyBzaW1pbGFyIHRvIGhvdyBXcml0YWJsZS53cml0ZSgpIHJldHVybnMgdHJ1ZSBpZiB5b3Ugc2hvdWxkCiAgLy8gd3JpdGUoKSBzb21lIG1vcmUuCiAgUmVhZGFibGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiAoY2h1bmssIGVuY29kaW5nKSB7CiAgICByZXR1cm4gcmVhZGFibGVBZGRDaHVuayh0aGlzLCBjaHVuaywgZW5jb2RpbmcsIGZhbHNlKTsKICB9OwoKICAvLyBVbnNoaWZ0IHNob3VsZCAqYWx3YXlzKiBiZSBzb21ldGhpbmcgZGlyZWN0bHkgb3V0IG9mIHJlYWQoKS4KICBSZWFkYWJsZS5wcm90b3R5cGUudW5zaGlmdCA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcpIHsKICAgIHJldHVybiByZWFkYWJsZUFkZENodW5rKHRoaXMsIGNodW5rLCBlbmNvZGluZywgdHJ1ZSk7CiAgfTsKICBmdW5jdGlvbiByZWFkYWJsZUFkZENodW5rKHN0cmVhbSwgY2h1bmssIGVuY29kaW5nLCBhZGRUb0Zyb250KSB7CiAgICBkZWJ1ZygncmVhZGFibGVBZGRDaHVuaycsIGNodW5rKTsKICAgIGNvbnN0IHN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgbGV0IGVycjsKICAgIGlmICgoc3RhdGUuc3RhdGUgJiBrT2JqZWN0TW9kZSkgPT09IDApIHsKICAgICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlbmNvZGluZyA9IGVuY29kaW5nIHx8IHN0YXRlLmRlZmF1bHRFbmNvZGluZzsKICAgICAgICBpZiAoc3RhdGUuZW5jb2RpbmcgIT09IGVuY29kaW5nKSB7CiAgICAgICAgICBpZiAoYWRkVG9Gcm9udCAmJiBzdGF0ZS5lbmNvZGluZykgewogICAgICAgICAgICAvLyBXaGVuIHVuc2hpZnRpbmcsIGlmIHN0YXRlLmVuY29kaW5nIGlzIHNldCwgd2UgaGF2ZSB0byBzYXZlCiAgICAgICAgICAgIC8vIHRoZSBzdHJpbmcgaW4gdGhlIEJ1ZmZlckxpc3Qgd2l0aCB0aGUgc3RhdGUgZW5jb2RpbmcuCiAgICAgICAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKS50b1N0cmluZyhzdGF0ZS5lbmNvZGluZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaHVuayA9IEJ1ZmZlci5mcm9tKGNodW5rLCBlbmNvZGluZyk7CiAgICAgICAgICAgIGVuY29kaW5nID0gJyc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNodW5rIGluc3RhbmNlb2YgQnVmZmVyKSB7CiAgICAgICAgZW5jb2RpbmcgPSAnJzsKICAgICAgfSBlbHNlIGlmIChTdHJlYW0uX2lzVWludDhBcnJheShjaHVuaykpIHsKICAgICAgICBjaHVuayA9IFN0cmVhbS5fdWludDhBcnJheVRvQnVmZmVyKGNodW5rKTsKICAgICAgICBlbmNvZGluZyA9ICcnOwogICAgICB9IGVsc2UgaWYgKGNodW5rICE9IG51bGwpIHsKICAgICAgICBlcnIgPSBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ2NodW5rJywgWydzdHJpbmcnLCAnQnVmZmVyJywgJ1VpbnQ4QXJyYXknXSwgY2h1bmspOwogICAgICB9CiAgICB9CiAgICBpZiAoZXJyKSB7CiAgICAgIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgZXJyKTsKICAgIH0gZWxzZSBpZiAoY2h1bmsgPT09IG51bGwpIHsKICAgICAgc3RhdGUuc3RhdGUgJj0gfmtSZWFkaW5nOwogICAgICBvbkVvZkNodW5rKHN0cmVhbSwgc3RhdGUpOwogICAgfSBlbHNlIGlmICgoc3RhdGUuc3RhdGUgJiBrT2JqZWN0TW9kZSkgIT09IDAgfHwgY2h1bmsgJiYgY2h1bmsubGVuZ3RoID4gMCkgewogICAgICBpZiAoYWRkVG9Gcm9udCkgewogICAgICAgIGlmICgoc3RhdGUuc3RhdGUgJiBrRW5kRW1pdHRlZCkgIT09IDApIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgbmV3IEVSUl9TVFJFQU1fVU5TSElGVF9BRlRFUl9FTkRfRVZFTlQoKSk7ZWxzZSBpZiAoc3RhdGUuZGVzdHJveWVkIHx8IHN0YXRlLmVycm9yZWQpIHJldHVybiBmYWxzZTtlbHNlIGFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCB0cnVlKTsKICAgICAgfSBlbHNlIGlmIChzdGF0ZS5lbmRlZCkgewogICAgICAgIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgbmV3IEVSUl9TVFJFQU1fUFVTSF9BRlRFUl9FT0YoKSk7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGUuZGVzdHJveWVkIHx8IHN0YXRlLmVycm9yZWQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGUuc3RhdGUgJj0gfmtSZWFkaW5nOwogICAgICAgIGlmIChzdGF0ZS5kZWNvZGVyICYmICFlbmNvZGluZykgewogICAgICAgICAgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLndyaXRlKGNodW5rKTsKICAgICAgICAgIGlmIChzdGF0ZS5vYmplY3RNb2RlIHx8IGNodW5rLmxlbmd0aCAhPT0gMCkgYWRkQ2h1bmsoc3RyZWFtLCBzdGF0ZSwgY2h1bmssIGZhbHNlKTtlbHNlIG1heWJlUmVhZE1vcmUoc3RyZWFtLCBzdGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKCFhZGRUb0Zyb250KSB7CiAgICAgIHN0YXRlLnN0YXRlICY9IH5rUmVhZGluZzsKICAgICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICAgIH0KCiAgICAvLyBXZSBjYW4gcHVzaCBtb3JlIGRhdGEgaWYgd2UgYXJlIGJlbG93IHRoZSBoaWdoV2F0ZXJNYXJrLgogICAgLy8gQWxzbywgaWYgd2UgaGF2ZSBubyBkYXRhIHlldCwgd2UgY2FuIHN0YW5kIHNvbWUgbW9yZSBieXRlcy4KICAgIC8vIFRoaXMgaXMgdG8gd29yayBhcm91bmQgY2FzZXMgd2hlcmUgaHdtPTAsIHN1Y2ggYXMgdGhlIHJlcGwuCiAgICByZXR1cm4gIXN0YXRlLmVuZGVkICYmIChzdGF0ZS5sZW5ndGggPCBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmxlbmd0aCA9PT0gMCk7CiAgfQogIGZ1bmN0aW9uIGFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBhZGRUb0Zyb250KSB7CiAgICBpZiAoc3RhdGUuZmxvd2luZyAmJiBzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLnN5bmMgJiYgc3RyZWFtLmxpc3RlbmVyQ291bnQoJ2RhdGEnKSA+IDApIHsKICAgICAgLy8gVXNlIHRoZSBndWFyZCB0byBhdm9pZCBjcmVhdGluZyBgU2V0KClgIHJlcGVhdGVkbHkKICAgICAgLy8gd2hlbiB3ZSBoYXZlIG11bHRpcGxlIHBpcGVzLgogICAgICBpZiAoKHN0YXRlLnN0YXRlICYga011bHRpQXdhaXREcmFpbikgIT09IDApIHsKICAgICAgICBzdGF0ZS5hd2FpdERyYWluV3JpdGVycy5jbGVhcigpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzID0gbnVsbDsKICAgICAgfQogICAgICBzdGF0ZS5kYXRhRW1pdHRlZCA9IHRydWU7CiAgICAgIHN0cmVhbS5lbWl0KCdkYXRhJywgY2h1bmspOwogICAgfSBlbHNlIHsKICAgICAgLy8gVXBkYXRlIHRoZSBidWZmZXIgaW5mby4KICAgICAgc3RhdGUubGVuZ3RoICs9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwogICAgICBpZiAoYWRkVG9Gcm9udCkgc3RhdGUuYnVmZmVyLnVuc2hpZnQoY2h1bmspO2Vsc2Ugc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICBpZiAoKHN0YXRlLnN0YXRlICYga05lZWRSZWFkYWJsZSkgIT09IDApIGVtaXRSZWFkYWJsZShzdHJlYW0pOwogICAgfQogICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICB9CiAgUmVhZGFibGUucHJvdG90eXBlLmlzUGF1c2VkID0gZnVuY3Rpb24gKCkgewogICAgY29uc3Qgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgcmV0dXJuIHN0YXRlW2tQYXVzZWRdID09PSB0cnVlIHx8IHN0YXRlLmZsb3dpbmcgPT09IGZhbHNlOwogIH07CgogIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIFJlYWRhYmxlLnByb3RvdHlwZS5zZXRFbmNvZGluZyA9IGZ1bmN0aW9uIChlbmMpIHsKICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihlbmMpOwogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5kZWNvZGVyID0gZGVjb2RlcjsKICAgIC8vIElmIHNldEVuY29kaW5nKG51bGwpLCBkZWNvZGVyLmVuY29kaW5nIGVxdWFscyB1dGY4LgogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA9IHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVjb2Rlci5lbmNvZGluZzsKICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuX3JlYWRhYmxlU3RhdGUuYnVmZmVyOwogICAgLy8gSXRlcmF0ZSBvdmVyIGN1cnJlbnQgYnVmZmVyIHRvIGNvbnZlcnQgYWxyZWFkeSBzdG9yZWQgQnVmZmVyczoKICAgIGxldCBjb250ZW50ID0gJyc7CiAgICBmb3IgKGNvbnN0IGRhdGEgb2YgYnVmZmVyKSB7CiAgICAgIGNvbnRlbnQgKz0gZGVjb2Rlci53cml0ZShkYXRhKTsKICAgIH0KICAgIGJ1ZmZlci5jbGVhcigpOwogICAgaWYgKGNvbnRlbnQgIT09ICcnKSBidWZmZXIucHVzaChjb250ZW50KTsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUubGVuZ3RoID0gY29udGVudC5sZW5ndGg7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBEb24ndCByYWlzZSB0aGUgaHdtID4gMUdCLgogIGNvbnN0IE1BWF9IV00gPSAweDQwMDAwMDAwOwogIGZ1bmN0aW9uIGNvbXB1dGVOZXdIaWdoV2F0ZXJNYXJrKG4pIHsKICAgIGlmIChuID4gTUFYX0hXTSkgewogICAgICB0aHJvdyBuZXcgRVJSX09VVF9PRl9SQU5HRSgnc2l6ZScsICc8PSAxR2lCJywgbik7CiAgICB9IGVsc2UgewogICAgICAvLyBHZXQgdGhlIG5leHQgaGlnaGVzdCBwb3dlciBvZiAyIHRvIHByZXZlbnQgaW5jcmVhc2luZyBod20gZXhjZXNzaXZlbHkgaW4KICAgICAgLy8gdGlueSBhbW91bnRzLgogICAgICBuLS07CiAgICAgIG4gfD0gbiA+Pj4gMTsKICAgICAgbiB8PSBuID4+PiAyOwogICAgICBuIHw9IG4gPj4+IDQ7CiAgICAgIG4gfD0gbiA+Pj4gODsKICAgICAgbiB8PSBuID4+PiAxNjsKICAgICAgbisrOwogICAgfQogICAgcmV0dXJuIG47CiAgfQoKICAvLyBUaGlzIGZ1bmN0aW9uIGlzIGRlc2lnbmVkIHRvIGJlIGlubGluYWJsZSwgc28gcGxlYXNlIHRha2UgY2FyZSB3aGVuIG1ha2luZwogIC8vIGNoYW5nZXMgdG8gdGhlIGZ1bmN0aW9uIGJvZHkuCiAgZnVuY3Rpb24gaG93TXVjaFRvUmVhZChuLCBzdGF0ZSkgewogICAgaWYgKG4gPD0gMCB8fCBzdGF0ZS5sZW5ndGggPT09IDAgJiYgc3RhdGUuZW5kZWQpIHJldHVybiAwOwogICAgaWYgKChzdGF0ZS5zdGF0ZSAmIGtPYmplY3RNb2RlKSAhPT0gMCkgcmV0dXJuIDE7CiAgICBpZiAoTnVtYmVySXNOYU4obikpIHsKICAgICAgLy8gT25seSBmbG93IG9uZSBidWZmZXIgYXQgYSB0aW1lLgogICAgICBpZiAoc3RhdGUuZmxvd2luZyAmJiBzdGF0ZS5sZW5ndGgpIHJldHVybiBzdGF0ZS5idWZmZXIuZmlyc3QoKS5sZW5ndGg7CiAgICAgIHJldHVybiBzdGF0ZS5sZW5ndGg7CiAgICB9CiAgICBpZiAobiA8PSBzdGF0ZS5sZW5ndGgpIHJldHVybiBuOwogICAgcmV0dXJuIHN0YXRlLmVuZGVkID8gc3RhdGUubGVuZ3RoIDogMDsKICB9CgogIC8vIFlvdSBjYW4gb3ZlcnJpZGUgZWl0aGVyIHRoaXMgbWV0aG9kLCBvciB0aGUgYXN5bmMgX3JlYWQobikgYmVsb3cuCiAgUmVhZGFibGUucHJvdG90eXBlLnJlYWQgPSBmdW5jdGlvbiAobikgewogICAgZGVidWcoJ3JlYWQnLCBuKTsKICAgIC8vIFNhbWUgYXMgcGFyc2VJbnQodW5kZWZpbmVkLCAxMCksIGhvd2V2ZXIgVjggNy4zIHBlcmZvcm1hbmNlIHJlZ3Jlc3NlZAogICAgLy8gaW4gdGhpcyBzY2VuYXJpbywgc28gd2UgYXJlIGRvaW5nIGl0IG1hbnVhbGx5LgogICAgaWYgKG4gPT09IHVuZGVmaW5lZCkgewogICAgICBuID0gTmFOOwogICAgfSBlbHNlIGlmICghTnVtYmVySXNJbnRlZ2VyKG4pKSB7CiAgICAgIG4gPSBOdW1iZXJQYXJzZUludChuLCAxMCk7CiAgICB9CiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgICBjb25zdCBuT3JpZyA9IG47CgogICAgLy8gSWYgd2UncmUgYXNraW5nIGZvciBtb3JlIHRoYW4gdGhlIGN1cnJlbnQgaHdtLCB0aGVuIHJhaXNlIHRoZSBod20uCiAgICBpZiAobiA+IHN0YXRlLmhpZ2hXYXRlck1hcmspIHN0YXRlLmhpZ2hXYXRlck1hcmsgPSBjb21wdXRlTmV3SGlnaFdhdGVyTWFyayhuKTsKICAgIGlmIChuICE9PSAwKSBzdGF0ZS5zdGF0ZSAmPSB+a0VtaXR0ZWRSZWFkYWJsZTsKCiAgICAvLyBJZiB3ZSdyZSBkb2luZyByZWFkKDApIHRvIHRyaWdnZXIgYSByZWFkYWJsZSBldmVudCwgYnV0IHdlCiAgICAvLyBhbHJlYWR5IGhhdmUgYSBidW5jaCBvZiBkYXRhIGluIHRoZSBidWZmZXIsIHRoZW4ganVzdCB0cmlnZ2VyCiAgICAvLyB0aGUgJ3JlYWRhYmxlJyBldmVudCBhbmQgbW92ZSBvbi4KICAgIGlmIChuID09PSAwICYmIHN0YXRlLm5lZWRSZWFkYWJsZSAmJiAoKHN0YXRlLmhpZ2hXYXRlck1hcmsgIT09IDAgPyBzdGF0ZS5sZW5ndGggPj0gc3RhdGUuaGlnaFdhdGVyTWFyayA6IHN0YXRlLmxlbmd0aCA+IDApIHx8IHN0YXRlLmVuZGVkKSkgewogICAgICBkZWJ1ZygncmVhZDogZW1pdFJlYWRhYmxlJywgc3RhdGUubGVuZ3RoLCBzdGF0ZS5lbmRlZCk7CiAgICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDAgJiYgc3RhdGUuZW5kZWQpIGVuZFJlYWRhYmxlKHRoaXMpO2Vsc2UgZW1pdFJlYWRhYmxlKHRoaXMpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIG4gPSBob3dNdWNoVG9SZWFkKG4sIHN0YXRlKTsKCiAgICAvLyBJZiB3ZSd2ZSBlbmRlZCwgYW5kIHdlJ3JlIG5vdyBjbGVhciwgdGhlbiBmaW5pc2ggaXQgdXAuCiAgICBpZiAobiA9PT0gMCAmJiBzdGF0ZS5lbmRlZCkgewogICAgICBpZiAoc3RhdGUubGVuZ3RoID09PSAwKSBlbmRSZWFkYWJsZSh0aGlzKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gQWxsIHRoZSBhY3R1YWwgY2h1bmsgZ2VuZXJhdGlvbiBsb2dpYyBuZWVkcyB0byBiZQogICAgLy8gKmJlbG93KiB0aGUgY2FsbCB0byBfcmVhZC4gIFRoZSByZWFzb24gaXMgdGhhdCBpbiBjZXJ0YWluCiAgICAvLyBzeW50aGV0aWMgc3RyZWFtIGNhc2VzLCBzdWNoIGFzIHBhc3N0aHJvdWdoIHN0cmVhbXMsIF9yZWFkCiAgICAvLyBtYXkgYmUgYSBjb21wbGV0ZWx5IHN5bmNocm9ub3VzIG9wZXJhdGlvbiB3aGljaCBtYXkgY2hhbmdlCiAgICAvLyB0aGUgc3RhdGUgb2YgdGhlIHJlYWQgYnVmZmVyLCBwcm92aWRpbmcgZW5vdWdoIGRhdGEgd2hlbgogICAgLy8gYmVmb3JlIHRoZXJlIHdhcyAqbm90KiBlbm91Z2guCiAgICAvLwogICAgLy8gU28sIHRoZSBzdGVwcyBhcmU6CiAgICAvLyAxLiBGaWd1cmUgb3V0IHdoYXQgdGhlIHN0YXRlIG9mIHRoaW5ncyB3aWxsIGJlIGFmdGVyIHdlIGRvCiAgICAvLyBhIHJlYWQgZnJvbSB0aGUgYnVmZmVyLgogICAgLy8KICAgIC8vIDIuIElmIHRoYXQgcmVzdWx0aW5nIHN0YXRlIHdpbGwgdHJpZ2dlciBhIF9yZWFkLCB0aGVuIGNhbGwgX3JlYWQuCiAgICAvLyBOb3RlIHRoYXQgdGhpcyBtYXkgYmUgYXN5bmNocm9ub3VzLCBvciBzeW5jaHJvbm91cy4gIFllcywgaXQgaXMKICAgIC8vIGRlZXBseSB1Z2x5IHRvIHdyaXRlIEFQSXMgdGhpcyB3YXksIGJ1dCB0aGF0IHN0aWxsIGRvZXNuJ3QgbWVhbgogICAgLy8gdGhhdCB0aGUgUmVhZGFibGUgY2xhc3Mgc2hvdWxkIGJlaGF2ZSBpbXByb3Blcmx5LCBhcyBzdHJlYW1zIGFyZQogICAgLy8gZGVzaWduZWQgdG8gYmUgc3luYy9hc3luYyBhZ25vc3RpYy4KICAgIC8vIFRha2Ugbm90ZSBpZiB0aGUgX3JlYWQgY2FsbCBpcyBzeW5jIG9yIGFzeW5jIChpZSwgaWYgdGhlIHJlYWQgY2FsbAogICAgLy8gaGFzIHJldHVybmVkIHlldCksIHNvIHRoYXQgd2Uga25vdyB3aGV0aGVyIG9yIG5vdCBpdCdzIHNhZmUgdG8gZW1pdAogICAgLy8gJ3JlYWRhYmxlJyBldGMuCiAgICAvLwogICAgLy8gMy4gQWN0dWFsbHkgcHVsbCB0aGUgcmVxdWVzdGVkIGNodW5rcyBvdXQgb2YgdGhlIGJ1ZmZlciBhbmQgcmV0dXJuLgoKICAgIC8vIGlmIHdlIG5lZWQgYSByZWFkYWJsZSBldmVudCwgdGhlbiB3ZSBuZWVkIHRvIGRvIHNvbWUgcmVhZGluZy4KICAgIGxldCBkb1JlYWQgPSAoc3RhdGUuc3RhdGUgJiBrTmVlZFJlYWRhYmxlKSAhPT0gMDsKICAgIGRlYnVnKCduZWVkIHJlYWRhYmxlJywgZG9SZWFkKTsKCiAgICAvLyBJZiB3ZSBjdXJyZW50bHkgaGF2ZSBsZXNzIHRoYW4gdGhlIGhpZ2hXYXRlck1hcmssIHRoZW4gYWxzbyByZWFkIHNvbWUuCiAgICBpZiAoc3RhdGUubGVuZ3RoID09PSAwIHx8IHN0YXRlLmxlbmd0aCAtIG4gPCBzdGF0ZS5oaWdoV2F0ZXJNYXJrKSB7CiAgICAgIGRvUmVhZCA9IHRydWU7CiAgICAgIGRlYnVnKCdsZW5ndGggbGVzcyB0aGFuIHdhdGVybWFyaycsIGRvUmVhZCk7CiAgICB9CgogICAgLy8gSG93ZXZlciwgaWYgd2UndmUgZW5kZWQsIHRoZW4gdGhlcmUncyBubyBwb2ludCwgaWYgd2UncmUgYWxyZWFkeQogICAgLy8gcmVhZGluZywgdGhlbiBpdCdzIHVubmVjZXNzYXJ5LCBpZiB3ZSdyZSBjb25zdHJ1Y3Rpbmcgd2UgaGF2ZSB0byB3YWl0LAogICAgLy8gYW5kIGlmIHdlJ3JlIGRlc3Ryb3llZCBvciBlcnJvcmVkLCB0aGVuIGl0J3Mgbm90IGFsbG93ZWQsCiAgICBpZiAoc3RhdGUuZW5kZWQgfHwgc3RhdGUucmVhZGluZyB8fCBzdGF0ZS5kZXN0cm95ZWQgfHwgc3RhdGUuZXJyb3JlZCB8fCAhc3RhdGUuY29uc3RydWN0ZWQpIHsKICAgICAgZG9SZWFkID0gZmFsc2U7CiAgICAgIGRlYnVnKCdyZWFkaW5nLCBlbmRlZCBvciBjb25zdHJ1Y3RpbmcnLCBkb1JlYWQpOwogICAgfSBlbHNlIGlmIChkb1JlYWQpIHsKICAgICAgZGVidWcoJ2RvIHJlYWQnKTsKICAgICAgc3RhdGUuc3RhdGUgfD0ga1JlYWRpbmcgfCBrU3luYzsKICAgICAgLy8gSWYgdGhlIGxlbmd0aCBpcyBjdXJyZW50bHkgemVybywgdGhlbiB3ZSAqbmVlZCogYSByZWFkYWJsZSBldmVudC4KICAgICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkgc3RhdGUuc3RhdGUgfD0ga05lZWRSZWFkYWJsZTsKCiAgICAgIC8vIENhbGwgaW50ZXJuYWwgcmVhZCBtZXRob2QKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLl9yZWFkKHN0YXRlLmhpZ2hXYXRlck1hcmspOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBlcnJvck9yRGVzdHJveSh0aGlzLCBlcnIpOwogICAgICB9CiAgICAgIHN0YXRlLnN0YXRlICY9IH5rU3luYzsKCiAgICAgIC8vIElmIF9yZWFkIHB1c2hlZCBkYXRhIHN5bmNocm9ub3VzbHksIHRoZW4gYHJlYWRpbmdgIHdpbGwgYmUgZmFsc2UsCiAgICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHJlLWV2YWx1YXRlIGhvdyBtdWNoIGRhdGEgd2UgY2FuIHJldHVybiB0byB0aGUgdXNlci4KICAgICAgaWYgKCFzdGF0ZS5yZWFkaW5nKSBuID0gaG93TXVjaFRvUmVhZChuT3JpZywgc3RhdGUpOwogICAgfQogICAgbGV0IHJldDsKICAgIGlmIChuID4gMCkgcmV0ID0gZnJvbUxpc3Qobiwgc3RhdGUpO2Vsc2UgcmV0ID0gbnVsbDsKICAgIGlmIChyZXQgPT09IG51bGwpIHsKICAgICAgc3RhdGUubmVlZFJlYWRhYmxlID0gc3RhdGUubGVuZ3RoIDw9IHN0YXRlLmhpZ2hXYXRlck1hcms7CiAgICAgIG4gPSAwOwogICAgfSBlbHNlIHsKICAgICAgc3RhdGUubGVuZ3RoIC09IG47CiAgICAgIGlmIChzdGF0ZS5tdWx0aUF3YWl0RHJhaW4pIHsKICAgICAgICBzdGF0ZS5hd2FpdERyYWluV3JpdGVycy5jbGVhcigpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzID0gbnVsbDsKICAgICAgfQogICAgfQogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAvLyBJZiB3ZSBoYXZlIG5vdGhpbmcgaW4gdGhlIGJ1ZmZlciwgdGhlbiB3ZSB3YW50IHRvIGtub3cKICAgICAgLy8gYXMgc29vbiBhcyB3ZSAqZG8qIGdldCBzb21ldGhpbmcgaW50byB0aGUgYnVmZmVyLgogICAgICBpZiAoIXN0YXRlLmVuZGVkKSBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwoKICAgICAgLy8gSWYgd2UgdHJpZWQgdG8gcmVhZCgpIHBhc3QgdGhlIEVPRiwgdGhlbiBlbWl0IGVuZCBvbiB0aGUgbmV4dCB0aWNrLgogICAgICBpZiAobk9yaWcgIT09IG4gJiYgc3RhdGUuZW5kZWQpIGVuZFJlYWRhYmxlKHRoaXMpOwogICAgfQogICAgaWYgKHJldCAhPT0gbnVsbCAmJiAhc3RhdGUuZXJyb3JFbWl0dGVkICYmICFzdGF0ZS5jbG9zZUVtaXR0ZWQpIHsKICAgICAgc3RhdGUuZGF0YUVtaXR0ZWQgPSB0cnVlOwogICAgICB0aGlzLmVtaXQoJ2RhdGEnLCByZXQpOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9OwogIGZ1bmN0aW9uIG9uRW9mQ2h1bmsoc3RyZWFtLCBzdGF0ZSkgewogICAgZGVidWcoJ29uRW9mQ2h1bmsnKTsKICAgIGlmIChzdGF0ZS5lbmRlZCkgcmV0dXJuOwogICAgaWYgKHN0YXRlLmRlY29kZXIpIHsKICAgICAgY29uc3QgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLmVuZCgpOwogICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKSB7CiAgICAgICAgc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICAgIHN0YXRlLmxlbmd0aCArPSBzdGF0ZS5vYmplY3RNb2RlID8gMSA6IGNodW5rLmxlbmd0aDsKICAgICAgfQogICAgfQogICAgc3RhdGUuZW5kZWQgPSB0cnVlOwogICAgaWYgKHN0YXRlLnN5bmMpIHsKICAgICAgLy8gSWYgd2UgYXJlIHN5bmMsIHdhaXQgdW50aWwgbmV4dCB0aWNrIHRvIGVtaXQgdGhlIGRhdGEuCiAgICAgIC8vIE90aGVyd2lzZSB3ZSByaXNrIGVtaXR0aW5nIGRhdGEgaW4gdGhlIGZsb3coKQogICAgICAvLyB0aGUgcmVhZGFibGUgY29kZSB0cmlnZ2VycyBkdXJpbmcgYSByZWFkKCkgY2FsbC4KICAgICAgZW1pdFJlYWRhYmxlKHN0cmVhbSk7CiAgICB9IGVsc2UgewogICAgICAvLyBFbWl0ICdyZWFkYWJsZScgbm93IHRvIG1ha2Ugc3VyZSBpdCBnZXRzIHBpY2tlZCB1cC4KICAgICAgc3RhdGUubmVlZFJlYWRhYmxlID0gZmFsc2U7CiAgICAgIHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIC8vIFdlIGhhdmUgdG8gZW1pdCByZWFkYWJsZSBub3cgdGhhdCB3ZSBhcmUgRU9GLiBNb2R1bGVzCiAgICAgIC8vIGluIHRoZSBlY29zeXN0ZW0gKGUuZy4gZGljZXIpIHJlbHkgb24gdGhpcyBldmVudCBiZWluZyBzeW5jLgogICAgICBlbWl0UmVhZGFibGVfKHN0cmVhbSk7CiAgICB9CiAgfQoKICAvLyBEb24ndCBlbWl0IHJlYWRhYmxlIHJpZ2h0IGF3YXkgaW4gc3luYyBtb2RlLCBiZWNhdXNlIHRoaXMgY2FuIHRyaWdnZXIKICAvLyBhbm90aGVyIHJlYWQoKSBjYWxsID0+IHN0YWNrIG92ZXJmbG93LiAgVGhpcyB3YXksIGl0IG1pZ2h0IHRyaWdnZXIKICAvLyBhIG5leHRUaWNrIHJlY3Vyc2lvbiB3YXJuaW5nLCBidXQgdGhhdCdzIG5vdCBzbyBiYWQuCiAgZnVuY3Rpb24gZW1pdFJlYWRhYmxlKHN0cmVhbSkgewogICAgY29uc3Qgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgICBkZWJ1ZygnZW1pdFJlYWRhYmxlJywgc3RhdGUubmVlZFJlYWRhYmxlLCBzdGF0ZS5lbWl0dGVkUmVhZGFibGUpOwogICAgc3RhdGUubmVlZFJlYWRhYmxlID0gZmFsc2U7CiAgICBpZiAoIXN0YXRlLmVtaXR0ZWRSZWFkYWJsZSkgewogICAgICBkZWJ1ZygnZW1pdFJlYWRhYmxlJywgc3RhdGUuZmxvd2luZyk7CiAgICAgIHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdFJlYWRhYmxlXywgc3RyZWFtKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZW1pdFJlYWRhYmxlXyhzdHJlYW0pIHsKICAgIGNvbnN0IHN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogICAgZGVidWcoJ2VtaXRSZWFkYWJsZV8nLCBzdGF0ZS5kZXN0cm95ZWQsIHN0YXRlLmxlbmd0aCwgc3RhdGUuZW5kZWQpOwogICAgaWYgKCFzdGF0ZS5kZXN0cm95ZWQgJiYgIXN0YXRlLmVycm9yZWQgJiYgKHN0YXRlLmxlbmd0aCB8fCBzdGF0ZS5lbmRlZCkpIHsKICAgICAgc3RyZWFtLmVtaXQoJ3JlYWRhYmxlJyk7CiAgICAgIHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSA9IGZhbHNlOwogICAgfQoKICAgIC8vIFRoZSBzdHJlYW0gbmVlZHMgYW5vdGhlciByZWFkYWJsZSBldmVudCBpZjoKICAgIC8vIDEuIEl0IGlzIG5vdCBmbG93aW5nLCBhcyB0aGUgZmxvdyBtZWNoYW5pc20gd2lsbCB0YWtlCiAgICAvLyAgICBjYXJlIG9mIGl0LgogICAgLy8gMi4gSXQgaXMgbm90IGVuZGVkLgogICAgLy8gMy4gSXQgaXMgYmVsb3cgdGhlIGhpZ2hXYXRlck1hcmssIHNvIHdlIGNhbiBzY2hlZHVsZQogICAgLy8gICAgYW5vdGhlciByZWFkYWJsZSBsYXRlci4KICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9ICFzdGF0ZS5mbG93aW5nICYmICFzdGF0ZS5lbmRlZCAmJiBzdGF0ZS5sZW5ndGggPD0gc3RhdGUuaGlnaFdhdGVyTWFyazsKICAgIGZsb3coc3RyZWFtKTsKICB9CgogIC8vIEF0IHRoaXMgcG9pbnQsIHRoZSB1c2VyIGhhcyBwcmVzdW1hYmx5IHNlZW4gdGhlICdyZWFkYWJsZScgZXZlbnQsCiAgLy8gYW5kIGNhbGxlZCByZWFkKCkgdG8gY29uc3VtZSBzb21lIGRhdGEuICB0aGF0IG1heSBoYXZlIHRyaWdnZXJlZAogIC8vIGluIHR1cm4gYW5vdGhlciBfcmVhZChuKSBjYWxsLCBpbiB3aGljaCBjYXNlIHJlYWRpbmcgPSB0cnVlIGlmCiAgLy8gaXQncyBpbiBwcm9ncmVzcy4KICAvLyBIb3dldmVyLCBpZiB3ZSdyZSBub3QgZW5kZWQsIG9yIHJlYWRpbmcsIGFuZCB0aGUgbGVuZ3RoIDwgaHdtLAogIC8vIHRoZW4gZ28gYWhlYWQgYW5kIHRyeSB0byByZWFkIHNvbWUgbW9yZSBwcmVlbXB0aXZlbHkuCiAgZnVuY3Rpb24gbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAoIXN0YXRlLnJlYWRpbmdNb3JlICYmIHN0YXRlLmNvbnN0cnVjdGVkKSB7CiAgICAgIHN0YXRlLnJlYWRpbmdNb3JlID0gdHJ1ZTsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhtYXliZVJlYWRNb3JlXywgc3RyZWFtLCBzdGF0ZSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIG1heWJlUmVhZE1vcmVfKHN0cmVhbSwgc3RhdGUpIHsKICAgIC8vIEF0dGVtcHQgdG8gcmVhZCBtb3JlIGRhdGEgaWYgd2Ugc2hvdWxkLgogICAgLy8KICAgIC8vIFRoZSBjb25kaXRpb25zIGZvciByZWFkaW5nIG1vcmUgZGF0YSBhcmUgKG9uZSBvZik6CiAgICAvLyAtIE5vdCBlbm91Z2ggZGF0YSBidWZmZXJlZCAoc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyaykuIFRoZSBsb29wCiAgICAvLyAgIGlzIHJlc3BvbnNpYmxlIGZvciBmaWxsaW5nIHRoZSBidWZmZXIgd2l0aCBlbm91Z2ggZGF0YSBpZiBzdWNoIGRhdGEKICAgIC8vICAgaXMgYXZhaWxhYmxlLiBJZiBoaWdoV2F0ZXJNYXJrIGlzIDAgYW5kIHdlIGFyZSBub3QgaW4gdGhlIGZsb3dpbmcgbW9kZQogICAgLy8gICB3ZSBzaG91bGQgX25vdF8gYXR0ZW1wdCB0byBidWZmZXIgYW55IGV4dHJhIGRhdGEuIFdlJ2xsIGdldCBtb3JlIGRhdGEKICAgIC8vICAgd2hlbiB0aGUgc3RyZWFtIGNvbnN1bWVyIGNhbGxzIHJlYWQoKSBpbnN0ZWFkLgogICAgLy8gLSBObyBkYXRhIGluIHRoZSBidWZmZXIsIGFuZCB0aGUgc3RyZWFtIGlzIGluIGZsb3dpbmcgbW9kZS4gSW4gdGhpcyBtb2RlCiAgICAvLyAgIHRoZSBsb29wIGJlbG93IGlzIHJlc3BvbnNpYmxlIGZvciBlbnN1cmluZyByZWFkKCkgaXMgY2FsbGVkLiBGYWlsaW5nIHRvCiAgICAvLyAgIGNhbGwgcmVhZCBoZXJlIHdvdWxkIGFib3J0IHRoZSBmbG93IGFuZCB0aGVyZSdzIG5vIG90aGVyIG1lY2hhbmlzbSBmb3IKICAgIC8vICAgY29udGludWluZyB0aGUgZmxvdyBpZiB0aGUgc3RyZWFtIGNvbnN1bWVyIGhhcyBqdXN0IHN1YnNjcmliZWQgdG8gdGhlCiAgICAvLyAgICdkYXRhJyBldmVudC4KICAgIC8vCiAgICAvLyBJbiBhZGRpdGlvbiB0byB0aGUgYWJvdmUgY29uZGl0aW9ucyB0byBrZWVwIHJlYWRpbmcgZGF0YSwgdGhlIGZvbGxvd2luZwogICAgLy8gY29uZGl0aW9ucyBwcmV2ZW50IHRoZSBkYXRhIGZyb20gYmVpbmcgcmVhZDoKICAgIC8vIC0gVGhlIHN0cmVhbSBoYXMgZW5kZWQgKHN0YXRlLmVuZGVkKS4KICAgIC8vIC0gVGhlcmUgaXMgYWxyZWFkeSBhIHBlbmRpbmcgJ3JlYWQnIG9wZXJhdGlvbiAoc3RhdGUucmVhZGluZykuIFRoaXMgaXMgYQogICAgLy8gICBjYXNlIHdoZXJlIHRoZSBzdHJlYW0gaGFzIGNhbGxlZCB0aGUgaW1wbGVtZW50YXRpb24gZGVmaW5lZCBfcmVhZCgpCiAgICAvLyAgIG1ldGhvZCwgYnV0IHRoZXkgYXJlIHByb2Nlc3NpbmcgdGhlIGNhbGwgYXN5bmNocm9ub3VzbHkgYW5kIGhhdmUgX25vdF8KICAgIC8vICAgY2FsbGVkIHB1c2goKSB3aXRoIG5ldyBkYXRhLiBJbiB0aGlzIGNhc2Ugd2Ugc2tpcCBwZXJmb3JtaW5nIG1vcmUKICAgIC8vICAgcmVhZCgpcy4gVGhlIGV4ZWN1dGlvbiBlbmRzIGluIHRoaXMgbWV0aG9kIGFnYWluIGFmdGVyIHRoZSBfcmVhZCgpIGVuZHMKICAgIC8vICAgdXAgY2FsbGluZyBwdXNoKCkgd2l0aCBtb3JlIGRhdGEuCiAgICB3aGlsZSAoIXN0YXRlLnJlYWRpbmcgJiYgIXN0YXRlLmVuZGVkICYmIChzdGF0ZS5sZW5ndGggPCBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmZsb3dpbmcgJiYgc3RhdGUubGVuZ3RoID09PSAwKSkgewogICAgICBjb25zdCBsZW4gPSBzdGF0ZS5sZW5ndGg7CiAgICAgIGRlYnVnKCdtYXliZVJlYWRNb3JlIHJlYWQgMCcpOwogICAgICBzdHJlYW0ucmVhZCgwKTsKICAgICAgaWYgKGxlbiA9PT0gc3RhdGUubGVuZ3RoKQogICAgICAgIC8vIERpZG4ndCBnZXQgYW55IGRhdGEsIHN0b3Agc3Bpbm5pbmcuCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBzdGF0ZS5yZWFkaW5nTW9yZSA9IGZhbHNlOwogIH0KCiAgLy8gQWJzdHJhY3QgbWV0aG9kLiAgdG8gYmUgb3ZlcnJpZGRlbiBpbiBzcGVjaWZpYyBpbXBsZW1lbnRhdGlvbiBjbGFzc2VzLgogIC8vIGNhbGwgY2IoZXIsIGRhdGEpIHdoZXJlIGRhdGEgaXMgPD0gbiBpbiBsZW5ndGguCiAgLy8gZm9yIHZpcnR1YWwgKG5vbi1zdHJpbmcsIG5vbi1idWZmZXIpIHN0cmVhbXMsICJsZW5ndGgiIGlzIHNvbWV3aGF0CiAgLy8gYXJiaXRyYXJ5LCBhbmQgcGVyaGFwcyBub3QgdmVyeSBtZWFuaW5nZnVsLgogIFJlYWRhYmxlLnByb3RvdHlwZS5fcmVhZCA9IGZ1bmN0aW9uIChuKSB7CiAgICB0aHJvdyBuZXcgRVJSX01FVEhPRF9OT1RfSU1QTEVNRU5URUQoJ19yZWFkKCknKTsKICB9OwogIFJlYWRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24gKGRlc3QsIHBpcGVPcHRzKSB7CiAgICBjb25zdCBzcmMgPSB0aGlzOwogICAgY29uc3Qgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKHN0YXRlLnBpcGVzLmxlbmd0aCA9PT0gMSkgewogICAgICBpZiAoIXN0YXRlLm11bHRpQXdhaXREcmFpbikgewogICAgICAgIHN0YXRlLm11bHRpQXdhaXREcmFpbiA9IHRydWU7CiAgICAgICAgc3RhdGUuYXdhaXREcmFpbldyaXRlcnMgPSBuZXcgU2FmZVNldChzdGF0ZS5hd2FpdERyYWluV3JpdGVycyA/IFtzdGF0ZS5hd2FpdERyYWluV3JpdGVyc10gOiBbXSk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlLnBpcGVzLnB1c2goZGVzdCk7CiAgICBkZWJ1ZygncGlwZSBjb3VudD0lZCBvcHRzPSVqJywgc3RhdGUucGlwZXMubGVuZ3RoLCBwaXBlT3B0cyk7CiAgICBjb25zdCBkb0VuZCA9ICghcGlwZU9wdHMgfHwgcGlwZU9wdHMuZW5kICE9PSBmYWxzZSkgJiYgZGVzdCAhPT0gcHJvY2Vzcy5zdGRvdXQgJiYgZGVzdCAhPT0gcHJvY2Vzcy5zdGRlcnI7CiAgICBjb25zdCBlbmRGbiA9IGRvRW5kID8gb25lbmQgOiB1bnBpcGU7CiAgICBpZiAoc3RhdGUuZW5kRW1pdHRlZCkgcHJvY2Vzcy5uZXh0VGljayhlbmRGbik7ZWxzZSBzcmMub25jZSgnZW5kJywgZW5kRm4pOwogICAgZGVzdC5vbigndW5waXBlJywgb251bnBpcGUpOwogICAgZnVuY3Rpb24gb251bnBpcGUocmVhZGFibGUsIHVucGlwZUluZm8pIHsKICAgICAgZGVidWcoJ29udW5waXBlJyk7CiAgICAgIGlmIChyZWFkYWJsZSA9PT0gc3JjKSB7CiAgICAgICAgaWYgKHVucGlwZUluZm8gJiYgdW5waXBlSW5mby5oYXNVbnBpcGVkID09PSBmYWxzZSkgewogICAgICAgICAgdW5waXBlSW5mby5oYXNVbnBpcGVkID0gdHJ1ZTsKICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG9uZW5kKCkgewogICAgICBkZWJ1Zygnb25lbmQnKTsKICAgICAgZGVzdC5lbmQoKTsKICAgIH0KICAgIGxldCBvbmRyYWluOwogICAgbGV0IGNsZWFuZWRVcCA9IGZhbHNlOwogICAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgICAgZGVidWcoJ2NsZWFudXAnKTsKICAgICAgLy8gQ2xlYW51cCBldmVudCBoYW5kbGVycyBvbmNlIHRoZSBwaXBlIGlzIGJyb2tlbi4KICAgICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZmluaXNoJywgb25maW5pc2gpOwogICAgICBpZiAob25kcmFpbikgewogICAgICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2RyYWluJywgb25kcmFpbik7CiAgICAgIH0KICAgICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKTsKICAgICAgZGVzdC5yZW1vdmVMaXN0ZW5lcigndW5waXBlJywgb251bnBpcGUpOwogICAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgICAgc3JjLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCB1bnBpcGUpOwogICAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwogICAgICBjbGVhbmVkVXAgPSB0cnVlOwoKICAgICAgLy8gSWYgdGhlIHJlYWRlciBpcyB3YWl0aW5nIGZvciBhIGRyYWluIGV2ZW50IGZyb20gdGhpcwogICAgICAvLyBzcGVjaWZpYyB3cml0ZXIsIHRoZW4gaXQgd291bGQgY2F1c2UgaXQgdG8gbmV2ZXIgc3RhcnQKICAgICAgLy8gZmxvd2luZyBhZ2Fpbi4KICAgICAgLy8gU28sIGlmIHRoaXMgaXMgYXdhaXRpbmcgYSBkcmFpbiwgdGhlbiB3ZSBqdXN0IGNhbGwgaXQgbm93LgogICAgICAvLyBJZiB3ZSBkb24ndCBrbm93LCB0aGVuIGFzc3VtZSB0aGF0IHdlIGFyZSB3YWl0aW5nIGZvciBvbmUuCiAgICAgIGlmIChvbmRyYWluICYmIHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzICYmICghZGVzdC5fd3JpdGFibGVTdGF0ZSB8fCBkZXN0Ll93cml0YWJsZVN0YXRlLm5lZWREcmFpbikpIG9uZHJhaW4oKTsKICAgIH0KICAgIGZ1bmN0aW9uIHBhdXNlKCkgewogICAgICAvLyBJZiB0aGUgdXNlciB1bnBpcGVkIGR1cmluZyBgZGVzdC53cml0ZSgpYCwgaXQgaXMgcG9zc2libGUKICAgICAgLy8gdG8gZ2V0IHN0dWNrIGluIGEgcGVybWFuZW50bHkgcGF1c2VkIHN0YXRlIGlmIHRoYXQgd3JpdGUKICAgICAgLy8gYWxzbyByZXR1cm5lZCBmYWxzZS4KICAgICAgLy8gPT4gQ2hlY2sgd2hldGhlciBgZGVzdGAgaXMgc3RpbGwgYSBwaXBpbmcgZGVzdGluYXRpb24uCiAgICAgIGlmICghY2xlYW5lZFVwKSB7CiAgICAgICAgaWYgKHN0YXRlLnBpcGVzLmxlbmd0aCA9PT0gMSAmJiBzdGF0ZS5waXBlc1swXSA9PT0gZGVzdCkgewogICAgICAgICAgZGVidWcoJ2ZhbHNlIHdyaXRlIHJlc3BvbnNlLCBwYXVzZScsIDApOwogICAgICAgICAgc3RhdGUuYXdhaXREcmFpbldyaXRlcnMgPSBkZXN0OwogICAgICAgICAgc3RhdGUubXVsdGlBd2FpdERyYWluID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5waXBlcy5sZW5ndGggPiAxICYmIHN0YXRlLnBpcGVzLmluY2x1ZGVzKGRlc3QpKSB7CiAgICAgICAgICBkZWJ1ZygnZmFsc2Ugd3JpdGUgcmVzcG9uc2UsIHBhdXNlJywgc3RhdGUuYXdhaXREcmFpbldyaXRlcnMuc2l6ZSk7CiAgICAgICAgICBzdGF0ZS5hd2FpdERyYWluV3JpdGVycy5hZGQoZGVzdCk7CiAgICAgICAgfQogICAgICAgIHNyYy5wYXVzZSgpOwogICAgICB9CiAgICAgIGlmICghb25kcmFpbikgewogICAgICAgIC8vIFdoZW4gdGhlIGRlc3QgZHJhaW5zLCBpdCByZWR1Y2VzIHRoZSBhd2FpdERyYWluIGNvdW50ZXIKICAgICAgICAvLyBvbiB0aGUgc291cmNlLiAgVGhpcyB3b3VsZCBiZSBtb3JlIGVsZWdhbnQgd2l0aCBhIC5vbmNlKCkKICAgICAgICAvLyBoYW5kbGVyIGluIGZsb3coKSwgYnV0IGFkZGluZyBhbmQgcmVtb3ZpbmcgcmVwZWF0ZWRseSBpcwogICAgICAgIC8vIHRvbyBzbG93LgogICAgICAgIG9uZHJhaW4gPSBwaXBlT25EcmFpbihzcmMsIGRlc3QpOwogICAgICAgIGRlc3Qub24oJ2RyYWluJywgb25kcmFpbik7CiAgICAgIH0KICAgIH0KICAgIHNyYy5vbignZGF0YScsIG9uZGF0YSk7CiAgICBmdW5jdGlvbiBvbmRhdGEoY2h1bmspIHsKICAgICAgZGVidWcoJ29uZGF0YScpOwogICAgICBjb25zdCByZXQgPSBkZXN0LndyaXRlKGNodW5rKTsKICAgICAgZGVidWcoJ2Rlc3Qud3JpdGUnLCByZXQpOwogICAgICBpZiAocmV0ID09PSBmYWxzZSkgewogICAgICAgIHBhdXNlKCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBJZiB0aGUgZGVzdCBoYXMgYW4gZXJyb3IsIHRoZW4gc3RvcCBwaXBpbmcgaW50byBpdC4KICAgIC8vIEhvd2V2ZXIsIGRvbid0IHN1cHByZXNzIHRoZSB0aHJvd2luZyBiZWhhdmlvciBmb3IgdGhpcy4KICAgIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgICAgZGVidWcoJ29uZXJyb3InLCBlcik7CiAgICAgIHVucGlwZSgpOwogICAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwogICAgICBpZiAoZGVzdC5saXN0ZW5lckNvdW50KCdlcnJvcicpID09PSAwKSB7CiAgICAgICAgY29uc3QgcyA9IGRlc3QuX3dyaXRhYmxlU3RhdGUgfHwgZGVzdC5fcmVhZGFibGVTdGF0ZTsKICAgICAgICBpZiAocyAmJiAhcy5lcnJvckVtaXR0ZWQpIHsKICAgICAgICAgIC8vIFVzZXIgaW5jb3JyZWN0bHkgZW1pdHRlZCAnZXJyb3InIGRpcmVjdGx5IG9uIHRoZSBzdHJlYW0uCiAgICAgICAgICBlcnJvck9yRGVzdHJveShkZXN0LCBlcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlc3QuZW1pdCgnZXJyb3InLCBlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gTWFrZSBzdXJlIG91ciBlcnJvciBoYW5kbGVyIGlzIGF0dGFjaGVkIGJlZm9yZSB1c2VybGFuZCBvbmVzLgogICAgcHJlcGVuZExpc3RlbmVyKGRlc3QsICdlcnJvcicsIG9uZXJyb3IpOwoKICAgIC8vIEJvdGggY2xvc2UgYW5kIGZpbmlzaCBzaG91bGQgdHJpZ2dlciB1bnBpcGUsIGJ1dCBvbmx5IG9uY2UuCiAgICBmdW5jdGlvbiBvbmNsb3NlKCkgewogICAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdmaW5pc2gnLCBvbmZpbmlzaCk7CiAgICAgIHVucGlwZSgpOwogICAgfQogICAgZGVzdC5vbmNlKCdjbG9zZScsIG9uY2xvc2UpOwogICAgZnVuY3Rpb24gb25maW5pc2goKSB7CiAgICAgIGRlYnVnKCdvbmZpbmlzaCcpOwogICAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpOwogICAgICB1bnBpcGUoKTsKICAgIH0KICAgIGRlc3Qub25jZSgnZmluaXNoJywgb25maW5pc2gpOwogICAgZnVuY3Rpb24gdW5waXBlKCkgewogICAgICBkZWJ1ZygndW5waXBlJyk7CiAgICAgIHNyYy51bnBpcGUoZGVzdCk7CiAgICB9CgogICAgLy8gVGVsbCB0aGUgZGVzdCB0aGF0IGl0J3MgYmVpbmcgcGlwZWQgdG8uCiAgICBkZXN0LmVtaXQoJ3BpcGUnLCBzcmMpOwoKICAgIC8vIFN0YXJ0IHRoZSBmbG93IGlmIGl0IGhhc24ndCBiZWVuIHN0YXJ0ZWQgYWxyZWFkeS4KCiAgICBpZiAoZGVzdC53cml0YWJsZU5lZWREcmFpbiA9PT0gdHJ1ZSkgewogICAgICBwYXVzZSgpOwogICAgfSBlbHNlIGlmICghc3RhdGUuZmxvd2luZykgewogICAgICBkZWJ1ZygncGlwZSByZXN1bWUnKTsKICAgICAgc3JjLnJlc3VtZSgpOwogICAgfQogICAgcmV0dXJuIGRlc3Q7CiAgfTsKICBmdW5jdGlvbiBwaXBlT25EcmFpbihzcmMsIGRlc3QpIHsKICAgIHJldHVybiBmdW5jdGlvbiBwaXBlT25EcmFpbkZ1bmN0aW9uUmVzdWx0KCkgewogICAgICBjb25zdCBzdGF0ZSA9IHNyYy5fcmVhZGFibGVTdGF0ZTsKCiAgICAgIC8vIGBvbmRyYWluYCB3aWxsIGNhbGwgZGlyZWN0bHksCiAgICAgIC8vIGB0aGlzYCBtYXliZSBub3QgYSByZWZlcmVuY2UgdG8gZGVzdCwKICAgICAgLy8gc28gd2UgdXNlIHRoZSByZWFsIGRlc3QgaGVyZS4KICAgICAgaWYgKHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzID09PSBkZXN0KSB7CiAgICAgICAgZGVidWcoJ3BpcGVPbkRyYWluJywgMSk7CiAgICAgICAgc3RhdGUuYXdhaXREcmFpbldyaXRlcnMgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKHN0YXRlLm11bHRpQXdhaXREcmFpbikgewogICAgICAgIGRlYnVnKCdwaXBlT25EcmFpbicsIHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzLnNpemUpOwogICAgICAgIHN0YXRlLmF3YWl0RHJhaW5Xcml0ZXJzLmRlbGV0ZShkZXN0KTsKICAgICAgfQogICAgICBpZiAoKCFzdGF0ZS5hd2FpdERyYWluV3JpdGVycyB8fCBzdGF0ZS5hd2FpdERyYWluV3JpdGVycy5zaXplID09PSAwKSAmJiBzcmMubGlzdGVuZXJDb3VudCgnZGF0YScpKSB7CiAgICAgICAgc3JjLnJlc3VtZSgpOwogICAgICB9CiAgICB9OwogIH0KICBSZWFkYWJsZS5wcm90b3R5cGUudW5waXBlID0gZnVuY3Rpb24gKGRlc3QpIHsKICAgIGNvbnN0IHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IHVucGlwZUluZm8gPSB7CiAgICAgIGhhc1VucGlwZWQ6IGZhbHNlCiAgICB9OwoKICAgIC8vIElmIHdlJ3JlIG5vdCBwaXBpbmcgYW55d2hlcmUsIHRoZW4gZG8gbm90aGluZy4KICAgIGlmIChzdGF0ZS5waXBlcy5sZW5ndGggPT09IDApIHJldHVybiB0aGlzOwogICAgaWYgKCFkZXN0KSB7CiAgICAgIC8vIHJlbW92ZSBhbGwuCiAgICAgIGNvbnN0IGRlc3RzID0gc3RhdGUucGlwZXM7CiAgICAgIHN0YXRlLnBpcGVzID0gW107CiAgICAgIHRoaXMucGF1c2UoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXN0cy5sZW5ndGg7IGkrKykgZGVzdHNbaV0uZW1pdCgndW5waXBlJywgdGhpcywgewogICAgICAgIGhhc1VucGlwZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvLyBUcnkgdG8gZmluZCB0aGUgcmlnaHQgb25lLgogICAgY29uc3QgaW5kZXggPSBBcnJheVByb3RvdHlwZUluZGV4T2Yoc3RhdGUucGlwZXMsIGRlc3QpOwogICAgaWYgKGluZGV4ID09PSAtMSkgcmV0dXJuIHRoaXM7CiAgICBzdGF0ZS5waXBlcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgaWYgKHN0YXRlLnBpcGVzLmxlbmd0aCA9PT0gMCkgdGhpcy5wYXVzZSgpOwogICAgZGVzdC5lbWl0KCd1bnBpcGUnLCB0aGlzLCB1bnBpcGVJbmZvKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFNldCB1cCBkYXRhIGV2ZW50cyBpZiB0aGV5IGFyZSBhc2tlZCBmb3IKICAvLyBFbnN1cmUgcmVhZGFibGUgbGlzdGVuZXJzIGV2ZW50dWFsbHkgZ2V0IHNvbWV0aGluZy4KICBSZWFkYWJsZS5wcm90b3R5cGUub24gPSBmdW5jdGlvbiAoZXYsIGZuKSB7CiAgICBjb25zdCByZXMgPSBTdHJlYW0ucHJvdG90eXBlLm9uLmNhbGwodGhpcywgZXYsIGZuKTsKICAgIGNvbnN0IHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICAgIGlmIChldiA9PT0gJ2RhdGEnKSB7CiAgICAgIC8vIFVwZGF0ZSByZWFkYWJsZUxpc3RlbmluZyBzbyB0aGF0IHJlc3VtZSgpIG1heSBiZSBhIG5vLW9wCiAgICAgIC8vIGEgZmV3IGxpbmVzIGRvd24uIFRoaXMgaXMgbmVlZGVkIHRvIHN1cHBvcnQgb25jZSgncmVhZGFibGUnKS4KICAgICAgc3RhdGUucmVhZGFibGVMaXN0ZW5pbmcgPSB0aGlzLmxpc3RlbmVyQ291bnQoJ3JlYWRhYmxlJykgPiAwOwoKICAgICAgLy8gVHJ5IHN0YXJ0IGZsb3dpbmcgb24gbmV4dCB0aWNrIGlmIHN0cmVhbSBpc24ndCBleHBsaWNpdGx5IHBhdXNlZC4KICAgICAgaWYgKHN0YXRlLmZsb3dpbmcgIT09IGZhbHNlKSB0aGlzLnJlc3VtZSgpOwogICAgfSBlbHNlIGlmIChldiA9PT0gJ3JlYWRhYmxlJykgewogICAgICBpZiAoIXN0YXRlLmVuZEVtaXR0ZWQgJiYgIXN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nKSB7CiAgICAgICAgc3RhdGUucmVhZGFibGVMaXN0ZW5pbmcgPSBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgICAgIHN0YXRlLmZsb3dpbmcgPSBmYWxzZTsKICAgICAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSBmYWxzZTsKICAgICAgICBkZWJ1Zygnb24gcmVhZGFibGUnLCBzdGF0ZS5sZW5ndGgsIHN0YXRlLnJlYWRpbmcpOwogICAgICAgIGlmIChzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgIGVtaXRSZWFkYWJsZSh0aGlzKTsKICAgICAgICB9IGVsc2UgaWYgKCFzdGF0ZS5yZWFkaW5nKSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKG5SZWFkaW5nTmV4dFRpY2ssIHRoaXMpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlczsKICB9OwogIFJlYWRhYmxlLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IFJlYWRhYmxlLnByb3RvdHlwZS5vbjsKICBSZWFkYWJsZS5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAoZXYsIGZuKSB7CiAgICBjb25zdCByZXMgPSBTdHJlYW0ucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyLmNhbGwodGhpcywgZXYsIGZuKTsKICAgIGlmIChldiA9PT0gJ3JlYWRhYmxlJykgewogICAgICAvLyBXZSBuZWVkIHRvIGNoZWNrIGlmIHRoZXJlIGlzIHNvbWVvbmUgc3RpbGwgbGlzdGVuaW5nIHRvCiAgICAgIC8vIHJlYWRhYmxlIGFuZCByZXNldCB0aGUgc3RhdGUuIEhvd2V2ZXIgdGhpcyBuZWVkcyB0byBoYXBwZW4KICAgICAgLy8gYWZ0ZXIgcmVhZGFibGUgaGFzIGJlZW4gZW1pdHRlZCBidXQgYmVmb3JlIEkvTyAobmV4dFRpY2spIHRvCiAgICAgIC8vIHN1cHBvcnQgb25jZSgncmVhZGFibGUnLCBmbikgY3ljbGVzLiBUaGlzIG1lYW5zIHRoYXQgY2FsbGluZwogICAgICAvLyByZXN1bWUgd2l0aGluIHRoZSBzYW1lIHRpY2sgd2lsbCBoYXZlIG5vCiAgICAgIC8vIGVmZmVjdC4KICAgICAgcHJvY2Vzcy5uZXh0VGljayh1cGRhdGVSZWFkYWJsZUxpc3RlbmluZywgdGhpcyk7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH07CiAgUmVhZGFibGUucHJvdG90eXBlLm9mZiA9IFJlYWRhYmxlLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICBSZWFkYWJsZS5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gKGV2KSB7CiAgICBjb25zdCByZXMgPSBTdHJlYW0ucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKGV2ID09PSAncmVhZGFibGUnIHx8IGV2ID09PSB1bmRlZmluZWQpIHsKICAgICAgLy8gV2UgbmVlZCB0byBjaGVjayBpZiB0aGVyZSBpcyBzb21lb25lIHN0aWxsIGxpc3RlbmluZyB0bwogICAgICAvLyByZWFkYWJsZSBhbmQgcmVzZXQgdGhlIHN0YXRlLiBIb3dldmVyIHRoaXMgbmVlZHMgdG8gaGFwcGVuCiAgICAgIC8vIGFmdGVyIHJlYWRhYmxlIGhhcyBiZWVuIGVtaXR0ZWQgYnV0IGJlZm9yZSBJL08gKG5leHRUaWNrKSB0bwogICAgICAvLyBzdXBwb3J0IG9uY2UoJ3JlYWRhYmxlJywgZm4pIGN5Y2xlcy4gVGhpcyBtZWFucyB0aGF0IGNhbGxpbmcKICAgICAgLy8gcmVzdW1lIHdpdGhpbiB0aGUgc2FtZSB0aWNrIHdpbGwgaGF2ZSBubwogICAgICAvLyBlZmZlY3QuCiAgICAgIHByb2Nlc3MubmV4dFRpY2sodXBkYXRlUmVhZGFibGVMaXN0ZW5pbmcsIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9OwogIGZ1bmN0aW9uIHVwZGF0ZVJlYWRhYmxlTGlzdGVuaW5nKHNlbGYpIHsKICAgIGNvbnN0IHN0YXRlID0gc2VsZi5fcmVhZGFibGVTdGF0ZTsKICAgIHN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nID0gc2VsZi5saXN0ZW5lckNvdW50KCdyZWFkYWJsZScpID4gMDsKICAgIGlmIChzdGF0ZS5yZXN1bWVTY2hlZHVsZWQgJiYgc3RhdGVba1BhdXNlZF0gPT09IGZhbHNlKSB7CiAgICAgIC8vIEZsb3dpbmcgbmVlZHMgdG8gYmUgc2V0IHRvIHRydWUgbm93LCBvdGhlcndpc2UKICAgICAgLy8gdGhlIHVwY29taW5nIHJlc3VtZSB3aWxsIG5vdCBmbG93LgogICAgICBzdGF0ZS5mbG93aW5nID0gdHJ1ZTsKCiAgICAgIC8vIENydWRlIHdheSB0byBjaGVjayBpZiB3ZSBzaG91bGQgcmVzdW1lLgogICAgfSBlbHNlIGlmIChzZWxmLmxpc3RlbmVyQ291bnQoJ2RhdGEnKSA+IDApIHsKICAgICAgc2VsZi5yZXN1bWUoKTsKICAgIH0gZWxzZSBpZiAoIXN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nKSB7CiAgICAgIHN0YXRlLmZsb3dpbmcgPSBudWxsOwogICAgfQogIH0KICBmdW5jdGlvbiBuUmVhZGluZ05leHRUaWNrKHNlbGYpIHsKICAgIGRlYnVnKCdyZWFkYWJsZSBuZXh0dGljayByZWFkIDAnKTsKICAgIHNlbGYucmVhZCgwKTsKICB9CgogIC8vIHBhdXNlKCkgYW5kIHJlc3VtZSgpIGFyZSByZW1uYW50cyBvZiB0aGUgbGVnYWN5IHJlYWRhYmxlIHN0cmVhbSBBUEkKICAvLyBJZiB0aGUgdXNlciB1c2VzIHRoZW0sIHRoZW4gc3dpdGNoIGludG8gb2xkIG1vZGUuCiAgUmVhZGFibGUucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbnN0IHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICAgIGlmICghc3RhdGUuZmxvd2luZykgewogICAgICBkZWJ1ZygncmVzdW1lJyk7CiAgICAgIC8vIFdlIGZsb3cgb25seSBpZiB0aGVyZSBpcyBubyBvbmUgbGlzdGVuaW5nCiAgICAgIC8vIGZvciByZWFkYWJsZSwgYnV0IHdlIHN0aWxsIGhhdmUgdG8gY2FsbAogICAgICAvLyByZXN1bWUoKS4KICAgICAgc3RhdGUuZmxvd2luZyA9ICFzdGF0ZS5yZWFkYWJsZUxpc3RlbmluZzsKICAgICAgcmVzdW1lKHRoaXMsIHN0YXRlKTsKICAgIH0KICAgIHN0YXRlW2tQYXVzZWRdID0gZmFsc2U7CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIHJlc3VtZShzdHJlYW0sIHN0YXRlKSB7CiAgICBpZiAoIXN0YXRlLnJlc3VtZVNjaGVkdWxlZCkgewogICAgICBzdGF0ZS5yZXN1bWVTY2hlZHVsZWQgPSB0cnVlOwogICAgICBwcm9jZXNzLm5leHRUaWNrKHJlc3VtZV8sIHN0cmVhbSwgc3RhdGUpOwogICAgfQogIH0KICBmdW5jdGlvbiByZXN1bWVfKHN0cmVhbSwgc3RhdGUpIHsKICAgIGRlYnVnKCdyZXN1bWUnLCBzdGF0ZS5yZWFkaW5nKTsKICAgIGlmICghc3RhdGUucmVhZGluZykgewogICAgICBzdHJlYW0ucmVhZCgwKTsKICAgIH0KICAgIHN0YXRlLnJlc3VtZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgc3RyZWFtLmVtaXQoJ3Jlc3VtZScpOwogICAgZmxvdyhzdHJlYW0pOwogICAgaWYgKHN0YXRlLmZsb3dpbmcgJiYgIXN0YXRlLnJlYWRpbmcpIHN0cmVhbS5yZWFkKDApOwogIH0KICBSZWFkYWJsZS5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbiAoKSB7CiAgICBkZWJ1ZygnY2FsbCBwYXVzZSBmbG93aW5nPSVqJywgdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nKTsKICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlLmZsb3dpbmcgIT09IGZhbHNlKSB7CiAgICAgIGRlYnVnKCdwYXVzZScpOwogICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmZsb3dpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5lbWl0KCdwYXVzZScpOwogICAgfQogICAgdGhpcy5fcmVhZGFibGVTdGF0ZVtrUGF1c2VkXSA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIGZsb3coc3RyZWFtKSB7CiAgICBjb25zdCBzdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgIGRlYnVnKCdmbG93Jywgc3RhdGUuZmxvd2luZyk7CiAgICB3aGlsZSAoc3RhdGUuZmxvd2luZyAmJiBzdHJlYW0ucmVhZCgpICE9PSBudWxsKTsKICB9CgogIC8vIFdyYXAgYW4gb2xkLXN0eWxlIHN0cmVhbSBhcyB0aGUgYXN5bmMgZGF0YSBzb3VyY2UuCiAgLy8gVGhpcyBpcyAqbm90KiBwYXJ0IG9mIHRoZSByZWFkYWJsZSBzdHJlYW0gaW50ZXJmYWNlLgogIC8vIEl0IGlzIGFuIHVnbHkgdW5mb3J0dW5hdGUgbWVzcyBvZiBoaXN0b3J5LgogIFJlYWRhYmxlLnByb3RvdHlwZS53cmFwID0gZnVuY3Rpb24gKHN0cmVhbSkgewogICAgbGV0IHBhdXNlZCA9IGZhbHNlOwoKICAgIC8vIFRPRE8gKHJvbmFnKTogU2hvdWxkIHRoaXMuZGVzdHJveShlcnIpIGVtaXQKICAgIC8vICdlcnJvcicgb24gdGhlIHdyYXBwZWQgc3RyZWFtPyBXb3VsZCByZXF1aXJlCiAgICAvLyBhIHN0YXRpYyBmYWN0b3J5IG1ldGhvZCwgZS5nLiBSZWFkYWJsZS53cmFwKHN0cmVhbSkuCgogICAgc3RyZWFtLm9uKCdkYXRhJywgY2h1bmsgPT4gewogICAgICBpZiAoIXRoaXMucHVzaChjaHVuaykgJiYgc3RyZWFtLnBhdXNlKSB7CiAgICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgICBzdHJlYW0ucGF1c2UoKTsKICAgICAgfQogICAgfSk7CiAgICBzdHJlYW0ub24oJ2VuZCcsICgpID0+IHsKICAgICAgdGhpcy5wdXNoKG51bGwpOwogICAgfSk7CiAgICBzdHJlYW0ub24oJ2Vycm9yJywgZXJyID0+IHsKICAgICAgZXJyb3JPckRlc3Ryb3kodGhpcywgZXJyKTsKICAgIH0pOwogICAgc3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICB9KTsKICAgIHN0cmVhbS5vbignZGVzdHJveScsICgpID0+IHsKICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICB9KTsKICAgIHRoaXMuX3JlYWQgPSAoKSA9PiB7CiAgICAgIGlmIChwYXVzZWQgJiYgc3RyZWFtLnJlc3VtZSkgewogICAgICAgIHBhdXNlZCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5yZXN1bWUoKTsKICAgICAgfQogICAgfTsKCiAgICAvLyBQcm94eSBhbGwgdGhlIG90aGVyIG1ldGhvZHMuIEltcG9ydGFudCB3aGVuIHdyYXBwaW5nIGZpbHRlcnMgYW5kIGR1cGxleGVzLgogICAgY29uc3Qgc3RyZWFtS2V5cyA9IE9iamVjdEtleXMoc3RyZWFtKTsKICAgIGZvciAobGV0IGogPSAxOyBqIDwgc3RyZWFtS2V5cy5sZW5ndGg7IGorKykgewogICAgICBjb25zdCBpID0gc3RyZWFtS2V5c1tqXTsKICAgICAgaWYgKHRoaXNbaV0gPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygc3RyZWFtW2ldID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpc1tpXSA9IHN0cmVhbVtpXS5iaW5kKHN0cmVhbSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CiAgUmVhZGFibGUucHJvdG90eXBlW1N5bWJvbEFzeW5jSXRlcmF0b3JdID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHN0cmVhbVRvQXN5bmNJdGVyYXRvcih0aGlzKTsKICB9OwogIFJlYWRhYmxlLnByb3RvdHlwZS5pdGVyYXRvciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbGlkYXRlT2JqZWN0KG9wdGlvbnMsICdvcHRpb25zJyk7CiAgICB9CiAgICByZXR1cm4gc3RyZWFtVG9Bc3luY0l0ZXJhdG9yKHRoaXMsIG9wdGlvbnMpOwogIH07CiAgZnVuY3Rpb24gc3RyZWFtVG9Bc3luY0l0ZXJhdG9yKHN0cmVhbSwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBzdHJlYW0ucmVhZCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICBzdHJlYW0gPSBSZWFkYWJsZS53cmFwKHN0cmVhbSwgewogICAgICAgIG9iamVjdE1vZGU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBpdGVyID0gY3JlYXRlQXN5bmNJdGVyYXRvcihzdHJlYW0sIG9wdGlvbnMpOwogICAgaXRlci5zdHJlYW0gPSBzdHJlYW07CiAgICByZXR1cm4gaXRlcjsKICB9CiAgYXN5bmMgZnVuY3Rpb24qIGNyZWF0ZUFzeW5jSXRlcmF0b3Ioc3RyZWFtLCBvcHRpb25zKSB7CiAgICBsZXQgY2FsbGJhY2sgPSBub3A7CiAgICBmdW5jdGlvbiBuZXh0KHJlc29sdmUpIHsKICAgICAgaWYgKHRoaXMgPT09IHN0cmVhbSkgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgY2FsbGJhY2sgPSBub3A7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSByZXNvbHZlOwogICAgICB9CiAgICB9CiAgICBzdHJlYW0ub24oJ3JlYWRhYmxlJywgbmV4dCk7CiAgICBsZXQgZXJyb3I7CiAgICBjb25zdCBjbGVhbnVwID0gZW9zKHN0cmVhbSwgewogICAgICB3cml0YWJsZTogZmFsc2UKICAgIH0sIGVyciA9PiB7CiAgICAgIGVycm9yID0gZXJyID8gYWdncmVnYXRlVHdvRXJyb3JzKGVycm9yLCBlcnIpIDogbnVsbDsKICAgICAgY2FsbGJhY2soKTsKICAgICAgY2FsbGJhY2sgPSBub3A7CiAgICB9KTsKICAgIHRyeSB7CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3QgY2h1bmsgPSBzdHJlYW0uZGVzdHJveWVkID8gbnVsbCA6IHN0cmVhbS5yZWFkKCk7CiAgICAgICAgaWYgKGNodW5rICE9PSBudWxsKSB7CiAgICAgICAgICB5aWVsZCBjaHVuazsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKG5leHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGVycm9yID0gYWdncmVnYXRlVHdvRXJyb3JzKGVycm9yLCBlcnIpOwogICAgICB0aHJvdyBlcnJvcjsKICAgIH0gZmluYWxseSB7CiAgICAgIGlmICgoZXJyb3IgfHwgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3B0aW9ucy5kZXN0cm95T25SZXR1cm4pICE9PSBmYWxzZSkgJiYgKGVycm9yID09PSB1bmRlZmluZWQgfHwgc3RyZWFtLl9yZWFkYWJsZVN0YXRlLmF1dG9EZXN0cm95KSkgewogICAgICAgIGRlc3Ryb3lJbXBsLmRlc3Ryb3llcihzdHJlYW0sIG51bGwpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5vZmYoJ3JlYWRhYmxlJywgbmV4dCk7CiAgICAgICAgY2xlYW51cCgpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBNYWtpbmcgaXQgZXhwbGljaXQgdGhlc2UgcHJvcGVydGllcyBhcmUgbm90IGVudW1lcmFibGUKICAvLyBiZWNhdXNlIG90aGVyd2lzZSBzb21lIHByb3RvdHlwZSBtYW5pcHVsYXRpb24gaW4KICAvLyB1c2VybGFuZCB3aWxsIGZhaWwuCiAgT2JqZWN0RGVmaW5lUHJvcGVydGllcyhSZWFkYWJsZS5wcm90b3R5cGUsIHsKICAgIHJlYWRhYmxlOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZ2V0KCkgewogICAgICAgIGNvbnN0IHIgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgICAgIC8vIHIucmVhZGFibGUgPT09IGZhbHNlIG1lYW5zIHRoYXQgdGhpcyBpcyBwYXJ0IG9mIGEgRHVwbGV4IHN0cmVhbQogICAgICAgIC8vIHdoZXJlIHRoZSByZWFkYWJsZSBzaWRlIHdhcyBkaXNhYmxlZCB1cG9uIGNvbnN0cnVjdGlvbi4KICAgICAgICAvLyBDb21wYXQuIFRoZSB1c2VyIG1pZ2h0IG1hbnVhbGx5IGRpc2FibGUgcmVhZGFibGUgc2lkZSB0aHJvdWdoCiAgICAgICAgLy8gZGVwcmVjYXRlZCBzZXR0ZXIuCiAgICAgICAgcmV0dXJuICEhciAmJiByLnJlYWRhYmxlICE9PSBmYWxzZSAmJiAhci5kZXN0cm95ZWQgJiYgIXIuZXJyb3JFbWl0dGVkICYmICFyLmVuZEVtaXR0ZWQ7CiAgICAgIH0sCiAgICAgIHNldCh2YWwpIHsKICAgICAgICAvLyBCYWNrd2FyZHMgY29tcGF0LgogICAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlKSB7CiAgICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWRhYmxlID0gISF2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVhZGFibGVEaWRSZWFkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLmRhdGFFbWl0dGVkOwogICAgICB9CiAgICB9LAogICAgcmVhZGFibGVBYm9ydGVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAhISh0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWRhYmxlICE9PSBmYWxzZSAmJiAodGhpcy5fcmVhZGFibGVTdGF0ZS5kZXN0cm95ZWQgfHwgdGhpcy5fcmVhZGFibGVTdGF0ZS5lcnJvcmVkKSAmJiAhdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmRFbWl0dGVkKTsKICAgICAgfQogICAgfSwKICAgIHJlYWRhYmxlSGlnaFdhdGVyTWFyazogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrOwogICAgICB9CiAgICB9LAogICAgcmVhZGFibGVCdWZmZXI6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUgJiYgdGhpcy5fcmVhZGFibGVTdGF0ZS5idWZmZXI7CiAgICAgIH0KICAgIH0sCiAgICByZWFkYWJsZUZsb3dpbmc6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUuZmxvd2luZzsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZSkgewogICAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nID0gc3RhdGU7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVhZGFibGVMZW5ndGg6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLmxlbmd0aDsKICAgICAgfQogICAgfSwKICAgIHJlYWRhYmxlT2JqZWN0TW9kZTogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUgPyB0aGlzLl9yZWFkYWJsZVN0YXRlLm9iamVjdE1vZGUgOiBmYWxzZTsKICAgICAgfQogICAgfSwKICAgIHJlYWRhYmxlRW5jb2Rpbmc6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlID8gdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA6IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBlcnJvcmVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZSA/IHRoaXMuX3JlYWRhYmxlU3RhdGUuZXJyb3JlZCA6IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBjbG9zZWQ6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlYWRhYmxlU3RhdGUgPyB0aGlzLl9yZWFkYWJsZVN0YXRlLmNsb3NlZCA6IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgZGVzdHJveWVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZSA/IHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVzdHJveWVkIDogZmFsc2U7CiAgICAgIH0sCiAgICAgIHNldCh2YWx1ZSkgewogICAgICAgIC8vIFdlIGlnbm9yZSB0aGUgdmFsdWUgaWYgdGhlIHN0cmVhbQogICAgICAgIC8vIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCB5ZXQuCiAgICAgICAgaWYgKCF0aGlzLl9yZWFkYWJsZVN0YXRlKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBCYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB0aGUgdXNlciBpcyBleHBsaWNpdGx5CiAgICAgICAgLy8gbWFuYWdpbmcgZGVzdHJveWVkLgogICAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVzdHJveWVkID0gdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICByZWFkYWJsZUVuZGVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmVhZGFibGVTdGF0ZSA/IHRoaXMuX3JlYWRhYmxlU3RhdGUuZW5kRW1pdHRlZCA6IGZhbHNlOwogICAgICB9CiAgICB9CiAgfSk7CiAgT2JqZWN0RGVmaW5lUHJvcGVydGllcyhSZWFkYWJsZVN0YXRlLnByb3RvdHlwZSwgewogICAgLy8gTGVnYWN5IGdldHRlciBmb3IgYHBpcGVzQ291bnRgLgogICAgcGlwZXNDb3VudDogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5waXBlcy5sZW5ndGg7CiAgICAgIH0KICAgIH0sCiAgICAvLyBMZWdhY3kgcHJvcGVydHkgZm9yIGBwYXVzZWRgLgogICAgcGF1c2VkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzW2tQYXVzZWRdICE9PSBmYWxzZTsKICAgICAgfSwKICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgdGhpc1trUGF1c2VkXSA9ICEhdmFsdWU7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gRXhwb3NlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LgogIFJlYWRhYmxlLl9mcm9tTGlzdCA9IGZyb21MaXN0OwoKICAvLyBQbHVjayBvZmYgbiBieXRlcyBmcm9tIGFuIGFycmF5IG9mIGJ1ZmZlcnMuCiAgLy8gTGVuZ3RoIGlzIHRoZSBjb21iaW5lZCBsZW5ndGhzIG9mIGFsbCB0aGUgYnVmZmVycyBpbiB0aGUgbGlzdC4KICAvLyBUaGlzIGZ1bmN0aW9uIGlzIGRlc2lnbmVkIHRvIGJlIGlubGluYWJsZSwgc28gcGxlYXNlIHRha2UgY2FyZSB3aGVuIG1ha2luZwogIC8vIGNoYW5nZXMgdG8gdGhlIGZ1bmN0aW9uIGJvZHkuCiAgZnVuY3Rpb24gZnJvbUxpc3Qobiwgc3RhdGUpIHsKICAgIC8vIG5vdGhpbmcgYnVmZmVyZWQuCiAgICBpZiAoc3RhdGUubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDsKICAgIGxldCByZXQ7CiAgICBpZiAoc3RhdGUub2JqZWN0TW9kZSkgcmV0ID0gc3RhdGUuYnVmZmVyLnNoaWZ0KCk7ZWxzZSBpZiAoIW4gfHwgbiA+PSBzdGF0ZS5sZW5ndGgpIHsKICAgICAgLy8gUmVhZCBpdCBhbGwsIHRydW5jYXRlIHRoZSBsaXN0LgogICAgICBpZiAoc3RhdGUuZGVjb2RlcikgcmV0ID0gc3RhdGUuYnVmZmVyLmpvaW4oJycpO2Vsc2UgaWYgKHN0YXRlLmJ1ZmZlci5sZW5ndGggPT09IDEpIHJldCA9IHN0YXRlLmJ1ZmZlci5maXJzdCgpO2Vsc2UgcmV0ID0gc3RhdGUuYnVmZmVyLmNvbmNhdChzdGF0ZS5sZW5ndGgpOwogICAgICBzdGF0ZS5idWZmZXIuY2xlYXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHJlYWQgcGFydCBvZiBsaXN0LgogICAgICByZXQgPSBzdGF0ZS5idWZmZXIuY29uc3VtZShuLCBzdGF0ZS5kZWNvZGVyKTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGZ1bmN0aW9uIGVuZFJlYWRhYmxlKHN0cmVhbSkgewogICAgY29uc3Qgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgICBkZWJ1ZygnZW5kUmVhZGFibGUnLCBzdGF0ZS5lbmRFbWl0dGVkKTsKICAgIGlmICghc3RhdGUuZW5kRW1pdHRlZCkgewogICAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZW5kUmVhZGFibGVOVCwgc3RhdGUsIHN0cmVhbSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVuZFJlYWRhYmxlTlQoc3RhdGUsIHN0cmVhbSkgewogICAgZGVidWcoJ2VuZFJlYWRhYmxlTlQnLCBzdGF0ZS5lbmRFbWl0dGVkLCBzdGF0ZS5sZW5ndGgpOwoKICAgIC8vIENoZWNrIHRoYXQgd2UgZGlkbid0IGdldCBvbmUgbGFzdCB1bnNoaWZ0LgogICAgaWYgKCFzdGF0ZS5lcnJvcmVkICYmICFzdGF0ZS5jbG9zZUVtaXR0ZWQgJiYgIXN0YXRlLmVuZEVtaXR0ZWQgJiYgc3RhdGUubGVuZ3RoID09PSAwKSB7CiAgICAgIHN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICBzdHJlYW0uZW1pdCgnZW5kJyk7CiAgICAgIGlmIChzdHJlYW0ud3JpdGFibGUgJiYgc3RyZWFtLmFsbG93SGFsZk9wZW4gPT09IGZhbHNlKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhlbmRXcml0YWJsZU5ULCBzdHJlYW0pOwogICAgICB9IGVsc2UgaWYgKHN0YXRlLmF1dG9EZXN0cm95KSB7CiAgICAgICAgLy8gSW4gY2FzZSBvZiBkdXBsZXggc3RyZWFtcyB3ZSBuZWVkIGEgd2F5IHRvIGRldGVjdAogICAgICAgIC8vIGlmIHRoZSB3cml0YWJsZSBzaWRlIGlzIHJlYWR5IGZvciBhdXRvRGVzdHJveSBhcyB3ZWxsLgogICAgICAgIGNvbnN0IHdTdGF0ZSA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZTsKICAgICAgICBjb25zdCBhdXRvRGVzdHJveSA9ICF3U3RhdGUgfHwgd1N0YXRlLmF1dG9EZXN0cm95ICYmICgKICAgICAgICAvLyBXZSBkb24ndCBleHBlY3QgdGhlIHdyaXRhYmxlIHRvIGV2ZXIgJ2ZpbmlzaCcKICAgICAgICAvLyBpZiB3cml0YWJsZSBpcyBleHBsaWNpdGx5IHNldCB0byBmYWxzZS4KICAgICAgICB3U3RhdGUuZmluaXNoZWQgfHwgd1N0YXRlLndyaXRhYmxlID09PSBmYWxzZSk7CiAgICAgICAgaWYgKGF1dG9EZXN0cm95KSB7CiAgICAgICAgICBzdHJlYW0uZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBlbmRXcml0YWJsZU5UKHN0cmVhbSkgewogICAgY29uc3Qgd3JpdGFibGUgPSBzdHJlYW0ud3JpdGFibGUgJiYgIXN0cmVhbS53cml0YWJsZUVuZGVkICYmICFzdHJlYW0uZGVzdHJveWVkOwogICAgaWYgKHdyaXRhYmxlKSB7CiAgICAgIHN0cmVhbS5lbmQoKTsKICAgIH0KICB9CiAgUmVhZGFibGUuZnJvbSA9IGZ1bmN0aW9uIChpdGVyYWJsZSwgb3B0cykgewogICAgcmV0dXJuIGZyb20oUmVhZGFibGUsIGl0ZXJhYmxlLCBvcHRzKTsKICB9OwogIGxldCB3ZWJTdHJlYW1zQWRhcHRlcnM7CgogIC8vIExhenkgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogIGZ1bmN0aW9uIGxhenlXZWJTdHJlYW1zKCkgewogICAgaWYgKHdlYlN0cmVhbXNBZGFwdGVycyA9PT0gdW5kZWZpbmVkKSB3ZWJTdHJlYW1zQWRhcHRlcnMgPSB7fTsKICAgIHJldHVybiB3ZWJTdHJlYW1zQWRhcHRlcnM7CiAgfQogIFJlYWRhYmxlLmZyb21XZWIgPSBmdW5jdGlvbiAocmVhZGFibGVTdHJlYW0sIG9wdGlvbnMpIHsKICAgIHJldHVybiBsYXp5V2ViU3RyZWFtcygpLm5ld1N0cmVhbVJlYWRhYmxlRnJvbVJlYWRhYmxlU3RyZWFtKHJlYWRhYmxlU3RyZWFtLCBvcHRpb25zKTsKICB9OwogIFJlYWRhYmxlLnRvV2ViID0gZnVuY3Rpb24gKHN0cmVhbVJlYWRhYmxlLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbGF6eVdlYlN0cmVhbXMoKS5uZXdSZWFkYWJsZVN0cmVhbUZyb21TdHJlYW1SZWFkYWJsZShzdHJlYW1SZWFkYWJsZSwgb3B0aW9ucyk7CiAgfTsKICBSZWFkYWJsZS53cmFwID0gZnVuY3Rpb24gKHNyYywgb3B0aW9ucykgewogICAgdmFyIF9yZWYsIF9zcmMkcmVhZGFibGVPYmplY3RNbzsKICAgIHJldHVybiBuZXcgUmVhZGFibGUoX29iamVjdFNwcmVhZCQ3KF9vYmplY3RTcHJlYWQkNyh7CiAgICAgIG9iamVjdE1vZGU6IChfcmVmID0gKF9zcmMkcmVhZGFibGVPYmplY3RNbyA9IHNyYy5yZWFkYWJsZU9iamVjdE1vZGUpICE9PSBudWxsICYmIF9zcmMkcmVhZGFibGVPYmplY3RNbyAhPT0gdW5kZWZpbmVkID8gX3NyYyRyZWFkYWJsZU9iamVjdE1vIDogc3JjLm9iamVjdE1vZGUpICE9PSBudWxsICYmIF9yZWYgIT09IHVuZGVmaW5lZCA/IF9yZWYgOiB0cnVlCiAgICB9LCBvcHRpb25zKSwge30sIHsKICAgICAgZGVzdHJveShlcnIsIGNhbGxiYWNrKSB7CiAgICAgICAgZGVzdHJveUltcGwuZGVzdHJveWVyKHNyYywgZXJyKTsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9CiAgICB9KSkud3JhcChzcmMpOwogIH07CiAgcmV0dXJuIHJlYWRhYmxlOwp9Cgp2YXIgd3JpdGFibGU7CnZhciBoYXNSZXF1aXJlZFdyaXRhYmxlOwpmdW5jdGlvbiByZXF1aXJlV3JpdGFibGUoKSB7CiAgaWYgKGhhc1JlcXVpcmVkV3JpdGFibGUpIHJldHVybiB3cml0YWJsZTsKICBoYXNSZXF1aXJlZFdyaXRhYmxlID0gMTsKCiAgLyogcmVwbGFjZW1lbnQgc3RhcnQgKi8KCiAgY29uc3QgcHJvY2VzcyA9IHJlcXVpcmVQcm9jZXNzKCk7CgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLwoKICBjb25zdCB7CiAgICBBcnJheVByb3RvdHlwZVNsaWNlLAogICAgRXJyb3IsCiAgICBGdW5jdGlvblByb3RvdHlwZVN5bWJvbEhhc0luc3RhbmNlLAogICAgT2JqZWN0RGVmaW5lUHJvcGVydHksCiAgICBPYmplY3REZWZpbmVQcm9wZXJ0aWVzLAogICAgT2JqZWN0U2V0UHJvdG90eXBlT2YsCiAgICBTdHJpbmdQcm90b3R5cGVUb0xvd2VyQ2FzZSwKICAgIFN5bWJvbCwKICAgIFN5bWJvbEhhc0luc3RhbmNlCiAgfSA9IHJlcXVpcmVQcmltb3JkaWFscygpOwogIHdyaXRhYmxlID0gV3JpdGFibGU7CiAgV3JpdGFibGUuV3JpdGFibGVTdGF0ZSA9IFdyaXRhYmxlU3RhdGU7CiAgY29uc3QgewogICAgRXZlbnRFbWl0dGVyOiBFRQogIH0gPSByZXF1aXJlJCQwJDI7CiAgY29uc3QgU3RyZWFtID0gcmVxdWlyZUxlZ2FjeSgpLlN0cmVhbTsKICBjb25zdCB7CiAgICBCdWZmZXIKICB9ID0gcmVxdWlyZSQkMCQzOwogIGNvbnN0IGRlc3Ryb3lJbXBsID0gcmVxdWlyZURlc3Ryb3koKTsKICBjb25zdCB7CiAgICBhZGRBYm9ydFNpZ25hbAogIH0gPSByZXF1aXJlQWRkQWJvcnRTaWduYWwoKTsKICBjb25zdCB7CiAgICBnZXRIaWdoV2F0ZXJNYXJrLAogICAgZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsKICB9ID0gcmVxdWlyZVN0YXRlKCk7CiAgY29uc3QgewogICAgRVJSX0lOVkFMSURfQVJHX1RZUEUsCiAgICBFUlJfTUVUSE9EX05PVF9JTVBMRU1FTlRFRCwKICAgIEVSUl9NVUxUSVBMRV9DQUxMQkFDSywKICAgIEVSUl9TVFJFQU1fQ0FOTk9UX1BJUEUsCiAgICBFUlJfU1RSRUFNX0RFU1RST1lFRCwKICAgIEVSUl9TVFJFQU1fQUxSRUFEWV9GSU5JU0hFRCwKICAgIEVSUl9TVFJFQU1fTlVMTF9WQUxVRVMsCiAgICBFUlJfU1RSRUFNX1dSSVRFX0FGVEVSX0VORCwKICAgIEVSUl9VTktOT1dOX0VOQ09ESU5HCiAgfSA9IHJlcXVpcmVFcnJvcnMoKS5jb2RlczsKICBjb25zdCB7CiAgICBlcnJvck9yRGVzdHJveQogIH0gPSBkZXN0cm95SW1wbDsKICBPYmplY3RTZXRQcm90b3R5cGVPZihXcml0YWJsZS5wcm90b3R5cGUsIFN0cmVhbS5wcm90b3R5cGUpOwogIE9iamVjdFNldFByb3RvdHlwZU9mKFdyaXRhYmxlLCBTdHJlYW0pOwogIGZ1bmN0aW9uIG5vcCgpIHt9CiAgY29uc3Qga09uRmluaXNoZWQgPSBTeW1ib2woJ2tPbkZpbmlzaGVkJyk7CiAgZnVuY3Rpb24gV3JpdGFibGVTdGF0ZShvcHRpb25zLCBzdHJlYW0sIGlzRHVwbGV4KSB7CiAgICAvLyBEdXBsZXggc3RyZWFtcyBhcmUgYm90aCByZWFkYWJsZSBhbmQgd3JpdGFibGUsIGJ1dCBzaGFyZQogICAgLy8gdGhlIHNhbWUgb3B0aW9ucyBvYmplY3QuCiAgICAvLyBIb3dldmVyLCBzb21lIGNhc2VzIHJlcXVpcmUgc2V0dGluZyBvcHRpb25zIHRvIGRpZmZlcmVudAogICAgLy8gdmFsdWVzIGZvciB0aGUgcmVhZGFibGUgYW5kIHRoZSB3cml0YWJsZSBzaWRlcyBvZiB0aGUgZHVwbGV4IHN0cmVhbSwKICAgIC8vIGUuZy4gb3B0aW9ucy5yZWFkYWJsZU9iamVjdE1vZGUgdnMuIG9wdGlvbnMud3JpdGFibGVPYmplY3RNb2RlLCBldGMuCiAgICBpZiAodHlwZW9mIGlzRHVwbGV4ICE9PSAnYm9vbGVhbicpIGlzRHVwbGV4ID0gc3RyZWFtIGluc3RhbmNlb2YgcmVxdWlyZUR1cGxleCgpOwoKICAgIC8vIE9iamVjdCBzdHJlYW0gZmxhZyB0byBpbmRpY2F0ZSB3aGV0aGVyIG9yIG5vdCB0aGlzIHN0cmVhbQogICAgLy8gY29udGFpbnMgYnVmZmVycyBvciBvYmplY3RzLgogICAgdGhpcy5vYmplY3RNb2RlID0gISEob3B0aW9ucyAmJiBvcHRpb25zLm9iamVjdE1vZGUpOwogICAgaWYgKGlzRHVwbGV4KSB0aGlzLm9iamVjdE1vZGUgPSB0aGlzLm9iamVjdE1vZGUgfHwgISEob3B0aW9ucyAmJiBvcHRpb25zLndyaXRhYmxlT2JqZWN0TW9kZSk7CgogICAgLy8gVGhlIHBvaW50IGF0IHdoaWNoIHdyaXRlKCkgc3RhcnRzIHJldHVybmluZyBmYWxzZQogICAgLy8gTm90ZTogMCBpcyBhIHZhbGlkIHZhbHVlLCBtZWFucyB0aGF0IHdlIGFsd2F5cyByZXR1cm4gZmFsc2UgaWYKICAgIC8vIHRoZSBlbnRpcmUgYnVmZmVyIGlzIG5vdCBmbHVzaGVkIGltbWVkaWF0ZWx5IG9uIHdyaXRlKCkuCiAgICB0aGlzLmhpZ2hXYXRlck1hcmsgPSBvcHRpb25zID8gZ2V0SGlnaFdhdGVyTWFyayh0aGlzLCBvcHRpb25zLCAnd3JpdGFibGVIaWdoV2F0ZXJNYXJrJywgaXNEdXBsZXgpIDogZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcmsoZmFsc2UpOwoKICAgIC8vIGlmIF9maW5hbCBoYXMgYmVlbiBjYWxsZWQuCiAgICB0aGlzLmZpbmFsQ2FsbGVkID0gZmFsc2U7CgogICAgLy8gZHJhaW4gZXZlbnQgZmxhZy4KICAgIHRoaXMubmVlZERyYWluID0gZmFsc2U7CiAgICAvLyBBdCB0aGUgc3RhcnQgb2YgY2FsbGluZyBlbmQoKQogICAgdGhpcy5lbmRpbmcgPSBmYWxzZTsKICAgIC8vIFdoZW4gZW5kKCkgaGFzIGJlZW4gY2FsbGVkLCBhbmQgcmV0dXJuZWQuCiAgICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgICAvLyBXaGVuICdmaW5pc2gnIGlzIGVtaXR0ZWQuCiAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CgogICAgLy8gSGFzIGl0IGJlZW4gZGVzdHJveWVkCiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlOwoKICAgIC8vIFNob3VsZCB3ZSBkZWNvZGUgc3RyaW5ncyBpbnRvIGJ1ZmZlcnMgYmVmb3JlIHBhc3NpbmcgdG8gX3dyaXRlPwogICAgLy8gdGhpcyBpcyBoZXJlIHNvIHRoYXQgc29tZSBub2RlLWNvcmUgc3RyZWFtcyBjYW4gb3B0aW1pemUgc3RyaW5nCiAgICAvLyBoYW5kbGluZyBhdCBhIGxvd2VyIGxldmVsLgogICAgY29uc3Qgbm9EZWNvZGUgPSAhIShvcHRpb25zICYmIG9wdGlvbnMuZGVjb2RlU3RyaW5ncyA9PT0gZmFsc2UpOwogICAgdGhpcy5kZWNvZGVTdHJpbmdzID0gIW5vRGVjb2RlOwoKICAgIC8vIENyeXB0byBpcyBraW5kIG9mIG9sZCBhbmQgY3J1c3R5LiAgSGlzdG9yaWNhbGx5LCBpdHMgZGVmYXVsdCBzdHJpbmcKICAgIC8vIGVuY29kaW5nIGlzICdiaW5hcnknIHNvIHdlIGhhdmUgdG8gbWFrZSB0aGlzIGNvbmZpZ3VyYWJsZS4KICAgIC8vIEV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgdW5pdmVyc2UgdXNlcyAndXRmOCcsIHRob3VnaC4KICAgIHRoaXMuZGVmYXVsdEVuY29kaW5nID0gb3B0aW9ucyAmJiBvcHRpb25zLmRlZmF1bHRFbmNvZGluZyB8fCAndXRmOCc7CgogICAgLy8gTm90IGFuIGFjdHVhbCBidWZmZXIgd2Uga2VlcCB0cmFjayBvZiwgYnV0IGEgbWVhc3VyZW1lbnQKICAgIC8vIG9mIGhvdyBtdWNoIHdlJ3JlIHdhaXRpbmcgdG8gZ2V0IHB1c2hlZCB0byBzb21lIHVuZGVybHlpbmcKICAgIC8vIHNvY2tldCBvciBmaWxlLgogICAgdGhpcy5sZW5ndGggPSAwOwoKICAgIC8vIEEgZmxhZyB0byBzZWUgd2hlbiB3ZSdyZSBpbiB0aGUgbWlkZGxlIG9mIGEgd3JpdGUuCiAgICB0aGlzLndyaXRpbmcgPSBmYWxzZTsKCiAgICAvLyBXaGVuIHRydWUgYWxsIHdyaXRlcyB3aWxsIGJlIGJ1ZmZlcmVkIHVudGlsIC51bmNvcmsoKSBjYWxsLgogICAgdGhpcy5jb3JrZWQgPSAwOwoKICAgIC8vIEEgZmxhZyB0byBiZSBhYmxlIHRvIHRlbGwgaWYgdGhlIG9ud3JpdGUgY2IgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LAogICAgLy8gb3Igb24gYSBsYXRlciB0aWNrLiAgV2Ugc2V0IHRoaXMgdG8gdHJ1ZSBhdCBmaXJzdCwgYmVjYXVzZSBhbnkKICAgIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgICAvLyBub3QgaGFwcGVuIGJlZm9yZSB0aGUgZmlyc3Qgd3JpdGUgY2FsbC4KICAgIHRoaXMuc3luYyA9IHRydWU7CgogICAgLy8gQSBmbGFnIHRvIGtub3cgaWYgd2UncmUgcHJvY2Vzc2luZyBwcmV2aW91c2x5IGJ1ZmZlcmVkIGl0ZW1zLCB3aGljaAogICAgLy8gbWF5IGNhbGwgdGhlIF93cml0ZSgpIGNhbGxiYWNrIGluIHRoZSBzYW1lIHRpY2ssIHNvIHRoYXQgd2UgZG9uJ3QKICAgIC8vIGVuZCB1cCBpbiBhbiBvdmVybGFwcGVkIG9ud3JpdGUgc2l0dWF0aW9uLgogICAgdGhpcy5idWZmZXJQcm9jZXNzaW5nID0gZmFsc2U7CgogICAgLy8gVGhlIGNhbGxiYWNrIHRoYXQncyBwYXNzZWQgdG8gX3dyaXRlKGNodW5rLCBjYikuCiAgICB0aGlzLm9ud3JpdGUgPSBvbndyaXRlLmJpbmQodW5kZWZpbmVkLCBzdHJlYW0pOwoKICAgIC8vIFRoZSBjYWxsYmFjayB0aGF0IHRoZSB1c2VyIHN1cHBsaWVzIHRvIHdyaXRlKGNodW5rLCBlbmNvZGluZywgY2IpLgogICAgdGhpcy53cml0ZWNiID0gbnVsbDsKCiAgICAvLyBUaGUgYW1vdW50IHRoYXQgaXMgYmVpbmcgd3JpdHRlbiB3aGVuIF93cml0ZSBpcyBjYWxsZWQuCiAgICB0aGlzLndyaXRlbGVuID0gMDsKCiAgICAvLyBTdG9yYWdlIGZvciBkYXRhIHBhc3NlZCB0byB0aGUgYWZ0ZXJXcml0ZSgpIGNhbGxiYWNrIGluIGNhc2Ugb2YKICAgIC8vIHN5bmNocm9ub3VzIF93cml0ZSgpIGNvbXBsZXRpb24uCiAgICB0aGlzLmFmdGVyV3JpdGVUaWNrSW5mbyA9IG51bGw7CiAgICByZXNldEJ1ZmZlcih0aGlzKTsKCiAgICAvLyBOdW1iZXIgb2YgcGVuZGluZyB1c2VyLXN1cHBsaWVkIHdyaXRlIGNhbGxiYWNrcwogICAgLy8gdGhpcyBtdXN0IGJlIDAgYmVmb3JlICdmaW5pc2gnIGNhbiBiZSBlbWl0dGVkLgogICAgdGhpcy5wZW5kaW5nY2IgPSAwOwoKICAgIC8vIFN0cmVhbSBpcyBzdGlsbCBiZWluZyBjb25zdHJ1Y3RlZCBhbmQgY2Fubm90IGJlCiAgICAvLyBkZXN0cm95ZWQgdW50aWwgY29uc3RydWN0aW9uIGZpbmlzaGVkIG9yIGZhaWxlZC4KICAgIC8vIEFzeW5jIGNvbnN0cnVjdGlvbiBpcyBvcHQgaW4sIHRoZXJlZm9yZSB3ZSBzdGFydCBhcwogICAgLy8gY29uc3RydWN0ZWQuCiAgICB0aGlzLmNvbnN0cnVjdGVkID0gdHJ1ZTsKCiAgICAvLyBFbWl0IHByZWZpbmlzaCBpZiB0aGUgb25seSB0aGluZyB3ZSdyZSB3YWl0aW5nIGZvciBpcyBfd3JpdGUgY2JzCiAgICAvLyBUaGlzIGlzIHJlbGV2YW50IGZvciBzeW5jaHJvbm91cyBUcmFuc2Zvcm0gc3RyZWFtcy4KICAgIHRoaXMucHJlZmluaXNoZWQgPSBmYWxzZTsKCiAgICAvLyBUcnVlIGlmIHRoZSBlcnJvciB3YXMgYWxyZWFkeSBlbWl0dGVkIGFuZCBzaG91bGQgbm90IGJlIHRocm93biBhZ2Fpbi4KICAgIHRoaXMuZXJyb3JFbWl0dGVkID0gZmFsc2U7CgogICAgLy8gU2hvdWxkIGNsb3NlIGJlIGVtaXR0ZWQgb24gZGVzdHJveS4gRGVmYXVsdHMgdG8gdHJ1ZS4KICAgIHRoaXMuZW1pdENsb3NlID0gIW9wdGlvbnMgfHwgb3B0aW9ucy5lbWl0Q2xvc2UgIT09IGZhbHNlOwoKICAgIC8vIFNob3VsZCAuZGVzdHJveSgpIGJlIGNhbGxlZCBhZnRlciAnZmluaXNoJyAoYW5kIHBvdGVudGlhbGx5ICdlbmQnKS4KICAgIHRoaXMuYXV0b0Rlc3Ryb3kgPSAhb3B0aW9ucyB8fCBvcHRpb25zLmF1dG9EZXN0cm95ICE9PSBmYWxzZTsKCiAgICAvLyBJbmRpY2F0ZXMgd2hldGhlciB0aGUgc3RyZWFtIGhhcyBlcnJvcmVkLiBXaGVuIHRydWUgYWxsIHdyaXRlKCkgY2FsbHMKICAgIC8vIHNob3VsZCByZXR1cm4gZmFsc2UuIFRoaXMgaXMgbmVlZGVkIHNpbmNlIHdoZW4gYXV0b0Rlc3Ryb3kKICAgIC8vIGlzIGRpc2FibGVkIHdlIG5lZWQgYSB3YXkgdG8gdGVsbCB3aGV0aGVyIHRoZSBzdHJlYW0gaGFzIGZhaWxlZC4KICAgIHRoaXMuZXJyb3JlZCA9IG51bGw7CgogICAgLy8gSW5kaWNhdGVzIHdoZXRoZXIgdGhlIHN0cmVhbSBoYXMgZmluaXNoZWQgZGVzdHJveWluZy4KICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7CgogICAgLy8gVHJ1ZSBpZiBjbG9zZSBoYXMgYmVlbiBlbWl0dGVkIG9yIHdvdWxkIGhhdmUgYmVlbiBlbWl0dGVkCiAgICAvLyBkZXBlbmRpbmcgb24gZW1pdENsb3NlLgogICAgdGhpcy5jbG9zZUVtaXR0ZWQgPSBmYWxzZTsKICAgIHRoaXNba09uRmluaXNoZWRdID0gW107CiAgfQogIGZ1bmN0aW9uIHJlc2V0QnVmZmVyKHN0YXRlKSB7CiAgICBzdGF0ZS5idWZmZXJlZCA9IFtdOwogICAgc3RhdGUuYnVmZmVyZWRJbmRleCA9IDA7CiAgICBzdGF0ZS5hbGxCdWZmZXJzID0gdHJ1ZTsKICAgIHN0YXRlLmFsbE5vb3AgPSB0cnVlOwogIH0KICBXcml0YWJsZVN0YXRlLnByb3RvdHlwZS5nZXRCdWZmZXIgPSBmdW5jdGlvbiBnZXRCdWZmZXIoKSB7CiAgICByZXR1cm4gQXJyYXlQcm90b3R5cGVTbGljZSh0aGlzLmJ1ZmZlcmVkLCB0aGlzLmJ1ZmZlcmVkSW5kZXgpOwogIH07CiAgT2JqZWN0RGVmaW5lUHJvcGVydHkoV3JpdGFibGVTdGF0ZS5wcm90b3R5cGUsICdidWZmZXJlZFJlcXVlc3RDb3VudCcsIHsKICAgIF9fcHJvdG9fXzogbnVsbCwKICAgIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyZWQubGVuZ3RoIC0gdGhpcy5idWZmZXJlZEluZGV4OwogICAgfQogIH0pOwogIGZ1bmN0aW9uIFdyaXRhYmxlKG9wdGlvbnMpIHsKICAgIC8vIFdyaXRhYmxlIGN0b3IgaXMgYXBwbGllZCB0byBEdXBsZXhlcywgdG9vLgogICAgLy8gYHJlYWxIYXNJbnN0YW5jZWAgaXMgbmVjZXNzYXJ5IGJlY2F1c2UgdXNpbmcgcGxhaW4gYGluc3RhbmNlb2ZgCiAgICAvLyB3b3VsZCByZXR1cm4gZmFsc2UsIGFzIG5vIGBfd3JpdGFibGVTdGF0ZWAgcHJvcGVydHkgaXMgYXR0YWNoZWQuCgogICAgLy8gVHJ5aW5nIHRvIHVzZSB0aGUgY3VzdG9tIGBpbnN0YW5jZW9mYCBmb3IgV3JpdGFibGUgaGVyZSB3aWxsIGFsc28gYnJlYWsgdGhlCiAgICAvLyBOb2RlLmpzIExhenlUcmFuc2Zvcm0gaW1wbGVtZW50YXRpb24sIHdoaWNoIGhhcyBhIG5vbi10cml2aWFsIGdldHRlciBmb3IKICAgIC8vIGBfd3JpdGFibGVTdGF0ZWAgdGhhdCB3b3VsZCBsZWFkIHRvIGluZmluaXRlIHJlY3Vyc2lvbi4KCiAgICAvLyBDaGVja2luZyBmb3IgYSBTdHJlYW0uRHVwbGV4IGluc3RhbmNlIGlzIGZhc3RlciBoZXJlIGluc3RlYWQgb2YgaW5zaWRlCiAgICAvLyB0aGUgV3JpdGFibGVTdGF0ZSBjb25zdHJ1Y3RvciwgYXQgbGVhc3Qgd2l0aCBWOCA2LjUuCiAgICBjb25zdCBpc0R1cGxleCA9IHRoaXMgaW5zdGFuY2VvZiByZXF1aXJlRHVwbGV4KCk7CiAgICBpZiAoIWlzRHVwbGV4ICYmICFGdW5jdGlvblByb3RvdHlwZVN5bWJvbEhhc0luc3RhbmNlKFdyaXRhYmxlLCB0aGlzKSkgcmV0dXJuIG5ldyBXcml0YWJsZShvcHRpb25zKTsKICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZShvcHRpb25zLCB0aGlzLCBpc0R1cGxleCk7CiAgICBpZiAob3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMud3JpdGUgPT09ICdmdW5jdGlvbicpIHRoaXMuX3dyaXRlID0gb3B0aW9ucy53cml0ZTsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLndyaXRldiA9PT0gJ2Z1bmN0aW9uJykgdGhpcy5fd3JpdGV2ID0gb3B0aW9ucy53cml0ZXY7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5kZXN0cm95ID09PSAnZnVuY3Rpb24nKSB0aGlzLl9kZXN0cm95ID0gb3B0aW9ucy5kZXN0cm95OwogICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZmluYWwgPT09ICdmdW5jdGlvbicpIHRoaXMuX2ZpbmFsID0gb3B0aW9ucy5maW5hbDsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbnN0cnVjdCA9PT0gJ2Z1bmN0aW9uJykgdGhpcy5fY29uc3RydWN0ID0gb3B0aW9ucy5jb25zdHJ1Y3Q7CiAgICAgIGlmIChvcHRpb25zLnNpZ25hbCkgYWRkQWJvcnRTaWduYWwob3B0aW9ucy5zaWduYWwsIHRoaXMpOwogICAgfQogICAgU3RyZWFtLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICBkZXN0cm95SW1wbC5jb25zdHJ1Y3QodGhpcywgKCkgPT4gewogICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgICAgIGlmICghc3RhdGUud3JpdGluZykgewogICAgICAgIGNsZWFyQnVmZmVyKHRoaXMsIHN0YXRlKTsKICAgICAgfQogICAgICBmaW5pc2hNYXliZSh0aGlzLCBzdGF0ZSk7CiAgICB9KTsKICB9CiAgT2JqZWN0RGVmaW5lUHJvcGVydHkoV3JpdGFibGUsIFN5bWJvbEhhc0luc3RhbmNlLCB7CiAgICBfX3Byb3RvX186IG51bGwsCiAgICB2YWx1ZTogZnVuY3Rpb24gKG9iamVjdCkgewogICAgICBpZiAoRnVuY3Rpb25Qcm90b3R5cGVTeW1ib2xIYXNJbnN0YW5jZSh0aGlzLCBvYmplY3QpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMgIT09IFdyaXRhYmxlKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0Ll93cml0YWJsZVN0YXRlIGluc3RhbmNlb2YgV3JpdGFibGVTdGF0ZTsKICAgIH0KICB9KTsKCiAgLy8gT3RoZXJ3aXNlIHBlb3BsZSBjYW4gcGlwZSBXcml0YWJsZSBzdHJlYW1zLCB3aGljaCBpcyBqdXN0IHdyb25nLgogIFdyaXRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24gKCkgewogICAgZXJyb3JPckRlc3Ryb3kodGhpcywgbmV3IEVSUl9TVFJFQU1fQ0FOTk9UX1BJUEUoKSk7CiAgfTsKICBmdW5jdGlvbiBfd3JpdGUoc3RyZWFtLCBjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBjb25zdCBzdGF0ZSA9IHN0cmVhbS5fd3JpdGFibGVTdGF0ZTsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZzsKICAgICAgZW5jb2RpbmcgPSBzdGF0ZS5kZWZhdWx0RW5jb2Rpbmc7CiAgICB9IGVsc2UgewogICAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9IHN0YXRlLmRlZmF1bHRFbmNvZGluZztlbHNlIGlmIChlbmNvZGluZyAhPT0gJ2J1ZmZlcicgJiYgIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgdGhyb3cgbmV3IEVSUl9VTktOT1dOX0VOQ09ESU5HKGVuY29kaW5nKTsKICAgICAgaWYgKHR5cGVvZiBjYiAhPT0gJ2Z1bmN0aW9uJykgY2IgPSBub3A7CiAgICB9CiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9TVFJFQU1fTlVMTF9WQUxVRVMoKTsKICAgIH0gZWxzZSBpZiAoIXN0YXRlLm9iamVjdE1vZGUpIHsKICAgICAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoc3RhdGUuZGVjb2RlU3RyaW5ncyAhPT0gZmFsc2UpIHsKICAgICAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKTsKICAgICAgICAgIGVuY29kaW5nID0gJ2J1ZmZlcic7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNodW5rIGluc3RhbmNlb2YgQnVmZmVyKSB7CiAgICAgICAgZW5jb2RpbmcgPSAnYnVmZmVyJzsKICAgICAgfSBlbHNlIGlmIChTdHJlYW0uX2lzVWludDhBcnJheShjaHVuaykpIHsKICAgICAgICBjaHVuayA9IFN0cmVhbS5fdWludDhBcnJheVRvQnVmZmVyKGNodW5rKTsKICAgICAgICBlbmNvZGluZyA9ICdidWZmZXInOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgnY2h1bmsnLCBbJ3N0cmluZycsICdCdWZmZXInLCAnVWludDhBcnJheSddLCBjaHVuayk7CiAgICAgIH0KICAgIH0KICAgIGxldCBlcnI7CiAgICBpZiAoc3RhdGUuZW5kaW5nKSB7CiAgICAgIGVyciA9IG5ldyBFUlJfU1RSRUFNX1dSSVRFX0FGVEVSX0VORCgpOwogICAgfSBlbHNlIGlmIChzdGF0ZS5kZXN0cm95ZWQpIHsKICAgICAgZXJyID0gbmV3IEVSUl9TVFJFQU1fREVTVFJPWUVEKCd3cml0ZScpOwogICAgfQogICAgaWYgKGVycikgewogICAgICBwcm9jZXNzLm5leHRUaWNrKGNiLCBlcnIpOwogICAgICBlcnJvck9yRGVzdHJveShzdHJlYW0sIGVyciwgdHJ1ZSk7CiAgICAgIHJldHVybiBlcnI7CiAgICB9CiAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgIHJldHVybiB3cml0ZU9yQnVmZmVyKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpOwogIH0KICBXcml0YWJsZS5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgcmV0dXJuIF93cml0ZSh0aGlzLCBjaHVuaywgZW5jb2RpbmcsIGNiKSA9PT0gdHJ1ZTsKICB9OwogIFdyaXRhYmxlLnByb3RvdHlwZS5jb3JrID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5jb3JrZWQrKzsKICB9OwogIFdyaXRhYmxlLnByb3RvdHlwZS51bmNvcmsgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAoc3RhdGUuY29ya2VkKSB7CiAgICAgIHN0YXRlLmNvcmtlZC0tOwogICAgICBpZiAoIXN0YXRlLndyaXRpbmcpIGNsZWFyQnVmZmVyKHRoaXMsIHN0YXRlKTsKICAgIH0KICB9OwogIFdyaXRhYmxlLnByb3RvdHlwZS5zZXREZWZhdWx0RW5jb2RpbmcgPSBmdW5jdGlvbiBzZXREZWZhdWx0RW5jb2RpbmcoZW5jb2RpbmcpIHsKICAgIC8vIG5vZGU6OlBhcnNlRW5jb2RpbmcoKSByZXF1aXJlcyBsb3dlciBjYXNlLgogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycpIGVuY29kaW5nID0gU3RyaW5nUHJvdG90eXBlVG9Mb3dlckNhc2UoZW5jb2RpbmcpOwogICAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHRocm93IG5ldyBFUlJfVU5LTk9XTl9FTkNPRElORyhlbmNvZGluZyk7CiAgICB0aGlzLl93cml0YWJsZVN0YXRlLmRlZmF1bHRFbmNvZGluZyA9IGVuY29kaW5nOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gSWYgd2UncmUgYWxyZWFkeSB3cml0aW5nIHNvbWV0aGluZywgdGhlbiBqdXN0IHB1dCB0aGlzCiAgLy8gaW4gdGhlIHF1ZXVlLCBhbmQgd2FpdCBvdXIgdHVybi4gIE90aGVyd2lzZSwgY2FsbCBfd3JpdGUKICAvLyBJZiB3ZSByZXR1cm4gZmFsc2UsIHRoZW4gd2UgbmVlZCBhIGRyYWluIGV2ZW50LCBzbyBzZXQgdGhhdCBmbGFnLgogIGZ1bmN0aW9uIHdyaXRlT3JCdWZmZXIoc3RyZWFtLCBzdGF0ZSwgY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjaykgewogICAgY29uc3QgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CiAgICBzdGF0ZS5sZW5ndGggKz0gbGVuOwoKICAgIC8vIHN0cmVhbS5fd3JpdGUgcmVzZXRzIHN0YXRlLmxlbmd0aAogICAgY29uc3QgcmV0ID0gc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyazsKICAgIC8vIFdlIG11c3QgZW5zdXJlIHRoYXQgcHJldmlvdXMgbmVlZERyYWluIHdpbGwgbm90IGJlIHJlc2V0IHRvIGZhbHNlLgogICAgaWYgKCFyZXQpIHN0YXRlLm5lZWREcmFpbiA9IHRydWU7CiAgICBpZiAoc3RhdGUud3JpdGluZyB8fCBzdGF0ZS5jb3JrZWQgfHwgc3RhdGUuZXJyb3JlZCB8fCAhc3RhdGUuY29uc3RydWN0ZWQpIHsKICAgICAgc3RhdGUuYnVmZmVyZWQucHVzaCh7CiAgICAgICAgY2h1bmssCiAgICAgICAgZW5jb2RpbmcsCiAgICAgICAgY2FsbGJhY2sKICAgICAgfSk7CiAgICAgIGlmIChzdGF0ZS5hbGxCdWZmZXJzICYmIGVuY29kaW5nICE9PSAnYnVmZmVyJykgewogICAgICAgIHN0YXRlLmFsbEJ1ZmZlcnMgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAoc3RhdGUuYWxsTm9vcCAmJiBjYWxsYmFjayAhPT0gbm9wKSB7CiAgICAgICAgc3RhdGUuYWxsTm9vcCA9IGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdGF0ZS53cml0ZWxlbiA9IGxlbjsKICAgICAgc3RhdGUud3JpdGVjYiA9IGNhbGxiYWNrOwogICAgICBzdGF0ZS53cml0aW5nID0gdHJ1ZTsKICAgICAgc3RhdGUuc3luYyA9IHRydWU7CiAgICAgIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICAgICAgc3RhdGUuc3luYyA9IGZhbHNlOwogICAgfQoKICAgIC8vIFJldHVybiBmYWxzZSBpZiBlcnJvcmVkIG9yIGRlc3Ryb3llZCBpbiBvcmRlciB0byBicmVhawogICAgLy8gYW55IHN5bmNocm9ub3VzIHdoaWxlKHN0cmVhbS53cml0ZShkYXRhKSkgbG9vcHMuCiAgICByZXR1cm4gcmV0ICYmICFzdGF0ZS5lcnJvcmVkICYmICFzdGF0ZS5kZXN0cm95ZWQ7CiAgfQogIGZ1bmN0aW9uIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgd3JpdGV2LCBsZW4sIGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIHN0YXRlLndyaXRlbGVuID0gbGVuOwogICAgc3RhdGUud3JpdGVjYiA9IGNiOwogICAgc3RhdGUud3JpdGluZyA9IHRydWU7CiAgICBzdGF0ZS5zeW5jID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5kZXN0cm95ZWQpIHN0YXRlLm9ud3JpdGUobmV3IEVSUl9TVFJFQU1fREVTVFJPWUVEKCd3cml0ZScpKTtlbHNlIGlmICh3cml0ZXYpIHN0cmVhbS5fd3JpdGV2KGNodW5rLCBzdGF0ZS5vbndyaXRlKTtlbHNlIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICAgIHN0YXRlLnN5bmMgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gb253cml0ZUVycm9yKHN0cmVhbSwgc3RhdGUsIGVyLCBjYikgewogICAgLS1zdGF0ZS5wZW5kaW5nY2I7CiAgICBjYihlcik7CiAgICAvLyBFbnN1cmUgY2FsbGJhY2tzIGFyZSBpbnZva2VkIGV2ZW4gd2hlbiBhdXRvRGVzdHJveSBpcwogICAgLy8gbm90IGVuYWJsZWQuIFBhc3NpbmcgYGVyYCBoZXJlIGRvZXNuJ3QgbWFrZSBzZW5zZSBzaW5jZQogICAgLy8gaXQncyByZWxhdGVkIHRvIG9uZSBzcGVjaWZpYyB3cml0ZSwgbm90IHRvIHRoZSBidWZmZXJlZAogICAgLy8gd3JpdGVzLgogICAgZXJyb3JCdWZmZXIoc3RhdGUpOwogICAgLy8gVGhpcyBjYW4gZW1pdCBlcnJvciwgYnV0IGVycm9yIG11c3QgYWx3YXlzIGZvbGxvdyBjYi4KICAgIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgZXIpOwogIH0KICBmdW5jdGlvbiBvbndyaXRlKHN0cmVhbSwgZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogICAgY29uc3Qgc3luYyA9IHN0YXRlLnN5bmM7CiAgICBjb25zdCBjYiA9IHN0YXRlLndyaXRlY2I7CiAgICBpZiAodHlwZW9mIGNiICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgbmV3IEVSUl9NVUxUSVBMRV9DQUxMQkFDSygpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3RhdGUud3JpdGluZyA9IGZhbHNlOwogICAgc3RhdGUud3JpdGVjYiA9IG51bGw7CiAgICBzdGF0ZS5sZW5ndGggLT0gc3RhdGUud3JpdGVsZW47CiAgICBzdGF0ZS53cml0ZWxlbiA9IDA7CiAgICBpZiAoZXIpIHsKICAgICAgLy8gQXZvaWQgVjggbGVhaywgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL3B1bGwvMzQxMDMjaXNzdWVjb21tZW50LTY1MjAwMjM2NAogICAgICBlci5zdGFjazsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnMKCiAgICAgIGlmICghc3RhdGUuZXJyb3JlZCkgewogICAgICAgIHN0YXRlLmVycm9yZWQgPSBlcjsKICAgICAgfQoKICAgICAgLy8gSW4gY2FzZSBvZiBkdXBsZXggc3RyZWFtcyB3ZSBuZWVkIHRvIG5vdGlmeSB0aGUgcmVhZGFibGUgc2lkZSBvZiB0aGUKICAgICAgLy8gZXJyb3IuCiAgICAgIGlmIChzdHJlYW0uX3JlYWRhYmxlU3RhdGUgJiYgIXN0cmVhbS5fcmVhZGFibGVTdGF0ZS5lcnJvcmVkKSB7CiAgICAgICAgc3RyZWFtLl9yZWFkYWJsZVN0YXRlLmVycm9yZWQgPSBlcjsKICAgICAgfQogICAgICBpZiAoc3luYykgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2sob253cml0ZUVycm9yLCBzdHJlYW0sIHN0YXRlLCBlciwgY2IpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ud3JpdGVFcnJvcihzdHJlYW0sIHN0YXRlLCBlciwgY2IpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoc3RhdGUuYnVmZmVyZWQubGVuZ3RoID4gc3RhdGUuYnVmZmVyZWRJbmRleCkgewogICAgICAgIGNsZWFyQnVmZmVyKHN0cmVhbSwgc3RhdGUpOwogICAgICB9CiAgICAgIGlmIChzeW5jKSB7CiAgICAgICAgLy8gSXQgaXMgYSBjb21tb24gY2FzZSB0aGF0IHRoZSBjYWxsYmFjayBwYXNzZWQgdG8gLndyaXRlKCkgaXMgYWx3YXlzCiAgICAgICAgLy8gdGhlIHNhbWUuIEluIHRoYXQgY2FzZSwgd2UgZG8gbm90IHNjaGVkdWxlIGEgbmV3IG5leHRUaWNrKCksIGJ1dAogICAgICAgIC8vIHJhdGhlciBqdXN0IGluY3JlYXNlIGEgY291bnRlciwgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZSBhbmQgYXZvaWQKICAgICAgICAvLyBtZW1vcnkgYWxsb2NhdGlvbnMuCiAgICAgICAgaWYgKHN0YXRlLmFmdGVyV3JpdGVUaWNrSW5mbyAhPT0gbnVsbCAmJiBzdGF0ZS5hZnRlcldyaXRlVGlja0luZm8uY2IgPT09IGNiKSB7CiAgICAgICAgICBzdGF0ZS5hZnRlcldyaXRlVGlja0luZm8uY291bnQrKzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhdGUuYWZ0ZXJXcml0ZVRpY2tJbmZvID0gewogICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgY2IsCiAgICAgICAgICAgIHN0cmVhbSwKICAgICAgICAgICAgc3RhdGUKICAgICAgICAgIH07CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGFmdGVyV3JpdGVUaWNrLCBzdGF0ZS5hZnRlcldyaXRlVGlja0luZm8pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBhZnRlcldyaXRlKHN0cmVhbSwgc3RhdGUsIDEsIGNiKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBhZnRlcldyaXRlVGljayh7CiAgICBzdHJlYW0sCiAgICBzdGF0ZSwKICAgIGNvdW50LAogICAgY2IKICB9KSB7CiAgICBzdGF0ZS5hZnRlcldyaXRlVGlja0luZm8gPSBudWxsOwogICAgcmV0dXJuIGFmdGVyV3JpdGUoc3RyZWFtLCBzdGF0ZSwgY291bnQsIGNiKTsKICB9CiAgZnVuY3Rpb24gYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBjb3VudCwgY2IpIHsKICAgIGNvbnN0IG5lZWREcmFpbiA9ICFzdGF0ZS5lbmRpbmcgJiYgIXN0cmVhbS5kZXN0cm95ZWQgJiYgc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLm5lZWREcmFpbjsKICAgIGlmIChuZWVkRHJhaW4pIHsKICAgICAgc3RhdGUubmVlZERyYWluID0gZmFsc2U7CiAgICAgIHN0cmVhbS5lbWl0KCdkcmFpbicpOwogICAgfQogICAgd2hpbGUgKGNvdW50LS0gPiAwKSB7CiAgICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgICBjYigpOwogICAgfQogICAgaWYgKHN0YXRlLmRlc3Ryb3llZCkgewogICAgICBlcnJvckJ1ZmZlcihzdGF0ZSk7CiAgICB9CiAgICBmaW5pc2hNYXliZShzdHJlYW0sIHN0YXRlKTsKICB9CgogIC8vIElmIHRoZXJlJ3Mgc29tZXRoaW5nIGluIHRoZSBidWZmZXIgd2FpdGluZywgdGhlbiBpbnZva2UgY2FsbGJhY2tzLgogIGZ1bmN0aW9uIGVycm9yQnVmZmVyKHN0YXRlKSB7CiAgICBpZiAoc3RhdGUud3JpdGluZykgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGxldCBuID0gc3RhdGUuYnVmZmVyZWRJbmRleDsgbiA8IHN0YXRlLmJ1ZmZlcmVkLmxlbmd0aDsgKytuKSB7CiAgICAgIHZhciBfc3RhdGUkZXJyb3JlZDsKICAgICAgY29uc3QgewogICAgICAgIGNodW5rLAogICAgICAgIGNhbGxiYWNrCiAgICAgIH0gPSBzdGF0ZS5idWZmZXJlZFtuXTsKICAgICAgY29uc3QgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CiAgICAgIHN0YXRlLmxlbmd0aCAtPSBsZW47CiAgICAgIGNhbGxiYWNrKChfc3RhdGUkZXJyb3JlZCA9IHN0YXRlLmVycm9yZWQpICE9PSBudWxsICYmIF9zdGF0ZSRlcnJvcmVkICE9PSB1bmRlZmluZWQgPyBfc3RhdGUkZXJyb3JlZCA6IG5ldyBFUlJfU1RSRUFNX0RFU1RST1lFRCgnd3JpdGUnKSk7CiAgICB9CiAgICBjb25zdCBvbmZpbmlzaENhbGxiYWNrcyA9IHN0YXRlW2tPbkZpbmlzaGVkXS5zcGxpY2UoMCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9uZmluaXNoQ2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBfc3RhdGUkZXJyb3JlZDI7CiAgICAgIG9uZmluaXNoQ2FsbGJhY2tzW2ldKChfc3RhdGUkZXJyb3JlZDIgPSBzdGF0ZS5lcnJvcmVkKSAhPT0gbnVsbCAmJiBfc3RhdGUkZXJyb3JlZDIgIT09IHVuZGVmaW5lZCA/IF9zdGF0ZSRlcnJvcmVkMiA6IG5ldyBFUlJfU1RSRUFNX0RFU1RST1lFRCgnZW5kJykpOwogICAgfQogICAgcmVzZXRCdWZmZXIoc3RhdGUpOwogIH0KCiAgLy8gSWYgdGhlcmUncyBzb21ldGhpbmcgaW4gdGhlIGJ1ZmZlciB3YWl0aW5nLCB0aGVuIHByb2Nlc3MgaXQuCiAgZnVuY3Rpb24gY2xlYXJCdWZmZXIoc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKHN0YXRlLmNvcmtlZCB8fCBzdGF0ZS5idWZmZXJQcm9jZXNzaW5nIHx8IHN0YXRlLmRlc3Ryb3llZCB8fCAhc3RhdGUuY29uc3RydWN0ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBidWZmZXJlZCwKICAgICAgYnVmZmVyZWRJbmRleCwKICAgICAgb2JqZWN0TW9kZQogICAgfSA9IHN0YXRlOwogICAgY29uc3QgYnVmZmVyZWRMZW5ndGggPSBidWZmZXJlZC5sZW5ndGggLSBidWZmZXJlZEluZGV4OwogICAgaWYgKCFidWZmZXJlZExlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgaSA9IGJ1ZmZlcmVkSW5kZXg7CiAgICBzdGF0ZS5idWZmZXJQcm9jZXNzaW5nID0gdHJ1ZTsKICAgIGlmIChidWZmZXJlZExlbmd0aCA+IDEgJiYgc3RyZWFtLl93cml0ZXYpIHsKICAgICAgc3RhdGUucGVuZGluZ2NiIC09IGJ1ZmZlcmVkTGVuZ3RoIC0gMTsKICAgICAgY29uc3QgY2FsbGJhY2sgPSBzdGF0ZS5hbGxOb29wID8gbm9wIDogZXJyID0+IHsKICAgICAgICBmb3IgKGxldCBuID0gaTsgbiA8IGJ1ZmZlcmVkLmxlbmd0aDsgKytuKSB7CiAgICAgICAgICBidWZmZXJlZFtuXS5jYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgLy8gTWFrZSBhIGNvcHkgb2YgYGJ1ZmZlcmVkYCBpZiBpdCdzIGdvaW5nIHRvIGJlIHVzZWQgYnkgYGNhbGxiYWNrYCBhYm92ZSwKICAgICAgLy8gc2luY2UgYGRvV3JpdGVgIHdpbGwgbXV0YXRlIHRoZSBhcnJheS4KICAgICAgY29uc3QgY2h1bmtzID0gc3RhdGUuYWxsTm9vcCAmJiBpID09PSAwID8gYnVmZmVyZWQgOiBBcnJheVByb3RvdHlwZVNsaWNlKGJ1ZmZlcmVkLCBpKTsKICAgICAgY2h1bmtzLmFsbEJ1ZmZlcnMgPSBzdGF0ZS5hbGxCdWZmZXJzOwogICAgICBkb1dyaXRlKHN0cmVhbSwgc3RhdGUsIHRydWUsIHN0YXRlLmxlbmd0aCwgY2h1bmtzLCAnJywgY2FsbGJhY2spOwogICAgICByZXNldEJ1ZmZlcihzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBkbyB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgY2h1bmssCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGNhbGxiYWNrCiAgICAgICAgfSA9IGJ1ZmZlcmVkW2ldOwogICAgICAgIGJ1ZmZlcmVkW2krK10gPSBudWxsOwogICAgICAgIGNvbnN0IGxlbiA9IG9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwogICAgICAgIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgZmFsc2UsIGxlbiwgY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjayk7CiAgICAgIH0gd2hpbGUgKGkgPCBidWZmZXJlZC5sZW5ndGggJiYgIXN0YXRlLndyaXRpbmcpOwogICAgICBpZiAoaSA9PT0gYnVmZmVyZWQubGVuZ3RoKSB7CiAgICAgICAgcmVzZXRCdWZmZXIoc3RhdGUpOwogICAgICB9IGVsc2UgaWYgKGkgPiAyNTYpIHsKICAgICAgICBidWZmZXJlZC5zcGxpY2UoMCwgaSk7CiAgICAgICAgc3RhdGUuYnVmZmVyZWRJbmRleCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGUuYnVmZmVyZWRJbmRleCA9IGk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgPSBmYWxzZTsKICB9CiAgV3JpdGFibGUucHJvdG90eXBlLl93cml0ZSA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBpZiAodGhpcy5fd3JpdGV2KSB7CiAgICAgIHRoaXMuX3dyaXRldihbewogICAgICAgIGNodW5rLAogICAgICAgIGVuY29kaW5nCiAgICAgIH1dLCBjYik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRVJSX01FVEhPRF9OT1RfSU1QTEVNRU5URUQoJ193cml0ZSgpJyk7CiAgICB9CiAgfTsKICBXcml0YWJsZS5wcm90b3R5cGUuX3dyaXRldiA9IG51bGw7CiAgV3JpdGFibGUucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgICBpZiAodHlwZW9mIGNodW5rID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNiID0gY2h1bms7CiAgICAgIGNodW5rID0gbnVsbDsKICAgICAgZW5jb2RpbmcgPSBudWxsOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSBlbmNvZGluZzsKICAgICAgZW5jb2RpbmcgPSBudWxsOwogICAgfQogICAgbGV0IGVycjsKICAgIGlmIChjaHVuayAhPT0gbnVsbCAmJiBjaHVuayAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNvbnN0IHJldCA9IF93cml0ZSh0aGlzLCBjaHVuaywgZW5jb2RpbmcpOwogICAgICBpZiAocmV0IGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBlcnIgPSByZXQ7CiAgICAgIH0KICAgIH0KCiAgICAvLyAuZW5kKCkgZnVsbHkgdW5jb3Jrcy4KICAgIGlmIChzdGF0ZS5jb3JrZWQpIHsKICAgICAgc3RhdGUuY29ya2VkID0gMTsKICAgICAgdGhpcy51bmNvcmsoKTsKICAgIH0KICAgIGlmIChlcnIpIDsgZWxzZSBpZiAoIXN0YXRlLmVycm9yZWQgJiYgIXN0YXRlLmVuZGluZykgewogICAgICAvLyBUaGlzIGlzIGZvcmdpdmluZyBpbiB0ZXJtcyBvZiB1bm5lY2Vzc2FyeSBjYWxscyB0byBlbmQoKSBhbmQgY2FuIGhpZGUKICAgICAgLy8gbG9naWMgZXJyb3JzLiBIb3dldmVyLCB1c3VhbGx5IHN1Y2ggZXJyb3JzIGFyZSBoYXJtbGVzcyBhbmQgY2F1c2luZyBhCiAgICAgIC8vIGhhcmQgZXJyb3IgY2FuIGJlIGRpc3Byb3BvcnRpb25hdGVseSBkZXN0cnVjdGl2ZS4gSXQgaXMgbm90IGFsd2F5cwogICAgICAvLyB0cml2aWFsIGZvciB0aGUgdXNlciB0byBkZXRlcm1pbmUgd2hldGhlciBlbmQoKSBuZWVkcyB0byBiZSBjYWxsZWQKICAgICAgLy8gb3Igbm90LgoKICAgICAgc3RhdGUuZW5kaW5nID0gdHJ1ZTsKICAgICAgZmluaXNoTWF5YmUodGhpcywgc3RhdGUsIHRydWUpOwogICAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHN0YXRlLmZpbmlzaGVkKSB7CiAgICAgIGVyciA9IG5ldyBFUlJfU1RSRUFNX0FMUkVBRFlfRklOSVNIRUQoJ2VuZCcpOwogICAgfSBlbHNlIGlmIChzdGF0ZS5kZXN0cm95ZWQpIHsKICAgICAgZXJyID0gbmV3IEVSUl9TVFJFQU1fREVTVFJPWUVEKCdlbmQnKTsKICAgIH0KICAgIGlmICh0eXBlb2YgY2IgPT09ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKGVyciB8fCBzdGF0ZS5maW5pc2hlZCkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IsIGVycik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RhdGVba09uRmluaXNoZWRdLnB1c2goY2IpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIG5lZWRGaW5pc2goc3RhdGUpIHsKICAgIHJldHVybiBzdGF0ZS5lbmRpbmcgJiYgIXN0YXRlLmRlc3Ryb3llZCAmJiBzdGF0ZS5jb25zdHJ1Y3RlZCAmJiBzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLmVycm9yZWQgJiYgc3RhdGUuYnVmZmVyZWQubGVuZ3RoID09PSAwICYmICFzdGF0ZS5maW5pc2hlZCAmJiAhc3RhdGUud3JpdGluZyAmJiAhc3RhdGUuZXJyb3JFbWl0dGVkICYmICFzdGF0ZS5jbG9zZUVtaXR0ZWQ7CiAgfQogIGZ1bmN0aW9uIGNhbGxGaW5hbChzdHJlYW0sIHN0YXRlKSB7CiAgICBsZXQgY2FsbGVkID0gZmFsc2U7CiAgICBmdW5jdGlvbiBvbkZpbmlzaChlcnIpIHsKICAgICAgaWYgKGNhbGxlZCkgewogICAgICAgIGVycm9yT3JEZXN0cm95KHN0cmVhbSwgZXJyICE9PSBudWxsICYmIGVyciAhPT0gdW5kZWZpbmVkID8gZXJyIDogRVJSX01VTFRJUExFX0NBTExCQUNLKCkpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjYWxsZWQgPSB0cnVlOwogICAgICBzdGF0ZS5wZW5kaW5nY2ItLTsKICAgICAgaWYgKGVycikgewogICAgICAgIGNvbnN0IG9uZmluaXNoQ2FsbGJhY2tzID0gc3RhdGVba09uRmluaXNoZWRdLnNwbGljZSgwKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9uZmluaXNoQ2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBvbmZpbmlzaENhbGxiYWNrc1tpXShlcnIpOwogICAgICAgIH0KICAgICAgICBlcnJvck9yRGVzdHJveShzdHJlYW0sIGVyciwgc3RhdGUuc3luYyk7CiAgICAgIH0gZWxzZSBpZiAobmVlZEZpbmlzaChzdGF0ZSkpIHsKICAgICAgICBzdGF0ZS5wcmVmaW5pc2hlZCA9IHRydWU7CiAgICAgICAgc3RyZWFtLmVtaXQoJ3ByZWZpbmlzaCcpOwogICAgICAgIC8vIEJhY2t3YXJkcyBjb21wYXQuIERvbid0IGNoZWNrIHN0YXRlLnN5bmMgaGVyZS4KICAgICAgICAvLyBTb21lIHN0cmVhbXMgYXNzdW1lICdmaW5pc2gnIHdpbGwgYmUgZW1pdHRlZAogICAgICAgIC8vIGFzeW5jaHJvbm91c2x5IHJlbGF0aXZlIHRvIF9maW5hbCBjYWxsYmFjay4KICAgICAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZpbmlzaCwgc3RyZWFtLCBzdGF0ZSk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlLnN5bmMgPSB0cnVlOwogICAgc3RhdGUucGVuZGluZ2NiKys7CiAgICB0cnkgewogICAgICBzdHJlYW0uX2ZpbmFsKG9uRmluaXNoKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBvbkZpbmlzaChlcnIpOwogICAgfQogICAgc3RhdGUuc3luYyA9IGZhbHNlOwogIH0KICBmdW5jdGlvbiBwcmVmaW5pc2goc3RyZWFtLCBzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5wcmVmaW5pc2hlZCAmJiAhc3RhdGUuZmluYWxDYWxsZWQpIHsKICAgICAgaWYgKHR5cGVvZiBzdHJlYW0uX2ZpbmFsID09PSAnZnVuY3Rpb24nICYmICFzdGF0ZS5kZXN0cm95ZWQpIHsKICAgICAgICBzdGF0ZS5maW5hbENhbGxlZCA9IHRydWU7CiAgICAgICAgY2FsbEZpbmFsKHN0cmVhbSwgc3RhdGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0YXRlLnByZWZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICBzdHJlYW0uZW1pdCgncHJlZmluaXNoJyk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSwgc3luYykgewogICAgaWYgKG5lZWRGaW5pc2goc3RhdGUpKSB7CiAgICAgIHByZWZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICAgICAgaWYgKHN0YXRlLnBlbmRpbmdjYiA9PT0gMCkgewogICAgICAgIGlmIChzeW5jKSB7CiAgICAgICAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soKHN0cmVhbSwgc3RhdGUpID0+IHsKICAgICAgICAgICAgaWYgKG5lZWRGaW5pc2goc3RhdGUpKSB7CiAgICAgICAgICAgICAgZmluaXNoKHN0cmVhbSwgc3RhdGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBzdHJlYW0sIHN0YXRlKTsKICAgICAgICB9IGVsc2UgaWYgKG5lZWRGaW5pc2goc3RhdGUpKSB7CiAgICAgICAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgICAgICAgIGZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluaXNoKHN0cmVhbSwgc3RhdGUpIHsKICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgc3RhdGUuZmluaXNoZWQgPSB0cnVlOwogICAgY29uc3Qgb25maW5pc2hDYWxsYmFja3MgPSBzdGF0ZVtrT25GaW5pc2hlZF0uc3BsaWNlKDApOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvbmZpbmlzaENhbGxiYWNrcy5sZW5ndGg7IGkrKykgewogICAgICBvbmZpbmlzaENhbGxiYWNrc1tpXSgpOwogICAgfQogICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpOwogICAgaWYgKHN0YXRlLmF1dG9EZXN0cm95KSB7CiAgICAgIC8vIEluIGNhc2Ugb2YgZHVwbGV4IHN0cmVhbXMgd2UgbmVlZCBhIHdheSB0byBkZXRlY3QKICAgICAgLy8gaWYgdGhlIHJlYWRhYmxlIHNpZGUgaXMgcmVhZHkgZm9yIGF1dG9EZXN0cm95IGFzIHdlbGwuCiAgICAgIGNvbnN0IHJTdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICAgICAgY29uc3QgYXV0b0Rlc3Ryb3kgPSAhclN0YXRlIHx8IHJTdGF0ZS5hdXRvRGVzdHJveSAmJiAoCiAgICAgIC8vIFdlIGRvbid0IGV4cGVjdCB0aGUgcmVhZGFibGUgdG8gZXZlciAnZW5kJwogICAgICAvLyBpZiByZWFkYWJsZSBpcyBleHBsaWNpdGx5IHNldCB0byBmYWxzZS4KICAgICAgclN0YXRlLmVuZEVtaXR0ZWQgfHwgclN0YXRlLnJlYWRhYmxlID09PSBmYWxzZSk7CiAgICAgIGlmIChhdXRvRGVzdHJveSkgewogICAgICAgIHN0cmVhbS5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KICB9CiAgT2JqZWN0RGVmaW5lUHJvcGVydGllcyhXcml0YWJsZS5wcm90b3R5cGUsIHsKICAgIGNsb3NlZDogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZSA/IHRoaXMuX3dyaXRhYmxlU3RhdGUuY2xvc2VkIDogZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICBkZXN0cm95ZWQ6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUgPyB0aGlzLl93cml0YWJsZVN0YXRlLmRlc3Ryb3llZCA6IGZhbHNlOwogICAgICB9LAogICAgICBzZXQodmFsdWUpIHsKICAgICAgICAvLyBCYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB0aGUgdXNlciBpcyBleHBsaWNpdGx5IG1hbmFnaW5nIGRlc3Ryb3llZC4KICAgICAgICBpZiAodGhpcy5fd3JpdGFibGVTdGF0ZSkgewogICAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5kZXN0cm95ZWQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZTogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICBjb25zdCB3ID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKICAgICAgICAvLyB3LndyaXRhYmxlID09PSBmYWxzZSBtZWFucyB0aGF0IHRoaXMgaXMgcGFydCBvZiBhIER1cGxleCBzdHJlYW0KICAgICAgICAvLyB3aGVyZSB0aGUgd3JpdGFibGUgc2lkZSB3YXMgZGlzYWJsZWQgdXBvbiBjb25zdHJ1Y3Rpb24uCiAgICAgICAgLy8gQ29tcGF0LiBUaGUgdXNlciBtaWdodCBtYW51YWxseSBkaXNhYmxlIHdyaXRhYmxlIHNpZGUgdGhyb3VnaAogICAgICAgIC8vIGRlcHJlY2F0ZWQgc2V0dGVyLgogICAgICAgIHJldHVybiAhIXcgJiYgdy53cml0YWJsZSAhPT0gZmFsc2UgJiYgIXcuZGVzdHJveWVkICYmICF3LmVycm9yZWQgJiYgIXcuZW5kaW5nICYmICF3LmVuZGVkOwogICAgICB9LAogICAgICBzZXQodmFsKSB7CiAgICAgICAgLy8gQmFja3dhcmRzIGNvbXBhdGlibGUuCiAgICAgICAgaWYgKHRoaXMuX3dyaXRhYmxlU3RhdGUpIHsKICAgICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUud3JpdGFibGUgPSAhIXZhbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZUZpbmlzaGVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlID8gdGhpcy5fd3JpdGFibGVTdGF0ZS5maW5pc2hlZCA6IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgd3JpdGFibGVPYmplY3RNb2RlOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlID8gdGhpcy5fd3JpdGFibGVTdGF0ZS5vYmplY3RNb2RlIDogZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZUJ1ZmZlcjogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZSAmJiB0aGlzLl93cml0YWJsZVN0YXRlLmdldEJ1ZmZlcigpOwogICAgICB9CiAgICB9LAogICAgd3JpdGFibGVFbmRlZDogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZSA/IHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kaW5nIDogZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZU5lZWREcmFpbjogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICBjb25zdCB3U3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwogICAgICAgIGlmICghd1N0YXRlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuICF3U3RhdGUuZGVzdHJveWVkICYmICF3U3RhdGUuZW5kaW5nICYmIHdTdGF0ZS5uZWVkRHJhaW47CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZUhpZ2hXYXRlck1hcms6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUgJiYgdGhpcy5fd3JpdGFibGVTdGF0ZS5oaWdoV2F0ZXJNYXJrOwogICAgICB9CiAgICB9LAogICAgd3JpdGFibGVDb3JrZWQ6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlU3RhdGUgPyB0aGlzLl93cml0YWJsZVN0YXRlLmNvcmtlZCA6IDA7CiAgICAgIH0KICAgIH0sCiAgICB3cml0YWJsZUxlbmd0aDogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGdldCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGVTdGF0ZSAmJiB0aGlzLl93cml0YWJsZVN0YXRlLmxlbmd0aDsKICAgICAgfQogICAgfSwKICAgIGVycm9yZWQ6IHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZVN0YXRlID8gdGhpcy5fd3JpdGFibGVTdGF0ZS5lcnJvcmVkIDogbnVsbDsKICAgICAgfQogICAgfSwKICAgIHdyaXRhYmxlQWJvcnRlZDogewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gISEodGhpcy5fd3JpdGFibGVTdGF0ZS53cml0YWJsZSAhPT0gZmFsc2UgJiYgKHRoaXMuX3dyaXRhYmxlU3RhdGUuZGVzdHJveWVkIHx8IHRoaXMuX3dyaXRhYmxlU3RhdGUuZXJyb3JlZCkgJiYgIXRoaXMuX3dyaXRhYmxlU3RhdGUuZmluaXNoZWQpOwogICAgICB9CiAgICB9CiAgfSk7CiAgY29uc3QgZGVzdHJveSA9IGRlc3Ryb3lJbXBsLmRlc3Ryb3k7CiAgV3JpdGFibGUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoZXJyLCBjYikgewogICAgY29uc3Qgc3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwoKICAgIC8vIEludm9rZSBwZW5kaW5nIGNhbGxiYWNrcy4KICAgIGlmICghc3RhdGUuZGVzdHJveWVkICYmIChzdGF0ZS5idWZmZXJlZEluZGV4IDwgc3RhdGUuYnVmZmVyZWQubGVuZ3RoIHx8IHN0YXRlW2tPbkZpbmlzaGVkXS5sZW5ndGgpKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZXJyb3JCdWZmZXIsIHN0YXRlKTsKICAgIH0KICAgIGRlc3Ryb3kuY2FsbCh0aGlzLCBlcnIsIGNiKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgV3JpdGFibGUucHJvdG90eXBlLl91bmRlc3Ryb3kgPSBkZXN0cm95SW1wbC51bmRlc3Ryb3k7CiAgV3JpdGFibGUucHJvdG90eXBlLl9kZXN0cm95ID0gZnVuY3Rpb24gKGVyciwgY2IpIHsKICAgIGNiKGVycik7CiAgfTsKICBXcml0YWJsZS5wcm90b3R5cGVbRUUuY2FwdHVyZVJlamVjdGlvblN5bWJvbF0gPSBmdW5jdGlvbiAoZXJyKSB7CiAgICB0aGlzLmRlc3Ryb3koZXJyKTsKICB9OwogIGxldCB3ZWJTdHJlYW1zQWRhcHRlcnM7CgogIC8vIExhenkgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogIGZ1bmN0aW9uIGxhenlXZWJTdHJlYW1zKCkgewogICAgaWYgKHdlYlN0cmVhbXNBZGFwdGVycyA9PT0gdW5kZWZpbmVkKSB3ZWJTdHJlYW1zQWRhcHRlcnMgPSB7fTsKICAgIHJldHVybiB3ZWJTdHJlYW1zQWRhcHRlcnM7CiAgfQogIFdyaXRhYmxlLmZyb21XZWIgPSBmdW5jdGlvbiAod3JpdGFibGVTdHJlYW0sIG9wdGlvbnMpIHsKICAgIHJldHVybiBsYXp5V2ViU3RyZWFtcygpLm5ld1N0cmVhbVdyaXRhYmxlRnJvbVdyaXRhYmxlU3RyZWFtKHdyaXRhYmxlU3RyZWFtLCBvcHRpb25zKTsKICB9OwogIFdyaXRhYmxlLnRvV2ViID0gZnVuY3Rpb24gKHN0cmVhbVdyaXRhYmxlKSB7CiAgICByZXR1cm4gbGF6eVdlYlN0cmVhbXMoKS5uZXdXcml0YWJsZVN0cmVhbUZyb21TdHJlYW1Xcml0YWJsZShzdHJlYW1Xcml0YWJsZSk7CiAgfTsKICByZXR1cm4gd3JpdGFibGU7Cn0KCi8qIHJlcGxhY2VtZW50IHN0YXJ0ICovCnZhciBkdXBsZXhpZnk7CnZhciBoYXNSZXF1aXJlZER1cGxleGlmeTsKZnVuY3Rpb24gcmVxdWlyZUR1cGxleGlmeSgpIHsKICBpZiAoaGFzUmVxdWlyZWREdXBsZXhpZnkpIHJldHVybiBkdXBsZXhpZnk7CiAgaGFzUmVxdWlyZWREdXBsZXhpZnkgPSAxOwogIGNvbnN0IHByb2Nlc3MgPSByZXF1aXJlUHJvY2VzcygpCgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLzsKICBjb25zdCBidWZmZXJNb2R1bGUgPSByZXF1aXJlJCQwJDM7CiAgY29uc3QgewogICAgaXNSZWFkYWJsZSwKICAgIGlzV3JpdGFibGUsCiAgICBpc0l0ZXJhYmxlLAogICAgaXNOb2RlU3RyZWFtLAogICAgaXNSZWFkYWJsZU5vZGVTdHJlYW0sCiAgICBpc1dyaXRhYmxlTm9kZVN0cmVhbSwKICAgIGlzRHVwbGV4Tm9kZVN0cmVhbSwKICAgIGlzUmVhZGFibGVTdHJlYW0sCiAgICBpc1dyaXRhYmxlU3RyZWFtCiAgfSA9IHJlcXVpcmVVdGlscyQxKCk7CiAgY29uc3QgZW9zID0gcmVxdWlyZUVuZE9mU3RyZWFtKCk7CiAgY29uc3QgewogICAgQWJvcnRFcnJvciwKICAgIGNvZGVzOiB7CiAgICAgIEVSUl9JTlZBTElEX0FSR19UWVBFLAogICAgICBFUlJfSU5WQUxJRF9SRVRVUk5fVkFMVUUKICAgIH0KICB9ID0gcmVxdWlyZUVycm9ycygpOwogIGNvbnN0IHsKICAgIGRlc3Ryb3llcgogIH0gPSByZXF1aXJlRGVzdHJveSgpOwogIGNvbnN0IER1cGxleCA9IHJlcXVpcmVEdXBsZXgoKTsKICBjb25zdCBSZWFkYWJsZSA9IHJlcXVpcmVSZWFkYWJsZSgpOwogIGNvbnN0IFdyaXRhYmxlID0gcmVxdWlyZVdyaXRhYmxlKCk7CiAgY29uc3QgewogICAgY3JlYXRlRGVmZXJyZWRQcm9taXNlCiAgfSA9IHJlcXVpcmVVdGlsJDEoKTsKICBjb25zdCBmcm9tID0gcmVxdWlyZUZyb20oKTsKICBjb25zdCBCbG9iID0gZ2xvYmFsVGhpcy5CbG9iIHx8IGJ1ZmZlck1vZHVsZS5CbG9iOwogIGNvbnN0IGlzQmxvYiA9IHR5cGVvZiBCbG9iICE9PSAndW5kZWZpbmVkJyA/IGZ1bmN0aW9uIGlzQmxvYihiKSB7CiAgICByZXR1cm4gYiBpbnN0YW5jZW9mIEJsb2I7CiAgfSA6IGZ1bmN0aW9uIGlzQmxvYihiKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfTsKICBjb25zdCBBYm9ydENvbnRyb2xsZXIgPSBnbG9iYWxUaGlzLkFib3J0Q29udHJvbGxlciB8fCByZXF1aXJlJCQwJDEuQWJvcnRDb250cm9sbGVyOwogIGNvbnN0IHsKICAgIEZ1bmN0aW9uUHJvdG90eXBlQ2FsbAogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKCiAgLy8gVGhpcyBpcyBuZWVkZWQgZm9yIHByZSBub2RlIDE3LgogIGNsYXNzIER1cGxleGlmeSBleHRlbmRzIER1cGxleCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIHN1cGVyKG9wdGlvbnMpOwoKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL3B1bGwvMzQzODUKCiAgICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRpb25zLnJlYWRhYmxlKSA9PT0gZmFsc2UpIHsKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnJlYWRhYmxlID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmRFbWl0dGVkID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3B0aW9ucy53cml0YWJsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS53cml0YWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kaW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlLmVuZGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KICBkdXBsZXhpZnkgPSBmdW5jdGlvbiBkdXBsZXhpZnkoYm9keSwgbmFtZSkgewogICAgaWYgKGlzRHVwbGV4Tm9kZVN0cmVhbShib2R5KSkgewogICAgICByZXR1cm4gYm9keTsKICAgIH0KICAgIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbShib2R5KSkgewogICAgICByZXR1cm4gX2R1cGxleGlmeSh7CiAgICAgICAgcmVhZGFibGU6IGJvZHkKICAgICAgfSk7CiAgICB9CiAgICBpZiAoaXNXcml0YWJsZU5vZGVTdHJlYW0oYm9keSkpIHsKICAgICAgcmV0dXJuIF9kdXBsZXhpZnkoewogICAgICAgIHdyaXRhYmxlOiBib2R5CiAgICAgIH0pOwogICAgfQogICAgaWYgKGlzTm9kZVN0cmVhbShib2R5KSkgewogICAgICByZXR1cm4gX2R1cGxleGlmeSh7CiAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgIHJlYWRhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIGlmIChpc1JlYWRhYmxlU3RyZWFtKGJvZHkpKSB7CiAgICAgIHJldHVybiBfZHVwbGV4aWZ5KHsKICAgICAgICByZWFkYWJsZTogUmVhZGFibGUuZnJvbVdlYihib2R5KQogICAgICB9KTsKICAgIH0KICAgIGlmIChpc1dyaXRhYmxlU3RyZWFtKGJvZHkpKSB7CiAgICAgIHJldHVybiBfZHVwbGV4aWZ5KHsKICAgICAgICB3cml0YWJsZTogV3JpdGFibGUuZnJvbVdlYihib2R5KQogICAgICB9KTsKICAgIH0KICAgIGlmICh0eXBlb2YgYm9keSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjb25zdCB7CiAgICAgICAgdmFsdWUsCiAgICAgICAgd3JpdGUsCiAgICAgICAgZmluYWwsCiAgICAgICAgZGVzdHJveQogICAgICB9ID0gZnJvbUFzeW5jR2VuKGJvZHkpOwogICAgICBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZnJvbShEdXBsZXhpZnksIHZhbHVlLCB7CiAgICAgICAgICAvLyBUT0RPIChyb25hZyk6IGhpZ2hXYXRlck1hcms/CiAgICAgICAgICBvYmplY3RNb2RlOiB0cnVlLAogICAgICAgICAgd3JpdGUsCiAgICAgICAgICBmaW5hbCwKICAgICAgICAgIGRlc3Ryb3kKICAgICAgICB9KTsKICAgICAgfQogICAgICBjb25zdCB0aGVuID0gdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IHZhbHVlLnRoZW47CiAgICAgIGlmICh0eXBlb2YgdGhlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGxldCBkOwogICAgICAgIGNvbnN0IHByb21pc2UgPSBGdW5jdGlvblByb3RvdHlwZUNhbGwodGhlbiwgdmFsdWUsIHZhbCA9PiB7CiAgICAgICAgICBpZiAodmFsICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX1JFVFVSTl9WQUxVRSgnbnVsbHknLCAnYm9keScsIHZhbCk7CiAgICAgICAgICB9CiAgICAgICAgfSwgZXJyID0+IHsKICAgICAgICAgIGRlc3Ryb3llcihkLCBlcnIpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkID0gbmV3IER1cGxleGlmeSh7CiAgICAgICAgICAvLyBUT0RPIChyb25hZyk6IGhpZ2hXYXRlck1hcms/CiAgICAgICAgICBvYmplY3RNb2RlOiB0cnVlLAogICAgICAgICAgcmVhZGFibGU6IGZhbHNlLAogICAgICAgICAgd3JpdGUsCiAgICAgICAgICBmaW5hbChjYikgewogICAgICAgICAgICBmaW5hbChhc3luYyAoKSA9PiB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHByb21pc2U7CiAgICAgICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGNiLCBudWxsKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IsIGVycik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXN0cm95CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX1JFVFVSTl9WQUxVRSgnSXRlcmFibGUsIEFzeW5jSXRlcmFibGUgb3IgQXN5bmNGdW5jdGlvbicsIG5hbWUsIHZhbHVlKTsKICAgIH0KICAgIGlmIChpc0Jsb2IoYm9keSkpIHsKICAgICAgcmV0dXJuIGR1cGxleGlmeShib2R5LmFycmF5QnVmZmVyKCkpOwogICAgfQogICAgaWYgKGlzSXRlcmFibGUoYm9keSkpIHsKICAgICAgcmV0dXJuIGZyb20oRHVwbGV4aWZ5LCBib2R5LCB7CiAgICAgICAgLy8gVE9ETyAocm9uYWcpOiBoaWdoV2F0ZXJNYXJrPwogICAgICAgIG9iamVjdE1vZGU6IHRydWUsCiAgICAgICAgd3JpdGFibGU6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGlzUmVhZGFibGVTdHJlYW0oYm9keSA9PT0gbnVsbCB8fCBib2R5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBib2R5LnJlYWRhYmxlKSAmJiBpc1dyaXRhYmxlU3RyZWFtKGJvZHkgPT09IG51bGwgfHwgYm9keSA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogYm9keS53cml0YWJsZSkpIHsKICAgICAgcmV0dXJuIER1cGxleGlmeS5mcm9tV2ViKGJvZHkpOwogICAgfQogICAgaWYgKHR5cGVvZiAoYm9keSA9PT0gbnVsbCB8fCBib2R5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBib2R5LndyaXRhYmxlKSA9PT0gJ29iamVjdCcgfHwgdHlwZW9mIChib2R5ID09PSBudWxsIHx8IGJvZHkgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGJvZHkucmVhZGFibGUpID09PSAnb2JqZWN0JykgewogICAgICBjb25zdCByZWFkYWJsZSA9IGJvZHkgIT09IG51bGwgJiYgYm9keSAhPT0gdW5kZWZpbmVkICYmIGJvZHkucmVhZGFibGUgPyBpc1JlYWRhYmxlTm9kZVN0cmVhbShib2R5ID09PSBudWxsIHx8IGJvZHkgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGJvZHkucmVhZGFibGUpID8gYm9keSA9PT0gbnVsbCB8fCBib2R5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBib2R5LnJlYWRhYmxlIDogZHVwbGV4aWZ5KGJvZHkucmVhZGFibGUpIDogdW5kZWZpbmVkOwogICAgICBjb25zdCB3cml0YWJsZSA9IGJvZHkgIT09IG51bGwgJiYgYm9keSAhPT0gdW5kZWZpbmVkICYmIGJvZHkud3JpdGFibGUgPyBpc1dyaXRhYmxlTm9kZVN0cmVhbShib2R5ID09PSBudWxsIHx8IGJvZHkgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IGJvZHkud3JpdGFibGUpID8gYm9keSA9PT0gbnVsbCB8fCBib2R5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBib2R5LndyaXRhYmxlIDogZHVwbGV4aWZ5KGJvZHkud3JpdGFibGUpIDogdW5kZWZpbmVkOwogICAgICByZXR1cm4gX2R1cGxleGlmeSh7CiAgICAgICAgcmVhZGFibGUsCiAgICAgICAgd3JpdGFibGUKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCB0aGVuID0gYm9keSA9PT0gbnVsbCB8fCBib2R5ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBib2R5LnRoZW47CiAgICBpZiAodHlwZW9mIHRoZW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgbGV0IGQ7CiAgICAgIEZ1bmN0aW9uUHJvdG90eXBlQ2FsbCh0aGVuLCBib2R5LCB2YWwgPT4gewogICAgICAgIGlmICh2YWwgIT0gbnVsbCkgewogICAgICAgICAgZC5wdXNoKHZhbCk7CiAgICAgICAgfQogICAgICAgIGQucHVzaChudWxsKTsKICAgICAgfSwgZXJyID0+IHsKICAgICAgICBkZXN0cm95ZXIoZCwgZXJyKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBkID0gbmV3IER1cGxleGlmeSh7CiAgICAgICAgb2JqZWN0TW9kZTogdHJ1ZSwKICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgcmVhZCgpIHt9CiAgICAgIH0pOwogICAgfQogICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKG5hbWUsIFsnQmxvYicsICdSZWFkYWJsZVN0cmVhbScsICdXcml0YWJsZVN0cmVhbScsICdTdHJlYW0nLCAnSXRlcmFibGUnLCAnQXN5bmNJdGVyYWJsZScsICdGdW5jdGlvbicsICd7IHJlYWRhYmxlLCB3cml0YWJsZSB9IHBhaXInLCAnUHJvbWlzZSddLCBib2R5KTsKICB9OwogIGZ1bmN0aW9uIGZyb21Bc3luY0dlbihmbikgewogICAgbGV0IHsKICAgICAgcHJvbWlzZSwKICAgICAgcmVzb2x2ZQogICAgfSA9IGNyZWF0ZURlZmVycmVkUHJvbWlzZSgpOwogICAgY29uc3QgYWMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSBhYy5zaWduYWw7CiAgICBjb25zdCB2YWx1ZSA9IGZuKGFzeW5jIGZ1bmN0aW9uKiAoKSB7CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgY29uc3QgX3Byb21pc2UgPSBwcm9taXNlOwogICAgICAgIHByb21pc2UgPSBudWxsOwogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGNodW5rLAogICAgICAgICAgZG9uZSwKICAgICAgICAgIGNiCiAgICAgICAgfSA9IGF3YWl0IF9wcm9taXNlOwogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IpOwogICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB0aHJvdyBuZXcgQWJvcnRFcnJvcih1bmRlZmluZWQsIHsKICAgICAgICAgIGNhdXNlOiBzaWduYWwucmVhc29uCiAgICAgICAgfSk7CiAgICAgICAgKHsKICAgICAgICAgIHByb21pc2UsCiAgICAgICAgICByZXNvbHZlCiAgICAgICAgfSA9IGNyZWF0ZURlZmVycmVkUHJvbWlzZSgpKTsKICAgICAgICB5aWVsZCBjaHVuazsKICAgICAgfQogICAgfSgpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICByZXR1cm4gewogICAgICB2YWx1ZSwKICAgICAgd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgICAgIGNvbnN0IF9yZXNvbHZlID0gcmVzb2x2ZTsKICAgICAgICByZXNvbHZlID0gbnVsbDsKICAgICAgICBfcmVzb2x2ZSh7CiAgICAgICAgICBjaHVuaywKICAgICAgICAgIGRvbmU6IGZhbHNlLAogICAgICAgICAgY2IKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgZmluYWwoY2IpIHsKICAgICAgICBjb25zdCBfcmVzb2x2ZSA9IHJlc29sdmU7CiAgICAgICAgcmVzb2x2ZSA9IG51bGw7CiAgICAgICAgX3Jlc29sdmUoewogICAgICAgICAgZG9uZTogdHJ1ZSwKICAgICAgICAgIGNiCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3koZXJyLCBjYikgewogICAgICAgIGFjLmFib3J0KCk7CiAgICAgICAgY2IoZXJyKTsKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gX2R1cGxleGlmeShwYWlyKSB7CiAgICBjb25zdCByID0gcGFpci5yZWFkYWJsZSAmJiB0eXBlb2YgcGFpci5yZWFkYWJsZS5yZWFkICE9PSAnZnVuY3Rpb24nID8gUmVhZGFibGUud3JhcChwYWlyLnJlYWRhYmxlKSA6IHBhaXIucmVhZGFibGU7CiAgICBjb25zdCB3ID0gcGFpci53cml0YWJsZTsKICAgIGxldCByZWFkYWJsZSA9ICEhaXNSZWFkYWJsZShyKTsKICAgIGxldCB3cml0YWJsZSA9ICEhaXNXcml0YWJsZSh3KTsKICAgIGxldCBvbmRyYWluOwogICAgbGV0IG9uZmluaXNoOwogICAgbGV0IG9ucmVhZGFibGU7CiAgICBsZXQgb25jbG9zZTsKICAgIGxldCBkOwogICAgZnVuY3Rpb24gb25maW5pc2hlZChlcnIpIHsKICAgICAgY29uc3QgY2IgPSBvbmNsb3NlOwogICAgICBvbmNsb3NlID0gbnVsbDsKICAgICAgaWYgKGNiKSB7CiAgICAgICAgY2IoZXJyKTsKICAgICAgfSBlbHNlIGlmIChlcnIpIHsKICAgICAgICBkLmRlc3Ryb3koZXJyKTsKICAgICAgfQogICAgfQoKICAgIC8vIFRPRE8ocm9uYWcpOiBBdm9pZCBkb3VibGUgYnVmZmVyaW5nLgogICAgLy8gSW1wbGVtZW50IFdyaXRhYmxlL1JlYWRhYmxlL0R1cGxleCB0cmFpdHMuCiAgICAvLyBTZWUsIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9wdWxsLzMzNTE1LgogICAgZCA9IG5ldyBEdXBsZXhpZnkoewogICAgICAvLyBUT0RPIChyb25hZyk6IGhpZ2hXYXRlck1hcms/CiAgICAgIHJlYWRhYmxlT2JqZWN0TW9kZTogISEociAhPT0gbnVsbCAmJiByICE9PSB1bmRlZmluZWQgJiYgci5yZWFkYWJsZU9iamVjdE1vZGUpLAogICAgICB3cml0YWJsZU9iamVjdE1vZGU6ICEhKHcgIT09IG51bGwgJiYgdyAhPT0gdW5kZWZpbmVkICYmIHcud3JpdGFibGVPYmplY3RNb2RlKSwKICAgICAgcmVhZGFibGUsCiAgICAgIHdyaXRhYmxlCiAgICB9KTsKICAgIGlmICh3cml0YWJsZSkgewogICAgICBlb3ModywgZXJyID0+IHsKICAgICAgICB3cml0YWJsZSA9IGZhbHNlOwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGRlc3Ryb3llcihyLCBlcnIpOwogICAgICAgIH0KICAgICAgICBvbmZpbmlzaGVkKGVycik7CiAgICAgIH0pOwogICAgICBkLl93cml0ZSA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHcud3JpdGUoY2h1bmssIGVuY29kaW5nKSkgewogICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb25kcmFpbiA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZC5fZmluYWwgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICB3LmVuZCgpOwogICAgICAgIG9uZmluaXNoID0gY2FsbGJhY2s7CiAgICAgIH07CiAgICAgIHcub24oJ2RyYWluJywgZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChvbmRyYWluKSB7CiAgICAgICAgICBjb25zdCBjYiA9IG9uZHJhaW47CiAgICAgICAgICBvbmRyYWluID0gbnVsbDsKICAgICAgICAgIGNiKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdy5vbignZmluaXNoJywgZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChvbmZpbmlzaCkgewogICAgICAgICAgY29uc3QgY2IgPSBvbmZpbmlzaDsKICAgICAgICAgIG9uZmluaXNoID0gbnVsbDsKICAgICAgICAgIGNiKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGlmIChyZWFkYWJsZSkgewogICAgICBlb3MociwgZXJyID0+IHsKICAgICAgICByZWFkYWJsZSA9IGZhbHNlOwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGRlc3Ryb3llcihyLCBlcnIpOwogICAgICAgIH0KICAgICAgICBvbmZpbmlzaGVkKGVycik7CiAgICAgIH0pOwogICAgICByLm9uKCdyZWFkYWJsZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAob25yZWFkYWJsZSkgewogICAgICAgICAgY29uc3QgY2IgPSBvbnJlYWRhYmxlOwogICAgICAgICAgb25yZWFkYWJsZSA9IG51bGw7CiAgICAgICAgICBjYigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHIub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBkLnB1c2gobnVsbCk7CiAgICAgIH0pOwogICAgICBkLl9yZWFkID0gZnVuY3Rpb24gKCkgewogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBjb25zdCBidWYgPSByLnJlYWQoKTsKICAgICAgICAgIGlmIChidWYgPT09IG51bGwpIHsKICAgICAgICAgICAgb25yZWFkYWJsZSA9IGQuX3JlYWQ7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghZC5wdXNoKGJ1ZikpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGQuX2Rlc3Ryb3kgPSBmdW5jdGlvbiAoZXJyLCBjYWxsYmFjaykgewogICAgICBpZiAoIWVyciAmJiBvbmNsb3NlICE9PSBudWxsKSB7CiAgICAgICAgZXJyID0gbmV3IEFib3J0RXJyb3IoKTsKICAgICAgfQogICAgICBvbnJlYWRhYmxlID0gbnVsbDsKICAgICAgb25kcmFpbiA9IG51bGw7CiAgICAgIG9uZmluaXNoID0gbnVsbDsKICAgICAgaWYgKG9uY2xvc2UgPT09IG51bGwpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9IGVsc2UgewogICAgICAgIG9uY2xvc2UgPSBjYWxsYmFjazsKICAgICAgICBkZXN0cm95ZXIodywgZXJyKTsKICAgICAgICBkZXN0cm95ZXIociwgZXJyKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBkOwogIH0KICByZXR1cm4gZHVwbGV4aWZ5Owp9CgpmdW5jdGlvbiBvd25LZXlzJDYoZSwgcikgeyB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7IHIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbiAocikgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByKS5lbnVtZXJhYmxlOyB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsgfSByZXR1cm4gdDsgfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkJDYoZSkgeyBmb3IgKHZhciByID0gMTsgciA8IGFyZ3VtZW50cy5sZW5ndGg7IHIrKykgeyB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3JdID8gYXJndW1lbnRzW3JdIDoge307IHIgJSAyID8gb3duS2V5cyQ2KE9iamVjdCh0KSwgITApLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgX2RlZmluZVByb3BlcnR5KGUsIHIsIHRbcl0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyQ2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgciwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByKSk7IH0pOyB9IHJldHVybiBlOyB9CnZhciBkdXBsZXg7CnZhciBoYXNSZXF1aXJlZER1cGxleDsKZnVuY3Rpb24gcmVxdWlyZUR1cGxleCgpIHsKICBpZiAoaGFzUmVxdWlyZWREdXBsZXgpIHJldHVybiBkdXBsZXg7CiAgaGFzUmVxdWlyZWREdXBsZXggPSAxOwogIGNvbnN0IHsKICAgIE9iamVjdERlZmluZVByb3BlcnRpZXMsCiAgICBPYmplY3RHZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IsCiAgICBPYmplY3RLZXlzLAogICAgT2JqZWN0U2V0UHJvdG90eXBlT2YKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgZHVwbGV4ID0gRHVwbGV4OwogIGNvbnN0IFJlYWRhYmxlID0gcmVxdWlyZVJlYWRhYmxlKCk7CiAgY29uc3QgV3JpdGFibGUgPSByZXF1aXJlV3JpdGFibGUoKTsKICBPYmplY3RTZXRQcm90b3R5cGVPZihEdXBsZXgucHJvdG90eXBlLCBSZWFkYWJsZS5wcm90b3R5cGUpOwogIE9iamVjdFNldFByb3RvdHlwZU9mKER1cGxleCwgUmVhZGFibGUpOwogIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3RLZXlzKFdyaXRhYmxlLnByb3RvdHlwZSk7CiAgICAvLyBBbGxvdyB0aGUga2V5cyBhcnJheSB0byBiZSBHQydlZC4KICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBtZXRob2QgPSBrZXlzW2ldOwogICAgICBpZiAoIUR1cGxleC5wcm90b3R5cGVbbWV0aG9kXSkgRHVwbGV4LnByb3RvdHlwZVttZXRob2RdID0gV3JpdGFibGUucHJvdG90eXBlW21ldGhvZF07CiAgICB9CiAgfQogIGZ1bmN0aW9uIER1cGxleChvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgRHVwbGV4KSkgcmV0dXJuIG5ldyBEdXBsZXgob3B0aW9ucyk7CiAgICBSZWFkYWJsZS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgV3JpdGFibGUuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIHRoaXMuYWxsb3dIYWxmT3BlbiA9IG9wdGlvbnMuYWxsb3dIYWxmT3BlbiAhPT0gZmFsc2U7CiAgICAgIGlmIChvcHRpb25zLnJlYWRhYmxlID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUucmVhZGFibGUgPSBmYWxzZTsKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmVuZGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLndyaXRhYmxlID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuX3dyaXRhYmxlU3RhdGUud3JpdGFibGUgPSBmYWxzZTsKICAgICAgICB0aGlzLl93cml0YWJsZVN0YXRlLmVuZGluZyA9IHRydWU7CiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5lbmRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5maW5pc2hlZCA9IHRydWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWxsb3dIYWxmT3BlbiA9IHRydWU7CiAgICB9CiAgfQogIE9iamVjdERlZmluZVByb3BlcnRpZXMoRHVwbGV4LnByb3RvdHlwZSwgewogICAgd3JpdGFibGU6IF9vYmplY3RTcHJlYWQkNih7CiAgICAgIF9fcHJvdG9fXzogbnVsbAogICAgfSwgT2JqZWN0R2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFdyaXRhYmxlLnByb3RvdHlwZSwgJ3dyaXRhYmxlJykpLAogICAgd3JpdGFibGVIaWdoV2F0ZXJNYXJrOiBfb2JqZWN0U3ByZWFkJDYoewogICAgICBfX3Byb3RvX186IG51bGwKICAgIH0sIE9iamVjdEdldE93blByb3BlcnR5RGVzY3JpcHRvcihXcml0YWJsZS5wcm90b3R5cGUsICd3cml0YWJsZUhpZ2hXYXRlck1hcmsnKSksCiAgICB3cml0YWJsZU9iamVjdE1vZGU6IF9vYmplY3RTcHJlYWQkNih7CiAgICAgIF9fcHJvdG9fXzogbnVsbAogICAgfSwgT2JqZWN0R2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFdyaXRhYmxlLnByb3RvdHlwZSwgJ3dyaXRhYmxlT2JqZWN0TW9kZScpKSwKICAgIHdyaXRhYmxlQnVmZmVyOiBfb2JqZWN0U3ByZWFkJDYoewogICAgICBfX3Byb3RvX186IG51bGwKICAgIH0sIE9iamVjdEdldE93blByb3BlcnR5RGVzY3JpcHRvcihXcml0YWJsZS5wcm90b3R5cGUsICd3cml0YWJsZUJ1ZmZlcicpKSwKICAgIHdyaXRhYmxlTGVuZ3RoOiBfb2JqZWN0U3ByZWFkJDYoewogICAgICBfX3Byb3RvX186IG51bGwKICAgIH0sIE9iamVjdEdldE93blByb3BlcnR5RGVzY3JpcHRvcihXcml0YWJsZS5wcm90b3R5cGUsICd3cml0YWJsZUxlbmd0aCcpKSwKICAgIHdyaXRhYmxlRmluaXNoZWQ6IF9vYmplY3RTcHJlYWQkNih7CiAgICAgIF9fcHJvdG9fXzogbnVsbAogICAgfSwgT2JqZWN0R2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFdyaXRhYmxlLnByb3RvdHlwZSwgJ3dyaXRhYmxlRmluaXNoZWQnKSksCiAgICB3cml0YWJsZUNvcmtlZDogX29iamVjdFNwcmVhZCQ2KHsKICAgICAgX19wcm90b19fOiBudWxsCiAgICB9LCBPYmplY3RHZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoV3JpdGFibGUucHJvdG90eXBlLCAnd3JpdGFibGVDb3JrZWQnKSksCiAgICB3cml0YWJsZUVuZGVkOiBfb2JqZWN0U3ByZWFkJDYoewogICAgICBfX3Byb3RvX186IG51bGwKICAgIH0sIE9iamVjdEdldE93blByb3BlcnR5RGVzY3JpcHRvcihXcml0YWJsZS5wcm90b3R5cGUsICd3cml0YWJsZUVuZGVkJykpLAogICAgd3JpdGFibGVOZWVkRHJhaW46IF9vYmplY3RTcHJlYWQkNih7CiAgICAgIF9fcHJvdG9fXzogbnVsbAogICAgfSwgT2JqZWN0R2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFdyaXRhYmxlLnByb3RvdHlwZSwgJ3dyaXRhYmxlTmVlZERyYWluJykpLAogICAgZGVzdHJveWVkOiB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgZ2V0KCkgewogICAgICAgIGlmICh0aGlzLl9yZWFkYWJsZVN0YXRlID09PSB1bmRlZmluZWQgfHwgdGhpcy5fd3JpdGFibGVTdGF0ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9yZWFkYWJsZVN0YXRlLmRlc3Ryb3llZCAmJiB0aGlzLl93cml0YWJsZVN0YXRlLmRlc3Ryb3llZDsKICAgICAgfSwKICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgLy8gQmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdGhlIHVzZXIgaXMgZXhwbGljaXRseQogICAgICAgIC8vIG1hbmFnaW5nIGRlc3Ryb3llZC4KICAgICAgICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZSAmJiB0aGlzLl93cml0YWJsZVN0YXRlKSB7CiAgICAgICAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLmRlc3Ryb3llZCA9IHZhbHVlOwogICAgICAgICAgdGhpcy5fd3JpdGFibGVTdGF0ZS5kZXN0cm95ZWQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBsZXQgd2ViU3RyZWFtc0FkYXB0ZXJzOwoKICAvLyBMYXp5IHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICBmdW5jdGlvbiBsYXp5V2ViU3RyZWFtcygpIHsKICAgIGlmICh3ZWJTdHJlYW1zQWRhcHRlcnMgPT09IHVuZGVmaW5lZCkgd2ViU3RyZWFtc0FkYXB0ZXJzID0ge307CiAgICByZXR1cm4gd2ViU3RyZWFtc0FkYXB0ZXJzOwogIH0KICBEdXBsZXguZnJvbVdlYiA9IGZ1bmN0aW9uIChwYWlyLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbGF6eVdlYlN0cmVhbXMoKS5uZXdTdHJlYW1EdXBsZXhGcm9tUmVhZGFibGVXcml0YWJsZVBhaXIocGFpciwgb3B0aW9ucyk7CiAgfTsKICBEdXBsZXgudG9XZWIgPSBmdW5jdGlvbiAoZHVwbGV4KSB7CiAgICByZXR1cm4gbGF6eVdlYlN0cmVhbXMoKS5uZXdSZWFkYWJsZVdyaXRhYmxlUGFpckZyb21EdXBsZXgoZHVwbGV4KTsKICB9OwogIGxldCBkdXBsZXhpZnk7CiAgRHVwbGV4LmZyb20gPSBmdW5jdGlvbiAoYm9keSkgewogICAgaWYgKCFkdXBsZXhpZnkpIHsKICAgICAgZHVwbGV4aWZ5ID0gcmVxdWlyZUR1cGxleGlmeSgpOwogICAgfQogICAgcmV0dXJuIGR1cGxleGlmeShib2R5LCAnYm9keScpOwogIH07CiAgcmV0dXJuIGR1cGxleDsKfQoKZnVuY3Rpb24gb3duS2V5cyQ1KGUsIHIpIHsgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOyByICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcikuZW51bWVyYWJsZTsgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7IH0gcmV0dXJuIHQ7IH0KZnVuY3Rpb24gX29iamVjdFNwcmVhZCQ1KGUpIHsgZm9yICh2YXIgciA9IDE7IHIgPCBhcmd1bWVudHMubGVuZ3RoOyByKyspIHsgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyXSA/IGFyZ3VtZW50c1tyXSA6IHt9OyByICUgMiA/IG93bktleXMkNShPYmplY3QodCksICEwKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IF9kZWZpbmVQcm9wZXJ0eShlLCByLCB0W3JdKTsgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMkNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcikpOyB9KTsgfSByZXR1cm4gZTsgfQp2YXIgdHJhbnNmb3JtOwp2YXIgaGFzUmVxdWlyZWRUcmFuc2Zvcm07CmZ1bmN0aW9uIHJlcXVpcmVUcmFuc2Zvcm0oKSB7CiAgaWYgKGhhc1JlcXVpcmVkVHJhbnNmb3JtKSByZXR1cm4gdHJhbnNmb3JtOwogIGhhc1JlcXVpcmVkVHJhbnNmb3JtID0gMTsKICBjb25zdCB7CiAgICBPYmplY3RTZXRQcm90b3R5cGVPZiwKICAgIFN5bWJvbAogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKICB0cmFuc2Zvcm0gPSBUcmFuc2Zvcm07CiAgY29uc3QgewogICAgRVJSX01FVEhPRF9OT1RfSU1QTEVNRU5URUQKICB9ID0gcmVxdWlyZUVycm9ycygpLmNvZGVzOwogIGNvbnN0IER1cGxleCA9IHJlcXVpcmVEdXBsZXgoKTsKICBjb25zdCB7CiAgICBnZXRIaWdoV2F0ZXJNYXJrCiAgfSA9IHJlcXVpcmVTdGF0ZSgpOwogIE9iamVjdFNldFByb3RvdHlwZU9mKFRyYW5zZm9ybS5wcm90b3R5cGUsIER1cGxleC5wcm90b3R5cGUpOwogIE9iamVjdFNldFByb3RvdHlwZU9mKFRyYW5zZm9ybSwgRHVwbGV4KTsKICBjb25zdCBrQ2FsbGJhY2sgPSBTeW1ib2woJ2tDYWxsYmFjaycpOwogIGZ1bmN0aW9uIFRyYW5zZm9ybShvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVHJhbnNmb3JtKSkgcmV0dXJuIG5ldyBUcmFuc2Zvcm0ob3B0aW9ucyk7CgogICAgLy8gVE9ETyAocm9uYWcpOiBUaGlzIHNob3VsZCBwcmVmZXJhYmx5IGFsd2F5cyBiZQogICAgLy8gYXBwbGllZCBidXQgd291bGQgYmUgc2VtdmVyLW1ham9yLiBPciBldmVuIGJldHRlcjsKICAgIC8vIG1ha2UgVHJhbnNmb3JtIGEgUmVhZGFibGUgd2l0aCB0aGUgV3JpdGFibGUgaW50ZXJmYWNlLgogICAgY29uc3QgcmVhZGFibGVIaWdoV2F0ZXJNYXJrID0gb3B0aW9ucyA/IGdldEhpZ2hXYXRlck1hcmsodGhpcywgb3B0aW9ucywgJ3JlYWRhYmxlSGlnaFdhdGVyTWFyaycsIHRydWUpIDogbnVsbDsKICAgIGlmIChyZWFkYWJsZUhpZ2hXYXRlck1hcmsgPT09IDApIHsKICAgICAgLy8gQSBEdXBsZXggd2lsbCBidWZmZXIgYm90aCBvbiB0aGUgd3JpdGFibGUgYW5kIHJlYWRhYmxlIHNpZGUgd2hpbGUKICAgICAgLy8gYSBUcmFuc2Zvcm0ganVzdCB3YW50cyB0byBidWZmZXIgaHdtIG51bWJlciBvZiBlbGVtZW50cy4gVG8gYXZvaWQKICAgICAgLy8gYnVmZmVyaW5nIHR3aWNlIHdlIGRpc2FibGUgYnVmZmVyaW5nIG9uIHRoZSB3cml0YWJsZSBzaWRlLgogICAgICBvcHRpb25zID0gX29iamVjdFNwcmVhZCQ1KF9vYmplY3RTcHJlYWQkNSh7fSwgb3B0aW9ucyksIHt9LCB7CiAgICAgICAgaGlnaFdhdGVyTWFyazogbnVsbCwKICAgICAgICByZWFkYWJsZUhpZ2hXYXRlck1hcmssCiAgICAgICAgLy8gVE9ETyAocm9uYWcpOiAwIGlzIG5vdCBvcHRpbWFsIHNpbmNlIHdlIGhhdmUKICAgICAgICAvLyBhICJidWciIHdoZXJlIHdlIGNoZWNrIG5lZWREcmFpbiBiZWZvcmUgY2FsbGluZyBfd3JpdGUgYW5kIG5vdCBhZnRlci4KICAgICAgICAvLyBSZWZzOiBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvcHVsbC8zMjg4NwogICAgICAgIC8vIFJlZnM6IGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9wdWxsLzM1OTQxCiAgICAgICAgd3JpdGFibGVIaWdoV2F0ZXJNYXJrOiBvcHRpb25zLndyaXRhYmxlSGlnaFdhdGVyTWFyayB8fCAwCiAgICAgIH0pOwogICAgfQogICAgRHVwbGV4LmNhbGwodGhpcywgb3B0aW9ucyk7CgogICAgLy8gV2UgaGF2ZSBpbXBsZW1lbnRlZCB0aGUgX3JlYWQgbWV0aG9kLCBhbmQgZG9uZSB0aGUgb3RoZXIgdGhpbmdzCiAgICAvLyB0aGF0IFJlYWRhYmxlIHdhbnRzIGJlZm9yZSB0aGUgZmlyc3QgX3JlYWQgY2FsbCwgc28gdW5zZXQgdGhlCiAgICAvLyBzeW5jIGd1YXJkIGZsYWcuCiAgICB0aGlzLl9yZWFkYWJsZVN0YXRlLnN5bmMgPSBmYWxzZTsKICAgIHRoaXNba0NhbGxiYWNrXSA9IG51bGw7CiAgICBpZiAob3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMudHJhbnNmb3JtID09PSAnZnVuY3Rpb24nKSB0aGlzLl90cmFuc2Zvcm0gPSBvcHRpb25zLnRyYW5zZm9ybTsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmZsdXNoID09PSAnZnVuY3Rpb24nKSB0aGlzLl9mbHVzaCA9IG9wdGlvbnMuZmx1c2g7CiAgICB9CgogICAgLy8gV2hlbiB0aGUgd3JpdGFibGUgc2lkZSBmaW5pc2hlcywgdGhlbiBmbHVzaCBvdXQgYW55dGhpbmcgcmVtYWluaW5nLgogICAgLy8gQmFja3dhcmRzIGNvbXBhdC4gU29tZSBUcmFuc2Zvcm0gc3RyZWFtcyBpbmNvcnJlY3RseSBpbXBsZW1lbnQgX2ZpbmFsCiAgICAvLyBpbnN0ZWFkIG9mIG9yIGluIGFkZGl0aW9uIHRvIF9mbHVzaC4gQnkgdXNpbmcgJ3ByZWZpbmlzaCcgaW5zdGVhZCBvZgogICAgLy8gaW1wbGVtZW50aW5nIF9maW5hbCB3ZSBjb250aW51ZSBzdXBwb3J0aW5nIHRoaXMgdW5mb3J0dW5hdGUgdXNlIGNhc2UuCiAgICB0aGlzLm9uKCdwcmVmaW5pc2gnLCBwcmVmaW5pc2gpOwogIH0KICBmdW5jdGlvbiBmaW5hbChjYikgewogICAgaWYgKHR5cGVvZiB0aGlzLl9mbHVzaCA9PT0gJ2Z1bmN0aW9uJyAmJiAhdGhpcy5kZXN0cm95ZWQpIHsKICAgICAgdGhpcy5fZmx1c2goKGVyLCBkYXRhKSA9PiB7CiAgICAgICAgaWYgKGVyKSB7CiAgICAgICAgICBpZiAoY2IpIHsKICAgICAgICAgICAgY2IoZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGRhdGEgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5wdXNoKGRhdGEpOwogICAgICAgIH0KICAgICAgICB0aGlzLnB1c2gobnVsbCk7CiAgICAgICAgaWYgKGNiKSB7CiAgICAgICAgICBjYigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnB1c2gobnVsbCk7CiAgICAgIGlmIChjYikgewogICAgICAgIGNiKCk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gcHJlZmluaXNoKCkgewogICAgaWYgKHRoaXMuX2ZpbmFsICE9PSBmaW5hbCkgewogICAgICBmaW5hbC5jYWxsKHRoaXMpOwogICAgfQogIH0KICBUcmFuc2Zvcm0ucHJvdG90eXBlLl9maW5hbCA9IGZpbmFsOwogIFRyYW5zZm9ybS5wcm90b3R5cGUuX3RyYW5zZm9ybSA9IGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICB0aHJvdyBuZXcgRVJSX01FVEhPRF9OT1RfSU1QTEVNRU5URUQoJ190cmFuc2Zvcm0oKScpOwogIH07CiAgVHJhbnNmb3JtLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbiAoY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjaykgewogICAgY29uc3QgclN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICAgIGNvbnN0IHdTdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgICBjb25zdCBsZW5ndGggPSByU3RhdGUubGVuZ3RoOwogICAgdGhpcy5fdHJhbnNmb3JtKGNodW5rLCBlbmNvZGluZywgKGVyciwgdmFsKSA9PiB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodmFsICE9IG51bGwpIHsKICAgICAgICB0aGlzLnB1c2godmFsKTsKICAgICAgfQogICAgICBpZiAod1N0YXRlLmVuZGVkIHx8CiAgICAgIC8vIEJhY2t3YXJkcyBjb21wYXQuCiAgICAgIGxlbmd0aCA9PT0gclN0YXRlLmxlbmd0aCB8fAogICAgICAvLyBCYWNrd2FyZHMgY29tcGF0LgogICAgICByU3RhdGUubGVuZ3RoIDwgclN0YXRlLmhpZ2hXYXRlck1hcmspIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNba0NhbGxiYWNrXSA9IGNhbGxiYWNrOwogICAgICB9CiAgICB9KTsKICB9OwogIFRyYW5zZm9ybS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpc1trQ2FsbGJhY2tdKSB7CiAgICAgIGNvbnN0IGNhbGxiYWNrID0gdGhpc1trQ2FsbGJhY2tdOwogICAgICB0aGlzW2tDYWxsYmFja10gPSBudWxsOwogICAgICBjYWxsYmFjaygpOwogICAgfQogIH07CiAgcmV0dXJuIHRyYW5zZm9ybTsKfQoKdmFyIHBhc3N0aHJvdWdoOwp2YXIgaGFzUmVxdWlyZWRQYXNzdGhyb3VnaDsKZnVuY3Rpb24gcmVxdWlyZVBhc3N0aHJvdWdoKCkgewogIGlmIChoYXNSZXF1aXJlZFBhc3N0aHJvdWdoKSByZXR1cm4gcGFzc3Rocm91Z2g7CiAgaGFzUmVxdWlyZWRQYXNzdGhyb3VnaCA9IDE7CiAgY29uc3QgewogICAgT2JqZWN0U2V0UHJvdG90eXBlT2YKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgcGFzc3Rocm91Z2ggPSBQYXNzVGhyb3VnaDsKICBjb25zdCBUcmFuc2Zvcm0gPSByZXF1aXJlVHJhbnNmb3JtKCk7CiAgT2JqZWN0U2V0UHJvdG90eXBlT2YoUGFzc1Rocm91Z2gucHJvdG90eXBlLCBUcmFuc2Zvcm0ucHJvdG90eXBlKTsKICBPYmplY3RTZXRQcm90b3R5cGVPZihQYXNzVGhyb3VnaCwgVHJhbnNmb3JtKTsKICBmdW5jdGlvbiBQYXNzVGhyb3VnaChvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUGFzc1Rocm91Z2gpKSByZXR1cm4gbmV3IFBhc3NUaHJvdWdoKG9wdGlvbnMpOwogICAgVHJhbnNmb3JtLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfQogIFBhc3NUaHJvdWdoLnByb3RvdHlwZS5fdHJhbnNmb3JtID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgIGNiKG51bGwsIGNodW5rKTsKICB9OwogIHJldHVybiBwYXNzdGhyb3VnaDsKfQoKLyogcmVwbGFjZW1lbnQgc3RhcnQgKi8KdmFyIHBpcGVsaW5lXzE7CnZhciBoYXNSZXF1aXJlZFBpcGVsaW5lOwpmdW5jdGlvbiByZXF1aXJlUGlwZWxpbmUoKSB7CiAgaWYgKGhhc1JlcXVpcmVkUGlwZWxpbmUpIHJldHVybiBwaXBlbGluZV8xOwogIGhhc1JlcXVpcmVkUGlwZWxpbmUgPSAxOwogIGNvbnN0IHByb2Nlc3MgPSByZXF1aXJlUHJvY2VzcygpCgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLwogIC8vIFBvcnRlZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9tYWZpbnRvc2gvcHVtcCB3aXRoCiAgLy8gcGVybWlzc2lvbiBmcm9tIHRoZSBhdXRob3IsIE1hdGhpYXMgQnV1cyAoQG1hZmludG9zaCkuCiAgOwogIGNvbnN0IHsKICAgIEFycmF5SXNBcnJheSwKICAgIFByb21pc2UsCiAgICBTeW1ib2xBc3luY0l0ZXJhdG9yLAogICAgU3ltYm9sRGlzcG9zZQogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKICBjb25zdCBlb3MgPSByZXF1aXJlRW5kT2ZTdHJlYW0oKTsKICBjb25zdCB7CiAgICBvbmNlCiAgfSA9IHJlcXVpcmVVdGlsJDEoKTsKICBjb25zdCBkZXN0cm95SW1wbCA9IHJlcXVpcmVEZXN0cm95KCk7CiAgY29uc3QgRHVwbGV4ID0gcmVxdWlyZUR1cGxleCgpOwogIGNvbnN0IHsKICAgIGFnZ3JlZ2F0ZVR3b0Vycm9ycywKICAgIGNvZGVzOiB7CiAgICAgIEVSUl9JTlZBTElEX0FSR19UWVBFLAogICAgICBFUlJfSU5WQUxJRF9SRVRVUk5fVkFMVUUsCiAgICAgIEVSUl9NSVNTSU5HX0FSR1MsCiAgICAgIEVSUl9TVFJFQU1fREVTVFJPWUVELAogICAgICBFUlJfU1RSRUFNX1BSRU1BVFVSRV9DTE9TRQogICAgfSwKICAgIEFib3J0RXJyb3IKICB9ID0gcmVxdWlyZUVycm9ycygpOwogIGNvbnN0IHsKICAgIHZhbGlkYXRlRnVuY3Rpb24sCiAgICB2YWxpZGF0ZUFib3J0U2lnbmFsCiAgfSA9IHJlcXVpcmVWYWxpZGF0b3JzKCk7CiAgY29uc3QgewogICAgaXNJdGVyYWJsZSwKICAgIGlzUmVhZGFibGUsCiAgICBpc1JlYWRhYmxlTm9kZVN0cmVhbSwKICAgIGlzTm9kZVN0cmVhbSwKICAgIGlzVHJhbnNmb3JtU3RyZWFtLAogICAgaXNXZWJTdHJlYW0sCiAgICBpc1JlYWRhYmxlU3RyZWFtLAogICAgaXNSZWFkYWJsZUZpbmlzaGVkCiAgfSA9IHJlcXVpcmVVdGlscyQxKCk7CiAgY29uc3QgQWJvcnRDb250cm9sbGVyID0gZ2xvYmFsVGhpcy5BYm9ydENvbnRyb2xsZXIgfHwgcmVxdWlyZSQkMCQxLkFib3J0Q29udHJvbGxlcjsKICBsZXQgUGFzc1Rocm91Z2g7CiAgbGV0IFJlYWRhYmxlOwogIGxldCBhZGRBYm9ydExpc3RlbmVyOwogIGZ1bmN0aW9uIGRlc3Ryb3llcihzdHJlYW0sIHJlYWRpbmcsIHdyaXRpbmcpIHsKICAgIGxldCBmaW5pc2hlZCA9IGZhbHNlOwogICAgc3RyZWFtLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgZmluaXNoZWQgPSB0cnVlOwogICAgfSk7CiAgICBjb25zdCBjbGVhbnVwID0gZW9zKHN0cmVhbSwgewogICAgICByZWFkYWJsZTogcmVhZGluZywKICAgICAgd3JpdGFibGU6IHdyaXRpbmcKICAgIH0sIGVyciA9PiB7CiAgICAgIGZpbmlzaGVkID0gIWVycjsKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgZGVzdHJveTogZXJyID0+IHsKICAgICAgICBpZiAoZmluaXNoZWQpIHJldHVybjsKICAgICAgICBmaW5pc2hlZCA9IHRydWU7CiAgICAgICAgZGVzdHJveUltcGwuZGVzdHJveWVyKHN0cmVhbSwgZXJyIHx8IG5ldyBFUlJfU1RSRUFNX0RFU1RST1lFRCgncGlwZScpKTsKICAgICAgfSwKICAgICAgY2xlYW51cAogICAgfTsKICB9CiAgZnVuY3Rpb24gcG9wQ2FsbGJhY2soc3RyZWFtcykgewogICAgLy8gU3RyZWFtcyBzaG91bGQgbmV2ZXIgYmUgYW4gZW1wdHkgYXJyYXkuIEl0IHNob3VsZCBhbHdheXMgY29udGFpbiBhdCBsZWFzdAogICAgLy8gYSBzaW5nbGUgc3RyZWFtLiBUaGVyZWZvcmUgb3B0aW1pemUgZm9yIHRoZSBhdmVyYWdlIGNhc2UgaW5zdGVhZCBvZgogICAgLy8gY2hlY2tpbmcgZm9yIGxlbmd0aCA9PT0gMCBhcyB3ZWxsLgogICAgdmFsaWRhdGVGdW5jdGlvbihzdHJlYW1zW3N0cmVhbXMubGVuZ3RoIC0gMV0sICdzdHJlYW1zW3N0cmVhbS5sZW5ndGggLSAxXScpOwogICAgcmV0dXJuIHN0cmVhbXMucG9wKCk7CiAgfQogIGZ1bmN0aW9uIG1ha2VBc3luY0l0ZXJhYmxlKHZhbCkgewogICAgaWYgKGlzSXRlcmFibGUodmFsKSkgewogICAgICByZXR1cm4gdmFsOwogICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbSh2YWwpKSB7CiAgICAgIC8vIExlZ2FjeSBzdHJlYW1zIGFyZSBub3QgSXRlcmFibGUuCiAgICAgIHJldHVybiBmcm9tUmVhZGFibGUodmFsKTsKICAgIH0KICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgndmFsJywgWydSZWFkYWJsZScsICdJdGVyYWJsZScsICdBc3luY0l0ZXJhYmxlJ10sIHZhbCk7CiAgfQogIGFzeW5jIGZ1bmN0aW9uKiBmcm9tUmVhZGFibGUodmFsKSB7CiAgICBpZiAoIVJlYWRhYmxlKSB7CiAgICAgIFJlYWRhYmxlID0gcmVxdWlyZVJlYWRhYmxlKCk7CiAgICB9CiAgICB5aWVsZCogUmVhZGFibGUucHJvdG90eXBlW1N5bWJvbEFzeW5jSXRlcmF0b3JdLmNhbGwodmFsKTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gcHVtcFRvTm9kZShpdGVyYWJsZSwgd3JpdGFibGUsIGZpbmlzaCwgewogICAgZW5kCiAgfSkgewogICAgbGV0IGVycm9yOwogICAgbGV0IG9ucmVzb2x2ZSA9IG51bGw7CiAgICBjb25zdCByZXN1bWUgPSBlcnIgPT4gewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgZXJyb3IgPSBlcnI7CiAgICAgIH0KICAgICAgaWYgKG9ucmVzb2x2ZSkgewogICAgICAgIGNvbnN0IGNhbGxiYWNrID0gb25yZXNvbHZlOwogICAgICAgIG9ucmVzb2x2ZSA9IG51bGw7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHdhaXQgPSAoKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb25yZXNvbHZlID0gKCkgPT4gewogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgICB3cml0YWJsZS5vbignZHJhaW4nLCByZXN1bWUpOwogICAgY29uc3QgY2xlYW51cCA9IGVvcyh3cml0YWJsZSwgewogICAgICByZWFkYWJsZTogZmFsc2UKICAgIH0sIHJlc3VtZSk7CiAgICB0cnkgewogICAgICBpZiAod3JpdGFibGUud3JpdGFibGVOZWVkRHJhaW4pIHsKICAgICAgICBhd2FpdCB3YWl0KCk7CiAgICAgIH0KICAgICAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBpdGVyYWJsZSkgewogICAgICAgIGlmICghd3JpdGFibGUud3JpdGUoY2h1bmspKSB7CiAgICAgICAgICBhd2FpdCB3YWl0KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChlbmQpIHsKICAgICAgICB3cml0YWJsZS5lbmQoKTsKICAgICAgICBhd2FpdCB3YWl0KCk7CiAgICAgIH0KICAgICAgZmluaXNoKCk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgZmluaXNoKGVycm9yICE9PSBlcnIgPyBhZ2dyZWdhdGVUd29FcnJvcnMoZXJyb3IsIGVycikgOiBlcnIpOwogICAgfSBmaW5hbGx5IHsKICAgICAgY2xlYW51cCgpOwogICAgICB3cml0YWJsZS5vZmYoJ2RyYWluJywgcmVzdW1lKTsKICAgIH0KICB9CiAgYXN5bmMgZnVuY3Rpb24gcHVtcFRvV2ViKHJlYWRhYmxlLCB3cml0YWJsZSwgZmluaXNoLCB7CiAgICBlbmQKICB9KSB7CiAgICBpZiAoaXNUcmFuc2Zvcm1TdHJlYW0od3JpdGFibGUpKSB7CiAgICAgIHdyaXRhYmxlID0gd3JpdGFibGUud3JpdGFibGU7CiAgICB9CiAgICAvLyBodHRwczovL3N0cmVhbXMuc3BlYy53aGF0d2cub3JnLyNleGFtcGxlLW1hbnVhbC13cml0ZS13aXRoLWJhY2twcmVzc3VyZQogICAgY29uc3Qgd3JpdGVyID0gd3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICB0cnkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIHJlYWRhYmxlKSB7CiAgICAgICAgYXdhaXQgd3JpdGVyLnJlYWR5OwogICAgICAgIHdyaXRlci53cml0ZShjaHVuaykuY2F0Y2goKCkgPT4ge30pOwogICAgICB9CiAgICAgIGF3YWl0IHdyaXRlci5yZWFkeTsKICAgICAgaWYgKGVuZCkgewogICAgICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpOwogICAgICB9CiAgICAgIGZpbmlzaCgpOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgd3JpdGVyLmFib3J0KGVycik7CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGZpbmlzaChlcnIpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBpcGVsaW5lKC4uLnN0cmVhbXMpIHsKICAgIHJldHVybiBwaXBlbGluZUltcGwoc3RyZWFtcywgb25jZShwb3BDYWxsYmFjayhzdHJlYW1zKSkpOwogIH0KICBmdW5jdGlvbiBwaXBlbGluZUltcGwoc3RyZWFtcywgY2FsbGJhY2ssIG9wdHMpIHsKICAgIGlmIChzdHJlYW1zLmxlbmd0aCA9PT0gMSAmJiBBcnJheUlzQXJyYXkoc3RyZWFtc1swXSkpIHsKICAgICAgc3RyZWFtcyA9IHN0cmVhbXNbMF07CiAgICB9CiAgICBpZiAoc3RyZWFtcy5sZW5ndGggPCAyKSB7CiAgICAgIHRocm93IG5ldyBFUlJfTUlTU0lOR19BUkdTKCdzdHJlYW1zJyk7CiAgICB9CiAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IGFjLnNpZ25hbDsKICAgIGNvbnN0IG91dGVyU2lnbmFsID0gb3B0cyA9PT0gbnVsbCB8fCBvcHRzID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRzLnNpZ25hbDsKCiAgICAvLyBOZWVkIHRvIGNsZWFudXAgZXZlbnQgbGlzdGVuZXJzIGlmIGxhc3Qgc3RyZWFtIGlzIHJlYWRhYmxlCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvaXNzdWVzLzM1NDUyCiAgICBjb25zdCBsYXN0U3RyZWFtQ2xlYW51cCA9IFtdOwogICAgdmFsaWRhdGVBYm9ydFNpZ25hbChvdXRlclNpZ25hbCwgJ29wdGlvbnMuc2lnbmFsJyk7CiAgICBmdW5jdGlvbiBhYm9ydCgpIHsKICAgICAgZmluaXNoSW1wbChuZXcgQWJvcnRFcnJvcigpKTsKICAgIH0KICAgIGFkZEFib3J0TGlzdGVuZXIgPSBhZGRBYm9ydExpc3RlbmVyIHx8IHJlcXVpcmVVdGlsJDEoKS5hZGRBYm9ydExpc3RlbmVyOwogICAgbGV0IGRpc3Bvc2FibGU7CiAgICBpZiAob3V0ZXJTaWduYWwpIHsKICAgICAgZGlzcG9zYWJsZSA9IGFkZEFib3J0TGlzdGVuZXIob3V0ZXJTaWduYWwsIGFib3J0KTsKICAgIH0KICAgIGxldCBlcnJvcjsKICAgIGxldCB2YWx1ZTsKICAgIGNvbnN0IGRlc3Ryb3lzID0gW107CiAgICBsZXQgZmluaXNoQ291bnQgPSAwOwogICAgZnVuY3Rpb24gZmluaXNoKGVycikgewogICAgICBmaW5pc2hJbXBsKGVyciwgLS1maW5pc2hDb3VudCA9PT0gMCk7CiAgICB9CiAgICBmdW5jdGlvbiBmaW5pc2hJbXBsKGVyciwgZmluYWwpIHsKICAgICAgdmFyIF9kaXNwb3NhYmxlOwogICAgICBpZiAoZXJyICYmICghZXJyb3IgfHwgZXJyb3IuY29kZSA9PT0gJ0VSUl9TVFJFQU1fUFJFTUFUVVJFX0NMT1NFJykpIHsKICAgICAgICBlcnJvciA9IGVycjsKICAgICAgfQogICAgICBpZiAoIWVycm9yICYmICFmaW5hbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB3aGlsZSAoZGVzdHJveXMubGVuZ3RoKSB7CiAgICAgICAgZGVzdHJveXMuc2hpZnQoKShlcnJvcik7CiAgICAgIH0KICAgICAgKF9kaXNwb3NhYmxlID0gZGlzcG9zYWJsZSkgPT09IG51bGwgfHwgX2Rpc3Bvc2FibGUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IF9kaXNwb3NhYmxlW1N5bWJvbERpc3Bvc2VdKCk7CiAgICAgIGFjLmFib3J0KCk7CiAgICAgIGlmIChmaW5hbCkgewogICAgICAgIGlmICghZXJyb3IpIHsKICAgICAgICAgIGxhc3RTdHJlYW1DbGVhbnVwLmZvckVhY2goZm4gPT4gZm4oKSk7CiAgICAgICAgfQogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2FsbGJhY2ssIGVycm9yLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIGxldCByZXQ7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0cmVhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgc3RyZWFtID0gc3RyZWFtc1tpXTsKICAgICAgY29uc3QgcmVhZGluZyA9IGkgPCBzdHJlYW1zLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IHdyaXRpbmcgPSBpID4gMDsKICAgICAgY29uc3QgZW5kID0gcmVhZGluZyB8fCAob3B0cyA9PT0gbnVsbCB8fCBvcHRzID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRzLmVuZCkgIT09IGZhbHNlOwogICAgICBjb25zdCBpc0xhc3RTdHJlYW0gPSBpID09PSBzdHJlYW1zLmxlbmd0aCAtIDE7CiAgICAgIGlmIChpc05vZGVTdHJlYW0oc3RyZWFtKSkgewogICAgICAgIGlmIChlbmQpIHsKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgZGVzdHJveSwKICAgICAgICAgICAgY2xlYW51cAogICAgICAgICAgfSA9IGRlc3Ryb3llcihzdHJlYW0sIHJlYWRpbmcsIHdyaXRpbmcpOwogICAgICAgICAgZGVzdHJveXMucHVzaChkZXN0cm95KTsKICAgICAgICAgIGlmIChpc1JlYWRhYmxlKHN0cmVhbSkgJiYgaXNMYXN0U3RyZWFtKSB7CiAgICAgICAgICAgIGxhc3RTdHJlYW1DbGVhbnVwLnB1c2goY2xlYW51cCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYXRjaCBzdHJlYW0gZXJyb3JzIHRoYXQgb2NjdXIgYWZ0ZXIgcGlwZS9wdW1wIGhhcyBjb21wbGV0ZWQuCiAgICAgICAgZnVuY3Rpb24gb25FcnJvcihlcnIpIHsKICAgICAgICAgIGlmIChlcnIgJiYgZXJyLm5hbWUgIT09ICdBYm9ydEVycm9yJyAmJiBlcnIuY29kZSAhPT0gJ0VSUl9TVFJFQU1fUFJFTUFUVVJFX0NMT1NFJykgewogICAgICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIG9uRXJyb3IpOwogICAgICAgIGlmIChpc1JlYWRhYmxlKHN0cmVhbSkgJiYgaXNMYXN0U3RyZWFtKSB7CiAgICAgICAgICBsYXN0U3RyZWFtQ2xlYW51cC5wdXNoKCgpID0+IHsKICAgICAgICAgICAgc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uRXJyb3IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJlYW0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldCA9IHN0cmVhbSh7CiAgICAgICAgICAgIHNpZ25hbAogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoIWlzSXRlcmFibGUocmV0KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfUkVUVVJOX1ZBTFVFKCdJdGVyYWJsZSwgQXN5bmNJdGVyYWJsZSBvciBTdHJlYW0nLCAnc291cmNlJywgcmV0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGUoc3RyZWFtKSB8fCBpc1JlYWRhYmxlTm9kZVN0cmVhbShzdHJlYW0pIHx8IGlzVHJhbnNmb3JtU3RyZWFtKHN0cmVhbSkpIHsKICAgICAgICAgIHJldCA9IHN0cmVhbTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0ID0gRHVwbGV4LmZyb20oc3RyZWFtKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmVhbSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGlmIChpc1RyYW5zZm9ybVN0cmVhbShyZXQpKSB7CiAgICAgICAgICB2YXIgX3JldDsKICAgICAgICAgIHJldCA9IG1ha2VBc3luY0l0ZXJhYmxlKChfcmV0ID0gcmV0KSA9PT0gbnVsbCB8fCBfcmV0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfcmV0LnJlYWRhYmxlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0ID0gbWFrZUFzeW5jSXRlcmFibGUocmV0KTsKICAgICAgICB9CiAgICAgICAgcmV0ID0gc3RyZWFtKHJldCwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHJlYWRpbmcpIHsKICAgICAgICAgIGlmICghaXNJdGVyYWJsZShyZXQsIHRydWUpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9SRVRVUk5fVkFMVUUoJ0FzeW5jSXRlcmFibGUnLCBgdHJhbnNmb3JtWyR7aSAtIDF9XWAsIHJldCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBfcmV0MjsKICAgICAgICAgIGlmICghUGFzc1Rocm91Z2gpIHsKICAgICAgICAgICAgUGFzc1Rocm91Z2ggPSByZXF1aXJlUGFzc3Rocm91Z2goKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGUgbGFzdCBhcmd1bWVudCB0byBwaXBlbGluZSBpcyBub3QgYSBzdHJlYW0KICAgICAgICAgIC8vIHdlIG11c3QgY3JlYXRlIGEgcHJveHkgc3RyZWFtIHNvIHRoYXQgcGlwZWxpbmUoLi4uKQogICAgICAgICAgLy8gYWx3YXlzIHJldHVybnMgYSBzdHJlYW0gd2hpY2ggY2FuIGJlIGZ1cnRoZXIKICAgICAgICAgIC8vIGNvbXBvc2VkIHRocm91Z2ggYC5waXBlKHN0cmVhbSlgLgoKICAgICAgICAgIGNvbnN0IHB0ID0gbmV3IFBhc3NUaHJvdWdoKHsKICAgICAgICAgICAgb2JqZWN0TW9kZTogdHJ1ZQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gSGFuZGxlIFByb21pc2VzL0ErIHNwZWMsIGB0aGVuYCBjb3VsZCBiZSBhIGdldHRlciB0aGF0IHRocm93cyBvbgogICAgICAgICAgLy8gc2Vjb25kIHVzZS4KICAgICAgICAgIGNvbnN0IHRoZW4gPSAoX3JldDIgPSByZXQpID09PSBudWxsIHx8IF9yZXQyID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBfcmV0Mi50aGVuOwogICAgICAgICAgaWYgKHR5cGVvZiB0aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGZpbmlzaENvdW50Kys7CiAgICAgICAgICAgIHRoZW4uY2FsbChyZXQsIHZhbCA9PiB7CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWw7CiAgICAgICAgICAgICAgaWYgKHZhbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBwdC53cml0ZSh2YWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5kKSB7CiAgICAgICAgICAgICAgICBwdC5lbmQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmaW5pc2gpOwogICAgICAgICAgICB9LCBlcnIgPT4gewogICAgICAgICAgICAgIHB0LmRlc3Ryb3koZXJyKTsKICAgICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZpbmlzaCwgZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGUocmV0LCB0cnVlKSkgewogICAgICAgICAgICBmaW5pc2hDb3VudCsrOwogICAgICAgICAgICBwdW1wVG9Ob2RlKHJldCwgcHQsIGZpbmlzaCwgewogICAgICAgICAgICAgIGVuZAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNSZWFkYWJsZVN0cmVhbShyZXQpIHx8IGlzVHJhbnNmb3JtU3RyZWFtKHJldCkpIHsKICAgICAgICAgICAgY29uc3QgdG9SZWFkID0gcmV0LnJlYWRhYmxlIHx8IHJldDsKICAgICAgICAgICAgZmluaXNoQ291bnQrKzsKICAgICAgICAgICAgcHVtcFRvTm9kZSh0b1JlYWQsIHB0LCBmaW5pc2gsIHsKICAgICAgICAgICAgICBlbmQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfUkVUVVJOX1ZBTFVFKCdBc3luY0l0ZXJhYmxlIG9yIFByb21pc2UnLCAnZGVzdGluYXRpb24nLCByZXQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0ID0gcHQ7CiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGNsZWFudXAKICAgICAgICAgIH0gPSBkZXN0cm95ZXIocmV0LCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICBkZXN0cm95cy5wdXNoKGRlc3Ryb3kpOwogICAgICAgICAgaWYgKGlzTGFzdFN0cmVhbSkgewogICAgICAgICAgICBsYXN0U3RyZWFtQ2xlYW51cC5wdXNoKGNsZWFudXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc05vZGVTdHJlYW0oc3RyZWFtKSkgewogICAgICAgIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbShyZXQpKSB7CiAgICAgICAgICBmaW5pc2hDb3VudCArPSAyOwogICAgICAgICAgY29uc3QgY2xlYW51cCA9IHBpcGUocmV0LCBzdHJlYW0sIGZpbmlzaCwgewogICAgICAgICAgICBlbmQKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGlzUmVhZGFibGUoc3RyZWFtKSAmJiBpc0xhc3RTdHJlYW0pIHsKICAgICAgICAgICAgbGFzdFN0cmVhbUNsZWFudXAucHVzaChjbGVhbnVwKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlzVHJhbnNmb3JtU3RyZWFtKHJldCkgfHwgaXNSZWFkYWJsZVN0cmVhbShyZXQpKSB7CiAgICAgICAgICBjb25zdCB0b1JlYWQgPSByZXQucmVhZGFibGUgfHwgcmV0OwogICAgICAgICAgZmluaXNoQ291bnQrKzsKICAgICAgICAgIHB1bXBUb05vZGUodG9SZWFkLCBzdHJlYW0sIGZpbmlzaCwgewogICAgICAgICAgICBlbmQKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZShyZXQpKSB7CiAgICAgICAgICBmaW5pc2hDb3VudCsrOwogICAgICAgICAgcHVtcFRvTm9kZShyZXQsIHN0cmVhbSwgZmluaXNoLCB7CiAgICAgICAgICAgIGVuZAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgndmFsJywgWydSZWFkYWJsZScsICdJdGVyYWJsZScsICdBc3luY0l0ZXJhYmxlJywgJ1JlYWRhYmxlU3RyZWFtJywgJ1RyYW5zZm9ybVN0cmVhbSddLCByZXQpOwogICAgICAgIH0KICAgICAgICByZXQgPSBzdHJlYW07CiAgICAgIH0gZWxzZSBpZiAoaXNXZWJTdHJlYW0oc3RyZWFtKSkgewogICAgICAgIGlmIChpc1JlYWRhYmxlTm9kZVN0cmVhbShyZXQpKSB7CiAgICAgICAgICBmaW5pc2hDb3VudCsrOwogICAgICAgICAgcHVtcFRvV2ViKG1ha2VBc3luY0l0ZXJhYmxlKHJldCksIHN0cmVhbSwgZmluaXNoLCB7CiAgICAgICAgICAgIGVuZAogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRhYmxlU3RyZWFtKHJldCkgfHwgaXNJdGVyYWJsZShyZXQpKSB7CiAgICAgICAgICBmaW5pc2hDb3VudCsrOwogICAgICAgICAgcHVtcFRvV2ViKHJldCwgc3RyZWFtLCBmaW5pc2gsIHsKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKGlzVHJhbnNmb3JtU3RyZWFtKHJldCkpIHsKICAgICAgICAgIGZpbmlzaENvdW50Kys7CiAgICAgICAgICBwdW1wVG9XZWIocmV0LnJlYWRhYmxlLCBzdHJlYW0sIGZpbmlzaCwgewogICAgICAgICAgICBlbmQKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ3ZhbCcsIFsnUmVhZGFibGUnLCAnSXRlcmFibGUnLCAnQXN5bmNJdGVyYWJsZScsICdSZWFkYWJsZVN0cmVhbScsICdUcmFuc2Zvcm1TdHJlYW0nXSwgcmV0KTsKICAgICAgICB9CiAgICAgICAgcmV0ID0gc3RyZWFtOwogICAgICB9IGVsc2UgewogICAgICAgIHJldCA9IER1cGxleC5mcm9tKHN0cmVhbSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChzaWduYWwgIT09IG51bGwgJiYgc2lnbmFsICE9PSB1bmRlZmluZWQgJiYgc2lnbmFsLmFib3J0ZWQgfHwgb3V0ZXJTaWduYWwgIT09IG51bGwgJiYgb3V0ZXJTaWduYWwgIT09IHVuZGVmaW5lZCAmJiBvdXRlclNpZ25hbC5hYm9ydGVkKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soYWJvcnQpOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgZnVuY3Rpb24gcGlwZShzcmMsIGRzdCwgZmluaXNoLCB7CiAgICBlbmQKICB9KSB7CiAgICBsZXQgZW5kZWQgPSBmYWxzZTsKICAgIGRzdC5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIGlmICghZW5kZWQpIHsKICAgICAgICAvLyBGaW5pc2ggaWYgdGhlIGRlc3RpbmF0aW9uIGNsb3NlcyBiZWZvcmUgdGhlIHNvdXJjZSBoYXMgY29tcGxldGVkLgogICAgICAgIGZpbmlzaChuZXcgRVJSX1NUUkVBTV9QUkVNQVRVUkVfQ0xPU0UoKSk7CiAgICAgIH0KICAgIH0pOwogICAgc3JjLnBpcGUoZHN0LCB7CiAgICAgIGVuZDogZmFsc2UKICAgIH0pOyAvLyBJZiBlbmQgaXMgdHJ1ZSB3ZSBhbHJlYWR5IHdpbGwgaGF2ZSBhIGxpc3RlbmVyIHRvIGVuZCBkc3QuCgogICAgaWYgKGVuZCkgewogICAgICAvLyBDb21wYXQuIEJlZm9yZSBub2RlIHYxMC4xMi4wIHN0ZGlvIHVzZWQgdG8gdGhyb3cgYW4gZXJyb3Igc28KICAgICAgLy8gcGlwZSgpIGRpZC9kb2VzIG5vdCBlbmQoKSBzdGRpbyBkZXN0aW5hdGlvbnMuCiAgICAgIC8vIE5vdyB0aGV5IGFsbG93IGl0IGJ1dCAic2VjcmV0bHkiIGRvbid0IGNsb3NlIHRoZSB1bmRlcmx5aW5nIGZkLgoKICAgICAgZnVuY3Rpb24gZW5kRm4oKSB7CiAgICAgICAgZW5kZWQgPSB0cnVlOwogICAgICAgIGRzdC5lbmQoKTsKICAgICAgfQogICAgICBpZiAoaXNSZWFkYWJsZUZpbmlzaGVkKHNyYykpIHsKICAgICAgICAvLyBFbmQgdGhlIGRlc3RpbmF0aW9uIGlmIHRoZSBzb3VyY2UgaGFzIGFscmVhZHkgZW5kZWQuCiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhlbmRGbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3JjLm9uY2UoJ2VuZCcsIGVuZEZuKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmluaXNoKCk7CiAgICB9CiAgICBlb3Moc3JjLCB7CiAgICAgIHJlYWRhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogZmFsc2UKICAgIH0sIGVyciA9PiB7CiAgICAgIGNvbnN0IHJTdGF0ZSA9IHNyYy5fcmVhZGFibGVTdGF0ZTsKICAgICAgaWYgKGVyciAmJiBlcnIuY29kZSA9PT0gJ0VSUl9TVFJFQU1fUFJFTUFUVVJFX0NMT1NFJyAmJiByU3RhdGUgJiYgclN0YXRlLmVuZGVkICYmICFyU3RhdGUuZXJyb3JlZCAmJiAhclN0YXRlLmVycm9yRW1pdHRlZCkgewogICAgICAgIC8vIFNvbWUgcmVhZGFibGUgc3RyZWFtcyB3aWxsIGVtaXQgJ2Nsb3NlJyBiZWZvcmUgJ2VuZCcuIEhvd2V2ZXIsIHNpbmNlCiAgICAgICAgLy8gdGhpcyBpcyBvbiB0aGUgcmVhZGFibGUgc2lkZSAnZW5kJyBzaG91bGQgc3RpbGwgYmUgZW1pdHRlZCBpZiB0aGUKICAgICAgICAvLyBzdHJlYW0gaGFzIGJlZW4gZW5kZWQgYW5kIG5vIGVycm9yIGVtaXR0ZWQuIFRoaXMgc2hvdWxkIGJlIGFsbG93ZWQgaW4KICAgICAgICAvLyBmYXZvciBvZiBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4gU2luY2UgdGhlIHN0cmVhbSBpcyBwaXBlZCB0byBhCiAgICAgICAgLy8gZGVzdGluYXRpb24gdGhpcyBzaG91bGQgbm90IHJlc3VsdCBpbiBhbnkgb2JzZXJ2YWJsZSBkaWZmZXJlbmNlLgogICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gY2hlY2sgaWYgdGhpcyBpcyBhIHdyaXRhYmxlIHByZW1hdHVyZSBjbG9zZSBzaW5jZQogICAgICAgIC8vIGVvcyB3aWxsIG9ubHkgZmFpbCB3aXRoIHByZW1hdHVyZSBjbG9zZSBvbiB0aGUgcmVhZGluZyBzaWRlIGZvcgogICAgICAgIC8vIGR1cGxleCBzdHJlYW1zLgogICAgICAgIHNyYy5vbmNlKCdlbmQnLCBmaW5pc2gpLm9uY2UoJ2Vycm9yJywgZmluaXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gZW9zKGRzdCwgewogICAgICByZWFkYWJsZTogZmFsc2UsCiAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICB9LCBmaW5pc2gpOwogIH0KICBwaXBlbGluZV8xID0gewogICAgcGlwZWxpbmVJbXBsLAogICAgcGlwZWxpbmUKICB9OwogIHJldHVybiBwaXBlbGluZV8xOwp9Cgp2YXIgY29tcG9zZTsKdmFyIGhhc1JlcXVpcmVkQ29tcG9zZTsKZnVuY3Rpb24gcmVxdWlyZUNvbXBvc2UoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQ29tcG9zZSkgcmV0dXJuIGNvbXBvc2U7CiAgaGFzUmVxdWlyZWRDb21wb3NlID0gMTsKICBjb25zdCB7CiAgICBwaXBlbGluZQogIH0gPSByZXF1aXJlUGlwZWxpbmUoKTsKICBjb25zdCBEdXBsZXggPSByZXF1aXJlRHVwbGV4KCk7CiAgY29uc3QgewogICAgZGVzdHJveWVyCiAgfSA9IHJlcXVpcmVEZXN0cm95KCk7CiAgY29uc3QgewogICAgaXNOb2RlU3RyZWFtLAogICAgaXNSZWFkYWJsZSwKICAgIGlzV3JpdGFibGUsCiAgICBpc1dlYlN0cmVhbSwKICAgIGlzVHJhbnNmb3JtU3RyZWFtLAogICAgaXNXcml0YWJsZVN0cmVhbSwKICAgIGlzUmVhZGFibGVTdHJlYW0KICB9ID0gcmVxdWlyZVV0aWxzJDEoKTsKICBjb25zdCB7CiAgICBBYm9ydEVycm9yLAogICAgY29kZXM6IHsKICAgICAgRVJSX0lOVkFMSURfQVJHX1ZBTFVFLAogICAgICBFUlJfTUlTU0lOR19BUkdTCiAgICB9CiAgfSA9IHJlcXVpcmVFcnJvcnMoKTsKICBjb25zdCBlb3MgPSByZXF1aXJlRW5kT2ZTdHJlYW0oKTsKICBjb21wb3NlID0gZnVuY3Rpb24gY29tcG9zZSguLi5zdHJlYW1zKSB7CiAgICBpZiAoc3RyZWFtcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVSUl9NSVNTSU5HX0FSR1MoJ3N0cmVhbXMnKTsKICAgIH0KICAgIGlmIChzdHJlYW1zLmxlbmd0aCA9PT0gMSkgewogICAgICByZXR1cm4gRHVwbGV4LmZyb20oc3RyZWFtc1swXSk7CiAgICB9CiAgICBjb25zdCBvcmdTdHJlYW1zID0gWy4uLnN0cmVhbXNdOwogICAgaWYgKHR5cGVvZiBzdHJlYW1zWzBdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHN0cmVhbXNbMF0gPSBEdXBsZXguZnJvbShzdHJlYW1zWzBdKTsKICAgIH0KICAgIGlmICh0eXBlb2Ygc3RyZWFtc1tzdHJlYW1zLmxlbmd0aCAtIDFdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNvbnN0IGlkeCA9IHN0cmVhbXMubGVuZ3RoIC0gMTsKICAgICAgc3RyZWFtc1tpZHhdID0gRHVwbGV4LmZyb20oc3RyZWFtc1tpZHhdKTsKICAgIH0KICAgIGZvciAobGV0IG4gPSAwOyBuIDwgc3RyZWFtcy5sZW5ndGg7ICsrbikgewogICAgICBpZiAoIWlzTm9kZVN0cmVhbShzdHJlYW1zW25dKSAmJiAhaXNXZWJTdHJlYW0oc3RyZWFtc1tuXSkpIHsKICAgICAgICAvLyBUT0RPKHJvbmFnKTogQWRkIGNoZWNrcyBmb3Igbm9uIHN0cmVhbXMuCiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKG4gPCBzdHJlYW1zLmxlbmd0aCAtIDEgJiYgIShpc1JlYWRhYmxlKHN0cmVhbXNbbl0pIHx8IGlzUmVhZGFibGVTdHJlYW0oc3RyZWFtc1tuXSkgfHwgaXNUcmFuc2Zvcm1TdHJlYW0oc3RyZWFtc1tuXSkpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19WQUxVRShgc3RyZWFtc1ske259XWAsIG9yZ1N0cmVhbXNbbl0sICdtdXN0IGJlIHJlYWRhYmxlJyk7CiAgICAgIH0KICAgICAgaWYgKG4gPiAwICYmICEoaXNXcml0YWJsZShzdHJlYW1zW25dKSB8fCBpc1dyaXRhYmxlU3RyZWFtKHN0cmVhbXNbbl0pIHx8IGlzVHJhbnNmb3JtU3RyZWFtKHN0cmVhbXNbbl0pKSkgewogICAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVkFMVUUoYHN0cmVhbXNbJHtufV1gLCBvcmdTdHJlYW1zW25dLCAnbXVzdCBiZSB3cml0YWJsZScpOwogICAgICB9CiAgICB9CiAgICBsZXQgb25kcmFpbjsKICAgIGxldCBvbmZpbmlzaDsKICAgIGxldCBvbnJlYWRhYmxlOwogICAgbGV0IG9uY2xvc2U7CiAgICBsZXQgZDsKICAgIGZ1bmN0aW9uIG9uZmluaXNoZWQoZXJyKSB7CiAgICAgIGNvbnN0IGNiID0gb25jbG9zZTsKICAgICAgb25jbG9zZSA9IG51bGw7CiAgICAgIGlmIChjYikgewogICAgICAgIGNiKGVycik7CiAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgZC5kZXN0cm95KGVycik7CiAgICAgIH0gZWxzZSBpZiAoIXJlYWRhYmxlICYmICF3cml0YWJsZSkgewogICAgICAgIGQuZGVzdHJveSgpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBoZWFkID0gc3RyZWFtc1swXTsKICAgIGNvbnN0IHRhaWwgPSBwaXBlbGluZShzdHJlYW1zLCBvbmZpbmlzaGVkKTsKICAgIGNvbnN0IHdyaXRhYmxlID0gISEoaXNXcml0YWJsZShoZWFkKSB8fCBpc1dyaXRhYmxlU3RyZWFtKGhlYWQpIHx8IGlzVHJhbnNmb3JtU3RyZWFtKGhlYWQpKTsKICAgIGNvbnN0IHJlYWRhYmxlID0gISEoaXNSZWFkYWJsZSh0YWlsKSB8fCBpc1JlYWRhYmxlU3RyZWFtKHRhaWwpIHx8IGlzVHJhbnNmb3JtU3RyZWFtKHRhaWwpKTsKCiAgICAvLyBUT0RPKHJvbmFnKTogQXZvaWQgZG91YmxlIGJ1ZmZlcmluZy4KICAgIC8vIEltcGxlbWVudCBXcml0YWJsZS9SZWFkYWJsZS9EdXBsZXggdHJhaXRzLgogICAgLy8gU2VlLCBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvcHVsbC8zMzUxNS4KICAgIGQgPSBuZXcgRHVwbGV4KHsKICAgICAgLy8gVE9ETyAocm9uYWcpOiBoaWdoV2F0ZXJNYXJrPwogICAgICB3cml0YWJsZU9iamVjdE1vZGU6ICEhKGhlYWQgIT09IG51bGwgJiYgaGVhZCAhPT0gdW5kZWZpbmVkICYmIGhlYWQud3JpdGFibGVPYmplY3RNb2RlKSwKICAgICAgcmVhZGFibGVPYmplY3RNb2RlOiAhISh0YWlsICE9PSBudWxsICYmIHRhaWwgIT09IHVuZGVmaW5lZCAmJiB0YWlsLnJlYWRhYmxlT2JqZWN0TW9kZSksCiAgICAgIHdyaXRhYmxlLAogICAgICByZWFkYWJsZQogICAgfSk7CiAgICBpZiAod3JpdGFibGUpIHsKICAgICAgaWYgKGlzTm9kZVN0cmVhbShoZWFkKSkgewogICAgICAgIGQuX3dyaXRlID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChoZWFkLndyaXRlKGNodW5rLCBlbmNvZGluZykpIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9uZHJhaW4gPSBjYWxsYmFjazsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGQuX2ZpbmFsID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICBoZWFkLmVuZCgpOwogICAgICAgICAgb25maW5pc2ggPSBjYWxsYmFjazsKICAgICAgICB9OwogICAgICAgIGhlYWQub24oJ2RyYWluJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKG9uZHJhaW4pIHsKICAgICAgICAgICAgY29uc3QgY2IgPSBvbmRyYWluOwogICAgICAgICAgICBvbmRyYWluID0gbnVsbDsKICAgICAgICAgICAgY2IoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChpc1dlYlN0cmVhbShoZWFkKSkgewogICAgICAgIGNvbnN0IHdyaXRhYmxlID0gaXNUcmFuc2Zvcm1TdHJlYW0oaGVhZCkgPyBoZWFkLndyaXRhYmxlIDogaGVhZDsKICAgICAgICBjb25zdCB3cml0ZXIgPSB3cml0YWJsZS5nZXRXcml0ZXIoKTsKICAgICAgICBkLl93cml0ZSA9IGFzeW5jIGZ1bmN0aW9uIChjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB3cml0ZXIucmVhZHk7CiAgICAgICAgICAgIHdyaXRlci53cml0ZShjaHVuaykuY2F0Y2goKCkgPT4ge30pOwogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBkLl9maW5hbCA9IGFzeW5jIGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgd3JpdGVyLnJlYWR5OwogICAgICAgICAgICB3cml0ZXIuY2xvc2UoKS5jYXRjaCgoKSA9PiB7fSk7CiAgICAgICAgICAgIG9uZmluaXNoID0gY2FsbGJhY2s7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGNvbnN0IHRvUmVhZCA9IGlzVHJhbnNmb3JtU3RyZWFtKHRhaWwpID8gdGFpbC5yZWFkYWJsZSA6IHRhaWw7CiAgICAgIGVvcyh0b1JlYWQsICgpID0+IHsKICAgICAgICBpZiAob25maW5pc2gpIHsKICAgICAgICAgIGNvbnN0IGNiID0gb25maW5pc2g7CiAgICAgICAgICBvbmZpbmlzaCA9IG51bGw7CiAgICAgICAgICBjYigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBpZiAocmVhZGFibGUpIHsKICAgICAgaWYgKGlzTm9kZVN0cmVhbSh0YWlsKSkgewogICAgICAgIHRhaWwub24oJ3JlYWRhYmxlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKG9ucmVhZGFibGUpIHsKICAgICAgICAgICAgY29uc3QgY2IgPSBvbnJlYWRhYmxlOwogICAgICAgICAgICBvbnJlYWRhYmxlID0gbnVsbDsKICAgICAgICAgICAgY2IoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0YWlsLm9uKCdlbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkLnB1c2gobnVsbCk7CiAgICAgICAgfSk7CiAgICAgICAgZC5fcmVhZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGNvbnN0IGJ1ZiA9IHRhaWwucmVhZCgpOwogICAgICAgICAgICBpZiAoYnVmID09PSBudWxsKSB7CiAgICAgICAgICAgICAgb25yZWFkYWJsZSA9IGQuX3JlYWQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZC5wdXNoKGJ1ZikpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKGlzV2ViU3RyZWFtKHRhaWwpKSB7CiAgICAgICAgY29uc3QgcmVhZGFibGUgPSBpc1RyYW5zZm9ybVN0cmVhbSh0YWlsKSA/IHRhaWwucmVhZGFibGUgOiB0YWlsOwogICAgICAgIGNvbnN0IHJlYWRlciA9IHJlYWRhYmxlLmdldFJlYWRlcigpOwogICAgICAgIGQuX3JlYWQgPSBhc3luYyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgICAgZG9uZQogICAgICAgICAgICAgIH0gPSBhd2FpdCByZWFkZXIucmVhZCgpOwogICAgICAgICAgICAgIGlmICghZC5wdXNoKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICAgZC5wdXNoKG51bGwpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZC5fZGVzdHJveSA9IGZ1bmN0aW9uIChlcnIsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghZXJyICYmIG9uY2xvc2UgIT09IG51bGwpIHsKICAgICAgICBlcnIgPSBuZXcgQWJvcnRFcnJvcigpOwogICAgICB9CiAgICAgIG9ucmVhZGFibGUgPSBudWxsOwogICAgICBvbmRyYWluID0gbnVsbDsKICAgICAgb25maW5pc2ggPSBudWxsOwogICAgICBpZiAob25jbG9zZSA9PT0gbnVsbCkgewogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb25jbG9zZSA9IGNhbGxiYWNrOwogICAgICAgIGlmIChpc05vZGVTdHJlYW0odGFpbCkpIHsKICAgICAgICAgIGRlc3Ryb3llcih0YWlsLCBlcnIpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHJldHVybiBkOwogIH07CiAgcmV0dXJuIGNvbXBvc2U7Cn0KCnZhciBoYXNSZXF1aXJlZE9wZXJhdG9yczsKZnVuY3Rpb24gcmVxdWlyZU9wZXJhdG9ycygpIHsKICBpZiAoaGFzUmVxdWlyZWRPcGVyYXRvcnMpIHJldHVybiBvcGVyYXRvcnM7CiAgaGFzUmVxdWlyZWRPcGVyYXRvcnMgPSAxOwogIGNvbnN0IEFib3J0Q29udHJvbGxlciA9IGdsb2JhbFRoaXMuQWJvcnRDb250cm9sbGVyIHx8IHJlcXVpcmUkJDAkMS5BYm9ydENvbnRyb2xsZXI7CiAgY29uc3QgewogICAgY29kZXM6IHsKICAgICAgRVJSX0lOVkFMSURfQVJHX1ZBTFVFLAogICAgICBFUlJfSU5WQUxJRF9BUkdfVFlQRSwKICAgICAgRVJSX01JU1NJTkdfQVJHUywKICAgICAgRVJSX09VVF9PRl9SQU5HRQogICAgfSwKICAgIEFib3J0RXJyb3IKICB9ID0gcmVxdWlyZUVycm9ycygpOwogIGNvbnN0IHsKICAgIHZhbGlkYXRlQWJvcnRTaWduYWwsCiAgICB2YWxpZGF0ZUludGVnZXIsCiAgICB2YWxpZGF0ZU9iamVjdAogIH0gPSByZXF1aXJlVmFsaWRhdG9ycygpOwogIGNvbnN0IGtXZWFrSGFuZGxlciA9IHJlcXVpcmVQcmltb3JkaWFscygpLlN5bWJvbCgna1dlYWsnKTsKICBjb25zdCBrUmVzaXN0U3RvcFByb3BhZ2F0aW9uID0gcmVxdWlyZVByaW1vcmRpYWxzKCkuU3ltYm9sKCdrUmVzaXN0U3RvcFByb3BhZ2F0aW9uJyk7CiAgY29uc3QgewogICAgZmluaXNoZWQKICB9ID0gcmVxdWlyZUVuZE9mU3RyZWFtKCk7CiAgY29uc3Qgc3RhdGljQ29tcG9zZSA9IHJlcXVpcmVDb21wb3NlKCk7CiAgY29uc3QgewogICAgYWRkQWJvcnRTaWduYWxOb1ZhbGlkYXRlCiAgfSA9IHJlcXVpcmVBZGRBYm9ydFNpZ25hbCgpOwogIGNvbnN0IHsKICAgIGlzV3JpdGFibGUsCiAgICBpc05vZGVTdHJlYW0KICB9ID0gcmVxdWlyZVV0aWxzJDEoKTsKICBjb25zdCB7CiAgICBkZXByZWNhdGUKICB9ID0gcmVxdWlyZVV0aWwkMSgpOwogIGNvbnN0IHsKICAgIEFycmF5UHJvdG90eXBlUHVzaCwKICAgIEJvb2xlYW4sCiAgICBNYXRoRmxvb3IsCiAgICBOdW1iZXIsCiAgICBOdW1iZXJJc05hTiwKICAgIFByb21pc2UsCiAgICBQcm9taXNlUmVqZWN0LAogICAgUHJvbWlzZVJlc29sdmUsCiAgICBQcm9taXNlUHJvdG90eXBlVGhlbiwKICAgIFN5bWJvbAogIH0gPSByZXF1aXJlUHJpbW9yZGlhbHMoKTsKICBjb25zdCBrRW1wdHkgPSBTeW1ib2woJ2tFbXB0eScpOwogIGNvbnN0IGtFb2YgPSBTeW1ib2woJ2tFb2YnKTsKICBmdW5jdGlvbiBjb21wb3NlKHN0cmVhbSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMgIT0gbnVsbCkgewogICAgICB2YWxpZGF0ZU9iamVjdChvcHRpb25zLCAnb3B0aW9ucycpOwogICAgfQogICAgaWYgKChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG9wdGlvbnMuc2lnbmFsKSAhPSBudWxsKSB7CiAgICAgIHZhbGlkYXRlQWJvcnRTaWduYWwob3B0aW9ucy5zaWduYWwsICdvcHRpb25zLnNpZ25hbCcpOwogICAgfQogICAgaWYgKGlzTm9kZVN0cmVhbShzdHJlYW0pICYmICFpc1dyaXRhYmxlKHN0cmVhbSkpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19WQUxVRSgnc3RyZWFtJywgc3RyZWFtLCAnbXVzdCBiZSB3cml0YWJsZScpOwogICAgfQogICAgY29uc3QgY29tcG9zZWRTdHJlYW0gPSBzdGF0aWNDb21wb3NlKHRoaXMsIHN0cmVhbSk7CiAgICBpZiAob3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5zaWduYWwpIHsKICAgICAgLy8gTm90IHZhbGlkYXRpbmcgYXMgd2UgYWxyZWFkeSB2YWxpZGF0ZWQgYmVmb3JlCiAgICAgIGFkZEFib3J0U2lnbmFsTm9WYWxpZGF0ZShvcHRpb25zLnNpZ25hbCwgY29tcG9zZWRTdHJlYW0pOwogICAgfQogICAgcmV0dXJuIGNvbXBvc2VkU3RyZWFtOwogIH0KICBmdW5jdGlvbiBtYXAoZm4sIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhyb3cgbmV3IEVSUl9JTlZBTElEX0FSR19UWVBFKCdmbicsIFsnRnVuY3Rpb24nLCAnQXN5bmNGdW5jdGlvbiddLCBmbik7CiAgICB9CiAgICBpZiAob3B0aW9ucyAhPSBudWxsKSB7CiAgICAgIHZhbGlkYXRlT2JqZWN0KG9wdGlvbnMsICdvcHRpb25zJyk7CiAgICB9CiAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3B0aW9ucy5zaWduYWwpICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVBYm9ydFNpZ25hbChvcHRpb25zLnNpZ25hbCwgJ29wdGlvbnMuc2lnbmFsJyk7CiAgICB9CiAgICBsZXQgY29uY3VycmVuY3kgPSAxOwogICAgaWYgKChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG9wdGlvbnMuY29uY3VycmVuY3kpICE9IG51bGwpIHsKICAgICAgY29uY3VycmVuY3kgPSBNYXRoRmxvb3Iob3B0aW9ucy5jb25jdXJyZW5jeSk7CiAgICB9CiAgICBsZXQgaGlnaFdhdGVyTWFyayA9IGNvbmN1cnJlbmN5IC0gMTsKICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRpb25zLmhpZ2hXYXRlck1hcmspICE9IG51bGwpIHsKICAgICAgaGlnaFdhdGVyTWFyayA9IE1hdGhGbG9vcihvcHRpb25zLmhpZ2hXYXRlck1hcmspOwogICAgfQogICAgdmFsaWRhdGVJbnRlZ2VyKGNvbmN1cnJlbmN5LCAnb3B0aW9ucy5jb25jdXJyZW5jeScsIDEpOwogICAgdmFsaWRhdGVJbnRlZ2VyKGhpZ2hXYXRlck1hcmssICdvcHRpb25zLmhpZ2hXYXRlck1hcmsnLCAwKTsKICAgIGhpZ2hXYXRlck1hcmsgKz0gY29uY3VycmVuY3k7CiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24qIG1hcCgpIHsKICAgICAgY29uc3Qgc2lnbmFsID0gcmVxdWlyZVV0aWwkMSgpLkFib3J0U2lnbmFsQW55KFtvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZCA6IG9wdGlvbnMuc2lnbmFsXS5maWx0ZXIoQm9vbGVhbikpOwogICAgICBjb25zdCBzdHJlYW0gPSB0aGlzOwogICAgICBjb25zdCBxdWV1ZSA9IFtdOwogICAgICBjb25zdCBzaWduYWxPcHQgPSB7CiAgICAgICAgc2lnbmFsCiAgICAgIH07CiAgICAgIGxldCBuZXh0OwogICAgICBsZXQgcmVzdW1lOwogICAgICBsZXQgZG9uZSA9IGZhbHNlOwogICAgICBsZXQgY250ID0gMDsKICAgICAgZnVuY3Rpb24gb25DYXRjaCgpIHsKICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICBhZnRlckl0ZW1Qcm9jZXNzZWQoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBhZnRlckl0ZW1Qcm9jZXNzZWQoKSB7CiAgICAgICAgY250IC09IDE7CiAgICAgICAgbWF5YmVSZXN1bWUoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBtYXliZVJlc3VtZSgpIHsKICAgICAgICBpZiAocmVzdW1lICYmICFkb25lICYmIGNudCA8IGNvbmN1cnJlbmN5ICYmIHF1ZXVlLmxlbmd0aCA8IGhpZ2hXYXRlck1hcmspIHsKICAgICAgICAgIHJlc3VtZSgpOwogICAgICAgICAgcmVzdW1lID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgYXN5bmMgZnVuY3Rpb24gcHVtcCgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgZm9yIGF3YWl0IChsZXQgdmFsIG9mIHN0cmVhbSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgQWJvcnRFcnJvcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFsID0gZm4odmFsLCBzaWduYWxPcHQpOwogICAgICAgICAgICAgIGlmICh2YWwgPT09IGtFbXB0eSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhbCA9IFByb21pc2VSZXNvbHZlKHZhbCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHZhbCA9IFByb21pc2VSZWplY3QoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbnQgKz0gMTsKICAgICAgICAgICAgUHJvbWlzZVByb3RvdHlwZVRoZW4odmFsLCBhZnRlckl0ZW1Qcm9jZXNzZWQsIG9uQ2F0Y2gpOwogICAgICAgICAgICBxdWV1ZS5wdXNoKHZhbCk7CiAgICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgICAgbmV4dCgpOwogICAgICAgICAgICAgIG5leHQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZG9uZSAmJiAocXVldWUubGVuZ3RoID49IGhpZ2hXYXRlck1hcmsgfHwgY250ID49IGNvbmN1cnJlbmN5KSkgewogICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgICAgICAgICAgICAgcmVzdW1lID0gcmVzb2x2ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWUucHVzaChrRW9mKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGNvbnN0IHZhbCA9IFByb21pc2VSZWplY3QoZXJyKTsKICAgICAgICAgIFByb21pc2VQcm90b3R5cGVUaGVuKHZhbCwgYWZ0ZXJJdGVtUHJvY2Vzc2VkLCBvbkNhdGNoKTsKICAgICAgICAgIHF1ZXVlLnB1c2godmFsKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICBuZXh0KCk7CiAgICAgICAgICAgIG5leHQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBwdW1wKCk7CiAgICAgIHRyeSB7CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbCA9IGF3YWl0IHF1ZXVlWzBdOwogICAgICAgICAgICBpZiAodmFsID09PSBrRW9mKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBBYm9ydEVycm9yKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbCAhPT0ga0VtcHR5KSB7CiAgICAgICAgICAgICAgeWllbGQgdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIG1heWJlUmVzdW1lKCk7CiAgICAgICAgICB9CiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgICAgICAgbmV4dCA9IHJlc29sdmU7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgaWYgKHJlc3VtZSkgewogICAgICAgICAgcmVzdW1lKCk7CiAgICAgICAgICByZXN1bWUgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfS5jYWxsKHRoaXMpOwogIH0KICBmdW5jdGlvbiBhc0luZGV4ZWRQYWlycyhvcHRpb25zID0gdW5kZWZpbmVkKSB7CiAgICBpZiAob3B0aW9ucyAhPSBudWxsKSB7CiAgICAgIHZhbGlkYXRlT2JqZWN0KG9wdGlvbnMsICdvcHRpb25zJyk7CiAgICB9CiAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3B0aW9ucy5zaWduYWwpICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVBYm9ydFNpZ25hbChvcHRpb25zLnNpZ25hbCwgJ29wdGlvbnMuc2lnbmFsJyk7CiAgICB9CiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24qIGFzSW5kZXhlZFBhaXJzKCkgewogICAgICBsZXQgaW5kZXggPSAwOwogICAgICBmb3IgYXdhaXQgKGNvbnN0IHZhbCBvZiB0aGlzKSB7CiAgICAgICAgdmFyIF9vcHRpb25zJHNpZ25hbDsKICAgICAgICBpZiAob3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgKF9vcHRpb25zJHNpZ25hbCA9IG9wdGlvbnMuc2lnbmFsKSAhPT0gbnVsbCAmJiBfb3B0aW9ucyRzaWduYWwgIT09IHVuZGVmaW5lZCAmJiBfb3B0aW9ucyRzaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEFib3J0RXJyb3IoewogICAgICAgICAgICBjYXVzZTogb3B0aW9ucy5zaWduYWwucmVhc29uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgeWllbGQgW2luZGV4KyssIHZhbF07CiAgICAgIH0KICAgIH0uY2FsbCh0aGlzKTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gc29tZShmbiwgb3B0aW9ucyA9IHVuZGVmaW5lZCkgewogICAgZm9yIGF3YWl0IChjb25zdCB1bnVzZWQgb2YgZmlsdGVyLmNhbGwodGhpcywgZm4sIG9wdGlvbnMpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBhc3luYyBmdW5jdGlvbiBldmVyeShmbiwgb3B0aW9ucyA9IHVuZGVmaW5lZCkgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ2ZuJywgWydGdW5jdGlvbicsICdBc3luY0Z1bmN0aW9uJ10sIGZuKTsKICAgIH0KICAgIC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0RlX01vcmdhbiUyN3NfbGF3cwogICAgcmV0dXJuICEoYXdhaXQgc29tZS5jYWxsKHRoaXMsIGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICAgIHJldHVybiAhKGF3YWl0IGZuKC4uLmFyZ3MpKTsKICAgIH0sIG9wdGlvbnMpKTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZmluZChmbiwgb3B0aW9ucykgewogICAgZm9yIGF3YWl0IChjb25zdCByZXN1bHQgb2YgZmlsdGVyLmNhbGwodGhpcywgZm4sIG9wdGlvbnMpKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KICBhc3luYyBmdW5jdGlvbiBmb3JFYWNoKGZuLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIGZuICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgnZm4nLCBbJ0Z1bmN0aW9uJywgJ0FzeW5jRnVuY3Rpb24nXSwgZm4pOwogICAgfQogICAgYXN5bmMgZnVuY3Rpb24gZm9yRWFjaEZuKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgIGF3YWl0IGZuKHZhbHVlLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGtFbXB0eTsKICAgIH0KICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFycwogICAgZm9yIGF3YWl0IChjb25zdCB1bnVzZWQgb2YgbWFwLmNhbGwodGhpcywgZm9yRWFjaEZuLCBvcHRpb25zKSk7CiAgfQogIGZ1bmN0aW9uIGZpbHRlcihmbiwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRVJSX0lOVkFMSURfQVJHX1RZUEUoJ2ZuJywgWydGdW5jdGlvbicsICdBc3luY0Z1bmN0aW9uJ10sIGZuKTsKICAgIH0KICAgIGFzeW5jIGZ1bmN0aW9uIGZpbHRlckZuKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgIGlmIChhd2FpdCBmbih2YWx1ZSwgb3B0aW9ucykpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGtFbXB0eTsKICAgIH0KICAgIHJldHVybiBtYXAuY2FsbCh0aGlzLCBmaWx0ZXJGbiwgb3B0aW9ucyk7CiAgfQoKICAvLyBTcGVjaWZpYyB0byBwcm92aWRlIGJldHRlciBlcnJvciB0byByZWR1Y2Ugc2luY2UgdGhlIGFyZ3VtZW50IGlzIG9ubHkKICAvLyBtaXNzaW5nIGlmIHRoZSBzdHJlYW0gaGFzIG5vIGl0ZW1zIGluIGl0IC0gYnV0IHRoZSBjb2RlIGlzIHN0aWxsIGFwcHJvcHJpYXRlCiAgY2xhc3MgUmVkdWNlQXdhcmVFcnJNaXNzaW5nQXJncyBleHRlbmRzIEVSUl9NSVNTSU5HX0FSR1MgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKCdyZWR1Y2UnKTsKICAgICAgdGhpcy5tZXNzYWdlID0gJ1JlZHVjZSBvZiBhbiBlbXB0eSBzdHJlYW0gcmVxdWlyZXMgYW4gaW5pdGlhbCB2YWx1ZSc7CiAgICB9CiAgfQogIGFzeW5jIGZ1bmN0aW9uIHJlZHVjZShyZWR1Y2VyLCBpbml0aWFsVmFsdWUsIG9wdGlvbnMpIHsKICAgIHZhciBfb3B0aW9ucyRzaWduYWwyOwogICAgaWYgKHR5cGVvZiByZWR1Y2VyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRocm93IG5ldyBFUlJfSU5WQUxJRF9BUkdfVFlQRSgncmVkdWNlcicsIFsnRnVuY3Rpb24nLCAnQXN5bmNGdW5jdGlvbiddLCByZWR1Y2VyKTsKICAgIH0KICAgIGlmIChvcHRpb25zICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVPYmplY3Qob3B0aW9ucywgJ29wdGlvbnMnKTsKICAgIH0KICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRpb25zLnNpZ25hbCkgIT0gbnVsbCkgewogICAgICB2YWxpZGF0ZUFib3J0U2lnbmFsKG9wdGlvbnMuc2lnbmFsLCAnb3B0aW9ucy5zaWduYWwnKTsKICAgIH0KICAgIGxldCBoYXNJbml0aWFsVmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMTsKICAgIGlmIChvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiAoX29wdGlvbnMkc2lnbmFsMiA9IG9wdGlvbnMuc2lnbmFsKSAhPT0gbnVsbCAmJiBfb3B0aW9ucyRzaWduYWwyICE9PSB1bmRlZmluZWQgJiYgX29wdGlvbnMkc2lnbmFsMi5hYm9ydGVkKSB7CiAgICAgIGNvbnN0IGVyciA9IG5ldyBBYm9ydEVycm9yKHVuZGVmaW5lZCwgewogICAgICAgIGNhdXNlOiBvcHRpb25zLnNpZ25hbC5yZWFzb24KICAgICAgfSk7CiAgICAgIHRoaXMub25jZSgnZXJyb3InLCAoKSA9PiB7fSk7IC8vIFRoZSBlcnJvciBpcyBhbHJlYWR5IHByb3BhZ2F0ZWQKICAgICAgYXdhaXQgZmluaXNoZWQodGhpcy5kZXN0cm95KGVycikpOwogICAgICB0aHJvdyBlcnI7CiAgICB9CiAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IGFjLnNpZ25hbDsKICAgIGlmIChvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnNpZ25hbCkgewogICAgICBjb25zdCBvcHRzID0gewogICAgICAgIG9uY2U6IHRydWUsCiAgICAgICAgW2tXZWFrSGFuZGxlcl06IHRoaXMsCiAgICAgICAgW2tSZXNpc3RTdG9wUHJvcGFnYXRpb25dOiB0cnVlCiAgICAgIH07CiAgICAgIG9wdGlvbnMuc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgKCkgPT4gYWMuYWJvcnQoKSwgb3B0cyk7CiAgICB9CiAgICBsZXQgZ290QW55SXRlbUZyb21TdHJlYW0gPSBmYWxzZTsKICAgIHRyeSB7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgdmFsdWUgb2YgdGhpcykgewogICAgICAgIHZhciBfb3B0aW9ucyRzaWduYWwzOwogICAgICAgIGdvdEFueUl0ZW1Gcm9tU3RyZWFtID0gdHJ1ZTsKICAgICAgICBpZiAob3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgKF9vcHRpb25zJHNpZ25hbDMgPSBvcHRpb25zLnNpZ25hbCkgIT09IG51bGwgJiYgX29wdGlvbnMkc2lnbmFsMyAhPT0gdW5kZWZpbmVkICYmIF9vcHRpb25zJHNpZ25hbDMuYWJvcnRlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEFib3J0RXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFoYXNJbml0aWFsVmFsdWUpIHsKICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgaGFzSW5pdGlhbFZhbHVlID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW5pdGlhbFZhbHVlID0gYXdhaXQgcmVkdWNlcihpbml0aWFsVmFsdWUsIHZhbHVlLCB7CiAgICAgICAgICAgIHNpZ25hbAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghZ290QW55SXRlbUZyb21TdHJlYW0gJiYgIWhhc0luaXRpYWxWYWx1ZSkgewogICAgICAgIHRocm93IG5ldyBSZWR1Y2VBd2FyZUVyck1pc3NpbmdBcmdzKCk7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGFjLmFib3J0KCk7CiAgICB9CiAgICByZXR1cm4gaW5pdGlhbFZhbHVlOwogIH0KICBhc3luYyBmdW5jdGlvbiB0b0FycmF5KG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVPYmplY3Qob3B0aW9ucywgJ29wdGlvbnMnKTsKICAgIH0KICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRpb25zLnNpZ25hbCkgIT0gbnVsbCkgewogICAgICB2YWxpZGF0ZUFib3J0U2lnbmFsKG9wdGlvbnMuc2lnbmFsLCAnb3B0aW9ucy5zaWduYWwnKTsKICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgZm9yIGF3YWl0IChjb25zdCB2YWwgb2YgdGhpcykgewogICAgICB2YXIgX29wdGlvbnMkc2lnbmFsNDsKICAgICAgaWYgKG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIChfb3B0aW9ucyRzaWduYWw0ID0gb3B0aW9ucy5zaWduYWwpICE9PSBudWxsICYmIF9vcHRpb25zJHNpZ25hbDQgIT09IHVuZGVmaW5lZCAmJiBfb3B0aW9ucyRzaWduYWw0LmFib3J0ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgQWJvcnRFcnJvcih1bmRlZmluZWQsIHsKICAgICAgICAgIGNhdXNlOiBvcHRpb25zLnNpZ25hbC5yZWFzb24KICAgICAgICB9KTsKICAgICAgfQogICAgICBBcnJheVByb3RvdHlwZVB1c2gocmVzdWx0LCB2YWwpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZmxhdE1hcChmbiwgb3B0aW9ucykgewogICAgY29uc3QgdmFsdWVzID0gbWFwLmNhbGwodGhpcywgZm4sIG9wdGlvbnMpOwogICAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uKiBmbGF0TWFwKCkgewogICAgICBmb3IgYXdhaXQgKGNvbnN0IHZhbCBvZiB2YWx1ZXMpIHsKICAgICAgICB5aWVsZCogdmFsOwogICAgICB9CiAgICB9LmNhbGwodGhpcyk7CiAgfQogIGZ1bmN0aW9uIHRvSW50ZWdlck9ySW5maW5pdHkobnVtYmVyKSB7CiAgICAvLyBXZSBjb2VyY2UgaGVyZSB0byBhbGlnbiB3aXRoIHRoZSBzcGVjCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vdGMzOS9wcm9wb3NhbC1pdGVyYXRvci1oZWxwZXJzL2lzc3Vlcy8xNjkKICAgIG51bWJlciA9IE51bWJlcihudW1iZXIpOwogICAgaWYgKE51bWJlcklzTmFOKG51bWJlcikpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICB0aHJvdyBuZXcgRVJSX09VVF9PRl9SQU5HRSgnbnVtYmVyJywgJz49IDAnLCBudW1iZXIpOwogICAgfQogICAgcmV0dXJuIG51bWJlcjsKICB9CiAgZnVuY3Rpb24gZHJvcChudW1iZXIsIG9wdGlvbnMgPSB1bmRlZmluZWQpIHsKICAgIGlmIChvcHRpb25zICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVPYmplY3Qob3B0aW9ucywgJ29wdGlvbnMnKTsKICAgIH0KICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBvcHRpb25zLnNpZ25hbCkgIT0gbnVsbCkgewogICAgICB2YWxpZGF0ZUFib3J0U2lnbmFsKG9wdGlvbnMuc2lnbmFsLCAnb3B0aW9ucy5zaWduYWwnKTsKICAgIH0KICAgIG51bWJlciA9IHRvSW50ZWdlck9ySW5maW5pdHkobnVtYmVyKTsKICAgIHJldHVybiBhc3luYyBmdW5jdGlvbiogZHJvcCgpIHsKICAgICAgdmFyIF9vcHRpb25zJHNpZ25hbDU7CiAgICAgIGlmIChvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiAoX29wdGlvbnMkc2lnbmFsNSA9IG9wdGlvbnMuc2lnbmFsKSAhPT0gbnVsbCAmJiBfb3B0aW9ucyRzaWduYWw1ICE9PSB1bmRlZmluZWQgJiYgX29wdGlvbnMkc2lnbmFsNS5hYm9ydGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEFib3J0RXJyb3IoKTsKICAgICAgfQogICAgICBmb3IgYXdhaXQgKGNvbnN0IHZhbCBvZiB0aGlzKSB7CiAgICAgICAgdmFyIF9vcHRpb25zJHNpZ25hbDY7CiAgICAgICAgaWYgKG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIChfb3B0aW9ucyRzaWduYWw2ID0gb3B0aW9ucy5zaWduYWwpICE9PSBudWxsICYmIF9vcHRpb25zJHNpZ25hbDYgIT09IHVuZGVmaW5lZCAmJiBfb3B0aW9ucyRzaWduYWw2LmFib3J0ZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBBYm9ydEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXItLSA8PSAwKSB7CiAgICAgICAgICB5aWVsZCB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9LmNhbGwodGhpcyk7CiAgfQogIGZ1bmN0aW9uIHRha2UobnVtYmVyLCBvcHRpb25zID0gdW5kZWZpbmVkKSB7CiAgICBpZiAob3B0aW9ucyAhPSBudWxsKSB7CiAgICAgIHZhbGlkYXRlT2JqZWN0KG9wdGlvbnMsICdvcHRpb25zJyk7CiAgICB9CiAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogb3B0aW9ucy5zaWduYWwpICE9IG51bGwpIHsKICAgICAgdmFsaWRhdGVBYm9ydFNpZ25hbChvcHRpb25zLnNpZ25hbCwgJ29wdGlvbnMuc2lnbmFsJyk7CiAgICB9CiAgICBudW1iZXIgPSB0b0ludGVnZXJPckluZmluaXR5KG51bWJlcik7CiAgICByZXR1cm4gYXN5bmMgZnVuY3Rpb24qIHRha2UoKSB7CiAgICAgIHZhciBfb3B0aW9ucyRzaWduYWw3OwogICAgICBpZiAob3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zICE9PSB1bmRlZmluZWQgJiYgKF9vcHRpb25zJHNpZ25hbDcgPSBvcHRpb25zLnNpZ25hbCkgIT09IG51bGwgJiYgX29wdGlvbnMkc2lnbmFsNyAhPT0gdW5kZWZpbmVkICYmIF9vcHRpb25zJHNpZ25hbDcuYWJvcnRlZCkgewogICAgICAgIHRocm93IG5ldyBBYm9ydEVycm9yKCk7CiAgICAgIH0KICAgICAgZm9yIGF3YWl0IChjb25zdCB2YWwgb2YgdGhpcykgewogICAgICAgIHZhciBfb3B0aW9ucyRzaWduYWw4OwogICAgICAgIGlmIChvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMgIT09IHVuZGVmaW5lZCAmJiAoX29wdGlvbnMkc2lnbmFsOCA9IG9wdGlvbnMuc2lnbmFsKSAhPT0gbnVsbCAmJiBfb3B0aW9ucyRzaWduYWw4ICE9PSB1bmRlZmluZWQgJiYgX29wdGlvbnMkc2lnbmFsOC5hYm9ydGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQWJvcnRFcnJvcigpOwogICAgICAgIH0KICAgICAgICBpZiAobnVtYmVyLS0gPiAwKSB7CiAgICAgICAgICB5aWVsZCB2YWw7CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBnZXQgYW5vdGhlciBpdGVtIGZyb20gaXRlcmF0b3IgaW4gY2FzZSB3ZSByZWFjaGVkIHRoZSBlbmQKICAgICAgICBpZiAobnVtYmVyIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0uY2FsbCh0aGlzKTsKICB9CiAgb3BlcmF0b3JzLnN0cmVhbVJldHVybmluZ09wZXJhdG9ycyA9IHsKICAgIGFzSW5kZXhlZFBhaXJzOiBkZXByZWNhdGUoYXNJbmRleGVkUGFpcnMsICdyZWFkYWJsZS5hc0luZGV4ZWRQYWlycyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4nKSwKICAgIGRyb3AsCiAgICBmaWx0ZXIsCiAgICBmbGF0TWFwLAogICAgbWFwLAogICAgdGFrZSwKICAgIGNvbXBvc2UKICB9OwogIG9wZXJhdG9ycy5wcm9taXNlUmV0dXJuaW5nT3BlcmF0b3JzID0gewogICAgZXZlcnksCiAgICBmb3JFYWNoLAogICAgcmVkdWNlLAogICAgdG9BcnJheSwKICAgIHNvbWUsCiAgICBmaW5kCiAgfTsKICByZXR1cm4gb3BlcmF0b3JzOwp9Cgp2YXIgcHJvbWlzZXM7CnZhciBoYXNSZXF1aXJlZFByb21pc2VzOwpmdW5jdGlvbiByZXF1aXJlUHJvbWlzZXMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkUHJvbWlzZXMpIHJldHVybiBwcm9taXNlczsKICBoYXNSZXF1aXJlZFByb21pc2VzID0gMTsKICBjb25zdCB7CiAgICBBcnJheVByb3RvdHlwZVBvcCwKICAgIFByb21pc2UKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgY29uc3QgewogICAgaXNJdGVyYWJsZSwKICAgIGlzTm9kZVN0cmVhbSwKICAgIGlzV2ViU3RyZWFtCiAgfSA9IHJlcXVpcmVVdGlscyQxKCk7CiAgY29uc3QgewogICAgcGlwZWxpbmVJbXBsOiBwbAogIH0gPSByZXF1aXJlUGlwZWxpbmUoKTsKICBjb25zdCB7CiAgICBmaW5pc2hlZAogIH0gPSByZXF1aXJlRW5kT2ZTdHJlYW0oKTsKICByZXF1aXJlU3RyZWFtJDEoKTsKICBmdW5jdGlvbiBwaXBlbGluZSguLi5zdHJlYW1zKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBsZXQgc2lnbmFsOwogICAgICBsZXQgZW5kOwogICAgICBjb25zdCBsYXN0QXJnID0gc3RyZWFtc1tzdHJlYW1zLmxlbmd0aCAtIDFdOwogICAgICBpZiAobGFzdEFyZyAmJiB0eXBlb2YgbGFzdEFyZyA9PT0gJ29iamVjdCcgJiYgIWlzTm9kZVN0cmVhbShsYXN0QXJnKSAmJiAhaXNJdGVyYWJsZShsYXN0QXJnKSAmJiAhaXNXZWJTdHJlYW0obGFzdEFyZykpIHsKICAgICAgICBjb25zdCBvcHRpb25zID0gQXJyYXlQcm90b3R5cGVQb3Aoc3RyZWFtcyk7CiAgICAgICAgc2lnbmFsID0gb3B0aW9ucy5zaWduYWw7CiAgICAgICAgZW5kID0gb3B0aW9ucy5lbmQ7CiAgICAgIH0KICAgICAgcGwoc3RyZWFtcywgKGVyciwgdmFsdWUpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc2lnbmFsLAogICAgICAgIGVuZAogICAgICB9KTsKICAgIH0pOwogIH0KICBwcm9taXNlcyA9IHsKICAgIGZpbmlzaGVkLAogICAgcGlwZWxpbmUKICB9OwogIHJldHVybiBwcm9taXNlczsKfQoKdmFyIGhhc1JlcXVpcmVkU3RyZWFtJDE7CmZ1bmN0aW9uIHJlcXVpcmVTdHJlYW0kMSgpIHsKICBpZiAoaGFzUmVxdWlyZWRTdHJlYW0kMSkgcmV0dXJuIHN0cmVhbSQxLmV4cG9ydHM7CiAgaGFzUmVxdWlyZWRTdHJlYW0kMSA9IDE7CgogIC8qIHJlcGxhY2VtZW50IHN0YXJ0ICovCgogIGNvbnN0IHsKICAgIEJ1ZmZlcgogIH0gPSByZXF1aXJlJCQwJDM7CgogIC8qIHJlcGxhY2VtZW50IGVuZCAqLwoKICBjb25zdCB7CiAgICBPYmplY3REZWZpbmVQcm9wZXJ0eSwKICAgIE9iamVjdEtleXMsCiAgICBSZWZsZWN0QXBwbHkKICB9ID0gcmVxdWlyZVByaW1vcmRpYWxzKCk7CiAgY29uc3QgewogICAgcHJvbWlzaWZ5OiB7CiAgICAgIGN1c3RvbTogY3VzdG9tUHJvbWlzaWZ5CiAgICB9CiAgfSA9IHJlcXVpcmVVdGlsJDEoKTsKICBjb25zdCB7CiAgICBzdHJlYW1SZXR1cm5pbmdPcGVyYXRvcnMsCiAgICBwcm9taXNlUmV0dXJuaW5nT3BlcmF0b3JzCiAgfSA9IHJlcXVpcmVPcGVyYXRvcnMoKTsKICBjb25zdCB7CiAgICBjb2RlczogewogICAgICBFUlJfSUxMRUdBTF9DT05TVFJVQ1RPUgogICAgfQogIH0gPSByZXF1aXJlRXJyb3JzKCk7CiAgY29uc3QgY29tcG9zZSA9IHJlcXVpcmVDb21wb3NlKCk7CiAgY29uc3QgewogICAgc2V0RGVmYXVsdEhpZ2hXYXRlck1hcmssCiAgICBnZXREZWZhdWx0SGlnaFdhdGVyTWFyawogIH0gPSByZXF1aXJlU3RhdGUoKTsKICBjb25zdCB7CiAgICBwaXBlbGluZQogIH0gPSByZXF1aXJlUGlwZWxpbmUoKTsKICBjb25zdCB7CiAgICBkZXN0cm95ZXIKICB9ID0gcmVxdWlyZURlc3Ryb3koKTsKICBjb25zdCBlb3MgPSByZXF1aXJlRW5kT2ZTdHJlYW0oKTsKICBjb25zdCBwcm9taXNlcyA9IHJlcXVpcmVQcm9taXNlcygpOwogIGNvbnN0IHV0aWxzID0gcmVxdWlyZVV0aWxzJDEoKTsKICBjb25zdCBTdHJlYW0gPSBzdHJlYW0kMS5leHBvcnRzID0gcmVxdWlyZUxlZ2FjeSgpLlN0cmVhbTsKICBTdHJlYW0uaXNEZXN0cm95ZWQgPSB1dGlscy5pc0Rlc3Ryb3llZDsKICBTdHJlYW0uaXNEaXN0dXJiZWQgPSB1dGlscy5pc0Rpc3R1cmJlZDsKICBTdHJlYW0uaXNFcnJvcmVkID0gdXRpbHMuaXNFcnJvcmVkOwogIFN0cmVhbS5pc1JlYWRhYmxlID0gdXRpbHMuaXNSZWFkYWJsZTsKICBTdHJlYW0uaXNXcml0YWJsZSA9IHV0aWxzLmlzV3JpdGFibGU7CiAgU3RyZWFtLlJlYWRhYmxlID0gcmVxdWlyZVJlYWRhYmxlKCk7CiAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0S2V5cyhzdHJlYW1SZXR1cm5pbmdPcGVyYXRvcnMpKSB7CiAgICBjb25zdCBvcCA9IHN0cmVhbVJldHVybmluZ09wZXJhdG9yc1trZXldOwogICAgZnVuY3Rpb24gZm4oLi4uYXJncykgewogICAgICBpZiAobmV3LnRhcmdldCkgewogICAgICAgIHRocm93IEVSUl9JTExFR0FMX0NPTlNUUlVDVE9SKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIFN0cmVhbS5SZWFkYWJsZS5mcm9tKFJlZmxlY3RBcHBseShvcCwgdGhpcywgYXJncykpOwogICAgfQogICAgT2JqZWN0RGVmaW5lUHJvcGVydHkoZm4sICduYW1lJywgewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIHZhbHVlOiBvcC5uYW1lCiAgICB9KTsKICAgIE9iamVjdERlZmluZVByb3BlcnR5KGZuLCAnbGVuZ3RoJywgewogICAgICBfX3Byb3RvX186IG51bGwsCiAgICAgIHZhbHVlOiBvcC5sZW5ndGgKICAgIH0pOwogICAgT2JqZWN0RGVmaW5lUHJvcGVydHkoU3RyZWFtLlJlYWRhYmxlLnByb3RvdHlwZSwga2V5LCB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgdmFsdWU6IGZuLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdEtleXMocHJvbWlzZVJldHVybmluZ09wZXJhdG9ycykpIHsKICAgIGNvbnN0IG9wID0gcHJvbWlzZVJldHVybmluZ09wZXJhdG9yc1trZXldOwogICAgZnVuY3Rpb24gZm4oLi4uYXJncykgewogICAgICBpZiAobmV3LnRhcmdldCkgewogICAgICAgIHRocm93IEVSUl9JTExFR0FMX0NPTlNUUlVDVE9SKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIFJlZmxlY3RBcHBseShvcCwgdGhpcywgYXJncyk7CiAgICB9CiAgICBPYmplY3REZWZpbmVQcm9wZXJ0eShmbiwgJ25hbWUnLCB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgdmFsdWU6IG9wLm5hbWUKICAgIH0pOwogICAgT2JqZWN0RGVmaW5lUHJvcGVydHkoZm4sICdsZW5ndGgnLCB7CiAgICAgIF9fcHJvdG9fXzogbnVsbCwKICAgICAgdmFsdWU6IG9wLmxlbmd0aAogICAgfSk7CiAgICBPYmplY3REZWZpbmVQcm9wZXJ0eShTdHJlYW0uUmVhZGFibGUucHJvdG90eXBlLCBrZXksIHsKICAgICAgX19wcm90b19fOiBudWxsLAogICAgICB2YWx1ZTogZm4sCiAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICB9KTsKICB9CiAgU3RyZWFtLldyaXRhYmxlID0gcmVxdWlyZVdyaXRhYmxlKCk7CiAgU3RyZWFtLkR1cGxleCA9IHJlcXVpcmVEdXBsZXgoKTsKICBTdHJlYW0uVHJhbnNmb3JtID0gcmVxdWlyZVRyYW5zZm9ybSgpOwogIFN0cmVhbS5QYXNzVGhyb3VnaCA9IHJlcXVpcmVQYXNzdGhyb3VnaCgpOwogIFN0cmVhbS5waXBlbGluZSA9IHBpcGVsaW5lOwogIGNvbnN0IHsKICAgIGFkZEFib3J0U2lnbmFsCiAgfSA9IHJlcXVpcmVBZGRBYm9ydFNpZ25hbCgpOwogIFN0cmVhbS5hZGRBYm9ydFNpZ25hbCA9IGFkZEFib3J0U2lnbmFsOwogIFN0cmVhbS5maW5pc2hlZCA9IGVvczsKICBTdHJlYW0uZGVzdHJveSA9IGRlc3Ryb3llcjsKICBTdHJlYW0uY29tcG9zZSA9IGNvbXBvc2U7CiAgU3RyZWFtLnNldERlZmF1bHRIaWdoV2F0ZXJNYXJrID0gc2V0RGVmYXVsdEhpZ2hXYXRlck1hcms7CiAgU3RyZWFtLmdldERlZmF1bHRIaWdoV2F0ZXJNYXJrID0gZ2V0RGVmYXVsdEhpZ2hXYXRlck1hcms7CiAgT2JqZWN0RGVmaW5lUHJvcGVydHkoU3RyZWFtLCAncHJvbWlzZXMnLCB7CiAgICBfX3Byb3RvX186IG51bGwsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0KCkgewogICAgICByZXR1cm4gcHJvbWlzZXM7CiAgICB9CiAgfSk7CiAgT2JqZWN0RGVmaW5lUHJvcGVydHkocGlwZWxpbmUsIGN1c3RvbVByb21pc2lmeSwgewogICAgX19wcm90b19fOiBudWxsLAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldCgpIHsKICAgICAgcmV0dXJuIHByb21pc2VzLnBpcGVsaW5lOwogICAgfQogIH0pOwogIE9iamVjdERlZmluZVByb3BlcnR5KGVvcywgY3VzdG9tUHJvbWlzaWZ5LCB7CiAgICBfX3Byb3RvX186IG51bGwsCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0KCkgewogICAgICByZXR1cm4gcHJvbWlzZXMuZmluaXNoZWQ7CiAgICB9CiAgfSk7CgogIC8vIEJhY2t3YXJkcy1jb21wYXQgd2l0aCBub2RlIDAuNC54CiAgU3RyZWFtLlN0cmVhbSA9IFN0cmVhbTsKICBTdHJlYW0uX2lzVWludDhBcnJheSA9IGZ1bmN0aW9uIGlzVWludDhBcnJheSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheTsKICB9OwogIFN0cmVhbS5fdWludDhBcnJheVRvQnVmZmVyID0gZnVuY3Rpb24gX3VpbnQ4QXJyYXlUb0J1ZmZlcihjaHVuaykgewogICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGNodW5rLmJ1ZmZlciwgY2h1bmsuYnl0ZU9mZnNldCwgY2h1bmsuYnl0ZUxlbmd0aCk7CiAgfTsKICByZXR1cm4gc3RyZWFtJDEuZXhwb3J0czsKfQoKb3Vycy5leHBvcnRzOwooZnVuY3Rpb24gKG1vZHVsZSkgewoKICBjb25zdCBTdHJlYW0gPSByZXF1aXJlJCQwJDQ7CiAgaWYgKFN0cmVhbSAmJiBwcm9jZXNzLmVudi5SRUFEQUJMRV9TVFJFQU0gPT09ICdkaXNhYmxlJykgewogICAgY29uc3QgcHJvbWlzZXMgPSBTdHJlYW0ucHJvbWlzZXM7CgogICAgLy8gRXhwbGljaXQgZXhwb3J0IG5hbWluZyBpcyBuZWVkZWQgZm9yIEVTTQogICAgbW9kdWxlLmV4cG9ydHMuX3VpbnQ4QXJyYXlUb0J1ZmZlciA9IFN0cmVhbS5fdWludDhBcnJheVRvQnVmZmVyOwogICAgbW9kdWxlLmV4cG9ydHMuX2lzVWludDhBcnJheSA9IFN0cmVhbS5faXNVaW50OEFycmF5OwogICAgbW9kdWxlLmV4cG9ydHMuaXNEaXN0dXJiZWQgPSBTdHJlYW0uaXNEaXN0dXJiZWQ7CiAgICBtb2R1bGUuZXhwb3J0cy5pc0Vycm9yZWQgPSBTdHJlYW0uaXNFcnJvcmVkOwogICAgbW9kdWxlLmV4cG9ydHMuaXNSZWFkYWJsZSA9IFN0cmVhbS5pc1JlYWRhYmxlOwogICAgbW9kdWxlLmV4cG9ydHMuUmVhZGFibGUgPSBTdHJlYW0uUmVhZGFibGU7CiAgICBtb2R1bGUuZXhwb3J0cy5Xcml0YWJsZSA9IFN0cmVhbS5Xcml0YWJsZTsKICAgIG1vZHVsZS5leHBvcnRzLkR1cGxleCA9IFN0cmVhbS5EdXBsZXg7CiAgICBtb2R1bGUuZXhwb3J0cy5UcmFuc2Zvcm0gPSBTdHJlYW0uVHJhbnNmb3JtOwogICAgbW9kdWxlLmV4cG9ydHMuUGFzc1Rocm91Z2ggPSBTdHJlYW0uUGFzc1Rocm91Z2g7CiAgICBtb2R1bGUuZXhwb3J0cy5hZGRBYm9ydFNpZ25hbCA9IFN0cmVhbS5hZGRBYm9ydFNpZ25hbDsKICAgIG1vZHVsZS5leHBvcnRzLmZpbmlzaGVkID0gU3RyZWFtLmZpbmlzaGVkOwogICAgbW9kdWxlLmV4cG9ydHMuZGVzdHJveSA9IFN0cmVhbS5kZXN0cm95OwogICAgbW9kdWxlLmV4cG9ydHMucGlwZWxpbmUgPSBTdHJlYW0ucGlwZWxpbmU7CiAgICBtb2R1bGUuZXhwb3J0cy5jb21wb3NlID0gU3RyZWFtLmNvbXBvc2U7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU3RyZWFtLCAncHJvbWlzZXMnLCB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIHJldHVybiBwcm9taXNlczsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cy5TdHJlYW0gPSBTdHJlYW0uU3RyZWFtOwogIH0gZWxzZSB7CiAgICBjb25zdCBDdXN0b21TdHJlYW0gPSByZXF1aXJlU3RyZWFtJDEoKTsKICAgIGNvbnN0IHByb21pc2VzID0gcmVxdWlyZVByb21pc2VzKCk7CiAgICBjb25zdCBvcmlnaW5hbERlc3Ryb3kgPSBDdXN0b21TdHJlYW0uUmVhZGFibGUuZGVzdHJveTsKICAgIG1vZHVsZS5leHBvcnRzID0gQ3VzdG9tU3RyZWFtLlJlYWRhYmxlOwoKICAgIC8vIEV4cGxpY2l0IGV4cG9ydCBuYW1pbmcgaXMgbmVlZGVkIGZvciBFU00KICAgIG1vZHVsZS5leHBvcnRzLl91aW50OEFycmF5VG9CdWZmZXIgPSBDdXN0b21TdHJlYW0uX3VpbnQ4QXJyYXlUb0J1ZmZlcjsKICAgIG1vZHVsZS5leHBvcnRzLl9pc1VpbnQ4QXJyYXkgPSBDdXN0b21TdHJlYW0uX2lzVWludDhBcnJheTsKICAgIG1vZHVsZS5leHBvcnRzLmlzRGlzdHVyYmVkID0gQ3VzdG9tU3RyZWFtLmlzRGlzdHVyYmVkOwogICAgbW9kdWxlLmV4cG9ydHMuaXNFcnJvcmVkID0gQ3VzdG9tU3RyZWFtLmlzRXJyb3JlZDsKICAgIG1vZHVsZS5leHBvcnRzLmlzUmVhZGFibGUgPSBDdXN0b21TdHJlYW0uaXNSZWFkYWJsZTsKICAgIG1vZHVsZS5leHBvcnRzLlJlYWRhYmxlID0gQ3VzdG9tU3RyZWFtLlJlYWRhYmxlOwogICAgbW9kdWxlLmV4cG9ydHMuV3JpdGFibGUgPSBDdXN0b21TdHJlYW0uV3JpdGFibGU7CiAgICBtb2R1bGUuZXhwb3J0cy5EdXBsZXggPSBDdXN0b21TdHJlYW0uRHVwbGV4OwogICAgbW9kdWxlLmV4cG9ydHMuVHJhbnNmb3JtID0gQ3VzdG9tU3RyZWFtLlRyYW5zZm9ybTsKICAgIG1vZHVsZS5leHBvcnRzLlBhc3NUaHJvdWdoID0gQ3VzdG9tU3RyZWFtLlBhc3NUaHJvdWdoOwogICAgbW9kdWxlLmV4cG9ydHMuYWRkQWJvcnRTaWduYWwgPSBDdXN0b21TdHJlYW0uYWRkQWJvcnRTaWduYWw7CiAgICBtb2R1bGUuZXhwb3J0cy5maW5pc2hlZCA9IEN1c3RvbVN0cmVhbS5maW5pc2hlZDsKICAgIG1vZHVsZS5leHBvcnRzLmRlc3Ryb3kgPSBDdXN0b21TdHJlYW0uZGVzdHJveTsKICAgIG1vZHVsZS5leHBvcnRzLmRlc3Ryb3kgPSBvcmlnaW5hbERlc3Ryb3k7CiAgICBtb2R1bGUuZXhwb3J0cy5waXBlbGluZSA9IEN1c3RvbVN0cmVhbS5waXBlbGluZTsKICAgIG1vZHVsZS5leHBvcnRzLmNvbXBvc2UgPSBDdXN0b21TdHJlYW0uY29tcG9zZTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDdXN0b21TdHJlYW0sICdwcm9taXNlcycsIHsKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHByb21pc2VzOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzLlN0cmVhbSA9IEN1c3RvbVN0cmVhbS5TdHJlYW07CiAgfQoKICAvLyBBbGxvdyBkZWZhdWx0IGltcG9ydGluZwogIG1vZHVsZS5leHBvcnRzLmRlZmF1bHQgPSBtb2R1bGUuZXhwb3J0czsKfSkob3Vycyk7CnZhciBvdXJzRXhwb3J0cyA9IG91cnMuZXhwb3J0czsKCnZhciBpbmhlcml0cyQxID0ge2V4cG9ydHM6IHt9fTsKCnZhciBpbmhlcml0c19icm93c2VyID0ge2V4cG9ydHM6IHt9fTsKCnZhciBoYXNSZXF1aXJlZEluaGVyaXRzX2Jyb3dzZXI7CmZ1bmN0aW9uIHJlcXVpcmVJbmhlcml0c19icm93c2VyKCkgewogIGlmIChoYXNSZXF1aXJlZEluaGVyaXRzX2Jyb3dzZXIpIHJldHVybiBpbmhlcml0c19icm93c2VyLmV4cG9ydHM7CiAgaGFzUmVxdWlyZWRJbmhlcml0c19icm93c2VyID0gMTsKICBpZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIC8vIGltcGxlbWVudGF0aW9uIGZyb20gc3RhbmRhcmQgbm9kZS5qcyAndXRpbCcgbW9kdWxlCiAgICBpbmhlcml0c19icm93c2VyLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgaWYgKHN1cGVyQ3RvcikgewogICAgICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yOwogICAgICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgICAgICB2YWx1ZTogY3RvciwKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9IGVsc2UgewogICAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICAgIGluaGVyaXRzX2Jyb3dzZXIuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBpZiAoc3VwZXJDdG9yKSB7CiAgICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3I7CiAgICAgICAgdmFyIFRlbXBDdG9yID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgVGVtcEN0b3IucHJvdG90eXBlID0gc3VwZXJDdG9yLnByb3RvdHlwZTsKICAgICAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpOwogICAgICAgIGN0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcjsKICAgICAgfQogICAgfTsKICB9CiAgcmV0dXJuIGluaGVyaXRzX2Jyb3dzZXIuZXhwb3J0czsKfQoKdHJ5IHsKICB2YXIgdXRpbCQxID0gcmVxdWlyZSgndXRpbCcpOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgaWYgKHR5cGVvZiB1dGlsJDEuaW5oZXJpdHMgIT09ICdmdW5jdGlvbicpIHRocm93ICcnOwogIGluaGVyaXRzJDEuZXhwb3J0cyA9IHV0aWwkMS5pbmhlcml0czsKfSBjYXRjaCAoZSkgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgaW5oZXJpdHMkMS5leHBvcnRzID0gcmVxdWlyZUluaGVyaXRzX2Jyb3dzZXIoKTsKfQp2YXIgaW5oZXJpdHNFeHBvcnRzID0gaW5oZXJpdHMkMS5leHBvcnRzOwoKY29uc3QgewogIEJ1ZmZlcjogQnVmZmVyJDQKfSA9IHJlcXVpcmUkJDAkMzsKY29uc3Qgc3ltYm9sID0gU3ltYm9sLmZvcignQnVmZmVyTGlzdCcpOwpmdW5jdGlvbiBCdWZmZXJMaXN0JDEoYnVmKSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEJ1ZmZlckxpc3QkMSkpIHsKICAgIHJldHVybiBuZXcgQnVmZmVyTGlzdCQxKGJ1Zik7CiAgfQogIEJ1ZmZlckxpc3QkMS5faW5pdC5jYWxsKHRoaXMsIGJ1Zik7Cn0KQnVmZmVyTGlzdCQxLl9pbml0ID0gZnVuY3Rpb24gX2luaXQoYnVmKSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHN5bWJvbCwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICB0aGlzLl9idWZzID0gW107CiAgdGhpcy5sZW5ndGggPSAwOwogIGlmIChidWYpIHsKICAgIHRoaXMuYXBwZW5kKGJ1Zik7CiAgfQp9OwpCdWZmZXJMaXN0JDEucHJvdG90eXBlLl9uZXcgPSBmdW5jdGlvbiBfbmV3KGJ1ZikgewogIHJldHVybiBuZXcgQnVmZmVyTGlzdCQxKGJ1Zik7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuX29mZnNldCA9IGZ1bmN0aW9uIF9vZmZzZXQob2Zmc2V0KSB7CiAgaWYgKG9mZnNldCA9PT0gMCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgbGV0IHRvdCA9IDA7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9idWZzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBfdCA9IHRvdCArIHRoaXMuX2J1ZnNbaV0ubGVuZ3RoOwogICAgaWYgKG9mZnNldCA8IF90IHx8IGkgPT09IHRoaXMuX2J1ZnMubGVuZ3RoIC0gMSkgewogICAgICByZXR1cm4gW2ksIG9mZnNldCAtIHRvdF07CiAgICB9CiAgICB0b3QgPSBfdDsKICB9Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuX3JldmVyc2VPZmZzZXQgPSBmdW5jdGlvbiAoYmxPZmZzZXQpIHsKICBjb25zdCBidWZmZXJJZCA9IGJsT2Zmc2V0WzBdOwogIGxldCBvZmZzZXQgPSBibE9mZnNldFsxXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlcklkOyBpKyspIHsKICAgIG9mZnNldCArPSB0aGlzLl9idWZzW2ldLmxlbmd0aDsKICB9CiAgcmV0dXJuIG9mZnNldDsKfTsKQnVmZmVyTGlzdCQxLnByb3RvdHlwZS5nZXRCdWZmZXJzID0gZnVuY3Rpb24gZ2V0QnVmZmVycygpIHsKICByZXR1cm4gdGhpcy5fYnVmczsKfTsKQnVmZmVyTGlzdCQxLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoaW5kZXgpIHsKICBpZiAoaW5kZXggPiB0aGlzLmxlbmd0aCB8fCBpbmRleCA8IDApIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfQogIGNvbnN0IG9mZnNldCA9IHRoaXMuX29mZnNldChpbmRleCk7CiAgcmV0dXJuIHRoaXMuX2J1ZnNbb2Zmc2V0WzBdXVtvZmZzZXRbMV1dOwp9OwpCdWZmZXJMaXN0JDEucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2Uoc3RhcnQsIGVuZCkgewogIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdudW1iZXInICYmIHN0YXJ0IDwgMCkgewogICAgc3RhcnQgKz0gdGhpcy5sZW5ndGg7CiAgfQogIGlmICh0eXBlb2YgZW5kID09PSAnbnVtYmVyJyAmJiBlbmQgPCAwKSB7CiAgICBlbmQgKz0gdGhpcy5sZW5ndGg7CiAgfQogIHJldHVybiB0aGlzLmNvcHkobnVsbCwgMCwgc3RhcnQsIGVuZCk7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkoZHN0LCBkc3RTdGFydCwgc3JjU3RhcnQsIHNyY0VuZCkgewogIGlmICh0eXBlb2Ygc3JjU3RhcnQgIT09ICdudW1iZXInIHx8IHNyY1N0YXJ0IDwgMCkgewogICAgc3JjU3RhcnQgPSAwOwogIH0KICBpZiAodHlwZW9mIHNyY0VuZCAhPT0gJ251bWJlcicgfHwgc3JjRW5kID4gdGhpcy5sZW5ndGgpIHsKICAgIHNyY0VuZCA9IHRoaXMubGVuZ3RoOwogIH0KICBpZiAoc3JjU3RhcnQgPj0gdGhpcy5sZW5ndGgpIHsKICAgIHJldHVybiBkc3QgfHwgQnVmZmVyJDQuYWxsb2MoMCk7CiAgfQogIGlmIChzcmNFbmQgPD0gMCkgewogICAgcmV0dXJuIGRzdCB8fCBCdWZmZXIkNC5hbGxvYygwKTsKICB9CiAgY29uc3QgY29weSA9ICEhZHN0OwogIGNvbnN0IG9mZiA9IHRoaXMuX29mZnNldChzcmNTdGFydCk7CiAgY29uc3QgbGVuID0gc3JjRW5kIC0gc3JjU3RhcnQ7CiAgbGV0IGJ5dGVzID0gbGVuOwogIGxldCBidWZvZmYgPSBjb3B5ICYmIGRzdFN0YXJ0IHx8IDA7CiAgbGV0IHN0YXJ0ID0gb2ZmWzFdOwoKICAvLyBjb3B5L3NsaWNlIGV2ZXJ5dGhpbmcKICBpZiAoc3JjU3RhcnQgPT09IDAgJiYgc3JjRW5kID09PSB0aGlzLmxlbmd0aCkgewogICAgaWYgKCFjb3B5KSB7CiAgICAgIC8vIHNsaWNlLCBidXQgZnVsbCBjb25jYXQgaWYgbXVsdGlwbGUgYnVmZmVycwogICAgICByZXR1cm4gdGhpcy5fYnVmcy5sZW5ndGggPT09IDEgPyB0aGlzLl9idWZzWzBdIDogQnVmZmVyJDQuY29uY2F0KHRoaXMuX2J1ZnMsIHRoaXMubGVuZ3RoKTsKICAgIH0KCiAgICAvLyBjb3B5LCBuZWVkIHRvIGNvcHkgaW5kaXZpZHVhbCBidWZmZXJzCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2J1ZnMubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5fYnVmc1tpXS5jb3B5KGRzdCwgYnVmb2ZmKTsKICAgICAgYnVmb2ZmICs9IHRoaXMuX2J1ZnNbaV0ubGVuZ3RoOwogICAgfQogICAgcmV0dXJuIGRzdDsKICB9CgogIC8vIGVhc3ksIGNoZWFwIGNhc2Ugd2hlcmUgaXQncyBhIHN1YnNldCBvZiBvbmUgb2YgdGhlIGJ1ZmZlcnMKICBpZiAoYnl0ZXMgPD0gdGhpcy5fYnVmc1tvZmZbMF1dLmxlbmd0aCAtIHN0YXJ0KSB7CiAgICByZXR1cm4gY29weSA/IHRoaXMuX2J1ZnNbb2ZmWzBdXS5jb3B5KGRzdCwgZHN0U3RhcnQsIHN0YXJ0LCBzdGFydCArIGJ5dGVzKSA6IHRoaXMuX2J1ZnNbb2ZmWzBdXS5zbGljZShzdGFydCwgc3RhcnQgKyBieXRlcyk7CiAgfQogIGlmICghY29weSkgewogICAgLy8gYSBzbGljZSwgd2UgbmVlZCBzb21ldGhpbmcgdG8gY29weSBpbiB0bwogICAgZHN0ID0gQnVmZmVyJDQuYWxsb2NVbnNhZmUobGVuKTsKICB9CiAgZm9yIChsZXQgaSA9IG9mZlswXTsgaSA8IHRoaXMuX2J1ZnMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGwgPSB0aGlzLl9idWZzW2ldLmxlbmd0aCAtIHN0YXJ0OwogICAgaWYgKGJ5dGVzID4gbCkgewogICAgICB0aGlzLl9idWZzW2ldLmNvcHkoZHN0LCBidWZvZmYsIHN0YXJ0KTsKICAgICAgYnVmb2ZmICs9IGw7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9idWZzW2ldLmNvcHkoZHN0LCBidWZvZmYsIHN0YXJ0LCBzdGFydCArIGJ5dGVzKTsKICAgICAgYnVmb2ZmICs9IGw7CiAgICAgIGJyZWFrOwogICAgfQogICAgYnl0ZXMgLT0gbDsKICAgIGlmIChzdGFydCkgewogICAgICBzdGFydCA9IDA7CiAgICB9CiAgfQoKICAvLyBzYWZlZ3VhcmQgc28gdGhhdCB3ZSBkb24ndCByZXR1cm4gdW5pbml0aWFsaXplZCBtZW1vcnkKICBpZiAoZHN0Lmxlbmd0aCA+IGJ1Zm9mZikgcmV0dXJuIGRzdC5zbGljZSgwLCBidWZvZmYpOwogIHJldHVybiBkc3Q7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuc2hhbGxvd1NsaWNlID0gZnVuY3Rpb24gc2hhbGxvd1NsaWNlKHN0YXJ0LCBlbmQpIHsKICBzdGFydCA9IHN0YXJ0IHx8IDA7CiAgZW5kID0gdHlwZW9mIGVuZCAhPT0gJ251bWJlcicgPyB0aGlzLmxlbmd0aCA6IGVuZDsKICBpZiAoc3RhcnQgPCAwKSB7CiAgICBzdGFydCArPSB0aGlzLmxlbmd0aDsKICB9CiAgaWYgKGVuZCA8IDApIHsKICAgIGVuZCArPSB0aGlzLmxlbmd0aDsKICB9CiAgaWYgKHN0YXJ0ID09PSBlbmQpIHsKICAgIHJldHVybiB0aGlzLl9uZXcoKTsKICB9CiAgY29uc3Qgc3RhcnRPZmZzZXQgPSB0aGlzLl9vZmZzZXQoc3RhcnQpOwogIGNvbnN0IGVuZE9mZnNldCA9IHRoaXMuX29mZnNldChlbmQpOwogIGNvbnN0IGJ1ZmZlcnMgPSB0aGlzLl9idWZzLnNsaWNlKHN0YXJ0T2Zmc2V0WzBdLCBlbmRPZmZzZXRbMF0gKyAxKTsKICBpZiAoZW5kT2Zmc2V0WzFdID09PSAwKSB7CiAgICBidWZmZXJzLnBvcCgpOwogIH0gZWxzZSB7CiAgICBidWZmZXJzW2J1ZmZlcnMubGVuZ3RoIC0gMV0gPSBidWZmZXJzW2J1ZmZlcnMubGVuZ3RoIC0gMV0uc2xpY2UoMCwgZW5kT2Zmc2V0WzFdKTsKICB9CiAgaWYgKHN0YXJ0T2Zmc2V0WzFdICE9PSAwKSB7CiAgICBidWZmZXJzWzBdID0gYnVmZmVyc1swXS5zbGljZShzdGFydE9mZnNldFsxXSk7CiAgfQogIHJldHVybiB0aGlzLl9uZXcoYnVmZmVycyk7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyhlbmNvZGluZywgc3RhcnQsIGVuZCkgewogIHJldHVybiB0aGlzLnNsaWNlKHN0YXJ0LCBlbmQpLnRvU3RyaW5nKGVuY29kaW5nKTsKfTsKQnVmZmVyTGlzdCQxLnByb3RvdHlwZS5jb25zdW1lID0gZnVuY3Rpb24gY29uc3VtZShieXRlcykgewogIC8vIGZpcnN0LCBub3JtYWxpemUgdGhlIGFyZ3VtZW50LCBpbiBhY2NvcmRhbmNlIHdpdGggaG93IEJ1ZmZlciBkb2VzIGl0CiAgYnl0ZXMgPSBNYXRoLnRydW5jKGJ5dGVzKTsKICAvLyBkbyBub3RoaW5nIGlmIG5vdCBhIHBvc2l0aXZlIG51bWJlcgogIGlmIChOdW1iZXIuaXNOYU4oYnl0ZXMpIHx8IGJ5dGVzIDw9IDApIHJldHVybiB0aGlzOwogIHdoaWxlICh0aGlzLl9idWZzLmxlbmd0aCkgewogICAgaWYgKGJ5dGVzID49IHRoaXMuX2J1ZnNbMF0ubGVuZ3RoKSB7CiAgICAgIGJ5dGVzIC09IHRoaXMuX2J1ZnNbMF0ubGVuZ3RoOwogICAgICB0aGlzLmxlbmd0aCAtPSB0aGlzLl9idWZzWzBdLmxlbmd0aDsKICAgICAgdGhpcy5fYnVmcy5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fYnVmc1swXSA9IHRoaXMuX2J1ZnNbMF0uc2xpY2UoYnl0ZXMpOwogICAgICB0aGlzLmxlbmd0aCAtPSBieXRlczsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9OwpCdWZmZXJMaXN0JDEucHJvdG90eXBlLmR1cGxpY2F0ZSA9IGZ1bmN0aW9uIGR1cGxpY2F0ZSgpIHsKICBjb25zdCBjb3B5ID0gdGhpcy5fbmV3KCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9idWZzLmxlbmd0aDsgaSsrKSB7CiAgICBjb3B5LmFwcGVuZCh0aGlzLl9idWZzW2ldKTsKICB9CiAgcmV0dXJuIGNvcHk7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuYXBwZW5kID0gZnVuY3Rpb24gYXBwZW5kKGJ1ZikgewogIHJldHVybiB0aGlzLl9hdHRhY2goYnVmLCBCdWZmZXJMaXN0JDEucHJvdG90eXBlLl9hcHBlbmRCdWZmZXIpOwp9OwpCdWZmZXJMaXN0JDEucHJvdG90eXBlLnByZXBlbmQgPSBmdW5jdGlvbiBwcmVwZW5kKGJ1ZikgewogIHJldHVybiB0aGlzLl9hdHRhY2goYnVmLCBCdWZmZXJMaXN0JDEucHJvdG90eXBlLl9wcmVwZW5kQnVmZmVyLCB0cnVlKTsKfTsKQnVmZmVyTGlzdCQxLnByb3RvdHlwZS5fYXR0YWNoID0gZnVuY3Rpb24gX2F0dGFjaChidWYsIGF0dGFjaGVyLCBwcmVwZW5kKSB7CiAgaWYgKGJ1ZiA9PSBudWxsKSB7CiAgICByZXR1cm4gdGhpczsKICB9CiAgaWYgKGJ1Zi5idWZmZXIpIHsKICAgIC8vIGFwcGVuZC9wcmVwZW5kIGEgdmlldyBvZiB0aGUgdW5kZXJseWluZyBBcnJheUJ1ZmZlcgogICAgYXR0YWNoZXIuY2FsbCh0aGlzLCBCdWZmZXIkNC5mcm9tKGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZUxlbmd0aCkpOwogIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShidWYpKSB7CiAgICBjb25zdCBbc3RhcnRpbmcsIG1vZGlmaWVyXSA9IHByZXBlbmQgPyBbYnVmLmxlbmd0aCAtIDEsIC0xXSA6IFswLCAxXTsKICAgIGZvciAobGV0IGkgPSBzdGFydGluZzsgaSA+PSAwICYmIGkgPCBidWYubGVuZ3RoOyBpICs9IG1vZGlmaWVyKSB7CiAgICAgIHRoaXMuX2F0dGFjaChidWZbaV0sIGF0dGFjaGVyLCBwcmVwZW5kKTsKICAgIH0KICB9IGVsc2UgaWYgKHRoaXMuX2lzQnVmZmVyTGlzdChidWYpKSB7CiAgICAvLyB1bndyYXAgYXJndW1lbnQgaW50byBpbmRpdmlkdWFsIEJ1ZmZlckxpc3RzCiAgICBjb25zdCBbc3RhcnRpbmcsIG1vZGlmaWVyXSA9IHByZXBlbmQgPyBbYnVmLl9idWZzLmxlbmd0aCAtIDEsIC0xXSA6IFswLCAxXTsKICAgIGZvciAobGV0IGkgPSBzdGFydGluZzsgaSA+PSAwICYmIGkgPCBidWYuX2J1ZnMubGVuZ3RoOyBpICs9IG1vZGlmaWVyKSB7CiAgICAgIHRoaXMuX2F0dGFjaChidWYuX2J1ZnNbaV0sIGF0dGFjaGVyLCBwcmVwZW5kKTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gY29lcmNlIG51bWJlciBhcmd1bWVudHMgdG8gc3RyaW5ncywgc2luY2UgQnVmZmVyKG51bWJlcikgZG9lcwogICAgLy8gdW5pbml0aWFsaXplZCBtZW1vcnkgYWxsb2NhdGlvbgogICAgaWYgKHR5cGVvZiBidWYgPT09ICdudW1iZXInKSB7CiAgICAgIGJ1ZiA9IGJ1Zi50b1N0cmluZygpOwogICAgfQogICAgYXR0YWNoZXIuY2FsbCh0aGlzLCBCdWZmZXIkNC5mcm9tKGJ1ZikpOwogIH0KICByZXR1cm4gdGhpczsKfTsKQnVmZmVyTGlzdCQxLnByb3RvdHlwZS5fYXBwZW5kQnVmZmVyID0gZnVuY3Rpb24gYXBwZW5kQnVmZmVyKGJ1ZikgewogIHRoaXMuX2J1ZnMucHVzaChidWYpOwogIHRoaXMubGVuZ3RoICs9IGJ1Zi5sZW5ndGg7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuX3ByZXBlbmRCdWZmZXIgPSBmdW5jdGlvbiBwcmVwZW5kQnVmZmVyKGJ1ZikgewogIHRoaXMuX2J1ZnMudW5zaGlmdChidWYpOwogIHRoaXMubGVuZ3RoICs9IGJ1Zi5sZW5ndGg7Cn07CkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIChzZWFyY2gsIG9mZnNldCwgZW5jb2RpbmcpIHsKICBpZiAoZW5jb2RpbmcgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgZW5jb2RpbmcgPSBvZmZzZXQ7CiAgICBvZmZzZXQgPSB1bmRlZmluZWQ7CiAgfQogIGlmICh0eXBlb2Ygc2VhcmNoID09PSAnZnVuY3Rpb24nIHx8IEFycmF5LmlzQXJyYXkoc2VhcmNoKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlICJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBiZSBvbmUgb2YgdHlwZSBzdHJpbmcsIEJ1ZmZlciwgQnVmZmVyTGlzdCwgb3IgVWludDhBcnJheS4nKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBzZWFyY2ggPT09ICdudW1iZXInKSB7CiAgICBzZWFyY2ggPSBCdWZmZXIkNC5mcm9tKFtzZWFyY2hdKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBzZWFyY2ggPT09ICdzdHJpbmcnKSB7CiAgICBzZWFyY2ggPSBCdWZmZXIkNC5mcm9tKHNlYXJjaCwgZW5jb2RpbmcpOwogIH0gZWxzZSBpZiAodGhpcy5faXNCdWZmZXJMaXN0KHNlYXJjaCkpIHsKICAgIHNlYXJjaCA9IHNlYXJjaC5zbGljZSgpOwogIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzZWFyY2guYnVmZmVyKSkgewogICAgc2VhcmNoID0gQnVmZmVyJDQuZnJvbShzZWFyY2guYnVmZmVyLCBzZWFyY2guYnl0ZU9mZnNldCwgc2VhcmNoLmJ5dGVMZW5ndGgpOwogIH0gZWxzZSBpZiAoIUJ1ZmZlciQ0LmlzQnVmZmVyKHNlYXJjaCkpIHsKICAgIHNlYXJjaCA9IEJ1ZmZlciQ0LmZyb20oc2VhcmNoKTsKICB9CiAgb2Zmc2V0ID0gTnVtYmVyKG9mZnNldCB8fCAwKTsKICBpZiAoaXNOYU4ob2Zmc2V0KSkgewogICAgb2Zmc2V0ID0gMDsKICB9CiAgaWYgKG9mZnNldCA8IDApIHsKICAgIG9mZnNldCA9IHRoaXMubGVuZ3RoICsgb2Zmc2V0OwogIH0KICBpZiAob2Zmc2V0IDwgMCkgewogICAgb2Zmc2V0ID0gMDsKICB9CiAgaWYgKHNlYXJjaC5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBvZmZzZXQgPiB0aGlzLmxlbmd0aCA/IHRoaXMubGVuZ3RoIDogb2Zmc2V0OwogIH0KICBjb25zdCBibE9mZnNldCA9IHRoaXMuX29mZnNldChvZmZzZXQpOwogIGxldCBibEluZGV4ID0gYmxPZmZzZXRbMF07IC8vIGluZGV4IG9mIHdoaWNoIGludGVybmFsIGJ1ZmZlciB3ZSdyZSB3b3JraW5nIG9uCiAgbGV0IGJ1ZmZPZmZzZXQgPSBibE9mZnNldFsxXTsgLy8gb2Zmc2V0IG9mIHRoZSBpbnRlcm5hbCBidWZmZXIgd2UncmUgd29ya2luZyBvbgoKICAvLyBzY2FuIG92ZXIgZWFjaCBidWZmZXIKICBmb3IgKDsgYmxJbmRleCA8IHRoaXMuX2J1ZnMubGVuZ3RoOyBibEluZGV4KyspIHsKICAgIGNvbnN0IGJ1ZmYgPSB0aGlzLl9idWZzW2JsSW5kZXhdOwogICAgd2hpbGUgKGJ1ZmZPZmZzZXQgPCBidWZmLmxlbmd0aCkgewogICAgICBjb25zdCBhdmFpbGFibGVXaW5kb3cgPSBidWZmLmxlbmd0aCAtIGJ1ZmZPZmZzZXQ7CiAgICAgIGlmIChhdmFpbGFibGVXaW5kb3cgPj0gc2VhcmNoLmxlbmd0aCkgewogICAgICAgIGNvbnN0IG5hdGl2ZVNlYXJjaFJlc3VsdCA9IGJ1ZmYuaW5kZXhPZihzZWFyY2gsIGJ1ZmZPZmZzZXQpOwogICAgICAgIGlmIChuYXRpdmVTZWFyY2hSZXN1bHQgIT09IC0xKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV2ZXJzZU9mZnNldChbYmxJbmRleCwgbmF0aXZlU2VhcmNoUmVzdWx0XSk7CiAgICAgICAgfQogICAgICAgIGJ1ZmZPZmZzZXQgPSBidWZmLmxlbmd0aCAtIHNlYXJjaC5sZW5ndGggKyAxOyAvLyBlbmQgb2YgbmF0aXZlIHNlYXJjaCB3aW5kb3cKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByZXZPZmZzZXQgPSB0aGlzLl9yZXZlcnNlT2Zmc2V0KFtibEluZGV4LCBidWZmT2Zmc2V0XSk7CiAgICAgICAgaWYgKHRoaXMuX21hdGNoKHJldk9mZnNldCwgc2VhcmNoKSkgewogICAgICAgICAgcmV0dXJuIHJldk9mZnNldDsKICAgICAgICB9CiAgICAgICAgYnVmZk9mZnNldCsrOwogICAgICB9CiAgICB9CiAgICBidWZmT2Zmc2V0ID0gMDsKICB9CiAgcmV0dXJuIC0xOwp9OwpCdWZmZXJMaXN0JDEucHJvdG90eXBlLl9tYXRjaCA9IGZ1bmN0aW9uIChvZmZzZXQsIHNlYXJjaCkgewogIGlmICh0aGlzLmxlbmd0aCAtIG9mZnNldCA8IHNlYXJjaC5sZW5ndGgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZm9yIChsZXQgc2VhcmNoT2Zmc2V0ID0gMDsgc2VhcmNoT2Zmc2V0IDwgc2VhcmNoLmxlbmd0aDsgc2VhcmNoT2Zmc2V0KyspIHsKICAgIGlmICh0aGlzLmdldChvZmZzZXQgKyBzZWFyY2hPZmZzZXQpICE9PSBzZWFyY2hbc2VhcmNoT2Zmc2V0XSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9OwooZnVuY3Rpb24gKCkgewogIGNvbnN0IG1ldGhvZHMgPSB7CiAgICByZWFkRG91YmxlQkU6IDgsCiAgICByZWFkRG91YmxlTEU6IDgsCiAgICByZWFkRmxvYXRCRTogNCwKICAgIHJlYWRGbG9hdExFOiA0LAogICAgcmVhZEJpZ0ludDY0QkU6IDgsCiAgICByZWFkQmlnSW50NjRMRTogOCwKICAgIHJlYWRCaWdVSW50NjRCRTogOCwKICAgIHJlYWRCaWdVSW50NjRMRTogOCwKICAgIHJlYWRJbnQzMkJFOiA0LAogICAgcmVhZEludDMyTEU6IDQsCiAgICByZWFkVUludDMyQkU6IDQsCiAgICByZWFkVUludDMyTEU6IDQsCiAgICByZWFkSW50MTZCRTogMiwKICAgIHJlYWRJbnQxNkxFOiAyLAogICAgcmVhZFVJbnQxNkJFOiAyLAogICAgcmVhZFVJbnQxNkxFOiAyLAogICAgcmVhZEludDg6IDEsCiAgICByZWFkVUludDg6IDEsCiAgICByZWFkSW50QkU6IG51bGwsCiAgICByZWFkSW50TEU6IG51bGwsCiAgICByZWFkVUludEJFOiBudWxsLAogICAgcmVhZFVJbnRMRTogbnVsbAogIH07CiAgZm9yIChjb25zdCBtIGluIG1ldGhvZHMpIHsKICAgIChmdW5jdGlvbiAobSkgewogICAgICBpZiAobWV0aG9kc1ttXSA9PT0gbnVsbCkgewogICAgICAgIEJ1ZmZlckxpc3QkMS5wcm90b3R5cGVbbV0gPSBmdW5jdGlvbiAob2Zmc2V0LCBieXRlTGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zbGljZShvZmZzZXQsIG9mZnNldCArIGJ5dGVMZW5ndGgpW21dKDAsIGJ5dGVMZW5ndGgpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgQnVmZmVyTGlzdCQxLnByb3RvdHlwZVttXSA9IGZ1bmN0aW9uIChvZmZzZXQgPSAwKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zbGljZShvZmZzZXQsIG9mZnNldCArIG1ldGhvZHNbbV0pW21dKDApOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pKG0pOwogIH0KfSkoKTsKCi8vIFVzZWQgaW50ZXJuYWxseSBieSB0aGUgY2xhc3MgYW5kIGFsc28gYXMgYW4gaW5kaWNhdG9yIG9mIHRoaXMgb2JqZWN0IGJlaW5nCi8vIGEgYEJ1ZmZlckxpc3RgLiBJdCdzIG5vdCBwb3NzaWJsZSB0byB1c2UgYGluc3RhbmNlb2YgQnVmZmVyTGlzdGAgaW4gYSBicm93c2VyCi8vIGVudmlyb25tZW50IGJlY2F1c2UgdGhlcmUgY291bGQgYmUgbXVsdGlwbGUgZGlmZmVyZW50IGNvcGllcyBvZiB0aGUKLy8gQnVmZmVyTGlzdCBjbGFzcyBhbmQgc29tZSBgQnVmZmVyTGlzdGBzIG1pZ2h0IGJlIGBCdWZmZXJMaXN0YHMuCkJ1ZmZlckxpc3QkMS5wcm90b3R5cGUuX2lzQnVmZmVyTGlzdCA9IGZ1bmN0aW9uIF9pc0J1ZmZlckxpc3QoYikgewogIHJldHVybiBiIGluc3RhbmNlb2YgQnVmZmVyTGlzdCQxIHx8IEJ1ZmZlckxpc3QkMS5pc0J1ZmZlckxpc3QoYik7Cn07CkJ1ZmZlckxpc3QkMS5pc0J1ZmZlckxpc3QgPSBmdW5jdGlvbiBpc0J1ZmZlckxpc3QoYikgewogIHJldHVybiBiICE9IG51bGwgJiYgYltzeW1ib2xdOwp9Owp2YXIgQnVmZmVyTGlzdF8xID0gQnVmZmVyTGlzdCQxOwoKY29uc3QgRHVwbGV4U3RyZWFtID0gb3Vyc0V4cG9ydHMuRHVwbGV4Owpjb25zdCBpbmhlcml0cyA9IGluaGVyaXRzRXhwb3J0czsKY29uc3QgQnVmZmVyTGlzdCA9IEJ1ZmZlckxpc3RfMTsKZnVuY3Rpb24gQnVmZmVyTGlzdFN0cmVhbShjYWxsYmFjaykgewogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBCdWZmZXJMaXN0U3RyZWFtKSkgewogICAgcmV0dXJuIG5ldyBCdWZmZXJMaXN0U3RyZWFtKGNhbGxiYWNrKTsKICB9CiAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgdGhpcy5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIGNvbnN0IHBpcGVyID0gZnVuY3Rpb24gcGlwZXIoZXJyKSB7CiAgICAgIGlmICh0aGlzLl9jYWxsYmFjaykgewogICAgICAgIHRoaXMuX2NhbGxiYWNrKGVycik7CiAgICAgICAgdGhpcy5fY2FsbGJhY2sgPSBudWxsOwogICAgICB9CiAgICB9LmJpbmQodGhpcyk7CiAgICB0aGlzLm9uKCdwaXBlJywgZnVuY3Rpb24gb25QaXBlKHNyYykgewogICAgICBzcmMub24oJ2Vycm9yJywgcGlwZXIpOwogICAgfSk7CiAgICB0aGlzLm9uKCd1bnBpcGUnLCBmdW5jdGlvbiBvblVucGlwZShzcmMpIHsKICAgICAgc3JjLnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIHBpcGVyKTsKICAgIH0pOwogICAgY2FsbGJhY2sgPSBudWxsOwogIH0KICBCdWZmZXJMaXN0Ll9pbml0LmNhbGwodGhpcywgY2FsbGJhY2spOwogIER1cGxleFN0cmVhbS5jYWxsKHRoaXMpOwp9CmluaGVyaXRzKEJ1ZmZlckxpc3RTdHJlYW0sIER1cGxleFN0cmVhbSk7Ck9iamVjdC5hc3NpZ24oQnVmZmVyTGlzdFN0cmVhbS5wcm90b3R5cGUsIEJ1ZmZlckxpc3QucHJvdG90eXBlKTsKQnVmZmVyTGlzdFN0cmVhbS5wcm90b3R5cGUuX25ldyA9IGZ1bmN0aW9uIF9uZXcoY2FsbGJhY2spIHsKICByZXR1cm4gbmV3IEJ1ZmZlckxpc3RTdHJlYW0oY2FsbGJhY2spOwp9OwpCdWZmZXJMaXN0U3RyZWFtLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbiBfd3JpdGUoYnVmLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICB0aGlzLl9hcHBlbmRCdWZmZXIoYnVmKTsKICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYWxsYmFjaygpOwogIH0KfTsKQnVmZmVyTGlzdFN0cmVhbS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbiBfcmVhZChzaXplKSB7CiAgaWYgKCF0aGlzLmxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMucHVzaChudWxsKTsKICB9CiAgc2l6ZSA9IE1hdGgubWluKHNpemUsIHRoaXMubGVuZ3RoKTsKICB0aGlzLnB1c2godGhpcy5zbGljZSgwLCBzaXplKSk7CiAgdGhpcy5jb25zdW1lKHNpemUpOwp9OwpCdWZmZXJMaXN0U3RyZWFtLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiBlbmQoY2h1bmspIHsKICBEdXBsZXhTdHJlYW0ucHJvdG90eXBlLmVuZC5jYWxsKHRoaXMsIGNodW5rKTsKICBpZiAodGhpcy5fY2FsbGJhY2spIHsKICAgIHRoaXMuX2NhbGxiYWNrKG51bGwsIHRoaXMuc2xpY2UoKSk7CiAgICB0aGlzLl9jYWxsYmFjayA9IG51bGw7CiAgfQp9OwpCdWZmZXJMaXN0U3RyZWFtLnByb3RvdHlwZS5fZGVzdHJveSA9IGZ1bmN0aW9uIF9kZXN0cm95KGVyciwgY2IpIHsKICB0aGlzLl9idWZzLmxlbmd0aCA9IDA7CiAgdGhpcy5sZW5ndGggPSAwOwogIGNiKGVycik7Cn07CkJ1ZmZlckxpc3RTdHJlYW0ucHJvdG90eXBlLl9pc0J1ZmZlckxpc3QgPSBmdW5jdGlvbiBfaXNCdWZmZXJMaXN0KGIpIHsKICByZXR1cm4gYiBpbnN0YW5jZW9mIEJ1ZmZlckxpc3RTdHJlYW0gfHwgYiBpbnN0YW5jZW9mIEJ1ZmZlckxpc3QgfHwgQnVmZmVyTGlzdFN0cmVhbS5pc0J1ZmZlckxpc3QoYik7Cn07CkJ1ZmZlckxpc3RTdHJlYW0uaXNCdWZmZXJMaXN0ID0gQnVmZmVyTGlzdC5pc0J1ZmZlckxpc3Q7CmJsJDEuZXhwb3J0cyA9IEJ1ZmZlckxpc3RTdHJlYW07CmJsJDEuZXhwb3J0cy5CdWZmZXJMaXN0U3RyZWFtID0gQnVmZmVyTGlzdFN0cmVhbTsKYmwkMS5leHBvcnRzLkJ1ZmZlckxpc3QgPSBCdWZmZXJMaXN0Owp2YXIgYmxFeHBvcnRzID0gYmwkMS5leHBvcnRzOwoKbGV0IFBhY2tldCQxID0gY2xhc3MgUGFja2V0IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMuY21kID0gbnVsbDsKICAgIHRoaXMucmV0YWluID0gZmFsc2U7CiAgICB0aGlzLnFvcyA9IDA7CiAgICB0aGlzLmR1cCA9IGZhbHNlOwogICAgdGhpcy5sZW5ndGggPSAtMTsKICAgIHRoaXMudG9waWMgPSBudWxsOwogICAgdGhpcy5wYXlsb2FkID0gbnVsbDsKICB9Cn07CnZhciBwYWNrZXQgPSBQYWNrZXQkMTsKCnZhciBjb25zdGFudHMkNSA9IHtleHBvcnRzOiB7fX07CgovKiBQcm90b2NvbCAtIHByb3RvY29sIGNvbnN0YW50cyAqLwooZnVuY3Rpb24gKG1vZHVsZSkgewogIGNvbnN0IHByb3RvY29sID0gbW9kdWxlLmV4cG9ydHM7CiAgY29uc3QgewogICAgQnVmZmVyCiAgfSA9IHJlcXVpcmUkJDAkMzsKCiAgLyogQ29tbWFuZCBjb2RlID0+IG1uZW1vbmljICovCiAgcHJvdG9jb2wudHlwZXMgPSB7CiAgICAwOiAncmVzZXJ2ZWQnLAogICAgMTogJ2Nvbm5lY3QnLAogICAgMjogJ2Nvbm5hY2snLAogICAgMzogJ3B1Ymxpc2gnLAogICAgNDogJ3B1YmFjaycsCiAgICA1OiAncHVicmVjJywKICAgIDY6ICdwdWJyZWwnLAogICAgNzogJ3B1YmNvbXAnLAogICAgODogJ3N1YnNjcmliZScsCiAgICA5OiAnc3ViYWNrJywKICAgIDEwOiAndW5zdWJzY3JpYmUnLAogICAgMTE6ICd1bnN1YmFjaycsCiAgICAxMjogJ3BpbmdyZXEnLAogICAgMTM6ICdwaW5ncmVzcCcsCiAgICAxNDogJ2Rpc2Nvbm5lY3QnLAogICAgMTU6ICdhdXRoJwogIH07CiAgcHJvdG9jb2wucmVxdWlyZWRIZWFkZXJGbGFncyA9IHsKICAgIDE6IDAsCiAgICAvLyAnY29ubmVjdCcKICAgIDI6IDAsCiAgICAvLyAnY29ubmFjaycKICAgIDQ6IDAsCiAgICAvLyAncHViYWNrJwogICAgNTogMCwKICAgIC8vICdwdWJyZWMnCiAgICA2OiAyLAogICAgLy8gJ3B1YnJlbCcKICAgIDc6IDAsCiAgICAvLyAncHViY29tcCcKICAgIDg6IDIsCiAgICAvLyAnc3Vic2NyaWJlJwogICAgOTogMCwKICAgIC8vICdzdWJhY2snCiAgICAxMDogMiwKICAgIC8vICd1bnN1YnNjcmliZScKICAgIDExOiAwLAogICAgLy8gJ3Vuc3ViYWNrJwogICAgMTI6IDAsCiAgICAvLyAncGluZ3JlcScKICAgIDEzOiAwLAogICAgLy8gJ3BpbmdyZXNwJwogICAgMTQ6IDAsCiAgICAvLyAnZGlzY29ubmVjdCcKICAgIDE1OiAwIC8vICdhdXRoJwogIH07CiAgcHJvdG9jb2wucmVxdWlyZWRIZWFkZXJGbGFnc0Vycm9ycyA9IHt9OwogIGZvciAoY29uc3QgayBpbiBwcm90b2NvbC5yZXF1aXJlZEhlYWRlckZsYWdzKSB7CiAgICBjb25zdCB2ID0gcHJvdG9jb2wucmVxdWlyZWRIZWFkZXJGbGFnc1trXTsKICAgIHByb3RvY29sLnJlcXVpcmVkSGVhZGVyRmxhZ3NFcnJvcnNba10gPSAnSW52YWxpZCBoZWFkZXIgZmxhZyBiaXRzLCBtdXN0IGJlIDB4JyArIHYudG9TdHJpbmcoMTYpICsgJyBmb3IgJyArIHByb3RvY29sLnR5cGVzW2tdICsgJyBwYWNrZXQnOwogIH0KCiAgLyogTW5lbW9uaWMgPT4gQ29tbWFuZCBjb2RlICovCiAgcHJvdG9jb2wuY29kZXMgPSB7fTsKICBmb3IgKGNvbnN0IGsgaW4gcHJvdG9jb2wudHlwZXMpIHsKICAgIGNvbnN0IHYgPSBwcm90b2NvbC50eXBlc1trXTsKICAgIHByb3RvY29sLmNvZGVzW3ZdID0gazsKICB9CgogIC8qIEhlYWRlciAqLwogIHByb3RvY29sLkNNRF9TSElGVCA9IDQ7CiAgcHJvdG9jb2wuQ01EX01BU0sgPSAweEYwOwogIHByb3RvY29sLkRVUF9NQVNLID0gMHgwODsKICBwcm90b2NvbC5RT1NfTUFTSyA9IDB4MDM7CiAgcHJvdG9jb2wuUU9TX1NISUZUID0gMTsKICBwcm90b2NvbC5SRVRBSU5fTUFTSyA9IDB4MDE7CgogIC8qIExlbmd0aCAqLwogIHByb3RvY29sLlZBUkJZVEVJTlRfTUFTSyA9IDB4N0Y7CiAgcHJvdG9jb2wuVkFSQllURUlOVF9GSU5fTUFTSyA9IDB4ODA7CiAgcHJvdG9jb2wuVkFSQllURUlOVF9NQVggPSAyNjg0MzU0NTU7CgogIC8qIENvbm5hY2sgKi8KICBwcm90b2NvbC5TRVNTSU9OUFJFU0VOVF9NQVNLID0gMHgwMTsKICBwcm90b2NvbC5TRVNTSU9OUFJFU0VOVF9IRUFERVIgPSBCdWZmZXIuZnJvbShbcHJvdG9jb2wuU0VTU0lPTlBSRVNFTlRfTUFTS10pOwogIHByb3RvY29sLkNPTk5BQ0tfSEVBREVSID0gQnVmZmVyLmZyb20oW3Byb3RvY29sLmNvZGVzLmNvbm5hY2sgPDwgcHJvdG9jb2wuQ01EX1NISUZUXSk7CgogIC8qIENvbm5lY3QgKi8KICBwcm90b2NvbC5VU0VSTkFNRV9NQVNLID0gMHg4MDsKICBwcm90b2NvbC5QQVNTV09SRF9NQVNLID0gMHg0MDsKICBwcm90b2NvbC5XSUxMX1JFVEFJTl9NQVNLID0gMHgyMDsKICBwcm90b2NvbC5XSUxMX1FPU19NQVNLID0gMHgxODsKICBwcm90b2NvbC5XSUxMX1FPU19TSElGVCA9IDM7CiAgcHJvdG9jb2wuV0lMTF9GTEFHX01BU0sgPSAweDA0OwogIHByb3RvY29sLkNMRUFOX1NFU1NJT05fTUFTSyA9IDB4MDI7CiAgcHJvdG9jb2wuQ09OTkVDVF9IRUFERVIgPSBCdWZmZXIuZnJvbShbcHJvdG9jb2wuY29kZXMuY29ubmVjdCA8PCBwcm90b2NvbC5DTURfU0hJRlRdKTsKCiAgLyogUHJvcGVydGllcyAqLwogIHByb3RvY29sLnByb3BlcnRpZXMgPSB7CiAgICBzZXNzaW9uRXhwaXJ5SW50ZXJ2YWw6IDE3LAogICAgd2lsbERlbGF5SW50ZXJ2YWw6IDI0LAogICAgcmVjZWl2ZU1heGltdW06IDMzLAogICAgbWF4aW11bVBhY2tldFNpemU6IDM5LAogICAgdG9waWNBbGlhc01heGltdW06IDM0LAogICAgcmVxdWVzdFJlc3BvbnNlSW5mb3JtYXRpb246IDI1LAogICAgcmVxdWVzdFByb2JsZW1JbmZvcm1hdGlvbjogMjMsCiAgICB1c2VyUHJvcGVydGllczogMzgsCiAgICBhdXRoZW50aWNhdGlvbk1ldGhvZDogMjEsCiAgICBhdXRoZW50aWNhdGlvbkRhdGE6IDIyLAogICAgcGF5bG9hZEZvcm1hdEluZGljYXRvcjogMSwKICAgIG1lc3NhZ2VFeHBpcnlJbnRlcnZhbDogMiwKICAgIGNvbnRlbnRUeXBlOiAzLAogICAgcmVzcG9uc2VUb3BpYzogOCwKICAgIGNvcnJlbGF0aW9uRGF0YTogOSwKICAgIG1heGltdW1Rb1M6IDM2LAogICAgcmV0YWluQXZhaWxhYmxlOiAzNywKICAgIGFzc2lnbmVkQ2xpZW50SWRlbnRpZmllcjogMTgsCiAgICByZWFzb25TdHJpbmc6IDMxLAogICAgd2lsZGNhcmRTdWJzY3JpcHRpb25BdmFpbGFibGU6IDQwLAogICAgc3Vic2NyaXB0aW9uSWRlbnRpZmllcnNBdmFpbGFibGU6IDQxLAogICAgc2hhcmVkU3Vic2NyaXB0aW9uQXZhaWxhYmxlOiA0MiwKICAgIHNlcnZlcktlZXBBbGl2ZTogMTksCiAgICByZXNwb25zZUluZm9ybWF0aW9uOiAyNiwKICAgIHNlcnZlclJlZmVyZW5jZTogMjgsCiAgICB0b3BpY0FsaWFzOiAzNSwKICAgIHN1YnNjcmlwdGlvbklkZW50aWZpZXI6IDExCiAgfTsKICBwcm90b2NvbC5wcm9wZXJ0aWVzQ29kZXMgPSB7fTsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvdG9jb2wucHJvcGVydGllcykgewogICAgY29uc3QgaWQgPSBwcm90b2NvbC5wcm9wZXJ0aWVzW3Byb3BdOwogICAgcHJvdG9jb2wucHJvcGVydGllc0NvZGVzW2lkXSA9IHByb3A7CiAgfQogIHByb3RvY29sLnByb3BlcnRpZXNUeXBlcyA9IHsKICAgIHNlc3Npb25FeHBpcnlJbnRlcnZhbDogJ2ludDMyJywKICAgIHdpbGxEZWxheUludGVydmFsOiAnaW50MzInLAogICAgcmVjZWl2ZU1heGltdW06ICdpbnQxNicsCiAgICBtYXhpbXVtUGFja2V0U2l6ZTogJ2ludDMyJywKICAgIHRvcGljQWxpYXNNYXhpbXVtOiAnaW50MTYnLAogICAgcmVxdWVzdFJlc3BvbnNlSW5mb3JtYXRpb246ICdieXRlJywKICAgIHJlcXVlc3RQcm9ibGVtSW5mb3JtYXRpb246ICdieXRlJywKICAgIHVzZXJQcm9wZXJ0aWVzOiAncGFpcicsCiAgICBhdXRoZW50aWNhdGlvbk1ldGhvZDogJ3N0cmluZycsCiAgICBhdXRoZW50aWNhdGlvbkRhdGE6ICdiaW5hcnknLAogICAgcGF5bG9hZEZvcm1hdEluZGljYXRvcjogJ2J5dGUnLAogICAgbWVzc2FnZUV4cGlyeUludGVydmFsOiAnaW50MzInLAogICAgY29udGVudFR5cGU6ICdzdHJpbmcnLAogICAgcmVzcG9uc2VUb3BpYzogJ3N0cmluZycsCiAgICBjb3JyZWxhdGlvbkRhdGE6ICdiaW5hcnknLAogICAgbWF4aW11bVFvUzogJ2ludDgnLAogICAgcmV0YWluQXZhaWxhYmxlOiAnYnl0ZScsCiAgICBhc3NpZ25lZENsaWVudElkZW50aWZpZXI6ICdzdHJpbmcnLAogICAgcmVhc29uU3RyaW5nOiAnc3RyaW5nJywKICAgIHdpbGRjYXJkU3Vic2NyaXB0aW9uQXZhaWxhYmxlOiAnYnl0ZScsCiAgICBzdWJzY3JpcHRpb25JZGVudGlmaWVyc0F2YWlsYWJsZTogJ2J5dGUnLAogICAgc2hhcmVkU3Vic2NyaXB0aW9uQXZhaWxhYmxlOiAnYnl0ZScsCiAgICBzZXJ2ZXJLZWVwQWxpdmU6ICdpbnQxNicsCiAgICByZXNwb25zZUluZm9ybWF0aW9uOiAnc3RyaW5nJywKICAgIHNlcnZlclJlZmVyZW5jZTogJ3N0cmluZycsCiAgICB0b3BpY0FsaWFzOiAnaW50MTYnLAogICAgc3Vic2NyaXB0aW9uSWRlbnRpZmllcjogJ3ZhcicKICB9OwogIGZ1bmN0aW9uIGdlbkhlYWRlcih0eXBlKSB7CiAgICByZXR1cm4gWzAsIDEsIDJdLm1hcChxb3MgPT4gewogICAgICByZXR1cm4gWzAsIDFdLm1hcChkdXAgPT4gewogICAgICAgIHJldHVybiBbMCwgMV0ubWFwKHJldGFpbiA9PiB7CiAgICAgICAgICBjb25zdCBidWYgPSBCdWZmZXIuYWxsb2MoMSk7CiAgICAgICAgICBidWYud3JpdGVVSW50OChwcm90b2NvbC5jb2Rlc1t0eXBlXSA8PCBwcm90b2NvbC5DTURfU0hJRlQgfCAoZHVwID8gcHJvdG9jb2wuRFVQX01BU0sgOiAwKSB8IHFvcyA8PCBwcm90b2NvbC5RT1NfU0hJRlQgfCByZXRhaW4sIDAsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8qIFB1Ymxpc2ggKi8KICBwcm90b2NvbC5QVUJMSVNIX0hFQURFUiA9IGdlbkhlYWRlcigncHVibGlzaCcpOwoKICAvKiBTdWJzY3JpYmUgKi8KICBwcm90b2NvbC5TVUJTQ1JJQkVfSEVBREVSID0gZ2VuSGVhZGVyKCdzdWJzY3JpYmUnKTsKICBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19RT1NfTUFTSyA9IDB4MDM7CiAgcHJvdG9jb2wuU1VCU0NSSUJFX09QVElPTlNfTkxfTUFTSyA9IDB4MDE7CiAgcHJvdG9jb2wuU1VCU0NSSUJFX09QVElPTlNfTkxfU0hJRlQgPSAyOwogIHByb3RvY29sLlNVQlNDUklCRV9PUFRJT05TX1JBUF9NQVNLID0gMHgwMTsKICBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19SQVBfU0hJRlQgPSAzOwogIHByb3RvY29sLlNVQlNDUklCRV9PUFRJT05TX1JIX01BU0sgPSAweDAzOwogIHByb3RvY29sLlNVQlNDUklCRV9PUFRJT05TX1JIX1NISUZUID0gNDsKICBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19SSCA9IFsweDAwLCAweDEwLCAweDIwXTsKICBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19OTCA9IDB4MDQ7CiAgcHJvdG9jb2wuU1VCU0NSSUJFX09QVElPTlNfUkFQID0gMHgwODsKICBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19RT1MgPSBbMHgwMCwgMHgwMSwgMHgwMl07CgogIC8qIFVuc3Vic2NyaWJlICovCiAgcHJvdG9jb2wuVU5TVUJTQ1JJQkVfSEVBREVSID0gZ2VuSGVhZGVyKCd1bnN1YnNjcmliZScpOwoKICAvKiBDb25maXJtYXRpb25zICovCiAgcHJvdG9jb2wuQUNLUyA9IHsKICAgIHVuc3ViYWNrOiBnZW5IZWFkZXIoJ3Vuc3ViYWNrJyksCiAgICBwdWJhY2s6IGdlbkhlYWRlcigncHViYWNrJyksCiAgICBwdWJjb21wOiBnZW5IZWFkZXIoJ3B1YmNvbXAnKSwKICAgIHB1YnJlbDogZ2VuSGVhZGVyKCdwdWJyZWwnKSwKICAgIHB1YnJlYzogZ2VuSGVhZGVyKCdwdWJyZWMnKQogIH07CiAgcHJvdG9jb2wuU1VCQUNLX0hFQURFUiA9IEJ1ZmZlci5mcm9tKFtwcm90b2NvbC5jb2Rlcy5zdWJhY2sgPDwgcHJvdG9jb2wuQ01EX1NISUZUXSk7CgogIC8qIFByb3RvY29sIHZlcnNpb25zICovCiAgcHJvdG9jb2wuVkVSU0lPTjMgPSBCdWZmZXIuZnJvbShbM10pOwogIHByb3RvY29sLlZFUlNJT040ID0gQnVmZmVyLmZyb20oWzRdKTsKICBwcm90b2NvbC5WRVJTSU9ONSA9IEJ1ZmZlci5mcm9tKFs1XSk7CiAgcHJvdG9jb2wuVkVSU0lPTjEzMSA9IEJ1ZmZlci5mcm9tKFsxMzFdKTsKICBwcm90b2NvbC5WRVJTSU9OMTMyID0gQnVmZmVyLmZyb20oWzEzMl0pOwoKICAvKiBRb1MgKi8KICBwcm90b2NvbC5RT1MgPSBbMCwgMSwgMl0ubWFwKHFvcyA9PiB7CiAgICByZXR1cm4gQnVmZmVyLmZyb20oW3Fvc10pOwogIH0pOwoKICAvKiBFbXB0eSBwYWNrZXRzICovCiAgcHJvdG9jb2wuRU1QVFkgPSB7CiAgICBwaW5ncmVxOiBCdWZmZXIuZnJvbShbcHJvdG9jb2wuY29kZXMucGluZ3JlcSA8PCA0LCAwXSksCiAgICBwaW5ncmVzcDogQnVmZmVyLmZyb20oW3Byb3RvY29sLmNvZGVzLnBpbmdyZXNwIDw8IDQsIDBdKSwKICAgIGRpc2Nvbm5lY3Q6IEJ1ZmZlci5mcm9tKFtwcm90b2NvbC5jb2Rlcy5kaXNjb25uZWN0IDw8IDQsIDBdKQogIH07CiAgcHJvdG9jb2wuTVFUVDVfUFVCQUNLX1BVQlJFQ19DT0RFUyA9IHsKICAgIDB4MDA6ICdTdWNjZXNzJywKICAgIDB4MTA6ICdObyBtYXRjaGluZyBzdWJzY3JpYmVycycsCiAgICAweDgwOiAnVW5zcGVjaWZpZWQgZXJyb3InLAogICAgMHg4MzogJ0ltcGxlbWVudGF0aW9uIHNwZWNpZmljIGVycm9yJywKICAgIDB4ODc6ICdOb3QgYXV0aG9yaXplZCcsCiAgICAweDkwOiAnVG9waWMgTmFtZSBpbnZhbGlkJywKICAgIDB4OTE6ICdQYWNrZXQgaWRlbnRpZmllciBpbiB1c2UnLAogICAgMHg5NzogJ1F1b3RhIGV4Y2VlZGVkJywKICAgIDB4OTk6ICdQYXlsb2FkIGZvcm1hdCBpbnZhbGlkJwogIH07CiAgcHJvdG9jb2wuTVFUVDVfUFVCUkVMX1BVQkNPTVBfQ09ERVMgPSB7CiAgICAweDAwOiAnU3VjY2VzcycsCiAgICAweDkyOiAnUGFja2V0IElkZW50aWZpZXIgbm90IGZvdW5kJwogIH07CiAgcHJvdG9jb2wuTVFUVDVfU1VCQUNLX0NPREVTID0gewogICAgMHgwMDogJ0dyYW50ZWQgUW9TIDAnLAogICAgMHgwMTogJ0dyYW50ZWQgUW9TIDEnLAogICAgMHgwMjogJ0dyYW50ZWQgUW9TIDInLAogICAgMHg4MDogJ1Vuc3BlY2lmaWVkIGVycm9yJywKICAgIDB4ODM6ICdJbXBsZW1lbnRhdGlvbiBzcGVjaWZpYyBlcnJvcicsCiAgICAweDg3OiAnTm90IGF1dGhvcml6ZWQnLAogICAgMHg4RjogJ1RvcGljIEZpbHRlciBpbnZhbGlkJywKICAgIDB4OTE6ICdQYWNrZXQgSWRlbnRpZmllciBpbiB1c2UnLAogICAgMHg5NzogJ1F1b3RhIGV4Y2VlZGVkJywKICAgIDB4OUU6ICdTaGFyZWQgU3Vic2NyaXB0aW9ucyBub3Qgc3VwcG9ydGVkJywKICAgIDB4QTE6ICdTdWJzY3JpcHRpb24gSWRlbnRpZmllcnMgbm90IHN1cHBvcnRlZCcsCiAgICAweEEyOiAnV2lsZGNhcmQgU3Vic2NyaXB0aW9ucyBub3Qgc3VwcG9ydGVkJwogIH07CiAgcHJvdG9jb2wuTVFUVDVfVU5TVUJBQ0tfQ09ERVMgPSB7CiAgICAweDAwOiAnU3VjY2VzcycsCiAgICAweDExOiAnTm8gc3Vic2NyaXB0aW9uIGV4aXN0ZWQnLAogICAgMHg4MDogJ1Vuc3BlY2lmaWVkIGVycm9yJywKICAgIDB4ODM6ICdJbXBsZW1lbnRhdGlvbiBzcGVjaWZpYyBlcnJvcicsCiAgICAweDg3OiAnTm90IGF1dGhvcml6ZWQnLAogICAgMHg4RjogJ1RvcGljIEZpbHRlciBpbnZhbGlkJywKICAgIDB4OTE6ICdQYWNrZXQgSWRlbnRpZmllciBpbiB1c2UnCiAgfTsKICBwcm90b2NvbC5NUVRUNV9ESVNDT05ORUNUX0NPREVTID0gewogICAgMHgwMDogJ05vcm1hbCBkaXNjb25uZWN0aW9uJywKICAgIDB4MDQ6ICdEaXNjb25uZWN0IHdpdGggV2lsbCBNZXNzYWdlJywKICAgIDB4ODA6ICdVbnNwZWNpZmllZCBlcnJvcicsCiAgICAweDgxOiAnTWFsZm9ybWVkIFBhY2tldCcsCiAgICAweDgyOiAnUHJvdG9jb2wgRXJyb3InLAogICAgMHg4MzogJ0ltcGxlbWVudGF0aW9uIHNwZWNpZmljIGVycm9yJywKICAgIDB4ODc6ICdOb3QgYXV0aG9yaXplZCcsCiAgICAweDg5OiAnU2VydmVyIGJ1c3knLAogICAgMHg4QjogJ1NlcnZlciBzaHV0dGluZyBkb3duJywKICAgIDB4OEQ6ICdLZWVwIEFsaXZlIHRpbWVvdXQnLAogICAgMHg4RTogJ1Nlc3Npb24gdGFrZW4gb3ZlcicsCiAgICAweDhGOiAnVG9waWMgRmlsdGVyIGludmFsaWQnLAogICAgMHg5MDogJ1RvcGljIE5hbWUgaW52YWxpZCcsCiAgICAweDkzOiAnUmVjZWl2ZSBNYXhpbXVtIGV4Y2VlZGVkJywKICAgIDB4OTQ6ICdUb3BpYyBBbGlhcyBpbnZhbGlkJywKICAgIDB4OTU6ICdQYWNrZXQgdG9vIGxhcmdlJywKICAgIDB4OTY6ICdNZXNzYWdlIHJhdGUgdG9vIGhpZ2gnLAogICAgMHg5NzogJ1F1b3RhIGV4Y2VlZGVkJywKICAgIDB4OTg6ICdBZG1pbmlzdHJhdGl2ZSBhY3Rpb24nLAogICAgMHg5OTogJ1BheWxvYWQgZm9ybWF0IGludmFsaWQnLAogICAgMHg5QTogJ1JldGFpbiBub3Qgc3VwcG9ydGVkJywKICAgIDB4OUI6ICdRb1Mgbm90IHN1cHBvcnRlZCcsCiAgICAweDlDOiAnVXNlIGFub3RoZXIgc2VydmVyJywKICAgIDB4OUQ6ICdTZXJ2ZXIgbW92ZWQnLAogICAgMHg5RTogJ1NoYXJlZCBTdWJzY3JpcHRpb25zIG5vdCBzdXBwb3J0ZWQnLAogICAgMHg5RjogJ0Nvbm5lY3Rpb24gcmF0ZSBleGNlZWRlZCcsCiAgICAweEEwOiAnTWF4aW11bSBjb25uZWN0IHRpbWUnLAogICAgMHhBMTogJ1N1YnNjcmlwdGlvbiBJZGVudGlmaWVycyBub3Qgc3VwcG9ydGVkJywKICAgIDB4QTI6ICdXaWxkY2FyZCBTdWJzY3JpcHRpb25zIG5vdCBzdXBwb3J0ZWQnCiAgfTsKICBwcm90b2NvbC5NUVRUNV9BVVRIX0NPREVTID0gewogICAgMHgwMDogJ1N1Y2Nlc3MnLAogICAgMHgxODogJ0NvbnRpbnVlIGF1dGhlbnRpY2F0aW9uJywKICAgIDB4MTk6ICdSZS1hdXRoZW50aWNhdGUnCiAgfTsKfSkoY29uc3RhbnRzJDUpOwp2YXIgY29uc3RhbnRzRXhwb3J0cyA9IGNvbnN0YW50cyQ1LmV4cG9ydHM7Cgp2YXIgc3JjID0ge2V4cG9ydHM6IHt9fTsKCnZhciBicm93c2VyJDEgPSB7ZXhwb3J0czoge319OwoKLyoqCiAqIEhlbHBlcnMuCiAqLwp2YXIgbXM7CnZhciBoYXNSZXF1aXJlZE1zOwpmdW5jdGlvbiByZXF1aXJlTXMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkTXMpIHJldHVybiBtczsKICBoYXNSZXF1aXJlZE1zID0gMTsKICB2YXIgcyA9IDEwMDA7CiAgdmFyIG0gPSBzICogNjA7CiAgdmFyIGggPSBtICogNjA7CiAgdmFyIGQgPSBoICogMjQ7CiAgdmFyIHcgPSBkICogNzsKICB2YXIgeSA9IGQgKiAzNjUuMjU7CgogIC8qKgogICAqIFBhcnNlIG9yIGZvcm1hdCB0aGUgZ2l2ZW4gYHZhbGAuCiAgICoKICAgKiBPcHRpb25zOgogICAqCiAgICogIC0gYGxvbmdgIHZlcmJvc2UgZm9ybWF0dGluZyBbZmFsc2VdCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IHZhbAogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10KICAgKiBAdGhyb3dzIHtFcnJvcn0gdGhyb3cgYW4gZXJyb3IgaWYgdmFsIGlzIG5vdCBhIG5vbi1lbXB0eSBzdHJpbmcgb3IgYSBudW1iZXIKICAgKiBAcmV0dXJuIHtTdHJpbmd8TnVtYmVyfQogICAqIEBhcGkgcHVibGljCiAgICovCgogIG1zID0gZnVuY3Rpb24gKHZhbCwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWw7CiAgICBpZiAodHlwZSA9PT0gJ3N0cmluZycgJiYgdmFsLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuIHBhcnNlKHZhbCk7CiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdudW1iZXInICYmIGlzRmluaXRlKHZhbCkpIHsKICAgICAgcmV0dXJuIG9wdGlvbnMubG9uZyA/IGZtdExvbmcodmFsKSA6IGZtdFNob3J0KHZhbCk7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZhbCBpcyBub3QgYSBub24tZW1wdHkgc3RyaW5nIG9yIGEgdmFsaWQgbnVtYmVyLiB2YWw9JyArIEpTT04uc3RyaW5naWZ5KHZhbCkpOwogIH07CgogIC8qKgogICAqIFBhcnNlIHRoZSBnaXZlbiBgc3RyYCBhbmQgcmV0dXJuIG1pbGxpc2Vjb25kcy4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIKICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIHBhcnNlKHN0cikgewogICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICBpZiAoc3RyLmxlbmd0aCA+IDEwMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgbWF0Y2ggPSAvXigtPyg/OlxkKyk/XC4/XGQrKSAqKG1pbGxpc2Vjb25kcz98bXNlY3M/fG1zfHNlY29uZHM/fHNlY3M/fHN8bWludXRlcz98bWlucz98bXxob3Vycz98aHJzP3xofGRheXM/fGR8d2Vla3M/fHd8eWVhcnM/fHlycz98eSk/JC9pLmV4ZWMoc3RyKTsKICAgIGlmICghbWF0Y2gpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIG4gPSBwYXJzZUZsb2F0KG1hdGNoWzFdKTsKICAgIHZhciB0eXBlID0gKG1hdGNoWzJdIHx8ICdtcycpLnRvTG93ZXJDYXNlKCk7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAneWVhcnMnOgogICAgICBjYXNlICd5ZWFyJzoKICAgICAgY2FzZSAneXJzJzoKICAgICAgY2FzZSAneXInOgogICAgICBjYXNlICd5JzoKICAgICAgICByZXR1cm4gbiAqIHk7CiAgICAgIGNhc2UgJ3dlZWtzJzoKICAgICAgY2FzZSAnd2Vlayc6CiAgICAgIGNhc2UgJ3cnOgogICAgICAgIHJldHVybiBuICogdzsKICAgICAgY2FzZSAnZGF5cyc6CiAgICAgIGNhc2UgJ2RheSc6CiAgICAgIGNhc2UgJ2QnOgogICAgICAgIHJldHVybiBuICogZDsKICAgICAgY2FzZSAnaG91cnMnOgogICAgICBjYXNlICdob3VyJzoKICAgICAgY2FzZSAnaHJzJzoKICAgICAgY2FzZSAnaHInOgogICAgICBjYXNlICdoJzoKICAgICAgICByZXR1cm4gbiAqIGg7CiAgICAgIGNhc2UgJ21pbnV0ZXMnOgogICAgICBjYXNlICdtaW51dGUnOgogICAgICBjYXNlICdtaW5zJzoKICAgICAgY2FzZSAnbWluJzoKICAgICAgY2FzZSAnbSc6CiAgICAgICAgcmV0dXJuIG4gKiBtOwogICAgICBjYXNlICdzZWNvbmRzJzoKICAgICAgY2FzZSAnc2Vjb25kJzoKICAgICAgY2FzZSAnc2Vjcyc6CiAgICAgIGNhc2UgJ3NlYyc6CiAgICAgIGNhc2UgJ3MnOgogICAgICAgIHJldHVybiBuICogczsKICAgICAgY2FzZSAnbWlsbGlzZWNvbmRzJzoKICAgICAgY2FzZSAnbWlsbGlzZWNvbmQnOgogICAgICBjYXNlICdtc2Vjcyc6CiAgICAgIGNhc2UgJ21zZWMnOgogICAgICBjYXNlICdtcyc6CiAgICAgICAgcmV0dXJuIG47CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICB9CgogIC8qKgogICAqIFNob3J0IGZvcm1hdCBmb3IgYG1zYC4KICAgKgogICAqIEBwYXJhbSB7TnVtYmVyfSBtcwogICAqIEByZXR1cm4ge1N0cmluZ30KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgZnVuY3Rpb24gZm10U2hvcnQobXMpIHsKICAgIHZhciBtc0FicyA9IE1hdGguYWJzKG1zKTsKICAgIGlmIChtc0FicyA+PSBkKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gZCkgKyAnZCc7CiAgICB9CiAgICBpZiAobXNBYnMgPj0gaCkgewogICAgICByZXR1cm4gTWF0aC5yb3VuZChtcyAvIGgpICsgJ2gnOwogICAgfQogICAgaWYgKG1zQWJzID49IG0pIHsKICAgICAgcmV0dXJuIE1hdGgucm91bmQobXMgLyBtKSArICdtJzsKICAgIH0KICAgIGlmIChtc0FicyA+PSBzKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gcykgKyAncyc7CiAgICB9CiAgICByZXR1cm4gbXMgKyAnbXMnOwogIH0KCiAgLyoqCiAgICogTG9uZyBmb3JtYXQgZm9yIGBtc2AuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gbXMKICAgKiBAcmV0dXJuIHtTdHJpbmd9CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIGZtdExvbmcobXMpIHsKICAgIHZhciBtc0FicyA9IE1hdGguYWJzKG1zKTsKICAgIGlmIChtc0FicyA+PSBkKSB7CiAgICAgIHJldHVybiBwbHVyYWwobXMsIG1zQWJzLCBkLCAnZGF5Jyk7CiAgICB9CiAgICBpZiAobXNBYnMgPj0gaCkgewogICAgICByZXR1cm4gcGx1cmFsKG1zLCBtc0FicywgaCwgJ2hvdXInKTsKICAgIH0KICAgIGlmIChtc0FicyA+PSBtKSB7CiAgICAgIHJldHVybiBwbHVyYWwobXMsIG1zQWJzLCBtLCAnbWludXRlJyk7CiAgICB9CiAgICBpZiAobXNBYnMgPj0gcykgewogICAgICByZXR1cm4gcGx1cmFsKG1zLCBtc0FicywgcywgJ3NlY29uZCcpOwogICAgfQogICAgcmV0dXJuIG1zICsgJyBtcyc7CiAgfQoKICAvKioKICAgKiBQbHVyYWxpemF0aW9uIGhlbHBlci4KICAgKi8KCiAgZnVuY3Rpb24gcGx1cmFsKG1zLCBtc0FicywgbiwgbmFtZSkgewogICAgdmFyIGlzUGx1cmFsID0gbXNBYnMgPj0gbiAqIDEuNTsKICAgIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gbikgKyAnICcgKyBuYW1lICsgKGlzUGx1cmFsID8gJ3MnIDogJycpOwogIH0KICByZXR1cm4gbXM7Cn0KCnZhciBjb21tb24kMTsKdmFyIGhhc1JlcXVpcmVkQ29tbW9uJDE7CmZ1bmN0aW9uIHJlcXVpcmVDb21tb24kMSgpIHsKICBpZiAoaGFzUmVxdWlyZWRDb21tb24kMSkgcmV0dXJuIGNvbW1vbiQxOwogIGhhc1JlcXVpcmVkQ29tbW9uJDEgPSAxOwogIC8qKgogICAqIFRoaXMgaXMgdGhlIGNvbW1vbiBsb2dpYyBmb3IgYm90aCB0aGUgTm9kZS5qcyBhbmQgd2ViIGJyb3dzZXIKICAgKiBpbXBsZW1lbnRhdGlvbnMgb2YgYGRlYnVnKClgLgogICAqLwoKICBmdW5jdGlvbiBzZXR1cChlbnYpIHsKICAgIGNyZWF0ZURlYnVnLmRlYnVnID0gY3JlYXRlRGVidWc7CiAgICBjcmVhdGVEZWJ1Zy5kZWZhdWx0ID0gY3JlYXRlRGVidWc7CiAgICBjcmVhdGVEZWJ1Zy5jb2VyY2UgPSBjb2VyY2U7CiAgICBjcmVhdGVEZWJ1Zy5kaXNhYmxlID0gZGlzYWJsZTsKICAgIGNyZWF0ZURlYnVnLmVuYWJsZSA9IGVuYWJsZTsKICAgIGNyZWF0ZURlYnVnLmVuYWJsZWQgPSBlbmFibGVkOwogICAgY3JlYXRlRGVidWcuaHVtYW5pemUgPSByZXF1aXJlTXMoKTsKICAgIGNyZWF0ZURlYnVnLmRlc3Ryb3kgPSBkZXN0cm95OwogICAgT2JqZWN0LmtleXMoZW52KS5mb3JFYWNoKGtleSA9PiB7CiAgICAgIGNyZWF0ZURlYnVnW2tleV0gPSBlbnZba2V5XTsKICAgIH0pOwoKICAgIC8qKgogICAgKiBUaGUgY3VycmVudGx5IGFjdGl2ZSBkZWJ1ZyBtb2RlIG5hbWVzLCBhbmQgbmFtZXMgdG8gc2tpcC4KICAgICovCgogICAgY3JlYXRlRGVidWcubmFtZXMgPSBbXTsKICAgIGNyZWF0ZURlYnVnLnNraXBzID0gW107CgogICAgLyoqCiAgICAqIE1hcCBvZiBzcGVjaWFsICIlbiIgaGFuZGxpbmcgZnVuY3Rpb25zLCBmb3IgdGhlIGRlYnVnICJmb3JtYXQiIGFyZ3VtZW50LgogICAgKgogICAgKiBWYWxpZCBrZXkgbmFtZXMgYXJlIGEgc2luZ2xlLCBsb3dlciBvciB1cHBlci1jYXNlIGxldHRlciwgaS5lLiAibiIgYW5kICJOIi4KICAgICovCiAgICBjcmVhdGVEZWJ1Zy5mb3JtYXR0ZXJzID0ge307CgogICAgLyoqCiAgICAqIFNlbGVjdHMgYSBjb2xvciBmb3IgYSBkZWJ1ZyBuYW1lc3BhY2UKICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZSBUaGUgbmFtZXNwYWNlIHN0cmluZyBmb3IgdGhlIGRlYnVnIGluc3RhbmNlIHRvIGJlIGNvbG9yZWQKICAgICogQHJldHVybiB7TnVtYmVyfFN0cmluZ30gQW4gQU5TSSBjb2xvciBjb2RlIGZvciB0aGUgZ2l2ZW4gbmFtZXNwYWNlCiAgICAqIEBhcGkgcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIHNlbGVjdENvbG9yKG5hbWVzcGFjZSkgewogICAgICBsZXQgaGFzaCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXNwYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIG5hbWVzcGFjZS5jaGFyQ29kZUF0KGkpOwogICAgICAgIGhhc2ggfD0gMDsgLy8gQ29udmVydCB0byAzMmJpdCBpbnRlZ2VyCiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZURlYnVnLmNvbG9yc1tNYXRoLmFicyhoYXNoKSAlIGNyZWF0ZURlYnVnLmNvbG9ycy5sZW5ndGhdOwogICAgfQogICAgY3JlYXRlRGVidWcuc2VsZWN0Q29sb3IgPSBzZWxlY3RDb2xvcjsKCiAgICAvKioKICAgICogQ3JlYXRlIGEgZGVidWdnZXIgd2l0aCB0aGUgZ2l2ZW4gYG5hbWVzcGFjZWAuCiAgICAqCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UKICAgICogQHJldHVybiB7RnVuY3Rpb259CiAgICAqIEBhcGkgcHVibGljCiAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlRGVidWcobmFtZXNwYWNlKSB7CiAgICAgIGxldCBwcmV2VGltZTsKICAgICAgbGV0IGVuYWJsZU92ZXJyaWRlID0gbnVsbDsKICAgICAgbGV0IG5hbWVzcGFjZXNDYWNoZTsKICAgICAgbGV0IGVuYWJsZWRDYWNoZTsKICAgICAgZnVuY3Rpb24gZGVidWcoLi4uYXJncykgewogICAgICAgIC8vIERpc2FibGVkPwogICAgICAgIGlmICghZGVidWcuZW5hYmxlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBzZWxmID0gZGVidWc7CgogICAgICAgIC8vIFNldCBgZGlmZmAgdGltZXN0YW1wCiAgICAgICAgY29uc3QgY3VyciA9IE51bWJlcihuZXcgRGF0ZSgpKTsKICAgICAgICBjb25zdCBtcyA9IGN1cnIgLSAocHJldlRpbWUgfHwgY3Vycik7CiAgICAgICAgc2VsZi5kaWZmID0gbXM7CiAgICAgICAgc2VsZi5wcmV2ID0gcHJldlRpbWU7CiAgICAgICAgc2VsZi5jdXJyID0gY3VycjsKICAgICAgICBwcmV2VGltZSA9IGN1cnI7CiAgICAgICAgYXJnc1swXSA9IGNyZWF0ZURlYnVnLmNvZXJjZShhcmdzWzBdKTsKICAgICAgICBpZiAodHlwZW9mIGFyZ3NbMF0gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAvLyBBbnl0aGluZyBlbHNlIGxldCdzIGluc3BlY3Qgd2l0aCAlTwogICAgICAgICAgYXJncy51bnNoaWZ0KCclTycpOwogICAgICAgIH0KCiAgICAgICAgLy8gQXBwbHkgYW55IGBmb3JtYXR0ZXJzYCB0cmFuc2Zvcm1hdGlvbnMKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGFyZ3NbMF0gPSBhcmdzWzBdLnJlcGxhY2UoLyUoW2EtekEtWiVdKS9nLCAobWF0Y2gsIGZvcm1hdCkgPT4gewogICAgICAgICAgLy8gSWYgd2UgZW5jb3VudGVyIGFuIGVzY2FwZWQgJSB0aGVuIGRvbid0IGluY3JlYXNlIHRoZSBhcnJheSBpbmRleAogICAgICAgICAgaWYgKG1hdGNoID09PSAnJSUnKSB7CiAgICAgICAgICAgIHJldHVybiAnJSc7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgY29uc3QgZm9ybWF0dGVyID0gY3JlYXRlRGVidWcuZm9ybWF0dGVyc1tmb3JtYXRdOwogICAgICAgICAgaWYgKHR5cGVvZiBmb3JtYXR0ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc3QgdmFsID0gYXJnc1tpbmRleF07CiAgICAgICAgICAgIG1hdGNoID0gZm9ybWF0dGVyLmNhbGwoc2VsZiwgdmFsKTsKCiAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIHJlbW92ZSBgYXJnc1tpbmRleF1gIHNpbmNlIGl0J3MgaW5saW5lZCBpbiB0aGUgYGZvcm1hdGAKICAgICAgICAgICAgYXJncy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgIH0pOwoKICAgICAgICAvLyBBcHBseSBlbnYtc3BlY2lmaWMgZm9ybWF0dGluZyAoY29sb3JzLCBldGMuKQogICAgICAgIGNyZWF0ZURlYnVnLmZvcm1hdEFyZ3MuY2FsbChzZWxmLCBhcmdzKTsKICAgICAgICBjb25zdCBsb2dGbiA9IHNlbGYubG9nIHx8IGNyZWF0ZURlYnVnLmxvZzsKICAgICAgICBsb2dGbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgfQogICAgICBkZWJ1Zy5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7CiAgICAgIGRlYnVnLnVzZUNvbG9ycyA9IGNyZWF0ZURlYnVnLnVzZUNvbG9ycygpOwogICAgICBkZWJ1Zy5jb2xvciA9IGNyZWF0ZURlYnVnLnNlbGVjdENvbG9yKG5hbWVzcGFjZSk7CiAgICAgIGRlYnVnLmV4dGVuZCA9IGV4dGVuZDsKICAgICAgZGVidWcuZGVzdHJveSA9IGNyZWF0ZURlYnVnLmRlc3Ryb3k7IC8vIFhYWCBUZW1wb3JhcnkuIFdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLgoKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRlYnVnLCAnZW5hYmxlZCcsIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgZ2V0OiAoKSA9PiB7CiAgICAgICAgICBpZiAoZW5hYmxlT3ZlcnJpZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVuYWJsZU92ZXJyaWRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWVzcGFjZXNDYWNoZSAhPT0gY3JlYXRlRGVidWcubmFtZXNwYWNlcykgewogICAgICAgICAgICBuYW1lc3BhY2VzQ2FjaGUgPSBjcmVhdGVEZWJ1Zy5uYW1lc3BhY2VzOwogICAgICAgICAgICBlbmFibGVkQ2FjaGUgPSBjcmVhdGVEZWJ1Zy5lbmFibGVkKG5hbWVzcGFjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW5hYmxlZENhY2hlOwogICAgICAgIH0sCiAgICAgICAgc2V0OiB2ID0+IHsKICAgICAgICAgIGVuYWJsZU92ZXJyaWRlID0gdjsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gRW52LXNwZWNpZmljIGluaXRpYWxpemF0aW9uIGxvZ2ljIGZvciBkZWJ1ZyBpbnN0YW5jZXMKICAgICAgaWYgKHR5cGVvZiBjcmVhdGVEZWJ1Zy5pbml0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY3JlYXRlRGVidWcuaW5pdChkZWJ1Zyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlYnVnOwogICAgfQogICAgZnVuY3Rpb24gZXh0ZW5kKG5hbWVzcGFjZSwgZGVsaW1pdGVyKSB7CiAgICAgIGNvbnN0IG5ld0RlYnVnID0gY3JlYXRlRGVidWcodGhpcy5uYW1lc3BhY2UgKyAodHlwZW9mIGRlbGltaXRlciA9PT0gJ3VuZGVmaW5lZCcgPyAnOicgOiBkZWxpbWl0ZXIpICsgbmFtZXNwYWNlKTsKICAgICAgbmV3RGVidWcubG9nID0gdGhpcy5sb2c7CiAgICAgIHJldHVybiBuZXdEZWJ1ZzsKICAgIH0KCiAgICAvKioKICAgICogRW5hYmxlcyBhIGRlYnVnIG1vZGUgYnkgbmFtZXNwYWNlcy4gVGhpcyBjYW4gaW5jbHVkZSBtb2RlcwogICAgKiBzZXBhcmF0ZWQgYnkgYSBjb2xvbiBhbmQgd2lsZGNhcmRzLgogICAgKgogICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlcwogICAgKiBAYXBpIHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGVuYWJsZShuYW1lc3BhY2VzKSB7CiAgICAgIGNyZWF0ZURlYnVnLnNhdmUobmFtZXNwYWNlcyk7CiAgICAgIGNyZWF0ZURlYnVnLm5hbWVzcGFjZXMgPSBuYW1lc3BhY2VzOwogICAgICBjcmVhdGVEZWJ1Zy5uYW1lcyA9IFtdOwogICAgICBjcmVhdGVEZWJ1Zy5za2lwcyA9IFtdOwogICAgICBjb25zdCBzcGxpdCA9ICh0eXBlb2YgbmFtZXNwYWNlcyA9PT0gJ3N0cmluZycgPyBuYW1lc3BhY2VzIDogJycpLnRyaW0oKS5yZXBsYWNlKCcgJywgJywnKS5zcGxpdCgnLCcpLmZpbHRlcihCb29sZWFuKTsKICAgICAgZm9yIChjb25zdCBucyBvZiBzcGxpdCkgewogICAgICAgIGlmIChuc1swXSA9PT0gJy0nKSB7CiAgICAgICAgICBjcmVhdGVEZWJ1Zy5za2lwcy5wdXNoKG5zLnNsaWNlKDEpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3JlYXRlRGVidWcubmFtZXMucHVzaChucyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHN0cmluZyBtYXRjaGVzIGEgbmFtZXNwYWNlIHRlbXBsYXRlLCBob25vcmluZwogICAgICogYXN0ZXJpc2tzIGFzIHdpbGRjYXJkcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc2VhcmNoCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdGVtcGxhdGUKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hdGNoZXNUZW1wbGF0ZShzZWFyY2gsIHRlbXBsYXRlKSB7CiAgICAgIGxldCBzZWFyY2hJbmRleCA9IDA7CiAgICAgIGxldCB0ZW1wbGF0ZUluZGV4ID0gMDsKICAgICAgbGV0IHN0YXJJbmRleCA9IC0xOwogICAgICBsZXQgbWF0Y2hJbmRleCA9IDA7CiAgICAgIHdoaWxlIChzZWFyY2hJbmRleCA8IHNlYXJjaC5sZW5ndGgpIHsKICAgICAgICBpZiAodGVtcGxhdGVJbmRleCA8IHRlbXBsYXRlLmxlbmd0aCAmJiAodGVtcGxhdGVbdGVtcGxhdGVJbmRleF0gPT09IHNlYXJjaFtzZWFyY2hJbmRleF0gfHwgdGVtcGxhdGVbdGVtcGxhdGVJbmRleF0gPT09ICcqJykpIHsKICAgICAgICAgIC8vIE1hdGNoIGNoYXJhY3RlciBvciBwcm9jZWVkIHdpdGggd2lsZGNhcmQKICAgICAgICAgIGlmICh0ZW1wbGF0ZVt0ZW1wbGF0ZUluZGV4XSA9PT0gJyonKSB7CiAgICAgICAgICAgIHN0YXJJbmRleCA9IHRlbXBsYXRlSW5kZXg7CiAgICAgICAgICAgIG1hdGNoSW5kZXggPSBzZWFyY2hJbmRleDsKICAgICAgICAgICAgdGVtcGxhdGVJbmRleCsrOyAvLyBTa2lwIHRoZSAnKicKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlYXJjaEluZGV4Kys7CiAgICAgICAgICAgIHRlbXBsYXRlSW5kZXgrKzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHN0YXJJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbmVnYXRlZC1jb25kaXRpb24KICAgICAgICAgIC8vIEJhY2t0cmFjayB0byB0aGUgbGFzdCAnKicgYW5kIHRyeSB0byBtYXRjaCBtb3JlIGNoYXJhY3RlcnMKICAgICAgICAgIHRlbXBsYXRlSW5kZXggPSBzdGFySW5kZXggKyAxOwogICAgICAgICAgbWF0Y2hJbmRleCsrOwogICAgICAgICAgc2VhcmNoSW5kZXggPSBtYXRjaEluZGV4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIE5vIG1hdGNoCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBIYW5kbGUgdHJhaWxpbmcgJyonIGluIHRlbXBsYXRlCiAgICAgIHdoaWxlICh0ZW1wbGF0ZUluZGV4IDwgdGVtcGxhdGUubGVuZ3RoICYmIHRlbXBsYXRlW3RlbXBsYXRlSW5kZXhdID09PSAnKicpIHsKICAgICAgICB0ZW1wbGF0ZUluZGV4Kys7CiAgICAgIH0KICAgICAgcmV0dXJuIHRlbXBsYXRlSW5kZXggPT09IHRlbXBsYXRlLmxlbmd0aDsKICAgIH0KCiAgICAvKioKICAgICogRGlzYWJsZSBkZWJ1ZyBvdXRwdXQuCiAgICAqCiAgICAqIEByZXR1cm4ge1N0cmluZ30gbmFtZXNwYWNlcwogICAgKiBAYXBpIHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGRpc2FibGUoKSB7CiAgICAgIGNvbnN0IG5hbWVzcGFjZXMgPSBbLi4uY3JlYXRlRGVidWcubmFtZXMsIC4uLmNyZWF0ZURlYnVnLnNraXBzLm1hcChuYW1lc3BhY2UgPT4gJy0nICsgbmFtZXNwYWNlKV0uam9pbignLCcpOwogICAgICBjcmVhdGVEZWJ1Zy5lbmFibGUoJycpOwogICAgICByZXR1cm4gbmFtZXNwYWNlczsKICAgIH0KCiAgICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBtb2RlIG5hbWUgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgKgogICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZQogICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgKiBAYXBpIHB1YmxpYwogICAgKi8KICAgIGZ1bmN0aW9uIGVuYWJsZWQobmFtZSkgewogICAgICBmb3IgKGNvbnN0IHNraXAgb2YgY3JlYXRlRGVidWcuc2tpcHMpIHsKICAgICAgICBpZiAobWF0Y2hlc1RlbXBsYXRlKG5hbWUsIHNraXApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3QgbnMgb2YgY3JlYXRlRGVidWcubmFtZXMpIHsKICAgICAgICBpZiAobWF0Y2hlc1RlbXBsYXRlKG5hbWUsIG5zKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICogQ29lcmNlIGB2YWxgLgogICAgKgogICAgKiBAcGFyYW0ge01peGVkfSB2YWwKICAgICogQHJldHVybiB7TWl4ZWR9CiAgICAqIEBhcGkgcHJpdmF0ZQogICAgKi8KICAgIGZ1bmN0aW9uIGNvZXJjZSh2YWwpIHsKICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgcmV0dXJuIHZhbC5zdGFjayB8fCB2YWwubWVzc2FnZTsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfQoKICAgIC8qKgogICAgKiBYWFggRE8gTk9UIFVTRS4gVGhpcyBpcyBhIHRlbXBvcmFyeSBzdHViIGZ1bmN0aW9uLgogICAgKiBYWFggSXQgV0lMTCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuCiAgICAqLwogICAgZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgY29uc29sZS53YXJuKCdJbnN0YW5jZSBtZXRob2QgYGRlYnVnLmRlc3Ryb3koKWAgaXMgZGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIGRvZXMgYW55dGhpbmcuIEl0IHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uIG9mIGBkZWJ1Z2AuJyk7CiAgICB9CiAgICBjcmVhdGVEZWJ1Zy5lbmFibGUoY3JlYXRlRGVidWcubG9hZCgpKTsKICAgIHJldHVybiBjcmVhdGVEZWJ1ZzsKICB9CiAgY29tbW9uJDEgPSBzZXR1cDsKICByZXR1cm4gY29tbW9uJDE7Cn0KCi8qIGVzbGludC1lbnYgYnJvd3NlciAqLwp2YXIgaGFzUmVxdWlyZWRCcm93c2VyOwpmdW5jdGlvbiByZXF1aXJlQnJvd3NlcigpIHsKICBpZiAoaGFzUmVxdWlyZWRCcm93c2VyKSByZXR1cm4gYnJvd3NlciQxLmV4cG9ydHM7CiAgaGFzUmVxdWlyZWRCcm93c2VyID0gMTsKICAoZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogICAgLyoqCiAgICAgKiBUaGlzIGlzIHRoZSB3ZWIgYnJvd3NlciBpbXBsZW1lbnRhdGlvbiBvZiBgZGVidWcoKWAuCiAgICAgKi8KCiAgICBleHBvcnRzLmZvcm1hdEFyZ3MgPSBmb3JtYXRBcmdzOwogICAgZXhwb3J0cy5zYXZlID0gc2F2ZTsKICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICBleHBvcnRzLnVzZUNvbG9ycyA9IHVzZUNvbG9yczsKICAgIGV4cG9ydHMuc3RvcmFnZSA9IGxvY2Fsc3RvcmFnZSgpOwogICAgZXhwb3J0cy5kZXN0cm95ID0gKCgpID0+IHsKICAgICAgbGV0IHdhcm5lZCA9IGZhbHNlOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGlmICghd2FybmVkKSB7CiAgICAgICAgICB3YXJuZWQgPSB0cnVlOwogICAgICAgICAgY29uc29sZS53YXJuKCdJbnN0YW5jZSBtZXRob2QgYGRlYnVnLmRlc3Ryb3koKWAgaXMgZGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIGRvZXMgYW55dGhpbmcuIEl0IHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uIG9mIGBkZWJ1Z2AuJyk7CiAgICAgICAgfQogICAgICB9OwogICAgfSkoKTsKCiAgICAvKioKICAgICAqIENvbG9ycy4KICAgICAqLwoKICAgIGV4cG9ydHMuY29sb3JzID0gWycjMDAwMENDJywgJyMwMDAwRkYnLCAnIzAwMzNDQycsICcjMDAzM0ZGJywgJyMwMDY2Q0MnLCAnIzAwNjZGRicsICcjMDA5OUNDJywgJyMwMDk5RkYnLCAnIzAwQ0MwMCcsICcjMDBDQzMzJywgJyMwMENDNjYnLCAnIzAwQ0M5OScsICcjMDBDQ0NDJywgJyMwMENDRkYnLCAnIzMzMDBDQycsICcjMzMwMEZGJywgJyMzMzMzQ0MnLCAnIzMzMzNGRicsICcjMzM2NkNDJywgJyMzMzY2RkYnLCAnIzMzOTlDQycsICcjMzM5OUZGJywgJyMzM0NDMDAnLCAnIzMzQ0MzMycsICcjMzNDQzY2JywgJyMzM0NDOTknLCAnIzMzQ0NDQycsICcjMzNDQ0ZGJywgJyM2NjAwQ0MnLCAnIzY2MDBGRicsICcjNjYzM0NDJywgJyM2NjMzRkYnLCAnIzY2Q0MwMCcsICcjNjZDQzMzJywgJyM5OTAwQ0MnLCAnIzk5MDBGRicsICcjOTkzM0NDJywgJyM5OTMzRkYnLCAnIzk5Q0MwMCcsICcjOTlDQzMzJywgJyNDQzAwMDAnLCAnI0NDMDAzMycsICcjQ0MwMDY2JywgJyNDQzAwOTknLCAnI0NDMDBDQycsICcjQ0MwMEZGJywgJyNDQzMzMDAnLCAnI0NDMzMzMycsICcjQ0MzMzY2JywgJyNDQzMzOTknLCAnI0NDMzNDQycsICcjQ0MzM0ZGJywgJyNDQzY2MDAnLCAnI0NDNjYzMycsICcjQ0M5OTAwJywgJyNDQzk5MzMnLCAnI0NDQ0MwMCcsICcjQ0NDQzMzJywgJyNGRjAwMDAnLCAnI0ZGMDAzMycsICcjRkYwMDY2JywgJyNGRjAwOTknLCAnI0ZGMDBDQycsICcjRkYwMEZGJywgJyNGRjMzMDAnLCAnI0ZGMzMzMycsICcjRkYzMzY2JywgJyNGRjMzOTknLCAnI0ZGMzNDQycsICcjRkYzM0ZGJywgJyNGRjY2MDAnLCAnI0ZGNjYzMycsICcjRkY5OTAwJywgJyNGRjk5MzMnLCAnI0ZGQ0MwMCcsICcjRkZDQzMzJ107CgogICAgLyoqCiAgICAgKiBDdXJyZW50bHkgb25seSBXZWJLaXQtYmFzZWQgV2ViIEluc3BlY3RvcnMsIEZpcmVmb3ggPj0gdjMxLAogICAgICogYW5kIHRoZSBGaXJlYnVnIGV4dGVuc2lvbiAoYW55IEZpcmVmb3ggdmVyc2lvbikgYXJlIGtub3duCiAgICAgKiB0byBzdXBwb3J0ICIlYyIgQ1NTIGN1c3RvbWl6YXRpb25zLgogICAgICoKICAgICAqIFRPRE86IGFkZCBhIGBsb2NhbFN0b3JhZ2VgIHZhcmlhYmxlIHRvIGV4cGxpY2l0bHkgZW5hYmxlL2Rpc2FibGUgY29sb3JzCiAgICAgKi8KCiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eQogICAgZnVuY3Rpb24gdXNlQ29sb3JzKCkgewogICAgICAvLyBOQjogSW4gYW4gRWxlY3Ryb24gcHJlbG9hZCBzY3JpcHQsIGRvY3VtZW50IHdpbGwgYmUgZGVmaW5lZCBidXQgbm90IGZ1bGx5CiAgICAgIC8vIGluaXRpYWxpemVkLiBTaW5jZSB3ZSBrbm93IHdlJ3JlIGluIENocm9tZSwgd2UnbGwganVzdCBkZXRlY3QgdGhpcyBjYXNlCiAgICAgIC8vIGV4cGxpY2l0bHkKICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5wcm9jZXNzICYmICh3aW5kb3cucHJvY2Vzcy50eXBlID09PSAncmVuZGVyZXInIHx8IHdpbmRvdy5wcm9jZXNzLl9fbndqcykpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgYW5kIEVkZ2UgZG8gbm90IHN1cHBvcnQgY29sb3JzLgogICAgICBpZiAodHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudCAmJiBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goLyhlZGdlfHRyaWRlbnQpXC8oXGQrKS8pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCBtOwoKICAgICAgLy8gSXMgd2Via2l0PyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xNjQ1OTYwNi8zNzY3NzMKICAgICAgLy8gZG9jdW1lbnQgaXMgdW5kZWZpbmVkIGluIHJlYWN0LW5hdGl2ZTogaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0LW5hdGl2ZS9wdWxsLzE2MzIKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJldHVybi1hc3NpZ24KICAgICAgcmV0dXJuIHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZSAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuV2Via2l0QXBwZWFyYW5jZSB8fAogICAgICAvLyBJcyBmaXJlYnVnPyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8zOTgxMjAvMzc2NzczCiAgICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5jb25zb2xlICYmICh3aW5kb3cuY29uc29sZS5maXJlYnVnIHx8IHdpbmRvdy5jb25zb2xlLmV4Y2VwdGlvbiAmJiB3aW5kb3cuY29uc29sZS50YWJsZSkgfHwKICAgICAgLy8gSXMgZmlyZWZveCA+PSB2MzE/CiAgICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvVG9vbHMvV2ViX0NvbnNvbGUjU3R5bGluZ19tZXNzYWdlcwogICAgICB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50ICYmIChtID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9maXJlZm94XC8oXGQrKS8pKSAmJiBwYXJzZUludChtWzFdLCAxMCkgPj0gMzEgfHwKICAgICAgLy8gRG91YmxlIGNoZWNrIHdlYmtpdCBpbiB1c2VyQWdlbnQganVzdCBpbiBjYXNlIHdlIGFyZSBpbiBhIHdvcmtlcgogICAgICB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50ICYmIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5tYXRjaCgvYXBwbGV3ZWJraXRcLyhcZCspLyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb2xvcml6ZSBsb2cgYXJndW1lbnRzIGlmIGVuYWJsZWQuCiAgICAgKgogICAgICogQGFwaSBwdWJsaWMKICAgICAqLwoKICAgIGZ1bmN0aW9uIGZvcm1hdEFyZ3MoYXJncykgewogICAgICBhcmdzWzBdID0gKHRoaXMudXNlQ29sb3JzID8gJyVjJyA6ICcnKSArIHRoaXMubmFtZXNwYWNlICsgKHRoaXMudXNlQ29sb3JzID8gJyAlYycgOiAnICcpICsgYXJnc1swXSArICh0aGlzLnVzZUNvbG9ycyA/ICclYyAnIDogJyAnKSArICcrJyArIG1vZHVsZS5leHBvcnRzLmh1bWFuaXplKHRoaXMuZGlmZik7CiAgICAgIGlmICghdGhpcy51c2VDb2xvcnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgYyA9ICdjb2xvcjogJyArIHRoaXMuY29sb3I7CiAgICAgIGFyZ3Muc3BsaWNlKDEsIDAsIGMsICdjb2xvcjogaW5oZXJpdCcpOwoKICAgICAgLy8gVGhlIGZpbmFsICIlYyIgaXMgc29tZXdoYXQgdHJpY2t5LCBiZWNhdXNlIHRoZXJlIGNvdWxkIGJlIG90aGVyCiAgICAgIC8vIGFyZ3VtZW50cyBwYXNzZWQgZWl0aGVyIGJlZm9yZSBvciBhZnRlciB0aGUgJWMsIHNvIHdlIG5lZWQgdG8KICAgICAgLy8gZmlndXJlIG91dCB0aGUgY29ycmVjdCBpbmRleCB0byBpbnNlcnQgdGhlIENTUyBpbnRvCiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBsYXN0QyA9IDA7CiAgICAgIGFyZ3NbMF0ucmVwbGFjZSgvJVthLXpBLVolXS9nLCBtYXRjaCA9PiB7CiAgICAgICAgaWYgKG1hdGNoID09PSAnJSUnKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgICAgaWYgKG1hdGNoID09PSAnJWMnKSB7CiAgICAgICAgICAvLyBXZSBvbmx5IGFyZSBpbnRlcmVzdGVkIGluIHRoZSAqbGFzdCogJWMKICAgICAgICAgIC8vICh0aGUgdXNlciBtYXkgaGF2ZSBwcm92aWRlZCB0aGVpciBvd24pCiAgICAgICAgICBsYXN0QyA9IGluZGV4OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGFyZ3Muc3BsaWNlKGxhc3RDLCAwLCBjKTsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZXMgYGNvbnNvbGUuZGVidWcoKWAgd2hlbiBhdmFpbGFibGUuCiAgICAgKiBOby1vcCB3aGVuIGBjb25zb2xlLmRlYnVnYCBpcyBub3QgYSAiZnVuY3Rpb24iLgogICAgICogSWYgYGNvbnNvbGUuZGVidWdgIGlzIG5vdCBhdmFpbGFibGUsIGZhbGxzIGJhY2sKICAgICAqIHRvIGBjb25zb2xlLmxvZ2AuCiAgICAgKgogICAgICogQGFwaSBwdWJsaWMKICAgICAqLwogICAgZXhwb3J0cy5sb2cgPSBjb25zb2xlLmRlYnVnIHx8IGNvbnNvbGUubG9nIHx8ICgoKSA9PiB7fSk7CgogICAgLyoqCiAgICAgKiBTYXZlIGBuYW1lc3BhY2VzYC4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNhdmUobmFtZXNwYWNlcykgewogICAgICB0cnkgewogICAgICAgIGlmIChuYW1lc3BhY2VzKSB7CiAgICAgICAgICBleHBvcnRzLnN0b3JhZ2Uuc2V0SXRlbSgnZGVidWcnLCBuYW1lc3BhY2VzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhwb3J0cy5zdG9yYWdlLnJlbW92ZUl0ZW0oJ2RlYnVnJyk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIC8vIFN3YWxsb3cKICAgICAgICAvLyBYWFggKEBRaXgtKSBzaG91bGQgd2UgYmUgbG9nZ2luZyB0aGVzZT8KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogTG9hZCBgbmFtZXNwYWNlc2AuCiAgICAgKgogICAgICogQHJldHVybiB7U3RyaW5nfSByZXR1cm5zIHRoZSBwcmV2aW91c2x5IHBlcnNpc3RlZCBkZWJ1ZyBtb2RlcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxvYWQoKSB7CiAgICAgIGxldCByOwogICAgICB0cnkgewogICAgICAgIHIgPSBleHBvcnRzLnN0b3JhZ2UuZ2V0SXRlbSgnZGVidWcnKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBTd2FsbG93CiAgICAgICAgLy8gWFhYIChAUWl4LSkgc2hvdWxkIHdlIGJlIGxvZ2dpbmcgdGhlc2U/CiAgICAgIH0KCiAgICAgIC8vIElmIGRlYnVnIGlzbid0IHNldCBpbiBMUywgYW5kIHdlJ3JlIGluIEVsZWN0cm9uLCB0cnkgdG8gbG9hZCAkREVCVUcKICAgICAgaWYgKCFyICYmIHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyAmJiAnZW52JyBpbiBwcm9jZXNzKSB7CiAgICAgICAgciA9IHByb2Nlc3MuZW52LkRFQlVHOwogICAgICB9CiAgICAgIHJldHVybiByOwogICAgfQoKICAgIC8qKgogICAgICogTG9jYWxzdG9yYWdlIGF0dGVtcHRzIHRvIHJldHVybiB0aGUgbG9jYWxzdG9yYWdlLgogICAgICoKICAgICAqIFRoaXMgaXMgbmVjZXNzYXJ5IGJlY2F1c2Ugc2FmYXJpIHRocm93cwogICAgICogd2hlbiBhIHVzZXIgZGlzYWJsZXMgY29va2llcy9sb2NhbHN0b3JhZ2UKICAgICAqIGFuZCB5b3UgYXR0ZW1wdCB0byBhY2Nlc3MgaXQuCiAgICAgKgogICAgICogQHJldHVybiB7TG9jYWxTdG9yYWdlfQogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KCiAgICBmdW5jdGlvbiBsb2NhbHN0b3JhZ2UoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgLy8gVFZNTEtpdCAoQXBwbGUgVFYgSlMgUnVudGltZSkgZG9lcyBub3QgaGF2ZSBhIHdpbmRvdyBvYmplY3QsIGp1c3QgbG9jYWxTdG9yYWdlIGluIHRoZSBnbG9iYWwgY29udGV4dAogICAgICAgIC8vIFRoZSBCcm93c2VyIGFsc28gaGFzIGxvY2FsU3RvcmFnZSBpbiB0aGUgZ2xvYmFsIGNvbnRleHQuCiAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAvLyBTd2FsbG93CiAgICAgICAgLy8gWFhYIChAUWl4LSkgc2hvdWxkIHdlIGJlIGxvZ2dpbmcgdGhlc2U/CiAgICAgIH0KICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZUNvbW1vbiQxKCkoZXhwb3J0cyk7CiAgICBjb25zdCB7CiAgICAgIGZvcm1hdHRlcnMKICAgIH0gPSBtb2R1bGUuZXhwb3J0czsKCiAgICAvKioKICAgICAqIE1hcCAlaiB0byBgSlNPTi5zdHJpbmdpZnkoKWAsIHNpbmNlIG5vIFdlYiBJbnNwZWN0b3JzIGRvIHRoYXQgYnkgZGVmYXVsdC4KICAgICAqLwoKICAgIGZvcm1hdHRlcnMuaiA9IGZ1bmN0aW9uICh2KSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHYpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHJldHVybiAnW1VuZXhwZWN0ZWRKU09OUGFyc2VFcnJvcl06ICcgKyBlcnJvci5tZXNzYWdlOwogICAgICB9CiAgICB9OwogIH0pKGJyb3dzZXIkMSwgYnJvd3NlciQxLmV4cG9ydHMpOwogIHJldHVybiBicm93c2VyJDEuZXhwb3J0czsKfQoKdmFyIG5vZGUgPSB7ZXhwb3J0czoge319OwoKdmFyIGhhc0ZsYWc7CnZhciBoYXNSZXF1aXJlZEhhc0ZsYWc7CmZ1bmN0aW9uIHJlcXVpcmVIYXNGbGFnKCkgewogIGlmIChoYXNSZXF1aXJlZEhhc0ZsYWcpIHJldHVybiBoYXNGbGFnOwogIGhhc1JlcXVpcmVkSGFzRmxhZyA9IDE7CiAgaGFzRmxhZyA9IChmbGFnLCBhcmd2ID0gcHJvY2Vzcy5hcmd2KSA9PiB7CiAgICBjb25zdCBwcmVmaXggPSBmbGFnLnN0YXJ0c1dpdGgoJy0nKSA/ICcnIDogZmxhZy5sZW5ndGggPT09IDEgPyAnLScgOiAnLS0nOwogICAgY29uc3QgcG9zaXRpb24gPSBhcmd2LmluZGV4T2YocHJlZml4ICsgZmxhZyk7CiAgICBjb25zdCB0ZXJtaW5hdG9yUG9zaXRpb24gPSBhcmd2LmluZGV4T2YoJy0tJyk7CiAgICByZXR1cm4gcG9zaXRpb24gIT09IC0xICYmICh0ZXJtaW5hdG9yUG9zaXRpb24gPT09IC0xIHx8IHBvc2l0aW9uIDwgdGVybWluYXRvclBvc2l0aW9uKTsKICB9OwogIHJldHVybiBoYXNGbGFnOwp9Cgp2YXIgc3VwcG9ydHNDb2xvcl8xOwp2YXIgaGFzUmVxdWlyZWRTdXBwb3J0c0NvbG9yOwpmdW5jdGlvbiByZXF1aXJlU3VwcG9ydHNDb2xvcigpIHsKICBpZiAoaGFzUmVxdWlyZWRTdXBwb3J0c0NvbG9yKSByZXR1cm4gc3VwcG9ydHNDb2xvcl8xOwogIGhhc1JlcXVpcmVkU3VwcG9ydHNDb2xvciA9IDE7CiAgY29uc3Qgb3MgPSByZXF1aXJlJCQwJDU7CiAgY29uc3QgdHR5ID0gcmVxdWlyZSQkMTsKICBjb25zdCBoYXNGbGFnID0gcmVxdWlyZUhhc0ZsYWcoKTsKICBjb25zdCB7CiAgICBlbnYKICB9ID0gcHJvY2VzczsKICBsZXQgZm9yY2VDb2xvcjsKICBpZiAoaGFzRmxhZygnbm8tY29sb3InKSB8fCBoYXNGbGFnKCduby1jb2xvcnMnKSB8fCBoYXNGbGFnKCdjb2xvcj1mYWxzZScpIHx8IGhhc0ZsYWcoJ2NvbG9yPW5ldmVyJykpIHsKICAgIGZvcmNlQ29sb3IgPSAwOwogIH0gZWxzZSBpZiAoaGFzRmxhZygnY29sb3InKSB8fCBoYXNGbGFnKCdjb2xvcnMnKSB8fCBoYXNGbGFnKCdjb2xvcj10cnVlJykgfHwgaGFzRmxhZygnY29sb3I9YWx3YXlzJykpIHsKICAgIGZvcmNlQ29sb3IgPSAxOwogIH0KICBpZiAoJ0ZPUkNFX0NPTE9SJyBpbiBlbnYpIHsKICAgIGlmIChlbnYuRk9SQ0VfQ09MT1IgPT09ICd0cnVlJykgewogICAgICBmb3JjZUNvbG9yID0gMTsKICAgIH0gZWxzZSBpZiAoZW52LkZPUkNFX0NPTE9SID09PSAnZmFsc2UnKSB7CiAgICAgIGZvcmNlQ29sb3IgPSAwOwogICAgfSBlbHNlIHsKICAgICAgZm9yY2VDb2xvciA9IGVudi5GT1JDRV9DT0xPUi5sZW5ndGggPT09IDAgPyAxIDogTWF0aC5taW4ocGFyc2VJbnQoZW52LkZPUkNFX0NPTE9SLCAxMCksIDMpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cmFuc2xhdGVMZXZlbChsZXZlbCkgewogICAgaWYgKGxldmVsID09PSAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGxldmVsLAogICAgICBoYXNCYXNpYzogdHJ1ZSwKICAgICAgaGFzMjU2OiBsZXZlbCA+PSAyLAogICAgICBoYXMxNm06IGxldmVsID49IDMKICAgIH07CiAgfQogIGZ1bmN0aW9uIHN1cHBvcnRzQ29sb3IoaGF2ZVN0cmVhbSwgc3RyZWFtSXNUVFkpIHsKICAgIGlmIChmb3JjZUNvbG9yID09PSAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgaWYgKGhhc0ZsYWcoJ2NvbG9yPTE2bScpIHx8IGhhc0ZsYWcoJ2NvbG9yPWZ1bGwnKSB8fCBoYXNGbGFnKCdjb2xvcj10cnVlY29sb3InKSkgewogICAgICByZXR1cm4gMzsKICAgIH0KICAgIGlmIChoYXNGbGFnKCdjb2xvcj0yNTYnKSkgewogICAgICByZXR1cm4gMjsKICAgIH0KICAgIGlmIChoYXZlU3RyZWFtICYmICFzdHJlYW1Jc1RUWSAmJiBmb3JjZUNvbG9yID09PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBjb25zdCBtaW4gPSBmb3JjZUNvbG9yIHx8IDA7CiAgICBpZiAoZW52LlRFUk0gPT09ICdkdW1iJykgewogICAgICByZXR1cm4gbWluOwogICAgfQogICAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMicpIHsKICAgICAgLy8gV2luZG93cyAxMCBidWlsZCAxMDU4NiBpcyB0aGUgZmlyc3QgV2luZG93cyByZWxlYXNlIHRoYXQgc3VwcG9ydHMgMjU2IGNvbG9ycy4KICAgICAgLy8gV2luZG93cyAxMCBidWlsZCAxNDkzMSBpcyB0aGUgZmlyc3QgcmVsZWFzZSB0aGF0IHN1cHBvcnRzIDE2bS9UcnVlQ29sb3IuCiAgICAgIGNvbnN0IG9zUmVsZWFzZSA9IG9zLnJlbGVhc2UoKS5zcGxpdCgnLicpOwogICAgICBpZiAoTnVtYmVyKG9zUmVsZWFzZVswXSkgPj0gMTAgJiYgTnVtYmVyKG9zUmVsZWFzZVsyXSkgPj0gMTA1ODYpIHsKICAgICAgICByZXR1cm4gTnVtYmVyKG9zUmVsZWFzZVsyXSkgPj0gMTQ5MzEgPyAzIDogMjsKICAgICAgfQogICAgICByZXR1cm4gMTsKICAgIH0KICAgIGlmICgnQ0knIGluIGVudikgewogICAgICBpZiAoWydUUkFWSVMnLCAnQ0lSQ0xFQ0knLCAnQVBQVkVZT1InLCAnR0lUTEFCX0NJJywgJ0dJVEhVQl9BQ1RJT05TJywgJ0JVSUxES0lURSddLnNvbWUoc2lnbiA9PiBzaWduIGluIGVudikgfHwgZW52LkNJX05BTUUgPT09ICdjb2Rlc2hpcCcpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICByZXR1cm4gbWluOwogICAgfQogICAgaWYgKCdURUFNQ0lUWV9WRVJTSU9OJyBpbiBlbnYpIHsKICAgICAgcmV0dXJuIC9eKDlcLigwKlsxLTldXGQqKVwufFxkezIsfVwuKS8udGVzdChlbnYuVEVBTUNJVFlfVkVSU0lPTikgPyAxIDogMDsKICAgIH0KICAgIGlmIChlbnYuQ09MT1JURVJNID09PSAndHJ1ZWNvbG9yJykgewogICAgICByZXR1cm4gMzsKICAgIH0KICAgIGlmICgnVEVSTV9QUk9HUkFNJyBpbiBlbnYpIHsKICAgICAgY29uc3QgdmVyc2lvbiA9IHBhcnNlSW50KChlbnYuVEVSTV9QUk9HUkFNX1ZFUlNJT04gfHwgJycpLnNwbGl0KCcuJylbMF0sIDEwKTsKICAgICAgc3dpdGNoIChlbnYuVEVSTV9QUk9HUkFNKSB7CiAgICAgICAgY2FzZSAnaVRlcm0uYXBwJzoKICAgICAgICAgIHJldHVybiB2ZXJzaW9uID49IDMgPyAzIDogMjsKICAgICAgICBjYXNlICdBcHBsZV9UZXJtaW5hbCc6CiAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAvLyBObyBkZWZhdWx0CiAgICAgIH0KICAgIH0KICAgIGlmICgvLTI1Nihjb2xvcik/JC9pLnRlc3QoZW52LlRFUk0pKSB7CiAgICAgIHJldHVybiAyOwogICAgfQogICAgaWYgKC9ec2NyZWVufF54dGVybXxednQxMDB8XnZ0MjIwfF5yeHZ0fGNvbG9yfGFuc2l8Y3lnd2lufGxpbnV4L2kudGVzdChlbnYuVEVSTSkpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICBpZiAoJ0NPTE9SVEVSTScgaW4gZW52KSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgcmV0dXJuIG1pbjsKICB9CiAgZnVuY3Rpb24gZ2V0U3VwcG9ydExldmVsKHN0cmVhbSkgewogICAgY29uc3QgbGV2ZWwgPSBzdXBwb3J0c0NvbG9yKHN0cmVhbSwgc3RyZWFtICYmIHN0cmVhbS5pc1RUWSk7CiAgICByZXR1cm4gdHJhbnNsYXRlTGV2ZWwobGV2ZWwpOwogIH0KICBzdXBwb3J0c0NvbG9yXzEgPSB7CiAgICBzdXBwb3J0c0NvbG9yOiBnZXRTdXBwb3J0TGV2ZWwsCiAgICBzdGRvdXQ6IHRyYW5zbGF0ZUxldmVsKHN1cHBvcnRzQ29sb3IodHJ1ZSwgdHR5LmlzYXR0eSgxKSkpLAogICAgc3RkZXJyOiB0cmFuc2xhdGVMZXZlbChzdXBwb3J0c0NvbG9yKHRydWUsIHR0eS5pc2F0dHkoMikpKQogIH07CiAgcmV0dXJuIHN1cHBvcnRzQ29sb3JfMTsKfQoKLyoqCiAqIE1vZHVsZSBkZXBlbmRlbmNpZXMuCiAqLwp2YXIgaGFzUmVxdWlyZWROb2RlOwpmdW5jdGlvbiByZXF1aXJlTm9kZSgpIHsKICBpZiAoaGFzUmVxdWlyZWROb2RlKSByZXR1cm4gbm9kZS5leHBvcnRzOwogIGhhc1JlcXVpcmVkTm9kZSA9IDE7CiAgKGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IHR0eSA9IHJlcXVpcmUkJDE7CiAgICBjb25zdCB1dGlsID0gcmVxdWlyZSQkMSQxOwoKICAgIC8qKgogICAgICogVGhpcyBpcyB0aGUgTm9kZS5qcyBpbXBsZW1lbnRhdGlvbiBvZiBgZGVidWcoKWAuCiAgICAgKi8KCiAgICBleHBvcnRzLmluaXQgPSBpbml0OwogICAgZXhwb3J0cy5sb2cgPSBsb2c7CiAgICBleHBvcnRzLmZvcm1hdEFyZ3MgPSBmb3JtYXRBcmdzOwogICAgZXhwb3J0cy5zYXZlID0gc2F2ZTsKICAgIGV4cG9ydHMubG9hZCA9IGxvYWQ7CiAgICBleHBvcnRzLnVzZUNvbG9ycyA9IHVzZUNvbG9yczsKICAgIGV4cG9ydHMuZGVzdHJveSA9IHV0aWwuZGVwcmVjYXRlKCgpID0+IHt9LCAnSW5zdGFuY2UgbWV0aG9kIGBkZWJ1Zy5kZXN0cm95KClgIGlzIGRlcHJlY2F0ZWQgYW5kIG5vIGxvbmdlciBkb2VzIGFueXRoaW5nLiBJdCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgdmVyc2lvbiBvZiBgZGVidWdgLicpOwoKICAgIC8qKgogICAgICogQ29sb3JzLgogICAgICovCgogICAgZXhwb3J0cy5jb2xvcnMgPSBbNiwgMiwgMywgNCwgNSwgMV07CiAgICB0cnkgewogICAgICAvLyBPcHRpb25hbCBkZXBlbmRlbmN5IChhcyBpbiwgZG9lc24ndCBuZWVkIHRvIGJlIGluc3RhbGxlZCwgTk9UIGxpa2Ugb3B0aW9uYWxEZXBlbmRlbmNpZXMgaW4gcGFja2FnZS5qc29uKQogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgaW1wb3J0L25vLWV4dHJhbmVvdXMtZGVwZW5kZW5jaWVzCiAgICAgIGNvbnN0IHN1cHBvcnRzQ29sb3IgPSByZXF1aXJlU3VwcG9ydHNDb2xvcigpOwogICAgICBpZiAoc3VwcG9ydHNDb2xvciAmJiAoc3VwcG9ydHNDb2xvci5zdGRlcnIgfHwgc3VwcG9ydHNDb2xvcikubGV2ZWwgPj0gMikgewogICAgICAgIGV4cG9ydHMuY29sb3JzID0gWzIwLCAyMSwgMjYsIDI3LCAzMiwgMzMsIDM4LCAzOSwgNDAsIDQxLCA0MiwgNDMsIDQ0LCA0NSwgNTYsIDU3LCA2MiwgNjMsIDY4LCA2OSwgNzQsIDc1LCA3NiwgNzcsIDc4LCA3OSwgODAsIDgxLCA5MiwgOTMsIDk4LCA5OSwgMTEyLCAxMTMsIDEyOCwgMTI5LCAxMzQsIDEzNSwgMTQ4LCAxNDksIDE2MCwgMTYxLCAxNjIsIDE2MywgMTY0LCAxNjUsIDE2NiwgMTY3LCAxNjgsIDE2OSwgMTcwLCAxNzEsIDE3MiwgMTczLCAxNzgsIDE3OSwgMTg0LCAxODUsIDE5NiwgMTk3LCAxOTgsIDE5OSwgMjAwLCAyMDEsIDIwMiwgMjAzLCAyMDQsIDIwNSwgMjA2LCAyMDcsIDIwOCwgMjA5LCAyMTQsIDIxNSwgMjIwLCAyMjFdOwogICAgICB9CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAvLyBTd2FsbG93IC0gd2Ugb25seSBjYXJlIGlmIGBzdXBwb3J0cy1jb2xvcmAgaXMgYXZhaWxhYmxlOyBpdCBkb2Vzbid0IGhhdmUgdG8gYmUuCiAgICB9CgogICAgLyoqCiAgICAgKiBCdWlsZCB1cCB0aGUgZGVmYXVsdCBgaW5zcGVjdE9wdHNgIG9iamVjdCBmcm9tIHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMuCiAgICAgKgogICAgICogICAkIERFQlVHX0NPTE9SUz1ubyBERUJVR19ERVBUSD0xMCBERUJVR19TSE9XX0hJRERFTj1lbmFibGVkIG5vZGUgc2NyaXB0LmpzCiAgICAgKi8KCiAgICBleHBvcnRzLmluc3BlY3RPcHRzID0gT2JqZWN0LmtleXMocHJvY2Vzcy5lbnYpLmZpbHRlcihrZXkgPT4gewogICAgICByZXR1cm4gL15kZWJ1Z18vaS50ZXN0KGtleSk7CiAgICB9KS5yZWR1Y2UoKG9iaiwga2V5KSA9PiB7CiAgICAgIC8vIENhbWVsLWNhc2UKICAgICAgY29uc3QgcHJvcCA9IGtleS5zdWJzdHJpbmcoNikudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9fKFthLXpdKS9nLCAoXywgaykgPT4gewogICAgICAgIHJldHVybiBrLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwoKICAgICAgLy8gQ29lcmNlIHN0cmluZyB2YWx1ZSBpbnRvIEpTIHZhbHVlCiAgICAgIGxldCB2YWwgPSBwcm9jZXNzLmVudltrZXldOwogICAgICBpZiAoL14oeWVzfG9ufHRydWV8ZW5hYmxlZCkkL2kudGVzdCh2YWwpKSB7CiAgICAgICAgdmFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICgvXihub3xvZmZ8ZmFsc2V8ZGlzYWJsZWQpJC9pLnRlc3QodmFsKSkgewogICAgICAgIHZhbCA9IGZhbHNlOwogICAgICB9IGVsc2UgaWYgKHZhbCA9PT0gJ251bGwnKSB7CiAgICAgICAgdmFsID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSBOdW1iZXIodmFsKTsKICAgICAgfQogICAgICBvYmpbcHJvcF0gPSB2YWw7CiAgICAgIHJldHVybiBvYmo7CiAgICB9LCB7fSk7CgogICAgLyoqCiAgICAgKiBJcyBzdGRvdXQgYSBUVFk/IENvbG9yZWQgb3V0cHV0IGlzIGVuYWJsZWQgd2hlbiBgdHJ1ZWAuCiAgICAgKi8KCiAgICBmdW5jdGlvbiB1c2VDb2xvcnMoKSB7CiAgICAgIHJldHVybiAnY29sb3JzJyBpbiBleHBvcnRzLmluc3BlY3RPcHRzID8gQm9vbGVhbihleHBvcnRzLmluc3BlY3RPcHRzLmNvbG9ycykgOiB0dHkuaXNhdHR5KHByb2Nlc3Muc3RkZXJyLmZkKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgQU5TSSBjb2xvciBlc2NhcGUgY29kZXMgaWYgZW5hYmxlZC4KICAgICAqCiAgICAgKiBAYXBpIHB1YmxpYwogICAgICovCgogICAgZnVuY3Rpb24gZm9ybWF0QXJncyhhcmdzKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBuYW1lc3BhY2U6IG5hbWUsCiAgICAgICAgdXNlQ29sb3JzCiAgICAgIH0gPSB0aGlzOwogICAgICBpZiAodXNlQ29sb3JzKSB7CiAgICAgICAgY29uc3QgYyA9IHRoaXMuY29sb3I7CiAgICAgICAgY29uc3QgY29sb3JDb2RlID0gJ1x1MDAxQlszJyArIChjIDwgOCA/IGMgOiAnODs1OycgKyBjKTsKICAgICAgICBjb25zdCBwcmVmaXggPSBgICAke2NvbG9yQ29kZX07MW0ke25hbWV9IFx1MDAxQlswbWA7CiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArIGFyZ3NbMF0uc3BsaXQoJ1xuJykuam9pbignXG4nICsgcHJlZml4KTsKICAgICAgICBhcmdzLnB1c2goY29sb3JDb2RlICsgJ20rJyArIG1vZHVsZS5leHBvcnRzLmh1bWFuaXplKHRoaXMuZGlmZikgKyAnXHUwMDFCWzBtJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXJnc1swXSA9IGdldERhdGUoKSArIG5hbWUgKyAnICcgKyBhcmdzWzBdOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXREYXRlKCkgewogICAgICBpZiAoZXhwb3J0cy5pbnNwZWN0T3B0cy5oaWRlRGF0ZSkgewogICAgICAgIHJldHVybiAnJzsKICAgICAgfQogICAgICByZXR1cm4gbmV3IERhdGUoKS50b0lTT1N0cmluZygpICsgJyAnOwogICAgfQoKICAgIC8qKgogICAgICogSW52b2tlcyBgdXRpbC5mb3JtYXRXaXRoT3B0aW9ucygpYCB3aXRoIHRoZSBzcGVjaWZpZWQgYXJndW1lbnRzIGFuZCB3cml0ZXMgdG8gc3RkZXJyLgogICAgICovCgogICAgZnVuY3Rpb24gbG9nKC4uLmFyZ3MpIHsKICAgICAgcmV0dXJuIHByb2Nlc3Muc3RkZXJyLndyaXRlKHV0aWwuZm9ybWF0V2l0aE9wdGlvbnMoZXhwb3J0cy5pbnNwZWN0T3B0cywgLi4uYXJncykgKyAnXG4nKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNhdmUgYG5hbWVzcGFjZXNgLgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2VzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZnVuY3Rpb24gc2F2ZShuYW1lc3BhY2VzKSB7CiAgICAgIGlmIChuYW1lc3BhY2VzKSB7CiAgICAgICAgcHJvY2Vzcy5lbnYuREVCVUcgPSBuYW1lc3BhY2VzOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIHlvdSBzZXQgYSBwcm9jZXNzLmVudiBmaWVsZCB0byBudWxsIG9yIHVuZGVmaW5lZCwgaXQgZ2V0cyBjYXN0IHRvIHRoZQogICAgICAgIC8vIHN0cmluZyAnbnVsbCcgb3IgJ3VuZGVmaW5lZCcuIEp1c3QgZGVsZXRlIGluc3RlYWQuCiAgICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkRFQlVHOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBMb2FkIGBuYW1lc3BhY2VzYC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IHJldHVybnMgdGhlIHByZXZpb3VzbHkgcGVyc2lzdGVkIGRlYnVnIG1vZGVzCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwoKICAgIGZ1bmN0aW9uIGxvYWQoKSB7CiAgICAgIHJldHVybiBwcm9jZXNzLmVudi5ERUJVRzsKICAgIH0KCiAgICAvKioKICAgICAqIEluaXQgbG9naWMgZm9yIGBkZWJ1Z2AgaW5zdGFuY2VzLgogICAgICoKICAgICAqIENyZWF0ZSBhIG5ldyBgaW5zcGVjdE9wdHNgIG9iamVjdCBpbiBjYXNlIGB1c2VDb2xvcnNgIGlzIHNldAogICAgICogZGlmZmVyZW50bHkgZm9yIGEgcGFydGljdWxhciBgZGVidWdgIGluc3RhbmNlLgogICAgICovCgogICAgZnVuY3Rpb24gaW5pdChkZWJ1ZykgewogICAgICBkZWJ1Zy5pbnNwZWN0T3B0cyA9IHt9OwogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZXhwb3J0cy5pbnNwZWN0T3B0cyk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGRlYnVnLmluc3BlY3RPcHRzW2tleXNbaV1dID0gZXhwb3J0cy5pbnNwZWN0T3B0c1trZXlzW2ldXTsKICAgICAgfQogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlQ29tbW9uJDEoKShleHBvcnRzKTsKICAgIGNvbnN0IHsKICAgICAgZm9ybWF0dGVycwogICAgfSA9IG1vZHVsZS5leHBvcnRzOwoKICAgIC8qKgogICAgICogTWFwICVvIHRvIGB1dGlsLmluc3BlY3QoKWAsIGFsbCBvbiBhIHNpbmdsZSBsaW5lLgogICAgICovCgogICAgZm9ybWF0dGVycy5vID0gZnVuY3Rpb24gKHYpIHsKICAgICAgdGhpcy5pbnNwZWN0T3B0cy5jb2xvcnMgPSB0aGlzLnVzZUNvbG9yczsKICAgICAgcmV0dXJuIHV0aWwuaW5zcGVjdCh2LCB0aGlzLmluc3BlY3RPcHRzKS5zcGxpdCgnXG4nKS5tYXAoc3RyID0+IHN0ci50cmltKCkpLmpvaW4oJyAnKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBNYXAgJU8gdG8gYHV0aWwuaW5zcGVjdCgpYCwgYWxsb3dpbmcgbXVsdGlwbGUgbGluZXMgaWYgbmVlZGVkLgogICAgICovCgogICAgZm9ybWF0dGVycy5PID0gZnVuY3Rpb24gKHYpIHsKICAgICAgdGhpcy5pbnNwZWN0T3B0cy5jb2xvcnMgPSB0aGlzLnVzZUNvbG9yczsKICAgICAgcmV0dXJuIHV0aWwuaW5zcGVjdCh2LCB0aGlzLmluc3BlY3RPcHRzKTsKICAgIH07CiAgfSkobm9kZSwgbm9kZS5leHBvcnRzKTsKICByZXR1cm4gbm9kZS5leHBvcnRzOwp9CgovKioKICogRGV0ZWN0IEVsZWN0cm9uIHJlbmRlcmVyIC8gbndqcyBwcm9jZXNzLCB3aGljaCBpcyBub2RlLCBidXQgd2Ugc2hvdWxkCiAqIHRyZWF0IGFzIGEgYnJvd3Nlci4KICovCmlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcHJvY2Vzcy50eXBlID09PSAncmVuZGVyZXInIHx8IHByb2Nlc3MuYnJvd3NlciA9PT0gdHJ1ZSB8fCBwcm9jZXNzLl9fbndqcykgewogIHNyYy5leHBvcnRzID0gcmVxdWlyZUJyb3dzZXIoKTsKfSBlbHNlIHsKICBzcmMuZXhwb3J0cyA9IHJlcXVpcmVOb2RlKCk7Cn0KdmFyIHNyY0V4cG9ydHMgPSBzcmMuZXhwb3J0czsKCmNvbnN0IGJsID0gYmxFeHBvcnRzOwpjb25zdCB7CiAgRXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIkMgp9ID0gcmVxdWlyZSQkMCQyOwpjb25zdCBQYWNrZXQgPSBwYWNrZXQ7CmNvbnN0IGNvbnN0YW50cyQ0ID0gY29uc3RhbnRzRXhwb3J0czsKY29uc3QgZGVidWckMiA9IHNyY0V4cG9ydHMoJ21xdHQtcGFja2V0OnBhcnNlcicpOwpjbGFzcyBQYXJzZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIkMiB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5wYXJzZXIgPSB0aGlzLmNvbnN0cnVjdG9yLnBhcnNlcjsKICB9CiAgc3RhdGljIHBhcnNlcihvcHQpIHsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBQYXJzZXIpKSByZXR1cm4gbmV3IFBhcnNlcigpLnBhcnNlcihvcHQpOwogICAgdGhpcy5zZXR0aW5ncyA9IG9wdCB8fCB7fTsKICAgIHRoaXMuX3N0YXRlcyA9IFsnX3BhcnNlSGVhZGVyJywgJ19wYXJzZUxlbmd0aCcsICdfcGFyc2VQYXlsb2FkJywgJ19uZXdQYWNrZXQnXTsKICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBfcmVzZXRTdGF0ZSgpIHsKICAgIGRlYnVnJDIoJ19yZXNldFN0YXRlOiByZXNldHRpbmcgcGFja2V0LCBlcnJvciwgX2xpc3QsIGFuZCBfc3RhdGVDb3VudGVyJyk7CiAgICB0aGlzLnBhY2tldCA9IG5ldyBQYWNrZXQoKTsKICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgdGhpcy5fbGlzdCA9IGJsKCk7CiAgICB0aGlzLl9zdGF0ZUNvdW50ZXIgPSAwOwogIH0KICBwYXJzZShidWYpIHsKICAgIGlmICh0aGlzLmVycm9yKSB0aGlzLl9yZXNldFN0YXRlKCk7CiAgICB0aGlzLl9saXN0LmFwcGVuZChidWYpOwogICAgZGVidWckMigncGFyc2U6IGN1cnJlbnQgc3RhdGU6ICVzJywgdGhpcy5fc3RhdGVzW3RoaXMuX3N0YXRlQ291bnRlcl0pOwogICAgd2hpbGUgKCh0aGlzLnBhY2tldC5sZW5ndGggIT09IC0xIHx8IHRoaXMuX2xpc3QubGVuZ3RoID4gMCkgJiYgdGhpc1t0aGlzLl9zdGF0ZXNbdGhpcy5fc3RhdGVDb3VudGVyXV0oKSAmJiAhdGhpcy5lcnJvcikgewogICAgICB0aGlzLl9zdGF0ZUNvdW50ZXIrKzsKICAgICAgZGVidWckMigncGFyc2U6IHN0YXRlIGNvbXBsZXRlLiBfc3RhdGVDb3VudGVyIGlzIG5vdzogJWQnLCB0aGlzLl9zdGF0ZUNvdW50ZXIpOwogICAgICBkZWJ1ZyQyKCdwYXJzZTogcGFja2V0Lmxlbmd0aDogJWQsIGJ1ZmZlciBsaXN0IGxlbmd0aDogJWQnLCB0aGlzLnBhY2tldC5sZW5ndGgsIHRoaXMuX2xpc3QubGVuZ3RoKTsKICAgICAgaWYgKHRoaXMuX3N0YXRlQ291bnRlciA+PSB0aGlzLl9zdGF0ZXMubGVuZ3RoKSB0aGlzLl9zdGF0ZUNvdW50ZXIgPSAwOwogICAgfQogICAgZGVidWckMigncGFyc2U6IGV4aXRlZCB3aGlsZSBsb29wLiBwYWNrZXQ6ICVkLCBidWZmZXIgbGlzdCBsZW5ndGg6ICVkJywgdGhpcy5wYWNrZXQubGVuZ3RoLCB0aGlzLl9saXN0Lmxlbmd0aCk7CiAgICByZXR1cm4gdGhpcy5fbGlzdC5sZW5ndGg7CiAgfQogIF9wYXJzZUhlYWRlcigpIHsKICAgIC8vIFRoZXJlIGlzIGF0IGxlYXN0IG9uZSBieXRlIGluIHRoZSBidWZmZXIKICAgIGNvbnN0IHplcm8gPSB0aGlzLl9saXN0LnJlYWRVSW50OCgwKTsKICAgIGNvbnN0IGNtZEluZGV4ID0gemVybyA+PiBjb25zdGFudHMkNC5DTURfU0hJRlQ7CiAgICB0aGlzLnBhY2tldC5jbWQgPSBjb25zdGFudHMkNC50eXBlc1tjbWRJbmRleF07CiAgICBjb25zdCBoZWFkZXJGbGFncyA9IHplcm8gJiAweGY7CiAgICBjb25zdCByZXF1aXJlZEhlYWRlckZsYWdzID0gY29uc3RhbnRzJDQucmVxdWlyZWRIZWFkZXJGbGFnc1tjbWRJbmRleF07CiAgICBpZiAocmVxdWlyZWRIZWFkZXJGbGFncyAhPSBudWxsICYmIGhlYWRlckZsYWdzICE9PSByZXF1aXJlZEhlYWRlckZsYWdzKSB7CiAgICAgIC8vIFdoZXJlIGEgZmxhZyBiaXQgaXMgbWFya2VkIGFzIOKAnFJlc2VydmVk4oCdIGluIFRhYmxlIDIuMiAtIEZsYWcgQml0cywgaXQgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UgYW5kIE1VU1QgYmUgc2V0IHRvIHRoZSB2YWx1ZSBsaXN0ZWQgaW4gdGhhdCB0YWJsZSBbTVFUVC0yLjIuMi0xXS4gSWYgaW52YWxpZCBmbGFncyBhcmUgcmVjZWl2ZWQsIHRoZSByZWNlaXZlciBNVVNUIGNsb3NlIHRoZSBOZXR3b3JrIENvbm5lY3Rpb24gW01RVFQtMi4yLjItMl0KICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoY29uc3RhbnRzJDQucmVxdWlyZWRIZWFkZXJGbGFnc0Vycm9yc1tjbWRJbmRleF0pKTsKICAgIH0KICAgIHRoaXMucGFja2V0LnJldGFpbiA9ICh6ZXJvICYgY29uc3RhbnRzJDQuUkVUQUlOX01BU0spICE9PSAwOwogICAgdGhpcy5wYWNrZXQucW9zID0gemVybyA+PiBjb25zdGFudHMkNC5RT1NfU0hJRlQgJiBjb25zdGFudHMkNC5RT1NfTUFTSzsKICAgIGlmICh0aGlzLnBhY2tldC5xb3MgPiAyKSB7CiAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdQYWNrZXQgbXVzdCBub3QgaGF2ZSBib3RoIFFvUyBiaXRzIHNldCB0byAxJykpOwogICAgfQogICAgdGhpcy5wYWNrZXQuZHVwID0gKHplcm8gJiBjb25zdGFudHMkNC5EVVBfTUFTSykgIT09IDA7CiAgICBkZWJ1ZyQyKCdfcGFyc2VIZWFkZXI6IHBhY2tldDogJW8nLCB0aGlzLnBhY2tldCk7CiAgICB0aGlzLl9saXN0LmNvbnN1bWUoMSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgX3BhcnNlTGVuZ3RoKCkgewogICAgLy8gVGhlcmUgaXMgYXQgbGVhc3Qgb25lIGJ5dGUgaW4gdGhlIGxpc3QKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3BhcnNlVmFyQnl0ZU51bSh0cnVlKTsKICAgIGlmIChyZXN1bHQpIHsKICAgICAgdGhpcy5wYWNrZXQubGVuZ3RoID0gcmVzdWx0LnZhbHVlOwogICAgICB0aGlzLl9saXN0LmNvbnN1bWUocmVzdWx0LmJ5dGVzKTsKICAgIH0KICAgIGRlYnVnJDIoJ19wYXJzZUxlbmd0aCAlZCcsIHJlc3VsdC52YWx1ZSk7CiAgICByZXR1cm4gISFyZXN1bHQ7CiAgfQogIF9wYXJzZVBheWxvYWQoKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VQYXlsb2FkOiBwYXlsb2FkICVPJywgdGhpcy5fbGlzdCk7CiAgICBsZXQgcmVzdWx0ID0gZmFsc2U7CgogICAgLy8gRG8gd2UgaGF2ZSBhIHBheWxvYWQ/IERvIHdlIGhhdmUgZW5vdWdoIGRhdGEgdG8gY29tcGxldGUgdGhlIHBheWxvYWQ/CiAgICAvLyBQSU5HcyBoYXZlIG5vIHBheWxvYWQKICAgIGlmICh0aGlzLnBhY2tldC5sZW5ndGggPT09IDAgfHwgdGhpcy5fbGlzdC5sZW5ndGggPj0gdGhpcy5wYWNrZXQubGVuZ3RoKSB7CiAgICAgIHRoaXMuX3BvcyA9IDA7CiAgICAgIHN3aXRjaCAodGhpcy5wYWNrZXQuY21kKSB7CiAgICAgICAgY2FzZSAnY29ubmVjdCc6CiAgICAgICAgICB0aGlzLl9wYXJzZUNvbm5lY3QoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2Nvbm5hY2snOgogICAgICAgICAgdGhpcy5fcGFyc2VDb25uYWNrKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwdWJsaXNoJzoKICAgICAgICAgIHRoaXMuX3BhcnNlUHVibGlzaCgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncHViYWNrJzoKICAgICAgICBjYXNlICdwdWJyZWMnOgogICAgICAgIGNhc2UgJ3B1YnJlbCc6CiAgICAgICAgY2FzZSAncHViY29tcCc6CiAgICAgICAgICB0aGlzLl9wYXJzZUNvbmZpcm1hdGlvbigpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnc3Vic2NyaWJlJzoKICAgICAgICAgIHRoaXMuX3BhcnNlU3Vic2NyaWJlKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdzdWJhY2snOgogICAgICAgICAgdGhpcy5fcGFyc2VTdWJhY2soKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Vuc3Vic2NyaWJlJzoKICAgICAgICAgIHRoaXMuX3BhcnNlVW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3Vuc3ViYWNrJzoKICAgICAgICAgIHRoaXMuX3BhcnNlVW5zdWJhY2soKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3BpbmdyZXEnOgogICAgICAgIGNhc2UgJ3BpbmdyZXNwJzoKICAgICAgICAgIC8vIFRoZXNlIGFyZSBlbXB0eSwgbm90aGluZyB0byBkbwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnZGlzY29ubmVjdCc6CiAgICAgICAgICB0aGlzLl9wYXJzZURpc2Nvbm5lY3QoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2F1dGgnOgogICAgICAgICAgdGhpcy5fcGFyc2VBdXRoKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTm90IHN1cHBvcnRlZCcpKTsKICAgICAgfQogICAgICByZXN1bHQgPSB0cnVlOwogICAgfQogICAgZGVidWckMignX3BhcnNlUGF5bG9hZCBjb21wbGV0ZSByZXN1bHQ6ICVzJywgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIF9wYXJzZUNvbm5lY3QoKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VDb25uZWN0Jyk7CiAgICBsZXQgdG9waWM7IC8vIFdpbGwgdG9waWMKICAgIGxldCBwYXlsb2FkOyAvLyBXaWxsIHBheWxvYWQKICAgIGxldCBwYXNzd29yZDsgLy8gUGFzc3dvcmQKICAgIGxldCB1c2VybmFtZTsgLy8gVXNlcm5hbWUKICAgIGNvbnN0IGZsYWdzID0ge307CiAgICBjb25zdCBwYWNrZXQgPSB0aGlzLnBhY2tldDsKCiAgICAvLyBQYXJzZSBwcm90b2NvbElkCiAgICBjb25zdCBwcm90b2NvbElkID0gdGhpcy5fcGFyc2VTdHJpbmcoKTsKICAgIGlmIChwcm90b2NvbElkID09PSBudWxsKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIHByb3RvY29sSWQnKSk7CiAgICBpZiAocHJvdG9jb2xJZCAhPT0gJ01RVFQnICYmIHByb3RvY29sSWQgIT09ICdNUUlzZHAnKSB7CiAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIHByb3RvY29sSWQnKSk7CiAgICB9CiAgICBwYWNrZXQucHJvdG9jb2xJZCA9IHByb3RvY29sSWQ7CgogICAgLy8gUGFyc2UgY29uc3RhbnRzIHZlcnNpb24gbnVtYmVyCiAgICBpZiAodGhpcy5fcG9zID49IHRoaXMuX2xpc3QubGVuZ3RoKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignUGFja2V0IHRvbyBzaG9ydCcpKTsKICAgIHBhY2tldC5wcm90b2NvbFZlcnNpb24gPSB0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MpOwogICAgaWYgKHBhY2tldC5wcm90b2NvbFZlcnNpb24gPj0gMTI4KSB7CiAgICAgIHBhY2tldC5icmlkZ2VNb2RlID0gdHJ1ZTsKICAgICAgcGFja2V0LnByb3RvY29sVmVyc2lvbiA9IHBhY2tldC5wcm90b2NvbFZlcnNpb24gLSAxMjg7CiAgICB9CiAgICBpZiAocGFja2V0LnByb3RvY29sVmVyc2lvbiAhPT0gMyAmJiBwYWNrZXQucHJvdG9jb2xWZXJzaW9uICE9PSA0ICYmIHBhY2tldC5wcm90b2NvbFZlcnNpb24gIT09IDUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgcHJvdG9jb2wgdmVyc2lvbicpKTsKICAgIH0KICAgIHRoaXMuX3BvcysrOwogICAgaWYgKHRoaXMuX3BvcyA+PSB0aGlzLl9saXN0Lmxlbmd0aCkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignUGFja2V0IHRvbyBzaG9ydCcpKTsKICAgIH0KICAgIGlmICh0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MpICYgMHgxKSB7CiAgICAgIC8vIFRoZSBTZXJ2ZXIgTVVTVCB2YWxpZGF0ZSB0aGF0IHRoZSByZXNlcnZlZCBmbGFnIGluIHRoZSBDT05ORUNUIENvbnRyb2wgUGFja2V0IGlzIHNldCB0byB6ZXJvIGFuZCBkaXNjb25uZWN0IHRoZSBDbGllbnQgaWYgaXQgaXMgbm90IHplcm8gW01RVFQtMy4xLjItM10KICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nvbm5lY3QgZmxhZyBiaXQgMCBtdXN0IGJlIDAsIGJ1dCBnb3QgMScpKTsKICAgIH0KICAgIC8vIFBhcnNlIGNvbm5lY3QgZmxhZ3MKICAgIGZsYWdzLnVzZXJuYW1lID0gdGhpcy5fbGlzdC5yZWFkVUludDgodGhpcy5fcG9zKSAmIGNvbnN0YW50cyQ0LlVTRVJOQU1FX01BU0s7CiAgICBmbGFncy5wYXNzd29yZCA9IHRoaXMuX2xpc3QucmVhZFVJbnQ4KHRoaXMuX3BvcykgJiBjb25zdGFudHMkNC5QQVNTV09SRF9NQVNLOwogICAgZmxhZ3Mud2lsbCA9IHRoaXMuX2xpc3QucmVhZFVJbnQ4KHRoaXMuX3BvcykgJiBjb25zdGFudHMkNC5XSUxMX0ZMQUdfTUFTSzsKICAgIGNvbnN0IHdpbGxSZXRhaW4gPSAhISh0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MpICYgY29uc3RhbnRzJDQuV0lMTF9SRVRBSU5fTUFTSyk7CiAgICBjb25zdCB3aWxsUW9zID0gKHRoaXMuX2xpc3QucmVhZFVJbnQ4KHRoaXMuX3BvcykgJiBjb25zdGFudHMkNC5XSUxMX1FPU19NQVNLKSA+PiBjb25zdGFudHMkNC5XSUxMX1FPU19TSElGVDsKICAgIGlmIChmbGFncy53aWxsKSB7CiAgICAgIHBhY2tldC53aWxsID0ge307CiAgICAgIHBhY2tldC53aWxsLnJldGFpbiA9IHdpbGxSZXRhaW47CiAgICAgIHBhY2tldC53aWxsLnFvcyA9IHdpbGxRb3M7CiAgICB9IGVsc2UgewogICAgICBpZiAod2lsbFJldGFpbikgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdXaWxsIFJldGFpbiBGbGFnIG11c3QgYmUgc2V0IHRvIHplcm8gd2hlbiBXaWxsIEZsYWcgaXMgc2V0IHRvIDAnKSk7CiAgICAgIH0KICAgICAgaWYgKHdpbGxRb3MpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignV2lsbCBRb1MgbXVzdCBiZSBzZXQgdG8gemVybyB3aGVuIFdpbGwgRmxhZyBpcyBzZXQgdG8gMCcpKTsKICAgICAgfQogICAgfQogICAgcGFja2V0LmNsZWFuID0gKHRoaXMuX2xpc3QucmVhZFVJbnQ4KHRoaXMuX3BvcykgJiBjb25zdGFudHMkNC5DTEVBTl9TRVNTSU9OX01BU0spICE9PSAwOwogICAgdGhpcy5fcG9zKys7CgogICAgLy8gUGFyc2Uga2VlcGFsaXZlCiAgICBwYWNrZXQua2VlcGFsaXZlID0gdGhpcy5fcGFyc2VOdW0oKTsKICAgIGlmIChwYWNrZXQua2VlcGFsaXZlID09PSAtMSkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ1BhY2tldCB0b28gc2hvcnQnKSk7CgogICAgLy8gcGFyc2UgcHJvcGVydGllcwogICAgaWYgKHBhY2tldC5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMuX3BhcnNlUHJvcGVydGllcygpOwogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcGVydGllcykubGVuZ3RoKSB7CiAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgICB9CiAgICB9CiAgICAvLyBQYXJzZSBjbGllbnRJZAogICAgY29uc3QgY2xpZW50SWQgPSB0aGlzLl9wYXJzZVN0cmluZygpOwogICAgaWYgKGNsaWVudElkID09PSBudWxsKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignUGFja2V0IHRvbyBzaG9ydCcpKTsKICAgIHBhY2tldC5jbGllbnRJZCA9IGNsaWVudElkOwogICAgZGVidWckMignX3BhcnNlQ29ubmVjdDogcGFja2V0LmNsaWVudElkOiAlcycsIHBhY2tldC5jbGllbnRJZCk7CiAgICBpZiAoZmxhZ3Mud2lsbCkgewogICAgICBpZiAocGFja2V0LnByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICAgIGNvbnN0IHdpbGxQcm9wZXJ0aWVzID0gdGhpcy5fcGFyc2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHdpbGxQcm9wZXJ0aWVzKS5sZW5ndGgpIHsKICAgICAgICAgIHBhY2tldC53aWxsLnByb3BlcnRpZXMgPSB3aWxsUHJvcGVydGllczsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gUGFyc2Ugd2lsbCB0b3BpYwogICAgICB0b3BpYyA9IHRoaXMuX3BhcnNlU3RyaW5nKCk7CiAgICAgIGlmICh0b3BpYyA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB3aWxsIHRvcGljJykpOwogICAgICBwYWNrZXQud2lsbC50b3BpYyA9IHRvcGljOwogICAgICBkZWJ1ZyQyKCdfcGFyc2VDb25uZWN0OiBwYWNrZXQud2lsbC50b3BpYzogJXMnLCBwYWNrZXQud2lsbC50b3BpYyk7CgogICAgICAvLyBQYXJzZSB3aWxsIHBheWxvYWQKICAgICAgcGF5bG9hZCA9IHRoaXMuX3BhcnNlQnVmZmVyKCk7CiAgICAgIGlmIChwYXlsb2FkID09PSBudWxsKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIHdpbGwgcGF5bG9hZCcpKTsKICAgICAgcGFja2V0LndpbGwucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgIGRlYnVnJDIoJ19wYXJzZUNvbm5lY3Q6IHBhY2tldC53aWxsLnBheWxhb2Q6ICVzJywgcGFja2V0LndpbGwucGF5bG9hZCk7CiAgICB9CgogICAgLy8gUGFyc2UgdXNlcm5hbWUKICAgIGlmIChmbGFncy51c2VybmFtZSkgewogICAgICB1c2VybmFtZSA9IHRoaXMuX3BhcnNlU3RyaW5nKCk7CiAgICAgIGlmICh1c2VybmFtZSA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB1c2VybmFtZScpKTsKICAgICAgcGFja2V0LnVzZXJuYW1lID0gdXNlcm5hbWU7CiAgICAgIGRlYnVnJDIoJ19wYXJzZUNvbm5lY3Q6IHBhY2tldC51c2VybmFtZTogJXMnLCBwYWNrZXQudXNlcm5hbWUpOwogICAgfQoKICAgIC8vIFBhcnNlIHBhc3N3b3JkCiAgICBpZiAoZmxhZ3MucGFzc3dvcmQpIHsKICAgICAgcGFzc3dvcmQgPSB0aGlzLl9wYXJzZUJ1ZmZlcigpOwogICAgICBpZiAocGFzc3dvcmQgPT09IG51bGwpIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdDYW5ub3QgcGFyc2UgcGFzc3dvcmQnKSk7CiAgICAgIHBhY2tldC5wYXNzd29yZCA9IHBhc3N3b3JkOwogICAgfQogICAgLy8gbmVlZCBmb3IgcmlnaHQgcGFyc2UgYXV0aCBwYWNrZXQgYW5kIHNlbGYgc2V0IHVwCiAgICB0aGlzLnNldHRpbmdzID0gcGFja2V0OwogICAgZGVidWckMignX3BhcnNlQ29ubmVjdDogY29tcGxldGUnKTsKICAgIHJldHVybiBwYWNrZXQ7CiAgfQogIF9wYXJzZUNvbm5hY2soKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VDb25uYWNrJyk7CiAgICBjb25zdCBwYWNrZXQgPSB0aGlzLnBhY2tldDsKICAgIGlmICh0aGlzLl9saXN0Lmxlbmd0aCA8IDEpIHJldHVybiBudWxsOwogICAgY29uc3QgZmxhZ3MgPSB0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MrKyk7CiAgICBpZiAoZmxhZ3MgPiAxKSB7CiAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIGNvbm5hY2sgZmxhZ3MsIGJpdHMgNy0xIG11c3QgYmUgc2V0IHRvIDAnKSk7CiAgICB9CiAgICBwYWNrZXQuc2Vzc2lvblByZXNlbnQgPSAhIShmbGFncyAmIGNvbnN0YW50cyQ0LlNFU1NJT05QUkVTRU5UX01BU0spOwogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGlmICh0aGlzLl9saXN0Lmxlbmd0aCA+PSAyKSB7CiAgICAgICAgcGFja2V0LnJlYXNvbkNvZGUgPSB0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MrKyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFja2V0LnJlYXNvbkNvZGUgPSAwOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAodGhpcy5fbGlzdC5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDsKICAgICAgcGFja2V0LnJldHVybkNvZGUgPSB0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MrKyk7CiAgICB9CiAgICBpZiAocGFja2V0LnJldHVybkNvZGUgPT09IC0xIHx8IHBhY2tldC5yZWFzb25Db2RlID09PSAtMSkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSByZXR1cm4gY29kZScpKTsKICAgIC8vIG1xdHQgNSBwcm9wZXJ0aWVzCiAgICBpZiAodGhpcy5zZXR0aW5ncy5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMuX3BhcnNlUHJvcGVydGllcygpOwogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcGVydGllcykubGVuZ3RoKSB7CiAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgICB9CiAgICB9CiAgICBkZWJ1ZyQyKCdfcGFyc2VDb25uYWNrOiBjb21wbGV0ZScpOwogIH0KICBfcGFyc2VQdWJsaXNoKCkgewogICAgZGVidWckMignX3BhcnNlUHVibGlzaCcpOwogICAgY29uc3QgcGFja2V0ID0gdGhpcy5wYWNrZXQ7CiAgICBwYWNrZXQudG9waWMgPSB0aGlzLl9wYXJzZVN0cmluZygpOwogICAgaWYgKHBhY2tldC50b3BpYyA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB0b3BpYycpKTsKCiAgICAvLyBQYXJzZSBtZXNzYWdlSWQKICAgIGlmIChwYWNrZXQucW9zID4gMCkgaWYgKCF0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBQcm9wZXJ0aWVzIG1xdHQgNQogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgfQogICAgcGFja2V0LnBheWxvYWQgPSB0aGlzLl9saXN0LnNsaWNlKHRoaXMuX3BvcywgcGFja2V0Lmxlbmd0aCk7CiAgICBkZWJ1ZyQyKCdfcGFyc2VQdWJsaXNoOiBwYXlsb2FkIGZyb20gYnVmZmVyIGxpc3Q6ICVvJywgcGFja2V0LnBheWxvYWQpOwogIH0KICBfcGFyc2VTdWJzY3JpYmUoKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VTdWJzY3JpYmUnKTsKICAgIGNvbnN0IHBhY2tldCA9IHRoaXMucGFja2V0OwogICAgbGV0IHRvcGljOwogICAgbGV0IG9wdGlvbnM7CiAgICBsZXQgcW9zOwogICAgbGV0IHJoOwogICAgbGV0IHJhcDsKICAgIGxldCBubDsKICAgIGxldCBzdWJzY3JpcHRpb247CiAgICBwYWNrZXQuc3Vic2NyaXB0aW9ucyA9IFtdOwogICAgaWYgKCF0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBQcm9wZXJ0aWVzIG1xdHQgNQogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgfQogICAgaWYgKHBhY2tldC5sZW5ndGggPD0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTWFsZm9ybWVkIHN1YnNjcmliZSwgbm8gcGF5bG9hZCBzcGVjaWZpZWQnKSk7CiAgICB9CiAgICB3aGlsZSAodGhpcy5fcG9zIDwgcGFja2V0Lmxlbmd0aCkgewogICAgICAvLyBQYXJzZSB0b3BpYwogICAgICB0b3BpYyA9IHRoaXMuX3BhcnNlU3RyaW5nKCk7CiAgICAgIGlmICh0b3BpYyA9PT0gbnVsbCkgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB0b3BpYycpKTsKICAgICAgaWYgKHRoaXMuX3BvcyA+PSBwYWNrZXQubGVuZ3RoKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTWFsZm9ybWVkIFN1YnNjcmliZSBQYXlsb2FkJykpOwogICAgICBvcHRpb25zID0gdGhpcy5fcGFyc2VCeXRlKCk7CiAgICAgIGlmICh0aGlzLnNldHRpbmdzLnByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICAgIGlmIChvcHRpb25zICYgMHhjMCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgc3Vic2NyaWJlIHRvcGljIGZsYWcgYml0cywgYml0cyA3LTYgbXVzdCBiZSAwJykpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAob3B0aW9ucyAmIDB4ZmMpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIHN1YnNjcmliZSB0b3BpYyBmbGFnIGJpdHMsIGJpdHMgNy0yIG11c3QgYmUgMCcpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcW9zID0gb3B0aW9ucyAmIGNvbnN0YW50cyQ0LlNVQlNDUklCRV9PUFRJT05TX1FPU19NQVNLOwogICAgICBpZiAocW9zID4gMikgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIHN1YnNjcmliZSBRb1MsIG11c3QgYmUgPD0gMicpKTsKICAgICAgfQogICAgICBubCA9IChvcHRpb25zID4+IGNvbnN0YW50cyQ0LlNVQlNDUklCRV9PUFRJT05TX05MX1NISUZUICYgY29uc3RhbnRzJDQuU1VCU0NSSUJFX09QVElPTlNfTkxfTUFTSykgIT09IDA7CiAgICAgIHJhcCA9IChvcHRpb25zID4+IGNvbnN0YW50cyQ0LlNVQlNDUklCRV9PUFRJT05TX1JBUF9TSElGVCAmIGNvbnN0YW50cyQ0LlNVQlNDUklCRV9PUFRJT05TX1JBUF9NQVNLKSAhPT0gMDsKICAgICAgcmggPSBvcHRpb25zID4+IGNvbnN0YW50cyQ0LlNVQlNDUklCRV9PUFRJT05TX1JIX1NISUZUICYgY29uc3RhbnRzJDQuU1VCU0NSSUJFX09QVElPTlNfUkhfTUFTSzsKICAgICAgaWYgKHJoID4gMikgewogICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIHJldGFpbiBoYW5kbGluZywgbXVzdCBiZSA8PSAyJykpOwogICAgICB9CiAgICAgIHN1YnNjcmlwdGlvbiA9IHsKICAgICAgICB0b3BpYywKICAgICAgICBxb3MKICAgICAgfTsKCiAgICAgIC8vIG1xdHQgNSBvcHRpb25zCiAgICAgIGlmICh0aGlzLnNldHRpbmdzLnByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICAgIHN1YnNjcmlwdGlvbi5ubCA9IG5sOwogICAgICAgIHN1YnNjcmlwdGlvbi5yYXAgPSByYXA7CiAgICAgICAgc3Vic2NyaXB0aW9uLnJoID0gcmg7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXR0aW5ncy5icmlkZ2VNb2RlKSB7CiAgICAgICAgc3Vic2NyaXB0aW9uLnJoID0gMDsKICAgICAgICBzdWJzY3JpcHRpb24ucmFwID0gdHJ1ZTsKICAgICAgICBzdWJzY3JpcHRpb24ubmwgPSB0cnVlOwogICAgICB9CgogICAgICAvLyBQdXNoIHBhaXIgdG8gc3Vic2NyaXB0aW9ucwogICAgICBkZWJ1ZyQyKCdfcGFyc2VTdWJzY3JpYmU6IHB1c2ggc3Vic2NyaXB0aW9uIGAlc2AgdG8gc3Vic2NyaXB0aW9uJywgc3Vic2NyaXB0aW9uKTsKICAgICAgcGFja2V0LnN1YnNjcmlwdGlvbnMucHVzaChzdWJzY3JpcHRpb24pOwogICAgfQogIH0KICBfcGFyc2VTdWJhY2soKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VTdWJhY2snKTsKICAgIGNvbnN0IHBhY2tldCA9IHRoaXMucGFja2V0OwogICAgdGhpcy5wYWNrZXQuZ3JhbnRlZCA9IFtdOwogICAgaWYgKCF0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBQcm9wZXJ0aWVzIG1xdHQgNQogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgfQogICAgaWYgKHBhY2tldC5sZW5ndGggPD0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTWFsZm9ybWVkIHN1YmFjaywgbm8gcGF5bG9hZCBzcGVjaWZpZWQnKSk7CiAgICB9CgogICAgLy8gUGFyc2UgZ3JhbnRlZCBRb1NlcwogICAgd2hpbGUgKHRoaXMuX3BvcyA8IHRoaXMucGFja2V0Lmxlbmd0aCkgewogICAgICBjb25zdCBjb2RlID0gdGhpcy5fbGlzdC5yZWFkVUludDgodGhpcy5fcG9zKyspOwogICAgICBpZiAodGhpcy5zZXR0aW5ncy5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgICAgICBpZiAoIWNvbnN0YW50cyQ0Lk1RVFQ1X1NVQkFDS19DT0RFU1tjb2RlXSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgc3ViYWNrIGNvZGUnKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChjb2RlID4gMiAmJiBjb2RlICE9PSAweDgwKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignSW52YWxpZCBzdWJhY2sgUW9TLCBtdXN0IGJlIDAsIDEsIDIgb3IgMTI4JykpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLnBhY2tldC5ncmFudGVkLnB1c2goY29kZSk7CiAgICB9CiAgfQogIF9wYXJzZVVuc3Vic2NyaWJlKCkgewogICAgZGVidWckMignX3BhcnNlVW5zdWJzY3JpYmUnKTsKICAgIGNvbnN0IHBhY2tldCA9IHRoaXMucGFja2V0OwogICAgcGFja2V0LnVuc3Vic2NyaXB0aW9ucyA9IFtdOwoKICAgIC8vIFBhcnNlIG1lc3NhZ2VJZAogICAgaWYgKCF0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBQcm9wZXJ0aWVzIG1xdHQgNQogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgfQogICAgaWYgKHBhY2tldC5sZW5ndGggPD0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTWFsZm9ybWVkIHVuc3Vic2NyaWJlLCBubyBwYXlsb2FkIHNwZWNpZmllZCcpKTsKICAgIH0KICAgIHdoaWxlICh0aGlzLl9wb3MgPCBwYWNrZXQubGVuZ3RoKSB7CiAgICAgIC8vIFBhcnNlIHRvcGljCiAgICAgIGNvbnN0IHRvcGljID0gdGhpcy5fcGFyc2VTdHJpbmcoKTsKICAgICAgaWYgKHRvcGljID09PSBudWxsKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIHRvcGljJykpOwoKICAgICAgLy8gUHVzaCB0b3BpYyB0byB1bnN1YnNjcmlwdGlvbnMKICAgICAgZGVidWckMignX3BhcnNlVW5zdWJzY3JpYmU6IHB1c2ggdG9waWMgYCVzYCB0byB1bnN1YnNjcmlwdGlvbnMnLCB0b3BpYyk7CiAgICAgIHBhY2tldC51bnN1YnNjcmlwdGlvbnMucHVzaCh0b3BpYyk7CiAgICB9CiAgfQogIF9wYXJzZVVuc3ViYWNrKCkgewogICAgZGVidWckMignX3BhcnNlVW5zdWJhY2snKTsKICAgIGNvbnN0IHBhY2tldCA9IHRoaXMucGFja2V0OwogICAgaWYgKCF0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpKSByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIG1lc3NhZ2VJZCcpKTsKICAgIGlmICgodGhpcy5zZXR0aW5ncy5wcm90b2NvbFZlcnNpb24gPT09IDMgfHwgdGhpcy5zZXR0aW5ncy5wcm90b2NvbFZlcnNpb24gPT09IDQpICYmIHBhY2tldC5sZW5ndGggIT09IDIpIHsKICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ01hbGZvcm1lZCB1bnN1YmFjaywgcGF5bG9hZCBsZW5ndGggbXVzdCBiZSAyJykpOwogICAgfQogICAgaWYgKHBhY2tldC5sZW5ndGggPD0gMCkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTWFsZm9ybWVkIHVuc3ViYWNrLCBubyBwYXlsb2FkIHNwZWNpZmllZCcpKTsKICAgIH0KCiAgICAvLyBQcm9wZXJ0aWVzIG1xdHQgNQogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgICAvLyBQYXJzZSBncmFudGVkIFFvU2VzCiAgICAgIHBhY2tldC5ncmFudGVkID0gW107CiAgICAgIHdoaWxlICh0aGlzLl9wb3MgPCB0aGlzLnBhY2tldC5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb2RlID0gdGhpcy5fbGlzdC5yZWFkVUludDgodGhpcy5fcG9zKyspOwogICAgICAgIGlmICghY29uc3RhbnRzJDQuTVFUVDVfVU5TVUJBQ0tfQ09ERVNbY29kZV0pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkIHVuc3ViYWNrIGNvZGUnKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMucGFja2V0LmdyYW50ZWQucHVzaChjb2RlKTsKICAgICAgfQogICAgfQogIH0KCiAgLy8gcGFyc2UgcGFja2V0cyBsaWtlIHB1YmFjaywgcHVicmVjLCBwdWJyZWwsIHB1YmNvbXAKICBfcGFyc2VDb25maXJtYXRpb24oKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VDb25maXJtYXRpb246IHBhY2tldC5jbWQ6IGAlc2AnLCB0aGlzLnBhY2tldC5jbWQpOwogICAgY29uc3QgcGFja2V0ID0gdGhpcy5wYWNrZXQ7CiAgICB0aGlzLl9wYXJzZU1lc3NhZ2VJZCgpOwogICAgaWYgKHRoaXMuc2V0dGluZ3MucHJvdG9jb2xWZXJzaW9uID09PSA1KSB7CiAgICAgIGlmIChwYWNrZXQubGVuZ3RoID4gMikgewogICAgICAgIC8vIHJlc3BvbnNlIGNvZGUKICAgICAgICBwYWNrZXQucmVhc29uQ29kZSA9IHRoaXMuX3BhcnNlQnl0ZSgpOwogICAgICAgIHN3aXRjaCAodGhpcy5wYWNrZXQuY21kKSB7CiAgICAgICAgICBjYXNlICdwdWJhY2snOgogICAgICAgICAgY2FzZSAncHVicmVjJzoKICAgICAgICAgICAgaWYgKCFjb25zdGFudHMkNC5NUVRUNV9QVUJBQ0tfUFVCUkVDX0NPREVTW3BhY2tldC5yZWFzb25Db2RlXSkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkICcgKyB0aGlzLnBhY2tldC5jbWQgKyAnIHJlYXNvbiBjb2RlJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAncHVicmVsJzoKICAgICAgICAgIGNhc2UgJ3B1YmNvbXAnOgogICAgICAgICAgICBpZiAoIWNvbnN0YW50cyQ0Lk1RVFQ1X1BVQlJFTF9QVUJDT01QX0NPREVTW3BhY2tldC5yZWFzb25Db2RlXSkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbWl0RXJyb3IobmV3IEVycm9yKCdJbnZhbGlkICcgKyB0aGlzLnBhY2tldC5jbWQgKyAnIHJlYXNvbiBjb2RlJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBkZWJ1ZyQyKCdfcGFyc2VDb25maXJtYXRpb246IHBhY2tldC5yZWFzb25Db2RlIGAlZGAnLCBwYWNrZXQucmVhc29uQ29kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFja2V0LnJlYXNvbkNvZGUgPSAwOwogICAgICB9CiAgICAgIGlmIChwYWNrZXQubGVuZ3RoID4gMykgewogICAgICAgIC8vIHByb3BlcmllcyBtcXR0IDUKICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0gdGhpcy5fcGFyc2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BlcnRpZXMpLmxlbmd0aCkgewogICAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLyBwYXJzZSBkaXNjb25uZWN0IHBhY2tldAogIF9wYXJzZURpc2Nvbm5lY3QoKSB7CiAgICBjb25zdCBwYWNrZXQgPSB0aGlzLnBhY2tldDsKICAgIGRlYnVnJDIoJ19wYXJzZURpc2Nvbm5lY3QnKTsKICAgIGlmICh0aGlzLnNldHRpbmdzLnByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICAvLyByZXNwb25zZSBjb2RlCiAgICAgIGlmICh0aGlzLl9saXN0Lmxlbmd0aCA+IDApIHsKICAgICAgICBwYWNrZXQucmVhc29uQ29kZSA9IHRoaXMuX3BhcnNlQnl0ZSgpOwogICAgICAgIGlmICghY29uc3RhbnRzJDQuTVFUVDVfRElTQ09OTkVDVF9DT0RFU1twYWNrZXQucmVhc29uQ29kZV0pIHsKICAgICAgICAgIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgZGlzY29ubmVjdCByZWFzb24gY29kZScpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFja2V0LnJlYXNvbkNvZGUgPSAwOwogICAgICB9CiAgICAgIC8vIHByb3BlcmllcyBtcXR0IDUKICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMuX3BhcnNlUHJvcGVydGllcygpOwogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcGVydGllcykubGVuZ3RoKSB7CiAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgICB9CiAgICB9CiAgICBkZWJ1ZyQyKCdfcGFyc2VEaXNjb25uZWN0IHJlc3VsdDogdHJ1ZScpOwogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvLyBwYXJzZSBhdXRoIHBhY2tldAogIF9wYXJzZUF1dGgoKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VBdXRoJyk7CiAgICBjb25zdCBwYWNrZXQgPSB0aGlzLnBhY2tldDsKICAgIGlmICh0aGlzLnNldHRpbmdzLnByb3RvY29sVmVyc2lvbiAhPT0gNSkgewogICAgICByZXR1cm4gdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignTm90IHN1cHBvcnRlZCBhdXRoIHBhY2tldCBmb3IgdGhpcyB2ZXJzaW9uIE1RVFQnKSk7CiAgICB9CgogICAgLy8gcmVzcG9uc2UgY29kZQogICAgcGFja2V0LnJlYXNvbkNvZGUgPSB0aGlzLl9wYXJzZUJ5dGUoKTsKICAgIGlmICghY29uc3RhbnRzJDQuTVFUVDVfQVVUSF9DT0RFU1twYWNrZXQucmVhc29uQ29kZV0pIHsKICAgICAgcmV0dXJuIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgYXV0aCByZWFzb24gY29kZScpKTsKICAgIH0KICAgIC8vIHByb3BlcmllcyBtcXR0IDUKICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLl9wYXJzZVByb3BlcnRpZXMoKTsKICAgIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wZXJ0aWVzKS5sZW5ndGgpIHsKICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOwogICAgfQogICAgZGVidWckMignX3BhcnNlQXV0aDogcmVzdWx0OiB0cnVlJyk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgX3BhcnNlTWVzc2FnZUlkKCkgewogICAgY29uc3QgcGFja2V0ID0gdGhpcy5wYWNrZXQ7CiAgICBwYWNrZXQubWVzc2FnZUlkID0gdGhpcy5fcGFyc2VOdW0oKTsKICAgIGlmIChwYWNrZXQubWVzc2FnZUlkID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSBtZXNzYWdlSWQnKSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlYnVnJDIoJ19wYXJzZU1lc3NhZ2VJZDogcGFja2V0Lm1lc3NhZ2VJZCAlZCcsIHBhY2tldC5tZXNzYWdlSWQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIF9wYXJzZVN0cmluZyhtYXliZUJ1ZmZlcikgewogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fcGFyc2VOdW0oKTsKICAgIGNvbnN0IGVuZCA9IGxlbmd0aCArIHRoaXMuX3BvczsKICAgIGlmIChsZW5ndGggPT09IC0xIHx8IGVuZCA+IHRoaXMuX2xpc3QubGVuZ3RoIHx8IGVuZCA+IHRoaXMucGFja2V0Lmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9saXN0LnRvU3RyaW5nKCd1dGY4JywgdGhpcy5fcG9zLCBlbmQpOwogICAgdGhpcy5fcG9zICs9IGxlbmd0aDsKICAgIGRlYnVnJDIoJ19wYXJzZVN0cmluZzogcmVzdWx0OiAlcycsIHJlc3VsdCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBfcGFyc2VTdHJpbmdQYWlyKCkgewogICAgZGVidWckMignX3BhcnNlU3RyaW5nUGFpcicpOwogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5fcGFyc2VTdHJpbmcoKSwKICAgICAgdmFsdWU6IHRoaXMuX3BhcnNlU3RyaW5nKCkKICAgIH07CiAgfQogIF9wYXJzZUJ1ZmZlcigpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX3BhcnNlTnVtKCk7CiAgICBjb25zdCBlbmQgPSBsZW5ndGggKyB0aGlzLl9wb3M7CiAgICBpZiAobGVuZ3RoID09PSAtMSB8fCBlbmQgPiB0aGlzLl9saXN0Lmxlbmd0aCB8fCBlbmQgPiB0aGlzLnBhY2tldC5sZW5ndGgpIHJldHVybiBudWxsOwogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fbGlzdC5zbGljZSh0aGlzLl9wb3MsIGVuZCk7CiAgICB0aGlzLl9wb3MgKz0gbGVuZ3RoOwogICAgZGVidWckMignX3BhcnNlQnVmZmVyOiByZXN1bHQ6ICVvJywgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIF9wYXJzZU51bSgpIHsKICAgIGlmICh0aGlzLl9saXN0Lmxlbmd0aCAtIHRoaXMuX3BvcyA8IDIpIHJldHVybiAtMTsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2xpc3QucmVhZFVJbnQxNkJFKHRoaXMuX3Bvcyk7CiAgICB0aGlzLl9wb3MgKz0gMjsKICAgIGRlYnVnJDIoJ19wYXJzZU51bTogcmVzdWx0OiAlcycsIHJlc3VsdCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBfcGFyc2U0Qnl0ZU51bSgpIHsKICAgIGlmICh0aGlzLl9saXN0Lmxlbmd0aCAtIHRoaXMuX3BvcyA8IDQpIHJldHVybiAtMTsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX2xpc3QucmVhZFVJbnQzMkJFKHRoaXMuX3Bvcyk7CiAgICB0aGlzLl9wb3MgKz0gNDsKICAgIGRlYnVnJDIoJ19wYXJzZTRCeXRlTnVtOiByZXN1bHQ6ICVzJywgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIF9wYXJzZVZhckJ5dGVOdW0oZnVsbEluZm9GbGFnKSB7CiAgICBkZWJ1ZyQyKCdfcGFyc2VWYXJCeXRlTnVtJyk7CiAgICBjb25zdCBtYXhCeXRlcyA9IDQ7CiAgICBsZXQgYnl0ZXMgPSAwOwogICAgbGV0IG11bCA9IDE7CiAgICBsZXQgdmFsdWUgPSAwOwogICAgbGV0IHJlc3VsdCA9IGZhbHNlOwogICAgbGV0IGN1cnJlbnQ7CiAgICBjb25zdCBwYWRkaW5nID0gdGhpcy5fcG9zID8gdGhpcy5fcG9zIDogMDsKICAgIHdoaWxlIChieXRlcyA8IG1heEJ5dGVzICYmIHBhZGRpbmcgKyBieXRlcyA8IHRoaXMuX2xpc3QubGVuZ3RoKSB7CiAgICAgIGN1cnJlbnQgPSB0aGlzLl9saXN0LnJlYWRVSW50OChwYWRkaW5nICsgYnl0ZXMrKyk7CiAgICAgIHZhbHVlICs9IG11bCAqIChjdXJyZW50ICYgY29uc3RhbnRzJDQuVkFSQllURUlOVF9NQVNLKTsKICAgICAgbXVsICo9IDB4ODA7CiAgICAgIGlmICgoY3VycmVudCAmIGNvbnN0YW50cyQ0LlZBUkJZVEVJTlRfRklOX01BU0spID09PSAwKSB7CiAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpZiAodGhpcy5fbGlzdC5sZW5ndGggPD0gYnl0ZXMpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKCFyZXN1bHQgJiYgYnl0ZXMgPT09IG1heEJ5dGVzICYmIHRoaXMuX2xpc3QubGVuZ3RoID49IGJ5dGVzKSB7CiAgICAgIHRoaXMuX2VtaXRFcnJvcihuZXcgRXJyb3IoJ0ludmFsaWQgdmFyaWFibGUgYnl0ZSBpbnRlZ2VyJykpOwogICAgfQogICAgaWYgKHBhZGRpbmcpIHsKICAgICAgdGhpcy5fcG9zICs9IGJ5dGVzOwogICAgfQogICAgaWYgKHJlc3VsdCkgewogICAgICBpZiAoZnVsbEluZm9GbGFnKSB7CiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgYnl0ZXMsCiAgICAgICAgICB2YWx1ZQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGZhbHNlOwogICAgfQogICAgZGVidWckMignX3BhcnNlVmFyQnl0ZU51bTogcmVzdWx0OiAlbycsIHJlc3VsdCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBfcGFyc2VCeXRlKCkgewogICAgbGV0IHJlc3VsdDsKICAgIGlmICh0aGlzLl9wb3MgPCB0aGlzLl9saXN0Lmxlbmd0aCkgewogICAgICByZXN1bHQgPSB0aGlzLl9saXN0LnJlYWRVSW50OCh0aGlzLl9wb3MpOwogICAgICB0aGlzLl9wb3MrKzsKICAgIH0KICAgIGRlYnVnJDIoJ19wYXJzZUJ5dGU6IHJlc3VsdDogJW8nLCByZXN1bHQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgX3BhcnNlQnlUeXBlKHR5cGUpIHsKICAgIGRlYnVnJDIoJ19wYXJzZUJ5VHlwZTogdHlwZTogJXMnLCB0eXBlKTsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlICdieXRlJzoKICAgICAgICB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VCeXRlKCkgIT09IDA7CiAgICAgICAgfQogICAgICBjYXNlICdpbnQ4JzoKICAgICAgICB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VCeXRlKCk7CiAgICAgICAgfQogICAgICBjYXNlICdpbnQxNic6CiAgICAgICAgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTnVtKCk7CiAgICAgICAgfQogICAgICBjYXNlICdpbnQzMic6CiAgICAgICAgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlNEJ5dGVOdW0oKTsKICAgICAgICB9CiAgICAgIGNhc2UgJ3Zhcic6CiAgICAgICAgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlVmFyQnl0ZU51bSgpOwogICAgICAgIH0KICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VTdHJpbmcoKTsKICAgICAgICB9CiAgICAgIGNhc2UgJ3BhaXInOgogICAgICAgIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZVN0cmluZ1BhaXIoKTsKICAgICAgICB9CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQnVmZmVyKCk7CiAgICAgICAgfQogICAgfQogIH0KICBfcGFyc2VQcm9wZXJ0aWVzKCkgewogICAgZGVidWckMignX3BhcnNlUHJvcGVydGllcycpOwogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fcGFyc2VWYXJCeXRlTnVtKCk7CiAgICBjb25zdCBzdGFydCA9IHRoaXMuX3BvczsKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgbGVuZ3RoOwogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICB3aGlsZSAodGhpcy5fcG9zIDwgZW5kKSB7CiAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLl9wYXJzZUJ5dGUoKTsKICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIHByb3BlcnR5IGNvZGUgdHlwZScpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY29uc3QgbmFtZSA9IGNvbnN0YW50cyQ0LnByb3BlcnRpZXNDb2Rlc1t0eXBlXTsKICAgICAgaWYgKCFuYW1lKSB7CiAgICAgICAgdGhpcy5fZW1pdEVycm9yKG5ldyBFcnJvcignVW5rbm93biBwcm9wZXJ0eScpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gdXNlciBwcm9wZXJ0aWVzIHByb2Nlc3MKICAgICAgaWYgKG5hbWUgPT09ICd1c2VyUHJvcGVydGllcycpIHsKICAgICAgICBpZiAoIXJlc3VsdFtuYW1lXSkgewogICAgICAgICAgcmVzdWx0W25hbWVdID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3VycmVudFVzZXJQcm9wZXJ0eSA9IHRoaXMuX3BhcnNlQnlUeXBlKGNvbnN0YW50cyQ0LnByb3BlcnRpZXNUeXBlc1tuYW1lXSk7CiAgICAgICAgaWYgKHJlc3VsdFtuYW1lXVtjdXJyZW50VXNlclByb3BlcnR5Lm5hbWVdKSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRbbmFtZV1bY3VycmVudFVzZXJQcm9wZXJ0eS5uYW1lXSkpIHsKICAgICAgICAgICAgcmVzdWx0W25hbWVdW2N1cnJlbnRVc2VyUHJvcGVydHkubmFtZV0ucHVzaChjdXJyZW50VXNlclByb3BlcnR5LnZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IHJlc3VsdFtuYW1lXVtjdXJyZW50VXNlclByb3BlcnR5Lm5hbWVdOwogICAgICAgICAgICByZXN1bHRbbmFtZV1bY3VycmVudFVzZXJQcm9wZXJ0eS5uYW1lXSA9IFtjdXJyZW50VmFsdWVdOwogICAgICAgICAgICByZXN1bHRbbmFtZV1bY3VycmVudFVzZXJQcm9wZXJ0eS5uYW1lXS5wdXNoKGN1cnJlbnRVc2VyUHJvcGVydHkudmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRbbmFtZV1bY3VycmVudFVzZXJQcm9wZXJ0eS5uYW1lXSA9IGN1cnJlbnRVc2VyUHJvcGVydHkudmFsdWU7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChyZXN1bHRbbmFtZV0pIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRbbmFtZV0pKSB7CiAgICAgICAgICByZXN1bHRbbmFtZV0ucHVzaCh0aGlzLl9wYXJzZUJ5VHlwZShjb25zdGFudHMkNC5wcm9wZXJ0aWVzVHlwZXNbbmFtZV0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0W25hbWVdID0gW3Jlc3VsdFtuYW1lXV07CiAgICAgICAgICByZXN1bHRbbmFtZV0ucHVzaCh0aGlzLl9wYXJzZUJ5VHlwZShjb25zdGFudHMkNC5wcm9wZXJ0aWVzVHlwZXNbbmFtZV0pKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W25hbWVdID0gdGhpcy5fcGFyc2VCeVR5cGUoY29uc3RhbnRzJDQucHJvcGVydGllc1R5cGVzW25hbWVdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgX25ld1BhY2tldCgpIHsKICAgIGRlYnVnJDIoJ19uZXdQYWNrZXQnKTsKICAgIGlmICh0aGlzLnBhY2tldCkgewogICAgICB0aGlzLl9saXN0LmNvbnN1bWUodGhpcy5wYWNrZXQubGVuZ3RoKTsKICAgICAgZGVidWckMignX25ld1BhY2tldDogcGFyc2VyIGVtaXQgcGFja2V0OiBwYWNrZXQuY21kOiAlcywgcGFja2V0LnBheWxvYWQ6ICVzLCBwYWNrZXQubGVuZ3RoOiAlZCcsIHRoaXMucGFja2V0LmNtZCwgdGhpcy5wYWNrZXQucGF5bG9hZCwgdGhpcy5wYWNrZXQubGVuZ3RoKTsKICAgICAgdGhpcy5lbWl0KCdwYWNrZXQnLCB0aGlzLnBhY2tldCk7CiAgICB9CiAgICBkZWJ1ZyQyKCdfbmV3UGFja2V0OiBuZXcgcGFja2V0Jyk7CiAgICB0aGlzLnBhY2tldCA9IG5ldyBQYWNrZXQoKTsKICAgIHRoaXMuX3BvcyA9IDA7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgX2VtaXRFcnJvcihlcnIpIHsKICAgIGRlYnVnJDIoJ19lbWl0RXJyb3InLCBlcnIpOwogICAgdGhpcy5lcnJvciA9IGVycjsKICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpOwogIH0KfQp2YXIgcGFyc2VyID0gUGFyc2VyOwoKY29uc3QgewogIEJ1ZmZlcjogQnVmZmVyJDMKfSA9IHJlcXVpcmUkJDAkMzsKY29uc3QgbWF4ID0gNjU1MzY7CmNvbnN0IGNhY2hlJDEgPSB7fTsKCi8vIGluIG5vZGUgNiBCdWZmZXIuc3ViYXJyYXkgcmV0dXJucyBhIFVpbnQ4QXJyYXkgaW5zdGVhZCBvZiBhIEJ1ZmZlcgovLyBsYXRlciB2ZXJzaW9ucyByZXR1cm4gYSBCdWZmZXIKLy8gYWx0ZXJuYXRpdmUgaXMgQnVmZmVyLnNsaWNlIGJ1dCB0aGF0IGNyZWF0ZXMgYSBuZXcgYnVmZmVyCi8vIGNyZWF0aW5nIG5ldyBidWZmZXJzIHRha2VzIHRpbWUKLy8gU3ViT2sgaXMgb25seSBmYWxzZSBvbiBub2RlIDwgOApjb25zdCBTdWJPayA9IEJ1ZmZlciQzLmlzQnVmZmVyKEJ1ZmZlciQzLmZyb20oWzEsIDJdKS5zdWJhcnJheSgwLCAxKSk7CmZ1bmN0aW9uIGdlbmVyYXRlQnVmZmVyKGkpIHsKICBjb25zdCBidWZmZXIgPSBCdWZmZXIkMy5hbGxvY1Vuc2FmZSgyKTsKICBidWZmZXIud3JpdGVVSW50OChpID4+IDgsIDApOwogIGJ1ZmZlci53cml0ZVVJbnQ4KGkgJiAweDAwRkYsIDAgKyAxKTsKICByZXR1cm4gYnVmZmVyOwp9CmZ1bmN0aW9uIGdlbmVyYXRlQ2FjaGUkMSgpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IG1heDsgaSsrKSB7CiAgICBjYWNoZSQxW2ldID0gZ2VuZXJhdGVCdWZmZXIoaSk7CiAgfQp9CmZ1bmN0aW9uIGdlbkJ1ZlZhcmlhYmxlQnl0ZUludCQxKG51bSkgewogIGNvbnN0IG1heExlbmd0aCA9IDQ7IC8vIG1heCA0IGJ5dGVzCiAgbGV0IGRpZ2l0ID0gMDsKICBsZXQgcG9zID0gMDsKICBjb25zdCBidWZmZXIgPSBCdWZmZXIkMy5hbGxvY1Vuc2FmZShtYXhMZW5ndGgpOwogIGRvIHsKICAgIGRpZ2l0ID0gbnVtICUgMTI4IHwgMDsKICAgIG51bSA9IG51bSAvIDEyOCB8IDA7CiAgICBpZiAobnVtID4gMCkgZGlnaXQgPSBkaWdpdCB8IDB4ODA7CiAgICBidWZmZXIud3JpdGVVSW50OChkaWdpdCwgcG9zKyspOwogIH0gd2hpbGUgKG51bSA+IDAgJiYgcG9zIDwgbWF4TGVuZ3RoKTsKICBpZiAobnVtID4gMCkgewogICAgcG9zID0gMDsKICB9CiAgcmV0dXJuIFN1Yk9rID8gYnVmZmVyLnN1YmFycmF5KDAsIHBvcykgOiBidWZmZXIuc2xpY2UoMCwgcG9zKTsKfQpmdW5jdGlvbiBnZW5lcmF0ZTRCeXRlQnVmZmVyJDEobnVtKSB7CiAgY29uc3QgYnVmZmVyID0gQnVmZmVyJDMuYWxsb2NVbnNhZmUoNCk7CiAgYnVmZmVyLndyaXRlVUludDMyQkUobnVtLCAwKTsKICByZXR1cm4gYnVmZmVyOwp9CnZhciBudW1iZXJzJDEgPSB7CiAgY2FjaGU6IGNhY2hlJDEsCiAgZ2VuZXJhdGVDYWNoZTogZ2VuZXJhdGVDYWNoZSQxLAogIGdlbmVyYXRlTnVtYmVyOiBnZW5lcmF0ZUJ1ZmZlciwKICBnZW5CdWZWYXJpYWJsZUJ5dGVJbnQ6IGdlbkJ1ZlZhcmlhYmxlQnl0ZUludCQxLAogIGdlbmVyYXRlNEJ5dGVCdWZmZXI6IGdlbmVyYXRlNEJ5dGVCdWZmZXIkMQp9OwoKdmFyIHByb2Nlc3NOZXh0aWNrQXJncyA9IHtleHBvcnRzOiB7fX07CgppZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnIHx8ICFwcm9jZXNzLnZlcnNpb24gfHwgcHJvY2Vzcy52ZXJzaW9uLmluZGV4T2YoJ3YwLicpID09PSAwIHx8IHByb2Nlc3MudmVyc2lvbi5pbmRleE9mKCd2MS4nKSA9PT0gMCAmJiBwcm9jZXNzLnZlcnNpb24uaW5kZXhPZigndjEuOC4nKSAhPT0gMCkgewogIHByb2Nlc3NOZXh0aWNrQXJncy5leHBvcnRzID0gewogICAgbmV4dFRpY2s6IG5leHRUaWNrJDEKICB9Owp9IGVsc2UgewogIHByb2Nlc3NOZXh0aWNrQXJncy5leHBvcnRzID0gcHJvY2VzczsKfQpmdW5jdGlvbiBuZXh0VGljayQxKGZuLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImNhbGxiYWNrIiBhcmd1bWVudCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICB9CiAgdmFyIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgdmFyIGFyZ3MsIGk7CiAgc3dpdGNoIChsZW4pIHsKICAgIGNhc2UgMDoKICAgIGNhc2UgMToKICAgICAgcmV0dXJuIHByb2Nlc3MubmV4dFRpY2soZm4pOwogICAgY2FzZSAyOgogICAgICByZXR1cm4gcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbiBhZnRlclRpY2tPbmUoKSB7CiAgICAgICAgZm4uY2FsbChudWxsLCBhcmcxKTsKICAgICAgfSk7CiAgICBjYXNlIDM6CiAgICAgIHJldHVybiBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uIGFmdGVyVGlja1R3bygpIHsKICAgICAgICBmbi5jYWxsKG51bGwsIGFyZzEsIGFyZzIpOwogICAgICB9KTsKICAgIGNhc2UgNDoKICAgICAgcmV0dXJuIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24gYWZ0ZXJUaWNrVGhyZWUoKSB7CiAgICAgICAgZm4uY2FsbChudWxsLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgfSk7CiAgICBkZWZhdWx0OgogICAgICBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOwogICAgICBpID0gMDsKICAgICAgd2hpbGUgKGkgPCBhcmdzLmxlbmd0aCkgewogICAgICAgIGFyZ3NbaSsrXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgfQogICAgICByZXR1cm4gcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbiBhZnRlclRpY2soKSB7CiAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgIH0pOwogIH0KfQp2YXIgcHJvY2Vzc05leHRpY2tBcmdzRXhwb3J0cyA9IHByb2Nlc3NOZXh0aWNrQXJncy5leHBvcnRzOwoKY29uc3QgcHJvdG9jb2wgPSBjb25zdGFudHNFeHBvcnRzOwpjb25zdCB7CiAgQnVmZmVyOiBCdWZmZXIkMgp9ID0gcmVxdWlyZSQkMCQzOwpjb25zdCBlbXB0eSA9IEJ1ZmZlciQyLmFsbG9jVW5zYWZlKDApOwpjb25zdCB6ZXJvQnVmID0gQnVmZmVyJDIuZnJvbShbMF0pOwpjb25zdCBudW1iZXJzID0gbnVtYmVycyQxOwpjb25zdCBuZXh0VGljayA9IHByb2Nlc3NOZXh0aWNrQXJnc0V4cG9ydHMubmV4dFRpY2s7CmNvbnN0IGRlYnVnJDEgPSBzcmNFeHBvcnRzKCdtcXR0LXBhY2tldDp3cml0ZVRvU3RyZWFtJyk7CmNvbnN0IG51bUNhY2hlID0gbnVtYmVycy5jYWNoZTsKY29uc3QgZ2VuZXJhdGVOdW1iZXIgPSBudW1iZXJzLmdlbmVyYXRlTnVtYmVyOwpjb25zdCBnZW5lcmF0ZUNhY2hlID0gbnVtYmVycy5nZW5lcmF0ZUNhY2hlOwpjb25zdCBnZW5CdWZWYXJpYWJsZUJ5dGVJbnQgPSBudW1iZXJzLmdlbkJ1ZlZhcmlhYmxlQnl0ZUludDsKY29uc3QgZ2VuZXJhdGU0Qnl0ZUJ1ZmZlciA9IG51bWJlcnMuZ2VuZXJhdGU0Qnl0ZUJ1ZmZlcjsKbGV0IHdyaXRlTnVtYmVyID0gd3JpdGVOdW1iZXJDYWNoZWQ7CmxldCB0b0dlbmVyYXRlID0gdHJ1ZTsKZnVuY3Rpb24gZ2VuZXJhdGUkMShwYWNrZXQsIHN0cmVhbSwgb3B0cykgewogIGRlYnVnJDEoJ2dlbmVyYXRlIGNhbGxlZCcpOwogIGlmIChzdHJlYW0uY29yaykgewogICAgc3RyZWFtLmNvcmsoKTsKICAgIG5leHRUaWNrKHVuY29yaywgc3RyZWFtKTsKICB9CiAgaWYgKHRvR2VuZXJhdGUpIHsKICAgIHRvR2VuZXJhdGUgPSBmYWxzZTsKICAgIGdlbmVyYXRlQ2FjaGUoKTsKICB9CiAgZGVidWckMSgnZ2VuZXJhdGU6IHBhY2tldC5jbWQ6ICVzJywgcGFja2V0LmNtZCk7CiAgc3dpdGNoIChwYWNrZXQuY21kKSB7CiAgICBjYXNlICdjb25uZWN0JzoKICAgICAgcmV0dXJuIGNvbm5lY3QkMihwYWNrZXQsIHN0cmVhbSk7CiAgICBjYXNlICdjb25uYWNrJzoKICAgICAgcmV0dXJuIGNvbm5hY2skMShwYWNrZXQsIHN0cmVhbSwgb3B0cyk7CiAgICBjYXNlICdwdWJsaXNoJzoKICAgICAgcmV0dXJuIHB1Ymxpc2gkMShwYWNrZXQsIHN0cmVhbSwgb3B0cyk7CiAgICBjYXNlICdwdWJhY2snOgogICAgY2FzZSAncHVicmVjJzoKICAgIGNhc2UgJ3B1YnJlbCc6CiAgICBjYXNlICdwdWJjb21wJzoKICAgICAgcmV0dXJuIGNvbmZpcm1hdGlvbihwYWNrZXQsIHN0cmVhbSwgb3B0cyk7CiAgICBjYXNlICdzdWJzY3JpYmUnOgogICAgICByZXR1cm4gc3Vic2NyaWJlKHBhY2tldCwgc3RyZWFtLCBvcHRzKTsKICAgIGNhc2UgJ3N1YmFjayc6CiAgICAgIHJldHVybiBzdWJhY2socGFja2V0LCBzdHJlYW0sIG9wdHMpOwogICAgY2FzZSAndW5zdWJzY3JpYmUnOgogICAgICByZXR1cm4gdW5zdWJzY3JpYmUocGFja2V0LCBzdHJlYW0sIG9wdHMpOwogICAgY2FzZSAndW5zdWJhY2snOgogICAgICByZXR1cm4gdW5zdWJhY2socGFja2V0LCBzdHJlYW0sIG9wdHMpOwogICAgY2FzZSAncGluZ3JlcSc6CiAgICBjYXNlICdwaW5ncmVzcCc6CiAgICAgIHJldHVybiBlbXB0eVBhY2tldChwYWNrZXQsIHN0cmVhbSk7CiAgICBjYXNlICdkaXNjb25uZWN0JzoKICAgICAgcmV0dXJuIGRpc2Nvbm5lY3QocGFja2V0LCBzdHJlYW0sIG9wdHMpOwogICAgY2FzZSAnYXV0aCc6CiAgICAgIHJldHVybiBhdXRoJDEocGFja2V0LCBzdHJlYW0sIG9wdHMpOwogICAgZGVmYXVsdDoKICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdVbmtub3duIGNvbW1hbmQnKSk7CiAgICAgIHJldHVybiBmYWxzZTsKICB9Cn0KLyoqCiAqIENvbnRyb2xzIG51bWJlcnMgY2FjaGUuCiAqIFNldCB0byAiZmFsc2UiIHRvIGFsbG9jYXRlIGJ1ZmZlcnMgb24tdGhlLWZsaWdodCBpbnN0ZWFkIG9mIHByZS1nZW5lcmF0ZWQgY2FjaGUKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShnZW5lcmF0ZSQxLCAnY2FjaGVOdW1iZXJzJywgewogIGdldCgpIHsKICAgIHJldHVybiB3cml0ZU51bWJlciA9PT0gd3JpdGVOdW1iZXJDYWNoZWQ7CiAgfSwKICBzZXQodmFsdWUpIHsKICAgIGlmICh2YWx1ZSkgewogICAgICBpZiAoIW51bUNhY2hlIHx8IE9iamVjdC5rZXlzKG51bUNhY2hlKS5sZW5ndGggPT09IDApIHRvR2VuZXJhdGUgPSB0cnVlOwogICAgICB3cml0ZU51bWJlciA9IHdyaXRlTnVtYmVyQ2FjaGVkOwogICAgfSBlbHNlIHsKICAgICAgdG9HZW5lcmF0ZSA9IGZhbHNlOwogICAgICB3cml0ZU51bWJlciA9IHdyaXRlTnVtYmVyR2VuZXJhdGVkOwogICAgfQogIH0KfSk7CmZ1bmN0aW9uIHVuY29yayhzdHJlYW0pIHsKICBzdHJlYW0udW5jb3JrKCk7Cn0KZnVuY3Rpb24gY29ubmVjdCQyKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgcHJvdG9jb2xJZCA9IHNldHRpbmdzLnByb3RvY29sSWQgfHwgJ01RVFQnOwogIGxldCBwcm90b2NvbFZlcnNpb24gPSBzZXR0aW5ncy5wcm90b2NvbFZlcnNpb24gfHwgNDsKICBjb25zdCB3aWxsID0gc2V0dGluZ3Mud2lsbDsKICBsZXQgY2xlYW4gPSBzZXR0aW5ncy5jbGVhbjsKICBjb25zdCBrZWVwYWxpdmUgPSBzZXR0aW5ncy5rZWVwYWxpdmUgfHwgMDsKICBjb25zdCBjbGllbnRJZCA9IHNldHRpbmdzLmNsaWVudElkIHx8ICcnOwogIGNvbnN0IHVzZXJuYW1lID0gc2V0dGluZ3MudXNlcm5hbWU7CiAgY29uc3QgcGFzc3dvcmQgPSBzZXR0aW5ncy5wYXNzd29yZDsKICAvKiBtcXR0NSBuZXcgb3ByaW9ucyAqLwogIGNvbnN0IHByb3BlcnRpZXMgPSBzZXR0aW5ncy5wcm9wZXJ0aWVzOwogIGlmIChjbGVhbiA9PT0gdW5kZWZpbmVkKSBjbGVhbiA9IHRydWU7CiAgbGV0IGxlbmd0aCA9IDA7CgogIC8vIE11c3QgYmUgYSBzdHJpbmcgYW5kIG5vbi1mYWxzeQogIGlmICghcHJvdG9jb2xJZCB8fCB0eXBlb2YgcHJvdG9jb2xJZCAhPT0gJ3N0cmluZycgJiYgIUJ1ZmZlciQyLmlzQnVmZmVyKHByb3RvY29sSWQpKSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgcHJvdG9jb2xJZCcpKTsKICAgIHJldHVybiBmYWxzZTsKICB9IGVsc2UgbGVuZ3RoICs9IHByb3RvY29sSWQubGVuZ3RoICsgMjsKCiAgLy8gTXVzdCBiZSAzIG9yIDQgb3IgNQogIGlmIChwcm90b2NvbFZlcnNpb24gIT09IDMgJiYgcHJvdG9jb2xWZXJzaW9uICE9PSA0ICYmIHByb3RvY29sVmVyc2lvbiAhPT0gNSkgewogICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIHByb3RvY29sIHZlcnNpb24nKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfSBlbHNlIGxlbmd0aCArPSAxOwoKICAvLyBDbGllbnRJZCBtaWdodCBiZSBvbWl0dGVkIGluIDMuMS4xIGFuZCA1LCBidXQgb25seSBpZiBjbGVhblNlc3Npb24gaXMgc2V0IHRvIDEKICBpZiAoKHR5cGVvZiBjbGllbnRJZCA9PT0gJ3N0cmluZycgfHwgQnVmZmVyJDIuaXNCdWZmZXIoY2xpZW50SWQpKSAmJiAoY2xpZW50SWQgfHwgcHJvdG9jb2xWZXJzaW9uID49IDQpICYmIChjbGllbnRJZCB8fCBjbGVhbikpIHsKICAgIGxlbmd0aCArPSBCdWZmZXIkMi5ieXRlTGVuZ3RoKGNsaWVudElkKSArIDI7CiAgfSBlbHNlIHsKICAgIGlmIChwcm90b2NvbFZlcnNpb24gPCA0KSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignY2xpZW50SWQgbXVzdCBiZSBzdXBwbGllZCBiZWZvcmUgMy4xLjEnKSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChjbGVhbiAqIDEgPT09IDApIHsKICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdjbGllbnRJZCBtdXN0IGJlIGdpdmVuIGlmIGNsZWFuU2Vzc2lvbiBzZXQgdG8gMCcpKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgLy8gTXVzdCBiZSBhIHR3byBieXRlIG51bWJlcgogIGlmICh0eXBlb2Yga2VlcGFsaXZlICE9PSAnbnVtYmVyJyB8fCBrZWVwYWxpdmUgPCAwIHx8IGtlZXBhbGl2ZSA+IDY1NTM1IHx8IGtlZXBhbGl2ZSAlIDEgIT09IDApIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBrZWVwYWxpdmUnKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfSBlbHNlIGxlbmd0aCArPSAyOwoKICAvLyBDb25uZWN0IGZsYWdzCiAgbGVuZ3RoICs9IDE7CiAgbGV0IHByb3BlcnRpZXNEYXRhOwogIGxldCB3aWxsUHJvcGVydGllczsKCiAgLy8gUHJvcGVydGllcwogIGlmIChwcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMpOwogICAgaWYgKCFwcm9wZXJ0aWVzRGF0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsZW5ndGggKz0gcHJvcGVydGllc0RhdGEubGVuZ3RoOwogIH0KCiAgLy8gSWYgd2lsbCBleGlzdHMuLi4KICBpZiAod2lsbCkgewogICAgLy8gSXQgbXVzdCBiZSBhbiBvYmplY3QKICAgIGlmICh0eXBlb2Ygd2lsbCAhPT0gJ29iamVjdCcpIHsKICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIHdpbGwnKSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIEl0IG11c3QgaGF2ZSB0b3BpYyB0eXBlb2Ygc3RyaW5nCiAgICBpZiAoIXdpbGwudG9waWMgfHwgdHlwZW9mIHdpbGwudG9waWMgIT09ICdzdHJpbmcnKSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCB3aWxsIHRvcGljJykpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICBsZW5ndGggKz0gQnVmZmVyJDIuYnl0ZUxlbmd0aCh3aWxsLnRvcGljKSArIDI7CiAgICB9CgogICAgLy8gUGF5bG9hZAogICAgbGVuZ3RoICs9IDI7IC8vIHBheWxvYWQgbGVuZ3RoCiAgICBpZiAod2lsbC5wYXlsb2FkKSB7CiAgICAgIGlmICh3aWxsLnBheWxvYWQubGVuZ3RoID49IDApIHsKICAgICAgICBpZiAodHlwZW9mIHdpbGwucGF5bG9hZCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGxlbmd0aCArPSBCdWZmZXIkMi5ieXRlTGVuZ3RoKHdpbGwucGF5bG9hZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxlbmd0aCArPSB3aWxsLnBheWxvYWQubGVuZ3RoOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgd2lsbCBwYXlsb2FkJykpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgLy8gd2lsbCBwcm9wZXJ0aWVzCiAgICB3aWxsUHJvcGVydGllcyA9IHt9OwogICAgaWYgKHByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICB3aWxsUHJvcGVydGllcyA9IGdldFByb3BlcnRpZXMoc3RyZWFtLCB3aWxsLnByb3BlcnRpZXMpOwogICAgICBpZiAoIXdpbGxQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxlbmd0aCArPSB3aWxsUHJvcGVydGllcy5sZW5ndGg7CiAgICB9CiAgfQoKICAvLyBVc2VybmFtZQogIGxldCBwcm92aWRlZFVzZXJuYW1lID0gZmFsc2U7CiAgaWYgKHVzZXJuYW1lICE9IG51bGwpIHsKICAgIGlmIChpc1N0cmluZ09yQnVmZmVyKHVzZXJuYW1lKSkgewogICAgICBwcm92aWRlZFVzZXJuYW1lID0gdHJ1ZTsKICAgICAgbGVuZ3RoICs9IEJ1ZmZlciQyLmJ5dGVMZW5ndGgodXNlcm5hbWUpICsgMjsKICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCB1c2VybmFtZScpKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgLy8gUGFzc3dvcmQKICBpZiAocGFzc3dvcmQgIT0gbnVsbCkgewogICAgaWYgKCFwcm92aWRlZFVzZXJuYW1lKSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignVXNlcm5hbWUgaXMgcmVxdWlyZWQgdG8gdXNlIHBhc3N3b3JkJykpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoaXNTdHJpbmdPckJ1ZmZlcihwYXNzd29yZCkpIHsKICAgICAgbGVuZ3RoICs9IGJ5dGVMZW5ndGgocGFzc3dvcmQpICsgMjsKICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBwYXNzd29yZCcpKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgaGVhZGVyCiAgc3RyZWFtLndyaXRlKHByb3RvY29sLkNPTk5FQ1RfSEVBREVSKTsKCiAgLy8gR2VuZXJhdGUgbGVuZ3RoCiAgd3JpdGVWYXJCeXRlSW50KHN0cmVhbSwgbGVuZ3RoKTsKCiAgLy8gR2VuZXJhdGUgcHJvdG9jb2wgSUQKICB3cml0ZVN0cmluZ09yQnVmZmVyKHN0cmVhbSwgcHJvdG9jb2xJZCk7CiAgaWYgKHNldHRpbmdzLmJyaWRnZU1vZGUpIHsKICAgIHByb3RvY29sVmVyc2lvbiArPSAxMjg7CiAgfQogIHN0cmVhbS53cml0ZShwcm90b2NvbFZlcnNpb24gPT09IDEzMSA/IHByb3RvY29sLlZFUlNJT04xMzEgOiBwcm90b2NvbFZlcnNpb24gPT09IDEzMiA/IHByb3RvY29sLlZFUlNJT04xMzIgOiBwcm90b2NvbFZlcnNpb24gPT09IDQgPyBwcm90b2NvbC5WRVJTSU9ONCA6IHByb3RvY29sVmVyc2lvbiA9PT0gNSA/IHByb3RvY29sLlZFUlNJT041IDogcHJvdG9jb2wuVkVSU0lPTjMpOwoKICAvLyBDb25uZWN0IGZsYWdzCiAgbGV0IGZsYWdzID0gMDsKICBmbGFncyB8PSB1c2VybmFtZSAhPSBudWxsID8gcHJvdG9jb2wuVVNFUk5BTUVfTUFTSyA6IDA7CiAgZmxhZ3MgfD0gcGFzc3dvcmQgIT0gbnVsbCA/IHByb3RvY29sLlBBU1NXT1JEX01BU0sgOiAwOwogIGZsYWdzIHw9IHdpbGwgJiYgd2lsbC5yZXRhaW4gPyBwcm90b2NvbC5XSUxMX1JFVEFJTl9NQVNLIDogMDsKICBmbGFncyB8PSB3aWxsICYmIHdpbGwucW9zID8gd2lsbC5xb3MgPDwgcHJvdG9jb2wuV0lMTF9RT1NfU0hJRlQgOiAwOwogIGZsYWdzIHw9IHdpbGwgPyBwcm90b2NvbC5XSUxMX0ZMQUdfTUFTSyA6IDA7CiAgZmxhZ3MgfD0gY2xlYW4gPyBwcm90b2NvbC5DTEVBTl9TRVNTSU9OX01BU0sgOiAwOwogIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtmbGFnc10pKTsKCiAgLy8gS2VlcGFsaXZlCiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBrZWVwYWxpdmUpOwoKICAvLyBQcm9wZXJ0aWVzCiAgaWYgKHByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgcHJvcGVydGllc0RhdGEud3JpdGUoKTsKICB9CgogIC8vIENsaWVudCBJRAogIHdyaXRlU3RyaW5nT3JCdWZmZXIoc3RyZWFtLCBjbGllbnRJZCk7CgogIC8vIFdpbGwKICBpZiAod2lsbCkgewogICAgaWYgKHByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICB3aWxsUHJvcGVydGllcy53cml0ZSgpOwogICAgfQogICAgd3JpdGVTdHJpbmcoc3RyZWFtLCB3aWxsLnRvcGljKTsKICAgIHdyaXRlU3RyaW5nT3JCdWZmZXIoc3RyZWFtLCB3aWxsLnBheWxvYWQpOwogIH0KCiAgLy8gVXNlcm5hbWUgYW5kIHBhc3N3b3JkCiAgaWYgKHVzZXJuYW1lICE9IG51bGwpIHsKICAgIHdyaXRlU3RyaW5nT3JCdWZmZXIoc3RyZWFtLCB1c2VybmFtZSk7CiAgfQogIGlmIChwYXNzd29yZCAhPSBudWxsKSB7CiAgICB3cml0ZVN0cmluZ09yQnVmZmVyKHN0cmVhbSwgcGFzc3dvcmQpOwogIH0KICAvLyBUaGlzIGlzIGEgc21hbGwgcGFja2V0IHRoYXQgaGFwcGVucyBvbmx5IG9uY2Ugb24gYSBzdHJlYW0KICAvLyBXZSBhc3N1bWUgdGhlIHN0cmVhbSBpcyBhbHdheXMgZnJlZSB0byByZWNlaXZlIG1vcmUgZGF0YSBhZnRlciB0aGlzCiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY29ubmFjayQxKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgY29uc3QgdmVyc2lvbiA9IG9wdHMgPyBvcHRzLnByb3RvY29sVmVyc2lvbiA6IDQ7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgcmMgPSB2ZXJzaW9uID09PSA1ID8gc2V0dGluZ3MucmVhc29uQ29kZSA6IHNldHRpbmdzLnJldHVybkNvZGU7CiAgY29uc3QgcHJvcGVydGllcyA9IHNldHRpbmdzLnByb3BlcnRpZXM7CiAgbGV0IGxlbmd0aCA9IDI7IC8vIGxlbmd0aCBvZiByYyBhbmQgc2Vzc2lvbkhlYWRlcgoKICAvLyBDaGVjayByZXR1cm4gY29kZQogIGlmICh0eXBlb2YgcmMgIT09ICdudW1iZXInKSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgcmV0dXJuIGNvZGUnKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8vIG1xdHQ1IHByb3BlcnRpZXMKICBsZXQgcHJvcGVydGllc0RhdGEgPSBudWxsOwogIGlmICh2ZXJzaW9uID09PSA1KSB7CiAgICBwcm9wZXJ0aWVzRGF0YSA9IGdldFByb3BlcnRpZXMoc3RyZWFtLCBwcm9wZXJ0aWVzKTsKICAgIGlmICghcHJvcGVydGllc0RhdGEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgbGVuZ3RoICs9IHByb3BlcnRpZXNEYXRhLmxlbmd0aDsKICB9CiAgc3RyZWFtLndyaXRlKHByb3RvY29sLkNPTk5BQ0tfSEVBREVSKTsKICAvLyBsZW5ndGgKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwogIHN0cmVhbS53cml0ZShzZXR0aW5ncy5zZXNzaW9uUHJlc2VudCA/IHByb3RvY29sLlNFU1NJT05QUkVTRU5UX0hFQURFUiA6IHplcm9CdWYpOwogIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtyY10pKTsKICBpZiAocHJvcGVydGllc0RhdGEgIT0gbnVsbCkgewogICAgcHJvcGVydGllc0RhdGEud3JpdGUoKTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gcHVibGlzaCQxKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgZGVidWckMSgncHVibGlzaDogcGFja2V0OiAlbycsIHBhY2tldCk7CiAgY29uc3QgdmVyc2lvbiA9IG9wdHMgPyBvcHRzLnByb3RvY29sVmVyc2lvbiA6IDQ7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgcW9zID0gc2V0dGluZ3MucW9zIHx8IDA7CiAgY29uc3QgcmV0YWluID0gc2V0dGluZ3MucmV0YWluID8gcHJvdG9jb2wuUkVUQUlOX01BU0sgOiAwOwogIGNvbnN0IHRvcGljID0gc2V0dGluZ3MudG9waWM7CiAgY29uc3QgcGF5bG9hZCA9IHNldHRpbmdzLnBheWxvYWQgfHwgZW1wdHk7CiAgY29uc3QgaWQgPSBzZXR0aW5ncy5tZXNzYWdlSWQ7CiAgY29uc3QgcHJvcGVydGllcyA9IHNldHRpbmdzLnByb3BlcnRpZXM7CiAgbGV0IGxlbmd0aCA9IDA7CgogIC8vIFRvcGljIG11c3QgYmUgYSBub24tZW1wdHkgc3RyaW5nIG9yIEJ1ZmZlcgogIGlmICh0eXBlb2YgdG9waWMgPT09ICdzdHJpbmcnKSBsZW5ndGggKz0gQnVmZmVyJDIuYnl0ZUxlbmd0aCh0b3BpYykgKyAyO2Vsc2UgaWYgKEJ1ZmZlciQyLmlzQnVmZmVyKHRvcGljKSkgbGVuZ3RoICs9IHRvcGljLmxlbmd0aCArIDI7ZWxzZSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgdG9waWMnKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvLyBHZXQgdGhlIHBheWxvYWQgbGVuZ3RoCiAgaWYgKCFCdWZmZXIkMi5pc0J1ZmZlcihwYXlsb2FkKSkgbGVuZ3RoICs9IEJ1ZmZlciQyLmJ5dGVMZW5ndGgocGF5bG9hZCk7ZWxzZSBsZW5ndGggKz0gcGF5bG9hZC5sZW5ndGg7CgogIC8vIE1lc3NhZ2UgSUQgbXVzdCBhIG51bWJlciBpZiBxb3MgPiAwCiAgaWYgKHFvcyAmJiB0eXBlb2YgaWQgIT09ICdudW1iZXInKSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgbWVzc2FnZUlkJykpOwogICAgcmV0dXJuIGZhbHNlOwogIH0gZWxzZSBpZiAocW9zKSBsZW5ndGggKz0gMjsKCiAgLy8gbXF0dDUgcHJvcGVydGllcwogIGxldCBwcm9wZXJ0aWVzRGF0YSA9IG51bGw7CiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMpOwogICAgaWYgKCFwcm9wZXJ0aWVzRGF0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsZW5ndGggKz0gcHJvcGVydGllc0RhdGEubGVuZ3RoOwogIH0KCiAgLy8gSGVhZGVyCiAgc3RyZWFtLndyaXRlKHByb3RvY29sLlBVQkxJU0hfSEVBREVSW3Fvc11bc2V0dGluZ3MuZHVwID8gMSA6IDBdW3JldGFpbiA/IDEgOiAwXSk7CgogIC8vIFJlbWFpbmluZyBsZW5ndGgKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwoKICAvLyBUb3BpYwogIHdyaXRlTnVtYmVyKHN0cmVhbSwgYnl0ZUxlbmd0aCh0b3BpYykpOwogIHN0cmVhbS53cml0ZSh0b3BpYyk7CgogIC8vIE1lc3NhZ2UgSUQKICBpZiAocW9zID4gMCkgd3JpdGVOdW1iZXIoc3RyZWFtLCBpZCk7CgogIC8vIFByb3BlcnRpZXMKICBpZiAocHJvcGVydGllc0RhdGEgIT0gbnVsbCkgewogICAgcHJvcGVydGllc0RhdGEud3JpdGUoKTsKICB9CgogIC8vIFBheWxvYWQKICBkZWJ1ZyQxKCdwdWJsaXNoOiBwYXlsb2FkOiAlbycsIHBheWxvYWQpOwogIHJldHVybiBzdHJlYW0ud3JpdGUocGF5bG9hZCk7Cn0KCi8qIFB1YmFjaywgcHVicmVjLCBwdWJyZWwgYW5kIHB1YmNvbXAgKi8KZnVuY3Rpb24gY29uZmlybWF0aW9uKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgY29uc3QgdmVyc2lvbiA9IG9wdHMgPyBvcHRzLnByb3RvY29sVmVyc2lvbiA6IDQ7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgdHlwZSA9IHNldHRpbmdzLmNtZCB8fCAncHViYWNrJzsKICBjb25zdCBpZCA9IHNldHRpbmdzLm1lc3NhZ2VJZDsKICBjb25zdCBkdXAgPSBzZXR0aW5ncy5kdXAgJiYgdHlwZSA9PT0gJ3B1YnJlbCcgPyBwcm90b2NvbC5EVVBfTUFTSyA6IDA7CiAgbGV0IHFvcyA9IDA7CiAgY29uc3QgcmVhc29uQ29kZSA9IHNldHRpbmdzLnJlYXNvbkNvZGU7CiAgY29uc3QgcHJvcGVydGllcyA9IHNldHRpbmdzLnByb3BlcnRpZXM7CiAgbGV0IGxlbmd0aCA9IHZlcnNpb24gPT09IDUgPyAzIDogMjsKICBpZiAodHlwZSA9PT0gJ3B1YnJlbCcpIHFvcyA9IDE7CgogIC8vIENoZWNrIG1lc3NhZ2UgSUQKICBpZiAodHlwZW9mIGlkICE9PSAnbnVtYmVyJykgewogICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIG1lc3NhZ2VJZCcpKTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8vIHByb3BlcmllcyBtcXR0IDUKICBsZXQgcHJvcGVydGllc0RhdGEgPSBudWxsOwogIGlmICh2ZXJzaW9uID09PSA1KSB7CiAgICAvLyBDb25maXJtIHNob3VsZCBub3QgYWRkIGVtcHR5IHByb3BlcnR5IGxlbmd0aCB3aXRoIG5vIHByb3BlcnRpZXMgKHJmYyAzLjQuMi4yLjEpCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT09ICdvYmplY3QnKSB7CiAgICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllc0J5TWF4aW11bVBhY2tldFNpemUoc3RyZWFtLCBwcm9wZXJ0aWVzLCBvcHRzLCBsZW5ndGgpOwogICAgICBpZiAoIXByb3BlcnRpZXNEYXRhKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxlbmd0aCArPSBwcm9wZXJ0aWVzRGF0YS5sZW5ndGg7CiAgICB9CiAgfQoKICAvLyBIZWFkZXIKICBzdHJlYW0ud3JpdGUocHJvdG9jb2wuQUNLU1t0eXBlXVtxb3NdW2R1cF1bMF0pOwoKICAvLyBMZW5ndGggPT09IDMgaXMgb25seSB0cnVlIG9mIHZlcnNpb24gPT09IDUgYW5kIG5vIHByb3BlcnRpZXM7IHRoZXJlZm9yZSBpZiByZWFzb25Db2RlID09PSAwIHdlIGFyZSBhbGxvd2VkIHRvIHNraXAgYm90aCBieXRlcyAtIGJ1dCBpZiB3ZSB3cml0ZSB0aGUgcmVhc29uIGNvZGUgd2UgYWxzbyBoYXZlIHRvIHdyaXRlIHByb3BlcnR5IGxlbmd0aCBbTVFUVC0zLjQuMi0xXS4KICBpZiAobGVuZ3RoID09PSAzKSBsZW5ndGggKz0gcmVhc29uQ29kZSAhPT0gMCA/IDEgOiAtMTsKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwoKICAvLyBNZXNzYWdlIElECiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBpZCk7CgogIC8vIHJlYXNvbiBjb2RlIGluIGhlYWRlciAtIGJ1dCBvbmx5IGlmIGl0IGNvdWxkbid0IGJlIG9taXR0ZWQgLSBpbmRpY2F0ZWQgYnkgbGVuZ3RoICE9PSAyLgogIGlmICh2ZXJzaW9uID09PSA1ICYmIGxlbmd0aCAhPT0gMikgewogICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3JlYXNvbkNvZGVdKSk7CiAgfQoKICAvLyBwcm9wZXJ0aWVzIG1xdHQgNQogIGlmIChwcm9wZXJ0aWVzRGF0YSAhPT0gbnVsbCkgewogICAgcHJvcGVydGllc0RhdGEud3JpdGUoKTsKICB9IGVsc2UgewogICAgaWYgKGxlbmd0aCA9PT0gNCkgewogICAgICAvLyB3ZSBoYXZlIG5vIHByb3BlcnRpZXMgYnV0IGhhdmUgd3JpdHRlbiBhIHJlYXNvbiBjb2RlIC0gc28gd2UgbmVlZCB0byBpbmRpY2F0ZSBlbXB0eSBwcm9wZXJ0aWVzIGJ5IGZpbGxpbmcgaW4gYSB6ZXJvLgogICAgICBzdHJlYW0ud3JpdGUoQnVmZmVyJDIuZnJvbShbMF0pKTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gc3Vic2NyaWJlKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgZGVidWckMSgnc3Vic2NyaWJlOiBwYWNrZXQ6ICcpOwogIGNvbnN0IHZlcnNpb24gPSBvcHRzID8gb3B0cy5wcm90b2NvbFZlcnNpb24gOiA0OwogIGNvbnN0IHNldHRpbmdzID0gcGFja2V0IHx8IHt9OwogIGNvbnN0IGR1cCA9IHNldHRpbmdzLmR1cCA/IHByb3RvY29sLkRVUF9NQVNLIDogMDsKICBjb25zdCBpZCA9IHNldHRpbmdzLm1lc3NhZ2VJZDsKICBjb25zdCBzdWJzID0gc2V0dGluZ3Muc3Vic2NyaXB0aW9uczsKICBjb25zdCBwcm9wZXJ0aWVzID0gc2V0dGluZ3MucHJvcGVydGllczsKICBsZXQgbGVuZ3RoID0gMDsKCiAgLy8gQ2hlY2sgbWVzc2FnZSBJRAogIGlmICh0eXBlb2YgaWQgIT09ICdudW1iZXInKSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgbWVzc2FnZUlkJykpOwogICAgcmV0dXJuIGZhbHNlOwogIH0gZWxzZSBsZW5ndGggKz0gMjsKCiAgLy8gcHJvcGVyaWVzIG1xdHQgNQogIGxldCBwcm9wZXJ0aWVzRGF0YSA9IG51bGw7CiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMpOwogICAgaWYgKCFwcm9wZXJ0aWVzRGF0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsZW5ndGggKz0gcHJvcGVydGllc0RhdGEubGVuZ3RoOwogIH0KCiAgLy8gQ2hlY2sgc3Vic2NyaXB0aW9ucwogIGlmICh0eXBlb2Ygc3VicyA9PT0gJ29iamVjdCcgJiYgc3Vicy5sZW5ndGgpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3Vicy5sZW5ndGg7IGkgKz0gMSkgewogICAgICBjb25zdCBpdG9waWMgPSBzdWJzW2ldLnRvcGljOwogICAgICBjb25zdCBpcW9zID0gc3Vic1tpXS5xb3M7CiAgICAgIGlmICh0eXBlb2YgaXRvcGljICE9PSAnc3RyaW5nJykgewogICAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBzdWJzY3JpcHRpb25zIC0gaW52YWxpZCB0b3BpYycpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBpcW9zICE9PSAnbnVtYmVyJykgewogICAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBzdWJzY3JpcHRpb25zIC0gaW52YWxpZCBxb3MnKSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh2ZXJzaW9uID09PSA1KSB7CiAgICAgICAgY29uc3QgbmwgPSBzdWJzW2ldLm5sIHx8IGZhbHNlOwogICAgICAgIGlmICh0eXBlb2YgbmwgIT09ICdib29sZWFuJykgewogICAgICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIHN1YnNjcmlwdGlvbnMgLSBpbnZhbGlkIE5vIExvY2FsJykpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXAgPSBzdWJzW2ldLnJhcCB8fCBmYWxzZTsKICAgICAgICBpZiAodHlwZW9mIHJhcCAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgc3Vic2NyaXB0aW9ucyAtIGludmFsaWQgUmV0YWluIGFzIFB1Ymxpc2hlZCcpKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmggPSBzdWJzW2ldLnJoIHx8IDA7CiAgICAgICAgaWYgKHR5cGVvZiByaCAhPT0gJ251bWJlcicgfHwgcmggPiAyKSB7CiAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgc3Vic2NyaXB0aW9ucyAtIGludmFsaWQgUmV0YWluIEhhbmRsaW5nJykpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICBsZW5ndGggKz0gQnVmZmVyJDIuYnl0ZUxlbmd0aChpdG9waWMpICsgMiArIDE7CiAgICB9CiAgfSBlbHNlIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBzdWJzY3JpcHRpb25zJykpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gR2VuZXJhdGUgaGVhZGVyCiAgZGVidWckMSgnc3Vic2NyaWJlOiB3cml0aW5nIHRvIHN0cmVhbTogJW8nLCBwcm90b2NvbC5TVUJTQ1JJQkVfSEVBREVSKTsKICBzdHJlYW0ud3JpdGUocHJvdG9jb2wuU1VCU0NSSUJFX0hFQURFUlsxXVtkdXAgPyAxIDogMF1bMF0pOwoKICAvLyBHZW5lcmF0ZSBsZW5ndGgKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwoKICAvLyBHZW5lcmF0ZSBtZXNzYWdlIElECiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBpZCk7CgogIC8vIHByb3BlcmllcyBtcXR0IDUKICBpZiAocHJvcGVydGllc0RhdGEgIT09IG51bGwpIHsKICAgIHByb3BlcnRpZXNEYXRhLndyaXRlKCk7CiAgfQogIGxldCByZXN1bHQgPSB0cnVlOwoKICAvLyBHZW5lcmF0ZSBzdWJzCiAgZm9yIChjb25zdCBzdWIgb2Ygc3VicykgewogICAgY29uc3QganRvcGljID0gc3ViLnRvcGljOwogICAgY29uc3QganFvcyA9IHN1Yi5xb3M7CiAgICBjb25zdCBqbmwgPSArc3ViLm5sOwogICAgY29uc3QganJhcCA9ICtzdWIucmFwOwogICAgY29uc3QganJoID0gc3ViLnJoOwogICAgbGV0IGpvcHRpb25zOwoKICAgIC8vIFdyaXRlIHRvcGljIHN0cmluZwogICAgd3JpdGVTdHJpbmcoc3RyZWFtLCBqdG9waWMpOwoKICAgIC8vIG9wdGlvbnMgcHJvY2VzcwogICAgam9wdGlvbnMgPSBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19RT1NbanFvc107CiAgICBpZiAodmVyc2lvbiA9PT0gNSkgewogICAgICBqb3B0aW9ucyB8PSBqbmwgPyBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19OTCA6IDA7CiAgICAgIGpvcHRpb25zIHw9IGpyYXAgPyBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19SQVAgOiAwOwogICAgICBqb3B0aW9ucyB8PSBqcmggPyBwcm90b2NvbC5TVUJTQ1JJQkVfT1BUSU9OU19SSFtqcmhdIDogMDsKICAgIH0KICAgIC8vIFdyaXRlIG9wdGlvbnMKICAgIHJlc3VsdCA9IHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtqb3B0aW9uc10pKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdWJhY2socGFja2V0LCBzdHJlYW0sIG9wdHMpIHsKICBjb25zdCB2ZXJzaW9uID0gb3B0cyA/IG9wdHMucHJvdG9jb2xWZXJzaW9uIDogNDsKICBjb25zdCBzZXR0aW5ncyA9IHBhY2tldCB8fCB7fTsKICBjb25zdCBpZCA9IHNldHRpbmdzLm1lc3NhZ2VJZDsKICBjb25zdCBncmFudGVkID0gc2V0dGluZ3MuZ3JhbnRlZDsKICBjb25zdCBwcm9wZXJ0aWVzID0gc2V0dGluZ3MucHJvcGVydGllczsKICBsZXQgbGVuZ3RoID0gMDsKCiAgLy8gQ2hlY2sgbWVzc2FnZSBJRAogIGlmICh0eXBlb2YgaWQgIT09ICdudW1iZXInKSB7CiAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgbWVzc2FnZUlkJykpOwogICAgcmV0dXJuIGZhbHNlOwogIH0gZWxzZSBsZW5ndGggKz0gMjsKCiAgLy8gQ2hlY2sgZ3JhbnRlZCBxb3MgdmVjdG9yCiAgaWYgKHR5cGVvZiBncmFudGVkID09PSAnb2JqZWN0JyAmJiBncmFudGVkLmxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFudGVkLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIGlmICh0eXBlb2YgZ3JhbnRlZFtpXSAhPT0gJ251bWJlcicpIHsKICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgcW9zIHZlY3RvcicpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGVuZ3RoICs9IDE7CiAgICB9CiAgfSBlbHNlIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBxb3MgdmVjdG9yJykpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gcHJvcGVyaWVzIG1xdHQgNQogIGxldCBwcm9wZXJ0aWVzRGF0YSA9IG51bGw7CiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllc0J5TWF4aW11bVBhY2tldFNpemUoc3RyZWFtLCBwcm9wZXJ0aWVzLCBvcHRzLCBsZW5ndGgpOwogICAgaWYgKCFwcm9wZXJ0aWVzRGF0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsZW5ndGggKz0gcHJvcGVydGllc0RhdGEubGVuZ3RoOwogIH0KCiAgLy8gaGVhZGVyCiAgc3RyZWFtLndyaXRlKHByb3RvY29sLlNVQkFDS19IRUFERVIpOwoKICAvLyBMZW5ndGgKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwoKICAvLyBNZXNzYWdlIElECiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBpZCk7CgogIC8vIHByb3BlcmllcyBtcXR0IDUKICBpZiAocHJvcGVydGllc0RhdGEgIT09IG51bGwpIHsKICAgIHByb3BlcnRpZXNEYXRhLndyaXRlKCk7CiAgfQogIHJldHVybiBzdHJlYW0ud3JpdGUoQnVmZmVyJDIuZnJvbShncmFudGVkKSk7Cn0KZnVuY3Rpb24gdW5zdWJzY3JpYmUocGFja2V0LCBzdHJlYW0sIG9wdHMpIHsKICBjb25zdCB2ZXJzaW9uID0gb3B0cyA/IG9wdHMucHJvdG9jb2xWZXJzaW9uIDogNDsKICBjb25zdCBzZXR0aW5ncyA9IHBhY2tldCB8fCB7fTsKICBjb25zdCBpZCA9IHNldHRpbmdzLm1lc3NhZ2VJZDsKICBjb25zdCBkdXAgPSBzZXR0aW5ncy5kdXAgPyBwcm90b2NvbC5EVVBfTUFTSyA6IDA7CiAgY29uc3QgdW5zdWJzID0gc2V0dGluZ3MudW5zdWJzY3JpcHRpb25zOwogIGNvbnN0IHByb3BlcnRpZXMgPSBzZXR0aW5ncy5wcm9wZXJ0aWVzOwogIGxldCBsZW5ndGggPSAwOwoKICAvLyBDaGVjayBtZXNzYWdlIElECiAgaWYgKHR5cGVvZiBpZCAhPT0gJ251bWJlcicpIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBtZXNzYWdlSWQnKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfSBlbHNlIHsKICAgIGxlbmd0aCArPSAyOwogIH0KICAvLyBDaGVjayB1bnN1YnMKICBpZiAodHlwZW9mIHVuc3VicyA9PT0gJ29iamVjdCcgJiYgdW5zdWJzLmxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1bnN1YnMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgaWYgKHR5cGVvZiB1bnN1YnNbaV0gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIHVuc3Vic2NyaXB0aW9ucycpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGVuZ3RoICs9IEJ1ZmZlciQyLmJ5dGVMZW5ndGgodW5zdWJzW2ldKSArIDI7CiAgICB9CiAgfSBlbHNlIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCB1bnN1YnNjcmlwdGlvbnMnKSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8vIHByb3BlcmllcyBtcXR0IDUKICBsZXQgcHJvcGVydGllc0RhdGEgPSBudWxsOwogIGlmICh2ZXJzaW9uID09PSA1KSB7CiAgICBwcm9wZXJ0aWVzRGF0YSA9IGdldFByb3BlcnRpZXMoc3RyZWFtLCBwcm9wZXJ0aWVzKTsKICAgIGlmICghcHJvcGVydGllc0RhdGEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgbGVuZ3RoICs9IHByb3BlcnRpZXNEYXRhLmxlbmd0aDsKICB9CgogIC8vIEhlYWRlcgogIHN0cmVhbS53cml0ZShwcm90b2NvbC5VTlNVQlNDUklCRV9IRUFERVJbMV1bZHVwID8gMSA6IDBdWzBdKTsKCiAgLy8gTGVuZ3RoCiAgd3JpdGVWYXJCeXRlSW50KHN0cmVhbSwgbGVuZ3RoKTsKCiAgLy8gTWVzc2FnZSBJRAogIHdyaXRlTnVtYmVyKHN0cmVhbSwgaWQpOwoKICAvLyBwcm9wZXJpZXMgbXF0dCA1CiAgaWYgKHByb3BlcnRpZXNEYXRhICE9PSBudWxsKSB7CiAgICBwcm9wZXJ0aWVzRGF0YS53cml0ZSgpOwogIH0KCiAgLy8gVW5zdWJzCiAgbGV0IHJlc3VsdCA9IHRydWU7CiAgZm9yIChsZXQgaiA9IDA7IGogPCB1bnN1YnMubGVuZ3RoOyBqKyspIHsKICAgIHJlc3VsdCA9IHdyaXRlU3RyaW5nKHN0cmVhbSwgdW5zdWJzW2pdKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiB1bnN1YmFjayhwYWNrZXQsIHN0cmVhbSwgb3B0cykgewogIGNvbnN0IHZlcnNpb24gPSBvcHRzID8gb3B0cy5wcm90b2NvbFZlcnNpb24gOiA0OwogIGNvbnN0IHNldHRpbmdzID0gcGFja2V0IHx8IHt9OwogIGNvbnN0IGlkID0gc2V0dGluZ3MubWVzc2FnZUlkOwogIGNvbnN0IGR1cCA9IHNldHRpbmdzLmR1cCA/IHByb3RvY29sLkRVUF9NQVNLIDogMDsKICBjb25zdCBncmFudGVkID0gc2V0dGluZ3MuZ3JhbnRlZDsKICBjb25zdCBwcm9wZXJ0aWVzID0gc2V0dGluZ3MucHJvcGVydGllczsKICBjb25zdCB0eXBlID0gc2V0dGluZ3MuY21kOwogIGNvbnN0IHFvcyA9IDA7CiAgbGV0IGxlbmd0aCA9IDI7CgogIC8vIENoZWNrIG1lc3NhZ2UgSUQKICBpZiAodHlwZW9mIGlkICE9PSAnbnVtYmVyJykgewogICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIG1lc3NhZ2VJZCcpKTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8vIENoZWNrIGdyYW50ZWQKICBpZiAodmVyc2lvbiA9PT0gNSkgewogICAgaWYgKHR5cGVvZiBncmFudGVkID09PSAnb2JqZWN0JyAmJiBncmFudGVkLmxlbmd0aCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyYW50ZWQubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICBpZiAodHlwZW9mIGdyYW50ZWRbaV0gIT09ICdudW1iZXInKSB7CiAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoJ0ludmFsaWQgcW9zIHZlY3RvcicpKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoICs9IDE7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcignSW52YWxpZCBxb3MgdmVjdG9yJykpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICAvLyBwcm9wZXJpZXMgbXF0dCA1CiAgbGV0IHByb3BlcnRpZXNEYXRhID0gbnVsbDsKICBpZiAodmVyc2lvbiA9PT0gNSkgewogICAgcHJvcGVydGllc0RhdGEgPSBnZXRQcm9wZXJ0aWVzQnlNYXhpbXVtUGFja2V0U2l6ZShzdHJlYW0sIHByb3BlcnRpZXMsIG9wdHMsIGxlbmd0aCk7CiAgICBpZiAoIXByb3BlcnRpZXNEYXRhKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGxlbmd0aCArPSBwcm9wZXJ0aWVzRGF0YS5sZW5ndGg7CiAgfQoKICAvLyBIZWFkZXIKICBzdHJlYW0ud3JpdGUocHJvdG9jb2wuQUNLU1t0eXBlXVtxb3NdW2R1cF1bMF0pOwoKICAvLyBMZW5ndGgKICB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBsZW5ndGgpOwoKICAvLyBNZXNzYWdlIElECiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBpZCk7CgogIC8vIHByb3BlcmllcyBtcXR0IDUKICBpZiAocHJvcGVydGllc0RhdGEgIT09IG51bGwpIHsKICAgIHByb3BlcnRpZXNEYXRhLndyaXRlKCk7CiAgfQoKICAvLyBwYXlsb2FkCiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKGdyYW50ZWQpKTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gZW1wdHlQYWNrZXQocGFja2V0LCBzdHJlYW0sIG9wdHMpIHsKICByZXR1cm4gc3RyZWFtLndyaXRlKHByb3RvY29sLkVNUFRZW3BhY2tldC5jbWRdKTsKfQpmdW5jdGlvbiBkaXNjb25uZWN0KHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgY29uc3QgdmVyc2lvbiA9IG9wdHMgPyBvcHRzLnByb3RvY29sVmVyc2lvbiA6IDQ7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgcmVhc29uQ29kZSA9IHNldHRpbmdzLnJlYXNvbkNvZGU7CiAgY29uc3QgcHJvcGVydGllcyA9IHNldHRpbmdzLnByb3BlcnRpZXM7CiAgbGV0IGxlbmd0aCA9IHZlcnNpb24gPT09IDUgPyAxIDogMDsKCiAgLy8gcHJvcGVyaWVzIG1xdHQgNQogIGxldCBwcm9wZXJ0aWVzRGF0YSA9IG51bGw7CiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllc0J5TWF4aW11bVBhY2tldFNpemUoc3RyZWFtLCBwcm9wZXJ0aWVzLCBvcHRzLCBsZW5ndGgpOwogICAgaWYgKCFwcm9wZXJ0aWVzRGF0YSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsZW5ndGggKz0gcHJvcGVydGllc0RhdGEubGVuZ3RoOwogIH0KCiAgLy8gSGVhZGVyCiAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLmNvZGVzLmRpc2Nvbm5lY3QgPDwgNF0pKTsKCiAgLy8gTGVuZ3RoCiAgd3JpdGVWYXJCeXRlSW50KHN0cmVhbSwgbGVuZ3RoKTsKCiAgLy8gcmVhc29uIGNvZGUgaW4gaGVhZGVyCiAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtyZWFzb25Db2RlXSkpOwogIH0KCiAgLy8gcHJvcGVyaWVzIG1xdHQgNQogIGlmIChwcm9wZXJ0aWVzRGF0YSAhPT0gbnVsbCkgewogICAgcHJvcGVydGllc0RhdGEud3JpdGUoKTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gYXV0aCQxKHBhY2tldCwgc3RyZWFtLCBvcHRzKSB7CiAgY29uc3QgdmVyc2lvbiA9IG9wdHMgPyBvcHRzLnByb3RvY29sVmVyc2lvbiA6IDQ7CiAgY29uc3Qgc2V0dGluZ3MgPSBwYWNrZXQgfHwge307CiAgY29uc3QgcmVhc29uQ29kZSA9IHNldHRpbmdzLnJlYXNvbkNvZGU7CiAgY29uc3QgcHJvcGVydGllcyA9IHNldHRpbmdzLnByb3BlcnRpZXM7CiAgbGV0IGxlbmd0aCA9IHZlcnNpb24gPT09IDUgPyAxIDogMDsKICBpZiAodmVyc2lvbiAhPT0gNSkgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKCdJbnZhbGlkIG1xdHQgdmVyc2lvbiBmb3IgYXV0aCBwYWNrZXQnKSk7CgogIC8vIHByb3BlcmllcyBtcXR0IDUKICBjb25zdCBwcm9wZXJ0aWVzRGF0YSA9IGdldFByb3BlcnRpZXNCeU1heGltdW1QYWNrZXRTaXplKHN0cmVhbSwgcHJvcGVydGllcywgb3B0cywgbGVuZ3RoKTsKICBpZiAoIXByb3BlcnRpZXNEYXRhKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGxlbmd0aCArPSBwcm9wZXJ0aWVzRGF0YS5sZW5ndGg7CgogIC8vIEhlYWRlcgogIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtwcm90b2NvbC5jb2Rlcy5hdXRoIDw8IDRdKSk7CgogIC8vIExlbmd0aAogIHdyaXRlVmFyQnl0ZUludChzdHJlYW0sIGxlbmd0aCk7CgogIC8vIHJlYXNvbiBjb2RlIGluIGhlYWRlcgogIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtyZWFzb25Db2RlXSkpOwoKICAvLyBwcm9wZXJpZXMgbXF0dCA1CiAgaWYgKHByb3BlcnRpZXNEYXRhICE9PSBudWxsKSB7CiAgICBwcm9wZXJ0aWVzRGF0YS53cml0ZSgpOwogIH0KICByZXR1cm4gdHJ1ZTsKfQoKLyoqCiAqIHdyaXRlVmFyQnl0ZUludCAtIHdyaXRlIGFuIE1RVFQgc3R5bGUgdmFyaWFibGUgYnl0ZSBpbnRlZ2VyIHRvIHRoZSBidWZmZXIKICoKICogQHBhcmFtIDxCdWZmZXI+IGJ1ZmZlciAtIGRlc3RpbmF0aW9uCiAqIEBwYXJhbSA8TnVtYmVyPiBwb3MgLSBvZmZzZXQKICogQHBhcmFtIDxOdW1iZXI+IGxlbmd0aCAtIGxlbmd0aCAoPjApCiAqIEByZXR1cm5zIDxOdW1iZXI+IG51bWJlciBvZiBieXRlcyB3cml0dGVuCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KCmNvbnN0IHZhckJ5dGVJbnRDYWNoZSA9IHt9OwpmdW5jdGlvbiB3cml0ZVZhckJ5dGVJbnQoc3RyZWFtLCBudW0pIHsKICBpZiAobnVtID4gcHJvdG9jb2wuVkFSQllURUlOVF9NQVgpIHsKICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcihgSW52YWxpZCB2YXJpYWJsZSBieXRlIGludGVnZXI6ICR7bnVtfWApKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgbGV0IGJ1ZmZlciA9IHZhckJ5dGVJbnRDYWNoZVtudW1dOwogIGlmICghYnVmZmVyKSB7CiAgICBidWZmZXIgPSBnZW5CdWZWYXJpYWJsZUJ5dGVJbnQobnVtKTsKICAgIGlmIChudW0gPCAxNjM4NCkgdmFyQnl0ZUludENhY2hlW251bV0gPSBidWZmZXI7CiAgfQogIGRlYnVnJDEoJ3dyaXRlVmFyQnl0ZUludDogd3JpdGluZyB0byBzdHJlYW06ICVvJywgYnVmZmVyKTsKICByZXR1cm4gc3RyZWFtLndyaXRlKGJ1ZmZlcik7Cn0KCi8qKgogKiB3cml0ZVN0cmluZyAtIHdyaXRlIGEgdXRmOCBzdHJpbmcgdG8gdGhlIGJ1ZmZlcgogKgogKiBAcGFyYW0gPEJ1ZmZlcj4gYnVmZmVyIC0gZGVzdGluYXRpb24KICogQHBhcmFtIDxOdW1iZXI+IHBvcyAtIG9mZnNldAogKiBAcGFyYW0gPFN0cmluZz4gc3RyaW5nIC0gc3RyaW5nIHRvIHdyaXRlCiAqIEByZXR1cm4gPE51bWJlcj4gbnVtYmVyIG9mIGJ5dGVzIHdyaXR0ZW4KICoKICogQGFwaSBwcml2YXRlCiAqLwoKZnVuY3Rpb24gd3JpdGVTdHJpbmcoc3RyZWFtLCBzdHJpbmcpIHsKICBjb25zdCBzdHJsZW4gPSBCdWZmZXIkMi5ieXRlTGVuZ3RoKHN0cmluZyk7CiAgd3JpdGVOdW1iZXIoc3RyZWFtLCBzdHJsZW4pOwogIGRlYnVnJDEoJ3dyaXRlU3RyaW5nOiAlcycsIHN0cmluZyk7CiAgcmV0dXJuIHN0cmVhbS53cml0ZShzdHJpbmcsICd1dGY4Jyk7Cn0KCi8qKgogKiB3cml0ZVN0cmluZ1BhaXIgLSB3cml0ZSBhIHV0Zjggc3RyaW5nIHBhaXJzIHRvIHRoZSBidWZmZXIKICoKICogQHBhcmFtIDxCdWZmZXI+IGJ1ZmZlciAtIGRlc3RpbmF0aW9uCiAqIEBwYXJhbSA8U3RyaW5nPiBuYW1lIC0gc3RyaW5nIG5hbWUgdG8gd3JpdGUKICogQHBhcmFtIDxTdHJpbmc+IHZhbHVlIC0gc3RyaW5nIHZhbHVlIHRvIHdyaXRlCiAqIEByZXR1cm4gPE51bWJlcj4gbnVtYmVyIG9mIGJ5dGVzIHdyaXR0ZW4KICoKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiB3cml0ZVN0cmluZ1BhaXIoc3RyZWFtLCBuYW1lLCB2YWx1ZSkgewogIHdyaXRlU3RyaW5nKHN0cmVhbSwgbmFtZSk7CiAgd3JpdGVTdHJpbmcoc3RyZWFtLCB2YWx1ZSk7Cn0KCi8qKgogKiB3cml0ZU51bWJlciAtIHdyaXRlIGEgdHdvIGJ5dGUgbnVtYmVyIHRvIHRoZSBidWZmZXIKICoKICogQHBhcmFtIDxCdWZmZXI+IGJ1ZmZlciAtIGRlc3RpbmF0aW9uCiAqIEBwYXJhbSA8TnVtYmVyPiBwb3MgLSBvZmZzZXQKICogQHBhcmFtIDxTdHJpbmc+IG51bWJlciAtIG51bWJlciB0byB3cml0ZQogKiBAcmV0dXJuIDxOdW1iZXI+IG51bWJlciBvZiBieXRlcyB3cml0dGVuCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gd3JpdGVOdW1iZXJDYWNoZWQoc3RyZWFtLCBudW1iZXIpIHsKICBkZWJ1ZyQxKCd3cml0ZU51bWJlckNhY2hlZDogbnVtYmVyOiAlZCcsIG51bWJlcik7CiAgZGVidWckMSgnd3JpdGVOdW1iZXJDYWNoZWQ6ICVvJywgbnVtQ2FjaGVbbnVtYmVyXSk7CiAgcmV0dXJuIHN0cmVhbS53cml0ZShudW1DYWNoZVtudW1iZXJdKTsKfQpmdW5jdGlvbiB3cml0ZU51bWJlckdlbmVyYXRlZChzdHJlYW0sIG51bWJlcikgewogIGNvbnN0IGdlbmVyYXRlZE51bWJlciA9IGdlbmVyYXRlTnVtYmVyKG51bWJlcik7CiAgZGVidWckMSgnd3JpdGVOdW1iZXJHZW5lcmF0ZWQ6ICVvJywgZ2VuZXJhdGVkTnVtYmVyKTsKICByZXR1cm4gc3RyZWFtLndyaXRlKGdlbmVyYXRlZE51bWJlcik7Cn0KZnVuY3Rpb24gd3JpdGU0Qnl0ZU51bWJlcihzdHJlYW0sIG51bWJlcikgewogIGNvbnN0IGdlbmVyYXRlZDRCeXRlQnVmZmVyID0gZ2VuZXJhdGU0Qnl0ZUJ1ZmZlcihudW1iZXIpOwogIGRlYnVnJDEoJ3dyaXRlNEJ5dGVOdW1iZXI6ICVvJywgZ2VuZXJhdGVkNEJ5dGVCdWZmZXIpOwogIHJldHVybiBzdHJlYW0ud3JpdGUoZ2VuZXJhdGVkNEJ5dGVCdWZmZXIpOwp9Ci8qKgogKiB3cml0ZVN0cmluZ09yQnVmZmVyIC0gd3JpdGUgYSBTdHJpbmcgb3IgQnVmZmVyIHdpdGggdGhlIGl0cyBsZW5ndGggcHJlZml4CiAqCiAqIEBwYXJhbSA8QnVmZmVyPiBidWZmZXIgLSBkZXN0aW5hdGlvbgogKiBAcGFyYW0gPE51bWJlcj4gcG9zIC0gb2Zmc2V0CiAqIEBwYXJhbSA8U3RyaW5nPiB0b1dyaXRlIC0gU3RyaW5nIG9yIEJ1ZmZlcgogKiBAcmV0dXJuIDxOdW1iZXI+IG51bWJlciBvZiBieXRlcyB3cml0dGVuCiAqLwpmdW5jdGlvbiB3cml0ZVN0cmluZ09yQnVmZmVyKHN0cmVhbSwgdG9Xcml0ZSkgewogIGlmICh0eXBlb2YgdG9Xcml0ZSA9PT0gJ3N0cmluZycpIHsKICAgIHdyaXRlU3RyaW5nKHN0cmVhbSwgdG9Xcml0ZSk7CiAgfSBlbHNlIGlmICh0b1dyaXRlKSB7CiAgICB3cml0ZU51bWJlcihzdHJlYW0sIHRvV3JpdGUubGVuZ3RoKTsKICAgIHN0cmVhbS53cml0ZSh0b1dyaXRlKTsKICB9IGVsc2Ugd3JpdGVOdW1iZXIoc3RyZWFtLCAwKTsKfQpmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKHN0cmVhbSwgcHJvcGVydGllcykgewogIC8qIGNvbm5lY3QgcHJvcGVydGllcyAqLwogIGlmICh0eXBlb2YgcHJvcGVydGllcyAhPT0gJ29iamVjdCcgfHwgcHJvcGVydGllcy5sZW5ndGggIT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgbGVuZ3RoOiAxLAogICAgICB3cml0ZSgpIHsKICAgICAgICB3cml0ZVByb3BlcnRpZXMoc3RyZWFtLCB7fSwgMCk7CiAgICAgIH0KICAgIH07CiAgfQogIGxldCBwcm9wZXJ0aWVzTGVuZ3RoID0gMDsKICBmdW5jdGlvbiBnZXRMZW5ndGhQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgY29uc3QgdHlwZSA9IHByb3RvY29sLnByb3BlcnRpZXNUeXBlc1tuYW1lXTsKICAgIGxldCBsZW5ndGggPSAwOwogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgJ2J5dGUnOgogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdib29sZWFuJykgewogICAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoYEludmFsaWQgJHtuYW1lfTogJHt2YWx1ZX1gKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCArPSAxICsgMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnaW50OCc6CiAgICAgICAgewogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicgfHwgdmFsdWUgPCAwIHx8IHZhbHVlID4gMHhmZikgewogICAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoYEludmFsaWQgJHtuYW1lfTogJHt2YWx1ZX1gKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCArPSAxICsgMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICB7CiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKGBJbnZhbGlkICR7bmFtZX06ICR7dmFsdWV9YCkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBsZW5ndGggKz0gMSArIEJ1ZmZlciQyLmJ5dGVMZW5ndGgodmFsdWUpICsgMjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnaW50MTYnOgogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInIHx8IHZhbHVlIDwgMCB8fCB2YWx1ZSA+IDB4ZmZmZikgewogICAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoYEludmFsaWQgJHtuYW1lfTogJHt2YWx1ZX1gKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCArPSAxICsgMjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnaW50MzInOgogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInIHx8IHZhbHVlIDwgMCB8fCB2YWx1ZSA+IDB4ZmZmZmZmZmYpIHsKICAgICAgICAgICAgc3RyZWFtLmRlc3Ryb3kobmV3IEVycm9yKGBJbnZhbGlkICR7bmFtZX06ICR7dmFsdWV9YCkpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBsZW5ndGggKz0gMSArIDQ7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3Zhcic6CiAgICAgICAgewogICAgICAgICAgLy8gdmFyIGJ5dGUgaW50ZWdlciBpcyBtYXggMjQgYml0cyBwYWNrZWQgaW4gMzIgYml0cwogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicgfHwgdmFsdWUgPCAwIHx8IHZhbHVlID4gMHgwZmZmZmZmZikgewogICAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoYEludmFsaWQgJHtuYW1lfTogJHt2YWx1ZX1gKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCArPSAxICsgQnVmZmVyJDIuYnl0ZUxlbmd0aChnZW5CdWZWYXJpYWJsZUJ5dGVJbnQodmFsdWUpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBzdHJlYW0uZGVzdHJveShuZXcgRXJyb3IoYEludmFsaWQgJHtuYW1lfTogJHt2YWx1ZX1gKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCArPSAxICsgMiArIEJ1ZmZlciQyLmJ5dGVMZW5ndGgodmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3BhaXInOgogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcihgSW52YWxpZCAke25hbWV9OiAke3ZhbHVlfWApKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgbGVuZ3RoICs9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKS5yZWR1Y2UoKHJlc3VsdCwgbmFtZSkgPT4gewogICAgICAgICAgICBjb25zdCBjdXJyZW50VmFsdWUgPSB2YWx1ZVtuYW1lXTsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3VycmVudFZhbHVlKSkgewogICAgICAgICAgICAgIHJlc3VsdCArPSBjdXJyZW50VmFsdWUucmVkdWNlKChjdXJyZW50TGVuZ3RoLCB2YWx1ZSkgPT4gewogICAgICAgICAgICAgICAgY3VycmVudExlbmd0aCArPSAxICsgMiArIEJ1ZmZlciQyLmJ5dGVMZW5ndGgobmFtZS50b1N0cmluZygpKSArIDIgKyBCdWZmZXIkMi5ieXRlTGVuZ3RoKHZhbHVlLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRMZW5ndGg7CiAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0ICs9IDEgKyAyICsgQnVmZmVyJDIuYnl0ZUxlbmd0aChuYW1lLnRvU3RyaW5nKCkpICsgMiArIEJ1ZmZlciQyLmJ5dGVMZW5ndGgodmFsdWVbbmFtZV0udG9TdHJpbmcoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sIDApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHsKICAgICAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcihgSW52YWxpZCBwcm9wZXJ0eSAke25hbWV9OiAke3ZhbHVlfWApKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbGVuZ3RoOwogIH0KICBpZiAocHJvcGVydGllcykgewogICAgZm9yIChjb25zdCBwcm9wTmFtZSBpbiBwcm9wZXJ0aWVzKSB7CiAgICAgIGxldCBwcm9wTGVuZ3RoID0gMDsKICAgICAgbGV0IHByb3BWYWx1ZUxlbmd0aCA9IDA7CiAgICAgIGNvbnN0IHByb3BWYWx1ZSA9IHByb3BlcnRpZXNbcHJvcE5hbWVdOwogICAgICBpZiAocHJvcFZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHByb3BWYWx1ZSkpIHsKICAgICAgICBmb3IgKGxldCB2YWx1ZUluZGV4ID0gMDsgdmFsdWVJbmRleCA8IHByb3BWYWx1ZS5sZW5ndGg7IHZhbHVlSW5kZXgrKykgewogICAgICAgICAgcHJvcFZhbHVlTGVuZ3RoID0gZ2V0TGVuZ3RoUHJvcGVydHkocHJvcE5hbWUsIHByb3BWYWx1ZVt2YWx1ZUluZGV4XSk7CiAgICAgICAgICBpZiAoIXByb3BWYWx1ZUxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcm9wTGVuZ3RoICs9IHByb3BWYWx1ZUxlbmd0aDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvcFZhbHVlTGVuZ3RoID0gZ2V0TGVuZ3RoUHJvcGVydHkocHJvcE5hbWUsIHByb3BWYWx1ZSk7CiAgICAgICAgaWYgKCFwcm9wVmFsdWVMZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcHJvcExlbmd0aCA9IHByb3BWYWx1ZUxlbmd0aDsKICAgICAgfQogICAgICBpZiAoIXByb3BMZW5ndGgpIHJldHVybiBmYWxzZTsKICAgICAgcHJvcGVydGllc0xlbmd0aCArPSBwcm9wTGVuZ3RoOwogICAgfQogIH0KICBjb25zdCBwcm9wZXJ0aWVzTGVuZ3RoTGVuZ3RoID0gQnVmZmVyJDIuYnl0ZUxlbmd0aChnZW5CdWZWYXJpYWJsZUJ5dGVJbnQocHJvcGVydGllc0xlbmd0aCkpOwogIHJldHVybiB7CiAgICBsZW5ndGg6IHByb3BlcnRpZXNMZW5ndGhMZW5ndGggKyBwcm9wZXJ0aWVzTGVuZ3RoLAogICAgd3JpdGUoKSB7CiAgICAgIHdyaXRlUHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMsIHByb3BlcnRpZXNMZW5ndGgpOwogICAgfQogIH07Cn0KZnVuY3Rpb24gZ2V0UHJvcGVydGllc0J5TWF4aW11bVBhY2tldFNpemUoc3RyZWFtLCBwcm9wZXJ0aWVzLCBvcHRzLCBsZW5ndGgpIHsKICBjb25zdCBtYXlFbXB0eVByb3BzID0gWydyZWFzb25TdHJpbmcnLCAndXNlclByb3BlcnRpZXMnXTsKICBjb25zdCBtYXhpbXVtUGFja2V0U2l6ZSA9IG9wdHMgJiYgb3B0cy5wcm9wZXJ0aWVzICYmIG9wdHMucHJvcGVydGllcy5tYXhpbXVtUGFja2V0U2l6ZSA/IG9wdHMucHJvcGVydGllcy5tYXhpbXVtUGFja2V0U2l6ZSA6IDA7CiAgbGV0IHByb3BlcnRpZXNEYXRhID0gZ2V0UHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMpOwogIGlmIChtYXhpbXVtUGFja2V0U2l6ZSkgewogICAgd2hpbGUgKGxlbmd0aCArIHByb3BlcnRpZXNEYXRhLmxlbmd0aCA+IG1heGltdW1QYWNrZXRTaXplKSB7CiAgICAgIGNvbnN0IGN1cnJlbnRNYXlFbXB0eVByb3AgPSBtYXlFbXB0eVByb3BzLnNoaWZ0KCk7CiAgICAgIGlmIChjdXJyZW50TWF5RW1wdHlQcm9wICYmIHByb3BlcnRpZXNbY3VycmVudE1heUVtcHR5UHJvcF0pIHsKICAgICAgICBkZWxldGUgcHJvcGVydGllc1tjdXJyZW50TWF5RW1wdHlQcm9wXTsKICAgICAgICBwcm9wZXJ0aWVzRGF0YSA9IGdldFByb3BlcnRpZXMoc3RyZWFtLCBwcm9wZXJ0aWVzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHByb3BlcnRpZXNEYXRhOwp9CmZ1bmN0aW9uIHdyaXRlUHJvcGVydHkoc3RyZWFtLCBwcm9wTmFtZSwgdmFsdWUpIHsKICBjb25zdCB0eXBlID0gcHJvdG9jb2wucHJvcGVydGllc1R5cGVzW3Byb3BOYW1lXTsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgJ2J5dGUnOgogICAgICB7CiAgICAgICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLnByb3BlcnRpZXNbcHJvcE5hbWVdXSkpOwogICAgICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFsrdmFsdWVdKSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIGNhc2UgJ2ludDgnOgogICAgICB7CiAgICAgICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLnByb3BlcnRpZXNbcHJvcE5hbWVdXSkpOwogICAgICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFt2YWx1ZV0pKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgY2FzZSAnYmluYXJ5JzoKICAgICAgewogICAgICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtwcm90b2NvbC5wcm9wZXJ0aWVzW3Byb3BOYW1lXV0pKTsKICAgICAgICB3cml0ZVN0cmluZ09yQnVmZmVyKHN0cmVhbSwgdmFsdWUpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICBjYXNlICdpbnQxNic6CiAgICAgIHsKICAgICAgICBzdHJlYW0ud3JpdGUoQnVmZmVyJDIuZnJvbShbcHJvdG9jb2wucHJvcGVydGllc1twcm9wTmFtZV1dKSk7CiAgICAgICAgd3JpdGVOdW1iZXIoc3RyZWFtLCB2YWx1ZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIGNhc2UgJ2ludDMyJzoKICAgICAgewogICAgICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtwcm90b2NvbC5wcm9wZXJ0aWVzW3Byb3BOYW1lXV0pKTsKICAgICAgICB3cml0ZTRCeXRlTnVtYmVyKHN0cmVhbSwgdmFsdWUpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICBjYXNlICd2YXInOgogICAgICB7CiAgICAgICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLnByb3BlcnRpZXNbcHJvcE5hbWVdXSkpOwogICAgICAgIHdyaXRlVmFyQnl0ZUludChzdHJlYW0sIHZhbHVlKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgY2FzZSAnc3RyaW5nJzoKICAgICAgewogICAgICAgIHN0cmVhbS53cml0ZShCdWZmZXIkMi5mcm9tKFtwcm90b2NvbC5wcm9wZXJ0aWVzW3Byb3BOYW1lXV0pKTsKICAgICAgICB3cml0ZVN0cmluZyhzdHJlYW0sIHZhbHVlKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgY2FzZSAncGFpcic6CiAgICAgIHsKICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSkuZm9yRWFjaChuYW1lID0+IHsKICAgICAgICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IHZhbHVlW25hbWVdOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3VycmVudFZhbHVlKSkgewogICAgICAgICAgICBjdXJyZW50VmFsdWUuZm9yRWFjaCh2YWx1ZSA9PiB7CiAgICAgICAgICAgICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLnByb3BlcnRpZXNbcHJvcE5hbWVdXSkpOwogICAgICAgICAgICAgIHdyaXRlU3RyaW5nUGFpcihzdHJlYW0sIG5hbWUudG9TdHJpbmcoKSwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyZWFtLndyaXRlKEJ1ZmZlciQyLmZyb20oW3Byb3RvY29sLnByb3BlcnRpZXNbcHJvcE5hbWVdXSkpOwogICAgICAgICAgICB3cml0ZVN0cmluZ1BhaXIoc3RyZWFtLCBuYW1lLnRvU3RyaW5nKCksIGN1cnJlbnRWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgZGVmYXVsdDoKICAgICAgewogICAgICAgIHN0cmVhbS5kZXN0cm95KG5ldyBFcnJvcihgSW52YWxpZCBwcm9wZXJ0eSAke3Byb3BOYW1lfSB2YWx1ZTogJHt2YWx1ZX1gKSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgfQp9CmZ1bmN0aW9uIHdyaXRlUHJvcGVydGllcyhzdHJlYW0sIHByb3BlcnRpZXMsIHByb3BlcnRpZXNMZW5ndGgpIHsKICAvKiB3cml0ZSBwcm9wZXJ0aWVzIHRvIHN0cmVhbSAqLwogIHdyaXRlVmFyQnl0ZUludChzdHJlYW0sIHByb3BlcnRpZXNMZW5ndGgpOwogIGZvciAoY29uc3QgcHJvcE5hbWUgaW4gcHJvcGVydGllcykgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9wZXJ0aWVzLCBwcm9wTmFtZSkgJiYgcHJvcGVydGllc1twcm9wTmFtZV0gIT0gbnVsbCkgewogICAgICBjb25zdCB2YWx1ZSA9IHByb3BlcnRpZXNbcHJvcE5hbWVdOwogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBmb3IgKGxldCB2YWx1ZUluZGV4ID0gMDsgdmFsdWVJbmRleCA8IHZhbHVlLmxlbmd0aDsgdmFsdWVJbmRleCsrKSB7CiAgICAgICAgICB3cml0ZVByb3BlcnR5KHN0cmVhbSwgcHJvcE5hbWUsIHZhbHVlW3ZhbHVlSW5kZXhdKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd3JpdGVQcm9wZXJ0eShzdHJlYW0sIHByb3BOYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICB9Cn0KZnVuY3Rpb24gYnl0ZUxlbmd0aChidWZPclN0cmluZykgewogIGlmICghYnVmT3JTdHJpbmcpIHJldHVybiAwO2Vsc2UgaWYgKGJ1Zk9yU3RyaW5nIGluc3RhbmNlb2YgQnVmZmVyJDIpIHJldHVybiBidWZPclN0cmluZy5sZW5ndGg7ZWxzZSByZXR1cm4gQnVmZmVyJDIuYnl0ZUxlbmd0aChidWZPclN0cmluZyk7Cn0KZnVuY3Rpb24gaXNTdHJpbmdPckJ1ZmZlcihmaWVsZCkgewogIHJldHVybiB0eXBlb2YgZmllbGQgPT09ICdzdHJpbmcnIHx8IGZpZWxkIGluc3RhbmNlb2YgQnVmZmVyJDI7Cn0KdmFyIHdyaXRlVG9TdHJlYW0kMSA9IGdlbmVyYXRlJDE7Cgpjb25zdCB3cml0ZVRvU3RyZWFtID0gd3JpdGVUb1N0cmVhbSQxOwpjb25zdCB7CiAgRXZlbnRFbWl0dGVyOiBFdmVudEVtaXR0ZXIkMQp9ID0gcmVxdWlyZSQkMCQyOwpjb25zdCB7CiAgQnVmZmVyOiBCdWZmZXIkMQp9ID0gcmVxdWlyZSQkMCQzOwpmdW5jdGlvbiBnZW5lcmF0ZShwYWNrZXQsIG9wdHMpIHsKICBjb25zdCBzdHJlYW0gPSBuZXcgQWNjdW11bGF0b3IoKTsKICB3cml0ZVRvU3RyZWFtKHBhY2tldCwgc3RyZWFtLCBvcHRzKTsKICByZXR1cm4gc3RyZWFtLmNvbmNhdCgpOwp9CmNsYXNzIEFjY3VtdWxhdG9yIGV4dGVuZHMgRXZlbnRFbWl0dGVyJDEgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKTsKICAgIHRoaXMuX2FycmF5ID0gbmV3IEFycmF5KDIwKTsKICAgIHRoaXMuX2kgPSAwOwogIH0KICB3cml0ZShjaHVuaykgewogICAgdGhpcy5fYXJyYXlbdGhpcy5faSsrXSA9IGNodW5rOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGNvbmNhdCgpIHsKICAgIGxldCBsZW5ndGggPSAwOwogICAgY29uc3QgbGVuZ3RocyA9IG5ldyBBcnJheSh0aGlzLl9hcnJheS5sZW5ndGgpOwogICAgY29uc3QgbGlzdCA9IHRoaXMuX2FycmF5OwogICAgbGV0IHBvcyA9IDA7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aCAmJiBsaXN0W2ldICE9PSB1bmRlZmluZWQ7IGkrKykgewogICAgICBpZiAodHlwZW9mIGxpc3RbaV0gIT09ICdzdHJpbmcnKSBsZW5ndGhzW2ldID0gbGlzdFtpXS5sZW5ndGg7ZWxzZSBsZW5ndGhzW2ldID0gQnVmZmVyJDEuYnl0ZUxlbmd0aChsaXN0W2ldKTsKICAgICAgbGVuZ3RoICs9IGxlbmd0aHNbaV07CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBCdWZmZXIkMS5hbGxvY1Vuc2FmZShsZW5ndGgpOwogICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoICYmIGxpc3RbaV0gIT09IHVuZGVmaW5lZDsgaSsrKSB7CiAgICAgIGlmICh0eXBlb2YgbGlzdFtpXSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBsaXN0W2ldLmNvcHkocmVzdWx0LCBwb3MpOwogICAgICAgIHBvcyArPSBsZW5ndGhzW2ldOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC53cml0ZShsaXN0W2ldLCBwb3MpOwogICAgICAgIHBvcyArPSBsZW5ndGhzW2ldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBkZXN0cm95KGVycikgewogICAgaWYgKGVycikgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7CiAgfQp9CnZhciBnZW5lcmF0ZV8xID0gZ2VuZXJhdGU7CgptcXR0JDEucGFyc2VyID0gcGFyc2VyLnBhcnNlcjsKbXF0dCQxLmdlbmVyYXRlID0gZ2VuZXJhdGVfMTsKbXF0dCQxLndyaXRlVG9TdHJlYW0gPSB3cml0ZVRvU3RyZWFtJDE7Cgp2YXIgZGVmYXVsdE1lc3NhZ2VJZFByb3ZpZGVyID0ge307CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZGVmYXVsdE1lc3NhZ2VJZFByb3ZpZGVyLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY2xhc3MgRGVmYXVsdE1lc3NhZ2VJZFByb3ZpZGVyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubmV4dElkID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNjU1MzUpKTsKICB9CiAgYWxsb2NhdGUoKSB7CiAgICBjb25zdCBpZCA9IHRoaXMubmV4dElkKys7CiAgICBpZiAodGhpcy5uZXh0SWQgPT09IDY1NTM2KSB7CiAgICAgIHRoaXMubmV4dElkID0gMTsKICAgIH0KICAgIHJldHVybiBpZDsKICB9CiAgZ2V0TGFzdEFsbG9jYXRlZCgpIHsKICAgIHJldHVybiB0aGlzLm5leHRJZCA9PT0gMSA/IDY1NTM1IDogdGhpcy5uZXh0SWQgLSAxOwogIH0KICByZWdpc3RlcihtZXNzYWdlSWQpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBkZWFsbG9jYXRlKG1lc3NhZ2VJZCkge30KICBjbGVhcigpIHt9Cn0KZGVmYXVsdE1lc3NhZ2VJZFByb3ZpZGVyLmRlZmF1bHQgPSBEZWZhdWx0TWVzc2FnZUlkUHJvdmlkZXI7Cgp2YXIgcmZkY18xID0gcmZkYzsKZnVuY3Rpb24gY29weUJ1ZmZlcihjdXIpIHsKICBpZiAoY3VyIGluc3RhbmNlb2YgQnVmZmVyKSB7CiAgICByZXR1cm4gQnVmZmVyLmZyb20oY3VyKTsKICB9CiAgcmV0dXJuIG5ldyBjdXIuY29uc3RydWN0b3IoY3VyLmJ1ZmZlci5zbGljZSgpLCBjdXIuYnl0ZU9mZnNldCwgY3VyLmxlbmd0aCk7Cn0KZnVuY3Rpb24gcmZkYyhvcHRzKSB7CiAgb3B0cyA9IG9wdHMgfHwge307CiAgaWYgKG9wdHMuY2lyY2xlcykgcmV0dXJuIHJmZGNDaXJjbGVzKG9wdHMpOwogIGNvbnN0IGNvbnN0cnVjdG9ySGFuZGxlcnMgPSBuZXcgTWFwKCk7CiAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoRGF0ZSwgbyA9PiBuZXcgRGF0ZShvKSk7CiAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoTWFwLCAobywgZm4pID0+IG5ldyBNYXAoY2xvbmVBcnJheShBcnJheS5mcm9tKG8pLCBmbikpKTsKICBjb25zdHJ1Y3RvckhhbmRsZXJzLnNldChTZXQsIChvLCBmbikgPT4gbmV3IFNldChjbG9uZUFycmF5KEFycmF5LmZyb20obyksIGZuKSkpOwogIGlmIChvcHRzLmNvbnN0cnVjdG9ySGFuZGxlcnMpIHsKICAgIGZvciAoY29uc3QgaGFuZGxlciBvZiBvcHRzLmNvbnN0cnVjdG9ySGFuZGxlcnMpIHsKICAgICAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoaGFuZGxlclswXSwgaGFuZGxlclsxXSk7CiAgICB9CiAgfQogIGxldCBoYW5kbGVyID0gbnVsbDsKICByZXR1cm4gb3B0cy5wcm90byA/IGNsb25lUHJvdG8gOiBjbG9uZTsKICBmdW5jdGlvbiBjbG9uZUFycmF5KGEsIGZuKSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYSk7CiAgICBjb25zdCBhMiA9IG5ldyBBcnJheShrZXlzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgayA9IGtleXNbaV07CiAgICAgIGNvbnN0IGN1ciA9IGFba107CiAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAnb2JqZWN0JyB8fCBjdXIgPT09IG51bGwpIHsKICAgICAgICBhMltrXSA9IGN1cjsKICAgICAgfSBlbHNlIGlmIChjdXIuY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KGN1ci5jb25zdHJ1Y3RvcikpKSB7CiAgICAgICAgYTJba10gPSBoYW5kbGVyKGN1ciwgZm4pOwogICAgICB9IGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhjdXIpKSB7CiAgICAgICAgYTJba10gPSBjb3B5QnVmZmVyKGN1cik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYTJba10gPSBmbihjdXIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYTI7CiAgfQogIGZ1bmN0aW9uIGNsb25lKG8pIHsKICAgIGlmICh0eXBlb2YgbyAhPT0gJ29iamVjdCcgfHwgbyA9PT0gbnVsbCkgcmV0dXJuIG87CiAgICBpZiAoQXJyYXkuaXNBcnJheShvKSkgcmV0dXJuIGNsb25lQXJyYXkobywgY2xvbmUpOwogICAgaWYgKG8uY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KG8uY29uc3RydWN0b3IpKSkgewogICAgICByZXR1cm4gaGFuZGxlcihvLCBjbG9uZSk7CiAgICB9CiAgICBjb25zdCBvMiA9IHt9OwogICAgZm9yIChjb25zdCBrIGluIG8pIHsKICAgICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG8sIGspID09PSBmYWxzZSkgY29udGludWU7CiAgICAgIGNvbnN0IGN1ciA9IG9ba107CiAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAnb2JqZWN0JyB8fCBjdXIgPT09IG51bGwpIHsKICAgICAgICBvMltrXSA9IGN1cjsKICAgICAgfSBlbHNlIGlmIChjdXIuY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KGN1ci5jb25zdHJ1Y3RvcikpKSB7CiAgICAgICAgbzJba10gPSBoYW5kbGVyKGN1ciwgY2xvbmUpOwogICAgICB9IGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhjdXIpKSB7CiAgICAgICAgbzJba10gPSBjb3B5QnVmZmVyKGN1cik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbzJba10gPSBjbG9uZShjdXIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbzI7CiAgfQogIGZ1bmN0aW9uIGNsb25lUHJvdG8obykgewogICAgaWYgKHR5cGVvZiBvICE9PSAnb2JqZWN0JyB8fCBvID09PSBudWxsKSByZXR1cm4gbzsKICAgIGlmIChBcnJheS5pc0FycmF5KG8pKSByZXR1cm4gY2xvbmVBcnJheShvLCBjbG9uZVByb3RvKTsKICAgIGlmIChvLmNvbnN0cnVjdG9yICE9PSBPYmplY3QgJiYgKGhhbmRsZXIgPSBjb25zdHJ1Y3RvckhhbmRsZXJzLmdldChvLmNvbnN0cnVjdG9yKSkpIHsKICAgICAgcmV0dXJuIGhhbmRsZXIobywgY2xvbmVQcm90byk7CiAgICB9CiAgICBjb25zdCBvMiA9IHt9OwogICAgZm9yIChjb25zdCBrIGluIG8pIHsKICAgICAgY29uc3QgY3VyID0gb1trXTsKICAgICAgaWYgKHR5cGVvZiBjdXIgIT09ICdvYmplY3QnIHx8IGN1ciA9PT0gbnVsbCkgewogICAgICAgIG8yW2tdID0gY3VyOwogICAgICB9IGVsc2UgaWYgKGN1ci5jb25zdHJ1Y3RvciAhPT0gT2JqZWN0ICYmIChoYW5kbGVyID0gY29uc3RydWN0b3JIYW5kbGVycy5nZXQoY3VyLmNvbnN0cnVjdG9yKSkpIHsKICAgICAgICBvMltrXSA9IGhhbmRsZXIoY3VyLCBjbG9uZVByb3RvKTsKICAgICAgfSBlbHNlIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoY3VyKSkgewogICAgICAgIG8yW2tdID0gY29weUJ1ZmZlcihjdXIpOwogICAgICB9IGVsc2UgewogICAgICAgIG8yW2tdID0gY2xvbmVQcm90byhjdXIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbzI7CiAgfQp9CmZ1bmN0aW9uIHJmZGNDaXJjbGVzKG9wdHMpIHsKICBjb25zdCByZWZzID0gW107CiAgY29uc3QgcmVmc05ldyA9IFtdOwogIGNvbnN0IGNvbnN0cnVjdG9ySGFuZGxlcnMgPSBuZXcgTWFwKCk7CiAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoRGF0ZSwgbyA9PiBuZXcgRGF0ZShvKSk7CiAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoTWFwLCAobywgZm4pID0+IG5ldyBNYXAoY2xvbmVBcnJheShBcnJheS5mcm9tKG8pLCBmbikpKTsKICBjb25zdHJ1Y3RvckhhbmRsZXJzLnNldChTZXQsIChvLCBmbikgPT4gbmV3IFNldChjbG9uZUFycmF5KEFycmF5LmZyb20obyksIGZuKSkpOwogIGlmIChvcHRzLmNvbnN0cnVjdG9ySGFuZGxlcnMpIHsKICAgIGZvciAoY29uc3QgaGFuZGxlciBvZiBvcHRzLmNvbnN0cnVjdG9ySGFuZGxlcnMpIHsKICAgICAgY29uc3RydWN0b3JIYW5kbGVycy5zZXQoaGFuZGxlclswXSwgaGFuZGxlclsxXSk7CiAgICB9CiAgfQogIGxldCBoYW5kbGVyID0gbnVsbDsKICByZXR1cm4gb3B0cy5wcm90byA/IGNsb25lUHJvdG8gOiBjbG9uZTsKICBmdW5jdGlvbiBjbG9uZUFycmF5KGEsIGZuKSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYSk7CiAgICBjb25zdCBhMiA9IG5ldyBBcnJheShrZXlzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgayA9IGtleXNbaV07CiAgICAgIGNvbnN0IGN1ciA9IGFba107CiAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAnb2JqZWN0JyB8fCBjdXIgPT09IG51bGwpIHsKICAgICAgICBhMltrXSA9IGN1cjsKICAgICAgfSBlbHNlIGlmIChjdXIuY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KGN1ci5jb25zdHJ1Y3RvcikpKSB7CiAgICAgICAgYTJba10gPSBoYW5kbGVyKGN1ciwgZm4pOwogICAgICB9IGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhjdXIpKSB7CiAgICAgICAgYTJba10gPSBjb3B5QnVmZmVyKGN1cik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaW5kZXggPSByZWZzLmluZGV4T2YoY3VyKTsKICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgICBhMltrXSA9IHJlZnNOZXdbaW5kZXhdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhMltrXSA9IGZuKGN1cik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYTI7CiAgfQogIGZ1bmN0aW9uIGNsb25lKG8pIHsKICAgIGlmICh0eXBlb2YgbyAhPT0gJ29iamVjdCcgfHwgbyA9PT0gbnVsbCkgcmV0dXJuIG87CiAgICBpZiAoQXJyYXkuaXNBcnJheShvKSkgcmV0dXJuIGNsb25lQXJyYXkobywgY2xvbmUpOwogICAgaWYgKG8uY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KG8uY29uc3RydWN0b3IpKSkgewogICAgICByZXR1cm4gaGFuZGxlcihvLCBjbG9uZSk7CiAgICB9CiAgICBjb25zdCBvMiA9IHt9OwogICAgcmVmcy5wdXNoKG8pOwogICAgcmVmc05ldy5wdXNoKG8yKTsKICAgIGZvciAoY29uc3QgayBpbiBvKSB7CiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChvLCBrKSA9PT0gZmFsc2UpIGNvbnRpbnVlOwogICAgICBjb25zdCBjdXIgPSBvW2tdOwogICAgICBpZiAodHlwZW9mIGN1ciAhPT0gJ29iamVjdCcgfHwgY3VyID09PSBudWxsKSB7CiAgICAgICAgbzJba10gPSBjdXI7CiAgICAgIH0gZWxzZSBpZiAoY3VyLmNvbnN0cnVjdG9yICE9PSBPYmplY3QgJiYgKGhhbmRsZXIgPSBjb25zdHJ1Y3RvckhhbmRsZXJzLmdldChjdXIuY29uc3RydWN0b3IpKSkgewogICAgICAgIG8yW2tdID0gaGFuZGxlcihjdXIsIGNsb25lKTsKICAgICAgfSBlbHNlIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoY3VyKSkgewogICAgICAgIG8yW2tdID0gY29weUJ1ZmZlcihjdXIpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGkgPSByZWZzLmluZGV4T2YoY3VyKTsKICAgICAgICBpZiAoaSAhPT0gLTEpIHsKICAgICAgICAgIG8yW2tdID0gcmVmc05ld1tpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbzJba10gPSBjbG9uZShjdXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmVmcy5wb3AoKTsKICAgIHJlZnNOZXcucG9wKCk7CiAgICByZXR1cm4gbzI7CiAgfQogIGZ1bmN0aW9uIGNsb25lUHJvdG8obykgewogICAgaWYgKHR5cGVvZiBvICE9PSAnb2JqZWN0JyB8fCBvID09PSBudWxsKSByZXR1cm4gbzsKICAgIGlmIChBcnJheS5pc0FycmF5KG8pKSByZXR1cm4gY2xvbmVBcnJheShvLCBjbG9uZVByb3RvKTsKICAgIGlmIChvLmNvbnN0cnVjdG9yICE9PSBPYmplY3QgJiYgKGhhbmRsZXIgPSBjb25zdHJ1Y3RvckhhbmRsZXJzLmdldChvLmNvbnN0cnVjdG9yKSkpIHsKICAgICAgcmV0dXJuIGhhbmRsZXIobywgY2xvbmVQcm90byk7CiAgICB9CiAgICBjb25zdCBvMiA9IHt9OwogICAgcmVmcy5wdXNoKG8pOwogICAgcmVmc05ldy5wdXNoKG8yKTsKICAgIGZvciAoY29uc3QgayBpbiBvKSB7CiAgICAgIGNvbnN0IGN1ciA9IG9ba107CiAgICAgIGlmICh0eXBlb2YgY3VyICE9PSAnb2JqZWN0JyB8fCBjdXIgPT09IG51bGwpIHsKICAgICAgICBvMltrXSA9IGN1cjsKICAgICAgfSBlbHNlIGlmIChjdXIuY29uc3RydWN0b3IgIT09IE9iamVjdCAmJiAoaGFuZGxlciA9IGNvbnN0cnVjdG9ySGFuZGxlcnMuZ2V0KGN1ci5jb25zdHJ1Y3RvcikpKSB7CiAgICAgICAgbzJba10gPSBoYW5kbGVyKGN1ciwgY2xvbmVQcm90byk7CiAgICAgIH0gZWxzZSBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGN1cikpIHsKICAgICAgICBvMltrXSA9IGNvcHlCdWZmZXIoY3VyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBpID0gcmVmcy5pbmRleE9mKGN1cik7CiAgICAgICAgaWYgKGkgIT09IC0xKSB7CiAgICAgICAgICBvMltrXSA9IHJlZnNOZXdbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG8yW2tdID0gY2xvbmVQcm90byhjdXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmVmcy5wb3AoKTsKICAgIHJlZnNOZXcucG9wKCk7CiAgICByZXR1cm4gbzI7CiAgfQp9Cgp2YXIgX2RlZmF1bHQgPSByZmRjXzEoKTsKCnZhciB2YWxpZGF0aW9ucyQxID0ge307CgpPYmplY3QuZGVmaW5lUHJvcGVydHkodmFsaWRhdGlvbnMkMSwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CnZhbGlkYXRpb25zJDEudmFsaWRhdGVUb3BpYyA9IHZhbGlkYXRlVG9waWM7CnZhbGlkYXRpb25zJDEudmFsaWRhdGVUb3BpY3MgPSB2YWxpZGF0ZVRvcGljczsKZnVuY3Rpb24gdmFsaWRhdGVUb3BpYyh0b3BpYykgewogIGNvbnN0IHBhcnRzID0gdG9waWMuc3BsaXQoJy8nKTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAocGFydHNbaV0gPT09ICcrJykgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGlmIChwYXJ0c1tpXSA9PT0gJyMnKSB7CiAgICAgIHJldHVybiBpID09PSBwYXJ0cy5sZW5ndGggLSAxOwogICAgfQogICAgaWYgKHBhcnRzW2ldLmluZGV4T2YoJysnKSAhPT0gLTEgfHwgcGFydHNbaV0uaW5kZXhPZignIycpICE9PSAtMSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbGlkYXRlVG9waWNzKHRvcGljcykgewogIGlmICh0b3BpY3MubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gJ2VtcHR5X3RvcGljX2xpc3QnOwogIH0KICBmb3IgKGxldCBpID0gMDsgaSA8IHRvcGljcy5sZW5ndGg7IGkrKykgewogICAgaWYgKCF2YWxpZGF0ZVRvcGljKHRvcGljc1tpXSkpIHsKICAgICAgcmV0dXJuIHRvcGljc1tpXTsKICAgIH0KICB9CiAgcmV0dXJuIG51bGw7Cn0KCnZhciBzdG9yZSA9IHt9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHN0b3JlLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY29uc3QgcmVhZGFibGVfc3RyZWFtXzEkMSA9IG91cnNFeHBvcnRzOwpjb25zdCBzdHJlYW1zT3B0cyA9IHsKICBvYmplY3RNb2RlOiB0cnVlCn07CmNvbnN0IGRlZmF1bHRTdG9yZU9wdGlvbnMgPSB7CiAgY2xlYW46IHRydWUKfTsKY2xhc3MgU3RvcmUgewogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRTdG9yZU9wdGlvbnMpLCBvcHRpb25zKTsKICAgIHRoaXMuX2luZmxpZ2h0cyA9IG5ldyBNYXAoKTsKICB9CiAgcHV0KHBhY2tldCwgY2IpIHsKICAgIHRoaXMuX2luZmxpZ2h0cy5zZXQocGFja2V0Lm1lc3NhZ2VJZCwgcGFja2V0KTsKICAgIGlmIChjYikgewogICAgICBjYigpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNyZWF0ZVN0cmVhbSgpIHsKICAgIGNvbnN0IHN0cmVhbSA9IG5ldyByZWFkYWJsZV9zdHJlYW1fMSQxLlJlYWRhYmxlKHN0cmVhbXNPcHRzKTsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgbGV0IGRlc3Ryb3llZCA9IGZhbHNlOwogICAgbGV0IGkgPSAwOwogICAgdGhpcy5faW5mbGlnaHRzLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHsKICAgICAgdmFsdWVzLnB1c2godmFsdWUpOwogICAgfSk7CiAgICBzdHJlYW0uX3JlYWQgPSAoKSA9PiB7CiAgICAgIGlmICghZGVzdHJveWVkICYmIGkgPCB2YWx1ZXMubGVuZ3RoKSB7CiAgICAgICAgc3RyZWFtLnB1c2godmFsdWVzW2krK10pOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbS5wdXNoKG51bGwpOwogICAgICB9CiAgICB9OwogICAgc3RyZWFtLmRlc3Ryb3kgPSBlcnIgPT4gewogICAgICBpZiAoZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRlc3Ryb3llZCA9IHRydWU7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHN0cmVhbS5lbWl0KCdjbG9zZScpOwogICAgICB9LCAwKTsKICAgICAgcmV0dXJuIHN0cmVhbTsKICAgIH07CiAgICByZXR1cm4gc3RyZWFtOwogIH0KICBkZWwocGFja2V0LCBjYikgewogICAgY29uc3QgdG9EZWxldGUgPSB0aGlzLl9pbmZsaWdodHMuZ2V0KHBhY2tldC5tZXNzYWdlSWQpOwogICAgaWYgKHRvRGVsZXRlKSB7CiAgICAgIHRoaXMuX2luZmxpZ2h0cy5kZWxldGUocGFja2V0Lm1lc3NhZ2VJZCk7CiAgICAgIGNiKG51bGwsIHRvRGVsZXRlKTsKICAgIH0gZWxzZSBpZiAoY2IpIHsKICAgICAgY2IobmV3IEVycm9yKCdtaXNzaW5nIHBhY2tldCcpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBnZXQocGFja2V0LCBjYikgewogICAgY29uc3Qgc3RvcmVkUGFja2V0ID0gdGhpcy5faW5mbGlnaHRzLmdldChwYWNrZXQubWVzc2FnZUlkKTsKICAgIGlmIChzdG9yZWRQYWNrZXQpIHsKICAgICAgY2IobnVsbCwgc3RvcmVkUGFja2V0KTsKICAgIH0gZWxzZSBpZiAoY2IpIHsKICAgICAgY2IobmV3IEVycm9yKCdtaXNzaW5nIHBhY2tldCcpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBjbG9zZShjYikgewogICAgaWYgKHRoaXMub3B0aW9ucy5jbGVhbikgewogICAgICB0aGlzLl9pbmZsaWdodHMgPSBudWxsOwogICAgfQogICAgaWYgKGNiKSB7CiAgICAgIGNiKCk7CiAgICB9CiAgfQp9CnN0b3JlLmRlZmF1bHQgPSBTdG9yZTsKCnZhciBoYW5kbGVycyA9IHt9OwoKdmFyIHB1Ymxpc2ggPSB7fTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShwdWJsaXNoLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY29uc3QgdmFsaWRSZWFzb25Db2RlcyA9IFswLCAxNiwgMTI4LCAxMzEsIDEzNSwgMTQ0LCAxNDUsIDE1MSwgMTUzXTsKY29uc3QgaGFuZGxlUHVibGlzaCA9IChjbGllbnQsIHBhY2tldCwgZG9uZSkgPT4gewogIGNsaWVudC5sb2coJ2hhbmRsZVB1Ymxpc2g6IHBhY2tldCAlbycsIHBhY2tldCk7CiAgZG9uZSA9IHR5cGVvZiBkb25lICE9PSAndW5kZWZpbmVkJyA/IGRvbmUgOiBjbGllbnQubm9vcDsKICBsZXQgdG9waWMgPSBwYWNrZXQudG9waWMudG9TdHJpbmcoKTsKICBjb25zdCBtZXNzYWdlID0gcGFja2V0LnBheWxvYWQ7CiAgY29uc3QgewogICAgcW9zCiAgfSA9IHBhY2tldDsKICBjb25zdCB7CiAgICBtZXNzYWdlSWQKICB9ID0gcGFja2V0OwogIGNvbnN0IHsKICAgIG9wdGlvbnMKICB9ID0gY2xpZW50OwogIGlmIChjbGllbnQub3B0aW9ucy5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgIGxldCBhbGlhczsKICAgIGlmIChwYWNrZXQucHJvcGVydGllcykgewogICAgICBhbGlhcyA9IHBhY2tldC5wcm9wZXJ0aWVzLnRvcGljQWxpYXM7CiAgICB9CiAgICBpZiAodHlwZW9mIGFsaWFzICE9PSAndW5kZWZpbmVkJykgewogICAgICBpZiAodG9waWMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKGFsaWFzID4gMCAmJiBhbGlhcyA8PSAweGZmZmYpIHsKICAgICAgICAgIGNvbnN0IGdvdFRvcGljID0gY2xpZW50Wyd0b3BpY0FsaWFzUmVjdiddLmdldFRvcGljQnlBbGlhcyhhbGlhcyk7CiAgICAgICAgICBpZiAoZ290VG9waWMpIHsKICAgICAgICAgICAgdG9waWMgPSBnb3RUb3BpYzsKICAgICAgICAgICAgY2xpZW50LmxvZygnaGFuZGxlUHVibGlzaCA6OiB0b3BpYyBjb21wbGVtZW50ZWQgYnkgYWxpYXMuIHRvcGljOiAlcyAtIGFsaWFzOiAlZCcsIHRvcGljLCBhbGlhcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjbGllbnQubG9nKCdoYW5kbGVQdWJsaXNoIDo6IHVucmVnaXN0ZXJlZCB0b3BpYyBhbGlhcy4gYWxpYXM6ICVkJywgYWxpYXMpOwogICAgICAgICAgICBjbGllbnQuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ1JlY2VpdmVkIHVucmVnaXN0ZXJlZCBUb3BpYyBBbGlhcycpKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjbGllbnQubG9nKCdoYW5kbGVQdWJsaXNoIDo6IHRvcGljIGFsaWFzIG91dCBvZiByYW5nZS4gYWxpYXM6ICVkJywgYWxpYXMpOwogICAgICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdSZWNlaXZlZCBUb3BpYyBBbGlhcyBpcyBvdXQgb2YgcmFuZ2UnKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNsaWVudFsndG9waWNBbGlhc1JlY3YnXS5wdXQodG9waWMsIGFsaWFzKSkgewogICAgICAgIGNsaWVudC5sb2coJ2hhbmRsZVB1Ymxpc2ggOjogcmVnaXN0ZXJlZCB0b3BpYzogJXMgLSBhbGlhczogJWQnLCB0b3BpYywgYWxpYXMpOwogICAgICB9IGVsc2UgewogICAgICAgIGNsaWVudC5sb2coJ2hhbmRsZVB1Ymxpc2ggOjogdG9waWMgYWxpYXMgb3V0IG9mIHJhbmdlLiBhbGlhczogJWQnLCBhbGlhcyk7CiAgICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdSZWNlaXZlZCBUb3BpYyBBbGlhcyBpcyBvdXQgb2YgcmFuZ2UnKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQogIGNsaWVudC5sb2coJ2hhbmRsZVB1Ymxpc2g6IHFvcyAlZCcsIHFvcyk7CiAgc3dpdGNoIChxb3MpIHsKICAgIGNhc2UgMjoKICAgICAgewogICAgICAgIG9wdGlvbnMuY3VzdG9tSGFuZGxlQWNrcyh0b3BpYywgbWVzc2FnZSwgcGFja2V0LCAoZXJyb3IsIGNvZGUpID0+IHsKICAgICAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIGNvZGUgPSBlcnJvcjsKICAgICAgICAgICAgZXJyb3IgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBjbGllbnQuZW1pdCgnZXJyb3InLCBlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRSZWFzb25Db2Rlcy5pbmRleE9mKGNvZGUpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gY2xpZW50LmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdXcm9uZyByZWFzb24gY29kZSBmb3IgcHVicmVjJykpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAgICAgY2xpZW50Wydfc2VuZFBhY2tldCddKHsKICAgICAgICAgICAgICBjbWQ6ICdwdWJyZWMnLAogICAgICAgICAgICAgIG1lc3NhZ2VJZCwKICAgICAgICAgICAgICByZWFzb25Db2RlOiBjb2RlCiAgICAgICAgICAgIH0sIGRvbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xpZW50LmluY29taW5nU3RvcmUucHV0KHBhY2tldCwgKCkgPT4gewogICAgICAgICAgICAgIGNsaWVudFsnX3NlbmRQYWNrZXQnXSh7CiAgICAgICAgICAgICAgICBjbWQ6ICdwdWJyZWMnLAogICAgICAgICAgICAgICAgbWVzc2FnZUlkCiAgICAgICAgICAgICAgfSwgZG9uZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICBjYXNlIDE6CiAgICAgIHsKICAgICAgICBvcHRpb25zLmN1c3RvbUhhbmRsZUFja3ModG9waWMsIG1lc3NhZ2UsIHBhY2tldCwgKGVycm9yLCBjb2RlKSA9PiB7CiAgICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnbnVtYmVyJykgewogICAgICAgICAgICBjb2RlID0gZXJyb3I7CiAgICAgICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICByZXR1cm4gY2xpZW50LmVtaXQoJ2Vycm9yJywgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbGlkUmVhc29uQ29kZXMuaW5kZXhPZihjb2RlKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIGNsaWVudC5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignV3JvbmcgcmVhc29uIGNvZGUgZm9yIHB1YmFjaycpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghY29kZSkgewogICAgICAgICAgICBjbGllbnQuZW1pdCgnbWVzc2FnZScsIHRvcGljLCBtZXNzYWdlLCBwYWNrZXQpOwogICAgICAgICAgfQogICAgICAgICAgY2xpZW50LmhhbmRsZU1lc3NhZ2UocGFja2V0LCBlcnIgPT4gewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRvbmUgJiYgZG9uZShlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsaWVudFsnX3NlbmRQYWNrZXQnXSh7CiAgICAgICAgICAgICAgY21kOiAncHViYWNrJywKICAgICAgICAgICAgICBtZXNzYWdlSWQsCiAgICAgICAgICAgICAgcmVhc29uQ29kZTogY29kZQogICAgICAgICAgICB9LCBkb25lKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICBjYXNlIDA6CiAgICAgIGNsaWVudC5lbWl0KCdtZXNzYWdlJywgdG9waWMsIG1lc3NhZ2UsIHBhY2tldCk7CiAgICAgIGNsaWVudC5oYW5kbGVNZXNzYWdlKHBhY2tldCwgZG9uZSk7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgY2xpZW50LmxvZygnaGFuZGxlUHVibGlzaDogdW5rbm93biBRb1MuIERvaW5nIG5vdGhpbmcuJyk7CiAgICAgIGJyZWFrOwogIH0KfTsKcHVibGlzaC5kZWZhdWx0ID0gaGFuZGxlUHVibGlzaDsKCnZhciBhdXRoID0ge307Cgp2YXIgc2hhcmVkID0ge307Cgp2YXIgbmFtZSA9ICJtcXR0IjsKdmFyIGRlc2NyaXB0aW9uID0gIkEgbGlicmFyeSBmb3IgdGhlIE1RVFQgcHJvdG9jb2wiOwp2YXIgdmVyc2lvbiA9ICI1LjEyLjAiOwp2YXIgY29udHJpYnV0b3JzID0gWwoJIkFkYW0gUnVkZCA8YWRhbXZyckBnbWFpbC5jb20+IiwKCSJNYXR0ZW8gQ29sbGluYSA8bWF0dGVvLmNvbGxpbmFAZ21haWwuY29tPiAoaHR0cHM6Ly9naXRodWIuY29tL21jb2xsaW5hKSIsCgkiU2lhcmhlaSBCdW50c2V2aWNoIDxzY2FycnkwNTA2QGdtYWlsLmNvbT4gKGh0dHBzOi8vZ2l0aHViLmNvbS9zY2FycnkxOTkyKSIsCgkiWW9zZXBoIE1hZ3VpcmUgPHlvbWFndWlyQG1pY3Jvc29mdC5jb20+IChodHRwczovL2dpdGh1Yi5jb20vWW9EYU1hKSIsCgkiRGFuaWVsIExhbmRvIDxkYW5pZWwuc29ycmlkaUBnbWFpbC5jb20+IChodHRwczovL2dpdGh1Yi5jb20vcm9iZXJ0c0xhbmRvKSIKXTsKdmFyIGtleXdvcmRzID0gWwoJIm1xdHQiLAoJInB1Ymxpc2gvc3Vic2NyaWJlIiwKCSJwdWJsaXNoIiwKCSJzdWJzY3JpYmUiCl07CnZhciBsaWNlbnNlID0gIk1JVCI7CnZhciByZXBvc2l0b3J5ID0gewoJdHlwZTogImdpdCIsCgl1cmw6ICJnaXQ6Ly9naXRodWIuY29tL21xdHRqcy9NUVRULmpzLmdpdCIKfTsKdmFyIG1haW4gPSAiLi9idWlsZC9pbmRleC5qcyI7CnZhciBtb2R1bGUkMiA9ICIuL2Rpc3QvbXF0dC5lc20uanMiOwp2YXIgYmluID0gewoJbXF0dF9wdWI6ICIuL2J1aWxkL2Jpbi9wdWIuanMiLAoJbXF0dF9zdWI6ICIuL2J1aWxkL2Jpbi9zdWIuanMiLAoJbXF0dDogIi4vYnVpbGQvYmluL21xdHQuanMiCn07CnZhciBmaWxlcyA9IFsKCSJkaXN0LyIsCgkiQ09OVFJJQlVUSU5HLm1kIiwKCSJMSUNFTlNFLm1kIiwKCSJoZWxwLyIsCgkiYnVpbGQvIiwKCSJzcmMvIgpdOwp2YXIgZXhwb3J0cyQxID0gewoJIi4iOiB7CgkJInJlYWN0LW5hdGl2ZSI6ICIuL2Rpc3QvbXF0dC5lc20uanMiLAoJCWJyb3dzZXI6IHsKCQkJImltcG9ydCI6ICIuL2Rpc3QvbXF0dC5lc20uanMiLAoJCQkiZGVmYXVsdCI6ICIuL2Rpc3QvbXF0dC5taW4uanMiCgkJfSwKCQkiZGVmYXVsdCI6ICIuL2J1aWxkL2luZGV4LmpzIgoJfSwKCSIuL3BhY2thZ2UuanNvbiI6ICIuL3BhY2thZ2UuanNvbiIsCgkiLi8qLm1hcCI6ICIuL2J1aWxkLyouanMubWFwIiwKCSIuL2Rpc3QvKiI6ICIuL2Rpc3QvKi5qcyIsCgkiLi8qIjogIi4vYnVpbGQvKi5qcyIKfTsKdmFyIHR5cGVzJDEgPSAiYnVpbGQvaW5kZXguZC50cyI7CnZhciB0eXBlc1ZlcnNpb25zID0gewoJIioiOiB7CgkJIioiOiBbCgkJCSIuL2J1aWxkL2luZGV4LmQudHMiCgkJXQoJfQp9Owp2YXIgc2NyaXB0cyA9IHsKCWxpbnQ6ICJlc2xpbnQgLS1leHQgLnRzIC4iLAoJImxpbnQtZml4IjogImVzbGludCAtLWZpeCAtLWV4dCAudHMgLiIsCgkiYnVpbGQ6dHMiOiAicmltcmFmIGJ1aWxkLyAmJiB0c2MgLXAgdHNjb25maWcuYnVpbGQuanNvbiIsCgkiYnVpbGQ6YnJvd3NlciI6ICJub2RlIGVzYnVpbGQuanMiLAoJYnVpbGQ6ICJucG0gcnVuIGJ1aWxkOnRzICYmIG5wbSBydW4gYnVpbGQ6YnJvd3NlciIsCglwcmVwYXJlOiAibnBtIHJ1biBidWlsZCIsCgkidW5pdC10ZXN0Om5vZGUiOiAibm9kZSAtciBlc2J1aWxkLXJlZ2lzdGVyIC0tdGVzdC1jb25jdXJyZW5jeSA0IC0tdGVzdC1yZXBvcnRlcj1qdW5pdCAtLXRlc3QtcmVwb3J0ZXItZGVzdGluYXRpb249anVuaXQueG1sIC0tdGVzdC1yZXBvcnRlcj1zcGVjIC0tdGVzdC1yZXBvcnRlci1kZXN0aW5hdGlvbj1zdGRvdXQgLS10ZXN0IHRlc3Qvbm9kZS8qLnRzICIsCgkidW5pdC10ZXN0OmJyb3dzZXIiOiAid3RyIiwKCSJ0ZXN0Om5vZGUiOiAibm9kZV9tb2R1bGVzLy5iaW4vbnljIG5wbSBydW4gdW5pdC10ZXN0Om5vZGUiLAoJInRlc3Q6YnJvd3NlciI6ICJucG0gcnVuIGJ1aWxkICYmIG5wbSBydW4gdW5pdC10ZXN0OmJyb3dzZXIiLAoJdGVzdDogIm5wbSBydW4gdGVzdDpub2RlIiwKCWNoYW5nZWxvZzogImNvbnZlbnRpb25hbC1jaGFuZ2Vsb2cgLXAgYW5ndWxhciAtaSBDSEFOR0VMT0cubWQgLXMgJiYgZ2l0IGFkZCBDSEFOR0VMT0cubWQiLAoJImNoYW5nZWxvZy1pbml0IjogImNvbnZlbnRpb25hbC1jaGFuZ2Vsb2cgLXAgYW5ndWxhciAtaSBDSEFOR0VMT0cubWQgLXMgLXIgMCIsCglyZWxlYXNlOiAicmVhZCAtcCAnR0lUSFVCX1RPS0VOOiAnIEdJVEhVQl9UT0tFTiAmJiBleHBvcnQgR0lUSFVCX1RPS0VOPSRHSVRIVUJfVE9LRU4gJiYgcmVsZWFzZS1pdCIKfTsKdmFyIHB1Ymxpc2hDb25maWcgPSB7Cglwcm92ZW5hbmNlOiB0cnVlCn07CnZhciBlbmdpbmVzID0gewoJbm9kZTogIj49MTYuMC4wIgp9Owp2YXIgYnJvd3NlciA9IHsKCSIuL21xdHQuanMiOiAiLi9kaXN0L21xdHQuanMiLAoJZnM6IGZhbHNlLAoJdGxzOiBmYWxzZSwKCW5ldDogZmFsc2UKfTsKdmFyIGRlcGVuZGVuY2llcyA9IHsKCWNvbW1pc3Q6ICJeMy4yLjAiLAoJImNvbmNhdC1zdHJlYW0iOiAiXjIuMC4wIiwKCWRlYnVnOiAiXjQuNC4wIiwKCSJoZWxwLW1lIjogIl41LjAuMCIsCgkibHJ1LWNhY2hlIjogIl4xMC40LjMiLAoJbWluaW1pc3Q6ICJeMS4yLjgiLAoJIm1xdHQtcGFja2V0IjogIl45LjAuMiIsCgkibnVtYmVyLWFsbG9jYXRvciI6ICJeMS4wLjE0IiwKCSJyZWFkYWJsZS1zdHJlYW0iOiAiXjQuNy4wIiwKCXJmZGM6ICJeMS40LjEiLAoJc29ja3M6ICJeMi44LjMiLAoJc3BsaXQyOiAiXjQuMi4wIiwKCSJ3b3JrZXItdGltZXJzIjogIl43LjEuOCIsCgl3czogIl44LjE4LjAiCn07CnZhciBkZXZEZXBlbmRlbmNpZXMgPSB7CgkiQGVzbS1idW5kbGUvY2hhaSI6ICJeNC4zLjQiLAoJIkByZWxlYXNlLWl0L2NvbnZlbnRpb25hbC1jaGFuZ2Vsb2ciOiAiXjcuMC4yIiwKCSJAdHlwZXMvY2hhaSI6ICJeNC4zLjIwIiwKCSJAdHlwZXMvbm9kZSI6ICJeMjAuMTcuMTYiLAoJIkB0eXBlcy9yZWFkYWJsZS1zdHJlYW0iOiAiXjQuMC4xOCIsCgkiQHR5cGVzL3Npbm9uIjogIl4xNy4wLjMiLAoJIkB0eXBlcy90YXBlIjogIl41LjguMSIsCgkiQHR5cGVzL3dzIjogIl44LjE4LjEiLAoJIkB0eXBlc2NyaXB0LWVzbGludC9lc2xpbnQtcGx1Z2luIjogIl42LjIxLjAiLAoJIkB0eXBlc2NyaXB0LWVzbGludC9wYXJzZXIiOiAiXjYuMjEuMCIsCgkiQHdlYi90ZXN0LXJ1bm5lciI6ICJeMC4xOS4wIiwKCSJAd2ViL3Rlc3QtcnVubmVyLXBsYXl3cmlnaHQiOiAiXjAuMTEuMCIsCgkiYWVkZXMtY2xpIjogIl4wLjguMCIsCgljaGFpOiAiXjQuNS4wIiwKCWNob2tpZGFyOiAiXjMuNi4wIiwKCSJjb252ZW50aW9uYWwtY2hhbmdlbG9nLWNsaSI6ICJeNC4xLjAiLAoJImVuZC1vZi1zdHJlYW0iOiAiXjEuNC40IiwKCWVzYnVpbGQ6ICJeMC4yNS4wIiwKCSJlc2J1aWxkLXBsdWdpbi1wb2x5ZmlsbC1ub2RlIjogIl4wLjMuMCIsCgkiZXNidWlsZC1yZWdpc3RlciI6ICJeMy42LjAiLAoJZXNsaW50OiAiXjguNTcuMSIsCgkiZXNsaW50LWNvbmZpZy1haXJibmItYmFzZSI6ICJeMTUuMC4wIiwKCSJlc2xpbnQtY29uZmlnLWFpcmJuYi10eXBlc2NyaXB0IjogIl4xNy4xLjAiLAoJImVzbGludC1jb25maWctcHJldHRpZXIiOiAiXjkuMS4wIiwKCSJlc2xpbnQtcGx1Z2luLWltcG9ydCI6ICJeMi4zMS4wIiwKCSJlc2xpbnQtcGx1Z2luLXByZXR0aWVyIjogIl41LjIuMyIsCglnbG9iYWw6ICJeNC40LjAiLAoJImxlYWtlZC1oYW5kbGVzIjogIl41LjIuMCIsCglta2RpcnA6ICJeMy4wLjEiLAoJIm1xdHQtY29ubmVjdGlvbiI6ICJeNC4xLjAiLAoJIm1xdHQtbGV2ZWwtc3RvcmUiOiAiXjMuMS4wIiwKCW55YzogIl4xNS4xLjAiLAoJInByZS1jb21taXQiOiAiXjEuMi4yIiwKCXByZXR0aWVyOiAiXjMuNC4yIiwKCSJyZWxlYXNlLWl0IjogIl4xNi4zLjAiLAoJcmltcmFmOiAiXjUuMC4xMCIsCglzaG91bGQ6ICJeMTMuMi4zIiwKCXNpbm9uOiAiXjE3LjAuMiIsCglzbmF6enk6ICJeOS4wLjAiLAoJdGFwZTogIl41LjkuMCIsCgkidHMtbm9kZSI6ICJeMTAuOS4yIiwKCXR5cGVzY3JpcHQ6ICJeNS43LjMiCn07CnZhciByZXF1aXJlJCQwID0gewoJbmFtZTogbmFtZSwKCWRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbiwKCXZlcnNpb246IHZlcnNpb24sCgljb250cmlidXRvcnM6IGNvbnRyaWJ1dG9ycywKCWtleXdvcmRzOiBrZXl3b3JkcywKCWxpY2Vuc2U6IGxpY2Vuc2UsCglyZXBvc2l0b3J5OiByZXBvc2l0b3J5LAoJbWFpbjogbWFpbiwKCW1vZHVsZTogbW9kdWxlJDIsCgliaW46IGJpbiwKCWZpbGVzOiBmaWxlcywKCWV4cG9ydHM6IGV4cG9ydHMkMSwKCXR5cGVzOiB0eXBlcyQxLAoJdHlwZXNWZXJzaW9uczogdHlwZXNWZXJzaW9ucywKCXNjcmlwdHM6IHNjcmlwdHMsCgkicmVsZWFzZS1pdCI6IHsKCWdpdGh1YjogewoJCXJlbGVhc2U6IHRydWUKCX0sCglnaXQ6IHsKCQl0YWdOYW1lOiAidiR7dmVyc2lvbn0iLAoJCWNvbW1pdE1lc3NhZ2U6ICJjaG9yZShyZWxlYXNlKTogJHt2ZXJzaW9ufSIKCX0sCglob29rczogewoJCSJiZWZvcmU6aW5pdCI6IFsKCQkJIm5wbSBydW4gdGVzdCIKCQldCgl9LAoJbnBtOiB7CgkJcHVibGlzaDogdHJ1ZQoJfSwKCXBsdWdpbnM6IHsKCQkiQHJlbGVhc2UtaXQvY29udmVudGlvbmFsLWNoYW5nZWxvZyI6IHsKCQkJcHJlc2V0OiAiYW5ndWxhciIsCgkJCWluZmlsZTogIkNIQU5HRUxPRy5tZCIKCQl9Cgl9Cn0sCglwdWJsaXNoQ29uZmlnOiBwdWJsaXNoQ29uZmlnLAoJInByZS1jb21taXQiOiBbCgkibGludCIKXSwKCWVuZ2luZXM6IGVuZ2luZXMsCglicm93c2VyOiBicm93c2VyLAoJZGVwZW5kZW5jaWVzOiBkZXBlbmRlbmNpZXMsCglkZXZEZXBlbmRlbmNpZXM6IGRldkRlcGVuZGVuY2llcwp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHNoYXJlZCwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CnNoYXJlZC5NUVRUSlNfVkVSU0lPTiA9IHNoYXJlZC5uZXh0VGljayA9IHNoYXJlZC5FcnJvcldpdGhSZWFzb25Db2RlID0gdm9pZCAwOwpzaGFyZWQuYXBwbHlNaXhpbiA9IGFwcGx5TWl4aW47CmNsYXNzIEVycm9yV2l0aFJlYXNvbkNvZGUgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgY29kZSkgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIEVycm9yV2l0aFJlYXNvbkNvZGUucHJvdG90eXBlKTsKICAgIE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5uYW1lID0gJ0Vycm9yV2l0aFJlYXNvbkNvZGUnOwogIH0KfQpzaGFyZWQuRXJyb3JXaXRoUmVhc29uQ29kZSA9IEVycm9yV2l0aFJlYXNvbkNvZGU7CmZ1bmN0aW9uIGFwcGx5TWl4aW4odGFyZ2V0LCBtaXhpbiwgaW5jbHVkZUNvbnN0cnVjdG9yID0gZmFsc2UpIHsKICB2YXIgX2E7CiAgY29uc3QgaW5oZXJpdGFuY2VDaGFpbiA9IFttaXhpbl07CiAgd2hpbGUgKHRydWUpIHsKICAgIGNvbnN0IGN1cnJlbnQgPSBpbmhlcml0YW5jZUNoYWluWzBdOwogICAgY29uc3QgYmFzZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihjdXJyZW50KTsKICAgIGlmIChiYXNlID09PSBudWxsIHx8IGJhc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJhc2UucHJvdG90eXBlKSB7CiAgICAgIGluaGVyaXRhbmNlQ2hhaW4udW5zaGlmdChiYXNlKTsKICAgIH0gZWxzZSB7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICBmb3IgKGNvbnN0IGN0b3Igb2YgaW5oZXJpdGFuY2VDaGFpbikgewogICAgZm9yIChjb25zdCBwcm9wIG9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGN0b3IucHJvdG90eXBlKSkgewogICAgICBpZiAoaW5jbHVkZUNvbnN0cnVjdG9yIHx8IHByb3AgIT09ICdjb25zdHJ1Y3RvcicpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LnByb3RvdHlwZSwgcHJvcCwgKF9hID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjdG9yLnByb3RvdHlwZSwgcHJvcCkpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IE9iamVjdC5jcmVhdGUobnVsbCkpOwogICAgICB9CiAgICB9CiAgfQp9CnNoYXJlZC5uZXh0VGljayA9IHR5cGVvZiAocHJvY2VzcyA9PT0gbnVsbCB8fCBwcm9jZXNzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwcm9jZXNzLm5leHRUaWNrKSA9PT0gJ2Z1bmN0aW9uJyA/IHByb2Nlc3MubmV4dFRpY2sgOiBjYWxsYmFjayA9PiB7CiAgc2V0VGltZW91dChjYWxsYmFjaywgMCk7Cn07CnNoYXJlZC5NUVRUSlNfVkVSU0lPTiA9IHJlcXVpcmUkJDAudmVyc2lvbjsKCnZhciBhY2sgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuUmVhc29uQ29kZXMgPSB2b2lkIDA7CiAgY29uc3Qgc2hhcmVkXzEgPSBzaGFyZWQ7CiAgZXhwb3J0cy5SZWFzb25Db2RlcyA9IHsKICAgIDA6ICcnLAogICAgMTogJ1VuYWNjZXB0YWJsZSBwcm90b2NvbCB2ZXJzaW9uJywKICAgIDI6ICdJZGVudGlmaWVyIHJlamVjdGVkJywKICAgIDM6ICdTZXJ2ZXIgdW5hdmFpbGFibGUnLAogICAgNDogJ0JhZCB1c2VybmFtZSBvciBwYXNzd29yZCcsCiAgICA1OiAnTm90IGF1dGhvcml6ZWQnLAogICAgMTY6ICdObyBtYXRjaGluZyBzdWJzY3JpYmVycycsCiAgICAxNzogJ05vIHN1YnNjcmlwdGlvbiBleGlzdGVkJywKICAgIDEyODogJ1Vuc3BlY2lmaWVkIGVycm9yJywKICAgIDEyOTogJ01hbGZvcm1lZCBQYWNrZXQnLAogICAgMTMwOiAnUHJvdG9jb2wgRXJyb3InLAogICAgMTMxOiAnSW1wbGVtZW50YXRpb24gc3BlY2lmaWMgZXJyb3InLAogICAgMTMyOiAnVW5zdXBwb3J0ZWQgUHJvdG9jb2wgVmVyc2lvbicsCiAgICAxMzM6ICdDbGllbnQgSWRlbnRpZmllciBub3QgdmFsaWQnLAogICAgMTM0OiAnQmFkIFVzZXIgTmFtZSBvciBQYXNzd29yZCcsCiAgICAxMzU6ICdOb3QgYXV0aG9yaXplZCcsCiAgICAxMzY6ICdTZXJ2ZXIgdW5hdmFpbGFibGUnLAogICAgMTM3OiAnU2VydmVyIGJ1c3knLAogICAgMTM4OiAnQmFubmVkJywKICAgIDEzOTogJ1NlcnZlciBzaHV0dGluZyBkb3duJywKICAgIDE0MDogJ0JhZCBhdXRoZW50aWNhdGlvbiBtZXRob2QnLAogICAgMTQxOiAnS2VlcCBBbGl2ZSB0aW1lb3V0JywKICAgIDE0MjogJ1Nlc3Npb24gdGFrZW4gb3ZlcicsCiAgICAxNDM6ICdUb3BpYyBGaWx0ZXIgaW52YWxpZCcsCiAgICAxNDQ6ICdUb3BpYyBOYW1lIGludmFsaWQnLAogICAgMTQ1OiAnUGFja2V0IGlkZW50aWZpZXIgaW4gdXNlJywKICAgIDE0NjogJ1BhY2tldCBJZGVudGlmaWVyIG5vdCBmb3VuZCcsCiAgICAxNDc6ICdSZWNlaXZlIE1heGltdW0gZXhjZWVkZWQnLAogICAgMTQ4OiAnVG9waWMgQWxpYXMgaW52YWxpZCcsCiAgICAxNDk6ICdQYWNrZXQgdG9vIGxhcmdlJywKICAgIDE1MDogJ01lc3NhZ2UgcmF0ZSB0b28gaGlnaCcsCiAgICAxNTE6ICdRdW90YSBleGNlZWRlZCcsCiAgICAxNTI6ICdBZG1pbmlzdHJhdGl2ZSBhY3Rpb24nLAogICAgMTUzOiAnUGF5bG9hZCBmb3JtYXQgaW52YWxpZCcsCiAgICAxNTQ6ICdSZXRhaW4gbm90IHN1cHBvcnRlZCcsCiAgICAxNTU6ICdRb1Mgbm90IHN1cHBvcnRlZCcsCiAgICAxNTY6ICdVc2UgYW5vdGhlciBzZXJ2ZXInLAogICAgMTU3OiAnU2VydmVyIG1vdmVkJywKICAgIDE1ODogJ1NoYXJlZCBTdWJzY3JpcHRpb25zIG5vdCBzdXBwb3J0ZWQnLAogICAgMTU5OiAnQ29ubmVjdGlvbiByYXRlIGV4Y2VlZGVkJywKICAgIDE2MDogJ01heGltdW0gY29ubmVjdCB0aW1lJywKICAgIDE2MTogJ1N1YnNjcmlwdGlvbiBJZGVudGlmaWVycyBub3Qgc3VwcG9ydGVkJywKICAgIDE2MjogJ1dpbGRjYXJkIFN1YnNjcmlwdGlvbnMgbm90IHN1cHBvcnRlZCcKICB9OwogIGNvbnN0IGhhbmRsZUFjayA9IChjbGllbnQsIHBhY2tldCkgPT4gewogICAgY29uc3QgewogICAgICBtZXNzYWdlSWQKICAgIH0gPSBwYWNrZXQ7CiAgICBjb25zdCB0eXBlID0gcGFja2V0LmNtZDsKICAgIGxldCByZXNwb25zZSA9IG51bGw7CiAgICBjb25zdCBjYiA9IGNsaWVudC5vdXRnb2luZ1ttZXNzYWdlSWRdID8gY2xpZW50Lm91dGdvaW5nW21lc3NhZ2VJZF0uY2IgOiBudWxsOwogICAgbGV0IGVyciA9IG51bGw7CiAgICBpZiAoIWNiKSB7CiAgICAgIGNsaWVudC5sb2coJ19oYW5kbGVBY2sgOjogU2VydmVyIHNlbnQgYW4gYWNrIGluIGVycm9yLiBJZ25vcmluZy4nKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xpZW50LmxvZygnX2hhbmRsZUFjayA6OiBwYWNrZXQgdHlwZScsIHR5cGUpOwogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgJ3B1YmNvbXAnOgogICAgICBjYXNlICdwdWJhY2snOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IHB1YmFja1JDID0gcGFja2V0LnJlYXNvbkNvZGU7CiAgICAgICAgICBpZiAocHViYWNrUkMgJiYgcHViYWNrUkMgPiAwICYmIHB1YmFja1JDICE9PSAxNikgewogICAgICAgICAgICBlcnIgPSBuZXcgc2hhcmVkXzEuRXJyb3JXaXRoUmVhc29uQ29kZShgUHVibGlzaCBlcnJvcjogJHtleHBvcnRzLlJlYXNvbkNvZGVzW3B1YmFja1JDXX1gLCBwdWJhY2tSQyk7CiAgICAgICAgICAgIGNsaWVudFsnX3JlbW92ZU91dGdvaW5nQW5kU3RvcmVNZXNzYWdlJ10obWVzc2FnZUlkLCAoKSA9PiB7CiAgICAgICAgICAgICAgY2IoZXJyLCBwYWNrZXQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsaWVudFsnX3JlbW92ZU91dGdvaW5nQW5kU3RvcmVNZXNzYWdlJ10obWVzc2FnZUlkLCBjYik7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3B1YnJlYyc6CiAgICAgICAgewogICAgICAgICAgcmVzcG9uc2UgPSB7CiAgICAgICAgICAgIGNtZDogJ3B1YnJlbCcsCiAgICAgICAgICAgIHFvczogMiwKICAgICAgICAgICAgbWVzc2FnZUlkCiAgICAgICAgICB9OwogICAgICAgICAgY29uc3QgcHVicmVjUkMgPSBwYWNrZXQucmVhc29uQ29kZTsKICAgICAgICAgIGlmIChwdWJyZWNSQyAmJiBwdWJyZWNSQyA+IDAgJiYgcHVicmVjUkMgIT09IDE2KSB7CiAgICAgICAgICAgIGVyciA9IG5ldyBzaGFyZWRfMS5FcnJvcldpdGhSZWFzb25Db2RlKGBQdWJsaXNoIGVycm9yOiAke2V4cG9ydHMuUmVhc29uQ29kZXNbcHVicmVjUkNdfWAsIHB1YnJlY1JDKTsKICAgICAgICAgICAgY2xpZW50WydfcmVtb3ZlT3V0Z29pbmdBbmRTdG9yZU1lc3NhZ2UnXShtZXNzYWdlSWQsICgpID0+IHsKICAgICAgICAgICAgICBjYihlcnIsIHBhY2tldCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xpZW50Wydfc2VuZFBhY2tldCddKHJlc3BvbnNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgY2FzZSAnc3ViYWNrJzoKICAgICAgICB7CiAgICAgICAgICBkZWxldGUgY2xpZW50Lm91dGdvaW5nW21lc3NhZ2VJZF07CiAgICAgICAgICBjbGllbnQubWVzc2FnZUlkUHJvdmlkZXIuZGVhbGxvY2F0ZShtZXNzYWdlSWQpOwogICAgICAgICAgY29uc3QgZ3JhbnRlZCA9IHBhY2tldC5ncmFudGVkOwogICAgICAgICAgZm9yIChsZXQgZ3JhbnRlZEkgPSAwOyBncmFudGVkSSA8IGdyYW50ZWQubGVuZ3RoOyBncmFudGVkSSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHN1YmFja1JDID0gZ3JhbnRlZFtncmFudGVkSV07CiAgICAgICAgICAgIGlmICgoc3ViYWNrUkMgJiAweDgwKSAhPT0gMCkgewogICAgICAgICAgICAgIGVyciA9IG5ldyBFcnJvcihgU3Vic2NyaWJlIGVycm9yOiAke2V4cG9ydHMuUmVhc29uQ29kZXNbc3ViYWNrUkNdfWApOwogICAgICAgICAgICAgIGVyci5jb2RlID0gc3ViYWNrUkM7CiAgICAgICAgICAgICAgY29uc3QgdG9waWNzID0gY2xpZW50Lm1lc3NhZ2VJZFRvVG9waWNbbWVzc2FnZUlkXTsKICAgICAgICAgICAgICBpZiAodG9waWNzKSB7CiAgICAgICAgICAgICAgICB0b3BpY3MuZm9yRWFjaCh0b3BpYyA9PiB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSBjbGllbnRbJ19yZXN1YnNjcmliZVRvcGljcyddW3RvcGljXTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIGNsaWVudC5tZXNzYWdlSWRUb1RvcGljW21lc3NhZ2VJZF07CiAgICAgICAgICBjbGllbnRbJ19pbnZva2VTdG9yZVByb2Nlc3NpbmdRdWV1ZSddKCk7CiAgICAgICAgICBjYihlcnIsIHBhY2tldCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIGNhc2UgJ3Vuc3ViYWNrJzoKICAgICAgICB7CiAgICAgICAgICBkZWxldGUgY2xpZW50Lm91dGdvaW5nW21lc3NhZ2VJZF07CiAgICAgICAgICBjbGllbnQubWVzc2FnZUlkUHJvdmlkZXIuZGVhbGxvY2F0ZShtZXNzYWdlSWQpOwogICAgICAgICAgY2xpZW50WydfaW52b2tlU3RvcmVQcm9jZXNzaW5nUXVldWUnXSgpOwogICAgICAgICAgY2IobnVsbCwgcGFja2V0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICBjbGllbnQuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ3VucmVjb2duaXplZCBwYWNrZXQgdHlwZScpKTsKICAgIH0KICAgIGlmIChjbGllbnQuZGlzY29ubmVjdGluZyAmJiBPYmplY3Qua2V5cyhjbGllbnQub3V0Z29pbmcpLmxlbmd0aCA9PT0gMCkgewogICAgICBjbGllbnQuZW1pdCgnb3V0Z29pbmdFbXB0eScpOwogICAgfQogIH07CiAgZXhwb3J0cy5kZWZhdWx0ID0gaGFuZGxlQWNrOwp9KShhY2spOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGF1dGgsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBzaGFyZWRfMSQzID0gc2hhcmVkOwpjb25zdCBhY2tfMSQyID0gYWNrOwpjb25zdCBoYW5kbGVBdXRoID0gKGNsaWVudCwgcGFja2V0KSA9PiB7CiAgY29uc3QgewogICAgb3B0aW9ucwogIH0gPSBjbGllbnQ7CiAgY29uc3QgdmVyc2lvbiA9IG9wdGlvbnMucHJvdG9jb2xWZXJzaW9uOwogIGNvbnN0IHJjID0gdmVyc2lvbiA9PT0gNSA/IHBhY2tldC5yZWFzb25Db2RlIDogcGFja2V0LnJldHVybkNvZGU7CiAgaWYgKHZlcnNpb24gIT09IDUpIHsKICAgIGNvbnN0IGVyciA9IG5ldyBzaGFyZWRfMSQzLkVycm9yV2l0aFJlYXNvbkNvZGUoYFByb3RvY29sIGVycm9yOiBBdXRoIHBhY2tldHMgYXJlIG9ubHkgc3VwcG9ydGVkIGluIE1RVFQgNS4gWW91ciB2ZXJzaW9uOiR7dmVyc2lvbn1gLCByYyk7CiAgICBjbGllbnQuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgcmV0dXJuOwogIH0KICBjbGllbnQuaGFuZGxlQXV0aChwYWNrZXQsIChlcnIsIHBhY2tldDIpID0+IHsKICAgIGlmIChlcnIpIHsKICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHJjID09PSAyNCkgewogICAgICBjbGllbnQucmVjb25uZWN0aW5nID0gZmFsc2U7CiAgICAgIGNsaWVudFsnX3NlbmRQYWNrZXQnXShwYWNrZXQyKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGVycm9yID0gbmV3IHNoYXJlZF8xJDMuRXJyb3JXaXRoUmVhc29uQ29kZShgQ29ubmVjdGlvbiByZWZ1c2VkOiAke2Fja18xJDIuUmVhc29uQ29kZXNbcmNdfWAsIHJjKTsKICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgZXJyb3IpOwogICAgfQogIH0pOwp9OwphdXRoLmRlZmF1bHQgPSBoYW5kbGVBdXRoOwoKdmFyIGNvbm5hY2sgPSB7fTsKCnZhciB0b3BpY0FsaWFzU2VuZCA9IHt9OwoKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UociwgZSkgewogIGlmIChudWxsID09IHIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwociwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByW25dOwogIH0KICByZXR1cm4gdDsKfQoKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sCiAgICByLAogICAgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIgPSAwOyByIDwgbi5sZW5ndGg7IHIrKykgbyA9IG5bcl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQoKdmFyIGNvbW1vbmpzID0ge307Cgpjb25zdCBfZXhjbHVkZWQgPSBbImNvbnRleHQiLCAiZm9yY2VSZWZyZXNoIl07CmZ1bmN0aW9uIG93bktleXMkNChlLCByKSB7IHZhciB0ID0gT2JqZWN0LmtleXMoZSk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsgciAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uIChyKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIpLmVudW1lcmFibGU7IH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOyB9IHJldHVybiB0OyB9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQkNChlKSB7IGZvciAodmFyIHIgPSAxOyByIDwgYXJndW1lbnRzLmxlbmd0aDsgcisrKSB7IHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcl0gPyBhcmd1bWVudHNbcl0gOiB7fTsgciAlIDIgPyBvd25LZXlzJDQoT2JqZWN0KHQpLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBfZGVmaW5lUHJvcGVydHkoZSwgciwgdFtyXSk7IH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzJDQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIpKTsgfSk7IH0gcmV0dXJuIGU7IH0KLyoqCiAqIEBtb2R1bGUgTFJVQ2FjaGUKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb21tb25qcywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbW1vbmpzLkxSVUNhY2hlID0gdm9pZCAwOwpjb25zdCBwZXJmID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAnb2JqZWN0JyAmJiBwZXJmb3JtYW5jZSAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nID8gcGVyZm9ybWFuY2UgOiBEYXRlOwpjb25zdCB3YXJuZWQgPSBuZXcgU2V0KCk7Ci8qIGM4IGlnbm9yZSBzdGFydCAqLwpjb25zdCBQUk9DRVNTID0gdHlwZW9mIHByb2Nlc3MgPT09ICdvYmplY3QnICYmICEhcHJvY2VzcyA/IHByb2Nlc3MgOiB7fTsKLyogYzggaWdub3JlIHN0YXJ0ICovCmNvbnN0IGVtaXRXYXJuaW5nID0gKG1zZywgdHlwZSwgY29kZSwgZm4pID0+IHsKICB0eXBlb2YgUFJPQ0VTUy5lbWl0V2FybmluZyA9PT0gJ2Z1bmN0aW9uJyA/IFBST0NFU1MuZW1pdFdhcm5pbmcobXNnLCB0eXBlLCBjb2RlLCBmbikgOiBjb25zb2xlLmVycm9yKGBbJHtjb2RlfV0gJHt0eXBlfTogJHttc2d9YCk7Cn07CmxldCBBQyA9IGdsb2JhbFRoaXMuQWJvcnRDb250cm9sbGVyOwpsZXQgQVMgPSBnbG9iYWxUaGlzLkFib3J0U2lnbmFsOwovKiBjOCBpZ25vcmUgc3RhcnQgKi8KaWYgKHR5cGVvZiBBQyA9PT0gJ3VuZGVmaW5lZCcpIHsKICB2YXIgX1BST0NFU1MkZW52OwogIC8vQHRzLWlnbm9yZQogIEFTID0gY2xhc3MgQWJvcnRTaWduYWwgewogICAgb25hYm9ydDsKICAgIF9vbmFib3J0ID0gW107CiAgICByZWFzb247CiAgICBhYm9ydGVkID0gZmFsc2U7CiAgICBhZGRFdmVudExpc3RlbmVyKF8sIGZuKSB7CiAgICAgIHRoaXMuX29uYWJvcnQucHVzaChmbik7CiAgICB9CiAgfTsKICAvL0B0cy1pZ25vcmUKICBBQyA9IGNsYXNzIEFib3J0Q29udHJvbGxlciB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgd2FybkFDUG9seWZpbGwoKTsKICAgIH0KICAgIHNpZ25hbCA9IG5ldyBBUygpOwogICAgYWJvcnQocmVhc29uKSB7CiAgICAgIHZhciBfdGhpcyRzaWduYWwkb25hYm9ydCwgX3RoaXMkc2lnbmFsOwogICAgICBpZiAodGhpcy5zaWduYWwuYWJvcnRlZCkgcmV0dXJuOwogICAgICAvL0B0cy1pZ25vcmUKICAgICAgdGhpcy5zaWduYWwucmVhc29uID0gcmVhc29uOwogICAgICAvL0B0cy1pZ25vcmUKICAgICAgdGhpcy5zaWduYWwuYWJvcnRlZCA9IHRydWU7CiAgICAgIC8vQHRzLWlnbm9yZQogICAgICBmb3IgKGNvbnN0IGZuIG9mIHRoaXMuc2lnbmFsLl9vbmFib3J0KSB7CiAgICAgICAgZm4ocmVhc29uKTsKICAgICAgfQogICAgICAoX3RoaXMkc2lnbmFsJG9uYWJvcnQgPSAoX3RoaXMkc2lnbmFsID0gdGhpcy5zaWduYWwpLm9uYWJvcnQpID09PSBudWxsIHx8IF90aGlzJHNpZ25hbCRvbmFib3J0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRzaWduYWwkb25hYm9ydC5jYWxsKF90aGlzJHNpZ25hbCwgcmVhc29uKTsKICAgIH0KICB9OwogIGxldCBwcmludEFDUG9seWZpbGxXYXJuaW5nID0gKChfUFJPQ0VTUyRlbnYgPSBQUk9DRVNTLmVudikgPT09IG51bGwgfHwgX1BST0NFU1MkZW52ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfUFJPQ0VTUyRlbnYuTFJVX0NBQ0hFX0lHTk9SRV9BQ19XQVJOSU5HKSAhPT0gJzEnOwogIGNvbnN0IHdhcm5BQ1BvbHlmaWxsID0gKCkgPT4gewogICAgaWYgKCFwcmludEFDUG9seWZpbGxXYXJuaW5nKSByZXR1cm47CiAgICBwcmludEFDUG9seWZpbGxXYXJuaW5nID0gZmFsc2U7CiAgICBlbWl0V2FybmluZygnQWJvcnRDb250cm9sbGVyIGlzIG5vdCBkZWZpbmVkLiBJZiB1c2luZyBscnUtY2FjaGUgaW4gJyArICdub2RlIDE0LCBsb2FkIGFuIEFib3J0Q29udHJvbGxlciBwb2x5ZmlsbCBmcm9tIHRoZSAnICsgJ2Bub2RlLWFib3J0LWNvbnRyb2xsZXJgIHBhY2thZ2UuIEEgbWluaW1hbCBwb2x5ZmlsbCBpcyAnICsgJ3Byb3ZpZGVkIGZvciB1c2UgYnkgTFJVQ2FjaGUuZmV0Y2goKSwgYnV0IGl0IHNob3VsZCBub3QgYmUgJyArICdyZWxpZWQgdXBvbiBpbiBvdGhlciBjb250ZXh0cyAoZWcsIHBhc3NpbmcgaXQgdG8gb3RoZXIgQVBJcyB0aGF0ICcgKyAndXNlIEFib3J0Q29udHJvbGxlci9BYm9ydFNpZ25hbCBtaWdodCBoYXZlIHVuZGVzaXJhYmxlIGVmZmVjdHMpLiAnICsgJ1lvdSBtYXkgZGlzYWJsZSB0aGlzIHdpdGggTFJVX0NBQ0hFX0lHTk9SRV9BQ19XQVJOSU5HPTEgaW4gdGhlIGVudi4nLCAnTk9fQUJPUlRfQ09OVFJPTExFUicsICdFTk9UU1VQJywgd2FybkFDUG9seWZpbGwpOwogIH07Cn0KLyogYzggaWdub3JlIHN0b3AgKi8KY29uc3Qgc2hvdWxkV2FybiA9IGNvZGUgPT4gIXdhcm5lZC5oYXMoY29kZSk7CmNvbnN0IGlzUG9zSW50ID0gbiA9PiBuICYmIG4gPT09IE1hdGguZmxvb3IobikgJiYgbiA+IDAgJiYgaXNGaW5pdGUobik7Ci8qIGM4IGlnbm9yZSBzdGFydCAqLwovLyBUaGlzIGlzIGEgbGl0dGxlIGJpdCByaWRpY3Vsb3VzLCB0YmguCi8vIFRoZSBtYXhpbXVtIGFycmF5IGxlbmd0aCBpcyAyXjMyLTEgb3IgdGhlcmVhYm91dHMgb24gbW9zdCBKUyBpbXBscy4KLy8gQW5kIHdlbGwgYmVmb3JlIHRoYXQgcG9pbnQsIHlvdSdyZSBjYWNoaW5nIHRoZSBlbnRpcmUgd29ybGQsIEkgbWVhbiwKLy8gdGhhdCdzIH4zMkdCIG9mIGp1c3QgaW50ZWdlcnMgZm9yIHRoZSBuZXh0L3ByZXYgbGlua3MsIHBsdXMgd2hhdGV2ZXIKLy8gZWxzZSB0byBob2xkIHRoYXQgbWFueSBrZXlzIGFuZCB2YWx1ZXMuICBKdXN0IGZpbGxpbmcgdGhlIG1lbW9yeSB3aXRoCi8vIHplcm9lcyBhdCBpbml0IHRpbWUgaXMgYnJ1dGFsIHdoZW4geW91IGdldCB0aGF0IGJpZy4KLy8gQnV0IHdoeSBub3QgYmUgY29tcGxldGU/Ci8vIE1heWJlIGluIHRoZSBmdXR1cmUsIHRoZXNlIGxpbWl0cyB3aWxsIGhhdmUgZXhwYW5kZWQuCmNvbnN0IGdldFVpbnRBcnJheSA9IG1heCA9PiAhaXNQb3NJbnQobWF4KSA/IG51bGwgOiBtYXggPD0gTWF0aC5wb3coMiwgOCkgPyBVaW50OEFycmF5IDogbWF4IDw9IE1hdGgucG93KDIsIDE2KSA/IFVpbnQxNkFycmF5IDogbWF4IDw9IE1hdGgucG93KDIsIDMyKSA/IFVpbnQzMkFycmF5IDogbWF4IDw9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID8gWmVyb0FycmF5IDogbnVsbDsKLyogYzggaWdub3JlIHN0b3AgKi8KY2xhc3MgWmVyb0FycmF5IGV4dGVuZHMgQXJyYXkgewogIGNvbnN0cnVjdG9yKHNpemUpIHsKICAgIHN1cGVyKHNpemUpOwogICAgdGhpcy5maWxsKDApOwogIH0KfQpsZXQgU3RhY2skMSA9IGNsYXNzIFN0YWNrIHsKICBoZWFwOwogIGxlbmd0aDsKICAvLyBwcml2YXRlIGNvbnN0cnVjdG9yCiAgc3RhdGljICNjb25zdHJ1Y3RpbmcgPSBmYWxzZTsKICBzdGF0aWMgY3JlYXRlKG1heCkgewogICAgY29uc3QgSGVhcENscyA9IGdldFVpbnRBcnJheShtYXgpOwogICAgaWYgKCFIZWFwQ2xzKSByZXR1cm4gW107CiAgICBTdGFjay4jY29uc3RydWN0aW5nID0gdHJ1ZTsKICAgIGNvbnN0IHMgPSBuZXcgU3RhY2sobWF4LCBIZWFwQ2xzKTsKICAgIFN0YWNrLiNjb25zdHJ1Y3RpbmcgPSBmYWxzZTsKICAgIHJldHVybiBzOwogIH0KICBjb25zdHJ1Y3RvcihtYXgsIEhlYXBDbHMpIHsKICAgIC8qIGM4IGlnbm9yZSBzdGFydCAqLwogICAgaWYgKCFTdGFjay4jY29uc3RydWN0aW5nKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2luc3RhbnRpYXRlIFN0YWNrIHVzaW5nIFN0YWNrLmNyZWF0ZShuKScpOwogICAgfQogICAgLyogYzggaWdub3JlIHN0b3AgKi8KICAgIHRoaXMuaGVhcCA9IG5ldyBIZWFwQ2xzKG1heCk7CiAgICB0aGlzLmxlbmd0aCA9IDA7CiAgfQogIHB1c2gobikgewogICAgdGhpcy5oZWFwW3RoaXMubGVuZ3RoKytdID0gbjsKICB9CiAgcG9wKCkgewogICAgcmV0dXJuIHRoaXMuaGVhcFstLXRoaXMubGVuZ3RoXTsKICB9Cn07Ci8qKgogKiBEZWZhdWx0IGV4cG9ydCwgdGhlIHRoaW5nIHlvdSdyZSB1c2luZyB0aGlzIG1vZHVsZSB0byBnZXQuCiAqCiAqIFRoZSBgS2AgYW5kIGBWYCB0eXBlcyBkZWZpbmUgdGhlIGtleSBhbmQgdmFsdWUgdHlwZXMsIHJlc3BlY3RpdmVseS4gVGhlCiAqIG9wdGlvbmFsIGBGQ2AgdHlwZSBkZWZpbmVzIHRoZSB0eXBlIG9mIHRoZSBgY29udGV4dGAgb2JqZWN0IHBhc3NlZCB0bwogKiBgY2FjaGUuZmV0Y2goKWAgYW5kIGBjYWNoZS5tZW1vKClgLgogKgogKiBLZXlzIGFuZCB2YWx1ZXMgKiptdXN0IG5vdCoqIGJlIGBudWxsYCBvciBgdW5kZWZpbmVkYC4KICoKICogQWxsIHByb3BlcnRpZXMgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3QgKHdpdGggdGhlIGV4Y2VwdGlvbiBvZiBgbWF4YCwKICogYG1heFNpemVgLCBgZmV0Y2hNZXRob2RgLCBgbWVtb01ldGhvZGAsIGBkaXNwb3NlYCBhbmQgYGRpc3Bvc2VBZnRlcmApIGFyZQogKiBhZGRlZCBhcyBub3JtYWwgcHVibGljIG1lbWJlcnMuIChUaGUgbGlzdGVkIG9wdGlvbnMgYXJlIHJlYWQtb25seSBnZXR0ZXJzLikKICoKICogQ2hhbmdpbmcgYW55IG9mIHRoZXNlIHdpbGwgYWx0ZXIgdGhlIGRlZmF1bHRzIGZvciBzdWJzZXF1ZW50IG1ldGhvZCBjYWxscy4KICovCmNsYXNzIExSVUNhY2hlIHsKICAvLyBvcHRpb25zIHRoYXQgY2Fubm90IGJlIGNoYW5nZWQgd2l0aG91dCBkaXNhc3RlcgogICNtYXg7CiAgI21heFNpemU7CiAgI2Rpc3Bvc2U7CiAgI2Rpc3Bvc2VBZnRlcjsKICAjZmV0Y2hNZXRob2Q7CiAgI21lbW9NZXRob2Q7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLnR0bH0KICAgKi8KICB0dGw7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLnR0bFJlc29sdXRpb259CiAgICovCiAgdHRsUmVzb2x1dGlvbjsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudHRsQXV0b3B1cmdlfQogICAqLwogIHR0bEF1dG9wdXJnZTsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudXBkYXRlQWdlT25HZXR9CiAgICovCiAgdXBkYXRlQWdlT25HZXQ7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLnVwZGF0ZUFnZU9uSGFzfQogICAqLwogIHVwZGF0ZUFnZU9uSGFzOwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5hbGxvd1N0YWxlfQogICAqLwogIGFsbG93U3RhbGU7CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm5vRGlzcG9zZU9uU2V0fQogICAqLwogIG5vRGlzcG9zZU9uU2V0OwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5ub1VwZGF0ZVRUTH0KICAgKi8KICBub1VwZGF0ZVRUTDsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UubWF4RW50cnlTaXplfQogICAqLwogIG1heEVudHJ5U2l6ZTsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2Uuc2l6ZUNhbGN1bGF0aW9ufQogICAqLwogIHNpemVDYWxjdWxhdGlvbjsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2Uubm9EZWxldGVPbkZldGNoUmVqZWN0aW9ufQogICAqLwogIG5vRGVsZXRlT25GZXRjaFJlamVjdGlvbjsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2Uubm9EZWxldGVPblN0YWxlR2V0fQogICAqLwogIG5vRGVsZXRlT25TdGFsZUdldDsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydH0KICAgKi8KICBhbGxvd1N0YWxlT25GZXRjaEFib3J0OwogIC8qKgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5hbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbn0KICAgKi8KICBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbjsKICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuaWdub3JlRmV0Y2hBYm9ydH0KICAgKi8KICBpZ25vcmVGZXRjaEFib3J0OwogIC8vIGNvbXB1dGVkIHByb3BlcnRpZXMKICAjc2l6ZTsKICAjY2FsY3VsYXRlZFNpemU7CiAgI2tleU1hcDsKICAja2V5TGlzdDsKICAjdmFsTGlzdDsKICAjbmV4dDsKICAjcHJldjsKICAjaGVhZDsKICAjdGFpbDsKICAjZnJlZTsKICAjZGlzcG9zZWQ7CiAgI3NpemVzOwogICNzdGFydHM7CiAgI3R0bHM7CiAgI2hhc0Rpc3Bvc2U7CiAgI2hhc0ZldGNoTWV0aG9kOwogICNoYXNEaXNwb3NlQWZ0ZXI7CiAgLyoqCiAgICogRG8gbm90IGNhbGwgdGhpcyBtZXRob2QgdW5sZXNzIHlvdSBuZWVkIHRvIGluc3BlY3QgdGhlCiAgICogaW5uZXIgd29ya2luZ3Mgb2YgdGhlIGNhY2hlLiAgSWYgYW55dGhpbmcgcmV0dXJuZWQgYnkgdGhpcwogICAqIG9iamVjdCBpcyBtb2RpZmllZCBpbiBhbnkgd2F5LCBzdHJhbmdlIGJyZWFrYWdlIG1heSBvY2N1ci4KICAgKgogICAqIFRoZXNlIGZpZWxkcyBhcmUgcHJpdmF0ZSBmb3IgYSByZWFzb24hCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBzdGF0aWMgdW5zYWZlRXhwb3NlSW50ZXJuYWxzKGMpIHsKICAgIHJldHVybiB7CiAgICAgIC8vIHByb3BlcnRpZXMKICAgICAgc3RhcnRzOiBjLiNzdGFydHMsCiAgICAgIHR0bHM6IGMuI3R0bHMsCiAgICAgIHNpemVzOiBjLiNzaXplcywKICAgICAga2V5TWFwOiBjLiNrZXlNYXAsCiAgICAgIGtleUxpc3Q6IGMuI2tleUxpc3QsCiAgICAgIHZhbExpc3Q6IGMuI3ZhbExpc3QsCiAgICAgIG5leHQ6IGMuI25leHQsCiAgICAgIHByZXY6IGMuI3ByZXYsCiAgICAgIGdldCBoZWFkKCkgewogICAgICAgIHJldHVybiBjLiNoZWFkOwogICAgICB9LAogICAgICBnZXQgdGFpbCgpIHsKICAgICAgICByZXR1cm4gYy4jdGFpbDsKICAgICAgfSwKICAgICAgZnJlZTogYy4jZnJlZSwKICAgICAgLy8gbWV0aG9kcwogICAgICBpc0JhY2tncm91bmRGZXRjaDogcCA9PiBjLiNpc0JhY2tncm91bmRGZXRjaChwKSwKICAgICAgYmFja2dyb3VuZEZldGNoOiAoaywgaW5kZXgsIG9wdGlvbnMsIGNvbnRleHQpID0+IGMuI2JhY2tncm91bmRGZXRjaChrLCBpbmRleCwgb3B0aW9ucywgY29udGV4dCksCiAgICAgIG1vdmVUb1RhaWw6IGluZGV4ID0+IGMuI21vdmVUb1RhaWwoaW5kZXgpLAogICAgICBpbmRleGVzOiBvcHRpb25zID0+IGMuI2luZGV4ZXMob3B0aW9ucyksCiAgICAgIHJpbmRleGVzOiBvcHRpb25zID0+IGMuI3JpbmRleGVzKG9wdGlvbnMpLAogICAgICBpc1N0YWxlOiBpbmRleCA9PiBjLiNpc1N0YWxlKGluZGV4KQogICAgfTsKICB9CiAgLy8gUHJvdGVjdGVkIHJlYWQtb25seSBtZW1iZXJzCiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm1heH0gKHJlYWQtb25seSkKICAgKi8KICBnZXQgbWF4KCkgewogICAgcmV0dXJuIHRoaXMuI21heDsKICB9CiAgLyoqCiAgICoge0BsaW5rIExSVUNhY2hlLk9wdGlvbnNCYXNlLm1heFNpemV9IChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IG1heFNpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jbWF4U2l6ZTsKICB9CiAgLyoqCiAgICogVGhlIHRvdGFsIGNvbXB1dGVkIHNpemUgb2YgaXRlbXMgaW4gdGhlIGNhY2hlIChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IGNhbGN1bGF0ZWRTaXplKCkgewogICAgcmV0dXJuIHRoaXMuI2NhbGN1bGF0ZWRTaXplOwogIH0KICAvKioKICAgKiBUaGUgbnVtYmVyIG9mIGl0ZW1zIHN0b3JlZCBpbiB0aGUgY2FjaGUgKHJlYWQtb25seSkKICAgKi8KICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLiNzaXplOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZmV0Y2hNZXRob2R9IChyZWFkLW9ubHkpCiAgICovCiAgZ2V0IGZldGNoTWV0aG9kKCkgewogICAgcmV0dXJuIHRoaXMuI2ZldGNoTWV0aG9kOwogIH0KICBnZXQgbWVtb01ldGhvZCgpIHsKICAgIHJldHVybiB0aGlzLiNtZW1vTWV0aG9kOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZGlzcG9zZX0gKHJlYWQtb25seSkKICAgKi8KICBnZXQgZGlzcG9zZSgpIHsKICAgIHJldHVybiB0aGlzLiNkaXNwb3NlOwogIH0KICAvKioKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuZGlzcG9zZUFmdGVyfSAocmVhZC1vbmx5KQogICAqLwogIGdldCBkaXNwb3NlQWZ0ZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jZGlzcG9zZUFmdGVyOwogIH0KICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBjb25zdCB7CiAgICAgIG1heCA9IDAsCiAgICAgIHR0bCwKICAgICAgdHRsUmVzb2x1dGlvbiA9IDEsCiAgICAgIHR0bEF1dG9wdXJnZSwKICAgICAgdXBkYXRlQWdlT25HZXQsCiAgICAgIHVwZGF0ZUFnZU9uSGFzLAogICAgICBhbGxvd1N0YWxlLAogICAgICBkaXNwb3NlLAogICAgICBkaXNwb3NlQWZ0ZXIsCiAgICAgIG5vRGlzcG9zZU9uU2V0LAogICAgICBub1VwZGF0ZVRUTCwKICAgICAgbWF4U2l6ZSA9IDAsCiAgICAgIG1heEVudHJ5U2l6ZSA9IDAsCiAgICAgIHNpemVDYWxjdWxhdGlvbiwKICAgICAgZmV0Y2hNZXRob2QsCiAgICAgIG1lbW9NZXRob2QsCiAgICAgIG5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiwKICAgICAgbm9EZWxldGVPblN0YWxlR2V0LAogICAgICBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiwKICAgICAgYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydCwKICAgICAgaWdub3JlRmV0Y2hBYm9ydAogICAgfSA9IG9wdGlvbnM7CiAgICBpZiAobWF4ICE9PSAwICYmICFpc1Bvc0ludChtYXgpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ21heCBvcHRpb24gbXVzdCBiZSBhIG5vbm5lZ2F0aXZlIGludGVnZXInKTsKICAgIH0KICAgIGNvbnN0IFVpbnRBcnJheSA9IG1heCA/IGdldFVpbnRBcnJheShtYXgpIDogQXJyYXk7CiAgICBpZiAoIVVpbnRBcnJheSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbWF4IHZhbHVlOiAnICsgbWF4KTsKICAgIH0KICAgIHRoaXMuI21heCA9IG1heDsKICAgIHRoaXMuI21heFNpemUgPSBtYXhTaXplOwogICAgdGhpcy5tYXhFbnRyeVNpemUgPSBtYXhFbnRyeVNpemUgfHwgdGhpcy4jbWF4U2l6ZTsKICAgIHRoaXMuc2l6ZUNhbGN1bGF0aW9uID0gc2l6ZUNhbGN1bGF0aW9uOwogICAgaWYgKHRoaXMuc2l6ZUNhbGN1bGF0aW9uKSB7CiAgICAgIGlmICghdGhpcy4jbWF4U2l6ZSAmJiAhdGhpcy5tYXhFbnRyeVNpemUpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdjYW5ub3Qgc2V0IHNpemVDYWxjdWxhdGlvbiB3aXRob3V0IHNldHRpbmcgbWF4U2l6ZSBvciBtYXhFbnRyeVNpemUnKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHRoaXMuc2l6ZUNhbGN1bGF0aW9uICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignc2l6ZUNhbGN1bGF0aW9uIHNldCB0byBub24tZnVuY3Rpb24nKTsKICAgICAgfQogICAgfQogICAgaWYgKG1lbW9NZXRob2QgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbWVtb01ldGhvZCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtZW1vTWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbiBpZiBkZWZpbmVkJyk7CiAgICB9CiAgICB0aGlzLiNtZW1vTWV0aG9kID0gbWVtb01ldGhvZDsKICAgIGlmIChmZXRjaE1ldGhvZCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBmZXRjaE1ldGhvZCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdmZXRjaE1ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24gaWYgc3BlY2lmaWVkJyk7CiAgICB9CiAgICB0aGlzLiNmZXRjaE1ldGhvZCA9IGZldGNoTWV0aG9kOwogICAgdGhpcy4jaGFzRmV0Y2hNZXRob2QgPSAhIWZldGNoTWV0aG9kOwogICAgdGhpcy4ja2V5TWFwID0gbmV3IE1hcCgpOwogICAgdGhpcy4ja2V5TGlzdCA9IG5ldyBBcnJheShtYXgpLmZpbGwodW5kZWZpbmVkKTsKICAgIHRoaXMuI3ZhbExpc3QgPSBuZXcgQXJyYXkobWF4KS5maWxsKHVuZGVmaW5lZCk7CiAgICB0aGlzLiNuZXh0ID0gbmV3IFVpbnRBcnJheShtYXgpOwogICAgdGhpcy4jcHJldiA9IG5ldyBVaW50QXJyYXkobWF4KTsKICAgIHRoaXMuI2hlYWQgPSAwOwogICAgdGhpcy4jdGFpbCA9IDA7CiAgICB0aGlzLiNmcmVlID0gU3RhY2skMS5jcmVhdGUobWF4KTsKICAgIHRoaXMuI3NpemUgPSAwOwogICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgPSAwOwogICAgaWYgKHR5cGVvZiBkaXNwb3NlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuI2Rpc3Bvc2UgPSBkaXNwb3NlOwogICAgfQogICAgaWYgKHR5cGVvZiBkaXNwb3NlQWZ0ZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyID0gZGlzcG9zZUFmdGVyOwogICAgICB0aGlzLiNkaXNwb3NlZCA9IFtdOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jZGlzcG9zZUFmdGVyID0gdW5kZWZpbmVkOwogICAgICB0aGlzLiNkaXNwb3NlZCA9IHVuZGVmaW5lZDsKICAgIH0KICAgIHRoaXMuI2hhc0Rpc3Bvc2UgPSAhIXRoaXMuI2Rpc3Bvc2U7CiAgICB0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIgPSAhIXRoaXMuI2Rpc3Bvc2VBZnRlcjsKICAgIHRoaXMubm9EaXNwb3NlT25TZXQgPSAhIW5vRGlzcG9zZU9uU2V0OwogICAgdGhpcy5ub1VwZGF0ZVRUTCA9ICEhbm9VcGRhdGVUVEw7CiAgICB0aGlzLm5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiA9ICEhbm9EZWxldGVPbkZldGNoUmVqZWN0aW9uOwogICAgdGhpcy5hbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiA9ICEhYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb247CiAgICB0aGlzLmFsbG93U3RhbGVPbkZldGNoQWJvcnQgPSAhIWFsbG93U3RhbGVPbkZldGNoQWJvcnQ7CiAgICB0aGlzLmlnbm9yZUZldGNoQWJvcnQgPSAhIWlnbm9yZUZldGNoQWJvcnQ7CiAgICAvLyBOQjogbWF4RW50cnlTaXplIGlzIHNldCB0byBtYXhTaXplIGlmIGl0J3Mgc2V0CiAgICBpZiAodGhpcy5tYXhFbnRyeVNpemUgIT09IDApIHsKICAgICAgaWYgKHRoaXMuI21heFNpemUgIT09IDApIHsKICAgICAgICBpZiAoIWlzUG9zSW50KHRoaXMuI21heFNpemUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtYXhTaXplIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIGlmIHNwZWNpZmllZCcpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWlzUG9zSW50KHRoaXMubWF4RW50cnlTaXplKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ21heEVudHJ5U2l6ZSBtdXN0IGJlIGEgcG9zaXRpdmUgaW50ZWdlciBpZiBzcGVjaWZpZWQnKTsKICAgICAgfQogICAgICB0aGlzLiNpbml0aWFsaXplU2l6ZVRyYWNraW5nKCk7CiAgICB9CiAgICB0aGlzLmFsbG93U3RhbGUgPSAhIWFsbG93U3RhbGU7CiAgICB0aGlzLm5vRGVsZXRlT25TdGFsZUdldCA9ICEhbm9EZWxldGVPblN0YWxlR2V0OwogICAgdGhpcy51cGRhdGVBZ2VPbkdldCA9ICEhdXBkYXRlQWdlT25HZXQ7CiAgICB0aGlzLnVwZGF0ZUFnZU9uSGFzID0gISF1cGRhdGVBZ2VPbkhhczsKICAgIHRoaXMudHRsUmVzb2x1dGlvbiA9IGlzUG9zSW50KHR0bFJlc29sdXRpb24pIHx8IHR0bFJlc29sdXRpb24gPT09IDAgPyB0dGxSZXNvbHV0aW9uIDogMTsKICAgIHRoaXMudHRsQXV0b3B1cmdlID0gISF0dGxBdXRvcHVyZ2U7CiAgICB0aGlzLnR0bCA9IHR0bCB8fCAwOwogICAgaWYgKHRoaXMudHRsKSB7CiAgICAgIGlmICghaXNQb3NJbnQodGhpcy50dGwpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndHRsIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIGlmIHNwZWNpZmllZCcpOwogICAgICB9CiAgICAgIHRoaXMuI2luaXRpYWxpemVUVExUcmFja2luZygpOwogICAgfQogICAgLy8gZG8gbm90IGFsbG93IGNvbXBsZXRlbHkgdW5ib3VuZGVkIGNhY2hlcwogICAgaWYgKHRoaXMuI21heCA9PT0gMCAmJiB0aGlzLnR0bCA9PT0gMCAmJiB0aGlzLiNtYXhTaXplID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiBtYXgsIG1heFNpemUsIG9yIHR0bCBpcyByZXF1aXJlZCcpOwogICAgfQogICAgaWYgKCF0aGlzLnR0bEF1dG9wdXJnZSAmJiAhdGhpcy4jbWF4ICYmICF0aGlzLiNtYXhTaXplKSB7CiAgICAgIGNvbnN0IGNvZGUgPSAnTFJVX0NBQ0hFX1VOQk9VTkRFRCc7CiAgICAgIGlmIChzaG91bGRXYXJuKGNvZGUpKSB7CiAgICAgICAgd2FybmVkLmFkZChjb2RlKTsKICAgICAgICBjb25zdCBtc2cgPSAnVFRMIGNhY2hpbmcgd2l0aG91dCB0dGxBdXRvcHVyZ2UsIG1heCwgb3IgbWF4U2l6ZSBjYW4gJyArICdyZXN1bHQgaW4gdW5ib3VuZGVkIG1lbW9yeSBjb25zdW1wdGlvbi4nOwogICAgICAgIGVtaXRXYXJuaW5nKG1zZywgJ1VuYm91bmRlZENhY2hlV2FybmluZycsIGNvZGUsIExSVUNhY2hlKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIG51bWJlciBvZiBtcyBsZWZ0IGluIHRoZSBpdGVtJ3MgVFRMLiBJZiBpdGVtIGlzIG5vdCBpbiBjYWNoZSwKICAgKiByZXR1cm5zIGAwYC4gUmV0dXJucyBgSW5maW5pdHlgIGlmIGl0ZW0gaXMgaW4gY2FjaGUgd2l0aG91dCBhIGRlZmluZWQgVFRMLgogICAqLwogIGdldFJlbWFpbmluZ1RUTChrZXkpIHsKICAgIHJldHVybiB0aGlzLiNrZXlNYXAuaGFzKGtleSkgPyBJbmZpbml0eSA6IDA7CiAgfQogICNpbml0aWFsaXplVFRMVHJhY2tpbmcoKSB7CiAgICBjb25zdCB0dGxzID0gbmV3IFplcm9BcnJheSh0aGlzLiNtYXgpOwogICAgY29uc3Qgc3RhcnRzID0gbmV3IFplcm9BcnJheSh0aGlzLiNtYXgpOwogICAgdGhpcy4jdHRscyA9IHR0bHM7CiAgICB0aGlzLiNzdGFydHMgPSBzdGFydHM7CiAgICB0aGlzLiNzZXRJdGVtVFRMID0gKGluZGV4LCB0dGwsIHN0YXJ0ID0gcGVyZi5ub3coKSkgPT4gewogICAgICBzdGFydHNbaW5kZXhdID0gdHRsICE9PSAwID8gc3RhcnQgOiAwOwogICAgICB0dGxzW2luZGV4XSA9IHR0bDsKICAgICAgaWYgKHR0bCAhPT0gMCAmJiB0aGlzLnR0bEF1dG9wdXJnZSkgewogICAgICAgIGNvbnN0IHQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGlmICh0aGlzLiNpc1N0YWxlKGluZGV4KSkgewogICAgICAgICAgICB0aGlzLiNkZWxldGUodGhpcy4ja2V5TGlzdFtpbmRleF0sICdleHBpcmUnKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0dGwgKyAxKTsKICAgICAgICAvLyB1bnJlZigpIG5vdCBzdXBwb3J0ZWQgb24gYWxsIHBsYXRmb3JtcwogICAgICAgIC8qIGM4IGlnbm9yZSBzdGFydCAqLwogICAgICAgIGlmICh0LnVucmVmKSB7CiAgICAgICAgICB0LnVucmVmKCk7CiAgICAgICAgfQogICAgICAgIC8qIGM4IGlnbm9yZSBzdG9wICovCiAgICAgIH0KICAgIH07CiAgICB0aGlzLiN1cGRhdGVJdGVtQWdlID0gaW5kZXggPT4gewogICAgICBzdGFydHNbaW5kZXhdID0gdHRsc1tpbmRleF0gIT09IDAgPyBwZXJmLm5vdygpIDogMDsKICAgIH07CiAgICB0aGlzLiNzdGF0dXNUVEwgPSAoc3RhdHVzLCBpbmRleCkgPT4gewogICAgICBpZiAodHRsc1tpbmRleF0pIHsKICAgICAgICBjb25zdCB0dGwgPSB0dGxzW2luZGV4XTsKICAgICAgICBjb25zdCBzdGFydCA9IHN0YXJ0c1tpbmRleF07CiAgICAgICAgLyogYzggaWdub3JlIG5leHQgKi8KICAgICAgICBpZiAoIXR0bCB8fCAhc3RhcnQpIHJldHVybjsKICAgICAgICBzdGF0dXMudHRsID0gdHRsOwogICAgICAgIHN0YXR1cy5zdGFydCA9IHN0YXJ0OwogICAgICAgIHN0YXR1cy5ub3cgPSBjYWNoZWROb3cgfHwgZ2V0Tm93KCk7CiAgICAgICAgY29uc3QgYWdlID0gc3RhdHVzLm5vdyAtIHN0YXJ0OwogICAgICAgIHN0YXR1cy5yZW1haW5pbmdUVEwgPSB0dGwgLSBhZ2U7CiAgICAgIH0KICAgIH07CiAgICAvLyBkZWJvdW5jZSBjYWxscyB0byBwZXJmLm5vdygpIHRvIDFzIHNvIHdlJ3JlIG5vdCBoaXR0aW5nCiAgICAvLyB0aGF0IGNvc3RseSBjYWxsIHJlcGVhdGVkbHkuCiAgICBsZXQgY2FjaGVkTm93ID0gMDsKICAgIGNvbnN0IGdldE5vdyA9ICgpID0+IHsKICAgICAgY29uc3QgbiA9IHBlcmYubm93KCk7CiAgICAgIGlmICh0aGlzLnR0bFJlc29sdXRpb24gPiAwKSB7CiAgICAgICAgY2FjaGVkTm93ID0gbjsKICAgICAgICBjb25zdCB0ID0gc2V0VGltZW91dCgoKSA9PiBjYWNoZWROb3cgPSAwLCB0aGlzLnR0bFJlc29sdXRpb24pOwogICAgICAgIC8vIG5vdCBhdmFpbGFibGUgb24gYWxsIHBsYXRmb3JtcwogICAgICAgIC8qIGM4IGlnbm9yZSBzdGFydCAqLwogICAgICAgIGlmICh0LnVucmVmKSB7CiAgICAgICAgICB0LnVucmVmKCk7CiAgICAgICAgfQogICAgICAgIC8qIGM4IGlnbm9yZSBzdG9wICovCiAgICAgIH0KICAgICAgcmV0dXJuIG47CiAgICB9OwogICAgdGhpcy5nZXRSZW1haW5pbmdUVEwgPSBrZXkgPT4gewogICAgICBjb25zdCBpbmRleCA9IHRoaXMuI2tleU1hcC5nZXQoa2V5KTsKICAgICAgaWYgKGluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCB0dGwgPSB0dGxzW2luZGV4XTsKICAgICAgY29uc3Qgc3RhcnQgPSBzdGFydHNbaW5kZXhdOwogICAgICBpZiAoIXR0bCB8fCAhc3RhcnQpIHsKICAgICAgICByZXR1cm4gSW5maW5pdHk7CiAgICAgIH0KICAgICAgY29uc3QgYWdlID0gKGNhY2hlZE5vdyB8fCBnZXROb3coKSkgLSBzdGFydDsKICAgICAgcmV0dXJuIHR0bCAtIGFnZTsKICAgIH07CiAgICB0aGlzLiNpc1N0YWxlID0gaW5kZXggPT4gewogICAgICBjb25zdCBzID0gc3RhcnRzW2luZGV4XTsKICAgICAgY29uc3QgdCA9IHR0bHNbaW5kZXhdOwogICAgICByZXR1cm4gISF0ICYmICEhcyAmJiAoY2FjaGVkTm93IHx8IGdldE5vdygpKSAtIHMgPiB0OwogICAgfTsKICB9CiAgLy8gY29uZGl0aW9uYWxseSBzZXQgcHJpdmF0ZSBtZXRob2RzIHJlbGF0ZWQgdG8gVFRMCiAgI3VwZGF0ZUl0ZW1BZ2UgPSAoKSA9PiB7fTsKICAjc3RhdHVzVFRMID0gKCkgPT4ge307CiAgI3NldEl0ZW1UVEwgPSAoKSA9PiB7fTsKICAvKiBjOCBpZ25vcmUgc3RvcCAqLwogICNpc1N0YWxlID0gKCkgPT4gZmFsc2U7CiAgI2luaXRpYWxpemVTaXplVHJhY2tpbmcoKSB7CiAgICBjb25zdCBzaXplcyA9IG5ldyBaZXJvQXJyYXkodGhpcy4jbWF4KTsKICAgIHRoaXMuI2NhbGN1bGF0ZWRTaXplID0gMDsKICAgIHRoaXMuI3NpemVzID0gc2l6ZXM7CiAgICB0aGlzLiNyZW1vdmVJdGVtU2l6ZSA9IGluZGV4ID0+IHsKICAgICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgLT0gc2l6ZXNbaW5kZXhdOwogICAgICBzaXplc1tpbmRleF0gPSAwOwogICAgfTsKICAgIHRoaXMuI3JlcXVpcmVTaXplID0gKGssIHYsIHNpemUsIHNpemVDYWxjdWxhdGlvbikgPT4gewogICAgICAvLyBwcm92aXNpb25hbGx5IGFjY2VwdCBiYWNrZ3JvdW5kIGZldGNoZXMuCiAgICAgIC8vIGFjdHVhbCB2YWx1ZSBzaXplIHdpbGwgYmUgY2hlY2tlZCB3aGVuIHRoZXkgcmV0dXJuLgogICAgICBpZiAodGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoIWlzUG9zSW50KHNpemUpKSB7CiAgICAgICAgaWYgKHNpemVDYWxjdWxhdGlvbikgewogICAgICAgICAgaWYgKHR5cGVvZiBzaXplQ2FsY3VsYXRpb24gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignc2l6ZUNhbGN1bGF0aW9uIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICAgICAgfQogICAgICAgICAgc2l6ZSA9IHNpemVDYWxjdWxhdGlvbih2LCBrKTsKICAgICAgICAgIGlmICghaXNQb3NJbnQoc2l6ZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignc2l6ZUNhbGN1bGF0aW9uIHJldHVybiBpbnZhbGlkIChleHBlY3QgcG9zaXRpdmUgaW50ZWdlciknKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignaW52YWxpZCBzaXplIHZhbHVlIChtdXN0IGJlIHBvc2l0aXZlIGludGVnZXIpLiAnICsgJ1doZW4gbWF4U2l6ZSBvciBtYXhFbnRyeVNpemUgaXMgdXNlZCwgc2l6ZUNhbGN1bGF0aW9uICcgKyAnb3Igc2l6ZSBtdXN0IGJlIHNldC4nKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgdGhpcy4jYWRkSXRlbVNpemUgPSAoaW5kZXgsIHNpemUsIHN0YXR1cykgPT4gewogICAgICBzaXplc1tpbmRleF0gPSBzaXplOwogICAgICBpZiAodGhpcy4jbWF4U2l6ZSkgewogICAgICAgIGNvbnN0IG1heFNpemUgPSB0aGlzLiNtYXhTaXplIC0gc2l6ZXNbaW5kZXhdOwogICAgICAgIHdoaWxlICh0aGlzLiNjYWxjdWxhdGVkU2l6ZSA+IG1heFNpemUpIHsKICAgICAgICAgIHRoaXMuI2V2aWN0KHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLiNjYWxjdWxhdGVkU2l6ZSArPSBzaXplc1tpbmRleF07CiAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuZW50cnlTaXplID0gc2l6ZTsKICAgICAgICBzdGF0dXMudG90YWxDYWxjdWxhdGVkU2l6ZSA9IHRoaXMuI2NhbGN1bGF0ZWRTaXplOwogICAgICB9CiAgICB9OwogIH0KICAjcmVtb3ZlSXRlbVNpemUgPSBfaSA9PiB7fTsKICAjYWRkSXRlbVNpemUgPSAoX2ksIF9zLCBfc3QpID0+IHt9OwogICNyZXF1aXJlU2l6ZSA9IChfaywgX3YsIHNpemUsIHNpemVDYWxjdWxhdGlvbikgPT4gewogICAgaWYgKHNpemUgfHwgc2l6ZUNhbGN1bGF0aW9uKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2Nhbm5vdCBzZXQgc2l6ZSB3aXRob3V0IHNldHRpbmcgbWF4U2l6ZSBvciBtYXhFbnRyeVNpemUgb24gY2FjaGUnKTsKICAgIH0KICAgIHJldHVybiAwOwogIH07CiAgKiNpbmRleGVzKHsKICAgIGFsbG93U3RhbGUgPSB0aGlzLmFsbG93U3RhbGUKICB9ID0ge30pIHsKICAgIGlmICh0aGlzLiNzaXplKSB7CiAgICAgIGZvciAobGV0IGkgPSB0aGlzLiN0YWlsOyB0cnVlOykgewogICAgICAgIGlmICghdGhpcy4jaXNWYWxpZEluZGV4KGkpKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKGFsbG93U3RhbGUgfHwgIXRoaXMuI2lzU3RhbGUoaSkpIHsKICAgICAgICAgIHlpZWxkIGk7CiAgICAgICAgfQogICAgICAgIGlmIChpID09PSB0aGlzLiNoZWFkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaSA9IHRoaXMuI3ByZXZbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogICojcmluZGV4ZXMoewogICAgYWxsb3dTdGFsZSA9IHRoaXMuYWxsb3dTdGFsZQogIH0gPSB7fSkgewogICAgaWYgKHRoaXMuI3NpemUpIHsKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuI2hlYWQ7IHRydWU7KSB7CiAgICAgICAgaWYgKCF0aGlzLiNpc1ZhbGlkSW5kZXgoaSkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAoYWxsb3dTdGFsZSB8fCAhdGhpcy4jaXNTdGFsZShpKSkgewogICAgICAgICAgeWllbGQgaTsKICAgICAgICB9CiAgICAgICAgaWYgKGkgPT09IHRoaXMuI3RhaWwpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpID0gdGhpcy4jbmV4dFtpXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgI2lzVmFsaWRJbmRleChpbmRleCkgewogICAgcmV0dXJuIGluZGV4ICE9PSB1bmRlZmluZWQgJiYgdGhpcy4ja2V5TWFwLmdldCh0aGlzLiNrZXlMaXN0W2luZGV4XSkgPT09IGluZGV4OwogIH0KICAvKioKICAgKiBSZXR1cm4gYSBnZW5lcmF0b3IgeWllbGRpbmcgYFtrZXksIHZhbHVlXWAgcGFpcnMsCiAgICogaW4gb3JkZXIgZnJvbSBtb3N0IHJlY2VudGx5IHVzZWQgdG8gbGVhc3QgcmVjZW50bHkgdXNlZC4KICAgKi8KICAqZW50cmllcygpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNpbmRleGVzKCkpIHsKICAgICAgaWYgKHRoaXMuI3ZhbExpc3RbaV0gIT09IHVuZGVmaW5lZCAmJiB0aGlzLiNrZXlMaXN0W2ldICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgW3RoaXMuI2tleUxpc3RbaV0sIHRoaXMuI3ZhbExpc3RbaV1dOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIEludmVyc2Ugb3JkZXIgdmVyc2lvbiBvZiB7QGxpbmsgTFJVQ2FjaGUuZW50cmllc30KICAgKgogICAqIFJldHVybiBhIGdlbmVyYXRvciB5aWVsZGluZyBgW2tleSwgdmFsdWVdYCBwYWlycywKICAgKiBpbiBvcmRlciBmcm9tIGxlYXN0IHJlY2VudGx5IHVzZWQgdG8gbW9zdCByZWNlbnRseSB1c2VkLgogICAqLwogICpyZW50cmllcygpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNyaW5kZXhlcygpKSB7CiAgICAgIGlmICh0aGlzLiN2YWxMaXN0W2ldICE9PSB1bmRlZmluZWQgJiYgdGhpcy4ja2V5TGlzdFtpXSAhPT0gdW5kZWZpbmVkICYmICF0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh0aGlzLiN2YWxMaXN0W2ldKSkgewogICAgICAgIHlpZWxkIFt0aGlzLiNrZXlMaXN0W2ldLCB0aGlzLiN2YWxMaXN0W2ldXTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gYSBnZW5lcmF0b3IgeWllbGRpbmcgdGhlIGtleXMgaW4gdGhlIGNhY2hlLAogICAqIGluIG9yZGVyIGZyb20gbW9zdCByZWNlbnRseSB1c2VkIHRvIGxlYXN0IHJlY2VudGx5IHVzZWQuCiAgICovCiAgKmtleXMoKSB7CiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy4jaW5kZXhlcygpKSB7CiAgICAgIGNvbnN0IGsgPSB0aGlzLiNrZXlMaXN0W2ldOwogICAgICBpZiAoayAhPT0gdW5kZWZpbmVkICYmICF0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh0aGlzLiN2YWxMaXN0W2ldKSkgewogICAgICAgIHlpZWxkIGs7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogSW52ZXJzZSBvcmRlciB2ZXJzaW9uIG9mIHtAbGluayBMUlVDYWNoZS5rZXlzfQogICAqCiAgICogUmV0dXJuIGEgZ2VuZXJhdG9yIHlpZWxkaW5nIHRoZSBrZXlzIGluIHRoZSBjYWNoZSwKICAgKiBpbiBvcmRlciBmcm9tIGxlYXN0IHJlY2VudGx5IHVzZWQgdG8gbW9zdCByZWNlbnRseSB1c2VkLgogICAqLwogICpya2V5cygpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNyaW5kZXhlcygpKSB7CiAgICAgIGNvbnN0IGsgPSB0aGlzLiNrZXlMaXN0W2ldOwogICAgICBpZiAoayAhPT0gdW5kZWZpbmVkICYmICF0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh0aGlzLiN2YWxMaXN0W2ldKSkgewogICAgICAgIHlpZWxkIGs7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJuIGEgZ2VuZXJhdG9yIHlpZWxkaW5nIHRoZSB2YWx1ZXMgaW4gdGhlIGNhY2hlLAogICAqIGluIG9yZGVyIGZyb20gbW9zdCByZWNlbnRseSB1c2VkIHRvIGxlYXN0IHJlY2VudGx5IHVzZWQuCiAgICovCiAgKnZhbHVlcygpIHsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNpbmRleGVzKCkpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaV07CiAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBJbnZlcnNlIG9yZGVyIHZlcnNpb24gb2Yge0BsaW5rIExSVUNhY2hlLnZhbHVlc30KICAgKgogICAqIFJldHVybiBhIGdlbmVyYXRvciB5aWVsZGluZyB0aGUgdmFsdWVzIGluIHRoZSBjYWNoZSwKICAgKiBpbiBvcmRlciBmcm9tIGxlYXN0IHJlY2VudGx5IHVzZWQgdG8gbW9zdCByZWNlbnRseSB1c2VkLgogICAqLwogICpydmFsdWVzKCkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI3JpbmRleGVzKCkpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaV07CiAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHRoaXMuI3ZhbExpc3RbaV0pKSB7CiAgICAgICAgeWllbGQgdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBJdGVyYXRpbmcgb3ZlciB0aGUgY2FjaGUgaXRzZWxmIHlpZWxkcyB0aGUgc2FtZSByZXN1bHRzIGFzCiAgICoge0BsaW5rIExSVUNhY2hlLmVudHJpZXN9CiAgICovCiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy5lbnRyaWVzKCk7CiAgfQogIC8qKgogICAqIEEgU3RyaW5nIHZhbHVlIHRoYXQgaXMgdXNlZCBpbiB0aGUgY3JlYXRpb24gb2YgdGhlIGRlZmF1bHQgc3RyaW5nCiAgICogZGVzY3JpcHRpb24gb2YgYW4gb2JqZWN0LiBDYWxsZWQgYnkgdGhlIGJ1aWx0LWluIG1ldGhvZAogICAqIGBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nYC4KICAgKi8KICBbU3ltYm9sLnRvU3RyaW5nVGFnXSA9ICdMUlVDYWNoZSc7CiAgLyoqCiAgICogRmluZCBhIHZhbHVlIGZvciB3aGljaCB0aGUgc3VwcGxpZWQgZm4gbWV0aG9kIHJldHVybnMgYSB0cnV0aHkgdmFsdWUsCiAgICogc2ltaWxhciB0byBgQXJyYXkuZmluZCgpYC4gZm4gaXMgY2FsbGVkIGFzIGBmbih2YWx1ZSwga2V5LCBjYWNoZSlgLgogICAqLwogIGZpbmQoZm4sIGdldE9wdGlvbnMgPSB7fSkgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI2luZGV4ZXMoKSkgewogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSA/IHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiB2OwogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgY29udGludWU7CiAgICAgIGlmIChmbih2YWx1ZSwgdGhpcy4ja2V5TGlzdFtpXSwgdGhpcykpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXQodGhpcy4ja2V5TGlzdFtpXSwgZ2V0T3B0aW9ucyk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogQ2FsbCB0aGUgc3VwcGxpZWQgZnVuY3Rpb24gb24gZWFjaCBpdGVtIGluIHRoZSBjYWNoZSwgaW4gb3JkZXIgZnJvbSBtb3N0CiAgICogcmVjZW50bHkgdXNlZCB0byBsZWFzdCByZWNlbnRseSB1c2VkLgogICAqCiAgICogYGZuYCBpcyBjYWxsZWQgYXMgYGZuKHZhbHVlLCBrZXksIGNhY2hlKWAuCiAgICoKICAgKiBJZiBgdGhpc3BgIGlzIHByb3ZpZGVkLCBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBpbiB0aGUgYHRoaXNgLWNvbnRleHQgb2YKICAgKiB0aGUgcHJvdmlkZWQgb2JqZWN0LCBvciB0aGUgY2FjaGUgaWYgbm8gYHRoaXNwYCBvYmplY3QgaXMgcHJvdmlkZWQuCiAgICoKICAgKiBEb2VzIG5vdCB1cGRhdGUgYWdlIG9yIHJlY2VudHkgb2YgdXNlLCBvciBpdGVyYXRlIG92ZXIgc3RhbGUgdmFsdWVzLgogICAqLwogIGZvckVhY2goZm4sIHRoaXNwID0gdGhpcykgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI2luZGV4ZXMoKSkgewogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpXTsKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSA/IHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiB2OwogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgY29udGludWU7CiAgICAgIGZuLmNhbGwodGhpc3AsIHZhbHVlLCB0aGlzLiNrZXlMaXN0W2ldLCB0aGlzKTsKICAgIH0KICB9CiAgLyoqCiAgICogVGhlIHNhbWUgYXMge0BsaW5rIExSVUNhY2hlLmZvckVhY2h9IGJ1dCBpdGVtcyBhcmUgaXRlcmF0ZWQgb3ZlciBpbgogICAqIHJldmVyc2Ugb3JkZXIuICAoaWUsIGxlc3MgcmVjZW50bHkgdXNlZCBpdGVtcyBhcmUgaXRlcmF0ZWQgb3ZlciBmaXJzdC4pCiAgICovCiAgcmZvckVhY2goZm4sIHRoaXNwID0gdGhpcykgewogICAgZm9yIChjb25zdCBpIG9mIHRoaXMuI3JpbmRleGVzKCkpIHsKICAgICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaV07CiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godikgPyB2Ll9fc3RhbGVXaGlsZUZldGNoaW5nIDogdjsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIGNvbnRpbnVlOwogICAgICBmbi5jYWxsKHRoaXNwLCB2YWx1ZSwgdGhpcy4ja2V5TGlzdFtpXSwgdGhpcyk7CiAgICB9CiAgfQogIC8qKgogICAqIERlbGV0ZSBhbnkgc3RhbGUgZW50cmllcy4gUmV0dXJucyB0cnVlIGlmIGFueXRoaW5nIHdhcyByZW1vdmVkLAogICAqIGZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBwdXJnZVN0YWxlKCkgewogICAgbGV0IGRlbGV0ZWQgPSBmYWxzZTsKICAgIGZvciAoY29uc3QgaSBvZiB0aGlzLiNyaW5kZXhlcyh7CiAgICAgIGFsbG93U3RhbGU6IHRydWUKICAgIH0pKSB7CiAgICAgIGlmICh0aGlzLiNpc1N0YWxlKGkpKSB7CiAgICAgICAgdGhpcy4jZGVsZXRlKHRoaXMuI2tleUxpc3RbaV0sICdleHBpcmUnKTsKICAgICAgICBkZWxldGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlbGV0ZWQ7CiAgfQogIC8qKgogICAqIEdldCB0aGUgZXh0ZW5kZWQgaW5mbyBhYm91dCBhIGdpdmVuIGVudHJ5LCB0byBnZXQgaXRzIHZhbHVlLCBzaXplLCBhbmQKICAgKiBUVEwgaW5mbyBzaW11bHRhbmVvdXNseS4gUmV0dXJucyBgdW5kZWZpbmVkYCBpZiB0aGUga2V5IGlzIG5vdCBwcmVzZW50LgogICAqCiAgICogVW5saWtlIHtAbGluayBMUlVDYWNoZSNkdW1wfSwgd2hpY2ggaXMgZGVzaWduZWQgdG8gYmUgcG9ydGFibGUgYW5kIHN1cnZpdmUKICAgKiBzZXJpYWxpemF0aW9uLCB0aGUgYHN0YXJ0YCB2YWx1ZSBpcyBhbHdheXMgdGhlIGN1cnJlbnQgdGltZXN0YW1wLCBhbmQgdGhlCiAgICogYHR0bGAgaXMgYSBjYWxjdWxhdGVkIHJlbWFpbmluZyB0aW1lIHRvIGxpdmUgKG5lZ2F0aXZlIGlmIGV4cGlyZWQpLgogICAqCiAgICogQWx3YXlzIHJldHVybnMgc3RhbGUgdmFsdWVzLCBpZiB0aGVpciBpbmZvIGlzIGZvdW5kIGluIHRoZSBjYWNoZSwgc28gYmUKICAgKiBzdXJlIHRvIGNoZWNrIGZvciBleHBpcmF0aW9ucyAoaWUsIGEgbmVnYXRpdmUge0BsaW5rIExSVUNhY2hlLkVudHJ5I3R0bH0pCiAgICogaWYgcmVsZXZhbnQuCiAgICovCiAgaW5mbyhrZXkpIHsKICAgIGNvbnN0IGkgPSB0aGlzLiNrZXlNYXAuZ2V0KGtleSk7CiAgICBpZiAoaSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgY29uc3QgdiA9IHRoaXMuI3ZhbExpc3RbaV07CiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpID8gdi5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHY7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IGVudHJ5ID0gewogICAgICB2YWx1ZQogICAgfTsKICAgIGlmICh0aGlzLiN0dGxzICYmIHRoaXMuI3N0YXJ0cykgewogICAgICBjb25zdCB0dGwgPSB0aGlzLiN0dGxzW2ldOwogICAgICBjb25zdCBzdGFydCA9IHRoaXMuI3N0YXJ0c1tpXTsKICAgICAgaWYgKHR0bCAmJiBzdGFydCkgewogICAgICAgIGNvbnN0IHJlbWFpbiA9IHR0bCAtIChwZXJmLm5vdygpIC0gc3RhcnQpOwogICAgICAgIGVudHJ5LnR0bCA9IHJlbWFpbjsKICAgICAgICBlbnRyeS5zdGFydCA9IERhdGUubm93KCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLiNzaXplcykgewogICAgICBlbnRyeS5zaXplID0gdGhpcy4jc2l6ZXNbaV07CiAgICB9CiAgICByZXR1cm4gZW50cnk7CiAgfQogIC8qKgogICAqIFJldHVybiBhbiBhcnJheSBvZiBba2V5LCB7QGxpbmsgTFJVQ2FjaGUuRW50cnl9XSB0dXBsZXMgd2hpY2ggY2FuIGJlCiAgICogcGFzc2VkIHRvIHtAbGluayBMUkxVQ2FjaGUjbG9hZH0uCiAgICoKICAgKiBUaGUgYHN0YXJ0YCBmaWVsZHMgYXJlIGNhbGN1bGF0ZWQgcmVsYXRpdmUgdG8gYSBwb3J0YWJsZSBgRGF0ZS5ub3coKWAKICAgKiB0aW1lc3RhbXAsIGV2ZW4gaWYgYHBlcmZvcm1hbmNlLm5vdygpYCBpcyBhdmFpbGFibGUuCiAgICoKICAgKiBTdGFsZSBlbnRyaWVzIGFyZSBhbHdheXMgaW5jbHVkZWQgaW4gdGhlIGBkdW1wYCwgZXZlbiBpZgogICAqIHtAbGluayBMUlVDYWNoZS5PcHRpb25zQmFzZS5hbGxvd1N0YWxlfSBpcyBmYWxzZS4KICAgKgogICAqIE5vdGU6IHRoaXMgcmV0dXJucyBhbiBhY3R1YWwgYXJyYXksIG5vdCBhIGdlbmVyYXRvciwgc28gaXQgY2FuIGJlIG1vcmUKICAgKiBlYXNpbHkgcGFzc2VkIGFyb3VuZC4KICAgKi8KICBkdW1wKCkgewogICAgY29uc3QgYXJyID0gW107CiAgICBmb3IgKGNvbnN0IGkgb2YgdGhpcy4jaW5kZXhlcyh7CiAgICAgIGFsbG93U3RhbGU6IHRydWUKICAgIH0pKSB7CiAgICAgIGNvbnN0IGtleSA9IHRoaXMuI2tleUxpc3RbaV07CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2ldOwogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpID8gdi5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHY7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IGtleSA9PT0gdW5kZWZpbmVkKSBjb250aW51ZTsKICAgICAgY29uc3QgZW50cnkgPSB7CiAgICAgICAgdmFsdWUKICAgICAgfTsKICAgICAgaWYgKHRoaXMuI3R0bHMgJiYgdGhpcy4jc3RhcnRzKSB7CiAgICAgICAgZW50cnkudHRsID0gdGhpcy4jdHRsc1tpXTsKICAgICAgICAvLyBhbHdheXMgZHVtcCB0aGUgc3RhcnQgcmVsYXRpdmUgdG8gYSBwb3J0YWJsZSB0aW1lc3RhbXAKICAgICAgICAvLyBpdCdzIG9rIGZvciB0aGlzIHRvIGJlIGEgYml0IHNsb3csIGl0J3MgYSByYXJlIG9wZXJhdGlvbi4KICAgICAgICBjb25zdCBhZ2UgPSBwZXJmLm5vdygpIC0gdGhpcy4jc3RhcnRzW2ldOwogICAgICAgIGVudHJ5LnN0YXJ0ID0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC0gYWdlKTsKICAgICAgfQogICAgICBpZiAodGhpcy4jc2l6ZXMpIHsKICAgICAgICBlbnRyeS5zaXplID0gdGhpcy4jc2l6ZXNbaV07CiAgICAgIH0KICAgICAgYXJyLnVuc2hpZnQoW2tleSwgZW50cnldKTsKICAgIH0KICAgIHJldHVybiBhcnI7CiAgfQogIC8qKgogICAqIFJlc2V0IHRoZSBjYWNoZSBhbmQgbG9hZCBpbiB0aGUgaXRlbXMgaW4gZW50cmllcyBpbiB0aGUgb3JkZXIgbGlzdGVkLgogICAqCiAgICogVGhlIHNoYXBlIG9mIHRoZSByZXN1bHRpbmcgY2FjaGUgbWF5IGJlIGRpZmZlcmVudCBpZiB0aGUgc2FtZSBvcHRpb25zIGFyZQogICAqIG5vdCB1c2VkIGluIGJvdGggY2FjaGVzLgogICAqCiAgICogVGhlIGBzdGFydGAgZmllbGRzIGFyZSBhc3N1bWVkIHRvIGJlIGNhbGN1bGF0ZWQgcmVsYXRpdmUgdG8gYSBwb3J0YWJsZQogICAqIGBEYXRlLm5vdygpYCB0aW1lc3RhbXAsIGV2ZW4gaWYgYHBlcmZvcm1hbmNlLm5vdygpYCBpcyBhdmFpbGFibGUuCiAgICovCiAgbG9hZChhcnIpIHsKICAgIHRoaXMuY2xlYXIoKTsKICAgIGZvciAoY29uc3QgW2tleSwgZW50cnldIG9mIGFycikgewogICAgICBpZiAoZW50cnkuc3RhcnQpIHsKICAgICAgICAvLyBlbnRyeS5zdGFydCBpcyBhIHBvcnRhYmxlIHRpbWVzdGFtcCwgYnV0IHdlIG1heSBiZSB1c2luZwogICAgICAgIC8vIG5vZGUncyBwZXJmb3JtYW5jZS5ub3coKSwgc28gY2FsY3VsYXRlIHRoZSBvZmZzZXQsIHNvIHRoYXQKICAgICAgICAvLyB3ZSBnZXQgdGhlIGludGVuZGVkIHJlbWFpbmluZyBUVEwsIG5vIG1hdHRlciBob3cgbG9uZyBpdCdzCiAgICAgICAgLy8gYmVlbiBvbiBpY2UuCiAgICAgICAgLy8KICAgICAgICAvLyBpdCdzIG9rIGZvciB0aGlzIHRvIGJlIGEgYml0IHNsb3csIGl0J3MgYSByYXJlIG9wZXJhdGlvbi4KICAgICAgICBjb25zdCBhZ2UgPSBEYXRlLm5vdygpIC0gZW50cnkuc3RhcnQ7CiAgICAgICAgZW50cnkuc3RhcnQgPSBwZXJmLm5vdygpIC0gYWdlOwogICAgICB9CiAgICAgIHRoaXMuc2V0KGtleSwgZW50cnkudmFsdWUsIGVudHJ5KTsKICAgIH0KICB9CiAgLyoqCiAgICogQWRkIGEgdmFsdWUgdG8gdGhlIGNhY2hlLgogICAqCiAgICogTm90ZTogaWYgYHVuZGVmaW5lZGAgaXMgc3BlY2lmaWVkIGFzIGEgdmFsdWUsIHRoaXMgaXMgYW4gYWxpYXMgZm9yCiAgICoge0BsaW5rIExSVUNhY2hlI2RlbGV0ZX0KICAgKgogICAqIEZpZWxkcyBvbiB0aGUge0BsaW5rIExSVUNhY2hlLlNldE9wdGlvbnN9IG9wdGlvbnMgcGFyYW0gd2lsbCBvdmVycmlkZQogICAqIHRoZWlyIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGluIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zIGZvciB0aGUgc2NvcGUKICAgKiBvZiB0aGlzIHNpbmdsZSBgc2V0KClgIG9wZXJhdGlvbi4KICAgKgogICAqIElmIGBzdGFydGAgaXMgcHJvdmlkZWQsIHRoZW4gdGhhdCB3aWxsIHNldCB0aGUgZWZmZWN0aXZlIHN0YXJ0CiAgICogdGltZSBmb3IgdGhlIFRUTCBjYWxjdWxhdGlvbi4gTm90ZSB0aGF0IHRoaXMgbXVzdCBiZSBhIHByZXZpb3VzCiAgICogdmFsdWUgb2YgYHBlcmZvcm1hbmNlLm5vdygpYCBpZiBzdXBwb3J0ZWQsIG9yIGEgcHJldmlvdXMgdmFsdWUgb2YKICAgKiBgRGF0ZS5ub3coKWAgaWYgbm90LgogICAqCiAgICogT3B0aW9ucyBvYmplY3QgbWF5IGFsc28gaW5jbHVkZSBgc2l6ZWAsIHdoaWNoIHdpbGwgcHJldmVudAogICAqIGNhbGxpbmcgdGhlIGBzaXplQ2FsY3VsYXRpb25gIGZ1bmN0aW9uIGFuZCBqdXN0IHVzZSB0aGUgc3BlY2lmaWVkCiAgICogbnVtYmVyIGlmIGl0IGlzIGEgcG9zaXRpdmUgaW50ZWdlciwgYW5kIGBub0Rpc3Bvc2VPblNldGAgd2hpY2gKICAgKiB3aWxsIHByZXZlbnQgY2FsbGluZyBhIGBkaXNwb3NlYCBmdW5jdGlvbiBpbiB0aGUgY2FzZSBvZgogICAqIG92ZXJ3cml0ZXMuCiAgICoKICAgKiBJZiB0aGUgYHNpemVgIChvciByZXR1cm4gdmFsdWUgb2YgYHNpemVDYWxjdWxhdGlvbmApIGZvciBhIGdpdmVuCiAgICogZW50cnkgaXMgZ3JlYXRlciB0aGFuIGBtYXhFbnRyeVNpemVgLCB0aGVuIHRoZSBpdGVtIHdpbGwgbm90IGJlCiAgICogYWRkZWQgdG8gdGhlIGNhY2hlLgogICAqCiAgICogV2lsbCB1cGRhdGUgdGhlIHJlY2VuY3kgb2YgdGhlIGVudHJ5LgogICAqCiAgICogSWYgdGhlIHZhbHVlIGlzIGB1bmRlZmluZWRgLCB0aGVuIHRoaXMgaXMgYW4gYWxpYXMgZm9yCiAgICogYGNhY2hlLmRlbGV0ZShrZXkpYC4gYHVuZGVmaW5lZGAgaXMgbmV2ZXIgc3RvcmVkIGluIHRoZSBjYWNoZS4KICAgKi8KICBzZXQoaywgdiwgc2V0T3B0aW9ucyA9IHt9KSB7CiAgICBpZiAodiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuZGVsZXRlKGspOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgdHRsID0gdGhpcy50dGwsCiAgICAgIHN0YXJ0LAogICAgICBub0Rpc3Bvc2VPblNldCA9IHRoaXMubm9EaXNwb3NlT25TZXQsCiAgICAgIHNpemVDYWxjdWxhdGlvbiA9IHRoaXMuc2l6ZUNhbGN1bGF0aW9uLAogICAgICBzdGF0dXMKICAgIH0gPSBzZXRPcHRpb25zOwogICAgbGV0IHsKICAgICAgbm9VcGRhdGVUVEwgPSB0aGlzLm5vVXBkYXRlVFRMCiAgICB9ID0gc2V0T3B0aW9uczsKICAgIGNvbnN0IHNpemUgPSB0aGlzLiNyZXF1aXJlU2l6ZShrLCB2LCBzZXRPcHRpb25zLnNpemUgfHwgMCwgc2l6ZUNhbGN1bGF0aW9uKTsKICAgIC8vIGlmIHRoZSBpdGVtIGRvZXNuJ3QgZml0LCBkb24ndCBkbyBhbnl0aGluZwogICAgLy8gTkI6IG1heEVudHJ5U2l6ZSBzZXQgdG8gbWF4U2l6ZSBieSBkZWZhdWx0CiAgICBpZiAodGhpcy5tYXhFbnRyeVNpemUgJiYgc2l6ZSA+IHRoaXMubWF4RW50cnlTaXplKSB7CiAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuc2V0ID0gJ21pc3MnOwogICAgICAgIHN0YXR1cy5tYXhFbnRyeVNpemVFeGNlZWRlZCA9IHRydWU7CiAgICAgIH0KICAgICAgLy8gaGF2ZSB0byBkZWxldGUsIGluIGNhc2Ugc29tZXRoaW5nIGlzIHRoZXJlIGFscmVhZHkuCiAgICAgIHRoaXMuI2RlbGV0ZShrLCAnc2V0Jyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgbGV0IGluZGV4ID0gdGhpcy4jc2l6ZSA9PT0gMCA/IHVuZGVmaW5lZCA6IHRoaXMuI2tleU1hcC5nZXQoayk7CiAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAvLyBhZGRpdGlvbgogICAgICBpbmRleCA9IHRoaXMuI3NpemUgPT09IDAgPyB0aGlzLiN0YWlsIDogdGhpcy4jZnJlZS5sZW5ndGggIT09IDAgPyB0aGlzLiNmcmVlLnBvcCgpIDogdGhpcy4jc2l6ZSA9PT0gdGhpcy4jbWF4ID8gdGhpcy4jZXZpY3QoZmFsc2UpIDogdGhpcy4jc2l6ZTsKICAgICAgdGhpcy4ja2V5TGlzdFtpbmRleF0gPSBrOwogICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IHY7CiAgICAgIHRoaXMuI2tleU1hcC5zZXQoaywgaW5kZXgpOwogICAgICB0aGlzLiNuZXh0W3RoaXMuI3RhaWxdID0gaW5kZXg7CiAgICAgIHRoaXMuI3ByZXZbaW5kZXhdID0gdGhpcy4jdGFpbDsKICAgICAgdGhpcy4jdGFpbCA9IGluZGV4OwogICAgICB0aGlzLiNzaXplKys7CiAgICAgIHRoaXMuI2FkZEl0ZW1TaXplKGluZGV4LCBzaXplLCBzdGF0dXMpOwogICAgICBpZiAoc3RhdHVzKSBzdGF0dXMuc2V0ID0gJ2FkZCc7CiAgICAgIG5vVXBkYXRlVFRMID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICAvLyB1cGRhdGUKICAgICAgdGhpcy4jbW92ZVRvVGFpbChpbmRleCk7CiAgICAgIGNvbnN0IG9sZFZhbCA9IHRoaXMuI3ZhbExpc3RbaW5kZXhdOwogICAgICBpZiAodiAhPT0gb2xkVmFsKSB7CiAgICAgICAgaWYgKHRoaXMuI2hhc0ZldGNoTWV0aG9kICYmIHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKG9sZFZhbCkpIHsKICAgICAgICAgIG9sZFZhbC5fX2Fib3J0Q29udHJvbGxlci5hYm9ydChuZXcgRXJyb3IoJ3JlcGxhY2VkJykpOwogICAgICAgICAgY29uc3QgewogICAgICAgICAgICBfX3N0YWxlV2hpbGVGZXRjaGluZzogcwogICAgICAgICAgfSA9IG9sZFZhbDsKICAgICAgICAgIGlmIChzICE9PSB1bmRlZmluZWQgJiYgIW5vRGlzcG9zZU9uU2V0KSB7CiAgICAgICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICAgICAgdmFyIF90aGlzJGRpc3Bvc2U7CiAgICAgICAgICAgICAgKF90aGlzJGRpc3Bvc2UgPSB0aGlzLiNkaXNwb3NlKSA9PT0gbnVsbCB8fCBfdGhpcyRkaXNwb3NlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRkaXNwb3NlLmNhbGwodGhpcywgcywgaywgJ3NldCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIpIHsKICAgICAgICAgICAgICB2YXIgX3RoaXMkZGlzcG9zZWQ7CiAgICAgICAgICAgICAgKF90aGlzJGRpc3Bvc2VkID0gdGhpcy4jZGlzcG9zZWQpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2VkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRkaXNwb3NlZC5wdXNoKFtzLCBrLCAnc2V0J10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghbm9EaXNwb3NlT25TZXQpIHsKICAgICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyRkaXNwb3NlMjsKICAgICAgICAgICAgKF90aGlzJGRpc3Bvc2UyID0gdGhpcy4jZGlzcG9zZSkgPT09IG51bGwgfHwgX3RoaXMkZGlzcG9zZTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2UyLmNhbGwodGhpcywgb2xkVmFsLCBrLCAnc2V0Jyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyRkaXNwb3NlZDI7CiAgICAgICAgICAgIChfdGhpcyRkaXNwb3NlZDIgPSB0aGlzLiNkaXNwb3NlZCkgPT09IG51bGwgfHwgX3RoaXMkZGlzcG9zZWQyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRkaXNwb3NlZDIucHVzaChbb2xkVmFsLCBrLCAnc2V0J10pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLiNyZW1vdmVJdGVtU2l6ZShpbmRleCk7CiAgICAgICAgdGhpcy4jYWRkSXRlbVNpemUoaW5kZXgsIHNpemUsIHN0YXR1cyk7CiAgICAgICAgdGhpcy4jdmFsTGlzdFtpbmRleF0gPSB2OwogICAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICAgIHN0YXR1cy5zZXQgPSAncmVwbGFjZSc7CiAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IG9sZFZhbCAmJiB0aGlzLiNpc0JhY2tncm91bmRGZXRjaChvbGRWYWwpID8gb2xkVmFsLl9fc3RhbGVXaGlsZUZldGNoaW5nIDogb2xkVmFsOwogICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSB1bmRlZmluZWQpIHN0YXR1cy5vbGRWYWx1ZSA9IG9sZFZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuc2V0ID0gJ3VwZGF0ZSc7CiAgICAgIH0KICAgIH0KICAgIGlmICh0dGwgIT09IDAgJiYgIXRoaXMuI3R0bHMpIHsKICAgICAgdGhpcy4jaW5pdGlhbGl6ZVRUTFRyYWNraW5nKCk7CiAgICB9CiAgICBpZiAodGhpcy4jdHRscykgewogICAgICBpZiAoIW5vVXBkYXRlVFRMKSB7CiAgICAgICAgdGhpcy4jc2V0SXRlbVRUTChpbmRleCwgdHRsLCBzdGFydCk7CiAgICAgIH0KICAgICAgaWYgKHN0YXR1cykgdGhpcy4jc3RhdHVzVFRMKHN0YXR1cywgaW5kZXgpOwogICAgfQogICAgaWYgKCFub0Rpc3Bvc2VPblNldCAmJiB0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIgJiYgdGhpcy4jZGlzcG9zZWQpIHsKICAgICAgY29uc3QgZHQgPSB0aGlzLiNkaXNwb3NlZDsKICAgICAgbGV0IHRhc2s7CiAgICAgIHdoaWxlICh0YXNrID0gZHQgPT09IG51bGwgfHwgZHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGR0LnNoaWZ0KCkpIHsKICAgICAgICB2YXIgX3RoaXMkZGlzcG9zZUFmdGVyOwogICAgICAgIChfdGhpcyRkaXNwb3NlQWZ0ZXIgPSB0aGlzLiNkaXNwb3NlQWZ0ZXIpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2VBZnRlciA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkZGlzcG9zZUFmdGVyLmNhbGwodGhpcywgLi4udGFzayk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBFdmljdCB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCBpdGVtLCByZXR1cm5pbmcgaXRzIHZhbHVlIG9yCiAgICogYHVuZGVmaW5lZGAgaWYgY2FjaGUgaXMgZW1wdHkuCiAgICovCiAgcG9wKCkgewogICAgdHJ5IHsKICAgICAgd2hpbGUgKHRoaXMuI3NpemUpIHsKICAgICAgICBjb25zdCB2YWwgPSB0aGlzLiN2YWxMaXN0W3RoaXMuI2hlYWRdOwogICAgICAgIHRoaXMuI2V2aWN0KHRydWUpOwogICAgICAgIGlmICh0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2YWwpKSB7CiAgICAgICAgICBpZiAodmFsLl9fc3RhbGVXaGlsZUZldGNoaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB2YWwuX19zdGFsZVdoaWxlRmV0Y2hpbmc7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWwgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIgJiYgdGhpcy4jZGlzcG9zZWQpIHsKICAgICAgICBjb25zdCBkdCA9IHRoaXMuI2Rpc3Bvc2VkOwogICAgICAgIGxldCB0YXNrOwogICAgICAgIHdoaWxlICh0YXNrID0gZHQgPT09IG51bGwgfHwgZHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGR0LnNoaWZ0KCkpIHsKICAgICAgICAgIHZhciBfdGhpcyRkaXNwb3NlQWZ0ZXIyOwogICAgICAgICAgKF90aGlzJGRpc3Bvc2VBZnRlcjIgPSB0aGlzLiNkaXNwb3NlQWZ0ZXIpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2VBZnRlcjIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VBZnRlcjIuY2FsbCh0aGlzLCAuLi50YXNrKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgI2V2aWN0KGZyZWUpIHsKICAgIGNvbnN0IGhlYWQgPSB0aGlzLiNoZWFkOwogICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaGVhZF07CiAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtoZWFkXTsKICAgIGlmICh0aGlzLiNoYXNGZXRjaE1ldGhvZCAmJiB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSkgewogICAgICB2Ll9fYWJvcnRDb250cm9sbGVyLmFib3J0KG5ldyBFcnJvcignZXZpY3RlZCcpKTsKICAgIH0gZWxzZSBpZiAodGhpcy4jaGFzRGlzcG9zZSB8fCB0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIpIHsKICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2UpIHsKICAgICAgICB2YXIgX3RoaXMkZGlzcG9zZTM7CiAgICAgICAgKF90aGlzJGRpc3Bvc2UzID0gdGhpcy4jZGlzcG9zZSkgPT09IG51bGwgfHwgX3RoaXMkZGlzcG9zZTMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2UzLmNhbGwodGhpcywgdiwgaywgJ2V2aWN0Jyk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgIHZhciBfdGhpcyRkaXNwb3NlZDM7CiAgICAgICAgKF90aGlzJGRpc3Bvc2VkMyA9IHRoaXMuI2Rpc3Bvc2VkKSA9PT0gbnVsbCB8fCBfdGhpcyRkaXNwb3NlZDMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VkMy5wdXNoKFt2LCBrLCAnZXZpY3QnXSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3JlbW92ZUl0ZW1TaXplKGhlYWQpOwogICAgLy8gaWYgd2UgYXJlbid0IGFib3V0IHRvIHVzZSB0aGUgaW5kZXgsIHRoZW4gbnVsbCB0aGVzZSBvdXQKICAgIGlmIChmcmVlKSB7CiAgICAgIHRoaXMuI2tleUxpc3RbaGVhZF0gPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuI3ZhbExpc3RbaGVhZF0gPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuI2ZyZWUucHVzaChoZWFkKTsKICAgIH0KICAgIGlmICh0aGlzLiNzaXplID09PSAxKSB7CiAgICAgIHRoaXMuI2hlYWQgPSB0aGlzLiN0YWlsID0gMDsKICAgICAgdGhpcy4jZnJlZS5sZW5ndGggPSAwOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jaGVhZCA9IHRoaXMuI25leHRbaGVhZF07CiAgICB9CiAgICB0aGlzLiNrZXlNYXAuZGVsZXRlKGspOwogICAgdGhpcy4jc2l6ZS0tOwogICAgcmV0dXJuIGhlYWQ7CiAgfQogIC8qKgogICAqIENoZWNrIGlmIGEga2V5IGlzIGluIHRoZSBjYWNoZSwgd2l0aG91dCB1cGRhdGluZyB0aGUgcmVjZW5jeSBvZiB1c2UuCiAgICogV2lsbCByZXR1cm4gZmFsc2UgaWYgdGhlIGl0ZW0gaXMgc3RhbGUsIGV2ZW4gdGhvdWdoIGl0IGlzIHRlY2huaWNhbGx5CiAgICogaW4gdGhlIGNhY2hlLgogICAqCiAgICogQ2hlY2sgaWYgYSBrZXkgaXMgaW4gdGhlIGNhY2hlLCB3aXRob3V0IHVwZGF0aW5nIHRoZSByZWNlbmN5IG9mCiAgICogdXNlLiBBZ2UgaXMgdXBkYXRlZCBpZiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudXBkYXRlQWdlT25IYXN9IGlzIHNldAogICAqIHRvIGB0cnVlYCBpbiBlaXRoZXIgdGhlIG9wdGlvbnMgb3IgdGhlIGNvbnN0cnVjdG9yLgogICAqCiAgICogV2lsbCByZXR1cm4gYGZhbHNlYCBpZiB0aGUgaXRlbSBpcyBzdGFsZSwgZXZlbiB0aG91Z2ggaXQgaXMgdGVjaG5pY2FsbHkgaW4KICAgKiB0aGUgY2FjaGUuIFRoZSBkaWZmZXJlbmNlIGNhbiBiZSBkZXRlcm1pbmVkIChpZiBpdCBtYXR0ZXJzKSBieSB1c2luZyBhCiAgICogYHN0YXR1c2AgYXJndW1lbnQsIGFuZCBpbnNwZWN0aW5nIHRoZSBgaGFzYCBmaWVsZC4KICAgKgogICAqIFdpbGwgbm90IHVwZGF0ZSBpdGVtIGFnZSB1bmxlc3MKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UudXBkYXRlQWdlT25IYXN9IGlzIHNldC4KICAgKi8KICBoYXMoaywgaGFzT3B0aW9ucyA9IHt9KSB7CiAgICBjb25zdCB7CiAgICAgIHVwZGF0ZUFnZU9uSGFzID0gdGhpcy51cGRhdGVBZ2VPbkhhcywKICAgICAgc3RhdHVzCiAgICB9ID0gaGFzT3B0aW9uczsKICAgIGNvbnN0IGluZGV4ID0gdGhpcy4ja2V5TWFwLmdldChrKTsKICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpICYmIHYuX19zdGFsZVdoaWxlRmV0Y2hpbmcgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoIXRoaXMuI2lzU3RhbGUoaW5kZXgpKSB7CiAgICAgICAgaWYgKHVwZGF0ZUFnZU9uSGFzKSB7CiAgICAgICAgICB0aGlzLiN1cGRhdGVJdGVtQWdlKGluZGV4KTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgc3RhdHVzLmhhcyA9ICdoaXQnOwogICAgICAgICAgdGhpcy4jc3RhdHVzVFRMKHN0YXR1cywgaW5kZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuaGFzID0gJ3N0YWxlJzsKICAgICAgICB0aGlzLiNzdGF0dXNUVEwoc3RhdHVzLCBpbmRleCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoc3RhdHVzKSB7CiAgICAgIHN0YXR1cy5oYXMgPSAnbWlzcyc7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIC8qKgogICAqIExpa2Uge0BsaW5rIExSVUNhY2hlI2dldH0gYnV0IGRvZXNuJ3QgdXBkYXRlIHJlY2VuY3kgb3IgZGVsZXRlIHN0YWxlCiAgICogaXRlbXMuCiAgICoKICAgKiBSZXR1cm5zIGB1bmRlZmluZWRgIGlmIHRoZSBpdGVtIGlzIHN0YWxlLCB1bmxlc3MKICAgKiB7QGxpbmsgTFJVQ2FjaGUuT3B0aW9uc0Jhc2UuYWxsb3dTdGFsZX0gaXMgc2V0LgogICAqLwogIHBlZWsoaywgcGVla09wdGlvbnMgPSB7fSkgewogICAgY29uc3QgewogICAgICBhbGxvd1N0YWxlID0gdGhpcy5hbGxvd1N0YWxlCiAgICB9ID0gcGVla09wdGlvbnM7CiAgICBjb25zdCBpbmRleCA9IHRoaXMuI2tleU1hcC5nZXQoayk7CiAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCB8fCAhYWxsb3dTdGFsZSAmJiB0aGlzLiNpc1N0YWxlKGluZGV4KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpbmRleF07CiAgICAvLyBlaXRoZXIgc3RhbGUgYW5kIGFsbG93ZWQsIG9yIGZvcmNpbmcgYSByZWZyZXNoIG9mIG5vbi1zdGFsZSB2YWx1ZQogICAgcmV0dXJuIHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpID8gdi5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHY7CiAgfQogICNiYWNrZ3JvdW5kRmV0Y2goaywgaW5kZXgsIG9wdGlvbnMsIGNvbnRleHQpIHsKICAgIGNvbnN0IHYgPSBpbmRleCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogdGhpcy4jdmFsTGlzdFtpbmRleF07CiAgICBpZiAodGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godikpIHsKICAgICAgcmV0dXJuIHY7CiAgICB9CiAgICBjb25zdCBhYyA9IG5ldyBBQygpOwogICAgY29uc3QgewogICAgICBzaWduYWwKICAgIH0gPSBvcHRpb25zOwogICAgLy8gd2hlbi9pZiBvdXIgQUMgc2lnbmFscywgdGhlbiBzdG9wIGxpc3RlbmluZyB0byB0aGVpcnMuCiAgICBzaWduYWwgPT09IG51bGwgfHwgc2lnbmFsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCAoKSA9PiBhYy5hYm9ydChzaWduYWwucmVhc29uKSwgewogICAgICBzaWduYWw6IGFjLnNpZ25hbAogICAgfSk7CiAgICBjb25zdCBmZXRjaE9wdHMgPSB7CiAgICAgIHNpZ25hbDogYWMuc2lnbmFsLAogICAgICBvcHRpb25zLAogICAgICBjb250ZXh0CiAgICB9OwogICAgY29uc3QgY2IgPSAodiwgdXBkYXRlQ2FjaGUgPSBmYWxzZSkgPT4gewogICAgICBjb25zdCB7CiAgICAgICAgYWJvcnRlZAogICAgICB9ID0gYWMuc2lnbmFsOwogICAgICBjb25zdCBpZ25vcmVBYm9ydCA9IG9wdGlvbnMuaWdub3JlRmV0Y2hBYm9ydCAmJiB2ICE9PSB1bmRlZmluZWQ7CiAgICAgIGlmIChvcHRpb25zLnN0YXR1cykgewogICAgICAgIGlmIChhYm9ydGVkICYmICF1cGRhdGVDYWNoZSkgewogICAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hBYm9ydGVkID0gdHJ1ZTsKICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoRXJyb3IgPSBhYy5zaWduYWwucmVhc29uOwogICAgICAgICAgaWYgKGlnbm9yZUFib3J0KSBvcHRpb25zLnN0YXR1cy5mZXRjaEFib3J0SWdub3JlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMuc3RhdHVzLmZldGNoUmVzb2x2ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYWJvcnRlZCAmJiAhaWdub3JlQWJvcnQgJiYgIXVwZGF0ZUNhY2hlKSB7CiAgICAgICAgcmV0dXJuIGZldGNoRmFpbChhYy5zaWduYWwucmVhc29uKTsKICAgICAgfQogICAgICAvLyBlaXRoZXIgd2UgZGlkbid0IGFib3J0LCBhbmQgYXJlIHN0aWxsIGhlcmUsIG9yIHdlIGRpZCwgYW5kIGlnbm9yZWQKICAgICAgY29uc3QgYmYgPSBwOwogICAgICBpZiAodGhpcy4jdmFsTGlzdFtpbmRleF0gPT09IHApIHsKICAgICAgICBpZiAodiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpZiAoYmYuX19zdGFsZVdoaWxlRmV0Y2hpbmcpIHsKICAgICAgICAgICAgdGhpcy4jdmFsTGlzdFtpbmRleF0gPSBiZi5fX3N0YWxlV2hpbGVGZXRjaGluZzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuI2RlbGV0ZShrLCAnZmV0Y2gnKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9wdGlvbnMuc3RhdHVzKSBvcHRpb25zLnN0YXR1cy5mZXRjaFVwZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdGhpcy5zZXQoaywgdiwgZmV0Y2hPcHRzLm9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdjsKICAgIH07CiAgICBjb25zdCBlYiA9IGVyID0+IHsKICAgICAgaWYgKG9wdGlvbnMuc3RhdHVzKSB7CiAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hSZWplY3RlZCA9IHRydWU7CiAgICAgICAgb3B0aW9ucy5zdGF0dXMuZmV0Y2hFcnJvciA9IGVyOwogICAgICB9CiAgICAgIHJldHVybiBmZXRjaEZhaWwoZXIpOwogICAgfTsKICAgIGNvbnN0IGZldGNoRmFpbCA9IGVyID0+IHsKICAgICAgY29uc3QgewogICAgICAgIGFib3J0ZWQKICAgICAgfSA9IGFjLnNpZ25hbDsKICAgICAgY29uc3QgYWxsb3dTdGFsZUFib3J0ZWQgPSBhYm9ydGVkICYmIG9wdGlvbnMuYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydDsKICAgICAgY29uc3QgYWxsb3dTdGFsZSA9IGFsbG93U3RhbGVBYm9ydGVkIHx8IG9wdGlvbnMuYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb247CiAgICAgIGNvbnN0IG5vRGVsZXRlID0gYWxsb3dTdGFsZSB8fCBvcHRpb25zLm5vRGVsZXRlT25GZXRjaFJlamVjdGlvbjsKICAgICAgY29uc3QgYmYgPSBwOwogICAgICBpZiAodGhpcy4jdmFsTGlzdFtpbmRleF0gPT09IHApIHsKICAgICAgICAvLyBpZiB3ZSBhbGxvdyBzdGFsZSBvbiBmZXRjaCByZWplY3Rpb25zLCB0aGVuIHdlIG5lZWQgdG8gZW5zdXJlIHRoYXQKICAgICAgICAvLyB0aGUgc3RhbGUgdmFsdWUgaXMgbm90IHJlbW92ZWQgZnJvbSB0aGUgY2FjaGUgd2hlbiB0aGUgZmV0Y2ggZmFpbHMuCiAgICAgICAgY29uc3QgZGVsID0gIW5vRGVsZXRlIHx8IGJmLl9fc3RhbGVXaGlsZUZldGNoaW5nID09PSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGRlbCkgewogICAgICAgICAgdGhpcy4jZGVsZXRlKGssICdmZXRjaCcpOwogICAgICAgIH0gZWxzZSBpZiAoIWFsbG93U3RhbGVBYm9ydGVkKSB7CiAgICAgICAgICAvLyBzdGlsbCByZXBsYWNlIHRoZSAqcHJvbWlzZSogd2l0aCB0aGUgc3RhbGUgdmFsdWUsCiAgICAgICAgICAvLyBzaW5jZSB3ZSBhcmUgZG9uZSB3aXRoIHRoZSBwcm9taXNlIGF0IHRoaXMgcG9pbnQuCiAgICAgICAgICAvLyBsZWF2ZSBpdCB1bnRvdWNoZWQgaWYgd2UncmUgc3RpbGwgd2FpdGluZyBmb3IgYW4KICAgICAgICAgIC8vIGFib3J0ZWQgYmFja2dyb3VuZCBmZXRjaCB0aGF0IGhhc24ndCB5ZXQgcmV0dXJuZWQuCiAgICAgICAgICB0aGlzLiN2YWxMaXN0W2luZGV4XSA9IGJmLl9fc3RhbGVXaGlsZUZldGNoaW5nOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoYWxsb3dTdGFsZSkgewogICAgICAgIGlmIChvcHRpb25zLnN0YXR1cyAmJiBiZi5fX3N0YWxlV2hpbGVGZXRjaGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBvcHRpb25zLnN0YXR1cy5yZXR1cm5lZFN0YWxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJmLl9fc3RhbGVXaGlsZUZldGNoaW5nOwogICAgICB9IGVsc2UgaWYgKGJmLl9fcmV0dXJuZWQgPT09IGJmKSB7CiAgICAgICAgdGhyb3cgZXI7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwY2FsbCA9IChyZXMsIHJlaikgPT4gewogICAgICB2YXIgX3RoaXMkZmV0Y2hNZXRob2Q7CiAgICAgIGNvbnN0IGZtcCA9IChfdGhpcyRmZXRjaE1ldGhvZCA9IHRoaXMuI2ZldGNoTWV0aG9kKSA9PT0gbnVsbCB8fCBfdGhpcyRmZXRjaE1ldGhvZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkZmV0Y2hNZXRob2QuY2FsbCh0aGlzLCBrLCB2LCBmZXRjaE9wdHMpOwogICAgICBpZiAoZm1wICYmIGZtcCBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICBmbXAudGhlbih2ID0+IHJlcyh2ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiB2KSwgcmVqKTsKICAgICAgfQogICAgICAvLyBpZ25vcmVkLCB3ZSBnbyB1bnRpbCB3ZSBmaW5pc2gsIHJlZ2FyZGxlc3MuCiAgICAgIC8vIGRlZmVyIGNoZWNrIHVudGlsIHdlIGFyZSBhY3R1YWxseSBhYm9ydGluZywKICAgICAgLy8gc28gZmV0Y2hNZXRob2QgY2FuIG92ZXJyaWRlLgogICAgICBhYy5zaWduYWwuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCAoKSA9PiB7CiAgICAgICAgaWYgKCFvcHRpb25zLmlnbm9yZUZldGNoQWJvcnQgfHwgb3B0aW9ucy5hbGxvd1N0YWxlT25GZXRjaEFib3J0KSB7CiAgICAgICAgICByZXModW5kZWZpbmVkKTsKICAgICAgICAgIC8vIHdoZW4gaXQgZXZlbnR1YWxseSByZXNvbHZlcywgdXBkYXRlIHRoZSBjYWNoZS4KICAgICAgICAgIGlmIChvcHRpb25zLmFsbG93U3RhbGVPbkZldGNoQWJvcnQpIHsKICAgICAgICAgICAgcmVzID0gdiA9PiBjYih2LCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIGlmIChvcHRpb25zLnN0YXR1cykgb3B0aW9ucy5zdGF0dXMuZmV0Y2hEaXNwYXRjaGVkID0gdHJ1ZTsKICAgIGNvbnN0IHAgPSBuZXcgUHJvbWlzZShwY2FsbCkudGhlbihjYiwgZWIpOwogICAgY29uc3QgYmYgPSBPYmplY3QuYXNzaWduKHAsIHsKICAgICAgX19hYm9ydENvbnRyb2xsZXI6IGFjLAogICAgICBfX3N0YWxlV2hpbGVGZXRjaGluZzogdiwKICAgICAgX19yZXR1cm5lZDogdW5kZWZpbmVkCiAgICB9KTsKICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIGludGVybmFsLCBkb24ndCBleHBvc2Ugc3RhdHVzLgogICAgICB0aGlzLnNldChrLCBiZiwgX29iamVjdFNwcmVhZCQ0KF9vYmplY3RTcHJlYWQkNCh7fSwgZmV0Y2hPcHRzLm9wdGlvbnMpLCB7fSwgewogICAgICAgIHN0YXR1czogdW5kZWZpbmVkCiAgICAgIH0pKTsKICAgICAgaW5kZXggPSB0aGlzLiNrZXlNYXAuZ2V0KGspOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jdmFsTGlzdFtpbmRleF0gPSBiZjsKICAgIH0KICAgIHJldHVybiBiZjsKICB9CiAgI2lzQmFja2dyb3VuZEZldGNoKHApIHsKICAgIGlmICghdGhpcy4jaGFzRmV0Y2hNZXRob2QpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGIgPSBwOwogICAgcmV0dXJuICEhYiAmJiBiIGluc3RhbmNlb2YgUHJvbWlzZSAmJiBiLmhhc093blByb3BlcnR5KCdfX3N0YWxlV2hpbGVGZXRjaGluZycpICYmIGIuX19hYm9ydENvbnRyb2xsZXIgaW5zdGFuY2VvZiBBQzsKICB9CiAgYXN5bmMgZmV0Y2goaywgZmV0Y2hPcHRpb25zID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgLy8gZ2V0IG9wdGlvbnMKICAgICAgYWxsb3dTdGFsZSA9IHRoaXMuYWxsb3dTdGFsZSwKICAgICAgdXBkYXRlQWdlT25HZXQgPSB0aGlzLnVwZGF0ZUFnZU9uR2V0LAogICAgICBub0RlbGV0ZU9uU3RhbGVHZXQgPSB0aGlzLm5vRGVsZXRlT25TdGFsZUdldCwKICAgICAgLy8gc2V0IG9wdGlvbnMKICAgICAgdHRsID0gdGhpcy50dGwsCiAgICAgIG5vRGlzcG9zZU9uU2V0ID0gdGhpcy5ub0Rpc3Bvc2VPblNldCwKICAgICAgc2l6ZSA9IDAsCiAgICAgIHNpemVDYWxjdWxhdGlvbiA9IHRoaXMuc2l6ZUNhbGN1bGF0aW9uLAogICAgICBub1VwZGF0ZVRUTCA9IHRoaXMubm9VcGRhdGVUVEwsCiAgICAgIC8vIGZldGNoIGV4Y2x1c2l2ZSBvcHRpb25zCiAgICAgIG5vRGVsZXRlT25GZXRjaFJlamVjdGlvbiA9IHRoaXMubm9EZWxldGVPbkZldGNoUmVqZWN0aW9uLAogICAgICBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiA9IHRoaXMuYWxsb3dTdGFsZU9uRmV0Y2hSZWplY3Rpb24sCiAgICAgIGlnbm9yZUZldGNoQWJvcnQgPSB0aGlzLmlnbm9yZUZldGNoQWJvcnQsCiAgICAgIGFsbG93U3RhbGVPbkZldGNoQWJvcnQgPSB0aGlzLmFsbG93U3RhbGVPbkZldGNoQWJvcnQsCiAgICAgIGNvbnRleHQsCiAgICAgIGZvcmNlUmVmcmVzaCA9IGZhbHNlLAogICAgICBzdGF0dXMsCiAgICAgIHNpZ25hbAogICAgfSA9IGZldGNoT3B0aW9uczsKICAgIGlmICghdGhpcy4jaGFzRmV0Y2hNZXRob2QpIHsKICAgICAgaWYgKHN0YXR1cykgc3RhdHVzLmZldGNoID0gJ2dldCc7CiAgICAgIHJldHVybiB0aGlzLmdldChrLCB7CiAgICAgICAgYWxsb3dTdGFsZSwKICAgICAgICB1cGRhdGVBZ2VPbkdldCwKICAgICAgICBub0RlbGV0ZU9uU3RhbGVHZXQsCiAgICAgICAgc3RhdHVzCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgYWxsb3dTdGFsZSwKICAgICAgdXBkYXRlQWdlT25HZXQsCiAgICAgIG5vRGVsZXRlT25TdGFsZUdldCwKICAgICAgdHRsLAogICAgICBub0Rpc3Bvc2VPblNldCwKICAgICAgc2l6ZSwKICAgICAgc2l6ZUNhbGN1bGF0aW9uLAogICAgICBub1VwZGF0ZVRUTCwKICAgICAgbm9EZWxldGVPbkZldGNoUmVqZWN0aW9uLAogICAgICBhbGxvd1N0YWxlT25GZXRjaFJlamVjdGlvbiwKICAgICAgYWxsb3dTdGFsZU9uRmV0Y2hBYm9ydCwKICAgICAgaWdub3JlRmV0Y2hBYm9ydCwKICAgICAgc3RhdHVzLAogICAgICBzaWduYWwKICAgIH07CiAgICBsZXQgaW5kZXggPSB0aGlzLiNrZXlNYXAuZ2V0KGspOwogICAgaWYgKGluZGV4ID09PSB1bmRlZmluZWQpIHsKICAgICAgaWYgKHN0YXR1cykgc3RhdHVzLmZldGNoID0gJ21pc3MnOwogICAgICBjb25zdCBwID0gdGhpcy4jYmFja2dyb3VuZEZldGNoKGssIGluZGV4LCBvcHRpb25zLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHAuX19yZXR1cm5lZCA9IHA7CiAgICB9IGVsc2UgewogICAgICAvLyBpbiBjYWNoZSwgbWF5YmUgYWxyZWFkeSBmZXRjaGluZwogICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpbmRleF07CiAgICAgIGlmICh0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2KSkgewogICAgICAgIGNvbnN0IHN0YWxlID0gYWxsb3dTdGFsZSAmJiB2Ll9fc3RhbGVXaGlsZUZldGNoaW5nICE9PSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgc3RhdHVzLmZldGNoID0gJ2luZmxpZ2h0JzsKICAgICAgICAgIGlmIChzdGFsZSkgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhbGUgPyB2Ll9fc3RhbGVXaGlsZUZldGNoaW5nIDogdi5fX3JldHVybmVkID0gdjsKICAgICAgfQogICAgICAvLyBpZiB3ZSBmb3JjZSBhIHJlZnJlc2gsIHRoYXQgbWVhbnMgZG8gTk9UIHNlcnZlIHRoZSBjYWNoZWQgdmFsdWUsCiAgICAgIC8vIHVubGVzcyB3ZSBhcmUgYWxyZWFkeSBpbiB0aGUgcHJvY2VzcyBvZiByZWZyZXNoaW5nIHRoZSBjYWNoZS4KICAgICAgY29uc3QgaXNTdGFsZSA9IHRoaXMuI2lzU3RhbGUoaW5kZXgpOwogICAgICBpZiAoIWZvcmNlUmVmcmVzaCAmJiAhaXNTdGFsZSkgewogICAgICAgIGlmIChzdGF0dXMpIHN0YXR1cy5mZXRjaCA9ICdoaXQnOwogICAgICAgIHRoaXMuI21vdmVUb1RhaWwoaW5kZXgpOwogICAgICAgIGlmICh1cGRhdGVBZ2VPbkdldCkgewogICAgICAgICAgdGhpcy4jdXBkYXRlSXRlbUFnZShpbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0dXMpIHRoaXMuI3N0YXR1c1RUTChzdGF0dXMsIGluZGV4KTsKICAgICAgICByZXR1cm4gdjsKICAgICAgfQogICAgICAvLyBvaywgaXQgaXMgc3RhbGUgb3IgYSBmb3JjZWQgcmVmcmVzaCwgYW5kIG5vdCBhbHJlYWR5IGZldGNoaW5nLgogICAgICAvLyByZWZyZXNoIHRoZSBjYWNoZS4KICAgICAgY29uc3QgcCA9IHRoaXMuI2JhY2tncm91bmRGZXRjaChrLCBpbmRleCwgb3B0aW9ucywgY29udGV4dCk7CiAgICAgIGNvbnN0IGhhc1N0YWxlID0gcC5fX3N0YWxlV2hpbGVGZXRjaGluZyAhPT0gdW5kZWZpbmVkOwogICAgICBjb25zdCBzdGFsZVZhbCA9IGhhc1N0YWxlICYmIGFsbG93U3RhbGU7CiAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICBzdGF0dXMuZmV0Y2ggPSBpc1N0YWxlID8gJ3N0YWxlJyA6ICdyZWZyZXNoJzsKICAgICAgICBpZiAoc3RhbGVWYWwgJiYgaXNTdGFsZSkgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBzdGFsZVZhbCA/IHAuX19zdGFsZVdoaWxlRmV0Y2hpbmcgOiBwLl9fcmV0dXJuZWQgPSBwOwogICAgfQogIH0KICBhc3luYyBmb3JjZUZldGNoKGssIGZldGNoT3B0aW9ucyA9IHt9KSB7CiAgICBjb25zdCB2ID0gYXdhaXQgdGhpcy5mZXRjaChrLCBmZXRjaE9wdGlvbnMpOwogICAgaWYgKHYgPT09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKCdmZXRjaCgpIHJldHVybmVkIHVuZGVmaW5lZCcpOwogICAgcmV0dXJuIHY7CiAgfQogIG1lbW8oaywgbWVtb09wdGlvbnMgPSB7fSkgewogICAgY29uc3QgbWVtb01ldGhvZCA9IHRoaXMuI21lbW9NZXRob2Q7CiAgICBpZiAoIW1lbW9NZXRob2QpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdubyBtZW1vTWV0aG9kIHByb3ZpZGVkIHRvIGNvbnN0cnVjdG9yJyk7CiAgICB9CiAgICBjb25zdCB7CiAgICAgICAgY29udGV4dCwKICAgICAgICBmb3JjZVJlZnJlc2gKICAgICAgfSA9IG1lbW9PcHRpb25zLAogICAgICBvcHRpb25zID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKG1lbW9PcHRpb25zLCBfZXhjbHVkZWQpOwogICAgY29uc3QgdiA9IHRoaXMuZ2V0KGssIG9wdGlvbnMpOwogICAgaWYgKCFmb3JjZVJlZnJlc2ggJiYgdiAhPT0gdW5kZWZpbmVkKSByZXR1cm4gdjsKICAgIGNvbnN0IHZ2ID0gbWVtb01ldGhvZChrLCB2LCB7CiAgICAgIG9wdGlvbnMsCiAgICAgIGNvbnRleHQKICAgIH0pOwogICAgdGhpcy5zZXQoaywgdnYsIG9wdGlvbnMpOwogICAgcmV0dXJuIHZ2OwogIH0KICAvKioKICAgKiBSZXR1cm4gYSB2YWx1ZSBmcm9tIHRoZSBjYWNoZS4gV2lsbCB1cGRhdGUgdGhlIHJlY2VuY3kgb2YgdGhlIGNhY2hlCiAgICogZW50cnkgZm91bmQuCiAgICoKICAgKiBJZiB0aGUga2V5IGlzIG5vdCBmb3VuZCwgZ2V0KCkgd2lsbCByZXR1cm4gYHVuZGVmaW5lZGAuCiAgICovCiAgZ2V0KGssIGdldE9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgewogICAgICBhbGxvd1N0YWxlID0gdGhpcy5hbGxvd1N0YWxlLAogICAgICB1cGRhdGVBZ2VPbkdldCA9IHRoaXMudXBkYXRlQWdlT25HZXQsCiAgICAgIG5vRGVsZXRlT25TdGFsZUdldCA9IHRoaXMubm9EZWxldGVPblN0YWxlR2V0LAogICAgICBzdGF0dXMKICAgIH0gPSBnZXRPcHRpb25zOwogICAgY29uc3QgaW5kZXggPSB0aGlzLiNrZXlNYXAuZ2V0KGspOwogICAgaWYgKGluZGV4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgY29uc3QgZmV0Y2hpbmcgPSB0aGlzLiNpc0JhY2tncm91bmRGZXRjaCh2YWx1ZSk7CiAgICAgIGlmIChzdGF0dXMpIHRoaXMuI3N0YXR1c1RUTChzdGF0dXMsIGluZGV4KTsKICAgICAgaWYgKHRoaXMuI2lzU3RhbGUoaW5kZXgpKSB7CiAgICAgICAgaWYgKHN0YXR1cykgc3RhdHVzLmdldCA9ICdzdGFsZSc7CiAgICAgICAgLy8gZGVsZXRlIG9ubHkgaWYgbm90IGFuIGluLWZsaWdodCBiYWNrZ3JvdW5kIGZldGNoCiAgICAgICAgaWYgKCFmZXRjaGluZykgewogICAgICAgICAgaWYgKCFub0RlbGV0ZU9uU3RhbGVHZXQpIHsKICAgICAgICAgICAgdGhpcy4jZGVsZXRlKGssICdleHBpcmUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0dXMgJiYgYWxsb3dTdGFsZSkgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIGFsbG93U3RhbGUgPyB2YWx1ZSA6IHVuZGVmaW5lZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHN0YXR1cyAmJiBhbGxvd1N0YWxlICYmIHZhbHVlLl9fc3RhbGVXaGlsZUZldGNoaW5nICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgc3RhdHVzLnJldHVybmVkU3RhbGUgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsbG93U3RhbGUgPyB2YWx1ZS5fX3N0YWxlV2hpbGVGZXRjaGluZyA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHN0YXR1cykgc3RhdHVzLmdldCA9ICdoaXQnOwogICAgICAgIC8vIGlmIHdlJ3JlIGN1cnJlbnRseSBmZXRjaGluZyBpdCwgd2UgZG9uJ3QgYWN0dWFsbHkgaGF2ZSBpdCB5ZXQKICAgICAgICAvLyBpdCdzIG5vdCBzdGFsZSwgd2hpY2ggbWVhbnMgdGhpcyBpc24ndCBhIHN0YWxlV2hpbGVSZWZldGNoaW5nLgogICAgICAgIC8vIElmIGl0J3Mgbm90IHN0YWxlLCBhbmQgZmV0Y2hpbmcsIEFORCBoYXMgYSBfX3N0YWxlV2hpbGVGZXRjaGluZwogICAgICAgIC8vIHZhbHVlLCB0aGVuIHRoYXQgbWVhbnMgdGhlIHVzZXIgZmV0Y2hlZCB3aXRoIHtmb3JjZVJlZnJlc2g6dHJ1ZX0sCiAgICAgICAgLy8gc28gaXQncyBzYWZlIHRvIHJldHVybiB0aGF0IHZhbHVlLgogICAgICAgIGlmIChmZXRjaGluZykgewogICAgICAgICAgcmV0dXJuIHZhbHVlLl9fc3RhbGVXaGlsZUZldGNoaW5nOwogICAgICAgIH0KICAgICAgICB0aGlzLiNtb3ZlVG9UYWlsKGluZGV4KTsKICAgICAgICBpZiAodXBkYXRlQWdlT25HZXQpIHsKICAgICAgICAgIHRoaXMuI3VwZGF0ZUl0ZW1BZ2UoaW5kZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoc3RhdHVzKSB7CiAgICAgIHN0YXR1cy5nZXQgPSAnbWlzcyc7CiAgICB9CiAgfQogICNjb25uZWN0KHAsIG4pIHsKICAgIHRoaXMuI3ByZXZbbl0gPSBwOwogICAgdGhpcy4jbmV4dFtwXSA9IG47CiAgfQogICNtb3ZlVG9UYWlsKGluZGV4KSB7CiAgICAvLyBpZiB0YWlsIGFscmVhZHksIG5vdGhpbmcgdG8gZG8KICAgIC8vIGlmIGhlYWQsIG1vdmUgaGVhZCB0byBuZXh0W2luZGV4XQogICAgLy8gZWxzZQogICAgLy8gICBtb3ZlIG5leHRbcHJldltpbmRleF1dIHRvIG5leHRbaW5kZXhdIChoZWFkIGhhcyBubyBwcmV2KQogICAgLy8gICBtb3ZlIHByZXZbbmV4dFtpbmRleF1dIHRvIHByZXZbaW5kZXhdCiAgICAvLyBwcmV2W2luZGV4XSA9IHRhaWwKICAgIC8vIG5leHRbdGFpbF0gPSBpbmRleAogICAgLy8gdGFpbCA9IGluZGV4CiAgICBpZiAoaW5kZXggIT09IHRoaXMuI3RhaWwpIHsKICAgICAgaWYgKGluZGV4ID09PSB0aGlzLiNoZWFkKSB7CiAgICAgICAgdGhpcy4jaGVhZCA9IHRoaXMuI25leHRbaW5kZXhdOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuI2Nvbm5lY3QodGhpcy4jcHJldltpbmRleF0sIHRoaXMuI25leHRbaW5kZXhdKTsKICAgICAgfQogICAgICB0aGlzLiNjb25uZWN0KHRoaXMuI3RhaWwsIGluZGV4KTsKICAgICAgdGhpcy4jdGFpbCA9IGluZGV4OwogICAgfQogIH0KICAvKioKICAgKiBEZWxldGVzIGEga2V5IG91dCBvZiB0aGUgY2FjaGUuCiAgICoKICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGtleSB3YXMgZGVsZXRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIGRlbGV0ZShrKSB7CiAgICByZXR1cm4gdGhpcy4jZGVsZXRlKGssICdkZWxldGUnKTsKICB9CiAgI2RlbGV0ZShrLCByZWFzb24pIHsKICAgIHZhciBfdGhpcyRkaXNwb3NlZDU7CiAgICBsZXQgZGVsZXRlZCA9IGZhbHNlOwogICAgaWYgKHRoaXMuI3NpemUgIT09IDApIHsKICAgICAgY29uc3QgaW5kZXggPSB0aGlzLiNrZXlNYXAuZ2V0KGspOwogICAgICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgICAgIGRlbGV0ZWQgPSB0cnVlOwogICAgICAgIGlmICh0aGlzLiNzaXplID09PSAxKSB7CiAgICAgICAgICB0aGlzLiNjbGVhcihyZWFzb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiNyZW1vdmVJdGVtU2l6ZShpbmRleCk7CiAgICAgICAgICBjb25zdCB2ID0gdGhpcy4jdmFsTGlzdFtpbmRleF07CiAgICAgICAgICBpZiAodGhpcy4jaXNCYWNrZ3JvdW5kRmV0Y2godikpIHsKICAgICAgICAgICAgdi5fX2Fib3J0Q29udHJvbGxlci5hYm9ydChuZXcgRXJyb3IoJ2RlbGV0ZWQnKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuI2hhc0Rpc3Bvc2UgfHwgdGhpcy4jaGFzRGlzcG9zZUFmdGVyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICAgICAgdmFyIF90aGlzJGRpc3Bvc2U0OwogICAgICAgICAgICAgIChfdGhpcyRkaXNwb3NlNCA9IHRoaXMuI2Rpc3Bvc2UpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2U0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRkaXNwb3NlNC5jYWxsKHRoaXMsIHYsIGssIHJlYXNvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuI2hhc0Rpc3Bvc2VBZnRlcikgewogICAgICAgICAgICAgIHZhciBfdGhpcyRkaXNwb3NlZDQ7CiAgICAgICAgICAgICAgKF90aGlzJGRpc3Bvc2VkNCA9IHRoaXMuI2Rpc3Bvc2VkKSA9PT0gbnVsbCB8fCBfdGhpcyRkaXNwb3NlZDQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VkNC5wdXNoKFt2LCBrLCByZWFzb25dKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy4ja2V5TWFwLmRlbGV0ZShrKTsKICAgICAgICAgIHRoaXMuI2tleUxpc3RbaW5kZXhdID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy4jdmFsTGlzdFtpbmRleF0gPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoaW5kZXggPT09IHRoaXMuI3RhaWwpIHsKICAgICAgICAgICAgdGhpcy4jdGFpbCA9IHRoaXMuI3ByZXZbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PT0gdGhpcy4jaGVhZCkgewogICAgICAgICAgICB0aGlzLiNoZWFkID0gdGhpcy4jbmV4dFtpbmRleF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBwaSA9IHRoaXMuI3ByZXZbaW5kZXhdOwogICAgICAgICAgICB0aGlzLiNuZXh0W3BpXSA9IHRoaXMuI25leHRbaW5kZXhdOwogICAgICAgICAgICBjb25zdCBuaSA9IHRoaXMuI25leHRbaW5kZXhdOwogICAgICAgICAgICB0aGlzLiNwcmV2W25pXSA9IHRoaXMuI3ByZXZbaW5kZXhdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy4jc2l6ZS0tOwogICAgICAgICAgdGhpcy4jZnJlZS5wdXNoKGluZGV4KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlQWZ0ZXIgJiYgKF90aGlzJGRpc3Bvc2VkNSA9IHRoaXMuI2Rpc3Bvc2VkKSAhPT0gbnVsbCAmJiBfdGhpcyRkaXNwb3NlZDUgIT09IHZvaWQgMCAmJiBfdGhpcyRkaXNwb3NlZDUubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGR0ID0gdGhpcy4jZGlzcG9zZWQ7CiAgICAgIGxldCB0YXNrOwogICAgICB3aGlsZSAodGFzayA9IGR0ID09PSBudWxsIHx8IGR0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkdC5zaGlmdCgpKSB7CiAgICAgICAgdmFyIF90aGlzJGRpc3Bvc2VBZnRlcjM7CiAgICAgICAgKF90aGlzJGRpc3Bvc2VBZnRlcjMgPSB0aGlzLiNkaXNwb3NlQWZ0ZXIpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2VBZnRlcjMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VBZnRlcjMuY2FsbCh0aGlzLCAuLi50YXNrKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlbGV0ZWQ7CiAgfQogIC8qKgogICAqIENsZWFyIHRoZSBjYWNoZSBlbnRpcmVseSwgdGhyb3dpbmcgYXdheSBhbGwgdmFsdWVzLgogICAqLwogIGNsZWFyKCkgewogICAgcmV0dXJuIHRoaXMuI2NsZWFyKCdkZWxldGUnKTsKICB9CiAgI2NsZWFyKHJlYXNvbikgewogICAgZm9yIChjb25zdCBpbmRleCBvZiB0aGlzLiNyaW5kZXhlcyh7CiAgICAgIGFsbG93U3RhbGU6IHRydWUKICAgIH0pKSB7CiAgICAgIGNvbnN0IHYgPSB0aGlzLiN2YWxMaXN0W2luZGV4XTsKICAgICAgaWYgKHRoaXMuI2lzQmFja2dyb3VuZEZldGNoKHYpKSB7CiAgICAgICAgdi5fX2Fib3J0Q29udHJvbGxlci5hYm9ydChuZXcgRXJyb3IoJ2RlbGV0ZWQnKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgayA9IHRoaXMuI2tleUxpc3RbaW5kZXhdOwogICAgICAgIGlmICh0aGlzLiNoYXNEaXNwb3NlKSB7CiAgICAgICAgICB2YXIgX3RoaXMkZGlzcG9zZTU7CiAgICAgICAgICAoX3RoaXMkZGlzcG9zZTUgPSB0aGlzLiNkaXNwb3NlKSA9PT0gbnVsbCB8fCBfdGhpcyRkaXNwb3NlNSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkZGlzcG9zZTUuY2FsbCh0aGlzLCB2LCBrLCByZWFzb24pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyKSB7CiAgICAgICAgICB2YXIgX3RoaXMkZGlzcG9zZWQ2OwogICAgICAgICAgKF90aGlzJGRpc3Bvc2VkNiA9IHRoaXMuI2Rpc3Bvc2VkKSA9PT0gbnVsbCB8fCBfdGhpcyRkaXNwb3NlZDYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VkNi5wdXNoKFt2LCBrLCByZWFzb25dKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2tleU1hcC5jbGVhcigpOwogICAgdGhpcy4jdmFsTGlzdC5maWxsKHVuZGVmaW5lZCk7CiAgICB0aGlzLiNrZXlMaXN0LmZpbGwodW5kZWZpbmVkKTsKICAgIGlmICh0aGlzLiN0dGxzICYmIHRoaXMuI3N0YXJ0cykgewogICAgICB0aGlzLiN0dGxzLmZpbGwoMCk7CiAgICAgIHRoaXMuI3N0YXJ0cy5maWxsKDApOwogICAgfQogICAgaWYgKHRoaXMuI3NpemVzKSB7CiAgICAgIHRoaXMuI3NpemVzLmZpbGwoMCk7CiAgICB9CiAgICB0aGlzLiNoZWFkID0gMDsKICAgIHRoaXMuI3RhaWwgPSAwOwogICAgdGhpcy4jZnJlZS5sZW5ndGggPSAwOwogICAgdGhpcy4jY2FsY3VsYXRlZFNpemUgPSAwOwogICAgdGhpcy4jc2l6ZSA9IDA7CiAgICBpZiAodGhpcy4jaGFzRGlzcG9zZUFmdGVyICYmIHRoaXMuI2Rpc3Bvc2VkKSB7CiAgICAgIGNvbnN0IGR0ID0gdGhpcy4jZGlzcG9zZWQ7CiAgICAgIGxldCB0YXNrOwogICAgICB3aGlsZSAodGFzayA9IGR0ID09PSBudWxsIHx8IGR0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkdC5zaGlmdCgpKSB7CiAgICAgICAgdmFyIF90aGlzJGRpc3Bvc2VBZnRlcjQ7CiAgICAgICAgKF90aGlzJGRpc3Bvc2VBZnRlcjQgPSB0aGlzLiNkaXNwb3NlQWZ0ZXIpID09PSBudWxsIHx8IF90aGlzJGRpc3Bvc2VBZnRlcjQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGRpc3Bvc2VBZnRlcjQuY2FsbCh0aGlzLCAuLi50YXNrKTsKICAgICAgfQogICAgfQogIH0KfQpjb21tb25qcy5MUlVDYWNoZSA9IExSVUNhY2hlOwoKdmFyIG51bWJlckFsbG9jYXRvciQxID0ge307Cgp2YXIgY2pzID0ge307Cgp2YXIgU3RhY2sgPSB7fTsKCnZhciBDb250YWluZXJCYXNlID0ge307CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLkNvbnRhaW5lckl0ZXJhdG9yID0gZXhwb3J0cy5Db250YWluZXIgPSBleHBvcnRzLkJhc2UgPSB2b2lkIDA7CiAgY2xhc3MgQ29udGFpbmVySXRlcmF0b3IgewogICAgY29uc3RydWN0b3IodCA9IDApIHsKICAgICAgdGhpcy5pdGVyYXRvclR5cGUgPSB0OwogICAgfQogICAgZXF1YWxzKHQpIHsKICAgICAgcmV0dXJuIHRoaXMubyA9PT0gdC5vOwogICAgfQogIH0KICBleHBvcnRzLkNvbnRhaW5lckl0ZXJhdG9yID0gQ29udGFpbmVySXRlcmF0b3I7CiAgY2xhc3MgQmFzZSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5pID0gMDsKICAgIH0KICAgIGdldCBsZW5ndGgoKSB7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBzaXplKCkgewogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgZW1wdHkoKSB7CiAgICAgIHJldHVybiB0aGlzLmkgPT09IDA7CiAgICB9CiAgfQogIGV4cG9ydHMuQmFzZSA9IEJhc2U7CiAgY2xhc3MgQ29udGFpbmVyIGV4dGVuZHMgQmFzZSB7fQogIGV4cG9ydHMuQ29udGFpbmVyID0gQ29udGFpbmVyOwp9KShDb250YWluZXJCYXNlKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX0NvbnRhaW5lckJhc2UgPSBDb250YWluZXJCYXNlOwogIGNsYXNzIFN0YWNrIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQmFzZSB7CiAgICBjb25zdHJ1Y3Rvcih0ID0gW10pIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5TID0gW107CiAgICAgIGNvbnN0IHMgPSB0aGlzOwogICAgICB0LmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICBzLnB1c2godCk7CiAgICAgIH0pOwogICAgfQogICAgY2xlYXIoKSB7CiAgICAgIHRoaXMuaSA9IDA7CiAgICAgIHRoaXMuUyA9IFtdOwogICAgfQogICAgcHVzaCh0KSB7CiAgICAgIHRoaXMuUy5wdXNoKHQpOwogICAgICB0aGlzLmkgKz0gMTsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIHBvcCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICB0aGlzLmkgLT0gMTsKICAgICAgcmV0dXJuIHRoaXMuUy5wb3AoKTsKICAgIH0KICAgIHRvcCgpIHsKICAgICAgcmV0dXJuIHRoaXMuU1t0aGlzLmkgLSAxXTsKICAgIH0KICB9CiAgdmFyIF9kZWZhdWx0ID0gU3RhY2s7CiAgZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pKFN0YWNrKTsKCnZhciBRdWV1ZSA9IHt9OwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidCIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBfQ29udGFpbmVyQmFzZSA9IENvbnRhaW5lckJhc2U7CiAgY2xhc3MgUXVldWUgZXh0ZW5kcyBfQ29udGFpbmVyQmFzZS5CYXNlIHsKICAgIGNvbnN0cnVjdG9yKHQgPSBbXSkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmogPSAwOwogICAgICB0aGlzLnEgPSBbXTsKICAgICAgY29uc3QgcyA9IHRoaXM7CiAgICAgIHQuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIHMucHVzaCh0KTsKICAgICAgfSk7CiAgICB9CiAgICBjbGVhcigpIHsKICAgICAgdGhpcy5xID0gW107CiAgICAgIHRoaXMuaSA9IHRoaXMuaiA9IDA7CiAgICB9CiAgICBwdXNoKHQpIHsKICAgICAgY29uc3QgcyA9IHRoaXMucS5sZW5ndGg7CiAgICAgIGlmICh0aGlzLmogLyBzID4gLjUgJiYgdGhpcy5qICsgdGhpcy5pID49IHMgJiYgcyA+IDQwOTYpIHsKICAgICAgICBjb25zdCBzID0gdGhpcy5pOwogICAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgczsgKyt0KSB7CiAgICAgICAgICB0aGlzLnFbdF0gPSB0aGlzLnFbdGhpcy5qICsgdF07CiAgICAgICAgfQogICAgICAgIHRoaXMuaiA9IDA7CiAgICAgICAgdGhpcy5xW3RoaXMuaV0gPSB0OwogICAgICB9IGVsc2UgdGhpcy5xW3RoaXMuaiArIHRoaXMuaV0gPSB0OwogICAgICByZXR1cm4gKyt0aGlzLmk7CiAgICB9CiAgICBwb3AoKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgY29uc3QgdCA9IHRoaXMucVt0aGlzLmorK107CiAgICAgIHRoaXMuaSAtPSAxOwogICAgICByZXR1cm4gdDsKICAgIH0KICAgIGZyb250KCkgewogICAgICBpZiAodGhpcy5pID09PSAwKSByZXR1cm47CiAgICAgIHJldHVybiB0aGlzLnFbdGhpcy5qXTsKICAgIH0KICB9CiAgdmFyIF9kZWZhdWx0ID0gUXVldWU7CiAgZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pKFF1ZXVlKTsKCnZhciBQcmlvcml0eVF1ZXVlID0ge307CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CiAgdmFyIF9Db250YWluZXJCYXNlID0gQ29udGFpbmVyQmFzZTsKICBjbGFzcyBQcmlvcml0eVF1ZXVlIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQmFzZSB7CiAgICBjb25zdHJ1Y3Rvcih0ID0gW10sIHMgPSBmdW5jdGlvbiAodCwgcykgewogICAgICBpZiAodCA+IHMpIHJldHVybiAtMTsKICAgICAgaWYgKHQgPCBzKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIDA7CiAgICB9LCBpID0gdHJ1ZSkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLnYgPSBzOwogICAgICBpZiAoQXJyYXkuaXNBcnJheSh0KSkgewogICAgICAgIHRoaXMuQyA9IGkgPyBbLi4udF0gOiB0OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuQyA9IFtdOwogICAgICAgIGNvbnN0IHMgPSB0aGlzOwogICAgICAgIHQuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgICAgcy5DLnB1c2godCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy5pID0gdGhpcy5DLmxlbmd0aDsKICAgICAgY29uc3QgZSA9IHRoaXMuaSA+PiAxOwogICAgICBmb3IgKGxldCB0ID0gdGhpcy5pIC0gMSA+PiAxOyB0ID49IDA7IC0tdCkgewogICAgICAgIHRoaXMuayh0LCBlKTsKICAgICAgfQogICAgfQogICAgbSh0KSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLkNbdF07CiAgICAgIHdoaWxlICh0ID4gMCkgewogICAgICAgIGNvbnN0IGkgPSB0IC0gMSA+PiAxOwogICAgICAgIGNvbnN0IGUgPSB0aGlzLkNbaV07CiAgICAgICAgaWYgKHRoaXMudihlLCBzKSA8PSAwKSBicmVhazsKICAgICAgICB0aGlzLkNbdF0gPSBlOwogICAgICAgIHQgPSBpOwogICAgICB9CiAgICAgIHRoaXMuQ1t0XSA9IHM7CiAgICB9CiAgICBrKHQsIHMpIHsKICAgICAgY29uc3QgaSA9IHRoaXMuQ1t0XTsKICAgICAgd2hpbGUgKHQgPCBzKSB7CiAgICAgICAgbGV0IHMgPSB0IDw8IDEgfCAxOwogICAgICAgIGNvbnN0IGUgPSBzICsgMTsKICAgICAgICBsZXQgaCA9IHRoaXMuQ1tzXTsKICAgICAgICBpZiAoZSA8IHRoaXMuaSAmJiB0aGlzLnYoaCwgdGhpcy5DW2VdKSA+IDApIHsKICAgICAgICAgIHMgPSBlOwogICAgICAgICAgaCA9IHRoaXMuQ1tlXTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudihoLCBpKSA+PSAwKSBicmVhazsKICAgICAgICB0aGlzLkNbdF0gPSBoOwogICAgICAgIHQgPSBzOwogICAgICB9CiAgICAgIHRoaXMuQ1t0XSA9IGk7CiAgICB9CiAgICBjbGVhcigpIHsKICAgICAgdGhpcy5pID0gMDsKICAgICAgdGhpcy5DLmxlbmd0aCA9IDA7CiAgICB9CiAgICBwdXNoKHQpIHsKICAgICAgdGhpcy5DLnB1c2godCk7CiAgICAgIHRoaXMubSh0aGlzLmkpOwogICAgICB0aGlzLmkgKz0gMTsKICAgIH0KICAgIHBvcCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICBjb25zdCB0ID0gdGhpcy5DWzBdOwogICAgICBjb25zdCBzID0gdGhpcy5DLnBvcCgpOwogICAgICB0aGlzLmkgLT0gMTsKICAgICAgaWYgKHRoaXMuaSkgewogICAgICAgIHRoaXMuQ1swXSA9IHM7CiAgICAgICAgdGhpcy5rKDAsIHRoaXMuaSA+PiAxKTsKICAgICAgfQogICAgICByZXR1cm4gdDsKICAgIH0KICAgIHRvcCgpIHsKICAgICAgcmV0dXJuIHRoaXMuQ1swXTsKICAgIH0KICAgIGZpbmQodCkgewogICAgICByZXR1cm4gdGhpcy5DLmluZGV4T2YodCkgPj0gMDsKICAgIH0KICAgIHJlbW92ZSh0KSB7CiAgICAgIGNvbnN0IHMgPSB0aGlzLkMuaW5kZXhPZih0KTsKICAgICAgaWYgKHMgPCAwKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmIChzID09PSAwKSB7CiAgICAgICAgdGhpcy5wb3AoKTsKICAgICAgfSBlbHNlIGlmIChzID09PSB0aGlzLmkgLSAxKSB7CiAgICAgICAgdGhpcy5DLnBvcCgpOwogICAgICAgIHRoaXMuaSAtPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuQy5zcGxpY2UocywgMSwgdGhpcy5DLnBvcCgpKTsKICAgICAgICB0aGlzLmkgLT0gMTsKICAgICAgICB0aGlzLm0ocyk7CiAgICAgICAgdGhpcy5rKHMsIHRoaXMuaSA+PiAxKTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHVwZGF0ZUl0ZW0odCkgewogICAgICBjb25zdCBzID0gdGhpcy5DLmluZGV4T2YodCk7CiAgICAgIGlmIChzIDwgMCkgcmV0dXJuIGZhbHNlOwogICAgICB0aGlzLm0ocyk7CiAgICAgIHRoaXMuayhzLCB0aGlzLmkgPj4gMSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIFsuLi50aGlzLkNdOwogICAgfQogIH0KICB2YXIgX2RlZmF1bHQgPSBQcmlvcml0eVF1ZXVlOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShQcmlvcml0eVF1ZXVlKTsKCnZhciBWZWN0b3IgPSB7fTsKCnZhciBCYXNlJDIgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX0NvbnRhaW5lckJhc2UgPSBDb250YWluZXJCYXNlOwogIGNsYXNzIFNlcXVlbnRpYWxDb250YWluZXIgZXh0ZW5kcyBfQ29udGFpbmVyQmFzZS5Db250YWluZXIge30KICB2YXIgX2RlZmF1bHQgPSBTZXF1ZW50aWFsQ29udGFpbmVyOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShCYXNlJDIpOwoKdmFyIFJhbmRvbUl0ZXJhdG9yID0ge307Cgp2YXIgdGhyb3dFcnJvciA9IHt9OwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidCIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IgPSB0aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3I7CiAgZnVuY3Rpb24gdGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkl0ZXJhdG9yIGFjY2VzcyBkZW5pZWQhIik7CiAgfQp9KSh0aHJvd0Vycm9yKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuUmFuZG9tSXRlcmF0b3IgPSB2b2lkIDA7CiAgdmFyIF9Db250YWluZXJCYXNlID0gQ29udGFpbmVyQmFzZTsKICB2YXIgX3Rocm93RXJyb3IgPSB0aHJvd0Vycm9yOwogIGNsYXNzIFJhbmRvbUl0ZXJhdG9yIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQ29udGFpbmVySXRlcmF0b3IgewogICAgY29uc3RydWN0b3IodCwgcikgewogICAgICBzdXBlcihyKTsKICAgICAgdGhpcy5vID0gdDsKICAgICAgaWYgKHRoaXMuaXRlcmF0b3JUeXBlID09PSAwKSB7CiAgICAgICAgdGhpcy5wcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSAwKSB7CiAgICAgICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm8gLT0gMTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgdGhpcy5uZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubyA9PT0gdGhpcy5jb250YWluZXIuc2l6ZSgpKSB7CiAgICAgICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm8gKz0gMTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSB0aGlzLmNvbnRhaW5lci5zaXplKCkgLSAxKSB7CiAgICAgICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm8gKz0gMTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgdGhpcy5uZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubyA9PT0gLTEpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyAtPSAxOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZ2V0IHBvaW50ZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lci5nZXRFbGVtZW50QnlQb3ModGhpcy5vKTsKICAgIH0KICAgIHNldCBwb2ludGVyKHQpIHsKICAgICAgdGhpcy5jb250YWluZXIuc2V0RWxlbWVudEJ5UG9zKHRoaXMubywgdCk7CiAgICB9CiAgfQogIGV4cG9ydHMuUmFuZG9tSXRlcmF0b3IgPSBSYW5kb21JdGVyYXRvcjsKfSkoUmFuZG9tSXRlcmF0b3IpOwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidCIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBfQmFzZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoQmFzZSQyKTsKICB2YXIgX1JhbmRvbUl0ZXJhdG9yID0gUmFuZG9tSXRlcmF0b3I7CiAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdCh0KSB7CiAgICByZXR1cm4gdCAmJiB0LnQgPyB0IDogewogICAgICBkZWZhdWx0OiB0CiAgICB9OwogIH0KICBjbGFzcyBWZWN0b3JJdGVyYXRvciBleHRlbmRzIF9SYW5kb21JdGVyYXRvci5SYW5kb21JdGVyYXRvciB7CiAgICBjb25zdHJ1Y3Rvcih0LCByLCBlKSB7CiAgICAgIHN1cGVyKHQsIGUpOwogICAgICB0aGlzLmNvbnRhaW5lciA9IHI7CiAgICB9CiAgICBjb3B5KCkgewogICAgICByZXR1cm4gbmV3IFZlY3Rvckl0ZXJhdG9yKHRoaXMubywgdGhpcy5jb250YWluZXIsIHRoaXMuaXRlcmF0b3JUeXBlKTsKICAgIH0KICB9CiAgY2xhc3MgVmVjdG9yIGV4dGVuZHMgX0Jhc2UuZGVmYXVsdCB7CiAgICBjb25zdHJ1Y3Rvcih0ID0gW10sIHIgPSB0cnVlKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHQpKSB7CiAgICAgICAgdGhpcy5KID0gciA/IFsuLi50XSA6IHQ7CiAgICAgICAgdGhpcy5pID0gdC5sZW5ndGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5KID0gW107CiAgICAgICAgY29uc3QgciA9IHRoaXM7CiAgICAgICAgdC5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICByLnB1c2hCYWNrKHQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBjbGVhcigpIHsKICAgICAgdGhpcy5pID0gMDsKICAgICAgdGhpcy5KLmxlbmd0aCA9IDA7CiAgICB9CiAgICBiZWdpbigpIHsKICAgICAgcmV0dXJuIG5ldyBWZWN0b3JJdGVyYXRvcigwLCB0aGlzKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBWZWN0b3JJdGVyYXRvcih0aGlzLmksIHRoaXMpOwogICAgfQogICAgckJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IFZlY3Rvckl0ZXJhdG9yKHRoaXMuaSAtIDEsIHRoaXMsIDEpOwogICAgfQogICAgckVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBWZWN0b3JJdGVyYXRvcigtMSwgdGhpcywgMSk7CiAgICB9CiAgICBmcm9udCgpIHsKICAgICAgcmV0dXJuIHRoaXMuSlswXTsKICAgIH0KICAgIGJhY2soKSB7CiAgICAgIHJldHVybiB0aGlzLkpbdGhpcy5pIC0gMV07CiAgICB9CiAgICBnZXRFbGVtZW50QnlQb3ModCkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLkpbdF07CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeVBvcyh0KSB7CiAgICAgIGlmICh0IDwgMCB8fCB0ID4gdGhpcy5pIC0gMSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCk7CiAgICAgIH0KICAgICAgdGhpcy5KLnNwbGljZSh0LCAxKTsKICAgICAgdGhpcy5pIC09IDE7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeVZhbHVlKHQpIHsKICAgICAgbGV0IHIgPSAwOwogICAgICBmb3IgKGxldCBlID0gMDsgZSA8IHRoaXMuaTsgKytlKSB7CiAgICAgICAgaWYgKHRoaXMuSltlXSAhPT0gdCkgewogICAgICAgICAgdGhpcy5KW3IrK10gPSB0aGlzLkpbZV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaSA9IHRoaXMuSi5sZW5ndGggPSByOwogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlJdGVyYXRvcih0KSB7CiAgICAgIGNvbnN0IHIgPSB0Lm87CiAgICAgIHQgPSB0Lm5leHQoKTsKICAgICAgdGhpcy5lcmFzZUVsZW1lbnRCeVBvcyhyKTsKICAgICAgcmV0dXJuIHQ7CiAgICB9CiAgICBwdXNoQmFjayh0KSB7CiAgICAgIHRoaXMuSi5wdXNoKHQpOwogICAgICB0aGlzLmkgKz0gMTsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIHBvcEJhY2soKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgdGhpcy5pIC09IDE7CiAgICAgIHJldHVybiB0aGlzLkoucG9wKCk7CiAgICB9CiAgICBzZXRFbGVtZW50QnlQb3ModCwgcikgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIHRoaXMuSlt0XSA9IHI7CiAgICB9CiAgICBpbnNlcnQodCwgciwgZSA9IDEpIHsKICAgICAgaWYgKHQgPCAwIHx8IHQgPiB0aGlzLmkpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIHRoaXMuSi5zcGxpY2UodCwgMCwgLi4ubmV3IEFycmF5KGUpLmZpbGwocikpOwogICAgICB0aGlzLmkgKz0gZTsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIGZpbmQodCkgewogICAgICBmb3IgKGxldCByID0gMDsgciA8IHRoaXMuaTsgKytyKSB7CiAgICAgICAgaWYgKHRoaXMuSltyXSA9PT0gdCkgewogICAgICAgICAgcmV0dXJuIG5ldyBWZWN0b3JJdGVyYXRvcihyLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZW5kKCk7CiAgICB9CiAgICByZXZlcnNlKCkgewogICAgICB0aGlzLkoucmV2ZXJzZSgpOwogICAgfQogICAgdW5pcXVlKCkgewogICAgICBsZXQgdCA9IDE7CiAgICAgIGZvciAobGV0IHIgPSAxOyByIDwgdGhpcy5pOyArK3IpIHsKICAgICAgICBpZiAodGhpcy5KW3JdICE9PSB0aGlzLkpbciAtIDFdKSB7CiAgICAgICAgICB0aGlzLkpbdCsrXSA9IHRoaXMuSltyXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5pID0gdGhpcy5KLmxlbmd0aCA9IHQ7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBzb3J0KHQpIHsKICAgICAgdGhpcy5KLnNvcnQodCk7CiAgICB9CiAgICBmb3JFYWNoKHQpIHsKICAgICAgZm9yIChsZXQgciA9IDA7IHIgPCB0aGlzLmk7ICsrcikgewogICAgICAgIHQodGhpcy5KW3JdLCByLCB0aGlzKTsKICAgICAgfQogICAgfQogICAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiogKCkgewogICAgICAgIHlpZWxkKiB0aGlzLko7CiAgICAgIH0uYmluZCh0aGlzKSgpOwogICAgfQogIH0KICB2YXIgX2RlZmF1bHQgPSBWZWN0b3I7CiAgZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pKFZlY3Rvcik7Cgp2YXIgTGlua0xpc3QgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX0Jhc2UgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KEJhc2UkMik7CiAgdmFyIF9Db250YWluZXJCYXNlID0gQ29udGFpbmVyQmFzZTsKICB2YXIgX3Rocm93RXJyb3IgPSB0aHJvd0Vycm9yOwogIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQodCkgewogICAgcmV0dXJuIHQgJiYgdC50ID8gdCA6IHsKICAgICAgZGVmYXVsdDogdAogICAgfTsKICB9CiAgY2xhc3MgTGlua0xpc3RJdGVyYXRvciBleHRlbmRzIF9Db250YWluZXJCYXNlLkNvbnRhaW5lckl0ZXJhdG9yIHsKICAgIGNvbnN0cnVjdG9yKHQsIGksIHMsIHIpIHsKICAgICAgc3VwZXIocik7CiAgICAgIHRoaXMubyA9IHQ7CiAgICAgIHRoaXMuaCA9IGk7CiAgICAgIHRoaXMuY29udGFpbmVyID0gczsKICAgICAgaWYgKHRoaXMuaXRlcmF0b3JUeXBlID09PSAwKSB7CiAgICAgICAgdGhpcy5wcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vLkwgPT09IHRoaXMuaCkgewogICAgICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vID0gdGhpcy5vLkw7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHRoaXMubmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaCkgewogICAgICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vID0gdGhpcy5vLkI7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMuby5CID09PSB0aGlzLmgpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyA9IHRoaXMuby5COwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSB0aGlzLmgpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyA9IHRoaXMuby5MOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZ2V0IHBvaW50ZXIoKSB7CiAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaCkgewogICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuby5sOwogICAgfQogICAgc2V0IHBvaW50ZXIodCkgewogICAgICBpZiAodGhpcy5vID09PSB0aGlzLmgpIHsKICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICB9CiAgICAgIHRoaXMuby5sID0gdDsKICAgIH0KICAgIGNvcHkoKSB7CiAgICAgIHJldHVybiBuZXcgTGlua0xpc3RJdGVyYXRvcih0aGlzLm8sIHRoaXMuaCwgdGhpcy5jb250YWluZXIsIHRoaXMuaXRlcmF0b3JUeXBlKTsKICAgIH0KICB9CiAgY2xhc3MgTGlua0xpc3QgZXh0ZW5kcyBfQmFzZS5kZWZhdWx0IHsKICAgIGNvbnN0cnVjdG9yKHQgPSBbXSkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmggPSB7fTsKICAgICAgdGhpcy5wID0gdGhpcy5fID0gdGhpcy5oLkwgPSB0aGlzLmguQiA9IHRoaXMuaDsKICAgICAgY29uc3QgaSA9IHRoaXM7CiAgICAgIHQuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIGkucHVzaEJhY2sodCk7CiAgICAgIH0pOwogICAgfQogICAgVih0KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBMOiBpLAogICAgICAgIEI6IHMKICAgICAgfSA9IHQ7CiAgICAgIGkuQiA9IHM7CiAgICAgIHMuTCA9IGk7CiAgICAgIGlmICh0ID09PSB0aGlzLnApIHsKICAgICAgICB0aGlzLnAgPSBzOwogICAgICB9CiAgICAgIGlmICh0ID09PSB0aGlzLl8pIHsKICAgICAgICB0aGlzLl8gPSBpOwogICAgICB9CiAgICAgIHRoaXMuaSAtPSAxOwogICAgfQogICAgRyh0LCBpKSB7CiAgICAgIGNvbnN0IHMgPSBpLkI7CiAgICAgIGNvbnN0IHIgPSB7CiAgICAgICAgbDogdCwKICAgICAgICBMOiBpLAogICAgICAgIEI6IHMKICAgICAgfTsKICAgICAgaS5CID0gcjsKICAgICAgcy5MID0gcjsKICAgICAgaWYgKGkgPT09IHRoaXMuaCkgewogICAgICAgIHRoaXMucCA9IHI7CiAgICAgIH0KICAgICAgaWYgKHMgPT09IHRoaXMuaCkgewogICAgICAgIHRoaXMuXyA9IHI7CiAgICAgIH0KICAgICAgdGhpcy5pICs9IDE7CiAgICB9CiAgICBjbGVhcigpIHsKICAgICAgdGhpcy5pID0gMDsKICAgICAgdGhpcy5wID0gdGhpcy5fID0gdGhpcy5oLkwgPSB0aGlzLmguQiA9IHRoaXMuaDsKICAgIH0KICAgIGJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IExpbmtMaXN0SXRlcmF0b3IodGhpcy5wLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgZW5kKCkgewogICAgICByZXR1cm4gbmV3IExpbmtMaXN0SXRlcmF0b3IodGhpcy5oLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgckJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IExpbmtMaXN0SXRlcmF0b3IodGhpcy5fLCB0aGlzLmgsIHRoaXMsIDEpOwogICAgfQogICAgckVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBMaW5rTGlzdEl0ZXJhdG9yKHRoaXMuaCwgdGhpcy5oLCB0aGlzLCAxKTsKICAgIH0KICAgIGZyb250KCkgewogICAgICByZXR1cm4gdGhpcy5wLmw7CiAgICB9CiAgICBiYWNrKCkgewogICAgICByZXR1cm4gdGhpcy5fLmw7CiAgICB9CiAgICBnZXRFbGVtZW50QnlQb3ModCkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCBpID0gdGhpcy5wOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgaSA9IGkuQjsKICAgICAgfQogICAgICByZXR1cm4gaS5sOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlQb3ModCkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCBpID0gdGhpcy5wOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgaSA9IGkuQjsKICAgICAgfQogICAgICB0aGlzLlYoaSk7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeVZhbHVlKHQpIHsKICAgICAgbGV0IGkgPSB0aGlzLnA7CiAgICAgIHdoaWxlIChpICE9PSB0aGlzLmgpIHsKICAgICAgICBpZiAoaS5sID09PSB0KSB7CiAgICAgICAgICB0aGlzLlYoaSk7CiAgICAgICAgfQogICAgICAgIGkgPSBpLkI7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIGVyYXNlRWxlbWVudEJ5SXRlcmF0b3IodCkgewogICAgICBjb25zdCBpID0gdC5vOwogICAgICBpZiAoaSA9PT0gdGhpcy5oKSB7CiAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgfQogICAgICB0ID0gdC5uZXh0KCk7CiAgICAgIHRoaXMuVihpKTsKICAgICAgcmV0dXJuIHQ7CiAgICB9CiAgICBwdXNoQmFjayh0KSB7CiAgICAgIHRoaXMuRyh0LCB0aGlzLl8pOwogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgcG9wQmFjaygpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICBjb25zdCB0ID0gdGhpcy5fLmw7CiAgICAgIHRoaXMuVih0aGlzLl8pOwogICAgICByZXR1cm4gdDsKICAgIH0KICAgIHB1c2hGcm9udCh0KSB7CiAgICAgIHRoaXMuRyh0LCB0aGlzLmgpOwogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgcG9wRnJvbnQoKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgY29uc3QgdCA9IHRoaXMucC5sOwogICAgICB0aGlzLlYodGhpcy5wKTsKICAgICAgcmV0dXJuIHQ7CiAgICB9CiAgICBzZXRFbGVtZW50QnlQb3ModCwgaSkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCBzID0gdGhpcy5wOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgcyA9IHMuQjsKICAgICAgfQogICAgICBzLmwgPSBpOwogICAgfQogICAgaW5zZXJ0KHQsIGksIHMgPSAxKSB7CiAgICAgIGlmICh0IDwgMCB8fCB0ID4gdGhpcy5pKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoKTsKICAgICAgfQogICAgICBpZiAocyA8PSAwKSByZXR1cm4gdGhpcy5pOwogICAgICBpZiAodCA9PT0gMCkgewogICAgICAgIHdoaWxlIChzLS0pIHRoaXMucHVzaEZyb250KGkpOwogICAgICB9IGVsc2UgaWYgKHQgPT09IHRoaXMuaSkgewogICAgICAgIHdoaWxlIChzLS0pIHRoaXMucHVzaEJhY2soaSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IHIgPSB0aGlzLnA7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCB0OyArK2kpIHsKICAgICAgICAgIHIgPSByLkI7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGUgPSByLkI7CiAgICAgICAgdGhpcy5pICs9IHM7CiAgICAgICAgd2hpbGUgKHMtLSkgewogICAgICAgICAgci5CID0gewogICAgICAgICAgICBsOiBpLAogICAgICAgICAgICBMOiByCiAgICAgICAgICB9OwogICAgICAgICAgci5CLkwgPSByOwogICAgICAgICAgciA9IHIuQjsKICAgICAgICB9CiAgICAgICAgci5CID0gZTsKICAgICAgICBlLkwgPSByOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBmaW5kKHQpIHsKICAgICAgbGV0IGkgPSB0aGlzLnA7CiAgICAgIHdoaWxlIChpICE9PSB0aGlzLmgpIHsKICAgICAgICBpZiAoaS5sID09PSB0KSB7CiAgICAgICAgICByZXR1cm4gbmV3IExpbmtMaXN0SXRlcmF0b3IoaSwgdGhpcy5oLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgaSA9IGkuQjsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lbmQoKTsKICAgIH0KICAgIHJldmVyc2UoKSB7CiAgICAgIGlmICh0aGlzLmkgPD0gMSkgcmV0dXJuOwogICAgICBsZXQgdCA9IHRoaXMucDsKICAgICAgbGV0IGkgPSB0aGlzLl87CiAgICAgIGxldCBzID0gMDsKICAgICAgd2hpbGUgKHMgPDwgMSA8IHRoaXMuaSkgewogICAgICAgIGNvbnN0IHIgPSB0Lmw7CiAgICAgICAgdC5sID0gaS5sOwogICAgICAgIGkubCA9IHI7CiAgICAgICAgdCA9IHQuQjsKICAgICAgICBpID0gaS5MOwogICAgICAgIHMgKz0gMTsKICAgICAgfQogICAgfQogICAgdW5pcXVlKCkgewogICAgICBpZiAodGhpcy5pIDw9IDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5pOwogICAgICB9CiAgICAgIGxldCB0ID0gdGhpcy5wOwogICAgICB3aGlsZSAodCAhPT0gdGhpcy5oKSB7CiAgICAgICAgbGV0IGkgPSB0OwogICAgICAgIHdoaWxlIChpLkIgIT09IHRoaXMuaCAmJiBpLmwgPT09IGkuQi5sKSB7CiAgICAgICAgICBpID0gaS5COwogICAgICAgICAgdGhpcy5pIC09IDE7CiAgICAgICAgfQogICAgICAgIHQuQiA9IGkuQjsKICAgICAgICB0LkIuTCA9IHQ7CiAgICAgICAgdCA9IHQuQjsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgc29ydCh0KSB7CiAgICAgIGlmICh0aGlzLmkgPD0gMSkgcmV0dXJuOwogICAgICBjb25zdCBpID0gW107CiAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIGkucHVzaCh0KTsKICAgICAgfSk7CiAgICAgIGkuc29ydCh0KTsKICAgICAgbGV0IHMgPSB0aGlzLnA7CiAgICAgIGkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgIHMubCA9IHQ7CiAgICAgICAgcyA9IHMuQjsKICAgICAgfSk7CiAgICB9CiAgICBtZXJnZSh0KSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzOwogICAgICBpZiAodGhpcy5pID09PSAwKSB7CiAgICAgICAgdC5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICBpLnB1c2hCYWNrKHQpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBzID0gdGhpcy5wOwogICAgICAgIHQuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgICAgd2hpbGUgKHMgIT09IGkuaCAmJiBzLmwgPD0gdCkgewogICAgICAgICAgICBzID0gcy5COwogICAgICAgICAgfQogICAgICAgICAgaS5HKHQsIHMuTCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIGZvckVhY2godCkgewogICAgICBsZXQgaSA9IHRoaXMucDsKICAgICAgbGV0IHMgPSAwOwogICAgICB3aGlsZSAoaSAhPT0gdGhpcy5oKSB7CiAgICAgICAgdChpLmwsIHMrKywgdGhpcyk7CiAgICAgICAgaSA9IGkuQjsKICAgICAgfQogICAgfQogICAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiogKCkgewogICAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgICBsZXQgdCA9IHRoaXMucDsKICAgICAgICB3aGlsZSAodCAhPT0gdGhpcy5oKSB7CiAgICAgICAgICB5aWVsZCB0Lmw7CiAgICAgICAgICB0ID0gdC5COwogICAgICAgIH0KICAgICAgfS5iaW5kKHRoaXMpKCk7CiAgICB9CiAgfQogIHZhciBfZGVmYXVsdCA9IExpbmtMaXN0OwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShMaW5rTGlzdCk7Cgp2YXIgRGVxdWUgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX0Jhc2UgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KEJhc2UkMik7CiAgdmFyIF9SYW5kb21JdGVyYXRvciA9IFJhbmRvbUl0ZXJhdG9yOwogIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQodCkgewogICAgcmV0dXJuIHQgJiYgdC50ID8gdCA6IHsKICAgICAgZGVmYXVsdDogdAogICAgfTsKICB9CiAgY2xhc3MgRGVxdWVJdGVyYXRvciBleHRlbmRzIF9SYW5kb21JdGVyYXRvci5SYW5kb21JdGVyYXRvciB7CiAgICBjb25zdHJ1Y3Rvcih0LCBpLCBzKSB7CiAgICAgIHN1cGVyKHQsIHMpOwogICAgICB0aGlzLmNvbnRhaW5lciA9IGk7CiAgICB9CiAgICBjb3B5KCkgewogICAgICByZXR1cm4gbmV3IERlcXVlSXRlcmF0b3IodGhpcy5vLCB0aGlzLmNvbnRhaW5lciwgdGhpcy5pdGVyYXRvclR5cGUpOwogICAgfQogIH0KICBjbGFzcyBEZXF1ZSBleHRlbmRzIF9CYXNlLmRlZmF1bHQgewogICAgY29uc3RydWN0b3IodCA9IFtdLCBpID0gMSA8PCAxMikgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLmogPSAwOwogICAgICB0aGlzLkQgPSAwOwogICAgICB0aGlzLlIgPSAwOwogICAgICB0aGlzLk4gPSAwOwogICAgICB0aGlzLlAgPSAwOwogICAgICB0aGlzLkEgPSBbXTsKICAgICAgY29uc3QgcyA9ICgoKSA9PiB7CiAgICAgICAgaWYgKHR5cGVvZiB0Lmxlbmd0aCA9PT0gIm51bWJlciIpIHJldHVybiB0Lmxlbmd0aDsKICAgICAgICBpZiAodHlwZW9mIHQuc2l6ZSA9PT0gIm51bWJlciIpIHJldHVybiB0LnNpemU7CiAgICAgICAgaWYgKHR5cGVvZiB0LnNpemUgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0LnNpemUoKTsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgZ2V0IHRoZSBsZW5ndGggb3Igc2l6ZSBvZiB0aGUgY29udGFpbmVyIik7CiAgICAgIH0pKCk7CiAgICAgIHRoaXMuRiA9IGk7CiAgICAgIHRoaXMuUCA9IE1hdGgubWF4KE1hdGguY2VpbChzIC8gdGhpcy5GKSwgMSk7CiAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy5QOyArK3QpIHsKICAgICAgICB0aGlzLkEucHVzaChuZXcgQXJyYXkodGhpcy5GKSk7CiAgICAgIH0KICAgICAgY29uc3QgaCA9IE1hdGguY2VpbChzIC8gdGhpcy5GKTsKICAgICAgdGhpcy5qID0gdGhpcy5SID0gKHRoaXMuUCA+PiAxKSAtIChoID4+IDEpOwogICAgICB0aGlzLkQgPSB0aGlzLk4gPSB0aGlzLkYgLSBzICUgdGhpcy5GID4+IDE7CiAgICAgIGNvbnN0IGUgPSB0aGlzOwogICAgICB0LmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICBlLnB1c2hCYWNrKHQpOwogICAgICB9KTsKICAgIH0KICAgIFQoKSB7CiAgICAgIGNvbnN0IHQgPSBbXTsKICAgICAgY29uc3QgaSA9IE1hdGgubWF4KHRoaXMuUCA+PiAxLCAxKTsKICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBpOyArK3MpIHsKICAgICAgICB0W3NdID0gbmV3IEFycmF5KHRoaXMuRik7CiAgICAgIH0KICAgICAgZm9yIChsZXQgaSA9IHRoaXMuajsgaSA8IHRoaXMuUDsgKytpKSB7CiAgICAgICAgdFt0Lmxlbmd0aF0gPSB0aGlzLkFbaV07CiAgICAgIH0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLlI7ICsraSkgewogICAgICAgIHRbdC5sZW5ndGhdID0gdGhpcy5BW2ldOwogICAgICB9CiAgICAgIHRbdC5sZW5ndGhdID0gWy4uLnRoaXMuQVt0aGlzLlJdXTsKICAgICAgdGhpcy5qID0gaTsKICAgICAgdGhpcy5SID0gdC5sZW5ndGggLSAxOwogICAgICBmb3IgKGxldCBzID0gMDsgcyA8IGk7ICsrcykgewogICAgICAgIHRbdC5sZW5ndGhdID0gbmV3IEFycmF5KHRoaXMuRik7CiAgICAgIH0KICAgICAgdGhpcy5BID0gdDsKICAgICAgdGhpcy5QID0gdC5sZW5ndGg7CiAgICB9CiAgICBPKHQpIHsKICAgICAgY29uc3QgaSA9IHRoaXMuRCArIHQgKyAxOwogICAgICBjb25zdCBzID0gaSAlIHRoaXMuRjsKICAgICAgbGV0IGggPSBzIC0gMTsKICAgICAgbGV0IGUgPSB0aGlzLmogKyAoaSAtIHMpIC8gdGhpcy5GOwogICAgICBpZiAocyA9PT0gMCkgZSAtPSAxOwogICAgICBlICU9IHRoaXMuUDsKICAgICAgaWYgKGggPCAwKSBoICs9IHRoaXMuRjsKICAgICAgcmV0dXJuIHsKICAgICAgICBjdXJOb2RlQnVja2V0SW5kZXg6IGUsCiAgICAgICAgY3VyTm9kZVBvaW50ZXJJbmRleDogaAogICAgICB9OwogICAgfQogICAgY2xlYXIoKSB7CiAgICAgIHRoaXMuQSA9IFtuZXcgQXJyYXkodGhpcy5GKV07CiAgICAgIHRoaXMuUCA9IDE7CiAgICAgIHRoaXMuaiA9IHRoaXMuUiA9IHRoaXMuaSA9IDA7CiAgICAgIHRoaXMuRCA9IHRoaXMuTiA9IHRoaXMuRiA+PiAxOwogICAgfQogICAgYmVnaW4oKSB7CiAgICAgIHJldHVybiBuZXcgRGVxdWVJdGVyYXRvcigwLCB0aGlzKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBEZXF1ZUl0ZXJhdG9yKHRoaXMuaSwgdGhpcyk7CiAgICB9CiAgICByQmVnaW4oKSB7CiAgICAgIHJldHVybiBuZXcgRGVxdWVJdGVyYXRvcih0aGlzLmkgLSAxLCB0aGlzLCAxKTsKICAgIH0KICAgIHJFbmQoKSB7CiAgICAgIHJldHVybiBuZXcgRGVxdWVJdGVyYXRvcigtMSwgdGhpcywgMSk7CiAgICB9CiAgICBmcm9udCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICByZXR1cm4gdGhpcy5BW3RoaXMual1bdGhpcy5EXTsKICAgIH0KICAgIGJhY2soKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgcmV0dXJuIHRoaXMuQVt0aGlzLlJdW3RoaXMuTl07CiAgICB9CiAgICBwdXNoQmFjayh0KSB7CiAgICAgIGlmICh0aGlzLmkpIHsKICAgICAgICBpZiAodGhpcy5OIDwgdGhpcy5GIC0gMSkgewogICAgICAgICAgdGhpcy5OICs9IDE7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLlIgPCB0aGlzLlAgLSAxKSB7CiAgICAgICAgICB0aGlzLlIgKz0gMTsKICAgICAgICAgIHRoaXMuTiA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuUiA9IDA7CiAgICAgICAgICB0aGlzLk4gPSAwOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5SID09PSB0aGlzLmogJiYgdGhpcy5OID09PSB0aGlzLkQpIHRoaXMuVCgpOwogICAgICB9CiAgICAgIHRoaXMuaSArPSAxOwogICAgICB0aGlzLkFbdGhpcy5SXVt0aGlzLk5dID0gdDsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIHBvcEJhY2soKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybjsKICAgICAgY29uc3QgdCA9IHRoaXMuQVt0aGlzLlJdW3RoaXMuTl07CiAgICAgIGlmICh0aGlzLmkgIT09IDEpIHsKICAgICAgICBpZiAodGhpcy5OID4gMCkgewogICAgICAgICAgdGhpcy5OIC09IDE7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLlIgPiAwKSB7CiAgICAgICAgICB0aGlzLlIgLT0gMTsKICAgICAgICAgIHRoaXMuTiA9IHRoaXMuRiAtIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuUiA9IHRoaXMuUCAtIDE7CiAgICAgICAgICB0aGlzLk4gPSB0aGlzLkYgLSAxOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLmkgLT0gMTsKICAgICAgcmV0dXJuIHQ7CiAgICB9CiAgICBwdXNoRnJvbnQodCkgewogICAgICBpZiAodGhpcy5pKSB7CiAgICAgICAgaWYgKHRoaXMuRCA+IDApIHsKICAgICAgICAgIHRoaXMuRCAtPSAxOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5qID4gMCkgewogICAgICAgICAgdGhpcy5qIC09IDE7CiAgICAgICAgICB0aGlzLkQgPSB0aGlzLkYgLSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmogPSB0aGlzLlAgLSAxOwogICAgICAgICAgdGhpcy5EID0gdGhpcy5GIC0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaiA9PT0gdGhpcy5SICYmIHRoaXMuRCA9PT0gdGhpcy5OKSB0aGlzLlQoKTsKICAgICAgfQogICAgICB0aGlzLmkgKz0gMTsKICAgICAgdGhpcy5BW3RoaXMual1bdGhpcy5EXSA9IHQ7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBwb3BGcm9udCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICBjb25zdCB0ID0gdGhpcy5BW3RoaXMual1bdGhpcy5EXTsKICAgICAgaWYgKHRoaXMuaSAhPT0gMSkgewogICAgICAgIGlmICh0aGlzLkQgPCB0aGlzLkYgLSAxKSB7CiAgICAgICAgICB0aGlzLkQgKz0gMTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaiA8IHRoaXMuUCAtIDEpIHsKICAgICAgICAgIHRoaXMuaiArPSAxOwogICAgICAgICAgdGhpcy5EID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5qID0gMDsKICAgICAgICAgIHRoaXMuRCA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaSAtPSAxOwogICAgICByZXR1cm4gdDsKICAgIH0KICAgIGdldEVsZW1lbnRCeVBvcyh0KSB7CiAgICAgIGlmICh0IDwgMCB8fCB0ID4gdGhpcy5pIC0gMSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCk7CiAgICAgIH0KICAgICAgY29uc3QgewogICAgICAgIGN1ck5vZGVCdWNrZXRJbmRleDogaSwKICAgICAgICBjdXJOb2RlUG9pbnRlckluZGV4OiBzCiAgICAgIH0gPSB0aGlzLk8odCk7CiAgICAgIHJldHVybiB0aGlzLkFbaV1bc107CiAgICB9CiAgICBzZXRFbGVtZW50QnlQb3ModCwgaSkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGNvbnN0IHsKICAgICAgICBjdXJOb2RlQnVja2V0SW5kZXg6IHMsCiAgICAgICAgY3VyTm9kZVBvaW50ZXJJbmRleDogaAogICAgICB9ID0gdGhpcy5PKHQpOwogICAgICB0aGlzLkFbc11baF0gPSBpOwogICAgfQogICAgaW5zZXJ0KHQsIGksIHMgPSAxKSB7CiAgICAgIGlmICh0IDwgMCB8fCB0ID4gdGhpcy5pKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoKTsKICAgICAgfQogICAgICBpZiAodCA9PT0gMCkgewogICAgICAgIHdoaWxlIChzLS0pIHRoaXMucHVzaEZyb250KGkpOwogICAgICB9IGVsc2UgaWYgKHQgPT09IHRoaXMuaSkgewogICAgICAgIHdoaWxlIChzLS0pIHRoaXMucHVzaEJhY2soaSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaCA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSB0OyBpIDwgdGhpcy5pOyArK2kpIHsKICAgICAgICAgIGgucHVzaCh0aGlzLmdldEVsZW1lbnRCeVBvcyhpKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY3V0KHQgLSAxKTsKICAgICAgICBmb3IgKGxldCB0ID0gMDsgdCA8IHM7ICsrdCkgdGhpcy5wdXNoQmFjayhpKTsKICAgICAgICBmb3IgKGxldCB0ID0gMDsgdCA8IGgubGVuZ3RoOyArK3QpIHRoaXMucHVzaEJhY2soaFt0XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIGN1dCh0KSB7CiAgICAgIGlmICh0IDwgMCkgewogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCB7CiAgICAgICAgY3VyTm9kZUJ1Y2tldEluZGV4OiBpLAogICAgICAgIGN1ck5vZGVQb2ludGVySW5kZXg6IHMKICAgICAgfSA9IHRoaXMuTyh0KTsKICAgICAgdGhpcy5SID0gaTsKICAgICAgdGhpcy5OID0gczsKICAgICAgdGhpcy5pID0gdCArIDE7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeVBvcyh0KSB7CiAgICAgIGlmICh0IDwgMCB8fCB0ID4gdGhpcy5pIC0gMSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCk7CiAgICAgIH0KICAgICAgaWYgKHQgPT09IDApIHRoaXMucG9wRnJvbnQoKTtlbHNlIGlmICh0ID09PSB0aGlzLmkgLSAxKSB0aGlzLnBvcEJhY2soKTtlbHNlIHsKICAgICAgICBjb25zdCBpID0gW107CiAgICAgICAgZm9yIChsZXQgcyA9IHQgKyAxOyBzIDwgdGhpcy5pOyArK3MpIHsKICAgICAgICAgIGkucHVzaCh0aGlzLmdldEVsZW1lbnRCeVBvcyhzKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY3V0KHQpOwogICAgICAgIHRoaXMucG9wQmFjaygpOwogICAgICAgIGNvbnN0IHMgPSB0aGlzOwogICAgICAgIGkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICAgICAgcy5wdXNoQmFjayh0KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5pOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlWYWx1ZSh0KSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybiAwOwogICAgICBjb25zdCBpID0gW107CiAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgdGhpcy5pOyArK3MpIHsKICAgICAgICBjb25zdCBoID0gdGhpcy5nZXRFbGVtZW50QnlQb3Mocyk7CiAgICAgICAgaWYgKGggIT09IHQpIGkucHVzaChoKTsKICAgICAgfQogICAgICBjb25zdCBzID0gaS5sZW5ndGg7CiAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgczsgKyt0KSB0aGlzLnNldEVsZW1lbnRCeVBvcyh0LCBpW3RdKTsKICAgICAgcmV0dXJuIHRoaXMuY3V0KHMgLSAxKTsKICAgIH0KICAgIGVyYXNlRWxlbWVudEJ5SXRlcmF0b3IodCkgewogICAgICBjb25zdCBpID0gdC5vOwogICAgICB0aGlzLmVyYXNlRWxlbWVudEJ5UG9zKGkpOwogICAgICB0ID0gdC5uZXh0KCk7CiAgICAgIHJldHVybiB0OwogICAgfQogICAgZmluZCh0KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pOyArK2kpIHsKICAgICAgICBpZiAodGhpcy5nZXRFbGVtZW50QnlQb3MoaSkgPT09IHQpIHsKICAgICAgICAgIHJldHVybiBuZXcgRGVxdWVJdGVyYXRvcihpLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZW5kKCk7CiAgICB9CiAgICByZXZlcnNlKCkgewogICAgICBsZXQgdCA9IDA7CiAgICAgIGxldCBpID0gdGhpcy5pIC0gMTsKICAgICAgd2hpbGUgKHQgPCBpKSB7CiAgICAgICAgY29uc3QgcyA9IHRoaXMuZ2V0RWxlbWVudEJ5UG9zKHQpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudEJ5UG9zKHQsIHRoaXMuZ2V0RWxlbWVudEJ5UG9zKGkpKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnRCeVBvcyhpLCBzKTsKICAgICAgICB0ICs9IDE7CiAgICAgICAgaSAtPSAxOwogICAgICB9CiAgICB9CiAgICB1bmlxdWUoKSB7CiAgICAgIGlmICh0aGlzLmkgPD0gMSkgewogICAgICAgIHJldHVybiB0aGlzLmk7CiAgICAgIH0KICAgICAgbGV0IHQgPSAxOwogICAgICBsZXQgaSA9IHRoaXMuZ2V0RWxlbWVudEJ5UG9zKDApOwogICAgICBmb3IgKGxldCBzID0gMTsgcyA8IHRoaXMuaTsgKytzKSB7CiAgICAgICAgY29uc3QgaCA9IHRoaXMuZ2V0RWxlbWVudEJ5UG9zKHMpOwogICAgICAgIGlmIChoICE9PSBpKSB7CiAgICAgICAgICBpID0gaDsKICAgICAgICAgIHRoaXMuc2V0RWxlbWVudEJ5UG9zKHQrKywgaCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlICh0aGlzLmkgPiB0KSB0aGlzLnBvcEJhY2soKTsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIHNvcnQodCkgewogICAgICBjb25zdCBpID0gW107CiAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy5pOyArK3QpIHsKICAgICAgICBpLnB1c2godGhpcy5nZXRFbGVtZW50QnlQb3ModCkpOwogICAgICB9CiAgICAgIGkuc29ydCh0KTsKICAgICAgZm9yIChsZXQgdCA9IDA7IHQgPCB0aGlzLmk7ICsrdCkgdGhpcy5zZXRFbGVtZW50QnlQb3ModCwgaVt0XSk7CiAgICB9CiAgICBzaHJpbmtUb0ZpdCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICBjb25zdCB0ID0gW107CiAgICAgIHRoaXMuZm9yRWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgIHQucHVzaChpKTsKICAgICAgfSk7CiAgICAgIHRoaXMuUCA9IE1hdGgubWF4KE1hdGguY2VpbCh0aGlzLmkgLyB0aGlzLkYpLCAxKTsKICAgICAgdGhpcy5pID0gdGhpcy5qID0gdGhpcy5SID0gdGhpcy5EID0gdGhpcy5OID0gMDsKICAgICAgdGhpcy5BID0gW107CiAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy5QOyArK3QpIHsKICAgICAgICB0aGlzLkEucHVzaChuZXcgQXJyYXkodGhpcy5GKSk7CiAgICAgIH0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0Lmxlbmd0aDsgKytpKSB0aGlzLnB1c2hCYWNrKHRbaV0pOwogICAgfQogICAgZm9yRWFjaCh0KSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pOyArK2kpIHsKICAgICAgICB0KHRoaXMuZ2V0RWxlbWVudEJ5UG9zKGkpLCBpLCB0aGlzKTsKICAgICAgfQogICAgfQogICAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiogKCkgewogICAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgdGhpcy5pOyArK3QpIHsKICAgICAgICAgIHlpZWxkIHRoaXMuZ2V0RWxlbWVudEJ5UG9zKHQpOwogICAgICAgIH0KICAgICAgfS5iaW5kKHRoaXMpKCk7CiAgICB9CiAgfQogIHZhciBfZGVmYXVsdCA9IERlcXVlOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShEZXF1ZSk7Cgp2YXIgT3JkZXJlZFNldCA9IHt9OwoKdmFyIEJhc2UkMSA9IHt9OwoKdmFyIFRyZWVOb2RlID0ge307CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLlRyZWVOb2RlRW5hYmxlSW5kZXggPSBleHBvcnRzLlRyZWVOb2RlID0gdm9pZCAwOwogIGNsYXNzIFRyZWVOb2RlIHsKICAgIGNvbnN0cnVjdG9yKGUsIHQpIHsKICAgICAgdGhpcy5lZSA9IDE7CiAgICAgIHRoaXMudSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5sID0gdW5kZWZpbmVkOwogICAgICB0aGlzLlUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuVyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy50dCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy51ID0gZTsKICAgICAgdGhpcy5sID0gdDsKICAgIH0KICAgIEwoKSB7CiAgICAgIGxldCBlID0gdGhpczsKICAgICAgaWYgKGUuZWUgPT09IDEgJiYgZS50dC50dCA9PT0gZSkgewogICAgICAgIGUgPSBlLlc7CiAgICAgIH0gZWxzZSBpZiAoZS5VKSB7CiAgICAgICAgZSA9IGUuVTsKICAgICAgICB3aGlsZSAoZS5XKSB7CiAgICAgICAgICBlID0gZS5XOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgdCA9IGUudHQ7CiAgICAgICAgd2hpbGUgKHQuVSA9PT0gZSkgewogICAgICAgICAgZSA9IHQ7CiAgICAgICAgICB0ID0gZS50dDsKICAgICAgICB9CiAgICAgICAgZSA9IHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGU7CiAgICB9CiAgICBCKCkgewogICAgICBsZXQgZSA9IHRoaXM7CiAgICAgIGlmIChlLlcpIHsKICAgICAgICBlID0gZS5XOwogICAgICAgIHdoaWxlIChlLlUpIHsKICAgICAgICAgIGUgPSBlLlU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCB0ID0gZS50dDsKICAgICAgICB3aGlsZSAodC5XID09PSBlKSB7CiAgICAgICAgICBlID0gdDsKICAgICAgICAgIHQgPSBlLnR0OwogICAgICAgIH0KICAgICAgICBpZiAoZS5XICE9PSB0KSB7CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9IGVsc2UgcmV0dXJuIGU7CiAgICAgIH0KICAgIH0KICAgIHRlKCkgewogICAgICBjb25zdCBlID0gdGhpcy50dDsKICAgICAgY29uc3QgdCA9IHRoaXMuVzsKICAgICAgY29uc3QgcyA9IHQuVTsKICAgICAgaWYgKGUudHQgPT09IHRoaXMpIGUudHQgPSB0O2Vsc2UgaWYgKGUuVSA9PT0gdGhpcykgZS5VID0gdDtlbHNlIGUuVyA9IHQ7CiAgICAgIHQudHQgPSBlOwogICAgICB0LlUgPSB0aGlzOwogICAgICB0aGlzLnR0ID0gdDsKICAgICAgdGhpcy5XID0gczsKICAgICAgaWYgKHMpIHMudHQgPSB0aGlzOwogICAgICByZXR1cm4gdDsKICAgIH0KICAgIHNlKCkgewogICAgICBjb25zdCBlID0gdGhpcy50dDsKICAgICAgY29uc3QgdCA9IHRoaXMuVTsKICAgICAgY29uc3QgcyA9IHQuVzsKICAgICAgaWYgKGUudHQgPT09IHRoaXMpIGUudHQgPSB0O2Vsc2UgaWYgKGUuVSA9PT0gdGhpcykgZS5VID0gdDtlbHNlIGUuVyA9IHQ7CiAgICAgIHQudHQgPSBlOwogICAgICB0LlcgPSB0aGlzOwogICAgICB0aGlzLnR0ID0gdDsKICAgICAgdGhpcy5VID0gczsKICAgICAgaWYgKHMpIHMudHQgPSB0aGlzOwogICAgICByZXR1cm4gdDsKICAgIH0KICB9CiAgZXhwb3J0cy5UcmVlTm9kZSA9IFRyZWVOb2RlOwogIGNsYXNzIFRyZWVOb2RlRW5hYmxlSW5kZXggZXh0ZW5kcyBUcmVlTm9kZSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgdGhpcy5ydCA9IDE7CiAgICB9CiAgICB0ZSgpIHsKICAgICAgY29uc3QgZSA9IHN1cGVyLnRlKCk7CiAgICAgIHRoaXMuaWUoKTsKICAgICAgZS5pZSgpOwogICAgICByZXR1cm4gZTsKICAgIH0KICAgIHNlKCkgewogICAgICBjb25zdCBlID0gc3VwZXIuc2UoKTsKICAgICAgdGhpcy5pZSgpOwogICAgICBlLmllKCk7CiAgICAgIHJldHVybiBlOwogICAgfQogICAgaWUoKSB7CiAgICAgIHRoaXMucnQgPSAxOwogICAgICBpZiAodGhpcy5VKSB7CiAgICAgICAgdGhpcy5ydCArPSB0aGlzLlUucnQ7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuVykgewogICAgICAgIHRoaXMucnQgKz0gdGhpcy5XLnJ0OwogICAgICB9CiAgICB9CiAgfQogIGV4cG9ydHMuVHJlZU5vZGVFbmFibGVJbmRleCA9IFRyZWVOb2RlRW5hYmxlSW5kZXg7Cn0pKFRyZWVOb2RlKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX1RyZWVOb2RlID0gVHJlZU5vZGU7CiAgdmFyIF9Db250YWluZXJCYXNlID0gQ29udGFpbmVyQmFzZTsKICB2YXIgX3Rocm93RXJyb3IgPSB0aHJvd0Vycm9yOwogIGNsYXNzIFRyZWVDb250YWluZXIgZXh0ZW5kcyBfQ29udGFpbmVyQmFzZS5Db250YWluZXIgewogICAgY29uc3RydWN0b3IoZSA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIGlmIChlIDwgdCkgcmV0dXJuIC0xOwogICAgICBpZiAoZSA+IHQpIHJldHVybiAxOwogICAgICByZXR1cm4gMDsKICAgIH0sIHQgPSBmYWxzZSkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLlkgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMudiA9IGU7CiAgICAgIGlmICh0KSB7CiAgICAgICAgdGhpcy5yZSA9IF9UcmVlTm9kZS5UcmVlTm9kZUVuYWJsZUluZGV4OwogICAgICAgIHRoaXMuTSA9IGZ1bmN0aW9uIChlLCB0LCBpKSB7CiAgICAgICAgICBjb25zdCBzID0gdGhpcy5uZShlLCB0LCBpKTsKICAgICAgICAgIGlmIChzKSB7CiAgICAgICAgICAgIGxldCBlID0gcy50dDsKICAgICAgICAgICAgd2hpbGUgKGUgIT09IHRoaXMuaCkgewogICAgICAgICAgICAgIGUucnQgKz0gMTsKICAgICAgICAgICAgICBlID0gZS50dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB0ID0gdGhpcy5oZShzKTsKICAgICAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgICBwYXJlbnROb2RlOiBlLAogICAgICAgICAgICAgICAgZ3JhbmRQYXJlbnQ6IGksCiAgICAgICAgICAgICAgICBjdXJOb2RlOiBzCiAgICAgICAgICAgICAgfSA9IHQ7CiAgICAgICAgICAgICAgZS5pZSgpOwogICAgICAgICAgICAgIGkuaWUoKTsKICAgICAgICAgICAgICBzLmllKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLmk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLlYgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgbGV0IHQgPSB0aGlzLmZlKGUpOwogICAgICAgICAgd2hpbGUgKHQgIT09IHRoaXMuaCkgewogICAgICAgICAgICB0LnJ0IC09IDE7CiAgICAgICAgICAgIHQgPSB0LnR0OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZSA9IF9UcmVlTm9kZS5UcmVlTm9kZTsKICAgICAgICB0aGlzLk0gPSBmdW5jdGlvbiAoZSwgdCwgaSkgewogICAgICAgICAgY29uc3QgcyA9IHRoaXMubmUoZSwgdCwgaSk7CiAgICAgICAgICBpZiAocykgdGhpcy5oZShzKTsKICAgICAgICAgIHJldHVybiB0aGlzLmk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLlYgPSB0aGlzLmZlOwogICAgICB9CiAgICAgIHRoaXMuaCA9IG5ldyB0aGlzLnJlKCk7CiAgICB9CiAgICBYKGUsIHQpIHsKICAgICAgbGV0IGkgPSB0aGlzLmg7CiAgICAgIHdoaWxlIChlKSB7CiAgICAgICAgY29uc3QgcyA9IHRoaXMudihlLnUsIHQpOwogICAgICAgIGlmIChzIDwgMCkgewogICAgICAgICAgZSA9IGUuVzsKICAgICAgICB9IGVsc2UgaWYgKHMgPiAwKSB7CiAgICAgICAgICBpID0gZTsKICAgICAgICAgIGUgPSBlLlU7CiAgICAgICAgfSBlbHNlIHJldHVybiBlOwogICAgICB9CiAgICAgIHJldHVybiBpOwogICAgfQogICAgWihlLCB0KSB7CiAgICAgIGxldCBpID0gdGhpcy5oOwogICAgICB3aGlsZSAoZSkgewogICAgICAgIGNvbnN0IHMgPSB0aGlzLnYoZS51LCB0KTsKICAgICAgICBpZiAocyA8PSAwKSB7CiAgICAgICAgICBlID0gZS5XOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpID0gZTsKICAgICAgICAgIGUgPSBlLlU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpOwogICAgfQogICAgJChlLCB0KSB7CiAgICAgIGxldCBpID0gdGhpcy5oOwogICAgICB3aGlsZSAoZSkgewogICAgICAgIGNvbnN0IHMgPSB0aGlzLnYoZS51LCB0KTsKICAgICAgICBpZiAocyA8IDApIHsKICAgICAgICAgIGkgPSBlOwogICAgICAgICAgZSA9IGUuVzsKICAgICAgICB9IGVsc2UgaWYgKHMgPiAwKSB7CiAgICAgICAgICBlID0gZS5VOwogICAgICAgIH0gZWxzZSByZXR1cm4gZTsKICAgICAgfQogICAgICByZXR1cm4gaTsKICAgIH0KICAgIHJyKGUsIHQpIHsKICAgICAgbGV0IGkgPSB0aGlzLmg7CiAgICAgIHdoaWxlIChlKSB7CiAgICAgICAgY29uc3QgcyA9IHRoaXMudihlLnUsIHQpOwogICAgICAgIGlmIChzIDwgMCkgewogICAgICAgICAgaSA9IGU7CiAgICAgICAgICBlID0gZS5XOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlID0gZS5VOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaTsKICAgIH0KICAgIHVlKGUpIHsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBjb25zdCB0ID0gZS50dDsKICAgICAgICBpZiAodCA9PT0gdGhpcy5oKSByZXR1cm47CiAgICAgICAgaWYgKGUuZWUgPT09IDEpIHsKICAgICAgICAgIGUuZWUgPSAwOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoZSA9PT0gdC5VKSB7CiAgICAgICAgICBjb25zdCBpID0gdC5XOwogICAgICAgICAgaWYgKGkuZWUgPT09IDEpIHsKICAgICAgICAgICAgaS5lZSA9IDA7CiAgICAgICAgICAgIHQuZWUgPSAxOwogICAgICAgICAgICBpZiAodCA9PT0gdGhpcy5ZKSB7CiAgICAgICAgICAgICAgdGhpcy5ZID0gdC50ZSgpOwogICAgICAgICAgICB9IGVsc2UgdC50ZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGkuVyAmJiBpLlcuZWUgPT09IDEpIHsKICAgICAgICAgICAgICBpLmVlID0gdC5lZTsKICAgICAgICAgICAgICB0LmVlID0gMDsKICAgICAgICAgICAgICBpLlcuZWUgPSAwOwogICAgICAgICAgICAgIGlmICh0ID09PSB0aGlzLlkpIHsKICAgICAgICAgICAgICAgIHRoaXMuWSA9IHQudGUoKTsKICAgICAgICAgICAgICB9IGVsc2UgdC50ZSgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChpLlUgJiYgaS5VLmVlID09PSAxKSB7CiAgICAgICAgICAgICAgaS5lZSA9IDE7CiAgICAgICAgICAgICAgaS5VLmVlID0gMDsKICAgICAgICAgICAgICBpLnNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaS5lZSA9IDE7CiAgICAgICAgICAgICAgZSA9IHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgaSA9IHQuVTsKICAgICAgICAgIGlmIChpLmVlID09PSAxKSB7CiAgICAgICAgICAgIGkuZWUgPSAwOwogICAgICAgICAgICB0LmVlID0gMTsKICAgICAgICAgICAgaWYgKHQgPT09IHRoaXMuWSkgewogICAgICAgICAgICAgIHRoaXMuWSA9IHQuc2UoKTsKICAgICAgICAgICAgfSBlbHNlIHQuc2UoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpLlUgJiYgaS5VLmVlID09PSAxKSB7CiAgICAgICAgICAgICAgaS5lZSA9IHQuZWU7CiAgICAgICAgICAgICAgdC5lZSA9IDA7CiAgICAgICAgICAgICAgaS5VLmVlID0gMDsKICAgICAgICAgICAgICBpZiAodCA9PT0gdGhpcy5ZKSB7CiAgICAgICAgICAgICAgICB0aGlzLlkgPSB0LnNlKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHQuc2UoKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaS5XICYmIGkuVy5lZSA9PT0gMSkgewogICAgICAgICAgICAgIGkuZWUgPSAxOwogICAgICAgICAgICAgIGkuVy5lZSA9IDA7CiAgICAgICAgICAgICAgaS50ZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGkuZWUgPSAxOwogICAgICAgICAgICAgIGUgPSB0OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmZShlKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDEpIHsKICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuaDsKICAgICAgfQogICAgICBsZXQgdCA9IGU7CiAgICAgIHdoaWxlICh0LlUgfHwgdC5XKSB7CiAgICAgICAgaWYgKHQuVykgewogICAgICAgICAgdCA9IHQuVzsKICAgICAgICAgIHdoaWxlICh0LlUpIHQgPSB0LlU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQgPSB0LlU7CiAgICAgICAgfQogICAgICAgIFtlLnUsIHQudV0gPSBbdC51LCBlLnVdOwogICAgICAgIFtlLmwsIHQubF0gPSBbdC5sLCBlLmxdOwogICAgICAgIGUgPSB0OwogICAgICB9CiAgICAgIGlmICh0aGlzLmguVSA9PT0gdCkgewogICAgICAgIHRoaXMuaC5VID0gdC50dDsKICAgICAgfSBlbHNlIGlmICh0aGlzLmguVyA9PT0gdCkgewogICAgICAgIHRoaXMuaC5XID0gdC50dDsKICAgICAgfQogICAgICB0aGlzLnVlKHQpOwogICAgICBjb25zdCBpID0gdC50dDsKICAgICAgaWYgKHQgPT09IGkuVSkgewogICAgICAgIGkuVSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGkuVyA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5pIC09IDE7CiAgICAgIHRoaXMuWS5lZSA9IDA7CiAgICAgIHJldHVybiBpOwogICAgfQogICAgb2UoZSwgdCkgewogICAgICBpZiAoZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGNvbnN0IGkgPSB0aGlzLm9lKGUuVSwgdCk7CiAgICAgIGlmIChpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHQoZSkpIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gdGhpcy5vZShlLlcsIHQpOwogICAgfQogICAgaGUoZSkgewogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGNvbnN0IHQgPSBlLnR0OwogICAgICAgIGlmICh0LmVlID09PSAwKSByZXR1cm47CiAgICAgICAgY29uc3QgaSA9IHQudHQ7CiAgICAgICAgaWYgKHQgPT09IGkuVSkgewogICAgICAgICAgY29uc3QgcyA9IGkuVzsKICAgICAgICAgIGlmIChzICYmIHMuZWUgPT09IDEpIHsKICAgICAgICAgICAgcy5lZSA9IHQuZWUgPSAwOwogICAgICAgICAgICBpZiAoaSA9PT0gdGhpcy5ZKSByZXR1cm47CiAgICAgICAgICAgIGkuZWUgPSAxOwogICAgICAgICAgICBlID0gaTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGUgPT09IHQuVykgewogICAgICAgICAgICBlLmVlID0gMDsKICAgICAgICAgICAgaWYgKGUuVSkgZS5VLnR0ID0gdDsKICAgICAgICAgICAgaWYgKGUuVykgZS5XLnR0ID0gaTsKICAgICAgICAgICAgdC5XID0gZS5VOwogICAgICAgICAgICBpLlUgPSBlLlc7CiAgICAgICAgICAgIGUuVSA9IHQ7CiAgICAgICAgICAgIGUuVyA9IGk7CiAgICAgICAgICAgIGlmIChpID09PSB0aGlzLlkpIHsKICAgICAgICAgICAgICB0aGlzLlkgPSBlOwogICAgICAgICAgICAgIHRoaXMuaC50dCA9IGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc3QgdCA9IGkudHQ7CiAgICAgICAgICAgICAgaWYgKHQuVSA9PT0gaSkgewogICAgICAgICAgICAgICAgdC5VID0gZTsKICAgICAgICAgICAgICB9IGVsc2UgdC5XID0gZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlLnR0ID0gaS50dDsKICAgICAgICAgICAgdC50dCA9IGU7CiAgICAgICAgICAgIGkudHQgPSBlOwogICAgICAgICAgICBpLmVlID0gMTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwYXJlbnROb2RlOiB0LAogICAgICAgICAgICAgIGdyYW5kUGFyZW50OiBpLAogICAgICAgICAgICAgIGN1ck5vZGU6IGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHQuZWUgPSAwOwogICAgICAgICAgICBpZiAoaSA9PT0gdGhpcy5ZKSB7CiAgICAgICAgICAgICAgdGhpcy5ZID0gaS5zZSgpOwogICAgICAgICAgICB9IGVsc2UgaS5zZSgpOwogICAgICAgICAgICBpLmVlID0gMTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgcyA9IGkuVTsKICAgICAgICAgIGlmIChzICYmIHMuZWUgPT09IDEpIHsKICAgICAgICAgICAgcy5lZSA9IHQuZWUgPSAwOwogICAgICAgICAgICBpZiAoaSA9PT0gdGhpcy5ZKSByZXR1cm47CiAgICAgICAgICAgIGkuZWUgPSAxOwogICAgICAgICAgICBlID0gaTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGUgPT09IHQuVSkgewogICAgICAgICAgICBlLmVlID0gMDsKICAgICAgICAgICAgaWYgKGUuVSkgZS5VLnR0ID0gaTsKICAgICAgICAgICAgaWYgKGUuVykgZS5XLnR0ID0gdDsKICAgICAgICAgICAgaS5XID0gZS5VOwogICAgICAgICAgICB0LlUgPSBlLlc7CiAgICAgICAgICAgIGUuVSA9IGk7CiAgICAgICAgICAgIGUuVyA9IHQ7CiAgICAgICAgICAgIGlmIChpID09PSB0aGlzLlkpIHsKICAgICAgICAgICAgICB0aGlzLlkgPSBlOwogICAgICAgICAgICAgIHRoaXMuaC50dCA9IGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc3QgdCA9IGkudHQ7CiAgICAgICAgICAgICAgaWYgKHQuVSA9PT0gaSkgewogICAgICAgICAgICAgICAgdC5VID0gZTsKICAgICAgICAgICAgICB9IGVsc2UgdC5XID0gZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlLnR0ID0gaS50dDsKICAgICAgICAgICAgdC50dCA9IGU7CiAgICAgICAgICAgIGkudHQgPSBlOwogICAgICAgICAgICBpLmVlID0gMTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwYXJlbnROb2RlOiB0LAogICAgICAgICAgICAgIGdyYW5kUGFyZW50OiBpLAogICAgICAgICAgICAgIGN1ck5vZGU6IGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHQuZWUgPSAwOwogICAgICAgICAgICBpZiAoaSA9PT0gdGhpcy5ZKSB7CiAgICAgICAgICAgICAgdGhpcy5ZID0gaS50ZSgpOwogICAgICAgICAgICB9IGVsc2UgaS50ZSgpOwogICAgICAgICAgICBpLmVlID0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBuZShlLCB0LCBpKSB7CiAgICAgIGlmICh0aGlzLlkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuaSArPSAxOwogICAgICAgIHRoaXMuWSA9IG5ldyB0aGlzLnJlKGUsIHQpOwogICAgICAgIHRoaXMuWS5lZSA9IDA7CiAgICAgICAgdGhpcy5ZLnR0ID0gdGhpcy5oOwogICAgICAgIHRoaXMuaC50dCA9IHRoaXMuWTsKICAgICAgICB0aGlzLmguVSA9IHRoaXMuWTsKICAgICAgICB0aGlzLmguVyA9IHRoaXMuWTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IHM7CiAgICAgIGNvbnN0IHIgPSB0aGlzLmguVTsKICAgICAgY29uc3QgbiA9IHRoaXMudihyLnUsIGUpOwogICAgICBpZiAobiA9PT0gMCkgewogICAgICAgIHIubCA9IHQ7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG4gPiAwKSB7CiAgICAgICAgci5VID0gbmV3IHRoaXMucmUoZSwgdCk7CiAgICAgICAgci5VLnR0ID0gcjsKICAgICAgICBzID0gci5VOwogICAgICAgIHRoaXMuaC5VID0gczsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByID0gdGhpcy5oLlc7CiAgICAgICAgY29uc3QgbiA9IHRoaXMudihyLnUsIGUpOwogICAgICAgIGlmIChuID09PSAwKSB7CiAgICAgICAgICByLmwgPSB0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSBpZiAobiA8IDApIHsKICAgICAgICAgIHIuVyA9IG5ldyB0aGlzLnJlKGUsIHQpOwogICAgICAgICAgci5XLnR0ID0gcjsKICAgICAgICAgIHMgPSByLlc7CiAgICAgICAgICB0aGlzLmguVyA9IHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgY29uc3QgciA9IGkubzsKICAgICAgICAgICAgaWYgKHIgIT09IHRoaXMuaCkgewogICAgICAgICAgICAgIGNvbnN0IGkgPSB0aGlzLnYoci51LCBlKTsKICAgICAgICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgICAgICAgci5sID0gdDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpID0gci5MKCk7CiAgICAgICAgICAgICAgICBjb25zdCBuID0gdGhpcy52KGkudSwgZSk7CiAgICAgICAgICAgICAgICBpZiAobiA9PT0gMCkgewogICAgICAgICAgICAgICAgICBpLmwgPSB0OwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG4gPCAwKSB7CiAgICAgICAgICAgICAgICAgIHMgPSBuZXcgdGhpcy5yZShlLCB0KTsKICAgICAgICAgICAgICAgICAgaWYgKGkuVyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgaS5XID0gczsKICAgICAgICAgICAgICAgICAgICBzLnR0ID0gaTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByLlUgPSBzOwogICAgICAgICAgICAgICAgICAgIHMudHQgPSByOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHMgPSB0aGlzLlk7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgY29uc3QgaSA9IHRoaXMudihzLnUsIGUpOwogICAgICAgICAgICAgIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgaWYgKHMuVSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHMuVSA9IG5ldyB0aGlzLnJlKGUsIHQpOwogICAgICAgICAgICAgICAgICBzLlUudHQgPSBzOwogICAgICAgICAgICAgICAgICBzID0gcy5VOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHMgPSBzLlU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpIDwgMCkgewogICAgICAgICAgICAgICAgaWYgKHMuVyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHMuVyA9IG5ldyB0aGlzLnJlKGUsIHQpOwogICAgICAgICAgICAgICAgICBzLlcudHQgPSBzOwogICAgICAgICAgICAgICAgICBzID0gcy5XOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHMgPSBzLlc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHMubCA9IHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaSArPSAxOwogICAgICByZXR1cm4gczsKICAgIH0KICAgIEkoZSwgdCkgewogICAgICB3aGlsZSAoZSkgewogICAgICAgIGNvbnN0IGkgPSB0aGlzLnYoZS51LCB0KTsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGUgPSBlLlc7CiAgICAgICAgfSBlbHNlIGlmIChpID4gMCkgewogICAgICAgICAgZSA9IGUuVTsKICAgICAgICB9IGVsc2UgcmV0dXJuIGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGUgfHwgdGhpcy5oOwogICAgfQogICAgY2xlYXIoKSB7CiAgICAgIHRoaXMuaSA9IDA7CiAgICAgIHRoaXMuWSA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5oLnR0ID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmguVSA9IHRoaXMuaC5XID0gdW5kZWZpbmVkOwogICAgfQogICAgdXBkYXRlS2V5QnlJdGVyYXRvcihlLCB0KSB7CiAgICAgIGNvbnN0IGkgPSBlLm87CiAgICAgIGlmIChpID09PSB0aGlzLmgpIHsKICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmkgPT09IDEpIHsKICAgICAgICBpLnUgPSB0OwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpID09PSB0aGlzLmguVSkgewogICAgICAgIGlmICh0aGlzLnYoaS5CKCkudSwgdCkgPiAwKSB7CiAgICAgICAgICBpLnUgPSB0OwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoaSA9PT0gdGhpcy5oLlcpIHsKICAgICAgICBpZiAodGhpcy52KGkuTCgpLnUsIHQpIDwgMCkgewogICAgICAgICAgaS51ID0gdDsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY29uc3QgcyA9IGkuTCgpLnU7CiAgICAgIGlmICh0aGlzLnYocywgdCkgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgICBjb25zdCByID0gaS5CKCkudTsKICAgICAgaWYgKHRoaXMudihyLCB0KSA8PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgIGkudSA9IHQ7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlQb3MoZSkgewogICAgICBpZiAoZSA8IDAgfHwgZSA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCB0ID0gMDsKICAgICAgY29uc3QgaSA9IHRoaXM7CiAgICAgIHRoaXMub2UodGhpcy5ZLCBmdW5jdGlvbiAocykgewogICAgICAgIGlmIChlID09PSB0KSB7CiAgICAgICAgICBpLlYocyk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgdCArPSAxOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeUtleShlKSB7CiAgICAgIGlmICh0aGlzLmkgPT09IDApIHJldHVybiBmYWxzZTsKICAgICAgY29uc3QgdCA9IHRoaXMuSSh0aGlzLlksIGUpOwogICAgICBpZiAodCA9PT0gdGhpcy5oKSByZXR1cm4gZmFsc2U7CiAgICAgIHRoaXMuVih0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBlcmFzZUVsZW1lbnRCeUl0ZXJhdG9yKGUpIHsKICAgICAgY29uc3QgdCA9IGUubzsKICAgICAgaWYgKHQgPT09IHRoaXMuaCkgewogICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgIH0KICAgICAgY29uc3QgaSA9IHQuVyA9PT0gdW5kZWZpbmVkOwogICAgICBjb25zdCBzID0gZS5pdGVyYXRvclR5cGUgPT09IDA7CiAgICAgIGlmIChzKSB7CiAgICAgICAgaWYgKGkpIGUubmV4dCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghaSB8fCB0LlUgPT09IHVuZGVmaW5lZCkgZS5uZXh0KCk7CiAgICAgIH0KICAgICAgdGhpcy5WKHQpOwogICAgICByZXR1cm4gZTsKICAgIH0KICAgIGZvckVhY2goZSkgewogICAgICBsZXQgdCA9IDA7CiAgICAgIGZvciAoY29uc3QgaSBvZiB0aGlzKSBlKGksIHQrKywgdGhpcyk7CiAgICB9CiAgICBnZXRFbGVtZW50QnlQb3MoZSkgewogICAgICBpZiAoZSA8IDAgfHwgZSA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCB0OwogICAgICBsZXQgaSA9IDA7CiAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzKSB7CiAgICAgICAgaWYgKGkgPT09IGUpIHsKICAgICAgICAgIHQgPSBzOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGkgKz0gMTsKICAgICAgfQogICAgICByZXR1cm4gdDsKICAgIH0KICAgIGdldEhlaWdodCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuIDA7CiAgICAgIGNvbnN0IHRyYXZlcnNhbCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgaWYgKCFlKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gTWF0aC5tYXgodHJhdmVyc2FsKGUuVSksIHRyYXZlcnNhbChlLlcpKSArIDE7CiAgICAgIH07CiAgICAgIHJldHVybiB0cmF2ZXJzYWwodGhpcy5ZKTsKICAgIH0KICB9CiAgdmFyIF9kZWZhdWx0ID0gVHJlZUNvbnRhaW5lcjsKICBleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSkoQmFzZSQxKTsKCnZhciBUcmVlSXRlcmF0b3IgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKICB2YXIgX0NvbnRhaW5lckJhc2UgPSBDb250YWluZXJCYXNlOwogIHZhciBfdGhyb3dFcnJvciA9IHRocm93RXJyb3I7CiAgY2xhc3MgVHJlZUl0ZXJhdG9yIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQ29udGFpbmVySXRlcmF0b3IgewogICAgY29uc3RydWN0b3IodCwgciwgaSkgewogICAgICBzdXBlcihpKTsKICAgICAgdGhpcy5vID0gdDsKICAgICAgdGhpcy5oID0gcjsKICAgICAgaWYgKHRoaXMuaXRlcmF0b3JUeXBlID09PSAwKSB7CiAgICAgICAgdGhpcy5wcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSB0aGlzLmguVSkgewogICAgICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vID0gdGhpcy5vLkwoKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgdGhpcy5uZXh0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubyA9PT0gdGhpcy5oKSB7CiAgICAgICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm8gPSB0aGlzLm8uQigpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaC5XKSB7CiAgICAgICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm8gPSB0aGlzLm8uQigpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSB0aGlzLmgpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyA9IHRoaXMuby5MKCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgICBnZXQgaW5kZXgoKSB7CiAgICAgIGxldCB0ID0gdGhpcy5vOwogICAgICBjb25zdCByID0gdGhpcy5oLnR0OwogICAgICBpZiAodCA9PT0gdGhpcy5oKSB7CiAgICAgICAgaWYgKHIpIHsKICAgICAgICAgIHJldHVybiByLnJ0IC0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgbGV0IGkgPSAwOwogICAgICBpZiAodC5VKSB7CiAgICAgICAgaSArPSB0LlUucnQ7CiAgICAgIH0KICAgICAgd2hpbGUgKHQgIT09IHIpIHsKICAgICAgICBjb25zdCByID0gdC50dDsKICAgICAgICBpZiAodCA9PT0gci5XKSB7CiAgICAgICAgICBpICs9IDE7CiAgICAgICAgICBpZiAoci5VKSB7CiAgICAgICAgICAgIGkgKz0gci5VLnJ0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ID0gcjsKICAgICAgfQogICAgICByZXR1cm4gaTsKICAgIH0KICB9CiAgdmFyIF9kZWZhdWx0ID0gVHJlZUl0ZXJhdG9yOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShUcmVlSXRlcmF0b3IpOwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidCIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBfQmFzZSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoQmFzZSQxKTsKICB2YXIgX1RyZWVJdGVyYXRvciA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoVHJlZUl0ZXJhdG9yKTsKICB2YXIgX3Rocm93RXJyb3IgPSB0aHJvd0Vycm9yOwogIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoZSkgewogICAgcmV0dXJuIGUgJiYgZS50ID8gZSA6IHsKICAgICAgZGVmYXVsdDogZQogICAgfTsKICB9CiAgY2xhc3MgT3JkZXJlZFNldEl0ZXJhdG9yIGV4dGVuZHMgX1RyZWVJdGVyYXRvci5kZWZhdWx0IHsKICAgIGNvbnN0cnVjdG9yKGUsIHQsIHIsIGkpIHsKICAgICAgc3VwZXIoZSwgdCwgaSk7CiAgICAgIHRoaXMuY29udGFpbmVyID0gcjsKICAgIH0KICAgIGdldCBwb2ludGVyKCkgewogICAgICBpZiAodGhpcy5vID09PSB0aGlzLmgpIHsKICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLm8udTsKICAgIH0KICAgIGNvcHkoKSB7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZFNldEl0ZXJhdG9yKHRoaXMubywgdGhpcy5oLCB0aGlzLmNvbnRhaW5lciwgdGhpcy5pdGVyYXRvclR5cGUpOwogICAgfQogIH0KICBjbGFzcyBPcmRlcmVkU2V0IGV4dGVuZHMgX0Jhc2UuZGVmYXVsdCB7CiAgICBjb25zdHJ1Y3RvcihlID0gW10sIHQsIHIpIHsKICAgICAgc3VwZXIodCwgcik7CiAgICAgIGNvbnN0IGkgPSB0aGlzOwogICAgICBlLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBpLmluc2VydChlKTsKICAgICAgfSk7CiAgICB9CiAgICAqSyhlKSB7CiAgICAgIGlmIChlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgeWllbGQqIHRoaXMuSyhlLlUpOwogICAgICB5aWVsZCBlLnU7CiAgICAgIHlpZWxkKiB0aGlzLksoZS5XKTsKICAgIH0KICAgIGJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IE9yZGVyZWRTZXRJdGVyYXRvcih0aGlzLmguVSB8fCB0aGlzLmgsIHRoaXMuaCwgdGhpcyk7CiAgICB9CiAgICBlbmQoKSB7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZFNldEl0ZXJhdG9yKHRoaXMuaCwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIHJCZWdpbigpIHsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkU2V0SXRlcmF0b3IodGhpcy5oLlcgfHwgdGhpcy5oLCB0aGlzLmgsIHRoaXMsIDEpOwogICAgfQogICAgckVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkU2V0SXRlcmF0b3IodGhpcy5oLCB0aGlzLmgsIHRoaXMsIDEpOwogICAgfQogICAgZnJvbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLmguVSA/IHRoaXMuaC5VLnUgOiB1bmRlZmluZWQ7CiAgICB9CiAgICBiYWNrKCkgewogICAgICByZXR1cm4gdGhpcy5oLlcgPyB0aGlzLmguVy51IDogdW5kZWZpbmVkOwogICAgfQogICAgaW5zZXJ0KGUsIHQpIHsKICAgICAgcmV0dXJuIHRoaXMuTShlLCB1bmRlZmluZWQsIHQpOwogICAgfQogICAgZmluZChlKSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLkkodGhpcy5ZLCBlKTsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkU2V0SXRlcmF0b3IodCwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIGxvd2VyQm91bmQoZSkgewogICAgICBjb25zdCB0ID0gdGhpcy5YKHRoaXMuWSwgZSk7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZFNldEl0ZXJhdG9yKHQsIHRoaXMuaCwgdGhpcyk7CiAgICB9CiAgICB1cHBlckJvdW5kKGUpIHsKICAgICAgY29uc3QgdCA9IHRoaXMuWih0aGlzLlksIGUpOwogICAgICByZXR1cm4gbmV3IE9yZGVyZWRTZXRJdGVyYXRvcih0LCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgcmV2ZXJzZUxvd2VyQm91bmQoZSkgewogICAgICBjb25zdCB0ID0gdGhpcy4kKHRoaXMuWSwgZSk7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZFNldEl0ZXJhdG9yKHQsIHRoaXMuaCwgdGhpcyk7CiAgICB9CiAgICByZXZlcnNlVXBwZXJCb3VuZChlKSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLnJyKHRoaXMuWSwgZSk7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZFNldEl0ZXJhdG9yKHQsIHRoaXMuaCwgdGhpcyk7CiAgICB9CiAgICB1bmlvbihlKSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzOwogICAgICBlLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICB0Lmluc2VydChlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuSyh0aGlzLlkpOwogICAgfQogIH0KICB2YXIgX2RlZmF1bHQgPSBPcmRlcmVkU2V0OwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShPcmRlcmVkU2V0KTsKCnZhciBPcmRlcmVkTWFwID0ge307CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CiAgdmFyIF9CYXNlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChCYXNlJDEpOwogIHZhciBfVHJlZUl0ZXJhdG9yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChUcmVlSXRlcmF0b3IpOwogIHZhciBfdGhyb3dFcnJvciA9IHRocm93RXJyb3I7CiAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyKSB7CiAgICByZXR1cm4gciAmJiByLnQgPyByIDogewogICAgICBkZWZhdWx0OiByCiAgICB9OwogIH0KICBjbGFzcyBPcmRlcmVkTWFwSXRlcmF0b3IgZXh0ZW5kcyBfVHJlZUl0ZXJhdG9yLmRlZmF1bHQgewogICAgY29uc3RydWN0b3IociwgdCwgZSwgcykgewogICAgICBzdXBlcihyLCB0LCBzKTsKICAgICAgdGhpcy5jb250YWluZXIgPSBlOwogICAgfQogICAgZ2V0IHBvaW50ZXIoKSB7CiAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaCkgewogICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgIH0KICAgICAgY29uc3QgciA9IHRoaXM7CiAgICAgIHJldHVybiBuZXcgUHJveHkoW10sIHsKICAgICAgICBnZXQodCwgZSkgewogICAgICAgICAgaWYgKGUgPT09ICIwIikgcmV0dXJuIHIuby51O2Vsc2UgaWYgKGUgPT09ICIxIikgcmV0dXJuIHIuby5sOwogICAgICAgIH0sCiAgICAgICAgc2V0KHQsIGUsIHMpIHsKICAgICAgICAgIGlmIChlICE9PSAiMSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigicHJvcHMgbXVzdCBiZSAxIik7CiAgICAgICAgICB9CiAgICAgICAgICByLm8ubCA9IHM7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgY29weSgpIHsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkTWFwSXRlcmF0b3IodGhpcy5vLCB0aGlzLmgsIHRoaXMuY29udGFpbmVyLCB0aGlzLml0ZXJhdG9yVHlwZSk7CiAgICB9CiAgfQogIGNsYXNzIE9yZGVyZWRNYXAgZXh0ZW5kcyBfQmFzZS5kZWZhdWx0IHsKICAgIGNvbnN0cnVjdG9yKHIgPSBbXSwgdCwgZSkgewogICAgICBzdXBlcih0LCBlKTsKICAgICAgY29uc3QgcyA9IHRoaXM7CiAgICAgIHIuZm9yRWFjaChmdW5jdGlvbiAocikgewogICAgICAgIHMuc2V0RWxlbWVudChyWzBdLCByWzFdKTsKICAgICAgfSk7CiAgICB9CiAgICAqSyhyKSB7CiAgICAgIGlmIChyID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgeWllbGQqIHRoaXMuSyhyLlUpOwogICAgICB5aWVsZCBbci51LCByLmxdOwogICAgICB5aWVsZCogdGhpcy5LKHIuVyk7CiAgICB9CiAgICBiZWdpbigpIHsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkTWFwSXRlcmF0b3IodGhpcy5oLlUgfHwgdGhpcy5oLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgZW5kKCkgewogICAgICByZXR1cm4gbmV3IE9yZGVyZWRNYXBJdGVyYXRvcih0aGlzLmgsIHRoaXMuaCwgdGhpcyk7CiAgICB9CiAgICByQmVnaW4oKSB7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZE1hcEl0ZXJhdG9yKHRoaXMuaC5XIHx8IHRoaXMuaCwgdGhpcy5oLCB0aGlzLCAxKTsKICAgIH0KICAgIHJFbmQoKSB7CiAgICAgIHJldHVybiBuZXcgT3JkZXJlZE1hcEl0ZXJhdG9yKHRoaXMuaCwgdGhpcy5oLCB0aGlzLCAxKTsKICAgIH0KICAgIGZyb250KCkgewogICAgICBpZiAodGhpcy5pID09PSAwKSByZXR1cm47CiAgICAgIGNvbnN0IHIgPSB0aGlzLmguVTsKICAgICAgcmV0dXJuIFtyLnUsIHIubF07CiAgICB9CiAgICBiYWNrKCkgewogICAgICBpZiAodGhpcy5pID09PSAwKSByZXR1cm47CiAgICAgIGNvbnN0IHIgPSB0aGlzLmguVzsKICAgICAgcmV0dXJuIFtyLnUsIHIubF07CiAgICB9CiAgICBsb3dlckJvdW5kKHIpIHsKICAgICAgY29uc3QgdCA9IHRoaXMuWCh0aGlzLlksIHIpOwogICAgICByZXR1cm4gbmV3IE9yZGVyZWRNYXBJdGVyYXRvcih0LCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgdXBwZXJCb3VuZChyKSB7CiAgICAgIGNvbnN0IHQgPSB0aGlzLloodGhpcy5ZLCByKTsKICAgICAgcmV0dXJuIG5ldyBPcmRlcmVkTWFwSXRlcmF0b3IodCwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIHJldmVyc2VMb3dlckJvdW5kKHIpIHsKICAgICAgY29uc3QgdCA9IHRoaXMuJCh0aGlzLlksIHIpOwogICAgICByZXR1cm4gbmV3IE9yZGVyZWRNYXBJdGVyYXRvcih0LCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgcmV2ZXJzZVVwcGVyQm91bmQocikgewogICAgICBjb25zdCB0ID0gdGhpcy5ycih0aGlzLlksIHIpOwogICAgICByZXR1cm4gbmV3IE9yZGVyZWRNYXBJdGVyYXRvcih0LCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgc2V0RWxlbWVudChyLCB0LCBlKSB7CiAgICAgIHJldHVybiB0aGlzLk0ociwgdCwgZSk7CiAgICB9CiAgICBmaW5kKHIpIHsKICAgICAgY29uc3QgdCA9IHRoaXMuSSh0aGlzLlksIHIpOwogICAgICByZXR1cm4gbmV3IE9yZGVyZWRNYXBJdGVyYXRvcih0LCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgZ2V0RWxlbWVudEJ5S2V5KHIpIHsKICAgICAgY29uc3QgdCA9IHRoaXMuSSh0aGlzLlksIHIpOwogICAgICByZXR1cm4gdC5sOwogICAgfQogICAgdW5pb24ocikgewogICAgICBjb25zdCB0ID0gdGhpczsKICAgICAgci5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7CiAgICAgICAgdC5zZXRFbGVtZW50KHJbMF0sIHJbMV0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXMuaTsKICAgIH0KICAgIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgICByZXR1cm4gdGhpcy5LKHRoaXMuWSk7CiAgICB9CiAgfQogIHZhciBfZGVmYXVsdCA9IE9yZGVyZWRNYXA7CiAgZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0pKE9yZGVyZWRNYXApOwoKdmFyIEhhc2hTZXQgPSB7fTsKCnZhciBCYXNlID0ge307Cgp2YXIgY2hlY2tPYmplY3QgPSB7fTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuZGVmYXVsdCA9IGNoZWNrT2JqZWN0OwogIGZ1bmN0aW9uIGNoZWNrT2JqZWN0KGUpIHsKICAgIGNvbnN0IHQgPSB0eXBlb2YgZTsKICAgIHJldHVybiB0ID09PSAib2JqZWN0IiAmJiBlICE9PSBudWxsIHx8IHQgPT09ICJmdW5jdGlvbiI7CiAgfQp9KShjaGVja09iamVjdCk7CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLkhhc2hDb250YWluZXJJdGVyYXRvciA9IGV4cG9ydHMuSGFzaENvbnRhaW5lciA9IHZvaWQgMDsKICB2YXIgX0NvbnRhaW5lckJhc2UgPSBDb250YWluZXJCYXNlOwogIHZhciBfY2hlY2tPYmplY3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KGNoZWNrT2JqZWN0KTsKICB2YXIgX3Rocm93RXJyb3IgPSB0aHJvd0Vycm9yOwogIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQodCkgewogICAgcmV0dXJuIHQgJiYgdC50ID8gdCA6IHsKICAgICAgZGVmYXVsdDogdAogICAgfTsKICB9CiAgY2xhc3MgSGFzaENvbnRhaW5lckl0ZXJhdG9yIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQ29udGFpbmVySXRlcmF0b3IgewogICAgY29uc3RydWN0b3IodCwgZSwgaSkgewogICAgICBzdXBlcihpKTsKICAgICAgdGhpcy5vID0gdDsKICAgICAgdGhpcy5oID0gZTsKICAgICAgaWYgKHRoaXMuaXRlcmF0b3JUeXBlID09PSAwKSB7CiAgICAgICAgdGhpcy5wcmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vLkwgPT09IHRoaXMuaCkgewogICAgICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vID0gdGhpcy5vLkw7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHRoaXMubmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaCkgewogICAgICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vID0gdGhpcy5vLkI7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucHJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMuby5CID09PSB0aGlzLmgpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyA9IHRoaXMuby5COwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vID09PSB0aGlzLmgpIHsKICAgICAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMubyA9IHRoaXMuby5MOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0KICBleHBvcnRzLkhhc2hDb250YWluZXJJdGVyYXRvciA9IEhhc2hDb250YWluZXJJdGVyYXRvcjsKICBjbGFzcyBIYXNoQ29udGFpbmVyIGV4dGVuZHMgX0NvbnRhaW5lckJhc2UuQ29udGFpbmVyIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLkggPSBbXTsKICAgICAgdGhpcy5nID0ge307CiAgICAgIHRoaXMuSEFTSF9UQUcgPSBTeW1ib2woIkBASEFTSF9UQUciKTsKICAgICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMuZywgbnVsbCk7CiAgICAgIHRoaXMuaCA9IHt9OwogICAgICB0aGlzLmguTCA9IHRoaXMuaC5CID0gdGhpcy5wID0gdGhpcy5fID0gdGhpcy5oOwogICAgfQogICAgVih0KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBMOiBlLAogICAgICAgIEI6IGkKICAgICAgfSA9IHQ7CiAgICAgIGUuQiA9IGk7CiAgICAgIGkuTCA9IGU7CiAgICAgIGlmICh0ID09PSB0aGlzLnApIHsKICAgICAgICB0aGlzLnAgPSBpOwogICAgICB9CiAgICAgIGlmICh0ID09PSB0aGlzLl8pIHsKICAgICAgICB0aGlzLl8gPSBlOwogICAgICB9CiAgICAgIHRoaXMuaSAtPSAxOwogICAgfQogICAgTSh0LCBlLCBpKSB7CiAgICAgIGlmIChpID09PSB1bmRlZmluZWQpIGkgPSAoMCwgX2NoZWNrT2JqZWN0LmRlZmF1bHQpKHQpOwogICAgICBsZXQgczsKICAgICAgaWYgKGkpIHsKICAgICAgICBjb25zdCBpID0gdFt0aGlzLkhBU0hfVEFHXTsKICAgICAgICBpZiAoaSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLkhbaV0ubCA9IGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5pOwogICAgICAgIH0KICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodCwgdGhpcy5IQVNIX1RBRywgewogICAgICAgICAgdmFsdWU6IHRoaXMuSC5sZW5ndGgsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBzID0gewogICAgICAgICAgdTogdCwKICAgICAgICAgIGw6IGUsCiAgICAgICAgICBMOiB0aGlzLl8sCiAgICAgICAgICBCOiB0aGlzLmgKICAgICAgICB9OwogICAgICAgIHRoaXMuSC5wdXNoKHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGkgPSB0aGlzLmdbdF07CiAgICAgICAgaWYgKGkpIHsKICAgICAgICAgIGkubCA9IGU7CiAgICAgICAgICByZXR1cm4gdGhpcy5pOwogICAgICAgIH0KICAgICAgICBzID0gewogICAgICAgICAgdTogdCwKICAgICAgICAgIGw6IGUsCiAgICAgICAgICBMOiB0aGlzLl8sCiAgICAgICAgICBCOiB0aGlzLmgKICAgICAgICB9OwogICAgICAgIHRoaXMuZ1t0XSA9IHM7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgewogICAgICAgIHRoaXMucCA9IHM7CiAgICAgICAgdGhpcy5oLkIgPSBzOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuXy5CID0gczsKICAgICAgfQogICAgICB0aGlzLl8gPSBzOwogICAgICB0aGlzLmguTCA9IHM7CiAgICAgIHJldHVybiArK3RoaXMuaTsKICAgIH0KICAgIEkodCwgZSkgewogICAgICBpZiAoZSA9PT0gdW5kZWZpbmVkKSBlID0gKDAsIF9jaGVja09iamVjdC5kZWZhdWx0KSh0KTsKICAgICAgaWYgKGUpIHsKICAgICAgICBjb25zdCBlID0gdFt0aGlzLkhBU0hfVEFHXTsKICAgICAgICBpZiAoZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdGhpcy5oOwogICAgICAgIHJldHVybiB0aGlzLkhbZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ1t0XSB8fCB0aGlzLmg7CiAgICAgIH0KICAgIH0KICAgIGNsZWFyKCkgewogICAgICBjb25zdCB0ID0gdGhpcy5IQVNIX1RBRzsKICAgICAgdGhpcy5ILmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBkZWxldGUgZS51W3RdOwogICAgICB9KTsKICAgICAgdGhpcy5IID0gW107CiAgICAgIHRoaXMuZyA9IHt9OwogICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcy5nLCBudWxsKTsKICAgICAgdGhpcy5pID0gMDsKICAgICAgdGhpcy5wID0gdGhpcy5fID0gdGhpcy5oLkwgPSB0aGlzLmguQiA9IHRoaXMuaDsKICAgIH0KICAgIGVyYXNlRWxlbWVudEJ5S2V5KHQsIGUpIHsKICAgICAgbGV0IGk7CiAgICAgIGlmIChlID09PSB1bmRlZmluZWQpIGUgPSAoMCwgX2NoZWNrT2JqZWN0LmRlZmF1bHQpKHQpOwogICAgICBpZiAoZSkgewogICAgICAgIGNvbnN0IGUgPSB0W3RoaXMuSEFTSF9UQUddOwogICAgICAgIGlmIChlID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKICAgICAgICBkZWxldGUgdFt0aGlzLkhBU0hfVEFHXTsKICAgICAgICBpID0gdGhpcy5IW2VdOwogICAgICAgIGRlbGV0ZSB0aGlzLkhbZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IHRoaXMuZ1t0XTsKICAgICAgICBpZiAoaSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVsZXRlIHRoaXMuZ1t0XTsKICAgICAgfQogICAgICB0aGlzLlYoaSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlJdGVyYXRvcih0KSB7CiAgICAgIGNvbnN0IGUgPSB0Lm87CiAgICAgIGlmIChlID09PSB0aGlzLmgpIHsKICAgICAgICAoMCwgX3Rocm93RXJyb3IudGhyb3dJdGVyYXRvckFjY2Vzc0Vycm9yKSgpOwogICAgICB9CiAgICAgIHRoaXMuVihlKTsKICAgICAgcmV0dXJuIHQubmV4dCgpOwogICAgfQogICAgZXJhc2VFbGVtZW50QnlQb3ModCkgewogICAgICBpZiAodCA8IDAgfHwgdCA+IHRoaXMuaSAtIDEpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigpOwogICAgICB9CiAgICAgIGxldCBlID0gdGhpcy5wOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgZSA9IGUuQjsKICAgICAgfQogICAgICB0aGlzLlYoZSk7CiAgICAgIHJldHVybiB0aGlzLmk7CiAgICB9CiAgfQogIGV4cG9ydHMuSGFzaENvbnRhaW5lciA9IEhhc2hDb250YWluZXI7Cn0pKEJhc2UpOwoKKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidCIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwogIHZhciBfQmFzZSA9IEJhc2U7CiAgdmFyIF90aHJvd0Vycm9yID0gdGhyb3dFcnJvcjsKICBjbGFzcyBIYXNoU2V0SXRlcmF0b3IgZXh0ZW5kcyBfQmFzZS5IYXNoQ29udGFpbmVySXRlcmF0b3IgewogICAgY29uc3RydWN0b3IodCwgZSwgciwgcykgewogICAgICBzdXBlcih0LCBlLCBzKTsKICAgICAgdGhpcy5jb250YWluZXIgPSByOwogICAgfQogICAgZ2V0IHBvaW50ZXIoKSB7CiAgICAgIGlmICh0aGlzLm8gPT09IHRoaXMuaCkgewogICAgICAgICgwLCBfdGhyb3dFcnJvci50aHJvd0l0ZXJhdG9yQWNjZXNzRXJyb3IpKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuby51OwogICAgfQogICAgY29weSgpIHsKICAgICAgcmV0dXJuIG5ldyBIYXNoU2V0SXRlcmF0b3IodGhpcy5vLCB0aGlzLmgsIHRoaXMuY29udGFpbmVyLCB0aGlzLml0ZXJhdG9yVHlwZSk7CiAgICB9CiAgfQogIGNsYXNzIEhhc2hTZXQgZXh0ZW5kcyBfQmFzZS5IYXNoQ29udGFpbmVyIHsKICAgIGNvbnN0cnVjdG9yKHQgPSBbXSkgewogICAgICBzdXBlcigpOwogICAgICBjb25zdCBlID0gdGhpczsKICAgICAgdC5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgZS5pbnNlcnQodCk7CiAgICAgIH0pOwogICAgfQogICAgYmVnaW4oKSB7CiAgICAgIHJldHVybiBuZXcgSGFzaFNldEl0ZXJhdG9yKHRoaXMucCwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBIYXNoU2V0SXRlcmF0b3IodGhpcy5oLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgckJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IEhhc2hTZXRJdGVyYXRvcih0aGlzLl8sIHRoaXMuaCwgdGhpcywgMSk7CiAgICB9CiAgICByRW5kKCkgewogICAgICByZXR1cm4gbmV3IEhhc2hTZXRJdGVyYXRvcih0aGlzLmgsIHRoaXMuaCwgdGhpcywgMSk7CiAgICB9CiAgICBmcm9udCgpIHsKICAgICAgcmV0dXJuIHRoaXMucC51OwogICAgfQogICAgYmFjaygpIHsKICAgICAgcmV0dXJuIHRoaXMuXy51OwogICAgfQogICAgaW5zZXJ0KHQsIGUpIHsKICAgICAgcmV0dXJuIHRoaXMuTSh0LCB1bmRlZmluZWQsIGUpOwogICAgfQogICAgZ2V0RWxlbWVudEJ5UG9zKHQpIHsKICAgICAgaWYgKHQgPCAwIHx8IHQgPiB0aGlzLmkgLSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoKTsKICAgICAgfQogICAgICBsZXQgZSA9IHRoaXMucDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIGUgPSBlLkI7CiAgICAgIH0KICAgICAgcmV0dXJuIGUudTsKICAgIH0KICAgIGZpbmQodCwgZSkgewogICAgICBjb25zdCByID0gdGhpcy5JKHQsIGUpOwogICAgICByZXR1cm4gbmV3IEhhc2hTZXRJdGVyYXRvcihyLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgZm9yRWFjaCh0KSB7CiAgICAgIGxldCBlID0gMDsKICAgICAgbGV0IHIgPSB0aGlzLnA7CiAgICAgIHdoaWxlIChyICE9PSB0aGlzLmgpIHsKICAgICAgICB0KHIudSwgZSsrLCB0aGlzKTsKICAgICAgICByID0gci5COwogICAgICB9CiAgICB9CiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgbGV0IHQgPSB0aGlzLnA7CiAgICAgICAgd2hpbGUgKHQgIT09IHRoaXMuaCkgewogICAgICAgICAgeWllbGQgdC51OwogICAgICAgICAgdCA9IHQuQjsKICAgICAgICB9CiAgICAgIH0uYmluZCh0aGlzKSgpOwogICAgfQogIH0KICB2YXIgX2RlZmF1bHQgPSBIYXNoU2V0OwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShIYXNoU2V0KTsKCnZhciBIYXNoTWFwID0ge307CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ0IiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CiAgdmFyIF9CYXNlID0gQmFzZTsKICB2YXIgX2NoZWNrT2JqZWN0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChjaGVja09iamVjdCk7CiAgdmFyIF90aHJvd0Vycm9yID0gdGhyb3dFcnJvcjsKICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHQpIHsKICAgIHJldHVybiB0ICYmIHQudCA/IHQgOiB7CiAgICAgIGRlZmF1bHQ6IHQKICAgIH07CiAgfQogIGNsYXNzIEhhc2hNYXBJdGVyYXRvciBleHRlbmRzIF9CYXNlLkhhc2hDb250YWluZXJJdGVyYXRvciB7CiAgICBjb25zdHJ1Y3Rvcih0LCBlLCByLCBzKSB7CiAgICAgIHN1cGVyKHQsIGUsIHMpOwogICAgICB0aGlzLmNvbnRhaW5lciA9IHI7CiAgICB9CiAgICBnZXQgcG9pbnRlcigpIHsKICAgICAgaWYgKHRoaXMubyA9PT0gdGhpcy5oKSB7CiAgICAgICAgKDAsIF90aHJvd0Vycm9yLnRocm93SXRlcmF0b3JBY2Nlc3NFcnJvcikoKTsKICAgICAgfQogICAgICBjb25zdCB0ID0gdGhpczsKICAgICAgcmV0dXJuIG5ldyBQcm94eShbXSwgewogICAgICAgIGdldChlLCByKSB7CiAgICAgICAgICBpZiAociA9PT0gIjAiKSByZXR1cm4gdC5vLnU7ZWxzZSBpZiAociA9PT0gIjEiKSByZXR1cm4gdC5vLmw7CiAgICAgICAgfSwKICAgICAgICBzZXQoZSwgciwgcykgewogICAgICAgICAgaWYgKHIgIT09ICIxIikgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJwcm9wcyBtdXN0IGJlIDEiKTsKICAgICAgICAgIH0KICAgICAgICAgIHQuby5sID0gczsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBjb3B5KCkgewogICAgICByZXR1cm4gbmV3IEhhc2hNYXBJdGVyYXRvcih0aGlzLm8sIHRoaXMuaCwgdGhpcy5jb250YWluZXIsIHRoaXMuaXRlcmF0b3JUeXBlKTsKICAgIH0KICB9CiAgY2xhc3MgSGFzaE1hcCBleHRlbmRzIF9CYXNlLkhhc2hDb250YWluZXIgewogICAgY29uc3RydWN0b3IodCA9IFtdKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIGNvbnN0IGUgPSB0aGlzOwogICAgICB0LmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgICBlLnNldEVsZW1lbnQodFswXSwgdFsxXSk7CiAgICAgIH0pOwogICAgfQogICAgYmVnaW4oKSB7CiAgICAgIHJldHVybiBuZXcgSGFzaE1hcEl0ZXJhdG9yKHRoaXMucCwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIGVuZCgpIHsKICAgICAgcmV0dXJuIG5ldyBIYXNoTWFwSXRlcmF0b3IodGhpcy5oLCB0aGlzLmgsIHRoaXMpOwogICAgfQogICAgckJlZ2luKCkgewogICAgICByZXR1cm4gbmV3IEhhc2hNYXBJdGVyYXRvcih0aGlzLl8sIHRoaXMuaCwgdGhpcywgMSk7CiAgICB9CiAgICByRW5kKCkgewogICAgICByZXR1cm4gbmV3IEhhc2hNYXBJdGVyYXRvcih0aGlzLmgsIHRoaXMuaCwgdGhpcywgMSk7CiAgICB9CiAgICBmcm9udCgpIHsKICAgICAgaWYgKHRoaXMuaSA9PT0gMCkgcmV0dXJuOwogICAgICByZXR1cm4gW3RoaXMucC51LCB0aGlzLnAubF07CiAgICB9CiAgICBiYWNrKCkgewogICAgICBpZiAodGhpcy5pID09PSAwKSByZXR1cm47CiAgICAgIHJldHVybiBbdGhpcy5fLnUsIHRoaXMuXy5sXTsKICAgIH0KICAgIHNldEVsZW1lbnQodCwgZSwgcikgewogICAgICByZXR1cm4gdGhpcy5NKHQsIGUsIHIpOwogICAgfQogICAgZ2V0RWxlbWVudEJ5S2V5KHQsIGUpIHsKICAgICAgaWYgKGUgPT09IHVuZGVmaW5lZCkgZSA9ICgwLCBfY2hlY2tPYmplY3QuZGVmYXVsdCkodCk7CiAgICAgIGlmIChlKSB7CiAgICAgICAgY29uc3QgZSA9IHRbdGhpcy5IQVNIX1RBR107CiAgICAgICAgcmV0dXJuIGUgIT09IHVuZGVmaW5lZCA/IHRoaXMuSFtlXS5sIDogdW5kZWZpbmVkOwogICAgICB9CiAgICAgIGNvbnN0IHIgPSB0aGlzLmdbdF07CiAgICAgIHJldHVybiByID8gci5sIDogdW5kZWZpbmVkOwogICAgfQogICAgZ2V0RWxlbWVudEJ5UG9zKHQpIHsKICAgICAgaWYgKHQgPCAwIHx8IHQgPiB0aGlzLmkgLSAxKSB7CiAgICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoKTsKICAgICAgfQogICAgICBsZXQgZSA9IHRoaXMucDsKICAgICAgd2hpbGUgKHQtLSkgewogICAgICAgIGUgPSBlLkI7CiAgICAgIH0KICAgICAgcmV0dXJuIFtlLnUsIGUubF07CiAgICB9CiAgICBmaW5kKHQsIGUpIHsKICAgICAgY29uc3QgciA9IHRoaXMuSSh0LCBlKTsKICAgICAgcmV0dXJuIG5ldyBIYXNoTWFwSXRlcmF0b3IociwgdGhpcy5oLCB0aGlzKTsKICAgIH0KICAgIGZvckVhY2godCkgewogICAgICBsZXQgZSA9IDA7CiAgICAgIGxldCByID0gdGhpcy5wOwogICAgICB3aGlsZSAociAhPT0gdGhpcy5oKSB7CiAgICAgICAgdChbci51LCByLmxdLCBlKyssIHRoaXMpOwogICAgICAgIHIgPSByLkI7CiAgICAgIH0KICAgIH0KICAgIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgICByZXR1cm4gZnVuY3Rpb24qICgpIHsKICAgICAgICBsZXQgdCA9IHRoaXMucDsKICAgICAgICB3aGlsZSAodCAhPT0gdGhpcy5oKSB7CiAgICAgICAgICB5aWVsZCBbdC51LCB0LmxdOwogICAgICAgICAgdCA9IHQuQjsKICAgICAgICB9CiAgICAgIH0uYmluZCh0aGlzKSgpOwogICAgfQogIH0KICB2YXIgX2RlZmF1bHQgPSBIYXNoTWFwOwogIGV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9KShIYXNoTWFwKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInQiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiRGVxdWUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfRGVxdWUuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIkhhc2hNYXAiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfSGFzaE1hcC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiSGFzaFNldCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9IYXNoU2V0LmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJMaW5rTGlzdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9MaW5rTGlzdC5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiT3JkZXJlZE1hcCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIF9PcmRlcmVkTWFwLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJPcmRlcmVkU2V0IiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX09yZGVyZWRTZXQuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIlByaW9yaXR5UXVldWUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfUHJpb3JpdHlRdWV1ZS5kZWZhdWx0OwogICAgfQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiUXVldWUiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfUXVldWUuZGVmYXVsdDsKICAgIH0KICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIlN0YWNrIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gX1N0YWNrLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJWZWN0b3IiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBfVmVjdG9yLmRlZmF1bHQ7CiAgICB9CiAgfSk7CiAgdmFyIF9TdGFjayA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoU3RhY2spOwogIHZhciBfUXVldWUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KFF1ZXVlKTsKICB2YXIgX1ByaW9yaXR5UXVldWUgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KFByaW9yaXR5UXVldWUpOwogIHZhciBfVmVjdG9yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChWZWN0b3IpOwogIHZhciBfTGlua0xpc3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KExpbmtMaXN0KTsKICB2YXIgX0RlcXVlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChEZXF1ZSk7CiAgdmFyIF9PcmRlcmVkU2V0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChPcmRlcmVkU2V0KTsKICB2YXIgX09yZGVyZWRNYXAgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KE9yZGVyZWRNYXApOwogIHZhciBfSGFzaFNldCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoSGFzaFNldCk7CiAgdmFyIF9IYXNoTWFwID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChIYXNoTWFwKTsKICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KGUpIHsKICAgIHJldHVybiBlICYmIGUudCA/IGUgOiB7CiAgICAgIGRlZmF1bHQ6IGUKICAgIH07CiAgfQp9KShjanMpOwoKY29uc3QgU29ydGVkU2V0ID0gY2pzLk9yZGVyZWRTZXQ7CmNvbnN0IGRlYnVnVHJhY2UgPSBzcmNFeHBvcnRzKCdudW1iZXItYWxsb2NhdG9yOnRyYWNlJyk7CmNvbnN0IGRlYnVnRXJyb3IgPSBzcmNFeHBvcnRzKCdudW1iZXItYWxsb2NhdG9yOmVycm9yJyk7Ci8qKgogKiBJbnRlcnZhbCBjb25zdHJ1Y3RvcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtOdW1iZXJ9IGxvdyAgLSBUaGUgbG93ZXN0IHZhbHVlIG9mIHRoZSBpbnRlcnZhbAogKiBAcGFyYW0ge051bWJlcn0gaGlnaCAtIFRoZSBoaWdoZXN0IHZhbHVlIG9mIHRoZSBpbnRlcnZhbAogKi8KZnVuY3Rpb24gSW50ZXJ2YWwobG93LCBoaWdoKSB7CiAgdGhpcy5sb3cgPSBsb3c7CiAgdGhpcy5oaWdoID0gaGlnaDsKfQpJbnRlcnZhbC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24gKG90aGVyKSB7CiAgcmV0dXJuIHRoaXMubG93ID09PSBvdGhlci5sb3cgJiYgdGhpcy5oaWdoID09PSBvdGhlci5oaWdoOwp9OwpJbnRlcnZhbC5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uIChvdGhlcikgewogIGlmICh0aGlzLmxvdyA8IG90aGVyLmxvdyAmJiB0aGlzLmhpZ2ggPCBvdGhlci5sb3cpIHJldHVybiAtMTsKICBpZiAob3RoZXIubG93IDwgdGhpcy5sb3cgJiYgb3RoZXIuaGlnaCA8IHRoaXMubG93KSByZXR1cm4gMTsKICByZXR1cm4gMDsKfTsKCi8qKgogKiBOdW1iZXJBbGxvY2F0b3IgY29uc3RydWN0b3IuCiAqIFRoZSBhbGwgbnVtYmVycyBhcmUgc2V0IHRvIHZhY2FudCBzdGF0dXMuCiAqIFRpbWUgQ29tcGxleGl0eSBPKDEpCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge051bWJlcn0gbWluICAtIFRoZSBtYXhpbXVtIG51bWJlciBvZiBhbGxvY2F0YWJsZS4gVGhlIG51bWJlciBtdXN0IGJlIGludGVnZXIuCiAqIEBwYXJhbSB7TnVtYmVyfSBtYXhoIC0gVGhlIG1pbmltdW0gbnVtYmVyIG9mIGFsbG9jYXRhYmxlLiBUaGUgbnVtYmVyIG11c3QgYmUgaW50ZWdlci4KICovCmZ1bmN0aW9uIE51bWJlckFsbG9jYXRvciQxKG1pbiwgbWF4KSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIE51bWJlckFsbG9jYXRvciQxKSkgewogICAgcmV0dXJuIG5ldyBOdW1iZXJBbGxvY2F0b3IkMShtaW4sIG1heCk7CiAgfQogIHRoaXMubWluID0gbWluOwogIHRoaXMubWF4ID0gbWF4OwogIHRoaXMuc3MgPSBuZXcgU29ydGVkU2V0KFtdLCAobGhzLCByaHMpID0+IHsKICAgIHJldHVybiBsaHMuY29tcGFyZShyaHMpOwogIH0pOwogIGRlYnVnVHJhY2UoJ0NyZWF0ZScpOwogIHRoaXMuY2xlYXIoKTsKfQoKLyoqCiAqIEdldCB0aGUgZmlyc3QgdmFjYW50IG51bWJlci4gVGhlIHN0YXR1cyBvZiB0aGUgbnVtYmVyIGlzIG5vdCB1cGRhdGVkLgogKiBUaW1lIENvbXBsZXhpdHkgTygxKQogKiBAcmV0dXJuIHtOdW1iZXJ9IC0gVGhlIGZpcnN0IHZhY2FudCBudW1iZXIuIElmIGFsbCBudW1iZXJzIGFyZSBvY2N1cGllZCwgcmV0dXJuIG51bGwuCiAqICAgICAgICAgICAgICAgICAgICBXaGVuIGFsbG9jKCkgaXMgY2FsbGVkIHRoZW4gdGhlIHNhbWUgdmFsdWUgd2lsbCBiZSBhbGxvY2F0ZWQuCiAqLwpOdW1iZXJBbGxvY2F0b3IkMS5wcm90b3R5cGUuZmlyc3RWYWNhbnQgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuc3Muc2l6ZSgpID09PSAwKSByZXR1cm4gbnVsbDsKICByZXR1cm4gdGhpcy5zcy5mcm9udCgpLmxvdzsKfTsKCi8qKgogKiBBbGxvY2F0ZSB0aGUgZmlyc3QgdmFjYW50IG51bWJlci4gVGhlIG51bWJlciBiZWNvbWUgb2NjdXBpZWQgc3RhdHVzLgogKiBUaW1lIENvbXBsZXhpdHkgTygxKQogKiBAcmV0dXJuIHtOdW1iZXJ9IC0gVGhlIGZpcnN0IHZhY2FudCBudW1iZXIuIElmIGFsbCBudW1iZXJzIGFyZSBvY2N1cGllZCwgcmV0dXJuIG51bGwuCiAqLwpOdW1iZXJBbGxvY2F0b3IkMS5wcm90b3R5cGUuYWxsb2MgPSBmdW5jdGlvbiAoKSB7CiAgaWYgKHRoaXMuc3Muc2l6ZSgpID09PSAwKSB7CiAgICBkZWJ1Z1RyYWNlKCdhbGxvYygpOmVtcHR5Jyk7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgY29uc3QgaXQgPSB0aGlzLnNzLmJlZ2luKCk7CiAgY29uc3QgbG93ID0gaXQucG9pbnRlci5sb3c7CiAgY29uc3QgaGlnaCA9IGl0LnBvaW50ZXIuaGlnaDsKICBjb25zdCBudW0gPSBsb3c7CiAgaWYgKG51bSArIDEgPD0gaGlnaCkgewogICAgLy8geHwtLS0tfAogICAgdGhpcy5zcy51cGRhdGVLZXlCeUl0ZXJhdG9yKGl0LCBuZXcgSW50ZXJ2YWwobG93ICsgMSwgaGlnaCkpOwogIH0gZWxzZSB7CiAgICB0aGlzLnNzLmVyYXNlRWxlbWVudEJ5UG9zKDApOwogIH0KICBkZWJ1Z1RyYWNlKCdhbGxvYygpOicgKyBudW0pOwogIHJldHVybiBudW07Cn07CgovKioKICogVXNlIHRoZSBudW1iZXIuIFRoZSBudW1iZXIgYmVjb21lIG9jY3VwaWVkIHN0YXR1cy4KICogSWYgdGhlIG51bWJlciBoYXMgYWxyZWFkeSBiZWVuIG9jY3VwaWVkLCB0aGVuIHJldHVybiBmYWxzZS4KICogVGltZSBDb21wbGV4aXR5IE8obG9nTikgOiBOIGlzIHRoZSBudW1iZXIgb2YgaW50ZXJ2YWxzIChub3QgbnVtYmVycykKICogQHBhcmFtIHtOdW1iZXJ9IG51bSAtIFRoZSBudW1iZXIgdG8gcmVxdWVzdCB1c2UuCiAqIEByZXR1cm4ge0Jvb2xlYW59IC0gSWYgYG51bWAgd2FzIG5vdCBvY2N1cGllZCwgdGhlbiByZXR1cm4gdHJ1ZSwgb3RoZXJ3aXNlIHJldHVybiBmYWxzZS4KICovCk51bWJlckFsbG9jYXRvciQxLnByb3RvdHlwZS51c2UgPSBmdW5jdGlvbiAobnVtKSB7CiAgY29uc3Qga2V5ID0gbmV3IEludGVydmFsKG51bSwgbnVtKTsKICBjb25zdCBpdCA9IHRoaXMuc3MubG93ZXJCb3VuZChrZXkpOwogIGlmICghaXQuZXF1YWxzKHRoaXMuc3MuZW5kKCkpKSB7CiAgICBjb25zdCBsb3cgPSBpdC5wb2ludGVyLmxvdzsKICAgIGNvbnN0IGhpZ2ggPSBpdC5wb2ludGVyLmhpZ2g7CiAgICBpZiAoaXQucG9pbnRlci5lcXVhbHMoa2V5KSkgewogICAgICAvLyB8eHwKICAgICAgdGhpcy5zcy5lcmFzZUVsZW1lbnRCeUl0ZXJhdG9yKGl0KTsKICAgICAgZGVidWdUcmFjZSgndXNlKCk6JyArIG51bSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIHggfC0tLS0tfAogICAgaWYgKGxvdyA+IG51bSkgcmV0dXJuIGZhbHNlOwoKICAgIC8vIHx4LS0tLXwKICAgIGlmIChsb3cgPT09IG51bSkgewogICAgICAvLyB4fC0tLS18CiAgICAgIHRoaXMuc3MudXBkYXRlS2V5QnlJdGVyYXRvcihpdCwgbmV3IEludGVydmFsKGxvdyArIDEsIGhpZ2gpKTsKICAgICAgZGVidWdUcmFjZSgndXNlKCk6JyArIG51bSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIHwtLS0teHwKICAgIGlmIChoaWdoID09PSBudW0pIHsKICAgICAgLy8gfC0tLS18eAogICAgICB0aGlzLnNzLnVwZGF0ZUtleUJ5SXRlcmF0b3IoaXQsIG5ldyBJbnRlcnZhbChsb3csIGhpZ2ggLSAxKSk7CiAgICAgIGRlYnVnVHJhY2UoJ3VzZSgpOicgKyBudW0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLyB8LS14LS18CiAgICAvLyB4fC0tfAogICAgdGhpcy5zcy51cGRhdGVLZXlCeUl0ZXJhdG9yKGl0LCBuZXcgSW50ZXJ2YWwobnVtICsgMSwgaGlnaCkpOwogICAgLy8gfC0tfHh8LS18CiAgICB0aGlzLnNzLmluc2VydChuZXcgSW50ZXJ2YWwobG93LCBudW0gLSAxKSk7CiAgICBkZWJ1Z1RyYWNlKCd1c2UoKTonICsgbnVtKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBkZWJ1Z1RyYWNlKCd1c2UoKTpmYWlsZWQnKTsKICByZXR1cm4gZmFsc2U7Cn07CgovKioKICogRGVhbGxvY2F0ZSB0aGUgbnVtYmVyLiBUaGUgbnVtYmVyIGJlY29tZSB2YWNhbnQgc3RhdHVzLgogKiBUaW1lIENvbXBsZXhpdHkgTyhsb2dOKSA6IE4gaXMgdGhlIG51bWJlciBvZiBpbnRlcnZhbHMgKG5vdCBudW1iZXJzKQogKiBAcGFyYW0ge051bWJlcn0gbnVtIC0gVGhlIG51bWJlciB0byBkZWFsbG9jYXRlLiBUaGUgbnVtYmVyIG11c3QgYmUgb2NjdXBpZWQgc3RhdHVzLgogKiAgICAgICAgICAgICAgICAgICAgICAgSW4gb3RoZXIgd29yZHMsIHRoZSBudW1iZXIgbXVzdCBiZSBhbGxvY2F0ZWQgYnkgYWxsb2MoKSBvciBvY2N1cGllZCBiZSB1c2UoKS4KICovCk51bWJlckFsbG9jYXRvciQxLnByb3RvdHlwZS5mcmVlID0gZnVuY3Rpb24gKG51bSkgewogIGlmIChudW0gPCB0aGlzLm1pbiB8fCBudW0gPiB0aGlzLm1heCkgewogICAgZGVidWdFcnJvcignZnJlZSgpOicgKyBudW0gKyAnIGlzIG91dCBvZiByYW5nZScpOwogICAgcmV0dXJuOwogIH0KICBjb25zdCBrZXkgPSBuZXcgSW50ZXJ2YWwobnVtLCBudW0pOwogIGNvbnN0IGl0ID0gdGhpcy5zcy51cHBlckJvdW5kKGtleSk7CiAgaWYgKGl0LmVxdWFscyh0aGlzLnNzLmVuZCgpKSkgewogICAgLy8gLi4uLnYKICAgIGlmIChpdC5lcXVhbHModGhpcy5zcy5iZWdpbigpKSkgewogICAgICAvLyBJbnNlcnQgbmV3IGludGVydmFsCiAgICAgIHRoaXMuc3MuaW5zZXJ0KGtleSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGl0LnByZSgpOwogICAgY29uc3QgbG93ID0gaXQucG9pbnRlci5oaWdoOwogICAgY29uc3QgaGlnaCA9IGl0LnBvaW50ZXIuaGlnaDsKICAgIGlmIChoaWdoICsgMSA9PT0gbnVtKSB7CiAgICAgIC8vIENvbmNhdCB0byBsZWZ0CiAgICAgIHRoaXMuc3MudXBkYXRlS2V5QnlJdGVyYXRvcihpdCwgbmV3IEludGVydmFsKGxvdywgbnVtKSk7CiAgICB9IGVsc2UgewogICAgICAvLyBJbnNlcnQgbmV3IGludGVydmFsCiAgICAgIHRoaXMuc3MuaW5zZXJ0KGtleSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChpdC5lcXVhbHModGhpcy5zcy5iZWdpbigpKSkgewogICAgICAvLyB2Li4uLgogICAgICBpZiAobnVtICsgMSA9PT0gaXQucG9pbnRlci5sb3cpIHsKICAgICAgICAvLyBDb25jYXQgdG8gcmlnaHQKICAgICAgICBjb25zdCBoaWdoID0gaXQucG9pbnRlci5oaWdoOwogICAgICAgIHRoaXMuc3MudXBkYXRlS2V5QnlJdGVyYXRvcihpdCwgbmV3IEludGVydmFsKG51bSwgaGlnaCkpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEluc2VydCBuZXcgaW50ZXJ2YWwKICAgICAgICB0aGlzLnNzLmluc2VydChrZXkpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyAuLnYuLgogICAgICBjb25zdCByTG93ID0gaXQucG9pbnRlci5sb3c7CiAgICAgIGNvbnN0IHJIaWdoID0gaXQucG9pbnRlci5oaWdoOwogICAgICBpdC5wcmUoKTsKICAgICAgY29uc3QgbExvdyA9IGl0LnBvaW50ZXIubG93OwogICAgICBjb25zdCBsSGlnaCA9IGl0LnBvaW50ZXIuaGlnaDsKICAgICAgaWYgKGxIaWdoICsgMSA9PT0gbnVtKSB7CiAgICAgICAgaWYgKG51bSArIDEgPT09IHJMb3cpIHsKICAgICAgICAgIC8vIENvbmNhdCB0byBsZWZ0IGFuZCByaWdodAogICAgICAgICAgdGhpcy5zcy5lcmFzZUVsZW1lbnRCeUl0ZXJhdG9yKGl0KTsKICAgICAgICAgIHRoaXMuc3MudXBkYXRlS2V5QnlJdGVyYXRvcihpdCwgbmV3IEludGVydmFsKGxMb3csIHJIaWdoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIENvbmNhdCB0byBsZWZ0CiAgICAgICAgICB0aGlzLnNzLnVwZGF0ZUtleUJ5SXRlcmF0b3IoaXQsIG5ldyBJbnRlcnZhbChsTG93LCBudW0pKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG51bSArIDEgPT09IHJMb3cpIHsKICAgICAgICAgIC8vIENvbmNhdCB0byByaWdodAogICAgICAgICAgdGhpcy5zcy5lcmFzZUVsZW1lbnRCeUl0ZXJhdG9yKGl0Lm5leHQoKSk7CiAgICAgICAgICB0aGlzLnNzLmluc2VydChuZXcgSW50ZXJ2YWwobnVtLCBySGlnaCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJbnNlcnQgbmV3IGludGVydmFsCiAgICAgICAgICB0aGlzLnNzLmluc2VydChrZXkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBkZWJ1Z1RyYWNlKCdmcmVlKCk6JyArIG51bSk7Cn07CgovKioKICogQ2xlYXIgYWxsIG9jY3VwaWVkIG51bWJlcnMuCiAqIFRoZSBhbGwgbnVtYmVycyBhcmUgc2V0IHRvIHZhY2FudCBzdGF0dXMuCiAqIFRpbWUgQ29tcGxleGl0eSBPKDEpCiAqLwpOdW1iZXJBbGxvY2F0b3IkMS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoKSB7CiAgZGVidWdUcmFjZSgnY2xlYXIoKScpOwogIHRoaXMuc3MuY2xlYXIoKTsKICB0aGlzLnNzLmluc2VydChuZXcgSW50ZXJ2YWwodGhpcy5taW4sIHRoaXMubWF4KSk7Cn07CgovKioKICogR2V0IHRoZSBudW1iZXIgb2YgaW50ZXJ2YWxzLiBJbnRlcnZhbCBpcyBpbnRlcm5hbCBzdHJ1Y3R1cmUgb2YgdGhpcyBsaWJyYXJ5LgogKiBUaGlzIGZ1bmN0aW9uIGlzIGZvciBkZWJ1Z2dpbmcuCiAqIFRpbWUgQ29tcGxleGl0eSBPKDEpCiAqIEByZXR1cm4ge051bWJlcn0gLSBUaGUgbnVtYmVyIG9mIGludGVydmFscy4KICovCk51bWJlckFsbG9jYXRvciQxLnByb3RvdHlwZS5pbnRlcnZhbENvdW50ID0gZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzLnNzLnNpemUoKTsKfTsKCi8qKgogKiBEdW1wIHRoZSBpbnRlcm5hbCBzdHJ1Y3RvciBvZiB0aGUgbGlicmFyeS4KICogVGhpcyBmdW5jdGlvbiBpcyBmb3IgZGVidWdnaW5nLgogKiBUaW1lIENvbXBsZXhpdHkgTyhOKSA6IE4gaXMgdGhlIG51bWJlciBvZiBpbnRlcnZhbHMgKG5vdCBudW1iZXJzKQogKi8KTnVtYmVyQWxsb2NhdG9yJDEucHJvdG90eXBlLmR1bXAgPSBmdW5jdGlvbiAoKSB7CiAgY29uc29sZS5sb2coJ2xlbmd0aDonICsgdGhpcy5zcy5zaXplKCkpOwogIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLnNzKSB7CiAgICBjb25zb2xlLmxvZyhlbGVtZW50KTsKICB9Cn07CnZhciBudW1iZXJBbGxvY2F0b3IgPSBOdW1iZXJBbGxvY2F0b3IkMTsKCi8vIENvcHlyaWdodCBUYWthdG9zaGkgS29uZG8gMjAyMQovLwovLyBEaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UKCmNvbnN0IE51bWJlckFsbG9jYXRvciA9IG51bWJlckFsbG9jYXRvcjsKbnVtYmVyQWxsb2NhdG9yJDEuTnVtYmVyQWxsb2NhdG9yID0gTnVtYmVyQWxsb2NhdG9yOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KHRvcGljQWxpYXNTZW5kLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY29uc3QgbHJ1X2NhY2hlXzEgPSBjb21tb25qczsKY29uc3QgbnVtYmVyX2FsbG9jYXRvcl8xJDEgPSBudW1iZXJBbGxvY2F0b3IkMTsKY2xhc3MgVG9waWNBbGlhc1NlbmQgewogIGNvbnN0cnVjdG9yKG1heCkgewogICAgaWYgKG1heCA+IDApIHsKICAgICAgdGhpcy5hbGlhc1RvVG9waWMgPSBuZXcgbHJ1X2NhY2hlXzEuTFJVQ2FjaGUoewogICAgICAgIG1heAogICAgICB9KTsKICAgICAgdGhpcy50b3BpY1RvQWxpYXMgPSB7fTsKICAgICAgdGhpcy5udW1iZXJBbGxvY2F0b3IgPSBuZXcgbnVtYmVyX2FsbG9jYXRvcl8xJDEuTnVtYmVyQWxsb2NhdG9yKDEsIG1heCk7CiAgICAgIHRoaXMubWF4ID0gbWF4OwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICB9CiAgfQogIHB1dCh0b3BpYywgYWxpYXMpIHsKICAgIGlmIChhbGlhcyA9PT0gMCB8fCBhbGlhcyA+IHRoaXMubWF4KSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5hbGlhc1RvVG9waWMuZ2V0KGFsaWFzKTsKICAgIGlmIChlbnRyeSkgewogICAgICBkZWxldGUgdGhpcy50b3BpY1RvQWxpYXNbZW50cnldOwogICAgfQogICAgdGhpcy5hbGlhc1RvVG9waWMuc2V0KGFsaWFzLCB0b3BpYyk7CiAgICB0aGlzLnRvcGljVG9BbGlhc1t0b3BpY10gPSBhbGlhczsKICAgIHRoaXMubnVtYmVyQWxsb2NhdG9yLnVzZShhbGlhcyk7CiAgICB0aGlzLmxlbmd0aCA9IHRoaXMuYWxpYXNUb1RvcGljLnNpemU7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZ2V0VG9waWNCeUFsaWFzKGFsaWFzKSB7CiAgICByZXR1cm4gdGhpcy5hbGlhc1RvVG9waWMuZ2V0KGFsaWFzKTsKICB9CiAgZ2V0QWxpYXNCeVRvcGljKHRvcGljKSB7CiAgICBjb25zdCBhbGlhcyA9IHRoaXMudG9waWNUb0FsaWFzW3RvcGljXTsKICAgIGlmICh0eXBlb2YgYWxpYXMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMuYWxpYXNUb1RvcGljLmdldChhbGlhcyk7CiAgICB9CiAgICByZXR1cm4gYWxpYXM7CiAgfQogIGNsZWFyKCkgewogICAgdGhpcy5hbGlhc1RvVG9waWMuY2xlYXIoKTsKICAgIHRoaXMudG9waWNUb0FsaWFzID0ge307CiAgICB0aGlzLm51bWJlckFsbG9jYXRvci5jbGVhcigpOwogICAgdGhpcy5sZW5ndGggPSAwOwogIH0KICBnZXRMcnVBbGlhcygpIHsKICAgIGNvbnN0IGFsaWFzID0gdGhpcy5udW1iZXJBbGxvY2F0b3IuZmlyc3RWYWNhbnQoKTsKICAgIGlmIChhbGlhcykgcmV0dXJuIGFsaWFzOwogICAgcmV0dXJuIFsuLi50aGlzLmFsaWFzVG9Ub3BpYy5rZXlzKCldW3RoaXMuYWxpYXNUb1RvcGljLnNpemUgLSAxXTsKICB9Cn0KdG9waWNBbGlhc1NlbmQuZGVmYXVsdCA9IFRvcGljQWxpYXNTZW5kOwoKdmFyIF9faW1wb3J0RGVmYXVsdCQ1ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICByZXR1cm4gbW9kICYmIG1vZC5fX2VzTW9kdWxlID8gbW9kIDogewogICAgImRlZmF1bHQiOiBtb2QKICB9Owp9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkoY29ubmFjaywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbnN0IGFja18xJDEgPSBhY2s7CmNvbnN0IHRvcGljX2FsaWFzX3NlbmRfMSA9IF9faW1wb3J0RGVmYXVsdCQ1KHRvcGljQWxpYXNTZW5kKTsKY29uc3Qgc2hhcmVkXzEkMiA9IHNoYXJlZDsKY29uc3QgaGFuZGxlQ29ubmFjayA9IChjbGllbnQsIHBhY2tldCkgPT4gewogIGNsaWVudC5sb2coJ19oYW5kbGVDb25uYWNrJyk7CiAgY29uc3QgewogICAgb3B0aW9ucwogIH0gPSBjbGllbnQ7CiAgY29uc3QgdmVyc2lvbiA9IG9wdGlvbnMucHJvdG9jb2xWZXJzaW9uOwogIGNvbnN0IHJjID0gdmVyc2lvbiA9PT0gNSA/IHBhY2tldC5yZWFzb25Db2RlIDogcGFja2V0LnJldHVybkNvZGU7CiAgY2xlYXJUaW1lb3V0KGNsaWVudFsnY29ubmFja1RpbWVyJ10pOwogIGRlbGV0ZSBjbGllbnRbJ3RvcGljQWxpYXNTZW5kJ107CiAgaWYgKHBhY2tldC5wcm9wZXJ0aWVzKSB7CiAgICBpZiAocGFja2V0LnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0pIHsKICAgICAgaWYgKHBhY2tldC5wcm9wZXJ0aWVzLnRvcGljQWxpYXNNYXhpbXVtID4gMHhmZmZmKSB7CiAgICAgICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCd0b3BpY0FsaWFzTWF4aW11bSBmcm9tIGJyb2tlciBpcyBvdXQgb2YgcmFuZ2UnKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChwYWNrZXQucHJvcGVydGllcy50b3BpY0FsaWFzTWF4aW11bSA+IDApIHsKICAgICAgICBjbGllbnRbJ3RvcGljQWxpYXNTZW5kJ10gPSBuZXcgdG9waWNfYWxpYXNfc2VuZF8xLmRlZmF1bHQocGFja2V0LnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0pOwogICAgICB9CiAgICB9CiAgICBpZiAocGFja2V0LnByb3BlcnRpZXMuc2VydmVyS2VlcEFsaXZlICYmIG9wdGlvbnMua2VlcGFsaXZlKSB7CiAgICAgIG9wdGlvbnMua2VlcGFsaXZlID0gcGFja2V0LnByb3BlcnRpZXMuc2VydmVyS2VlcEFsaXZlOwogICAgfQogICAgaWYgKHBhY2tldC5wcm9wZXJ0aWVzLm1heGltdW1QYWNrZXRTaXplKSB7CiAgICAgIGlmICghb3B0aW9ucy5wcm9wZXJ0aWVzKSB7CiAgICAgICAgb3B0aW9ucy5wcm9wZXJ0aWVzID0ge307CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcm9wZXJ0aWVzLm1heGltdW1QYWNrZXRTaXplID0gcGFja2V0LnByb3BlcnRpZXMubWF4aW11bVBhY2tldFNpemU7CiAgICB9CiAgfQogIGlmIChyYyA9PT0gMCkgewogICAgY2xpZW50LnJlY29ubmVjdGluZyA9IGZhbHNlOwogICAgY2xpZW50Wydfb25Db25uZWN0J10ocGFja2V0KTsKICB9IGVsc2UgaWYgKHJjID4gMCkgewogICAgY29uc3QgZXJyID0gbmV3IHNoYXJlZF8xJDIuRXJyb3JXaXRoUmVhc29uQ29kZShgQ29ubmVjdGlvbiByZWZ1c2VkOiAke2Fja18xJDEuUmVhc29uQ29kZXNbcmNdfWAsIHJjKTsKICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIGVycik7CiAgICBpZiAoY2xpZW50Lm9wdGlvbnMucmVjb25uZWN0T25Db25uYWNrRXJyb3IpIHsKICAgICAgY2xpZW50WydfY2xlYW5VcCddKHRydWUpOwogICAgfQogIH0KfTsKY29ubmFjay5kZWZhdWx0ID0gaGFuZGxlQ29ubmFjazsKCnZhciBwdWJyZWwgPSB7fTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShwdWJyZWwsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBoYW5kbGVQdWJyZWwgPSAoY2xpZW50LCBwYWNrZXQsIGRvbmUpID0+IHsKICBjbGllbnQubG9nKCdoYW5kbGluZyBwdWJyZWwgcGFja2V0Jyk7CiAgY29uc3QgY2FsbGJhY2sgPSB0eXBlb2YgZG9uZSAhPT0gJ3VuZGVmaW5lZCcgPyBkb25lIDogY2xpZW50Lm5vb3A7CiAgY29uc3QgewogICAgbWVzc2FnZUlkCiAgfSA9IHBhY2tldDsKICBjb25zdCBjb21wID0gewogICAgY21kOiAncHViY29tcCcsCiAgICBtZXNzYWdlSWQKICB9OwogIGNsaWVudC5pbmNvbWluZ1N0b3JlLmdldChwYWNrZXQsIChlcnIsIHB1YikgPT4gewogICAgaWYgKCFlcnIpIHsKICAgICAgY2xpZW50LmVtaXQoJ21lc3NhZ2UnLCBwdWIudG9waWMsIHB1Yi5wYXlsb2FkLCBwdWIpOwogICAgICBjbGllbnQuaGFuZGxlTWVzc2FnZShwdWIsIGVycjIgPT4gewogICAgICAgIGlmIChlcnIyKSB7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyMik7CiAgICAgICAgfQogICAgICAgIGNsaWVudC5pbmNvbWluZ1N0b3JlLmRlbChwdWIsIGNsaWVudC5ub29wKTsKICAgICAgICBjbGllbnRbJ19zZW5kUGFja2V0J10oY29tcCwgY2FsbGJhY2spOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNsaWVudFsnX3NlbmRQYWNrZXQnXShjb21wLCBjYWxsYmFjayk7CiAgICB9CiAgfSk7Cn07CnB1YnJlbC5kZWZhdWx0ID0gaGFuZGxlUHVicmVsOwoKdmFyIF9faW1wb3J0RGVmYXVsdCQ0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICByZXR1cm4gbW9kICYmIG1vZC5fX2VzTW9kdWxlID8gbW9kIDogewogICAgImRlZmF1bHQiOiBtb2QKICB9Owp9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkoaGFuZGxlcnMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBwdWJsaXNoXzEgPSBfX2ltcG9ydERlZmF1bHQkNChwdWJsaXNoKTsKY29uc3QgYXV0aF8xID0gX19pbXBvcnREZWZhdWx0JDQoYXV0aCk7CmNvbnN0IGNvbm5hY2tfMSA9IF9faW1wb3J0RGVmYXVsdCQ0KGNvbm5hY2spOwpjb25zdCBhY2tfMSA9IF9faW1wb3J0RGVmYXVsdCQ0KGFjayk7CmNvbnN0IHB1YnJlbF8xID0gX19pbXBvcnREZWZhdWx0JDQocHVicmVsKTsKY29uc3QgaGFuZGxlID0gKGNsaWVudCwgcGFja2V0LCBkb25lKSA9PiB7CiAgY29uc3QgewogICAgb3B0aW9ucwogIH0gPSBjbGllbnQ7CiAgaWYgKG9wdGlvbnMucHJvdG9jb2xWZXJzaW9uID09PSA1ICYmIG9wdGlvbnMucHJvcGVydGllcyAmJiBvcHRpb25zLnByb3BlcnRpZXMubWF4aW11bVBhY2tldFNpemUgJiYgb3B0aW9ucy5wcm9wZXJ0aWVzLm1heGltdW1QYWNrZXRTaXplIDwgcGFja2V0Lmxlbmd0aCkgewogICAgY2xpZW50LmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKGBleGNlZWRpbmcgcGFja2V0cyBzaXplICR7cGFja2V0LmNtZH1gKSk7CiAgICBjbGllbnQuZW5kKHsKICAgICAgcmVhc29uQ29kZTogMTQ5LAogICAgICBwcm9wZXJ0aWVzOiB7CiAgICAgICAgcmVhc29uU3RyaW5nOiAnTWF4aW11bSBwYWNrZXQgc2l6ZSB3YXMgZXhjZWVkZWQnCiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNsaWVudDsKICB9CiAgY2xpZW50LmxvZygnX2hhbmRsZVBhY2tldCA6OiBlbWl0dGluZyBwYWNrZXRyZWNlaXZlJyk7CiAgY2xpZW50LmVtaXQoJ3BhY2tldHJlY2VpdmUnLCBwYWNrZXQpOwogIHN3aXRjaCAocGFja2V0LmNtZCkgewogICAgY2FzZSAncHVibGlzaCc6CiAgICAgICgwLCBwdWJsaXNoXzEuZGVmYXVsdCkoY2xpZW50LCBwYWNrZXQsIGRvbmUpOwogICAgICBicmVhazsKICAgIGNhc2UgJ3B1YmFjayc6CiAgICBjYXNlICdwdWJyZWMnOgogICAgY2FzZSAncHViY29tcCc6CiAgICBjYXNlICdzdWJhY2snOgogICAgY2FzZSAndW5zdWJhY2snOgogICAgICBjbGllbnQucmVzY2hlZHVsZVBpbmcoKTsKICAgICAgKDAsIGFja18xLmRlZmF1bHQpKGNsaWVudCwgcGFja2V0KTsKICAgICAgZG9uZSgpOwogICAgICBicmVhazsKICAgIGNhc2UgJ3B1YnJlbCc6CiAgICAgIGNsaWVudC5yZXNjaGVkdWxlUGluZygpOwogICAgICAoMCwgcHVicmVsXzEuZGVmYXVsdCkoY2xpZW50LCBwYWNrZXQsIGRvbmUpOwogICAgICBicmVhazsKICAgIGNhc2UgJ2Nvbm5hY2snOgogICAgICAoMCwgY29ubmFja18xLmRlZmF1bHQpKGNsaWVudCwgcGFja2V0KTsKICAgICAgZG9uZSgpOwogICAgICBicmVhazsKICAgIGNhc2UgJ2F1dGgnOgogICAgICBjbGllbnQucmVzY2hlZHVsZVBpbmcoKTsKICAgICAgKDAsIGF1dGhfMS5kZWZhdWx0KShjbGllbnQsIHBhY2tldCk7CiAgICAgIGRvbmUoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdwaW5ncmVzcCc6CiAgICAgIGNsaWVudC5sb2coJ19oYW5kbGVQYWNrZXQgOjogcmVjZWl2ZWQgcGluZ3Jlc3AnKTsKICAgICAgY2xpZW50LnJlc2NoZWR1bGVQaW5nKHRydWUpOwogICAgICBkb25lKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnZGlzY29ubmVjdCc6CiAgICAgIGNsaWVudC5lbWl0KCdkaXNjb25uZWN0JywgcGFja2V0KTsKICAgICAgZG9uZSgpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNsaWVudC5sb2coJ19oYW5kbGVQYWNrZXQgOjogdW5rbm93biBjb21tYW5kJyk7CiAgICAgIGRvbmUoKTsKICAgICAgYnJlYWs7CiAgfQp9OwpoYW5kbGVycy5kZWZhdWx0ID0gaGFuZGxlOwoKdmFyIFR5cGVkRW1pdHRlciA9IHt9OwoKdmFyIF9faW1wb3J0RGVmYXVsdCQzID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICByZXR1cm4gbW9kICYmIG1vZC5fX2VzTW9kdWxlID8gbW9kIDogewogICAgImRlZmF1bHQiOiBtb2QKICB9Owp9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkoVHlwZWRFbWl0dGVyLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKVHlwZWRFbWl0dGVyLlR5cGVkRXZlbnRFbWl0dGVyID0gdm9pZCAwOwpjb25zdCBldmVudHNfMSA9IF9faW1wb3J0RGVmYXVsdCQzKHJlcXVpcmUkJDAkMik7CmNvbnN0IHNoYXJlZF8xJDEgPSBzaGFyZWQ7CmNsYXNzIFR5cGVkRXZlbnRFbWl0dGVyIHt9ClR5cGVkRW1pdHRlci5UeXBlZEV2ZW50RW1pdHRlciA9IFR5cGVkRXZlbnRFbWl0dGVyOwooMCwgc2hhcmVkXzEkMS5hcHBseU1peGluKShUeXBlZEV2ZW50RW1pdHRlciwgZXZlbnRzXzEuZGVmYXVsdCk7Cgp2YXIgS2VlcGFsaXZlTWFuYWdlciQxID0ge307Cgp2YXIgZ2V0VGltZXIkMSA9IHt9OwoKdmFyIGlzQnJvd3NlciQxID0ge307CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoaXNCcm93c2VyJDEsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwppc0Jyb3dzZXIkMS5pc1JlYWN0TmF0aXZlQnJvd3NlciA9IGlzQnJvd3NlciQxLmlzV2ViV29ya2VyID0gdm9pZCAwOwpjb25zdCBpc1N0YW5kYXJkQnJvd3NlckVudiA9ICgpID0+IHsKICB2YXIgX2E7CiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICBjb25zdCBlbGVjdHJvblJlbmRlckNoZWNrID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgKChfYSA9IG5hdmlnYXRvci51c2VyQWdlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJyBlbGVjdHJvbi8nKSkgPiAtMTsKICAgIGlmIChlbGVjdHJvblJlbmRlckNoZWNrICYmIChwcm9jZXNzID09PSBudWxsIHx8IHByb2Nlc3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHByb2Nlc3MudmVyc2lvbnMpKSB7CiAgICAgIGNvbnN0IGVsZWN0cm9uTWFpbkNoZWNrID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MudmVyc2lvbnMsICdlbGVjdHJvbicpOwogICAgICByZXR1cm4gIWVsZWN0cm9uTWFpbkNoZWNrOwogICAgfQogICAgcmV0dXJuIHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgIT09ICd1bmRlZmluZWQnOwogIH0KICByZXR1cm4gZmFsc2U7Cn07CmNvbnN0IGlzV2ViV29ya2VyRW52ID0gKCkgPT4gewogIHZhciBfYSwgX2I7CiAgcmV0dXJuIEJvb2xlYW4odHlwZW9mIHNlbGYgPT09ICdvYmplY3QnICYmICgoX2IgPSAoX2EgPSBzZWxmID09PSBudWxsIHx8IHNlbGYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGYuY29uc3RydWN0b3IpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5uYW1lKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuaW5jbHVkZXMoJ1dvcmtlckdsb2JhbFNjb3BlJykpKTsKfTsKY29uc3QgaXNSZWFjdE5hdGl2ZUVudiA9ICgpID0+IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci5wcm9kdWN0ID09PSAnUmVhY3ROYXRpdmUnOwpjb25zdCBpc0Jyb3dzZXIgPSBpc1N0YW5kYXJkQnJvd3NlckVudigpIHx8IGlzV2ViV29ya2VyRW52KCkgfHwgaXNSZWFjdE5hdGl2ZUVudigpOwppc0Jyb3dzZXIkMS5pc1dlYldvcmtlciA9IGlzV2ViV29ya2VyRW52KCk7CmlzQnJvd3NlciQxLmlzUmVhY3ROYXRpdmVCcm93c2VyID0gaXNSZWFjdE5hdGl2ZUVudigpOwppc0Jyb3dzZXIkMS5kZWZhdWx0ID0gaXNCcm93c2VyOwoKdmFyIGJ1bmRsZSQxID0ge2V4cG9ydHM6IHt9fTsKCnZhciBidW5kbGUgPSB7ZXhwb3J0czoge319OwoKdmFyIG1vZHVsZSQxID0ge307Cgp2YXIgYWRkVW5pcXVlTnVtYmVyID0ge307Cgp2YXIgaGFzUmVxdWlyZWRBZGRVbmlxdWVOdW1iZXI7CmZ1bmN0aW9uIHJlcXVpcmVBZGRVbmlxdWVOdW1iZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQWRkVW5pcXVlTnVtYmVyKSByZXR1cm4gYWRkVW5pcXVlTnVtYmVyOwogIGhhc1JlcXVpcmVkQWRkVW5pcXVlTnVtYmVyID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYWRkVW5pcXVlTnVtYmVyLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgYWRkVW5pcXVlTnVtYmVyLmNyZWF0ZUFkZFVuaXF1ZU51bWJlciA9IHZvaWQgMDsKICBjb25zdCBjcmVhdGVBZGRVbmlxdWVOdW1iZXIgPSBnZW5lcmF0ZVVuaXF1ZU51bWJlciA9PiB7CiAgICByZXR1cm4gc2V0ID0+IHsKICAgICAgY29uc3QgbnVtYmVyID0gZ2VuZXJhdGVVbmlxdWVOdW1iZXIoc2V0KTsKICAgICAgc2V0LmFkZChudW1iZXIpOwogICAgICByZXR1cm4gbnVtYmVyOwogICAgfTsKICB9OwogIGFkZFVuaXF1ZU51bWJlci5jcmVhdGVBZGRVbmlxdWVOdW1iZXIgPSBjcmVhdGVBZGRVbmlxdWVOdW1iZXI7CiAgcmV0dXJuIGFkZFVuaXF1ZU51bWJlcjsKfQoKdmFyIGNhY2hlID0ge307Cgp2YXIgaGFzUmVxdWlyZWRDYWNoZTsKZnVuY3Rpb24gcmVxdWlyZUNhY2hlKCkgewogIGlmIChoYXNSZXF1aXJlZENhY2hlKSByZXR1cm4gY2FjaGU7CiAgaGFzUmVxdWlyZWRDYWNoZSA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNhY2hlLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgY2FjaGUuY3JlYXRlQ2FjaGUgPSB2b2lkIDA7CiAgY29uc3QgY3JlYXRlQ2FjaGUgPSBsYXN0TnVtYmVyV2Vha01hcCA9PiB7CiAgICByZXR1cm4gKGNvbGxlY3Rpb24sIG5leHROdW1iZXIpID0+IHsKICAgICAgbGFzdE51bWJlcldlYWtNYXAuc2V0KGNvbGxlY3Rpb24sIG5leHROdW1iZXIpOwogICAgICByZXR1cm4gbmV4dE51bWJlcjsKICAgIH07CiAgfTsKICBjYWNoZS5jcmVhdGVDYWNoZSA9IGNyZWF0ZUNhY2hlOwogIHJldHVybiBjYWNoZTsKfQoKdmFyIGdlbmVyYXRlVW5pcXVlTnVtYmVyID0ge307Cgp2YXIgaGFzUmVxdWlyZWRHZW5lcmF0ZVVuaXF1ZU51bWJlcjsKZnVuY3Rpb24gcmVxdWlyZUdlbmVyYXRlVW5pcXVlTnVtYmVyKCkgewogIGlmIChoYXNSZXF1aXJlZEdlbmVyYXRlVW5pcXVlTnVtYmVyKSByZXR1cm4gZ2VuZXJhdGVVbmlxdWVOdW1iZXI7CiAgaGFzUmVxdWlyZWRHZW5lcmF0ZVVuaXF1ZU51bWJlciA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGdlbmVyYXRlVW5pcXVlTnVtYmVyLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgZ2VuZXJhdGVVbmlxdWVOdW1iZXIuY3JlYXRlR2VuZXJhdGVVbmlxdWVOdW1iZXIgPSB2b2lkIDA7CiAgLyoKICAgKiBUaGUgdmFsdWUgb2YgdGhlIGNvbnN0YW50IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSIGVxdWFscyAoMiAqKiA1MyAtIDEpIGJ1dCBpdAogICAqIGlzIGZhaXJseSBuZXcuCiAgICovCiAgY29uc3QgTUFYX1NBRkVfSU5URUdFUiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSID09PSB1bmRlZmluZWQgPyA5MDA3MTk5MjU0NzQwOTkxIDogTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7CiAgY29uc3QgVFdPX1RPX1RIRV9QT1dFUl9PRl9UV0VOVFlfTklORSA9IDUzNjg3MDkxMjsKICBjb25zdCBUV09fVE9fVEhFX1BPV0VSX09GX1RISVJUWSA9IFRXT19UT19USEVfUE9XRVJfT0ZfVFdFTlRZX05JTkUgKiAyOwogIGNvbnN0IGNyZWF0ZUdlbmVyYXRlVW5pcXVlTnVtYmVyID0gKGNhY2hlLCBsYXN0TnVtYmVyV2Vha01hcCkgPT4gewogICAgcmV0dXJuIGNvbGxlY3Rpb24gPT4gewogICAgICBjb25zdCBsYXN0TnVtYmVyID0gbGFzdE51bWJlcldlYWtNYXAuZ2V0KGNvbGxlY3Rpb24pOwogICAgICAvKgogICAgICAgKiBMZXQncyB0cnkgdGhlIGNoZWFwZXN0IGFsZ29yaXRobSBmaXJzdC4gSXQgbWlnaHQgZmFpbCB0byBwcm9kdWNlIGEgbmV3CiAgICAgICAqIG51bWJlciwgYnV0IGl0IGlzIHNvIGNoZWFwIHRoYXQgaXQgaXMgb2theSB0byB0YWtlIHRoZSByaXNrLiBKdXN0CiAgICAgICAqIGluY3JlYXNlIHRoZSBsYXN0IG51bWJlciBieSBvbmUgb3IgcmVzZXQgaXQgdG8gMCBpZiB3ZSByZWFjaGVkIHRoZSB1cHBlcgogICAgICAgKiBib3VuZCBvZiBTTUlzICh3aGljaCBzdGFuZHMgZm9yIHNtYWxsIGludGVnZXJzKS4gV2hlbiB0aGUgbGFzdCBudW1iZXIgaXMKICAgICAgICogdW5rbm93biBpdCBpcyBhc3N1bWVkIHRoYXQgdGhlIGNvbGxlY3Rpb24gY29udGFpbnMgemVybyBiYXNlZCBjb25zZWN1dGl2ZQogICAgICAgKiBudW1iZXJzLgogICAgICAgKi8KICAgICAgbGV0IG5leHROdW1iZXIgPSBsYXN0TnVtYmVyID09PSB1bmRlZmluZWQgPyBjb2xsZWN0aW9uLnNpemUgOiBsYXN0TnVtYmVyIDwgVFdPX1RPX1RIRV9QT1dFUl9PRl9USElSVFkgPyBsYXN0TnVtYmVyICsgMSA6IDA7CiAgICAgIGlmICghY29sbGVjdGlvbi5oYXMobmV4dE51bWJlcikpIHsKICAgICAgICByZXR1cm4gY2FjaGUoY29sbGVjdGlvbiwgbmV4dE51bWJlcik7CiAgICAgIH0KICAgICAgLyoKICAgICAgICogSWYgdGhlcmUgYXJlIGxlc3MgdGhhbiBoYWxmIG9mIDIgKiogMzAgbnVtYmVycyBzdG9yZWQgaW4gdGhlIGNvbGxlY3Rpb24sCiAgICAgICAqIHRoZSBjaGFuY2UgdG8gZ2VuZXJhdGUgYSBuZXcgcmFuZG9tIG51bWJlciBpbiB0aGUgcmFuZ2UgZnJvbSAwIHRvIDIgKiogMzAKICAgICAgICogaXMgYXQgbGVhc3QgNTAlLiBJdCdzIGJlbmlmaXRpYWwgdG8gdXNlIG9ubHkgU01JcyBiZWNhdXNlIHRoZXkgcGVyZm9ybQogICAgICAgKiBtdWNoIGJldHRlciBpbiBhbnkgZW52aXJvbm1lbnQgYmFzZWQgb24gVjguCiAgICAgICAqLwogICAgICBpZiAoY29sbGVjdGlvbi5zaXplIDwgVFdPX1RPX1RIRV9QT1dFUl9PRl9UV0VOVFlfTklORSkgewogICAgICAgIHdoaWxlIChjb2xsZWN0aW9uLmhhcyhuZXh0TnVtYmVyKSkgewogICAgICAgICAgbmV4dE51bWJlciA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIFRXT19UT19USEVfUE9XRVJfT0ZfVEhJUlRZKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlKGNvbGxlY3Rpb24sIG5leHROdW1iZXIpOwogICAgICB9CiAgICAgIC8vIFF1aWNrbHkgY2hlY2sgaWYgdGhlcmUgaXMgYSB0aGVvcmV0aWNhbCBjaGFuY2UgdG8gZ2VuZXJhdGUgYSBuZXcgbnVtYmVyLgogICAgICBpZiAoY29sbGVjdGlvbi5zaXplID4gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ29uZ3JhdHVsYXRpb25zLCB5b3UgY3JlYXRlZCBhIGNvbGxlY3Rpb24gb2YgdW5pcXVlIG51bWJlcnMgd2hpY2ggdXNlcyBhbGwgYXZhaWxhYmxlIGludGVnZXJzIScpOwogICAgICB9CiAgICAgIC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgc2NhbGUgb2Ygc2FmZWx5IHVzYWJsZSBpbnRlZ2Vycy4KICAgICAgd2hpbGUgKGNvbGxlY3Rpb24uaGFzKG5leHROdW1iZXIpKSB7CiAgICAgICAgbmV4dE51bWJlciA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIE1BWF9TQUZFX0lOVEVHRVIpOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZShjb2xsZWN0aW9uLCBuZXh0TnVtYmVyKTsKICAgIH07CiAgfTsKICBnZW5lcmF0ZVVuaXF1ZU51bWJlci5jcmVhdGVHZW5lcmF0ZVVuaXF1ZU51bWJlciA9IGNyZWF0ZUdlbmVyYXRlVW5pcXVlTnVtYmVyOwogIHJldHVybiBnZW5lcmF0ZVVuaXF1ZU51bWJlcjsKfQoKdmFyIHR5cGVzID0ge307Cgp2YXIgYWRkVW5pcXVlTnVtYmVyRmFjdG9yeSA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkQWRkVW5pcXVlTnVtYmVyRmFjdG9yeTsKZnVuY3Rpb24gcmVxdWlyZUFkZFVuaXF1ZU51bWJlckZhY3RvcnkoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQWRkVW5pcXVlTnVtYmVyRmFjdG9yeSkgcmV0dXJuIGFkZFVuaXF1ZU51bWJlckZhY3Rvcnk7CiAgaGFzUmVxdWlyZWRBZGRVbmlxdWVOdW1iZXJGYWN0b3J5ID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYWRkVW5pcXVlTnVtYmVyRmFjdG9yeSwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIHJldHVybiBhZGRVbmlxdWVOdW1iZXJGYWN0b3J5Owp9Cgp2YXIgYWRkVW5pcXVlTnVtYmVyRnVuY3Rpb24gPSB7fTsKCnZhciBoYXNSZXF1aXJlZEFkZFVuaXF1ZU51bWJlckZ1bmN0aW9uOwpmdW5jdGlvbiByZXF1aXJlQWRkVW5pcXVlTnVtYmVyRnVuY3Rpb24oKSB7CiAgaWYgKGhhc1JlcXVpcmVkQWRkVW5pcXVlTnVtYmVyRnVuY3Rpb24pIHJldHVybiBhZGRVbmlxdWVOdW1iZXJGdW5jdGlvbjsKICBoYXNSZXF1aXJlZEFkZFVuaXF1ZU51bWJlckZ1bmN0aW9uID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYWRkVW5pcXVlTnVtYmVyRnVuY3Rpb24sICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICByZXR1cm4gYWRkVW5pcXVlTnVtYmVyRnVuY3Rpb247Cn0KCnZhciBjYWNoZUZhY3RvcnkgPSB7fTsKCnZhciBoYXNSZXF1aXJlZENhY2hlRmFjdG9yeTsKZnVuY3Rpb24gcmVxdWlyZUNhY2hlRmFjdG9yeSgpIHsKICBpZiAoaGFzUmVxdWlyZWRDYWNoZUZhY3RvcnkpIHJldHVybiBjYWNoZUZhY3Rvcnk7CiAgaGFzUmVxdWlyZWRDYWNoZUZhY3RvcnkgPSAxOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjYWNoZUZhY3RvcnksICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICByZXR1cm4gY2FjaGVGYWN0b3J5Owp9Cgp2YXIgY2FjaGVGdW5jdGlvbiA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkQ2FjaGVGdW5jdGlvbjsKZnVuY3Rpb24gcmVxdWlyZUNhY2hlRnVuY3Rpb24oKSB7CiAgaWYgKGhhc1JlcXVpcmVkQ2FjaGVGdW5jdGlvbikgcmV0dXJuIGNhY2hlRnVuY3Rpb247CiAgaGFzUmVxdWlyZWRDYWNoZUZ1bmN0aW9uID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY2FjaGVGdW5jdGlvbiwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIHJldHVybiBjYWNoZUZ1bmN0aW9uOwp9Cgp2YXIgZ2VuZXJhdGVVbmlxdWVOdW1iZXJGYWN0b3J5ID0ge307Cgp2YXIgaGFzUmVxdWlyZWRHZW5lcmF0ZVVuaXF1ZU51bWJlckZhY3Rvcnk7CmZ1bmN0aW9uIHJlcXVpcmVHZW5lcmF0ZVVuaXF1ZU51bWJlckZhY3RvcnkoKSB7CiAgaWYgKGhhc1JlcXVpcmVkR2VuZXJhdGVVbmlxdWVOdW1iZXJGYWN0b3J5KSByZXR1cm4gZ2VuZXJhdGVVbmlxdWVOdW1iZXJGYWN0b3J5OwogIGhhc1JlcXVpcmVkR2VuZXJhdGVVbmlxdWVOdW1iZXJGYWN0b3J5ID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZ2VuZXJhdGVVbmlxdWVOdW1iZXJGYWN0b3J5LCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgcmV0dXJuIGdlbmVyYXRlVW5pcXVlTnVtYmVyRmFjdG9yeTsKfQoKdmFyIGdlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb24gPSB7fTsKCnZhciBoYXNSZXF1aXJlZEdlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb247CmZ1bmN0aW9uIHJlcXVpcmVHZW5lcmF0ZVVuaXF1ZU51bWJlckZ1bmN0aW9uKCkgewogIGlmIChoYXNSZXF1aXJlZEdlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb24pIHJldHVybiBnZW5lcmF0ZVVuaXF1ZU51bWJlckZ1bmN0aW9uOwogIGhhc1JlcXVpcmVkR2VuZXJhdGVVbmlxdWVOdW1iZXJGdW5jdGlvbiA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGdlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb24sICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICByZXR1cm4gZ2VuZXJhdGVVbmlxdWVOdW1iZXJGdW5jdGlvbjsKfQoKdmFyIGhhc1JlcXVpcmVkVHlwZXM7CmZ1bmN0aW9uIHJlcXVpcmVUeXBlcygpIHsKICBpZiAoaGFzUmVxdWlyZWRUeXBlcykgcmV0dXJuIHR5cGVzOwogIGhhc1JlcXVpcmVkVHlwZXMgPSAxOwogIChmdW5jdGlvbiAoZXhwb3J0cykgewoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgdmFsdWU6IHRydWUKICAgIH0pOwogICAgdmFyIF9hZGRVbmlxdWVOdW1iZXJGYWN0b3J5ID0gcmVxdWlyZUFkZFVuaXF1ZU51bWJlckZhY3RvcnkoKTsKICAgIE9iamVjdC5rZXlzKF9hZGRVbmlxdWVOdW1iZXJGYWN0b3J5KS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gImRlZmF1bHQiIHx8IGtleSA9PT0gIl9fZXNNb2R1bGUiKSByZXR1cm47CiAgICAgIGlmIChrZXkgaW4gZXhwb3J0cyAmJiBleHBvcnRzW2tleV0gPT09IF9hZGRVbmlxdWVOdW1iZXJGYWN0b3J5W2tleV0pIHJldHVybjsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX2FkZFVuaXF1ZU51bWJlckZhY3Rvcnlba2V5XTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICB2YXIgX2FkZFVuaXF1ZU51bWJlckZ1bmN0aW9uID0gcmVxdWlyZUFkZFVuaXF1ZU51bWJlckZ1bmN0aW9uKCk7CiAgICBPYmplY3Qua2V5cyhfYWRkVW5pcXVlTnVtYmVyRnVuY3Rpb24pLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoa2V5ID09PSAiZGVmYXVsdCIgfHwga2V5ID09PSAiX19lc01vZHVsZSIpIHJldHVybjsKICAgICAgaWYgKGtleSBpbiBleHBvcnRzICYmIGV4cG9ydHNba2V5XSA9PT0gX2FkZFVuaXF1ZU51bWJlckZ1bmN0aW9uW2tleV0pIHJldHVybjsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX2FkZFVuaXF1ZU51bWJlckZ1bmN0aW9uW2tleV07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgdmFyIF9jYWNoZUZhY3RvcnkgPSByZXF1aXJlQ2FjaGVGYWN0b3J5KCk7CiAgICBPYmplY3Qua2V5cyhfY2FjaGVGYWN0b3J5KS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gImRlZmF1bHQiIHx8IGtleSA9PT0gIl9fZXNNb2R1bGUiKSByZXR1cm47CiAgICAgIGlmIChrZXkgaW4gZXhwb3J0cyAmJiBleHBvcnRzW2tleV0gPT09IF9jYWNoZUZhY3Rvcnlba2V5XSkgcmV0dXJuOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywga2V5LCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBfY2FjaGVGYWN0b3J5W2tleV07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgdmFyIF9jYWNoZUZ1bmN0aW9uID0gcmVxdWlyZUNhY2hlRnVuY3Rpb24oKTsKICAgIE9iamVjdC5rZXlzKF9jYWNoZUZ1bmN0aW9uKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gImRlZmF1bHQiIHx8IGtleSA9PT0gIl9fZXNNb2R1bGUiKSByZXR1cm47CiAgICAgIGlmIChrZXkgaW4gZXhwb3J0cyAmJiBleHBvcnRzW2tleV0gPT09IF9jYWNoZUZ1bmN0aW9uW2tleV0pIHJldHVybjsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gX2NhY2hlRnVuY3Rpb25ba2V5XTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICB2YXIgX2dlbmVyYXRlVW5pcXVlTnVtYmVyRmFjdG9yeSA9IHJlcXVpcmVHZW5lcmF0ZVVuaXF1ZU51bWJlckZhY3RvcnkoKTsKICAgIE9iamVjdC5rZXlzKF9nZW5lcmF0ZVVuaXF1ZU51bWJlckZhY3RvcnkpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoa2V5ID09PSAiZGVmYXVsdCIgfHwga2V5ID09PSAiX19lc01vZHVsZSIpIHJldHVybjsKICAgICAgaWYgKGtleSBpbiBleHBvcnRzICYmIGV4cG9ydHNba2V5XSA9PT0gX2dlbmVyYXRlVW5pcXVlTnVtYmVyRmFjdG9yeVtrZXldKSByZXR1cm47CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBrZXksIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9nZW5lcmF0ZVVuaXF1ZU51bWJlckZhY3Rvcnlba2V5XTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgICB2YXIgX2dlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb24gPSByZXF1aXJlR2VuZXJhdGVVbmlxdWVOdW1iZXJGdW5jdGlvbigpOwogICAgT2JqZWN0LmtleXMoX2dlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb24pLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoa2V5ID09PSAiZGVmYXVsdCIgfHwga2V5ID09PSAiX19lc01vZHVsZSIpIHJldHVybjsKICAgICAgaWYgKGtleSBpbiBleHBvcnRzICYmIGV4cG9ydHNba2V5XSA9PT0gX2dlbmVyYXRlVW5pcXVlTnVtYmVyRnVuY3Rpb25ba2V5XSkgcmV0dXJuOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywga2V5LCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBfZ2VuZXJhdGVVbmlxdWVOdW1iZXJGdW5jdGlvbltrZXldOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9KSh0eXBlcyk7CiAgcmV0dXJuIHR5cGVzOwp9Cgp2YXIgaGFzUmVxdWlyZWRNb2R1bGU7CmZ1bmN0aW9uIHJlcXVpcmVNb2R1bGUoKSB7CiAgaWYgKGhhc1JlcXVpcmVkTW9kdWxlKSByZXR1cm4gbW9kdWxlJDE7CiAgaGFzUmVxdWlyZWRNb2R1bGUgPSAxOwogIChmdW5jdGlvbiAoZXhwb3J0cykgewoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgdmFsdWU6IHRydWUKICAgIH0pOwogICAgdmFyIF9leHBvcnROYW1lcyA9IHsKICAgICAgYWRkVW5pcXVlTnVtYmVyOiB0cnVlLAogICAgICBnZW5lcmF0ZVVuaXF1ZU51bWJlcjogdHJ1ZQogICAgfTsKICAgIGV4cG9ydHMuZ2VuZXJhdGVVbmlxdWVOdW1iZXIgPSBleHBvcnRzLmFkZFVuaXF1ZU51bWJlciA9IHZvaWQgMDsKICAgIHZhciBfYWRkVW5pcXVlTnVtYmVyID0gcmVxdWlyZUFkZFVuaXF1ZU51bWJlcigpOwogICAgdmFyIF9jYWNoZSA9IHJlcXVpcmVDYWNoZSgpOwogICAgdmFyIF9nZW5lcmF0ZVVuaXF1ZU51bWJlciA9IHJlcXVpcmVHZW5lcmF0ZVVuaXF1ZU51bWJlcigpOwogICAgdmFyIF9pbmRleCA9IHJlcXVpcmVUeXBlcygpOwogICAgT2JqZWN0LmtleXMoX2luZGV4KS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKGtleSA9PT0gImRlZmF1bHQiIHx8IGtleSA9PT0gIl9fZXNNb2R1bGUiKSByZXR1cm47CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoX2V4cG9ydE5hbWVzLCBrZXkpKSByZXR1cm47CiAgICAgIGlmIChrZXkgaW4gZXhwb3J0cyAmJiBleHBvcnRzW2tleV0gPT09IF9pbmRleFtrZXldKSByZXR1cm47CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBrZXksIHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIF9pbmRleFtrZXldOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIC8qCiAgICAgKiBAdG9kbyBFeHBsaWNpdGx5IHJlZmVyZW5jaW5nIHRoZSBiYXJyZWwgZmlsZSBzZWVtcyB0byBiZSBuZWNlc3Nhcnkgd2hlbiBlbmFibGluZyB0aGUKICAgICAqIGlzb2xhdGVkTW9kdWxlcyBjb21waWxlciBvcHRpb24uCiAgICAgKi8KCiAgICBjb25zdCBMQVNUX05VTUJFUl9XRUFLX01BUCA9IG5ldyBXZWFrTWFwKCk7CiAgICBjb25zdCBjYWNoZSA9ICgwLCBfY2FjaGUuY3JlYXRlQ2FjaGUpKExBU1RfTlVNQkVSX1dFQUtfTUFQKTsKICAgIGNvbnN0IGdlbmVyYXRlVW5pcXVlTnVtYmVyID0gZXhwb3J0cy5nZW5lcmF0ZVVuaXF1ZU51bWJlciA9ICgwLCBfZ2VuZXJhdGVVbmlxdWVOdW1iZXIuY3JlYXRlR2VuZXJhdGVVbmlxdWVOdW1iZXIpKGNhY2hlLCBMQVNUX05VTUJFUl9XRUFLX01BUCk7CiAgICBleHBvcnRzLmFkZFVuaXF1ZU51bWJlciA9ICgwLCBfYWRkVW5pcXVlTnVtYmVyLmNyZWF0ZUFkZFVuaXF1ZU51bWJlcikoZ2VuZXJhdGVVbmlxdWVOdW1iZXIpOwogIH0pKG1vZHVsZSQxKTsKICByZXR1cm4gbW9kdWxlJDE7Cn0KCnZhciBoYXNSZXF1aXJlZEJ1bmRsZTsKZnVuY3Rpb24gcmVxdWlyZUJ1bmRsZSgpIHsKICBpZiAoaGFzUmVxdWlyZWRCdW5kbGUpIHJldHVybiBidW5kbGUuZXhwb3J0czsKICBoYXNSZXF1aXJlZEJ1bmRsZSA9IDE7CiAgKGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKICAgIChmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICAgIGZhY3RvcnkoZXhwb3J0cywgcmVxdWlyZU1vZHVsZSgpKSA7CiAgICB9KShjb21tb25qc0dsb2JhbCwgZnVuY3Rpb24gKGV4cG9ydHMsIGZhc3RVbmlxdWVOdW1iZXJzKSB7CgogICAgICB2YXIgaXNDYWxsTm90aWZpY2F0aW9uID0gZnVuY3Rpb24gaXNDYWxsTm90aWZpY2F0aW9uKG1lc3NhZ2UpIHsKICAgICAgICByZXR1cm4gbWVzc2FnZS5tZXRob2QgIT09IHVuZGVmaW5lZCAmJiBtZXNzYWdlLm1ldGhvZCA9PT0gJ2NhbGwnOwogICAgICB9OwogICAgICB2YXIgaXNDbGVhclJlc3BvbnNlID0gZnVuY3Rpb24gaXNDbGVhclJlc3BvbnNlKG1lc3NhZ2UpIHsKICAgICAgICByZXR1cm4gbWVzc2FnZS5lcnJvciA9PT0gbnVsbCAmJiB0eXBlb2YgbWVzc2FnZS5pZCA9PT0gJ251bWJlcic7CiAgICAgIH07CiAgICAgIHZhciBsb2FkID0gZnVuY3Rpb24gbG9hZCh1cmwpIHsKICAgICAgICAvLyBQcmVmaWxsaW5nIHRoZSBNYXBzIHdpdGggYSBmdW5jdGlvbiBpbmRleGVkIGJ5IHplcm8gaXMgbmVjZXNzYXJ5IHRvIGJlIGNvbXBsaWFudCB3aXRoIHRoZSBzcGVjaWZpY2F0aW9uLgogICAgICAgIHZhciBzY2hlZHVsZWRJbnRlcnZhbEZ1bmN0aW9ucyA9IG5ldyBNYXAoW1swLCBmdW5jdGlvbiAoKSB7fV1dKTsgLy8gdHNsaW50OmRpc2FibGUtbGluZSBuby1lbXB0eQogICAgICAgIHZhciBzY2hlZHVsZWRUaW1lb3V0RnVuY3Rpb25zID0gbmV3IE1hcChbWzAsIGZ1bmN0aW9uICgpIHt9XV0pOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lIG5vLWVtcHR5CiAgICAgICAgdmFyIHVucmVzcG9uZGVkUmVxdWVzdHMgPSBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHdvcmtlciA9IG5ldyBXb3JrZXIodXJsKTsKICAgICAgICB3b3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IF9yZWYuZGF0YTsKICAgICAgICAgIGlmIChpc0NhbGxOb3RpZmljYXRpb24oZGF0YSkpIHsKICAgICAgICAgICAgdmFyIF9kYXRhJHBhcmFtcyA9IGRhdGEucGFyYW1zLAogICAgICAgICAgICAgIHRpbWVySWQgPSBfZGF0YSRwYXJhbXMudGltZXJJZCwKICAgICAgICAgICAgICB0aW1lclR5cGUgPSBfZGF0YSRwYXJhbXMudGltZXJUeXBlOwogICAgICAgICAgICBpZiAodGltZXJUeXBlID09PSAnaW50ZXJ2YWwnKSB7CiAgICAgICAgICAgICAgdmFyIGlkT3JGdW5jID0gc2NoZWR1bGVkSW50ZXJ2YWxGdW5jdGlvbnMuZ2V0KHRpbWVySWQpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaWRPckZ1bmMgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICB2YXIgdGltZXJJZEFuZFRpbWVyVHlwZSA9IHVucmVzcG9uZGVkUmVxdWVzdHMuZ2V0KGlkT3JGdW5jKTsKICAgICAgICAgICAgICAgIGlmICh0aW1lcklkQW5kVGltZXJUeXBlID09PSB1bmRlZmluZWQgfHwgdGltZXJJZEFuZFRpbWVyVHlwZS50aW1lcklkICE9PSB0aW1lcklkIHx8IHRpbWVySWRBbmRUaW1lclR5cGUudGltZXJUeXBlICE9PSB0aW1lclR5cGUpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgdGltZXIgaXMgaW4gYW4gdW5kZWZpbmVkIHN0YXRlLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGlkT3JGdW5jICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgaWRPckZ1bmMoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgdGltZXIgaXMgaW4gYW4gdW5kZWZpbmVkIHN0YXRlLicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lclR5cGUgPT09ICd0aW1lb3V0JykgewogICAgICAgICAgICAgIHZhciBfaWRPckZ1bmMgPSBzY2hlZHVsZWRUaW1lb3V0RnVuY3Rpb25zLmdldCh0aW1lcklkKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9pZE9yRnVuYyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIHZhciBfdGltZXJJZEFuZFRpbWVyVHlwZSA9IHVucmVzcG9uZGVkUmVxdWVzdHMuZ2V0KF9pZE9yRnVuYyk7CiAgICAgICAgICAgICAgICBpZiAoX3RpbWVySWRBbmRUaW1lclR5cGUgPT09IHVuZGVmaW5lZCB8fCBfdGltZXJJZEFuZFRpbWVyVHlwZS50aW1lcklkICE9PSB0aW1lcklkIHx8IF90aW1lcklkQW5kVGltZXJUeXBlLnRpbWVyVHlwZSAhPT0gdGltZXJUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHRpbWVyIGlzIGluIGFuIHVuZGVmaW5lZCBzdGF0ZS4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBfaWRPckZ1bmMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBfaWRPckZ1bmMoKTsKICAgICAgICAgICAgICAgIC8vIEEgdGltZW91dCBjYW4gYmUgc2F2ZWx5IGRlbGV0ZWQgYmVjYXVzZSBpdCBpcyBvbmx5IGNhbGxlZCBvbmNlLgogICAgICAgICAgICAgICAgc2NoZWR1bGVkVGltZW91dEZ1bmN0aW9uc1siZGVsZXRlIl0odGltZXJJZCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHRpbWVyIGlzIGluIGFuIHVuZGVmaW5lZCBzdGF0ZS4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNDbGVhclJlc3BvbnNlKGRhdGEpKSB7CiAgICAgICAgICAgIHZhciBpZCA9IGRhdGEuaWQ7CiAgICAgICAgICAgIHZhciBfdGltZXJJZEFuZFRpbWVyVHlwZTIgPSB1bnJlc3BvbmRlZFJlcXVlc3RzLmdldChpZCk7CiAgICAgICAgICAgIGlmIChfdGltZXJJZEFuZFRpbWVyVHlwZTIgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHRpbWVyIGlzIGluIGFuIHVuZGVmaW5lZCBzdGF0ZS4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3RpbWVySWQgPSBfdGltZXJJZEFuZFRpbWVyVHlwZTIudGltZXJJZCwKICAgICAgICAgICAgICBfdGltZXJUeXBlID0gX3RpbWVySWRBbmRUaW1lclR5cGUyLnRpbWVyVHlwZTsKICAgICAgICAgICAgdW5yZXNwb25kZWRSZXF1ZXN0c1siZGVsZXRlIl0oaWQpOwogICAgICAgICAgICBpZiAoX3RpbWVyVHlwZSA9PT0gJ2ludGVydmFsJykgewogICAgICAgICAgICAgIHNjaGVkdWxlZEludGVydmFsRnVuY3Rpb25zWyJkZWxldGUiXShfdGltZXJJZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVkVGltZW91dEZ1bmN0aW9uc1siZGVsZXRlIl0oX3RpbWVySWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGRhdGEuZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBjbGVhckludGVydmFsID0gZnVuY3Rpb24gY2xlYXJJbnRlcnZhbCh0aW1lcklkKSB7CiAgICAgICAgICB2YXIgaWQgPSBmYXN0VW5pcXVlTnVtYmVycy5nZW5lcmF0ZVVuaXF1ZU51bWJlcih1bnJlc3BvbmRlZFJlcXVlc3RzKTsKICAgICAgICAgIHVucmVzcG9uZGVkUmVxdWVzdHMuc2V0KGlkLCB7CiAgICAgICAgICAgIHRpbWVySWQ6IHRpbWVySWQsCiAgICAgICAgICAgIHRpbWVyVHlwZTogJ2ludGVydmFsJwogICAgICAgICAgfSk7CiAgICAgICAgICBzY2hlZHVsZWRJbnRlcnZhbEZ1bmN0aW9ucy5zZXQodGltZXJJZCwgaWQpOwogICAgICAgICAgd29ya2VyLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICBtZXRob2Q6ICdjbGVhcicsCiAgICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICAgIHRpbWVySWQ6IHRpbWVySWQsCiAgICAgICAgICAgICAgdGltZXJUeXBlOiAnaW50ZXJ2YWwnCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGNsZWFyVGltZW91dCA9IGZ1bmN0aW9uIGNsZWFyVGltZW91dCh0aW1lcklkKSB7CiAgICAgICAgICB2YXIgaWQgPSBmYXN0VW5pcXVlTnVtYmVycy5nZW5lcmF0ZVVuaXF1ZU51bWJlcih1bnJlc3BvbmRlZFJlcXVlc3RzKTsKICAgICAgICAgIHVucmVzcG9uZGVkUmVxdWVzdHMuc2V0KGlkLCB7CiAgICAgICAgICAgIHRpbWVySWQ6IHRpbWVySWQsCiAgICAgICAgICAgIHRpbWVyVHlwZTogJ3RpbWVvdXQnCiAgICAgICAgICB9KTsKICAgICAgICAgIHNjaGVkdWxlZFRpbWVvdXRGdW5jdGlvbnMuc2V0KHRpbWVySWQsIGlkKTsKICAgICAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgbWV0aG9kOiAnY2xlYXInLAogICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICB0aW1lcklkOiB0aW1lcklkLAogICAgICAgICAgICAgIHRpbWVyVHlwZTogJ3RpbWVvdXQnCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIHNldEludGVydmFsID0gZnVuY3Rpb24gc2V0SW50ZXJ2YWwoZnVuYykgewogICAgICAgICAgdmFyIGRlbGF5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAwOwogICAgICAgICAgdmFyIHRpbWVySWQgPSBmYXN0VW5pcXVlTnVtYmVycy5nZW5lcmF0ZVVuaXF1ZU51bWJlcihzY2hlZHVsZWRJbnRlcnZhbEZ1bmN0aW9ucyk7CiAgICAgICAgICBzY2hlZHVsZWRJbnRlcnZhbEZ1bmN0aW9ucy5zZXQodGltZXJJZCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdW5jKCk7CiAgICAgICAgICAgIC8vIERvdWJsZWNoZWNrIGlmIHRoZSBpbnRlcnZhbCBzaG91bGQgc3RpbGwgYmUgcmVzY2hlZHVsZWQgYmVjYXVzZSBpdCBjb3VsZCBoYXZlIGJlZW4gY2xlYXJlZCBpbnNpZGUgb2YgZnVuYygpLgogICAgICAgICAgICBpZiAodHlwZW9mIHNjaGVkdWxlZEludGVydmFsRnVuY3Rpb25zLmdldCh0aW1lcklkKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgICBpZDogbnVsbCwKICAgICAgICAgICAgICAgIG1ldGhvZDogJ3NldCcsCiAgICAgICAgICAgICAgICBwYXJhbXM6IHsKICAgICAgICAgICAgICAgICAgZGVsYXk6IGRlbGF5LAogICAgICAgICAgICAgICAgICBub3c6IHBlcmZvcm1hbmNlLm5vdygpLAogICAgICAgICAgICAgICAgICB0aW1lcklkOiB0aW1lcklkLAogICAgICAgICAgICAgICAgICB0aW1lclR5cGU6ICdpbnRlcnZhbCcKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB3b3JrZXIucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbnVsbCwKICAgICAgICAgICAgbWV0aG9kOiAnc2V0JywKICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgZGVsYXk6IGRlbGF5LAogICAgICAgICAgICAgIG5vdzogcGVyZm9ybWFuY2Uubm93KCksCiAgICAgICAgICAgICAgdGltZXJJZDogdGltZXJJZCwKICAgICAgICAgICAgICB0aW1lclR5cGU6ICdpbnRlcnZhbCcKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gdGltZXJJZDsKICAgICAgICB9OwogICAgICAgIHZhciBzZXRUaW1lb3V0ID0gZnVuY3Rpb24gc2V0VGltZW91dChmdW5jKSB7CiAgICAgICAgICB2YXIgZGVsYXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgICAgICAgICB2YXIgdGltZXJJZCA9IGZhc3RVbmlxdWVOdW1iZXJzLmdlbmVyYXRlVW5pcXVlTnVtYmVyKHNjaGVkdWxlZFRpbWVvdXRGdW5jdGlvbnMpOwogICAgICAgICAgc2NoZWR1bGVkVGltZW91dEZ1bmN0aW9ucy5zZXQodGltZXJJZCwgZnVuYyk7CiAgICAgICAgICB3b3JrZXIucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBpZDogbnVsbCwKICAgICAgICAgICAgbWV0aG9kOiAnc2V0JywKICAgICAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICAgICAgZGVsYXk6IGRlbGF5LAogICAgICAgICAgICAgIG5vdzogcGVyZm9ybWFuY2Uubm93KCksCiAgICAgICAgICAgICAgdGltZXJJZDogdGltZXJJZCwKICAgICAgICAgICAgICB0aW1lclR5cGU6ICd0aW1lb3V0JwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0aW1lcklkOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNsZWFySW50ZXJ2YWw6IGNsZWFySW50ZXJ2YWwsCiAgICAgICAgICBjbGVhclRpbWVvdXQ6IGNsZWFyVGltZW91dCwKICAgICAgICAgIHNldEludGVydmFsOiBzZXRJbnRlcnZhbCwKICAgICAgICAgIHNldFRpbWVvdXQ6IHNldFRpbWVvdXQKICAgICAgICB9OwogICAgICB9OwogICAgICBleHBvcnRzLmxvYWQgPSBsb2FkOwogICAgfSk7CiAgfSkoYnVuZGxlLCBidW5kbGUuZXhwb3J0cyk7CiAgcmV0dXJuIGJ1bmRsZS5leHBvcnRzOwp9CgooZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewogIChmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgICBmYWN0b3J5KGV4cG9ydHMsIHJlcXVpcmVCdW5kbGUoKSkgOwogIH0pKGNvbW1vbmpzR2xvYmFsLCBmdW5jdGlvbiAoZXhwb3J0cywgd29ya2VyVGltZXJzQnJva2VyKSB7CgogICAgdmFyIGNyZWF0ZUxvYWRPclJldHVybkJyb2tlciA9IGZ1bmN0aW9uIGNyZWF0ZUxvYWRPclJldHVybkJyb2tlcihsb2FkQnJva2VyLCB3b3JrZXIpIHsKICAgICAgdmFyIGJyb2tlciA9IG51bGw7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGJyb2tlciAhPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIGJyb2tlcjsKICAgICAgICB9CiAgICAgICAgdmFyIGJsb2IgPSBuZXcgQmxvYihbd29ya2VyXSwgewogICAgICAgICAgdHlwZTogJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQ7IGNoYXJzZXQ9dXRmLTgnCiAgICAgICAgfSk7CiAgICAgICAgdmFyIHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgYnJva2VyID0gbG9hZEJyb2tlcih1cmwpOwogICAgICAgIC8vIEJ1ZyAjMTogRWRnZSB1cCB1bnRpbCB2MTggZGlkbid0IGxpa2UgdGhlIFVSTCB0byBiZSByZXZva2VkIGRpcmVjdGx5LgogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYnJva2VyOwogICAgICB9OwogICAgfTsKCiAgICAvLyBUaGlzIGlzIHRoZSBtaW5pZmllZCBhbmQgc3RyaW5naWZpZWQgY29kZSBvZiB0aGUgd29ya2VyLXRpbWVycy13b3JrZXIgcGFja2FnZS4KICAgIHZhciB3b3JrZXIgPSAiKCgpPT57dmFyIGU9ezQ3MjooZSx0LHIpPT57dmFyIG8saTt2b2lkIDA9PT0oaT1cImZ1bmN0aW9uXCI9PXR5cGVvZihvPWZ1bmN0aW9uKCl7XCJ1c2Ugc3RyaWN0XCI7dmFyIGU9bmV3IE1hcCx0PW5ldyBNYXAscj1mdW5jdGlvbih0KXt2YXIgcj1lLmdldCh0KTtpZih2b2lkIDA9PT1yKXRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gaW50ZXJ2YWwgc2NoZWR1bGVkIHdpdGggdGhlIGdpdmVuIGlkIFwiJy5jb25jYXQodCwnXCIuJykpO2NsZWFyVGltZW91dChyKSxlLmRlbGV0ZSh0KX0sbz1mdW5jdGlvbihlKXt2YXIgcj10LmdldChlKTtpZih2b2lkIDA9PT1yKXRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gdGltZW91dCBzY2hlZHVsZWQgd2l0aCB0aGUgZ2l2ZW4gaWQgXCInLmNvbmNhdChlLCdcIi4nKSk7Y2xlYXJUaW1lb3V0KHIpLHQuZGVsZXRlKGUpfSxpPWZ1bmN0aW9uKGUsdCl7dmFyIHIsbz1wZXJmb3JtYW5jZS5ub3coKTtyZXR1cm57ZXhwZWN0ZWQ6bysocj1lLU1hdGgubWF4KDAsby10KSkscmVtYWluaW5nRGVsYXk6cn19LG49ZnVuY3Rpb24gZSh0LHIsbyxpKXt2YXIgbj1wZXJmb3JtYW5jZS5ub3coKTtuPm8/cG9zdE1lc3NhZ2Uoe2lkOm51bGwsbWV0aG9kOlwiY2FsbFwiLHBhcmFtczp7dGltZXJJZDpyLHRpbWVyVHlwZTppfX0pOnQuc2V0KHIsc2V0VGltZW91dChlLG8tbix0LHIsbyxpKSl9LGE9ZnVuY3Rpb24odCxyLG8pe3ZhciBhPWkodCxvKSxzPWEuZXhwZWN0ZWQsZD1hLnJlbWFpbmluZ0RlbGF5O2Uuc2V0KHIsc2V0VGltZW91dChuLGQsZSxyLHMsXCJpbnRlcnZhbFwiKSl9LHM9ZnVuY3Rpb24oZSxyLG8pe3ZhciBhPWkoZSxvKSxzPWEuZXhwZWN0ZWQsZD1hLnJlbWFpbmluZ0RlbGF5O3Quc2V0KHIsc2V0VGltZW91dChuLGQsdCxyLHMsXCJ0aW1lb3V0XCIpKX07YWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwoZnVuY3Rpb24oZSl7dmFyIHQ9ZS5kYXRhO3RyeXtpZihcImNsZWFyXCI9PT10Lm1ldGhvZCl7dmFyIGk9dC5pZCxuPXQucGFyYW1zLGQ9bi50aW1lcklkLGM9bi50aW1lclR5cGU7aWYoXCJpbnRlcnZhbFwiPT09YylyKGQpLHBvc3RNZXNzYWdlKHtlcnJvcjpudWxsLGlkOml9KTtlbHNle2lmKFwidGltZW91dFwiIT09Yyl0aHJvdyBuZXcgRXJyb3IoJ1RoZSBnaXZlbiB0eXBlIFwiJy5jb25jYXQoYywnXCIgaXMgbm90IHN1cHBvcnRlZCcpKTtvKGQpLHBvc3RNZXNzYWdlKHtlcnJvcjpudWxsLGlkOml9KX19ZWxzZXtpZihcInNldFwiIT09dC5tZXRob2QpdGhyb3cgbmV3IEVycm9yKCdUaGUgZ2l2ZW4gbWV0aG9kIFwiJy5jb25jYXQodC5tZXRob2QsJ1wiIGlzIG5vdCBzdXBwb3J0ZWQnKSk7dmFyIHU9dC5wYXJhbXMsbD11LmRlbGF5LHA9dS5ub3csbT11LnRpbWVySWQsdj11LnRpbWVyVHlwZTtpZihcImludGVydmFsXCI9PT12KWEobCxtLHApO2Vsc2V7aWYoXCJ0aW1lb3V0XCIhPT12KXRocm93IG5ldyBFcnJvcignVGhlIGdpdmVuIHR5cGUgXCInLmNvbmNhdCh2LCdcIiBpcyBub3Qgc3VwcG9ydGVkJykpO3MobCxtLHApfX19Y2F0Y2goZSl7cG9zdE1lc3NhZ2Uoe2Vycm9yOnttZXNzYWdlOmUubWVzc2FnZX0saWQ6dC5pZCxyZXN1bHQ6bnVsbH0pfX0pKX0pP28uY2FsbCh0LHIsdCxlKTpvKXx8KGUuZXhwb3J0cz1pKX19LHQ9e307ZnVuY3Rpb24gcihvKXt2YXIgaT10W29dO2lmKHZvaWQgMCE9PWkpcmV0dXJuIGkuZXhwb3J0czt2YXIgbj10W29dPXtleHBvcnRzOnt9fTtyZXR1cm4gZVtvXShuLG4uZXhwb3J0cyxyKSxuLmV4cG9ydHN9ci5uPWU9Pnt2YXIgdD1lJiZlLl9fZXNNb2R1bGU/KCk9PmUuZGVmYXVsdDooKT0+ZTtyZXR1cm4gci5kKHQse2E6dH0pLHR9LHIuZD0oZSx0KT0+e2Zvcih2YXIgbyBpbiB0KXIubyh0LG8pJiYhci5vKGUsbykmJk9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8se2VudW1lcmFibGU6ITAsZ2V0OnRbb119KX0sci5vPShlLHQpPT5PYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSx0KSwoKCk9PntcInVzZSBzdHJpY3RcIjtyKDQ3Mil9KSgpfSkoKTsiOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm1heC1saW5lLWxlbmd0aAoKICAgIHZhciBsb2FkT3JSZXR1cm5Ccm9rZXIgPSBjcmVhdGVMb2FkT3JSZXR1cm5Ccm9rZXIod29ya2VyVGltZXJzQnJva2VyLmxvYWQsIHdvcmtlcik7CiAgICB2YXIgY2xlYXJJbnRlcnZhbCA9IGZ1bmN0aW9uIGNsZWFySW50ZXJ2YWwodGltZXJJZCkgewogICAgICByZXR1cm4gbG9hZE9yUmV0dXJuQnJva2VyKCkuY2xlYXJJbnRlcnZhbCh0aW1lcklkKTsKICAgIH07CiAgICB2YXIgY2xlYXJUaW1lb3V0ID0gZnVuY3Rpb24gY2xlYXJUaW1lb3V0KHRpbWVySWQpIHsKICAgICAgcmV0dXJuIGxvYWRPclJldHVybkJyb2tlcigpLmNsZWFyVGltZW91dCh0aW1lcklkKTsKICAgIH07CiAgICB2YXIgc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbiBzZXRJbnRlcnZhbCgpIHsKICAgICAgdmFyIF9sb2FkT3JSZXR1cm5Ccm9rZXI7CiAgICAgIHJldHVybiAoX2xvYWRPclJldHVybkJyb2tlciA9IGxvYWRPclJldHVybkJyb2tlcigpKS5zZXRJbnRlcnZhbC5hcHBseShfbG9hZE9yUmV0dXJuQnJva2VyLCBhcmd1bWVudHMpOwogICAgfTsKICAgIHZhciBzZXRUaW1lb3V0JDEgPSBmdW5jdGlvbiBzZXRUaW1lb3V0KCkgewogICAgICB2YXIgX2xvYWRPclJldHVybkJyb2tlcjI7CiAgICAgIHJldHVybiAoX2xvYWRPclJldHVybkJyb2tlcjIgPSBsb2FkT3JSZXR1cm5Ccm9rZXIoKSkuc2V0VGltZW91dC5hcHBseShfbG9hZE9yUmV0dXJuQnJva2VyMiwgYXJndW1lbnRzKTsKICAgIH07CiAgICBleHBvcnRzLmNsZWFySW50ZXJ2YWwgPSBjbGVhckludGVydmFsOwogICAgZXhwb3J0cy5jbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICBleHBvcnRzLnNldEludGVydmFsID0gc2V0SW50ZXJ2YWw7CiAgICBleHBvcnRzLnNldFRpbWVvdXQgPSBzZXRUaW1lb3V0JDE7CiAgfSk7Cn0pKGJ1bmRsZSQxLCBidW5kbGUkMS5leHBvcnRzKTsKdmFyIGJ1bmRsZUV4cG9ydHMgPSBidW5kbGUkMS5leHBvcnRzOwoKdmFyIF9fY3JlYXRlQmluZGluZyQxID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobSwgayk7CiAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICBkZXNjID0gewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbVtrXTsKICAgICAgfQogICAgfTsKICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCBkZXNjKTsKfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7CiAgb1trMl0gPSBtW2tdOwp9KTsKdmFyIF9fc2V0TW9kdWxlRGVmYXVsdCQxID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgdmFsdWU6IHYKICB9KTsKfSA6IGZ1bmN0aW9uIChvLCB2KSB7CiAgb1siZGVmYXVsdCJdID0gdjsKfSk7CnZhciBfX2ltcG9ydFN0YXIkMSA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0U3RhciB8fCBmdW5jdGlvbiAoKSB7CiAgdmFyIG93bktleXMgPSBmdW5jdGlvbiAobykgewogICAgb3duS2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzIHx8IGZ1bmN0aW9uIChvKSB7CiAgICAgIHZhciBhciA9IFtdOwogICAgICBmb3IgKHZhciBrIGluIG8pIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobywgaykpIGFyW2FyLmxlbmd0aF0gPSBrOwogICAgICByZXR1cm4gYXI7CiAgICB9OwogICAgcmV0dXJuIG93bktleXMobyk7CiAgfTsKICByZXR1cm4gZnVuY3Rpb24gKG1vZCkgewogICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgcmV0dXJuIG1vZDsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmIChtb2QgIT0gbnVsbCkgZm9yICh2YXIgayA9IG93bktleXMobW9kKSwgaSA9IDA7IGkgPCBrLmxlbmd0aDsgaSsrKSBpZiAoa1tpXSAhPT0gImRlZmF1bHQiKSBfX2NyZWF0ZUJpbmRpbmckMShyZXN1bHQsIG1vZCwga1tpXSk7CiAgICBfX3NldE1vZHVsZURlZmF1bHQkMShyZXN1bHQsIG1vZCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07Cn0oKTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGdldFRpbWVyJDEsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBpc19icm93c2VyXzEkMiA9IF9faW1wb3J0U3RhciQxKGlzQnJvd3NlciQxKTsKY29uc3Qgd29ya2VyX3RpbWVyc18xID0gYnVuZGxlRXhwb3J0czsKY29uc3Qgd29ya2VyVGltZXIgPSB7CiAgc2V0OiB3b3JrZXJfdGltZXJzXzEuc2V0SW50ZXJ2YWwsCiAgY2xlYXI6IHdvcmtlcl90aW1lcnNfMS5jbGVhckludGVydmFsCn07CmNvbnN0IG5hdGl2ZVRpbWVyID0gewogIHNldDogKGZ1bmMsIHRpbWUpID0+IHNldEludGVydmFsKGZ1bmMsIHRpbWUpLAogIGNsZWFyOiB0aW1lcklkID0+IGNsZWFySW50ZXJ2YWwodGltZXJJZCkKfTsKY29uc3QgZ2V0VGltZXIgPSB2YXJpYW50ID0+IHsKICBzd2l0Y2ggKHZhcmlhbnQpIHsKICAgIGNhc2UgJ25hdGl2ZSc6CiAgICAgIHsKICAgICAgICByZXR1cm4gbmF0aXZlVGltZXI7CiAgICAgIH0KICAgIGNhc2UgJ3dvcmtlcic6CiAgICAgIHsKICAgICAgICByZXR1cm4gd29ya2VyVGltZXI7CiAgICAgIH0KICAgIGNhc2UgJ2F1dG8nOgogICAgZGVmYXVsdDoKICAgICAgewogICAgICAgIHJldHVybiBpc19icm93c2VyXzEkMi5kZWZhdWx0ICYmICFpc19icm93c2VyXzEkMi5pc1dlYldvcmtlciAmJiAhaXNfYnJvd3Nlcl8xJDIuaXNSZWFjdE5hdGl2ZUJyb3dzZXIgPyB3b3JrZXJUaW1lciA6IG5hdGl2ZVRpbWVyOwogICAgICB9CiAgfQp9OwpnZXRUaW1lciQxLmRlZmF1bHQgPSBnZXRUaW1lcjsKCnZhciBfX2ltcG9ydERlZmF1bHQkMiA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0RGVmYXVsdCB8fCBmdW5jdGlvbiAobW9kKSB7CiAgcmV0dXJuIG1vZCAmJiBtb2QuX19lc01vZHVsZSA/IG1vZCA6IHsKICAgICJkZWZhdWx0IjogbW9kCiAgfTsKfTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KEtlZXBhbGl2ZU1hbmFnZXIkMSwgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmNvbnN0IGdldF90aW1lcl8xID0gX19pbXBvcnREZWZhdWx0JDIoZ2V0VGltZXIkMSk7CmNsYXNzIEtlZXBhbGl2ZU1hbmFnZXIgewogIGdldCBrZWVwYWxpdmVUaW1lb3V0VGltZXN0YW1wKCkgewogICAgcmV0dXJuIHRoaXMuX2tlZXBhbGl2ZVRpbWVvdXRUaW1lc3RhbXA7CiAgfQogIGdldCBpbnRlcnZhbEV2ZXJ5KCkgewogICAgcmV0dXJuIHRoaXMuX2ludGVydmFsRXZlcnk7CiAgfQogIGdldCBrZWVwYWxpdmUoKSB7CiAgICByZXR1cm4gdGhpcy5fa2VlcGFsaXZlOwogIH0KICBjb25zdHJ1Y3RvcihjbGllbnQsIHZhcmlhbnQpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CiAgICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICAgIHRoaXMudGltZXIgPSB0eXBlb2YgdmFyaWFudCA9PT0gJ29iamVjdCcgJiYgJ3NldCcgaW4gdmFyaWFudCAmJiAnY2xlYXInIGluIHZhcmlhbnQgPyB2YXJpYW50IDogKDAsIGdldF90aW1lcl8xLmRlZmF1bHQpKHZhcmlhbnQpOwogICAgdGhpcy5zZXRLZWVwYWxpdmUoY2xpZW50Lm9wdGlvbnMua2VlcGFsaXZlKTsKICB9CiAgY2xlYXIoKSB7CiAgICBpZiAodGhpcy50aW1lcklkKSB7CiAgICAgIHRoaXMudGltZXIuY2xlYXIodGhpcy50aW1lcklkKTsKICAgICAgdGhpcy50aW1lcklkID0gbnVsbDsKICAgIH0KICB9CiAgc2V0S2VlcGFsaXZlKHZhbHVlKSB7CiAgICB2YWx1ZSAqPSAxMDAwOwogICAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8PSAwIHx8IHZhbHVlID4gMjE0NzQ4MzY0NykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEtlZXBhbGl2ZSB2YWx1ZSBtdXN0IGJlIGFuIGludGVnZXIgYmV0d2VlbiAwIGFuZCAyMTQ3NDgzNjQ3LiBQcm92aWRlZCB2YWx1ZSBpcyAke3ZhbHVlfWApOwogICAgfQogICAgdGhpcy5fa2VlcGFsaXZlID0gdmFsdWU7CiAgICB0aGlzLnJlc2NoZWR1bGUoKTsKICAgIHRoaXMuY2xpZW50Wydsb2cnXShgS2VlcGFsaXZlTWFuYWdlcjogc2V0IGtlZXBhbGl2ZSB0byAke3ZhbHVlfW1zYCk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmNsZWFyKCk7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgfQogIHJlc2NoZWR1bGUoKSB7CiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5jbGVhcigpOwogICAgdGhpcy5jb3VudGVyID0gMDsKICAgIGNvbnN0IGtlZXBBbGl2ZVRpbWVvdXQgPSBNYXRoLmNlaWwodGhpcy5fa2VlcGFsaXZlICogMS41KTsKICAgIHRoaXMuX2tlZXBhbGl2ZVRpbWVvdXRUaW1lc3RhbXAgPSBEYXRlLm5vdygpICsga2VlcEFsaXZlVGltZW91dDsKICAgIHRoaXMuX2ludGVydmFsRXZlcnkgPSBNYXRoLmNlaWwodGhpcy5fa2VlcGFsaXZlIC8gMik7CiAgICB0aGlzLnRpbWVySWQgPSB0aGlzLnRpbWVyLnNldCgoKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLmNvdW50ZXIgKz0gMTsKICAgICAgaWYgKHRoaXMuY291bnRlciA9PT0gMikgewogICAgICAgIHRoaXMuY2xpZW50LnNlbmRQaW5nKCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5jb3VudGVyID4gMikgewogICAgICAgIHRoaXMuY2xpZW50Lm9uS2VlcGFsaXZlVGltZW91dCgpOwogICAgICB9CiAgICB9LCB0aGlzLl9pbnRlcnZhbEV2ZXJ5KTsKICB9Cn0KS2VlcGFsaXZlTWFuYWdlciQxLmRlZmF1bHQgPSBLZWVwYWxpdmVNYW5hZ2VyOwoKdmFyIF9fY3JlYXRlQmluZGluZyA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7CiAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogIGlmICghZGVzYyB8fCAoImdldCIgaW4gZGVzYyA/ICFtLl9fZXNNb2R1bGUgOiBkZXNjLndyaXRhYmxlIHx8IGRlc2MuY29uZmlndXJhYmxlKSkgewogICAgZGVzYyA9IHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG1ba107CiAgICAgIH0KICAgIH07CiAgfQogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7Cn0gOiBmdW5jdGlvbiAobywgbSwgaywgazIpIHsKICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogIG9bazJdID0gbVtrXTsKfSk7CnZhciBfX3NldE1vZHVsZURlZmF1bHQgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX3NldE1vZHVsZURlZmF1bHQgfHwgKE9iamVjdC5jcmVhdGUgPyBmdW5jdGlvbiAobywgdikgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogdgogIH0pOwp9IDogZnVuY3Rpb24gKG8sIHYpIHsKICBvWyJkZWZhdWx0Il0gPSB2Owp9KTsKdmFyIF9faW1wb3J0U3RhciA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0U3RhciB8fCBmdW5jdGlvbiAoKSB7CiAgdmFyIG93bktleXMgPSBmdW5jdGlvbiAobykgewogICAgb3duS2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzIHx8IGZ1bmN0aW9uIChvKSB7CiAgICAgIHZhciBhciA9IFtdOwogICAgICBmb3IgKHZhciBrIGluIG8pIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobywgaykpIGFyW2FyLmxlbmd0aF0gPSBrOwogICAgICByZXR1cm4gYXI7CiAgICB9OwogICAgcmV0dXJuIG93bktleXMobyk7CiAgfTsKICByZXR1cm4gZnVuY3Rpb24gKG1vZCkgewogICAgaWYgKG1vZCAmJiBtb2QuX19lc01vZHVsZSkgcmV0dXJuIG1vZDsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGlmIChtb2QgIT0gbnVsbCkgZm9yICh2YXIgayA9IG93bktleXMobW9kKSwgaSA9IDA7IGkgPCBrLmxlbmd0aDsgaSsrKSBpZiAoa1tpXSAhPT0gImRlZmF1bHQiKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGtbaV0pOwogICAgX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKfSgpOwp2YXIgX19pbXBvcnREZWZhdWx0JDEgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAiZGVmYXVsdCI6IG1vZAogIH07Cn07Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShjbGllbnQsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCB0b3BpY19hbGlhc19yZWN2XzEgPSBfX2ltcG9ydERlZmF1bHQkMSh0b3BpY0FsaWFzUmVjdik7CmNvbnN0IG1xdHRfcGFja2V0XzEgPSBfX2ltcG9ydERlZmF1bHQkMShtcXR0JDEpOwpjb25zdCBkZWZhdWx0X21lc3NhZ2VfaWRfcHJvdmlkZXJfMSA9IF9faW1wb3J0RGVmYXVsdCQxKGRlZmF1bHRNZXNzYWdlSWRQcm92aWRlcik7CmNvbnN0IHJlYWRhYmxlX3N0cmVhbV8xID0gb3Vyc0V4cG9ydHM7CmNvbnN0IGRlZmF1bHRfMSA9IF9faW1wb3J0RGVmYXVsdCQxKF9kZWZhdWx0KTsKY29uc3QgdmFsaWRhdGlvbnMgPSBfX2ltcG9ydFN0YXIodmFsaWRhdGlvbnMkMSk7CmNvbnN0IGRlYnVnXzEkMSA9IF9faW1wb3J0RGVmYXVsdCQxKHNyY0V4cG9ydHMpOwpjb25zdCBzdG9yZV8xID0gX19pbXBvcnREZWZhdWx0JDEoc3RvcmUpOwpjb25zdCBoYW5kbGVyc18xID0gX19pbXBvcnREZWZhdWx0JDEoaGFuZGxlcnMpOwpjb25zdCBzaGFyZWRfMSA9IHNoYXJlZDsKY29uc3QgVHlwZWRFbWl0dGVyXzEgPSBUeXBlZEVtaXR0ZXI7CmNvbnN0IEtlZXBhbGl2ZU1hbmFnZXJfMSA9IF9faW1wb3J0RGVmYXVsdCQxKEtlZXBhbGl2ZU1hbmFnZXIkMSk7CmNvbnN0IGlzX2Jyb3dzZXJfMSQxID0gX19pbXBvcnRTdGFyKGlzQnJvd3NlciQxKTsKY29uc3Qgc2V0SW1tZWRpYXRlJDEgPSBnbG9iYWxUaGlzLnNldEltbWVkaWF0ZSB8fCAoKC4uLmFyZ3MpID0+IHsKICBjb25zdCBjYWxsYmFjayA9IGFyZ3Muc2hpZnQoKTsKICAoMCwgc2hhcmVkXzEubmV4dFRpY2spKCgpID0+IHsKICAgIGNhbGxiYWNrKC4uLmFyZ3MpOwogIH0pOwp9KTsKY29uc3QgZGVmYXVsdENvbm5lY3RPcHRpb25zID0gewogIGtlZXBhbGl2ZTogNjAsCiAgcmVzY2hlZHVsZVBpbmdzOiB0cnVlLAogIHByb3RvY29sSWQ6ICdNUVRUJywKICBwcm90b2NvbFZlcnNpb246IDQsCiAgcmVjb25uZWN0UGVyaW9kOiAxMDAwLAogIGNvbm5lY3RUaW1lb3V0OiAzMCAqIDEwMDAsCiAgY2xlYW46IHRydWUsCiAgcmVzdWJzY3JpYmU6IHRydWUsCiAgd3JpdGVDYWNoZTogdHJ1ZSwKICB0aW1lclZhcmlhbnQ6ICdhdXRvJwp9OwpjbGFzcyBNcXR0Q2xpZW50IGV4dGVuZHMgVHlwZWRFbWl0dGVyXzEuVHlwZWRFdmVudEVtaXR0ZXIgewogIHN0YXRpYyBkZWZhdWx0SWQoKSB7CiAgICByZXR1cm4gYG1xdHRqc18ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cigyLCA4KX1gOwogIH0KICBjb25zdHJ1Y3RvcihzdHJlYW1CdWlsZGVyLCBvcHRpb25zKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIGZvciAoY29uc3QgayBpbiBkZWZhdWx0Q29ubmVjdE9wdGlvbnMpIHsKICAgICAgaWYgKHR5cGVvZiB0aGlzLm9wdGlvbnNba10gPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgdGhpcy5vcHRpb25zW2tdID0gZGVmYXVsdENvbm5lY3RPcHRpb25zW2tdOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3B0aW9uc1trXSA9IG9wdGlvbnNba107CiAgICAgIH0KICAgIH0KICAgIHRoaXMubG9nID0gdGhpcy5vcHRpb25zLmxvZyB8fCAoMCwgZGVidWdfMSQxLmRlZmF1bHQpKCdtcXR0anM6Y2xpZW50Jyk7CiAgICB0aGlzLm5vb3AgPSB0aGlzLl9ub29wLmJpbmQodGhpcyk7CiAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiB2ZXJzaW9uOicsIE1xdHRDbGllbnQuVkVSU0lPTik7CiAgICBpZiAoaXNfYnJvd3Nlcl8xJDEuaXNXZWJXb3JrZXIpIHsKICAgICAgdGhpcy5sb2coJ01xdHRDbGllbnQgOjogZW52aXJvbm1lbnQnLCAnd2Vid29ya2VyJyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBlbnZpcm9ubWVudCcsIGlzX2Jyb3dzZXJfMSQxLmRlZmF1bHQgPyAnYnJvd3NlcicgOiAnbm9kZScpOwogICAgfQogICAgdGhpcy5sb2coJ01xdHRDbGllbnQgOjogb3B0aW9ucy5wcm90b2NvbCcsIG9wdGlvbnMucHJvdG9jb2wpOwogICAgdGhpcy5sb2coJ01xdHRDbGllbnQgOjogb3B0aW9ucy5wcm90b2NvbFZlcnNpb24nLCBvcHRpb25zLnByb3RvY29sVmVyc2lvbik7CiAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBvcHRpb25zLnVzZXJuYW1lJywgb3B0aW9ucy51c2VybmFtZSk7CiAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBvcHRpb25zLmtlZXBhbGl2ZScsIG9wdGlvbnMua2VlcGFsaXZlKTsKICAgIHRoaXMubG9nKCdNcXR0Q2xpZW50IDo6IG9wdGlvbnMucmVjb25uZWN0UGVyaW9kJywgb3B0aW9ucy5yZWNvbm5lY3RQZXJpb2QpOwogICAgdGhpcy5sb2coJ01xdHRDbGllbnQgOjogb3B0aW9ucy5yZWplY3RVbmF1dGhvcml6ZWQnLCBvcHRpb25zLnJlamVjdFVuYXV0aG9yaXplZCk7CiAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0nLCBvcHRpb25zLnByb3BlcnRpZXMgPyBvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0gOiB1bmRlZmluZWQpOwogICAgdGhpcy5vcHRpb25zLmNsaWVudElkID0gdHlwZW9mIG9wdGlvbnMuY2xpZW50SWQgPT09ICdzdHJpbmcnID8gb3B0aW9ucy5jbGllbnRJZCA6IE1xdHRDbGllbnQuZGVmYXVsdElkKCk7CiAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBjbGllbnRJZCcsIHRoaXMub3B0aW9ucy5jbGllbnRJZCk7CiAgICB0aGlzLm9wdGlvbnMuY3VzdG9tSGFuZGxlQWNrcyA9IG9wdGlvbnMucHJvdG9jb2xWZXJzaW9uID09PSA1ICYmIG9wdGlvbnMuY3VzdG9tSGFuZGxlQWNrcyA/IG9wdGlvbnMuY3VzdG9tSGFuZGxlQWNrcyA6ICguLi5hcmdzKSA9PiB7CiAgICAgIGFyZ3NbM10obnVsbCwgMCk7CiAgICB9OwogICAgaWYgKCF0aGlzLm9wdGlvbnMud3JpdGVDYWNoZSkgewogICAgICBtcXR0X3BhY2tldF8xLmRlZmF1bHQud3JpdGVUb1N0cmVhbS5jYWNoZU51bWJlcnMgPSBmYWxzZTsKICAgIH0KICAgIHRoaXMuc3RyZWFtQnVpbGRlciA9IHN0cmVhbUJ1aWxkZXI7CiAgICB0aGlzLm1lc3NhZ2VJZFByb3ZpZGVyID0gdHlwZW9mIHRoaXMub3B0aW9ucy5tZXNzYWdlSWRQcm92aWRlciA9PT0gJ3VuZGVmaW5lZCcgPyBuZXcgZGVmYXVsdF9tZXNzYWdlX2lkX3Byb3ZpZGVyXzEuZGVmYXVsdCgpIDogdGhpcy5vcHRpb25zLm1lc3NhZ2VJZFByb3ZpZGVyOwogICAgdGhpcy5vdXRnb2luZ1N0b3JlID0gb3B0aW9ucy5vdXRnb2luZ1N0b3JlIHx8IG5ldyBzdG9yZV8xLmRlZmF1bHQoKTsKICAgIHRoaXMuaW5jb21pbmdTdG9yZSA9IG9wdGlvbnMuaW5jb21pbmdTdG9yZSB8fCBuZXcgc3RvcmVfMS5kZWZhdWx0KCk7CiAgICB0aGlzLnF1ZXVlUW9TWmVybyA9IG9wdGlvbnMucXVldWVRb1NaZXJvID09PSB1bmRlZmluZWQgPyB0cnVlIDogb3B0aW9ucy5xdWV1ZVFvU1plcm87CiAgICB0aGlzLl9yZXN1YnNjcmliZVRvcGljcyA9IHt9OwogICAgdGhpcy5tZXNzYWdlSWRUb1RvcGljID0ge307CiAgICB0aGlzLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTsKICAgIHRoaXMuZGlzY29ubmVjdGluZyA9IGZhbHNlOwogICAgdGhpcy5yZWNvbm5lY3RpbmcgPSBmYWxzZTsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHRoaXMuY29ubmFja1RpbWVyID0gbnVsbDsKICAgIHRoaXMucmVjb25uZWN0VGltZXIgPSBudWxsOwogICAgdGhpcy5fc3RvcmVQcm9jZXNzaW5nID0gZmFsc2U7CiAgICB0aGlzLl9wYWNrZXRJZHNEdXJpbmdTdG9yZVByb2Nlc3NpbmcgPSB7fTsKICAgIHRoaXMuX3N0b3JlUHJvY2Vzc2luZ1F1ZXVlID0gW107CiAgICB0aGlzLm91dGdvaW5nID0ge307CiAgICB0aGlzLl9maXJzdENvbm5lY3Rpb24gPSB0cnVlOwogICAgaWYgKG9wdGlvbnMucHJvcGVydGllcyAmJiBvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0gPiAwKSB7CiAgICAgIGlmIChvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0gPiAweGZmZmYpIHsKICAgICAgICB0aGlzLmxvZygnTXF0dENsaWVudCA6OiBvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0gaXMgb3V0IG9mIHJhbmdlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50b3BpY0FsaWFzUmVjdiA9IG5ldyB0b3BpY19hbGlhc19yZWN2XzEuZGVmYXVsdChvcHRpb25zLnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0pOwogICAgICB9CiAgICB9CiAgICB0aGlzLm9uKCdjb25uZWN0JywgKCkgPT4gewogICAgICBjb25zdCB7CiAgICAgICAgcXVldWUKICAgICAgfSA9IHRoaXM7CiAgICAgIGNvbnN0IGRlbGl2ZXIgPSAoKSA9PiB7CiAgICAgICAgY29uc3QgZW50cnkgPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgIHRoaXMubG9nKCdkZWxpdmVyIDo6IGVudHJ5ICVvJywgZW50cnkpOwogICAgICAgIGxldCBwYWNrZXQgPSBudWxsOwogICAgICAgIGlmICghZW50cnkpIHsKICAgICAgICAgIHRoaXMuX3Jlc3Vic2NyaWJlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBhY2tldCA9IGVudHJ5LnBhY2tldDsKICAgICAgICB0aGlzLmxvZygnZGVsaXZlciA6OiBjYWxsIF9zZW5kUGFja2V0IGZvciAlbycsIHBhY2tldCk7CiAgICAgICAgbGV0IHNlbmQgPSB0cnVlOwogICAgICAgIGlmIChwYWNrZXQubWVzc2FnZUlkICYmIHBhY2tldC5tZXNzYWdlSWQgIT09IDApIHsKICAgICAgICAgIGlmICghdGhpcy5tZXNzYWdlSWRQcm92aWRlci5yZWdpc3RlcihwYWNrZXQubWVzc2FnZUlkKSkgewogICAgICAgICAgICBzZW5kID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzZW5kKSB7CiAgICAgICAgICB0aGlzLl9zZW5kUGFja2V0KHBhY2tldCwgZXJyID0+IHsKICAgICAgICAgICAgaWYgKGVudHJ5LmNiKSB7CiAgICAgICAgICAgICAgZW50cnkuY2IoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxpdmVyKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5sb2coJ21lc3NhZ2VJZDogJWQgaGFzIGFscmVhZHkgdXNlZC4gVGhlIG1lc3NhZ2UgaXMgc2tpcHBlZCBhbmQgcmVtb3ZlZC4nLCBwYWNrZXQubWVzc2FnZUlkKTsKICAgICAgICAgIGRlbGl2ZXIoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMubG9nKCdjb25uZWN0IDo6IHNlbmRpbmcgcXVldWVkIHBhY2tldHMnKTsKICAgICAgZGVsaXZlcigpOwogICAgfSk7CiAgICB0aGlzLm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgdGhpcy5sb2coJ2Nsb3NlIDo6IGNvbm5lY3RlZCBzZXQgdG8gYGZhbHNlYCcpOwogICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlOwogICAgICB0aGlzLmxvZygnY2xvc2UgOjogY2xlYXJpbmcgY29ubmFja1RpbWVyJyk7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLmNvbm5hY2tUaW1lcik7CiAgICAgIHRoaXMuX2Rlc3Ryb3lLZWVwYWxpdmVNYW5hZ2VyKCk7CiAgICAgIGlmICh0aGlzLnRvcGljQWxpYXNSZWN2KSB7CiAgICAgICAgdGhpcy50b3BpY0FsaWFzUmVjdi5jbGVhcigpOwogICAgICB9CiAgICAgIHRoaXMubG9nKCdjbG9zZSA6OiBjYWxsaW5nIF9zZXR1cFJlY29ubmVjdCcpOwogICAgICB0aGlzLl9zZXR1cFJlY29ubmVjdCgpOwogICAgfSk7CiAgICBpZiAoIXRoaXMub3B0aW9ucy5tYW51YWxDb25uZWN0KSB7CiAgICAgIHRoaXMubG9nKCdNcXR0Q2xpZW50IDo6IHNldHRpbmcgdXAgc3RyZWFtJyk7CiAgICAgIHRoaXMuY29ubmVjdCgpOwogICAgfQogIH0KICBoYW5kbGVBdXRoKHBhY2tldCwgY2FsbGJhY2spIHsKICAgIGNhbGxiYWNrKCk7CiAgfQogIGhhbmRsZU1lc3NhZ2UocGFja2V0LCBjYWxsYmFjaykgewogICAgY2FsbGJhY2soKTsKICB9CiAgX25leHRJZCgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VJZFByb3ZpZGVyLmFsbG9jYXRlKCk7CiAgfQogIGdldExhc3RNZXNzYWdlSWQoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSWRQcm92aWRlci5nZXRMYXN0QWxsb2NhdGVkKCk7CiAgfQogIGNvbm5lY3QoKSB7CiAgICB2YXIgX2E7CiAgICBjb25zdCB3cml0YWJsZSA9IG5ldyByZWFkYWJsZV9zdHJlYW1fMS5Xcml0YWJsZSgpOwogICAgY29uc3QgcGFyc2VyID0gbXF0dF9wYWNrZXRfMS5kZWZhdWx0LnBhcnNlcih0aGlzLm9wdGlvbnMpOwogICAgbGV0IGNvbXBsZXRlUGFyc2UgPSBudWxsOwogICAgY29uc3QgcGFja2V0cyA9IFtdOwogICAgdGhpcy5sb2coJ2Nvbm5lY3QgOjogY2FsbGluZyBtZXRob2QgdG8gY2xlYXIgcmVjb25uZWN0Jyk7CiAgICB0aGlzLl9jbGVhclJlY29ubmVjdCgpOwogICAgaWYgKHRoaXMuZGlzY29ubmVjdGVkICYmICF0aGlzLnJlY29ubmVjdGluZykgewogICAgICB0aGlzLmluY29taW5nU3RvcmUgPSB0aGlzLm9wdGlvbnMuaW5jb21pbmdTdG9yZSB8fCBuZXcgc3RvcmVfMS5kZWZhdWx0KCk7CiAgICAgIHRoaXMub3V0Z29pbmdTdG9yZSA9IHRoaXMub3B0aW9ucy5vdXRnb2luZ1N0b3JlIHx8IG5ldyBzdG9yZV8xLmRlZmF1bHQoKTsKICAgICAgdGhpcy5kaXNjb25uZWN0aW5nID0gZmFsc2U7CiAgICAgIHRoaXMuZGlzY29ubmVjdGVkID0gZmFsc2U7CiAgICB9CiAgICB0aGlzLmxvZygnY29ubmVjdCA6OiB1c2luZyBzdHJlYW1CdWlsZGVyIHByb3ZpZGVkIHRvIGNsaWVudCB0byBjcmVhdGUgc3RyZWFtJyk7CiAgICB0aGlzLnN0cmVhbSA9IHRoaXMuc3RyZWFtQnVpbGRlcih0aGlzKTsKICAgIHBhcnNlci5vbigncGFja2V0JywgcGFja2V0ID0+IHsKICAgICAgdGhpcy5sb2coJ3BhcnNlciA6OiBvbiBwYWNrZXQgcHVzaCB0byBwYWNrZXRzIGFycmF5LicpOwogICAgICBwYWNrZXRzLnB1c2gocGFja2V0KTsKICAgIH0pOwogICAgY29uc3Qgd29yayA9ICgpID0+IHsKICAgICAgdGhpcy5sb2coJ3dvcmsgOjogZ2V0dGluZyBuZXh0IHBhY2tldCBpbiBxdWV1ZScpOwogICAgICBjb25zdCBwYWNrZXQgPSBwYWNrZXRzLnNoaWZ0KCk7CiAgICAgIGlmIChwYWNrZXQpIHsKICAgICAgICB0aGlzLmxvZygnd29yayA6OiBwYWNrZXQgcHVsbGVkIGZyb20gcXVldWUnKTsKICAgICAgICAoMCwgaGFuZGxlcnNfMS5kZWZhdWx0KSh0aGlzLCBwYWNrZXQsIG5leHRUaWNrV29yayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5sb2coJ3dvcmsgOjogbm8gcGFja2V0cyBpbiBxdWV1ZScpOwogICAgICAgIGNvbnN0IGRvbmUgPSBjb21wbGV0ZVBhcnNlOwogICAgICAgIGNvbXBsZXRlUGFyc2UgPSBudWxsOwogICAgICAgIHRoaXMubG9nKCd3b3JrIDo6IGRvbmUgZmxhZyBpcyAlcycsICEhZG9uZSk7CiAgICAgICAgaWYgKGRvbmUpIGRvbmUoKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IG5leHRUaWNrV29yayA9ICgpID0+IHsKICAgICAgaWYgKHBhY2tldHMubGVuZ3RoKSB7CiAgICAgICAgKDAsIHNoYXJlZF8xLm5leHRUaWNrKSh3b3JrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBkb25lID0gY29tcGxldGVQYXJzZTsKICAgICAgICBjb21wbGV0ZVBhcnNlID0gbnVsbDsKICAgICAgICBkb25lKCk7CiAgICAgIH0KICAgIH07CiAgICB3cml0YWJsZS5fd3JpdGUgPSAoYnVmLCBlbmMsIGRvbmUpID0+IHsKICAgICAgY29tcGxldGVQYXJzZSA9IGRvbmU7CiAgICAgIHRoaXMubG9nKCd3cml0YWJsZSBzdHJlYW0gOjogcGFyc2luZyBidWZmZXInKTsKICAgICAgcGFyc2VyLnBhcnNlKGJ1Zik7CiAgICAgIHdvcmsoKTsKICAgIH07CiAgICBjb25zdCBzdHJlYW1FcnJvckhhbmRsZXIgPSBlcnJvciA9PiB7CiAgICAgIHRoaXMubG9nKCdzdHJlYW1FcnJvckhhbmRsZXIgOjogZXJyb3InLCBlcnJvci5tZXNzYWdlKTsKICAgICAgaWYgKGVycm9yLmNvZGUpIHsKICAgICAgICB0aGlzLmxvZygnc3RyZWFtRXJyb3JIYW5kbGVyIDo6IGVtaXR0aW5nIGVycm9yJyk7CiAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycm9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm5vb3AoZXJyb3IpOwogICAgICB9CiAgICB9OwogICAgdGhpcy5sb2coJ2Nvbm5lY3QgOjogcGlwZSBzdHJlYW0gdG8gd3JpdGFibGUgc3RyZWFtJyk7CiAgICB0aGlzLnN0cmVhbS5waXBlKHdyaXRhYmxlKTsKICAgIHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIHN0cmVhbUVycm9ySGFuZGxlcik7CiAgICB0aGlzLnN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7CiAgICAgIHRoaXMubG9nKCcoJXMpc3RyZWFtIDo6IG9uIGNsb3NlJywgdGhpcy5vcHRpb25zLmNsaWVudElkKTsKICAgICAgdGhpcy5fZmx1c2hWb2xhdGlsZSgpOwogICAgICB0aGlzLmxvZygnc3RyZWFtOiBlbWl0IGNsb3NlIHRvIE1xdHRDbGllbnQnKTsKICAgICAgdGhpcy5lbWl0KCdjbG9zZScpOwogICAgfSk7CiAgICB0aGlzLmxvZygnY29ubmVjdDogc2VuZGluZyBwYWNrZXQgYGNvbm5lY3RgJyk7CiAgICBjb25zdCBjb25uZWN0UGFja2V0ID0gewogICAgICBjbWQ6ICdjb25uZWN0JywKICAgICAgcHJvdG9jb2xJZDogdGhpcy5vcHRpb25zLnByb3RvY29sSWQsCiAgICAgIHByb3RvY29sVmVyc2lvbjogdGhpcy5vcHRpb25zLnByb3RvY29sVmVyc2lvbiwKICAgICAgY2xlYW46IHRoaXMub3B0aW9ucy5jbGVhbiwKICAgICAgY2xpZW50SWQ6IHRoaXMub3B0aW9ucy5jbGllbnRJZCwKICAgICAga2VlcGFsaXZlOiB0aGlzLm9wdGlvbnMua2VlcGFsaXZlLAogICAgICB1c2VybmFtZTogdGhpcy5vcHRpb25zLnVzZXJuYW1lLAogICAgICBwYXNzd29yZDogdGhpcy5vcHRpb25zLnBhc3N3b3JkLAogICAgICBwcm9wZXJ0aWVzOiB0aGlzLm9wdGlvbnMucHJvcGVydGllcwogICAgfTsKICAgIGlmICh0aGlzLm9wdGlvbnMud2lsbCkgewogICAgICBjb25uZWN0UGFja2V0LndpbGwgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0aW9ucy53aWxsKSwgewogICAgICAgIHBheWxvYWQ6IChfYSA9IHRoaXMub3B0aW9ucy53aWxsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGF5bG9hZAogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLnRvcGljQWxpYXNSZWN2KSB7CiAgICAgIGlmICghY29ubmVjdFBhY2tldC5wcm9wZXJ0aWVzKSB7CiAgICAgICAgY29ubmVjdFBhY2tldC5wcm9wZXJ0aWVzID0ge307CiAgICAgIH0KICAgICAgaWYgKHRoaXMudG9waWNBbGlhc1JlY3YpIHsKICAgICAgICBjb25uZWN0UGFja2V0LnByb3BlcnRpZXMudG9waWNBbGlhc01heGltdW0gPSB0aGlzLnRvcGljQWxpYXNSZWN2Lm1heDsKICAgICAgfQogICAgfQogICAgdGhpcy5fd3JpdGVQYWNrZXQoY29ubmVjdFBhY2tldCk7CiAgICBwYXJzZXIub24oJ2Vycm9yJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ2Vycm9yJykpOwogICAgaWYgKHRoaXMub3B0aW9ucy5wcm9wZXJ0aWVzKSB7CiAgICAgIGlmICghdGhpcy5vcHRpb25zLnByb3BlcnRpZXMuYXV0aGVudGljYXRpb25NZXRob2QgJiYgdGhpcy5vcHRpb25zLnByb3BlcnRpZXMuYXV0aGVudGljYXRpb25EYXRhKSB7CiAgICAgICAgdGhpcy5lbmQoKCkgPT4gdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignUGFja2V0IGhhcyBubyBBdXRoZW50aWNhdGlvbiBNZXRob2QnKSkpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmICh0aGlzLm9wdGlvbnMucHJvcGVydGllcy5hdXRoZW50aWNhdGlvbk1ldGhvZCAmJiB0aGlzLm9wdGlvbnMuYXV0aFBhY2tldCAmJiB0eXBlb2YgdGhpcy5vcHRpb25zLmF1dGhQYWNrZXQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgY29uc3QgYXV0aFBhY2tldCA9IE9iamVjdC5hc3NpZ24oewogICAgICAgICAgY21kOiAnYXV0aCcsCiAgICAgICAgICByZWFzb25Db2RlOiAwCiAgICAgICAgfSwgdGhpcy5vcHRpb25zLmF1dGhQYWNrZXQpOwogICAgICAgIHRoaXMuX3dyaXRlUGFja2V0KGF1dGhQYWNrZXQpOwogICAgICB9CiAgICB9CiAgICB0aGlzLnN0cmVhbS5zZXRNYXhMaXN0ZW5lcnMoMTAwMCk7CiAgICBjbGVhclRpbWVvdXQodGhpcy5jb25uYWNrVGltZXIpOwogICAgdGhpcy5jb25uYWNrVGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhpcy5sb2coJyEhY29ubmVjdFRpbWVvdXQgaGl0ISEgQ2FsbGluZyBfY2xlYW5VcCB3aXRoIGZvcmNlIGB0cnVlYCcpOwogICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdjb25uYWNrIHRpbWVvdXQnKSk7CiAgICAgIHRoaXMuX2NsZWFuVXAodHJ1ZSk7CiAgICB9LCB0aGlzLm9wdGlvbnMuY29ubmVjdFRpbWVvdXQpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHB1Ymxpc2godG9waWMsIG1lc3NhZ2UsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICB0aGlzLmxvZygncHVibGlzaCA6OiBtZXNzYWdlIGAlc2AgdG8gdG9waWMgYCVzYCcsIG1lc3NhZ2UsIHRvcGljKTsKICAgIGNvbnN0IHsKICAgICAgb3B0aW9ucwogICAgfSA9IHRoaXM7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgICBvcHRzID0gbnVsbDsKICAgIH0KICAgIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgY29uc3QgZGVmYXVsdE9wdHMgPSB7CiAgICAgIHFvczogMCwKICAgICAgcmV0YWluOiBmYWxzZSwKICAgICAgZHVwOiBmYWxzZQogICAgfTsKICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRzKSwgb3B0cyk7CiAgICBjb25zdCB7CiAgICAgIHFvcywKICAgICAgcmV0YWluLAogICAgICBkdXAsCiAgICAgIHByb3BlcnRpZXMsCiAgICAgIGNiU3RvcmVQdXQKICAgIH0gPSBvcHRzOwogICAgaWYgKHRoaXMuX2NoZWNrRGlzY29ubmVjdGluZyhjYWxsYmFjaykpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBwdWJsaXNoUHJvYyA9ICgpID0+IHsKICAgICAgbGV0IG1lc3NhZ2VJZCA9IDA7CiAgICAgIGlmIChxb3MgPT09IDEgfHwgcW9zID09PSAyKSB7CiAgICAgICAgbWVzc2FnZUlkID0gdGhpcy5fbmV4dElkKCk7CiAgICAgICAgaWYgKG1lc3NhZ2VJZCA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy5sb2coJ05vIG1lc3NhZ2VJZCBsZWZ0Jyk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHBhY2tldCA9IHsKICAgICAgICBjbWQ6ICdwdWJsaXNoJywKICAgICAgICB0b3BpYywKICAgICAgICBwYXlsb2FkOiBtZXNzYWdlLAogICAgICAgIHFvcywKICAgICAgICByZXRhaW4sCiAgICAgICAgbWVzc2FnZUlkLAogICAgICAgIGR1cAogICAgICB9OwogICAgICBpZiAob3B0aW9ucy5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgICAgICBwYWNrZXQucHJvcGVydGllcyA9IHByb3BlcnRpZXM7CiAgICAgIH0KICAgICAgdGhpcy5sb2coJ3B1Ymxpc2ggOjogcW9zJywgcW9zKTsKICAgICAgc3dpdGNoIChxb3MpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgdGhpcy5vdXRnb2luZ1twYWNrZXQubWVzc2FnZUlkXSA9IHsKICAgICAgICAgICAgdm9sYXRpbGU6IGZhbHNlLAogICAgICAgICAgICBjYjogY2FsbGJhY2sgfHwgdGhpcy5ub29wCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5sb2coJ01xdHRDbGllbnQ6cHVibGlzaDogcGFja2V0IGNtZDogJXMnLCBwYWNrZXQuY21kKTsKICAgICAgICAgIHRoaXMuX3NlbmRQYWNrZXQocGFja2V0LCB1bmRlZmluZWQsIGNiU3RvcmVQdXQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRoaXMubG9nKCdNcXR0Q2xpZW50OnB1Ymxpc2g6IHBhY2tldCBjbWQ6ICVzJywgcGFja2V0LmNtZCk7CiAgICAgICAgICB0aGlzLl9zZW5kUGFja2V0KHBhY2tldCwgY2FsbGJhY2ssIGNiU3RvcmVQdXQpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgaWYgKHRoaXMuX3N0b3JlUHJvY2Vzc2luZyB8fCB0aGlzLl9zdG9yZVByb2Nlc3NpbmdRdWV1ZS5sZW5ndGggPiAwIHx8ICFwdWJsaXNoUHJvYygpKSB7CiAgICAgIHRoaXMuX3N0b3JlUHJvY2Vzc2luZ1F1ZXVlLnB1c2goewogICAgICAgIGludm9rZTogcHVibGlzaFByb2MsCiAgICAgICAgY2JTdG9yZVB1dDogb3B0cy5jYlN0b3JlUHV0LAogICAgICAgIGNhbGxiYWNrCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHB1Ymxpc2hBc3luYyh0b3BpYywgbWVzc2FnZSwgb3B0cykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgdGhpcy5wdWJsaXNoKHRvcGljLCBtZXNzYWdlLCBvcHRzLCAoZXJyLCBwYWNrZXQpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZShwYWNrZXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgc3Vic2NyaWJlKHRvcGljT2JqZWN0LCBvcHRzLCBjYWxsYmFjaykgewogICAgY29uc3QgdmVyc2lvbiA9IHRoaXMub3B0aW9ucy5wcm90b2NvbFZlcnNpb247CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgfQogICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCB0aGlzLm5vb3A7CiAgICBsZXQgcmVzdWJzY3JpYmUgPSBmYWxzZTsKICAgIGxldCB0b3BpY3NMaXN0ID0gW107CiAgICBpZiAodHlwZW9mIHRvcGljT2JqZWN0ID09PSAnc3RyaW5nJykgewogICAgICB0b3BpY09iamVjdCA9IFt0b3BpY09iamVjdF07CiAgICAgIHRvcGljc0xpc3QgPSB0b3BpY09iamVjdDsKICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh0b3BpY09iamVjdCkpIHsKICAgICAgdG9waWNzTGlzdCA9IHRvcGljT2JqZWN0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdG9waWNPYmplY3QgPT09ICdvYmplY3QnKSB7CiAgICAgIHJlc3Vic2NyaWJlID0gdG9waWNPYmplY3QucmVzdWJzY3JpYmU7CiAgICAgIGRlbGV0ZSB0b3BpY09iamVjdC5yZXN1YnNjcmliZTsKICAgICAgdG9waWNzTGlzdCA9IE9iamVjdC5rZXlzKHRvcGljT2JqZWN0KTsKICAgIH0KICAgIGNvbnN0IGludmFsaWRUb3BpYyA9IHZhbGlkYXRpb25zLnZhbGlkYXRlVG9waWNzKHRvcGljc0xpc3QpOwogICAgaWYgKGludmFsaWRUb3BpYyAhPT0gbnVsbCkgewogICAgICBzZXRJbW1lZGlhdGUkMShjYWxsYmFjaywgbmV3IEVycm9yKGBJbnZhbGlkIHRvcGljICR7aW52YWxpZFRvcGljfWApKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBpZiAodGhpcy5fY2hlY2tEaXNjb25uZWN0aW5nKGNhbGxiYWNrKSkgewogICAgICB0aGlzLmxvZygnc3Vic2NyaWJlOiBkaXNjY29uZWN0aW5nIHRydWUnKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBkZWZhdWx0T3B0cyA9IHsKICAgICAgcW9zOiAwCiAgICB9OwogICAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgICAgZGVmYXVsdE9wdHMubmwgPSBmYWxzZTsKICAgICAgZGVmYXVsdE9wdHMucmFwID0gZmFsc2U7CiAgICAgIGRlZmF1bHRPcHRzLnJoID0gMDsKICAgIH0KICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRPcHRzKSwgb3B0cyk7CiAgICBjb25zdCBwcm9wZXJ0aWVzID0gb3B0cy5wcm9wZXJ0aWVzOwogICAgY29uc3Qgc3VicyA9IFtdOwogICAgY29uc3QgcGFyc2VTdWIgPSAodG9waWMsIHN1Yk9wdGlvbnMpID0+IHsKICAgICAgc3ViT3B0aW9ucyA9IHN1Yk9wdGlvbnMgfHwgb3B0czsKICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5fcmVzdWJzY3JpYmVUb3BpY3MsIHRvcGljKSB8fCB0aGlzLl9yZXN1YnNjcmliZVRvcGljc1t0b3BpY10ucW9zIDwgc3ViT3B0aW9ucy5xb3MgfHwgcmVzdWJzY3JpYmUpIHsKICAgICAgICBjb25zdCBjdXJyZW50T3B0cyA9IHsKICAgICAgICAgIHRvcGljLAogICAgICAgICAgcW9zOiBzdWJPcHRpb25zLnFvcwogICAgICAgIH07CiAgICAgICAgaWYgKHZlcnNpb24gPT09IDUpIHsKICAgICAgICAgIGN1cnJlbnRPcHRzLm5sID0gc3ViT3B0aW9ucy5ubDsKICAgICAgICAgIGN1cnJlbnRPcHRzLnJhcCA9IHN1Yk9wdGlvbnMucmFwOwogICAgICAgICAgY3VycmVudE9wdHMucmggPSBzdWJPcHRpb25zLnJoOwogICAgICAgICAgY3VycmVudE9wdHMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7CiAgICAgICAgfQogICAgICAgIHRoaXMubG9nKCdzdWJzY3JpYmU6IHB1c2hpbmcgdG9waWMgYCVzYCBhbmQgcW9zIGAlc2AgdG8gc3VicyBsaXN0JywgY3VycmVudE9wdHMudG9waWMsIGN1cnJlbnRPcHRzLnFvcyk7CiAgICAgICAgc3Vicy5wdXNoKGN1cnJlbnRPcHRzKTsKICAgICAgfQogICAgfTsKICAgIGlmIChBcnJheS5pc0FycmF5KHRvcGljT2JqZWN0KSkgewogICAgICB0b3BpY09iamVjdC5mb3JFYWNoKHRvcGljID0+IHsKICAgICAgICB0aGlzLmxvZygnc3Vic2NyaWJlOiBhcnJheSB0b3BpYyAlcycsIHRvcGljKTsKICAgICAgICBwYXJzZVN1Yih0b3BpYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgT2JqZWN0LmtleXModG9waWNPYmplY3QpLmZvckVhY2godG9waWMgPT4gewogICAgICAgIHRoaXMubG9nKCdzdWJzY3JpYmU6IG9iamVjdCB0b3BpYyAlcywgJW8nLCB0b3BpYywgdG9waWNPYmplY3RbdG9waWNdKTsKICAgICAgICBwYXJzZVN1Yih0b3BpYywgdG9waWNPYmplY3RbdG9waWNdKTsKICAgICAgfSk7CiAgICB9CiAgICBpZiAoIXN1YnMubGVuZ3RoKSB7CiAgICAgIGNhbGxiYWNrKG51bGwsIFtdKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBzdWJzY3JpYmVQcm9jID0gKCkgPT4gewogICAgICBjb25zdCBtZXNzYWdlSWQgPSB0aGlzLl9uZXh0SWQoKTsKICAgICAgaWYgKG1lc3NhZ2VJZCA9PT0gbnVsbCkgewogICAgICAgIHRoaXMubG9nKCdObyBtZXNzYWdlSWQgbGVmdCcpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb25zdCBwYWNrZXQgPSB7CiAgICAgICAgY21kOiAnc3Vic2NyaWJlJywKICAgICAgICBzdWJzY3JpcHRpb25zOiBzdWJzLAogICAgICAgIG1lc3NhZ2VJZAogICAgICB9OwogICAgICBpZiAocHJvcGVydGllcykgewogICAgICAgIHBhY2tldC5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKICAgICAgfQogICAgICBpZiAodGhpcy5vcHRpb25zLnJlc3Vic2NyaWJlKSB7CiAgICAgICAgdGhpcy5sb2coJ3N1YnNjcmliZSA6OiByZXN1YnNjcmliZSB0cnVlJyk7CiAgICAgICAgY29uc3QgdG9waWNzID0gW107CiAgICAgICAgc3Vicy5mb3JFYWNoKHN1YiA9PiB7CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnJlY29ubmVjdFBlcmlvZCA+IDApIHsKICAgICAgICAgICAgY29uc3QgdG9waWMgPSB7CiAgICAgICAgICAgICAgcW9zOiBzdWIucW9zCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh2ZXJzaW9uID09PSA1KSB7CiAgICAgICAgICAgICAgdG9waWMubmwgPSBzdWIubmwgfHwgZmFsc2U7CiAgICAgICAgICAgICAgdG9waWMucmFwID0gc3ViLnJhcCB8fCBmYWxzZTsKICAgICAgICAgICAgICB0b3BpYy5yaCA9IHN1Yi5yaCB8fCAwOwogICAgICAgICAgICAgIHRvcGljLnByb3BlcnRpZXMgPSBzdWIucHJvcGVydGllczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9yZXN1YnNjcmliZVRvcGljc1tzdWIudG9waWNdID0gdG9waWM7CiAgICAgICAgICAgIHRvcGljcy5wdXNoKHN1Yi50b3BpYyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5tZXNzYWdlSWRUb1RvcGljW3BhY2tldC5tZXNzYWdlSWRdID0gdG9waWNzOwogICAgICB9CiAgICAgIHRoaXMub3V0Z29pbmdbcGFja2V0Lm1lc3NhZ2VJZF0gPSB7CiAgICAgICAgdm9sYXRpbGU6IHRydWUsCiAgICAgICAgY2IoZXJyLCBwYWNrZXQyKSB7CiAgICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgZ3JhbnRlZAogICAgICAgICAgICB9ID0gcGFja2V0MjsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFudGVkLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgc3Vic1tpXS5xb3MgPSBncmFudGVkW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhlcnIsIHN1YnMsIHBhY2tldDIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdGhpcy5sb2coJ3N1YnNjcmliZSA6OiBjYWxsIF9zZW5kUGFja2V0Jyk7CiAgICAgIHRoaXMuX3NlbmRQYWNrZXQocGFja2V0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgaWYgKHRoaXMuX3N0b3JlUHJvY2Vzc2luZyB8fCB0aGlzLl9zdG9yZVByb2Nlc3NpbmdRdWV1ZS5sZW5ndGggPiAwIHx8ICFzdWJzY3JpYmVQcm9jKCkpIHsKICAgICAgdGhpcy5fc3RvcmVQcm9jZXNzaW5nUXVldWUucHVzaCh7CiAgICAgICAgaW52b2tlOiBzdWJzY3JpYmVQcm9jLAogICAgICAgIGNhbGxiYWNrCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1YnNjcmliZUFzeW5jKHRvcGljT2JqZWN0LCBvcHRzKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICB0aGlzLnN1YnNjcmliZSh0b3BpY09iamVjdCwgb3B0cywgKGVyciwgZ3JhbnRlZCkgPT4gewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlKGdyYW50ZWQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgdW5zdWJzY3JpYmUodG9waWMsIG9wdHMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHRvcGljID09PSAnc3RyaW5nJykgewogICAgICB0b3BpYyA9IFt0b3BpY107CiAgICB9CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBvcHRzOwogICAgfQogICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCB0aGlzLm5vb3A7CiAgICBjb25zdCBpbnZhbGlkVG9waWMgPSB2YWxpZGF0aW9ucy52YWxpZGF0ZVRvcGljcyh0b3BpYyk7CiAgICBpZiAoaW52YWxpZFRvcGljICE9PSBudWxsKSB7CiAgICAgIHNldEltbWVkaWF0ZSQxKGNhbGxiYWNrLCBuZXcgRXJyb3IoYEludmFsaWQgdG9waWMgJHtpbnZhbGlkVG9waWN9YCkpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGlmICh0aGlzLl9jaGVja0Rpc2Nvbm5lY3RpbmcoY2FsbGJhY2spKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY29uc3QgdW5zdWJzY3JpYmVQcm9jID0gKCkgPT4gewogICAgICBjb25zdCBtZXNzYWdlSWQgPSB0aGlzLl9uZXh0SWQoKTsKICAgICAgaWYgKG1lc3NhZ2VJZCA9PT0gbnVsbCkgewogICAgICAgIHRoaXMubG9nKCdObyBtZXNzYWdlSWQgbGVmdCcpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb25zdCBwYWNrZXQgPSB7CiAgICAgICAgY21kOiAndW5zdWJzY3JpYmUnLAogICAgICAgIG1lc3NhZ2VJZCwKICAgICAgICB1bnN1YnNjcmlwdGlvbnM6IFtdCiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdG9waWMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcGFja2V0LnVuc3Vic2NyaXB0aW9ucyA9IFt0b3BpY107CiAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh0b3BpYykpIHsKICAgICAgICBwYWNrZXQudW5zdWJzY3JpcHRpb25zID0gdG9waWM7CiAgICAgIH0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5yZXN1YnNjcmliZSkgewogICAgICAgIHBhY2tldC51bnN1YnNjcmlwdGlvbnMuZm9yRWFjaCh0b3BpYzIgPT4gewogICAgICAgICAgZGVsZXRlIHRoaXMuX3Jlc3Vic2NyaWJlVG9waWNzW3RvcGljMl07CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBvcHRzID09PSAnb2JqZWN0JyAmJiBvcHRzLnByb3BlcnRpZXMpIHsKICAgICAgICBwYWNrZXQucHJvcGVydGllcyA9IG9wdHMucHJvcGVydGllczsKICAgICAgfQogICAgICB0aGlzLm91dGdvaW5nW3BhY2tldC5tZXNzYWdlSWRdID0gewogICAgICAgIHZvbGF0aWxlOiB0cnVlLAogICAgICAgIGNiOiBjYWxsYmFjawogICAgICB9OwogICAgICB0aGlzLmxvZygndW5zdWJzY3JpYmU6IGNhbGwgX3NlbmRQYWNrZXQnKTsKICAgICAgdGhpcy5fc2VuZFBhY2tldChwYWNrZXQpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgICBpZiAodGhpcy5fc3RvcmVQcm9jZXNzaW5nIHx8IHRoaXMuX3N0b3JlUHJvY2Vzc2luZ1F1ZXVlLmxlbmd0aCA+IDAgfHwgIXVuc3Vic2NyaWJlUHJvYygpKSB7CiAgICAgIHRoaXMuX3N0b3JlUHJvY2Vzc2luZ1F1ZXVlLnB1c2goewogICAgICAgIGludm9rZTogdW5zdWJzY3JpYmVQcm9jLAogICAgICAgIGNhbGxiYWNrCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHVuc3Vic2NyaWJlQXN5bmModG9waWMsIG9wdHMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUodG9waWMsIG9wdHMsIChlcnIsIHBhY2tldCkgPT4gewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlKHBhY2tldCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KICBlbmQoZm9yY2UsIG9wdHMsIGNiKSB7CiAgICB0aGlzLmxvZygnZW5kIDo6ICglcyknLCB0aGlzLm9wdGlvbnMuY2xpZW50SWQpOwogICAgaWYgKGZvcmNlID09IG51bGwgfHwgdHlwZW9mIGZvcmNlICE9PSAnYm9vbGVhbicpIHsKICAgICAgY2IgPSBjYiB8fCBvcHRzOwogICAgICBvcHRzID0gZm9yY2U7CiAgICAgIGZvcmNlID0gZmFsc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIG9wdHMgIT09ICdvYmplY3QnKSB7CiAgICAgIGNiID0gY2IgfHwgb3B0czsKICAgICAgb3B0cyA9IG51bGw7CiAgICB9CiAgICB0aGlzLmxvZygnZW5kIDo6IGNiPyAlcycsICEhY2IpOwogICAgaWYgKCFjYiB8fCB0eXBlb2YgY2IgIT09ICdmdW5jdGlvbicpIHsKICAgICAgY2IgPSB0aGlzLm5vb3A7CiAgICB9CiAgICBjb25zdCBjbG9zZVN0b3JlcyA9ICgpID0+IHsKICAgICAgdGhpcy5sb2coJ2VuZCA6OiBjbG9zZVN0b3JlczogY2xvc2luZyBpbmNvbWluZyBhbmQgb3V0Z29pbmcgc3RvcmVzJyk7CiAgICAgIHRoaXMuZGlzY29ubmVjdGVkID0gdHJ1ZTsKICAgICAgdGhpcy5pbmNvbWluZ1N0b3JlLmNsb3NlKGUxID0+IHsKICAgICAgICB0aGlzLm91dGdvaW5nU3RvcmUuY2xvc2UoZTIgPT4gewogICAgICAgICAgdGhpcy5sb2coJ2VuZCA6OiBjbG9zZVN0b3JlczogZW1pdHRpbmcgZW5kJyk7CiAgICAgICAgICB0aGlzLmVtaXQoJ2VuZCcpOwogICAgICAgICAgaWYgKGNiKSB7CiAgICAgICAgICAgIGNvbnN0IGVyciA9IGUxIHx8IGUyOwogICAgICAgICAgICB0aGlzLmxvZygnZW5kIDo6IGNsb3NlU3RvcmVzOiBpbnZva2luZyBjYWxsYmFjayB3aXRoIGFyZ3MnKTsKICAgICAgICAgICAgY2IoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGlmICh0aGlzLl9kZWZlcnJlZFJlY29ubmVjdCkgewogICAgICAgIHRoaXMuX2RlZmVycmVkUmVjb25uZWN0KCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5vcHRpb25zLnJlY29ubmVjdFBlcmlvZCA9PT0gMCB8fCB0aGlzLm9wdGlvbnMubWFudWFsQ29ubmVjdCkgewogICAgICAgIHRoaXMuZGlzY29ubmVjdGluZyA9IGZhbHNlOwogICAgICB9CiAgICB9OwogICAgY29uc3QgZmluaXNoID0gKCkgPT4gewogICAgICB0aGlzLmxvZygnZW5kIDo6ICglcykgOjogZmluaXNoIDo6IGNhbGxpbmcgX2NsZWFuVXAgd2l0aCBmb3JjZSAlcycsIHRoaXMub3B0aW9ucy5jbGllbnRJZCwgZm9yY2UpOwogICAgICB0aGlzLl9jbGVhblVwKGZvcmNlLCAoKSA9PiB7CiAgICAgICAgdGhpcy5sb2coJ2VuZCA6OiBmaW5pc2ggOjogY2FsbGluZyBwcm9jZXNzLm5leHRUaWNrIG9uIGNsb3NlU3RvcmVzJyk7CiAgICAgICAgKDAsIHNoYXJlZF8xLm5leHRUaWNrKShjbG9zZVN0b3Jlcyk7CiAgICAgIH0sIG9wdHMpOwogICAgfTsKICAgIGlmICh0aGlzLmRpc2Nvbm5lY3RpbmcpIHsKICAgICAgY2IoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB0aGlzLl9jbGVhclJlY29ubmVjdCgpOwogICAgdGhpcy5kaXNjb25uZWN0aW5nID0gdHJ1ZTsKICAgIGlmICghZm9yY2UgJiYgT2JqZWN0LmtleXModGhpcy5vdXRnb2luZykubGVuZ3RoID4gMCkgewogICAgICB0aGlzLmxvZygnZW5kIDo6ICglcykgOjogY2FsbGluZyBmaW5pc2ggaW4gMTBtcyBvbmNlIG91dGdvaW5nIGlzIGVtcHR5JywgdGhpcy5vcHRpb25zLmNsaWVudElkKTsKICAgICAgdGhpcy5vbmNlKCdvdXRnb2luZ0VtcHR5Jywgc2V0VGltZW91dC5iaW5kKG51bGwsIGZpbmlzaCwgMTApKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubG9nKCdlbmQgOjogKCVzKSA6OiBpbW1lZGlhdGVseSBjYWxsaW5nIGZpbmlzaCcsIHRoaXMub3B0aW9ucy5jbGllbnRJZCk7CiAgICAgIGZpbmlzaCgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGVuZEFzeW5jKGZvcmNlLCBvcHRzKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICB0aGlzLmVuZChmb3JjZSwgb3B0cywgZXJyID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgcmVtb3ZlT3V0Z29pbmdNZXNzYWdlKG1lc3NhZ2VJZCkgewogICAgaWYgKHRoaXMub3V0Z29pbmdbbWVzc2FnZUlkXSkgewogICAgICBjb25zdCB7CiAgICAgICAgY2IKICAgICAgfSA9IHRoaXMub3V0Z29pbmdbbWVzc2FnZUlkXTsKICAgICAgdGhpcy5fcmVtb3ZlT3V0Z29pbmdBbmRTdG9yZU1lc3NhZ2UobWVzc2FnZUlkLCAoKSA9PiB7CiAgICAgICAgY2IobmV3IEVycm9yKCdNZXNzYWdlIHJlbW92ZWQnKSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29ubmVjdChvcHRzKSB7CiAgICB0aGlzLmxvZygnY2xpZW50IHJlY29ubmVjdCcpOwogICAgY29uc3QgZiA9ICgpID0+IHsKICAgICAgaWYgKG9wdHMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMuaW5jb21pbmdTdG9yZSA9IG9wdHMuaW5jb21pbmdTdG9yZTsKICAgICAgICB0aGlzLm9wdGlvbnMub3V0Z29pbmdTdG9yZSA9IG9wdHMub3V0Z29pbmdTdG9yZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wdGlvbnMuaW5jb21pbmdTdG9yZSA9IG51bGw7CiAgICAgICAgdGhpcy5vcHRpb25zLm91dGdvaW5nU3RvcmUgPSBudWxsOwogICAgICB9CiAgICAgIHRoaXMuaW5jb21pbmdTdG9yZSA9IHRoaXMub3B0aW9ucy5pbmNvbWluZ1N0b3JlIHx8IG5ldyBzdG9yZV8xLmRlZmF1bHQoKTsKICAgICAgdGhpcy5vdXRnb2luZ1N0b3JlID0gdGhpcy5vcHRpb25zLm91dGdvaW5nU3RvcmUgfHwgbmV3IHN0b3JlXzEuZGVmYXVsdCgpOwogICAgICB0aGlzLmRpc2Nvbm5lY3RpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5kaXNjb25uZWN0ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fZGVmZXJyZWRSZWNvbm5lY3QgPSBudWxsOwogICAgICB0aGlzLl9yZWNvbm5lY3QoKTsKICAgIH07CiAgICBpZiAodGhpcy5kaXNjb25uZWN0aW5nICYmICF0aGlzLmRpc2Nvbm5lY3RlZCkgewogICAgICB0aGlzLl9kZWZlcnJlZFJlY29ubmVjdCA9IGY7CiAgICB9IGVsc2UgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgX2ZsdXNoVm9sYXRpbGUoKSB7CiAgICBpZiAodGhpcy5vdXRnb2luZykgewogICAgICB0aGlzLmxvZygnX2ZsdXNoVm9sYXRpbGUgOjogZGVsZXRpbmcgdm9sYXRpbGUgbWVzc2FnZXMgZnJvbSB0aGUgcXVldWUgYW5kIHNldHRpbmcgdGhlaXIgY2FsbGJhY2tzIGFzIGVycm9yIGZ1bmN0aW9uJyk7CiAgICAgIE9iamVjdC5rZXlzKHRoaXMub3V0Z29pbmcpLmZvckVhY2gobWVzc2FnZUlkID0+IHsKICAgICAgICBpZiAodGhpcy5vdXRnb2luZ1ttZXNzYWdlSWRdLnZvbGF0aWxlICYmIHR5cGVvZiB0aGlzLm91dGdvaW5nW21lc3NhZ2VJZF0uY2IgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXMub3V0Z29pbmdbbWVzc2FnZUlkXS5jYihuZXcgRXJyb3IoJ0Nvbm5lY3Rpb24gY2xvc2VkJykpOwogICAgICAgICAgZGVsZXRlIHRoaXMub3V0Z29pbmdbbWVzc2FnZUlkXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICBfZmx1c2goKSB7CiAgICBpZiAodGhpcy5vdXRnb2luZykgewogICAgICB0aGlzLmxvZygnX2ZsdXNoOiBxdWV1ZSBleGlzdHM/ICViJywgISF0aGlzLm91dGdvaW5nKTsKICAgICAgT2JqZWN0LmtleXModGhpcy5vdXRnb2luZykuZm9yRWFjaChtZXNzYWdlSWQgPT4gewogICAgICAgIGlmICh0eXBlb2YgdGhpcy5vdXRnb2luZ1ttZXNzYWdlSWRdLmNiID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aGlzLm91dGdvaW5nW21lc3NhZ2VJZF0uY2IobmV3IEVycm9yKCdDb25uZWN0aW9uIGNsb3NlZCcpKTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLm91dGdvaW5nW21lc3NhZ2VJZF07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgX3JlbW92ZVRvcGljQWxpYXNBbmRSZWNvdmVyVG9waWNOYW1lKHBhY2tldCkgewogICAgbGV0IGFsaWFzOwogICAgaWYgKHBhY2tldC5wcm9wZXJ0aWVzKSB7CiAgICAgIGFsaWFzID0gcGFja2V0LnByb3BlcnRpZXMudG9waWNBbGlhczsKICAgIH0KICAgIGxldCB0b3BpYyA9IHBhY2tldC50b3BpYy50b1N0cmluZygpOwogICAgdGhpcy5sb2coJ19yZW1vdmVUb3BpY0FsaWFzQW5kUmVjb3ZlclRvcGljTmFtZSA6OiBhbGlhcyAlZCwgdG9waWMgJW8nLCBhbGlhcywgdG9waWMpOwogICAgaWYgKHRvcGljLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAodHlwZW9mIGFsaWFzID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBuZXcgRXJyb3IoJ1VucmVnaXN0ZXJlZCBUb3BpYyBBbGlhcycpOwogICAgICB9CiAgICAgIHRvcGljID0gdGhpcy50b3BpY0FsaWFzU2VuZC5nZXRUb3BpY0J5QWxpYXMoYWxpYXMpOwogICAgICBpZiAodHlwZW9mIHRvcGljID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBuZXcgRXJyb3IoJ1VucmVnaXN0ZXJlZCBUb3BpYyBBbGlhcycpOwogICAgICB9CiAgICAgIHBhY2tldC50b3BpYyA9IHRvcGljOwogICAgfQogICAgaWYgKGFsaWFzKSB7CiAgICAgIGRlbGV0ZSBwYWNrZXQucHJvcGVydGllcy50b3BpY0FsaWFzOwogICAgfQogIH0KICBfY2hlY2tEaXNjb25uZWN0aW5nKGNhbGxiYWNrKSB7CiAgICBpZiAodGhpcy5kaXNjb25uZWN0aW5nKSB7CiAgICAgIGlmIChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gdGhpcy5ub29wKSB7CiAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdjbGllbnQgZGlzY29ubmVjdGluZycpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdjbGllbnQgZGlzY29ubmVjdGluZycpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuZGlzY29ubmVjdGluZzsKICB9CiAgX3JlY29ubmVjdCgpIHsKICAgIHRoaXMubG9nKCdfcmVjb25uZWN0OiBlbWl0dGluZyByZWNvbm5lY3QgdG8gY2xpZW50Jyk7CiAgICB0aGlzLmVtaXQoJ3JlY29ubmVjdCcpOwogICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7CiAgICAgIHRoaXMuZW5kKCgpID0+IHsKICAgICAgICB0aGlzLmNvbm5lY3QoKTsKICAgICAgfSk7CiAgICAgIHRoaXMubG9nKCdjbGllbnQgYWxyZWFkeSBjb25uZWN0ZWQuIGRpc2Nvbm5lY3RpbmcgZmlyc3QuJyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxvZygnX3JlY29ubmVjdDogY2FsbGluZyBjb25uZWN0Jyk7CiAgICAgIHRoaXMuY29ubmVjdCgpOwogICAgfQogIH0KICBfc2V0dXBSZWNvbm5lY3QoKSB7CiAgICBpZiAoIXRoaXMuZGlzY29ubmVjdGluZyAmJiAhdGhpcy5yZWNvbm5lY3RUaW1lciAmJiB0aGlzLm9wdGlvbnMucmVjb25uZWN0UGVyaW9kID4gMCkgewogICAgICBpZiAoIXRoaXMucmVjb25uZWN0aW5nKSB7CiAgICAgICAgdGhpcy5sb2coJ19zZXR1cFJlY29ubmVjdCA6OiBlbWl0IGBvZmZsaW5lYCBzdGF0ZScpOwogICAgICAgIHRoaXMuZW1pdCgnb2ZmbGluZScpOwogICAgICAgIHRoaXMubG9nKCdfc2V0dXBSZWNvbm5lY3QgOjogc2V0IGByZWNvbm5lY3RpbmdgIHRvIGB0cnVlYCcpOwogICAgICAgIHRoaXMucmVjb25uZWN0aW5nID0gdHJ1ZTsKICAgICAgfQogICAgICB0aGlzLmxvZygnX3NldHVwUmVjb25uZWN0IDo6IHNldHRpbmcgcmVjb25uZWN0VGltZXIgZm9yICVkIG1zJywgdGhpcy5vcHRpb25zLnJlY29ubmVjdFBlcmlvZCk7CiAgICAgIHRoaXMucmVjb25uZWN0VGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgICAgdGhpcy5sb2coJ3JlY29ubmVjdFRpbWVyIDo6IHJlY29ubmVjdCB0cmlnZ2VyZWQhJyk7CiAgICAgICAgdGhpcy5fcmVjb25uZWN0KCk7CiAgICAgIH0sIHRoaXMub3B0aW9ucy5yZWNvbm5lY3RQZXJpb2QpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5sb2coJ19zZXR1cFJlY29ubmVjdCA6OiBkb2luZyBub3RoaW5nLi4uJyk7CiAgICB9CiAgfQogIF9jbGVhclJlY29ubmVjdCgpIHsKICAgIHRoaXMubG9nKCdfY2xlYXJSZWNvbm5lY3QgOiBjbGVhcmluZyByZWNvbm5lY3QgdGltZXInKTsKICAgIGlmICh0aGlzLnJlY29ubmVjdFRpbWVyKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5yZWNvbm5lY3RUaW1lcik7CiAgICAgIHRoaXMucmVjb25uZWN0VGltZXIgPSBudWxsOwogICAgfQogIH0KICBfY2xlYW5VcChmb3JjZWQsIGRvbmUsIG9wdHMgPSB7fSkgewogICAgaWYgKGRvbmUpIHsKICAgICAgdGhpcy5sb2coJ19jbGVhblVwIDo6IGRvbmUgY2FsbGJhY2sgcHJvdmlkZWQgZm9yIG9uIHN0cmVhbSBjbG9zZScpOwogICAgICB0aGlzLnN0cmVhbS5vbignY2xvc2UnLCBkb25lKTsKICAgIH0KICAgIHRoaXMubG9nKCdfY2xlYW5VcCA6OiBmb3JjZWQ/ICVzJywgZm9yY2VkKTsKICAgIGlmIChmb3JjZWQpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5yZWNvbm5lY3RQZXJpb2QgPT09IDAgJiYgdGhpcy5vcHRpb25zLmNsZWFuKSB7CiAgICAgICAgdGhpcy5fZmx1c2goKTsKICAgICAgfQogICAgICB0aGlzLmxvZygnX2NsZWFuVXAgOjogKCVzKSA6OiBkZXN0cm95aW5nIHN0cmVhbScsIHRoaXMub3B0aW9ucy5jbGllbnRJZCk7CiAgICAgIHRoaXMuc3RyZWFtLmRlc3Ryb3koKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHBhY2tldCA9IE9iamVjdC5hc3NpZ24oewogICAgICAgIGNtZDogJ2Rpc2Nvbm5lY3QnCiAgICAgIH0sIG9wdHMpOwogICAgICB0aGlzLmxvZygnX2NsZWFuVXAgOjogKCVzKSA6OiBjYWxsIF9zZW5kUGFja2V0IHdpdGggZGlzY29ubmVjdCBwYWNrZXQnLCB0aGlzLm9wdGlvbnMuY2xpZW50SWQpOwogICAgICB0aGlzLl9zZW5kUGFja2V0KHBhY2tldCwgKCkgPT4gewogICAgICAgIHRoaXMubG9nKCdfY2xlYW5VcCA6OiAoJXMpIDo6IGRlc3Ryb3lpbmcgc3RyZWFtJywgdGhpcy5vcHRpb25zLmNsaWVudElkKTsKICAgICAgICBzZXRJbW1lZGlhdGUkMSgoKSA9PiB7CiAgICAgICAgICB0aGlzLnN0cmVhbS5lbmQoKCkgPT4gewogICAgICAgICAgICB0aGlzLmxvZygnX2NsZWFuVXAgOjogKCVzKSA6OiBzdHJlYW0gZGVzdHJveWVkJywgdGhpcy5vcHRpb25zLmNsaWVudElkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICAgIGlmICghdGhpcy5kaXNjb25uZWN0aW5nICYmICF0aGlzLnJlY29ubmVjdGluZykgewogICAgICB0aGlzLmxvZygnX2NsZWFuVXAgOjogY2xpZW50IG5vdCBkaXNjb25uZWN0aW5nL3JlY29ubmVjdGluZy4gQ2xlYXJpbmcgYW5kIHJlc2V0dGluZyByZWNvbm5lY3QuJyk7CiAgICAgIHRoaXMuX2NsZWFyUmVjb25uZWN0KCk7CiAgICAgIHRoaXMuX3NldHVwUmVjb25uZWN0KCk7CiAgICB9CiAgICB0aGlzLl9kZXN0cm95S2VlcGFsaXZlTWFuYWdlcigpOwogICAgaWYgKGRvbmUgJiYgIXRoaXMuY29ubmVjdGVkKSB7CiAgICAgIHRoaXMubG9nKCdfY2xlYW5VcCA6OiAoJXMpIDo6IHJlbW92aW5nIHN0cmVhbSBgZG9uZWAgY2FsbGJhY2sgYGNsb3NlYCBsaXN0ZW5lcicsIHRoaXMub3B0aW9ucy5jbGllbnRJZCk7CiAgICAgIHRoaXMuc3RyZWFtLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIGRvbmUpOwogICAgICBkb25lKCk7CiAgICB9CiAgfQogIF9zdG9yZUFuZFNlbmQocGFja2V0LCBjYiwgY2JTdG9yZVB1dCkgewogICAgdGhpcy5sb2coJ3N0b3JlQW5kU2VuZCA6OiBzdG9yZSBwYWNrZXQgd2l0aCBjbWQgJXMgdG8gb3V0Z29pbmdTdG9yZScsIHBhY2tldC5jbWQpOwogICAgbGV0IHN0b3JlUGFja2V0ID0gcGFja2V0OwogICAgbGV0IGVycjsKICAgIGlmIChzdG9yZVBhY2tldC5jbWQgPT09ICdwdWJsaXNoJykgewogICAgICBzdG9yZVBhY2tldCA9ICgwLCBkZWZhdWx0XzEuZGVmYXVsdCkocGFja2V0KTsKICAgICAgZXJyID0gdGhpcy5fcmVtb3ZlVG9waWNBbGlhc0FuZFJlY292ZXJUb3BpY05hbWUoc3RvcmVQYWNrZXQpOwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGNiICYmIGNiKGVycik7CiAgICAgIH0KICAgIH0KICAgIHRoaXMub3V0Z29pbmdTdG9yZS5wdXQoc3RvcmVQYWNrZXQsIGVycjIgPT4gewogICAgICBpZiAoZXJyMikgewogICAgICAgIHJldHVybiBjYiAmJiBjYihlcnIyKTsKICAgICAgfQogICAgICBjYlN0b3JlUHV0KCk7CiAgICAgIHRoaXMuX3dyaXRlUGFja2V0KHBhY2tldCwgY2IpOwogICAgfSk7CiAgfQogIF9hcHBseVRvcGljQWxpYXMocGFja2V0KSB7CiAgICBpZiAodGhpcy5vcHRpb25zLnByb3RvY29sVmVyc2lvbiA9PT0gNSkgewogICAgICBpZiAocGFja2V0LmNtZCA9PT0gJ3B1Ymxpc2gnKSB7CiAgICAgICAgbGV0IGFsaWFzOwogICAgICAgIGlmIChwYWNrZXQucHJvcGVydGllcykgewogICAgICAgICAgYWxpYXMgPSBwYWNrZXQucHJvcGVydGllcy50b3BpY0FsaWFzOwogICAgICAgIH0KICAgICAgICBjb25zdCB0b3BpYyA9IHBhY2tldC50b3BpYy50b1N0cmluZygpOwogICAgICAgIGlmICh0aGlzLnRvcGljQWxpYXNTZW5kKSB7CiAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgaWYgKHRvcGljLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgIHRoaXMubG9nKCdhcHBseVRvcGljQWxpYXMgOjogcmVnaXN0ZXIgdG9waWM6ICVzIC0gYWxpYXM6ICVkJywgdG9waWMsIGFsaWFzKTsKICAgICAgICAgICAgICBpZiAoIXRoaXMudG9waWNBbGlhc1NlbmQucHV0KHRvcGljLCBhbGlhcykpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9nKCdhcHBseVRvcGljQWxpYXMgOjogZXJyb3Igb3V0IG9mIHJhbmdlLiB0b3BpYzogJXMgLSBhbGlhczogJWQnLCB0b3BpYywgYWxpYXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBFcnJvcignU2VuZGluZyBUb3BpYyBBbGlhcyBvdXQgb2YgcmFuZ2UnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodG9waWMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXV0b0Fzc2lnblRvcGljQWxpYXMpIHsKICAgICAgICAgICAgICBhbGlhcyA9IHRoaXMudG9waWNBbGlhc1NlbmQuZ2V0QWxpYXNCeVRvcGljKHRvcGljKTsKICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgIHBhY2tldC50b3BpYyA9ICcnOwogICAgICAgICAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhY2tldC5wcm9wZXJ0aWVzKSwgewogICAgICAgICAgICAgICAgICB0b3BpY0FsaWFzOiBhbGlhcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmxvZygnYXBwbHlUb3BpY0FsaWFzIDo6IGF1dG8gYXNzaWduKHVzZSkgdG9waWM6ICVzIC0gYWxpYXM6ICVkJywgdG9waWMsIGFsaWFzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWxpYXMgPSB0aGlzLnRvcGljQWxpYXNTZW5kLmdldExydUFsaWFzKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRvcGljQWxpYXNTZW5kLnB1dCh0b3BpYywgYWxpYXMpOwogICAgICAgICAgICAgICAgcGFja2V0LnByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhY2tldC5wcm9wZXJ0aWVzKSwgewogICAgICAgICAgICAgICAgICB0b3BpY0FsaWFzOiBhbGlhcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmxvZygnYXBwbHlUb3BpY0FsaWFzIDo6IGF1dG8gYXNzaWduIHRvcGljOiAlcyAtIGFsaWFzOiAlZCcsIHRvcGljLCBhbGlhcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5hdXRvVXNlVG9waWNBbGlhcykgewogICAgICAgICAgICAgIGFsaWFzID0gdGhpcy50b3BpY0FsaWFzU2VuZC5nZXRBbGlhc0J5VG9waWModG9waWMpOwogICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgcGFja2V0LnRvcGljID0gJyc7CiAgICAgICAgICAgICAgICBwYWNrZXQucHJvcGVydGllcyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcGFja2V0LnByb3BlcnRpZXMpLCB7CiAgICAgICAgICAgICAgICAgIHRvcGljQWxpYXM6IGFsaWFzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMubG9nKCdhcHBseVRvcGljQWxpYXMgOjogYXV0byB1c2UgdG9waWM6ICVzIC0gYWxpYXM6ICVkJywgdG9waWMsIGFsaWFzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGFsaWFzKSB7CiAgICAgICAgICB0aGlzLmxvZygnYXBwbHlUb3BpY0FsaWFzIDo6IGVycm9yIG91dCBvZiByYW5nZS4gdG9waWM6ICVzIC0gYWxpYXM6ICVkJywgdG9waWMsIGFsaWFzKTsKICAgICAgICAgIHJldHVybiBuZXcgRXJyb3IoJ1NlbmRpbmcgVG9waWMgQWxpYXMgb3V0IG9mIHJhbmdlJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIF9ub29wKGVycikgewogICAgdGhpcy5sb2coJ25vb3AgOjonLCBlcnIpOwogIH0KICBfd3JpdGVQYWNrZXQocGFja2V0LCBjYikgewogICAgdGhpcy5sb2coJ193cml0ZVBhY2tldCA6OiBwYWNrZXQ6ICVPJywgcGFja2V0KTsKICAgIHRoaXMubG9nKCdfd3JpdGVQYWNrZXQgOjogZW1pdHRpbmcgYHBhY2tldHNlbmRgJyk7CiAgICB0aGlzLmVtaXQoJ3BhY2tldHNlbmQnLCBwYWNrZXQpOwogICAgdGhpcy5sb2coJ193cml0ZVBhY2tldCA6OiB3cml0aW5nIHRvIHN0cmVhbScpOwogICAgY29uc3QgcmVzdWx0ID0gbXF0dF9wYWNrZXRfMS5kZWZhdWx0LndyaXRlVG9TdHJlYW0ocGFja2V0LCB0aGlzLnN0cmVhbSwgdGhpcy5vcHRpb25zKTsKICAgIHRoaXMubG9nKCdfd3JpdGVQYWNrZXQgOjogd3JpdGVUb1N0cmVhbSByZXN1bHQgJXMnLCByZXN1bHQpOwogICAgaWYgKCFyZXN1bHQgJiYgY2IgJiYgY2IgIT09IHRoaXMubm9vcCkgewogICAgICB0aGlzLmxvZygnX3dyaXRlUGFja2V0IDo6IGhhbmRsZSBldmVudHMgb24gYGRyYWluYCBvbmNlIHRocm91Z2ggY2FsbGJhY2suJyk7CiAgICAgIHRoaXMuc3RyZWFtLm9uY2UoJ2RyYWluJywgY2IpOwogICAgfSBlbHNlIGlmIChjYikgewogICAgICB0aGlzLmxvZygnX3dyaXRlUGFja2V0IDo6IGludm9raW5nIGNiJyk7CiAgICAgIGNiKCk7CiAgICB9CiAgfQogIF9zZW5kUGFja2V0KHBhY2tldCwgY2IsIGNiU3RvcmVQdXQsIG5vU3RvcmUpIHsKICAgIHRoaXMubG9nKCdfc2VuZFBhY2tldCA6OiAoJXMpIDo6ICBzdGFydCcsIHRoaXMub3B0aW9ucy5jbGllbnRJZCk7CiAgICBjYlN0b3JlUHV0ID0gY2JTdG9yZVB1dCB8fCB0aGlzLm5vb3A7CiAgICBjYiA9IGNiIHx8IHRoaXMubm9vcDsKICAgIGNvbnN0IGVyciA9IHRoaXMuX2FwcGx5VG9waWNBbGlhcyhwYWNrZXQpOwogICAgaWYgKGVycikgewogICAgICBjYihlcnIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuY29ubmVjdGVkKSB7CiAgICAgIGlmIChwYWNrZXQuY21kID09PSAnYXV0aCcpIHsKICAgICAgICB0aGlzLl93cml0ZVBhY2tldChwYWNrZXQsIGNiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5sb2coJ19zZW5kUGFja2V0IDo6IGNsaWVudCBub3QgY29ubmVjdGVkLiBTdG9yaW5nIHBhY2tldCBvZmZsaW5lLicpOwogICAgICB0aGlzLl9zdG9yZVBhY2tldChwYWNrZXQsIGNiLCBjYlN0b3JlUHV0KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG5vU3RvcmUpIHsKICAgICAgdGhpcy5fd3JpdGVQYWNrZXQocGFja2V0LCBjYik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN3aXRjaCAocGFja2V0LmNtZCkgewogICAgICBjYXNlICdwdWJsaXNoJzoKICAgICAgICBicmVhazsKICAgICAgY2FzZSAncHVicmVsJzoKICAgICAgICB0aGlzLl9zdG9yZUFuZFNlbmQocGFja2V0LCBjYiwgY2JTdG9yZVB1dCk7CiAgICAgICAgcmV0dXJuOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuX3dyaXRlUGFja2V0KHBhY2tldCwgY2IpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIHN3aXRjaCAocGFja2V0LnFvcykgewogICAgICBjYXNlIDI6CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9zdG9yZUFuZFNlbmQocGFja2V0LCBjYiwgY2JTdG9yZVB1dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMDoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLl93cml0ZVBhY2tldChwYWNrZXQsIGNiKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMubG9nKCdfc2VuZFBhY2tldCA6OiAoJXMpIDo6ICBlbmQnLCB0aGlzLm9wdGlvbnMuY2xpZW50SWQpOwogIH0KICBfc3RvcmVQYWNrZXQocGFja2V0LCBjYiwgY2JTdG9yZVB1dCkgewogICAgdGhpcy5sb2coJ19zdG9yZVBhY2tldCA6OiBwYWNrZXQ6ICVvJywgcGFja2V0KTsKICAgIHRoaXMubG9nKCdfc3RvcmVQYWNrZXQgOjogY2I/ICVzJywgISFjYik7CiAgICBjYlN0b3JlUHV0ID0gY2JTdG9yZVB1dCB8fCB0aGlzLm5vb3A7CiAgICBsZXQgc3RvcmVQYWNrZXQgPSBwYWNrZXQ7CiAgICBpZiAoc3RvcmVQYWNrZXQuY21kID09PSAncHVibGlzaCcpIHsKICAgICAgc3RvcmVQYWNrZXQgPSAoMCwgZGVmYXVsdF8xLmRlZmF1bHQpKHBhY2tldCk7CiAgICAgIGNvbnN0IGVyciA9IHRoaXMuX3JlbW92ZVRvcGljQWxpYXNBbmRSZWNvdmVyVG9waWNOYW1lKHN0b3JlUGFja2V0KTsKICAgICAgaWYgKGVycikgewogICAgICAgIHJldHVybiBjYiAmJiBjYihlcnIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBxb3MgPSBzdG9yZVBhY2tldC5xb3MgfHwgMDsKICAgIGlmIChxb3MgPT09IDAgJiYgdGhpcy5xdWV1ZVFvU1plcm8gfHwgc3RvcmVQYWNrZXQuY21kICE9PSAncHVibGlzaCcpIHsKICAgICAgdGhpcy5xdWV1ZS5wdXNoKHsKICAgICAgICBwYWNrZXQ6IHN0b3JlUGFja2V0LAogICAgICAgIGNiCiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChxb3MgPiAwKSB7CiAgICAgIGNiID0gdGhpcy5vdXRnb2luZ1tzdG9yZVBhY2tldC5tZXNzYWdlSWRdID8gdGhpcy5vdXRnb2luZ1tzdG9yZVBhY2tldC5tZXNzYWdlSWRdLmNiIDogbnVsbDsKICAgICAgdGhpcy5vdXRnb2luZ1N0b3JlLnB1dChzdG9yZVBhY2tldCwgZXJyID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gY2IgJiYgY2IoZXJyKTsKICAgICAgICB9CiAgICAgICAgY2JTdG9yZVB1dCgpOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoY2IpIHsKICAgICAgY2IobmV3IEVycm9yKCdObyBjb25uZWN0aW9uIHRvIGJyb2tlcicpKTsKICAgIH0KICB9CiAgX3NldHVwS2VlcGFsaXZlTWFuYWdlcigpIHsKICAgIHRoaXMubG9nKCdfc2V0dXBLZWVwYWxpdmVNYW5hZ2VyIDo6IGtlZXBhbGl2ZSAlZCAoc2Vjb25kcyknLCB0aGlzLm9wdGlvbnMua2VlcGFsaXZlKTsKICAgIGlmICghdGhpcy5rZWVwYWxpdmVNYW5hZ2VyICYmIHRoaXMub3B0aW9ucy5rZWVwYWxpdmUpIHsKICAgICAgdGhpcy5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXJfMS5kZWZhdWx0KHRoaXMsIHRoaXMub3B0aW9ucy50aW1lclZhcmlhbnQpOwogICAgfQogIH0KICBfZGVzdHJveUtlZXBhbGl2ZU1hbmFnZXIoKSB7CiAgICBpZiAodGhpcy5rZWVwYWxpdmVNYW5hZ2VyKSB7CiAgICAgIHRoaXMubG9nKCdfZGVzdHJveUtlZXBhbGl2ZU1hbmFnZXIgOjogZGVzdHJveWluZyBrZWVwYWxpdmUgbWFuYWdlcicpOwogICAgICB0aGlzLmtlZXBhbGl2ZU1hbmFnZXIuZGVzdHJveSgpOwogICAgICB0aGlzLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgfQogIH0KICByZXNjaGVkdWxlUGluZyhmb3JjZSA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5rZWVwYWxpdmVNYW5hZ2VyICYmIHRoaXMub3B0aW9ucy5rZWVwYWxpdmUgJiYgKGZvcmNlIHx8IHRoaXMub3B0aW9ucy5yZXNjaGVkdWxlUGluZ3MpKSB7CiAgICAgIHRoaXMuX3Jlc2NoZWR1bGVQaW5nKCk7CiAgICB9CiAgfQogIF9yZXNjaGVkdWxlUGluZygpIHsKICAgIHRoaXMubG9nKCdfcmVzY2hlZHVsZVBpbmcgOjogcmVzY2hlZHVsaW5nIHBpbmcnKTsKICAgIHRoaXMua2VlcGFsaXZlTWFuYWdlci5yZXNjaGVkdWxlKCk7CiAgfQogIHNlbmRQaW5nKCkgewogICAgdGhpcy5sb2coJ19zZW5kUGluZyA6OiBzZW5kaW5nIHBpbmdyZXEnKTsKICAgIHRoaXMuX3NlbmRQYWNrZXQoewogICAgICBjbWQ6ICdwaW5ncmVxJwogICAgfSk7CiAgfQogIG9uS2VlcGFsaXZlVGltZW91dCgpIHsKICAgIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ0tlZXBhbGl2ZSB0aW1lb3V0JykpOwogICAgdGhpcy5sb2coJ29uS2VlcGFsaXZlVGltZW91dCA6OiBjYWxsaW5nIF9jbGVhblVwIHdpdGggZm9yY2UgdHJ1ZScpOwogICAgdGhpcy5fY2xlYW5VcCh0cnVlKTsKICB9CiAgX3Jlc3Vic2NyaWJlKCkgewogICAgdGhpcy5sb2coJ19yZXN1YnNjcmliZScpOwogICAgY29uc3QgX3Jlc3Vic2NyaWJlVG9waWNzS2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuX3Jlc3Vic2NyaWJlVG9waWNzKTsKICAgIGlmICghdGhpcy5fZmlyc3RDb25uZWN0aW9uICYmICh0aGlzLm9wdGlvbnMuY2xlYW4gfHwgdGhpcy5vcHRpb25zLnByb3RvY29sVmVyc2lvbiA+PSA0ICYmICF0aGlzLmNvbm5hY2tQYWNrZXQuc2Vzc2lvblByZXNlbnQpICYmIF9yZXN1YnNjcmliZVRvcGljc0tleXMubGVuZ3RoID4gMCkgewogICAgICBpZiAodGhpcy5vcHRpb25zLnJlc3Vic2NyaWJlKSB7CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5wcm90b2NvbFZlcnNpb24gPT09IDUpIHsKICAgICAgICAgIHRoaXMubG9nKCdfcmVzdWJzY3JpYmU6IHByb3RvY29sVmVyc2lvbiA1Jyk7CiAgICAgICAgICBmb3IgKGxldCB0b3BpY0kgPSAwOyB0b3BpY0kgPCBfcmVzdWJzY3JpYmVUb3BpY3NLZXlzLmxlbmd0aDsgdG9waWNJKyspIHsKICAgICAgICAgICAgY29uc3QgcmVzdWJzY3JpYmVUb3BpYyA9IHt9OwogICAgICAgICAgICByZXN1YnNjcmliZVRvcGljW19yZXN1YnNjcmliZVRvcGljc0tleXNbdG9waWNJXV0gPSB0aGlzLl9yZXN1YnNjcmliZVRvcGljc1tfcmVzdWJzY3JpYmVUb3BpY3NLZXlzW3RvcGljSV1dOwogICAgICAgICAgICByZXN1YnNjcmliZVRvcGljLnJlc3Vic2NyaWJlID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmUocmVzdWJzY3JpYmVUb3BpYywgewogICAgICAgICAgICAgIHByb3BlcnRpZXM6IHJlc3Vic2NyaWJlVG9waWNbX3Jlc3Vic2NyaWJlVG9waWNzS2V5c1t0b3BpY0ldXS5wcm9wZXJ0aWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9yZXN1YnNjcmliZVRvcGljcy5yZXN1YnNjcmliZSA9IHRydWU7CiAgICAgICAgICB0aGlzLnN1YnNjcmliZSh0aGlzLl9yZXN1YnNjcmliZVRvcGljcyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3Jlc3Vic2NyaWJlVG9waWNzID0ge307CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX2ZpcnN0Q29ubmVjdGlvbiA9IGZhbHNlOwogIH0KICBfb25Db25uZWN0KHBhY2tldCkgewogICAgaWYgKHRoaXMuZGlzY29ubmVjdGVkKSB7CiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdCcsIHBhY2tldCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuY29ubmFja1BhY2tldCA9IHBhY2tldDsKICAgIHRoaXMubWVzc2FnZUlkUHJvdmlkZXIuY2xlYXIoKTsKICAgIHRoaXMuX3NldHVwS2VlcGFsaXZlTWFuYWdlcigpOwogICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlOwogICAgY29uc3Qgc3RhcnRTdHJlYW1Qcm9jZXNzID0gKCkgPT4gewogICAgICBsZXQgb3V0U3RvcmUgPSB0aGlzLm91dGdvaW5nU3RvcmUuY3JlYXRlU3RyZWFtKCk7CiAgICAgIGNvbnN0IHJlbW92ZSA9ICgpID0+IHsKICAgICAgICBvdXRTdG9yZS5kZXN0cm95KCk7CiAgICAgICAgb3V0U3RvcmUgPSBudWxsOwogICAgICAgIHRoaXMuX2ZsdXNoU3RvcmVQcm9jZXNzaW5nUXVldWUoKTsKICAgICAgICBjbGVhclN0b3JlUHJvY2Vzc2luZygpOwogICAgICB9OwogICAgICBjb25zdCBjbGVhclN0b3JlUHJvY2Vzc2luZyA9ICgpID0+IHsKICAgICAgICB0aGlzLl9zdG9yZVByb2Nlc3NpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLl9wYWNrZXRJZHNEdXJpbmdTdG9yZVByb2Nlc3NpbmcgPSB7fTsKICAgICAgfTsKICAgICAgdGhpcy5vbmNlKCdjbG9zZScsIHJlbW92ZSk7CiAgICAgIG91dFN0b3JlLm9uKCdlcnJvcicsIGVyciA9PiB7CiAgICAgICAgY2xlYXJTdG9yZVByb2Nlc3NpbmcoKTsKICAgICAgICB0aGlzLl9mbHVzaFN0b3JlUHJvY2Vzc2luZ1F1ZXVlKCk7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCByZW1vdmUpOwogICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICB9KTsKICAgICAgY29uc3Qgc3RvcmVEZWxpdmVyID0gKCkgPT4gewogICAgICAgIGlmICghb3V0U3RvcmUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFja2V0MiA9IG91dFN0b3JlLnJlYWQoMSk7CiAgICAgICAgbGV0IGNiOwogICAgICAgIGlmICghcGFja2V0MikgewogICAgICAgICAgb3V0U3RvcmUub25jZSgncmVhZGFibGUnLCBzdG9yZURlbGl2ZXIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdG9yZVByb2Nlc3NpbmcgPSB0cnVlOwogICAgICAgIGlmICh0aGlzLl9wYWNrZXRJZHNEdXJpbmdTdG9yZVByb2Nlc3NpbmdbcGFja2V0Mi5tZXNzYWdlSWRdKSB7CiAgICAgICAgICBzdG9yZURlbGl2ZXIoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmRpc2Nvbm5lY3RpbmcgJiYgIXRoaXMucmVjb25uZWN0VGltZXIpIHsKICAgICAgICAgIGNiID0gdGhpcy5vdXRnb2luZ1twYWNrZXQyLm1lc3NhZ2VJZF0gPyB0aGlzLm91dGdvaW5nW3BhY2tldDIubWVzc2FnZUlkXS5jYiA6IG51bGw7CiAgICAgICAgICB0aGlzLm91dGdvaW5nW3BhY2tldDIubWVzc2FnZUlkXSA9IHsKICAgICAgICAgICAgdm9sYXRpbGU6IGZhbHNlLAogICAgICAgICAgICBjYihlcnIsIHN0YXR1cykgewogICAgICAgICAgICAgIGlmIChjYikgewogICAgICAgICAgICAgICAgY2IoZXJyLCBzdGF0dXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdG9yZURlbGl2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuX3BhY2tldElkc0R1cmluZ1N0b3JlUHJvY2Vzc2luZ1twYWNrZXQyLm1lc3NhZ2VJZF0gPSB0cnVlOwogICAgICAgICAgaWYgKHRoaXMubWVzc2FnZUlkUHJvdmlkZXIucmVnaXN0ZXIocGFja2V0Mi5tZXNzYWdlSWQpKSB7CiAgICAgICAgICAgIHRoaXMuX3NlbmRQYWNrZXQocGFja2V0MiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5sb2coJ21lc3NhZ2VJZDogJWQgaGFzIGFscmVhZHkgdXNlZC4nLCBwYWNrZXQyLm1lc3NhZ2VJZCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChvdXRTdG9yZS5kZXN0cm95KSB7CiAgICAgICAgICBvdXRTdG9yZS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBvdXRTdG9yZS5vbignZW5kJywgKCkgPT4gewogICAgICAgIGxldCBhbGxQcm9jZXNzZWQgPSB0cnVlOwogICAgICAgIGZvciAoY29uc3QgaWQgaW4gdGhpcy5fcGFja2V0SWRzRHVyaW5nU3RvcmVQcm9jZXNzaW5nKSB7CiAgICAgICAgICBpZiAoIXRoaXMuX3BhY2tldElkc0R1cmluZ1N0b3JlUHJvY2Vzc2luZ1tpZF0pIHsKICAgICAgICAgICAgYWxsUHJvY2Vzc2VkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIHJlbW92ZSk7CiAgICAgICAgaWYgKGFsbFByb2Nlc3NlZCkgewogICAgICAgICAgY2xlYXJTdG9yZVByb2Nlc3NpbmcoKTsKICAgICAgICAgIHRoaXMuX2ludm9rZUFsbFN0b3JlUHJvY2Vzc2luZ1F1ZXVlKCk7CiAgICAgICAgICB0aGlzLmVtaXQoJ2Nvbm5lY3QnLCBwYWNrZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGFydFN0cmVhbVByb2Nlc3MoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBzdG9yZURlbGl2ZXIoKTsKICAgIH07CiAgICBzdGFydFN0cmVhbVByb2Nlc3MoKTsKICB9CiAgX2ludm9rZVN0b3JlUHJvY2Vzc2luZ1F1ZXVlKCkgewogICAgaWYgKCF0aGlzLl9zdG9yZVByb2Nlc3NpbmcgJiYgdGhpcy5fc3RvcmVQcm9jZXNzaW5nUXVldWUubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBmID0gdGhpcy5fc3RvcmVQcm9jZXNzaW5nUXVldWVbMF07CiAgICAgIGlmIChmICYmIGYuaW52b2tlKCkpIHsKICAgICAgICB0aGlzLl9zdG9yZVByb2Nlc3NpbmdRdWV1ZS5zaGlmdCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIF9pbnZva2VBbGxTdG9yZVByb2Nlc3NpbmdRdWV1ZSgpIHsKICAgIHdoaWxlICh0aGlzLl9pbnZva2VTdG9yZVByb2Nlc3NpbmdRdWV1ZSgpKSB7fQogIH0KICBfZmx1c2hTdG9yZVByb2Nlc3NpbmdRdWV1ZSgpIHsKICAgIGZvciAoY29uc3QgZiBvZiB0aGlzLl9zdG9yZVByb2Nlc3NpbmdRdWV1ZSkgewogICAgICBpZiAoZi5jYlN0b3JlUHV0KSBmLmNiU3RvcmVQdXQobmV3IEVycm9yKCdDb25uZWN0aW9uIGNsb3NlZCcpKTsKICAgICAgaWYgKGYuY2FsbGJhY2spIGYuY2FsbGJhY2sobmV3IEVycm9yKCdDb25uZWN0aW9uIGNsb3NlZCcpKTsKICAgIH0KICAgIHRoaXMuX3N0b3JlUHJvY2Vzc2luZ1F1ZXVlLnNwbGljZSgwKTsKICB9CiAgX3JlbW92ZU91dGdvaW5nQW5kU3RvcmVNZXNzYWdlKG1lc3NhZ2VJZCwgY2IpIHsKICAgIGRlbGV0ZSB0aGlzLm91dGdvaW5nW21lc3NhZ2VJZF07CiAgICB0aGlzLm91dGdvaW5nU3RvcmUuZGVsKHsKICAgICAgbWVzc2FnZUlkCiAgICB9LCAoZXJyLCBwYWNrZXQpID0+IHsKICAgICAgY2IoZXJyLCBwYWNrZXQpOwogICAgICB0aGlzLm1lc3NhZ2VJZFByb3ZpZGVyLmRlYWxsb2NhdGUobWVzc2FnZUlkKTsKICAgICAgdGhpcy5faW52b2tlU3RvcmVQcm9jZXNzaW5nUXVldWUoKTsKICAgIH0pOwogIH0KfQpNcXR0Q2xpZW50LlZFUlNJT04gPSBzaGFyZWRfMS5NUVRUSlNfVkVSU0lPTjsKY2xpZW50LmRlZmF1bHQgPSBNcXR0Q2xpZW50OwoKdmFyIHVuaXF1ZU1lc3NhZ2VJZFByb3ZpZGVyID0ge307CgpPYmplY3QuZGVmaW5lUHJvcGVydHkodW5pcXVlTWVzc2FnZUlkUHJvdmlkZXIsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpjb25zdCBudW1iZXJfYWxsb2NhdG9yXzEgPSBudW1iZXJBbGxvY2F0b3IkMTsKY2xhc3MgVW5pcXVlTWVzc2FnZUlkUHJvdmlkZXIgewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5udW1iZXJBbGxvY2F0b3IgPSBuZXcgbnVtYmVyX2FsbG9jYXRvcl8xLk51bWJlckFsbG9jYXRvcigxLCA2NTUzNSk7CiAgfQogIGFsbG9jYXRlKCkgewogICAgdGhpcy5sYXN0SWQgPSB0aGlzLm51bWJlckFsbG9jYXRvci5hbGxvYygpOwogICAgcmV0dXJuIHRoaXMubGFzdElkOwogIH0KICBnZXRMYXN0QWxsb2NhdGVkKCkgewogICAgcmV0dXJuIHRoaXMubGFzdElkOwogIH0KICByZWdpc3RlcihtZXNzYWdlSWQpIHsKICAgIHJldHVybiB0aGlzLm51bWJlckFsbG9jYXRvci51c2UobWVzc2FnZUlkKTsKICB9CiAgZGVhbGxvY2F0ZShtZXNzYWdlSWQpIHsKICAgIHRoaXMubnVtYmVyQWxsb2NhdG9yLmZyZWUobWVzc2FnZUlkKTsKICB9CiAgY2xlYXIoKSB7CiAgICB0aGlzLm51bWJlckFsbG9jYXRvci5jbGVhcigpOwogIH0KfQp1bmlxdWVNZXNzYWdlSWRQcm92aWRlci5kZWZhdWx0ID0gVW5pcXVlTWVzc2FnZUlkUHJvdmlkZXI7Cgp2YXIgY29ubmVjdCQxID0ge307Cgp2YXIgd3MkMSA9IHt9OwoKdmFyIGJ1ZmZlclV0aWwgPSB7ZXhwb3J0czoge319OwoKdmFyIGNvbnN0YW50cyQzOwp2YXIgaGFzUmVxdWlyZWRDb25zdGFudHMkMzsKZnVuY3Rpb24gcmVxdWlyZUNvbnN0YW50cyQzKCkgewogIGlmIChoYXNSZXF1aXJlZENvbnN0YW50cyQzKSByZXR1cm4gY29uc3RhbnRzJDM7CiAgaGFzUmVxdWlyZWRDb25zdGFudHMkMyA9IDE7CiAgY29uc3QgQklOQVJZX1RZUEVTID0gWydub2RlYnVmZmVyJywgJ2FycmF5YnVmZmVyJywgJ2ZyYWdtZW50cyddOwogIGNvbnN0IGhhc0Jsb2IgPSB0eXBlb2YgQmxvYiAhPT0gJ3VuZGVmaW5lZCc7CiAgaWYgKGhhc0Jsb2IpIEJJTkFSWV9UWVBFUy5wdXNoKCdibG9iJyk7CiAgY29uc3RhbnRzJDMgPSB7CiAgICBCSU5BUllfVFlQRVMsCiAgICBFTVBUWV9CVUZGRVI6IEJ1ZmZlci5hbGxvYygwKSwKICAgIEdVSUQ6ICcyNThFQUZBNS1FOTE0LTQ3REEtOTVDQS1DNUFCMERDODVCMTEnLAogICAgaGFzQmxvYiwKICAgIGtGb3JPbkV2ZW50QXR0cmlidXRlOiBTeW1ib2woJ2tJc0Zvck9uRXZlbnRBdHRyaWJ1dGUnKSwKICAgIGtMaXN0ZW5lcjogU3ltYm9sKCdrTGlzdGVuZXInKSwKICAgIGtTdGF0dXNDb2RlOiBTeW1ib2woJ3N0YXR1cy1jb2RlJyksCiAgICBrV2ViU29ja2V0OiBTeW1ib2woJ3dlYnNvY2tldCcpLAogICAgTk9PUDogKCkgPT4ge30KICB9OwogIHJldHVybiBjb25zdGFudHMkMzsKfQoKdmFyIGhhc1JlcXVpcmVkQnVmZmVyVXRpbDsKZnVuY3Rpb24gcmVxdWlyZUJ1ZmZlclV0aWwoKSB7CiAgaWYgKGhhc1JlcXVpcmVkQnVmZmVyVXRpbCkgcmV0dXJuIGJ1ZmZlclV0aWwuZXhwb3J0czsKICBoYXNSZXF1aXJlZEJ1ZmZlclV0aWwgPSAxOwogIGNvbnN0IHsKICAgIEVNUFRZX0JVRkZFUgogIH0gPSByZXF1aXJlQ29uc3RhbnRzJDMoKTsKICBjb25zdCBGYXN0QnVmZmVyID0gQnVmZmVyW1N5bWJvbC5zcGVjaWVzXTsKCiAgLyoqCiAgICogTWVyZ2VzIGFuIGFycmF5IG9mIGJ1ZmZlcnMgaW50byBhIG5ldyBidWZmZXIuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcltdfSBsaXN0IFRoZSBhcnJheSBvZiBidWZmZXJzIHRvIGNvbmNhdAogICAqIEBwYXJhbSB7TnVtYmVyfSB0b3RhbExlbmd0aCBUaGUgdG90YWwgbGVuZ3RoIG9mIGJ1ZmZlcnMgaW4gdGhlIGxpc3QKICAgKiBAcmV0dXJuIHtCdWZmZXJ9IFRoZSByZXN1bHRpbmcgYnVmZmVyCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIGNvbmNhdChsaXN0LCB0b3RhbExlbmd0aCkgewogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSByZXR1cm4gRU1QVFlfQlVGRkVSOwogICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSByZXR1cm4gbGlzdFswXTsKICAgIGNvbnN0IHRhcmdldCA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSh0b3RhbExlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBidWYgPSBsaXN0W2ldOwogICAgICB0YXJnZXQuc2V0KGJ1Ziwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IGJ1Zi5sZW5ndGg7CiAgICB9CiAgICBpZiAob2Zmc2V0IDwgdG90YWxMZW5ndGgpIHsKICAgICAgcmV0dXJuIG5ldyBGYXN0QnVmZmVyKHRhcmdldC5idWZmZXIsIHRhcmdldC5ieXRlT2Zmc2V0LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIHRhcmdldDsKICB9CgogIC8qKgogICAqIE1hc2tzIGEgYnVmZmVyIHVzaW5nIHRoZSBnaXZlbiBtYXNrLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IHNvdXJjZSBUaGUgYnVmZmVyIHRvIG1hc2sKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWFzayBUaGUgbWFzayB0byB1c2UKICAgKiBAcGFyYW0ge0J1ZmZlcn0gb3V0cHV0IFRoZSBidWZmZXIgd2hlcmUgdG8gc3RvcmUgdGhlIHJlc3VsdAogICAqIEBwYXJhbSB7TnVtYmVyfSBvZmZzZXQgVGhlIG9mZnNldCBhdCB3aGljaCB0byBzdGFydCB3cml0aW5nCiAgICogQHBhcmFtIHtOdW1iZXJ9IGxlbmd0aCBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRvIG1hc2suCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIF9tYXNrKHNvdXJjZSwgbWFzaywgb3V0cHV0LCBvZmZzZXQsIGxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBvdXRwdXRbb2Zmc2V0ICsgaV0gPSBzb3VyY2VbaV0gXiBtYXNrW2kgJiAzXTsKICAgIH0KICB9CgogIC8qKgogICAqIFVubWFza3MgYSBidWZmZXIgdXNpbmcgdGhlIGdpdmVuIG1hc2suCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnVmZmVyIFRoZSBidWZmZXIgdG8gdW5tYXNrCiAgICogQHBhcmFtIHtCdWZmZXJ9IG1hc2sgVGhlIG1hc2sgdG8gdXNlCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIF91bm1hc2soYnVmZmVyLCBtYXNrKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7IGkrKykgewogICAgICBidWZmZXJbaV0gXj0gbWFza1tpICYgM107CiAgICB9CiAgfQoKICAvKioKICAgKiBDb252ZXJ0cyBhIGJ1ZmZlciB0byBhbiBgQXJyYXlCdWZmZXJgLgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZiBUaGUgYnVmZmVyIHRvIGNvbnZlcnQKICAgKiBAcmV0dXJuIHtBcnJheUJ1ZmZlcn0gQ29udmVydGVkIGJ1ZmZlcgogICAqIEBwdWJsaWMKICAgKi8KICBmdW5jdGlvbiB0b0FycmF5QnVmZmVyKGJ1ZikgewogICAgaWYgKGJ1Zi5sZW5ndGggPT09IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aCkgewogICAgICByZXR1cm4gYnVmLmJ1ZmZlcjsKICAgIH0KICAgIHJldHVybiBidWYuYnVmZmVyLnNsaWNlKGJ1Zi5ieXRlT2Zmc2V0LCBidWYuYnl0ZU9mZnNldCArIGJ1Zi5sZW5ndGgpOwogIH0KCiAgLyoqCiAgICogQ29udmVydHMgYGRhdGFgIHRvIGEgYEJ1ZmZlcmAuCiAgICoKICAgKiBAcGFyYW0geyp9IGRhdGEgVGhlIGRhdGEgdG8gY29udmVydAogICAqIEByZXR1cm4ge0J1ZmZlcn0gVGhlIGJ1ZmZlcgogICAqIEB0aHJvd3Mge1R5cGVFcnJvcn0KICAgKiBAcHVibGljCiAgICovCiAgZnVuY3Rpb24gdG9CdWZmZXIoZGF0YSkgewogICAgdG9CdWZmZXIucmVhZE9ubHkgPSB0cnVlOwogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihkYXRhKSkgcmV0dXJuIGRhdGE7CiAgICBsZXQgYnVmOwogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICBidWYgPSBuZXcgRmFzdEJ1ZmZlcihkYXRhKTsKICAgIH0gZWxzZSBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgIGJ1ZiA9IG5ldyBGYXN0QnVmZmVyKGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICBidWYgPSBCdWZmZXIuZnJvbShkYXRhKTsKICAgICAgdG9CdWZmZXIucmVhZE9ubHkgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiBidWY7CiAgfQogIGJ1ZmZlclV0aWwuZXhwb3J0cyA9IHsKICAgIGNvbmNhdCwKICAgIG1hc2s6IF9tYXNrLAogICAgdG9BcnJheUJ1ZmZlciwKICAgIHRvQnVmZmVyLAogICAgdW5tYXNrOiBfdW5tYXNrCiAgfTsKCiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgICovCiAgaWYgKCFwcm9jZXNzLmVudi5XU19OT19CVUZGRVJfVVRJTCkgewogICAgdHJ5IHsKICAgICAgY29uc3QgYnVmZmVyVXRpbCQxID0gcmVxdWlyZSgnYnVmZmVydXRpbCcpOwogICAgICBidWZmZXJVdGlsLmV4cG9ydHMubWFzayA9IGZ1bmN0aW9uIChzb3VyY2UsIG1hc2ssIG91dHB1dCwgb2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgICBpZiAobGVuZ3RoIDwgNDgpIF9tYXNrKHNvdXJjZSwgbWFzaywgb3V0cHV0LCBvZmZzZXQsIGxlbmd0aCk7ZWxzZSBidWZmZXJVdGlsJDEubWFzayhzb3VyY2UsIG1hc2ssIG91dHB1dCwgb2Zmc2V0LCBsZW5ndGgpOwogICAgICB9OwogICAgICBidWZmZXJVdGlsLmV4cG9ydHMudW5tYXNrID0gZnVuY3Rpb24gKGJ1ZmZlciwgbWFzaykgewogICAgICAgIGlmIChidWZmZXIubGVuZ3RoIDwgMzIpIF91bm1hc2soYnVmZmVyLCBtYXNrKTtlbHNlIGJ1ZmZlclV0aWwkMS51bm1hc2soYnVmZmVyLCBtYXNrKTsKICAgICAgfTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgLy8gQ29udGludWUgcmVnYXJkbGVzcyBvZiB0aGUgZXJyb3IuCiAgICB9CiAgfQogIHJldHVybiBidWZmZXJVdGlsLmV4cG9ydHM7Cn0KCnZhciBsaW1pdGVyOwp2YXIgaGFzUmVxdWlyZWRMaW1pdGVyOwpmdW5jdGlvbiByZXF1aXJlTGltaXRlcigpIHsKICBpZiAoaGFzUmVxdWlyZWRMaW1pdGVyKSByZXR1cm4gbGltaXRlcjsKICBoYXNSZXF1aXJlZExpbWl0ZXIgPSAxOwogIGNvbnN0IGtEb25lID0gU3ltYm9sKCdrRG9uZScpOwogIGNvbnN0IGtSdW4gPSBTeW1ib2woJ2tSdW4nKTsKCiAgLyoqCiAgICogQSB2ZXJ5IHNpbXBsZSBqb2IgcXVldWUgd2l0aCBhZGp1c3RhYmxlIGNvbmN1cnJlbmN5LiBBZGFwdGVkIGZyb20KICAgKiBodHRwczovL2dpdGh1Yi5jb20vU1RSTUwvYXN5bmMtbGltaXRlcgogICAqLwogIGNsYXNzIExpbWl0ZXIgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGBMaW1pdGVyYC4KICAgICAqCiAgICAgKiBAcGFyYW0ge051bWJlcn0gW2NvbmN1cnJlbmN5PUluZmluaXR5XSBUaGUgbWF4aW11bSBudW1iZXIgb2Ygam9icyBhbGxvd2VkCiAgICAgKiAgICAgdG8gcnVuIGNvbmN1cnJlbnRseQogICAgICovCiAgICBjb25zdHJ1Y3Rvcihjb25jdXJyZW5jeSkgewogICAgICB0aGlzW2tEb25lXSA9ICgpID0+IHsKICAgICAgICB0aGlzLnBlbmRpbmctLTsKICAgICAgICB0aGlzW2tSdW5dKCk7CiAgICAgIH07CiAgICAgIHRoaXMuY29uY3VycmVuY3kgPSBjb25jdXJyZW5jeSB8fCBJbmZpbml0eTsKICAgICAgdGhpcy5qb2JzID0gW107CiAgICAgIHRoaXMucGVuZGluZyA9IDA7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGRzIGEgam9iIHRvIHRoZSBxdWV1ZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBqb2IgVGhlIGpvYiB0byBydW4KICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgYWRkKGpvYikgewogICAgICB0aGlzLmpvYnMucHVzaChqb2IpOwogICAgICB0aGlzW2tSdW5dKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGEgam9iIGZyb20gdGhlIHF1ZXVlIGFuZCBydW5zIGl0IGlmIHBvc3NpYmxlLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIFtrUnVuXSgpIHsKICAgICAgaWYgKHRoaXMucGVuZGluZyA9PT0gdGhpcy5jb25jdXJyZW5jeSkgcmV0dXJuOwogICAgICBpZiAodGhpcy5qb2JzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGpvYiA9IHRoaXMuam9icy5zaGlmdCgpOwogICAgICAgIHRoaXMucGVuZGluZysrOwogICAgICAgIGpvYih0aGlzW2tEb25lXSk7CiAgICAgIH0KICAgIH0KICB9CiAgbGltaXRlciA9IExpbWl0ZXI7CiAgcmV0dXJuIGxpbWl0ZXI7Cn0KCmZ1bmN0aW9uIG93bktleXMkMyhlLCByKSB7IHZhciB0ID0gT2JqZWN0LmtleXMoZSk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsgciAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uIChyKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIpLmVudW1lcmFibGU7IH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOyB9IHJldHVybiB0OyB9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQkMyhlKSB7IGZvciAodmFyIHIgPSAxOyByIDwgYXJndW1lbnRzLmxlbmd0aDsgcisrKSB7IHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcl0gPyBhcmd1bWVudHNbcl0gOiB7fTsgciAlIDIgPyBvd25LZXlzJDMoT2JqZWN0KHQpLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAocikgeyBfZGVmaW5lUHJvcGVydHkoZSwgciwgdFtyXSk7IH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzJDMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIpKTsgfSk7IH0gcmV0dXJuIGU7IH0KdmFyIHBlcm1lc3NhZ2VEZWZsYXRlOwp2YXIgaGFzUmVxdWlyZWRQZXJtZXNzYWdlRGVmbGF0ZTsKZnVuY3Rpb24gcmVxdWlyZVBlcm1lc3NhZ2VEZWZsYXRlKCkgewogIGlmIChoYXNSZXF1aXJlZFBlcm1lc3NhZ2VEZWZsYXRlKSByZXR1cm4gcGVybWVzc2FnZURlZmxhdGU7CiAgaGFzUmVxdWlyZWRQZXJtZXNzYWdlRGVmbGF0ZSA9IDE7CiAgY29uc3QgemxpYiA9IHJlcXVpcmUkJDAkNjsKICBjb25zdCBidWZmZXJVdGlsID0gcmVxdWlyZUJ1ZmZlclV0aWwoKTsKICBjb25zdCBMaW1pdGVyID0gcmVxdWlyZUxpbWl0ZXIoKTsKICBjb25zdCB7CiAgICBrU3RhdHVzQ29kZQogIH0gPSByZXF1aXJlQ29uc3RhbnRzJDMoKTsKICBjb25zdCBGYXN0QnVmZmVyID0gQnVmZmVyW1N5bWJvbC5zcGVjaWVzXTsKICBjb25zdCBUUkFJTEVSID0gQnVmZmVyLmZyb20oWzB4MDAsIDB4MDAsIDB4ZmYsIDB4ZmZdKTsKICBjb25zdCBrUGVyTWVzc2FnZURlZmxhdGUgPSBTeW1ib2woJ3Blcm1lc3NhZ2UtZGVmbGF0ZScpOwogIGNvbnN0IGtUb3RhbExlbmd0aCA9IFN5bWJvbCgndG90YWwtbGVuZ3RoJyk7CiAgY29uc3Qga0NhbGxiYWNrID0gU3ltYm9sKCdjYWxsYmFjaycpOwogIGNvbnN0IGtCdWZmZXJzID0gU3ltYm9sKCdidWZmZXJzJyk7CiAgY29uc3Qga0Vycm9yID0gU3ltYm9sKCdlcnJvcicpOwoKICAvLwogIC8vIFdlIGxpbWl0IHpsaWIgY29uY3VycmVuY3ksIHdoaWNoIHByZXZlbnRzIHNldmVyZSBtZW1vcnkgZnJhZ21lbnRhdGlvbgogIC8vIGFzIGRvY3VtZW50ZWQgaW4gaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy84ODcxI2lzc3VlY29tbWVudC0yNTA5MTU5MTMKICAvLyBhbmQgaHR0cHM6Ly9naXRodWIuY29tL3dlYnNvY2tldHMvd3MvaXNzdWVzLzEyMDIKICAvLwogIC8vIEludGVudGlvbmFsbHkgZ2xvYmFsOyBpdCdzIHRoZSBnbG9iYWwgdGhyZWFkIHBvb2wgdGhhdCdzIGFuIGlzc3VlLgogIC8vCiAgbGV0IHpsaWJMaW1pdGVyOwoKICAvKioKICAgKiBwZXJtZXNzYWdlLWRlZmxhdGUgaW1wbGVtZW50YXRpb24uCiAgICovCiAgY2xhc3MgUGVyTWVzc2FnZURlZmxhdGUgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgUGVyTWVzc2FnZURlZmxhdGUgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBDb25maWd1cmF0aW9uIG9wdGlvbnMKICAgICAqIEBwYXJhbSB7KEJvb2xlYW58TnVtYmVyKX0gW29wdGlvbnMuY2xpZW50TWF4V2luZG93Qml0c10gQWR2ZXJ0aXNlIHN1cHBvcnQKICAgICAqICAgICBmb3IsIG9yIHJlcXVlc3QsIGEgY3VzdG9tIGNsaWVudCB3aW5kb3cgc2l6ZQogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jbGllbnROb0NvbnRleHRUYWtlb3Zlcj1mYWxzZV0gQWR2ZXJ0aXNlLwogICAgICogICAgIGFja25vd2xlZGdlIGRpc2FibGluZyBvZiBjbGllbnQgY29udGV4dCB0YWtlb3ZlcgogICAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLmNvbmN1cnJlbmN5TGltaXQ9MTBdIFRoZSBudW1iZXIgb2YgY29uY3VycmVudAogICAgICogICAgIGNhbGxzIHRvIHpsaWIKICAgICAqIEBwYXJhbSB7KEJvb2xlYW58TnVtYmVyKX0gW29wdGlvbnMuc2VydmVyTWF4V2luZG93Qml0c10gUmVxdWVzdC9jb25maXJtIHRoZQogICAgICogICAgIHVzZSBvZiBhIGN1c3RvbSBzZXJ2ZXIgd2luZG93IHNpemUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuc2VydmVyTm9Db250ZXh0VGFrZW92ZXI9ZmFsc2VdIFJlcXVlc3QvYWNjZXB0CiAgICAgKiAgICAgZGlzYWJsaW5nIG9mIHNlcnZlciBjb250ZXh0IHRha2VvdmVyCiAgICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMudGhyZXNob2xkPTEwMjRdIFNpemUgKGluIGJ5dGVzKSBiZWxvdyB3aGljaAogICAgICogICAgIG1lc3NhZ2VzIHNob3VsZCBub3QgYmUgY29tcHJlc3NlZCBpZiBjb250ZXh0IHRha2VvdmVyIGlzIGRpc2FibGVkCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMuemxpYkRlZmxhdGVPcHRpb25zXSBPcHRpb25zIHRvIHBhc3MgdG8gemxpYiBvbgogICAgICogICAgIGRlZmxhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy56bGliSW5mbGF0ZU9wdGlvbnNdIE9wdGlvbnMgdG8gcGFzcyB0byB6bGliIG9uCiAgICAgKiAgICAgaW5mbGF0ZQogICAgICogQHBhcmFtIHtCb29sZWFufSBbaXNTZXJ2ZXI9ZmFsc2VdIENyZWF0ZSB0aGUgaW5zdGFuY2UgaW4gZWl0aGVyIHNlcnZlciBvcgogICAgICogICAgIGNsaWVudCBtb2RlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gW21heFBheWxvYWQ9MF0gVGhlIG1heGltdW0gYWxsb3dlZCBtZXNzYWdlIGxlbmd0aAogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zLCBpc1NlcnZlciwgbWF4UGF5bG9hZCkgewogICAgICB0aGlzLl9tYXhQYXlsb2FkID0gbWF4UGF5bG9hZCB8IDA7CiAgICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLl90aHJlc2hvbGQgPSB0aGlzLl9vcHRpb25zLnRocmVzaG9sZCAhPT0gdW5kZWZpbmVkID8gdGhpcy5fb3B0aW9ucy50aHJlc2hvbGQgOiAxMDI0OwogICAgICB0aGlzLl9pc1NlcnZlciA9ICEhaXNTZXJ2ZXI7CiAgICAgIHRoaXMuX2RlZmxhdGUgPSBudWxsOwogICAgICB0aGlzLl9pbmZsYXRlID0gbnVsbDsKICAgICAgdGhpcy5wYXJhbXMgPSBudWxsOwogICAgICBpZiAoIXpsaWJMaW1pdGVyKSB7CiAgICAgICAgY29uc3QgY29uY3VycmVuY3kgPSB0aGlzLl9vcHRpb25zLmNvbmN1cnJlbmN5TGltaXQgIT09IHVuZGVmaW5lZCA/IHRoaXMuX29wdGlvbnMuY29uY3VycmVuY3lMaW1pdCA6IDEwOwogICAgICAgIHpsaWJMaW1pdGVyID0gbmV3IExpbWl0ZXIoY29uY3VycmVuY3kpOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBzdGF0aWMgZ2V0IGV4dGVuc2lvbk5hbWUoKSB7CiAgICAgIHJldHVybiAncGVybWVzc2FnZS1kZWZsYXRlJzsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZSBhbiBleHRlbnNpb24gbmVnb3RpYXRpb24gb2ZmZXIuCiAgICAgKgogICAgICogQHJldHVybiB7T2JqZWN0fSBFeHRlbnNpb24gcGFyYW1ldGVycwogICAgICogQHB1YmxpYwogICAgICovCiAgICBvZmZlcigpIHsKICAgICAgY29uc3QgcGFyYW1zID0ge307CiAgICAgIGlmICh0aGlzLl9vcHRpb25zLnNlcnZlck5vQ29udGV4dFRha2VvdmVyKSB7CiAgICAgICAgcGFyYW1zLnNlcnZlcl9ub19jb250ZXh0X3Rha2VvdmVyID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy5fb3B0aW9ucy5jbGllbnROb0NvbnRleHRUYWtlb3ZlcikgewogICAgICAgIHBhcmFtcy5jbGllbnRfbm9fY29udGV4dF90YWtlb3ZlciA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX29wdGlvbnMuc2VydmVyTWF4V2luZG93Qml0cykgewogICAgICAgIHBhcmFtcy5zZXJ2ZXJfbWF4X3dpbmRvd19iaXRzID0gdGhpcy5fb3B0aW9ucy5zZXJ2ZXJNYXhXaW5kb3dCaXRzOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmNsaWVudE1heFdpbmRvd0JpdHMpIHsKICAgICAgICBwYXJhbXMuY2xpZW50X21heF93aW5kb3dfYml0cyA9IHRoaXMuX29wdGlvbnMuY2xpZW50TWF4V2luZG93Qml0czsKICAgICAgfSBlbHNlIGlmICh0aGlzLl9vcHRpb25zLmNsaWVudE1heFdpbmRvd0JpdHMgPT0gbnVsbCkgewogICAgICAgIHBhcmFtcy5jbGllbnRfbWF4X3dpbmRvd19iaXRzID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQoKICAgIC8qKgogICAgICogQWNjZXB0IGFuIGV4dGVuc2lvbiBuZWdvdGlhdGlvbiBvZmZlci9yZXNwb25zZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBjb25maWd1cmF0aW9ucyBUaGUgZXh0ZW5zaW9uIG5lZ290aWF0aW9uIG9mZmVycy9yZXBvbnNlCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEFjY2VwdGVkIGNvbmZpZ3VyYXRpb24KICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgYWNjZXB0KGNvbmZpZ3VyYXRpb25zKSB7CiAgICAgIGNvbmZpZ3VyYXRpb25zID0gdGhpcy5ub3JtYWxpemVQYXJhbXMoY29uZmlndXJhdGlvbnMpOwogICAgICB0aGlzLnBhcmFtcyA9IHRoaXMuX2lzU2VydmVyID8gdGhpcy5hY2NlcHRBc1NlcnZlcihjb25maWd1cmF0aW9ucykgOiB0aGlzLmFjY2VwdEFzQ2xpZW50KGNvbmZpZ3VyYXRpb25zKTsKICAgICAgcmV0dXJuIHRoaXMucGFyYW1zOwogICAgfQoKICAgIC8qKgogICAgICogUmVsZWFzZXMgYWxsIHJlc291cmNlcyB1c2VkIGJ5IHRoZSBleHRlbnNpb24uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBjbGVhbnVwKCkgewogICAgICBpZiAodGhpcy5faW5mbGF0ZSkgewogICAgICAgIHRoaXMuX2luZmxhdGUuY2xvc2UoKTsKICAgICAgICB0aGlzLl9pbmZsYXRlID0gbnVsbDsKICAgICAgfQogICAgICBpZiAodGhpcy5fZGVmbGF0ZSkgewogICAgICAgIGNvbnN0IGNhbGxiYWNrID0gdGhpcy5fZGVmbGF0ZVtrQ2FsbGJhY2tdOwogICAgICAgIHRoaXMuX2RlZmxhdGUuY2xvc2UoKTsKICAgICAgICB0aGlzLl9kZWZsYXRlID0gbnVsbDsKICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignVGhlIGRlZmxhdGUgc3RyZWFtIHdhcyBjbG9zZWQgd2hpbGUgZGF0YSB3YXMgYmVpbmcgcHJvY2Vzc2VkJykpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogIEFjY2VwdCBhbiBleHRlbnNpb24gbmVnb3RpYXRpb24gb2ZmZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gb2ZmZXJzIFRoZSBleHRlbnNpb24gbmVnb3RpYXRpb24gb2ZmZXJzCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEFjY2VwdGVkIGNvbmZpZ3VyYXRpb24KICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGFjY2VwdEFzU2VydmVyKG9mZmVycykgewogICAgICBjb25zdCBvcHRzID0gdGhpcy5fb3B0aW9uczsKICAgICAgY29uc3QgYWNjZXB0ZWQgPSBvZmZlcnMuZmluZChwYXJhbXMgPT4gewogICAgICAgIGlmIChvcHRzLnNlcnZlck5vQ29udGV4dFRha2VvdmVyID09PSBmYWxzZSAmJiBwYXJhbXMuc2VydmVyX25vX2NvbnRleHRfdGFrZW92ZXIgfHwgcGFyYW1zLnNlcnZlcl9tYXhfd2luZG93X2JpdHMgJiYgKG9wdHMuc2VydmVyTWF4V2luZG93Qml0cyA9PT0gZmFsc2UgfHwgdHlwZW9mIG9wdHMuc2VydmVyTWF4V2luZG93Qml0cyA9PT0gJ251bWJlcicgJiYgb3B0cy5zZXJ2ZXJNYXhXaW5kb3dCaXRzID4gcGFyYW1zLnNlcnZlcl9tYXhfd2luZG93X2JpdHMpIHx8IHR5cGVvZiBvcHRzLmNsaWVudE1heFdpbmRvd0JpdHMgPT09ICdudW1iZXInICYmICFwYXJhbXMuY2xpZW50X21heF93aW5kb3dfYml0cykgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSk7CiAgICAgIGlmICghYWNjZXB0ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vbmUgb2YgdGhlIGV4dGVuc2lvbiBvZmZlcnMgY2FuIGJlIGFjY2VwdGVkJyk7CiAgICAgIH0KICAgICAgaWYgKG9wdHMuc2VydmVyTm9Db250ZXh0VGFrZW92ZXIpIHsKICAgICAgICBhY2NlcHRlZC5zZXJ2ZXJfbm9fY29udGV4dF90YWtlb3ZlciA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKG9wdHMuY2xpZW50Tm9Db250ZXh0VGFrZW92ZXIpIHsKICAgICAgICBhY2NlcHRlZC5jbGllbnRfbm9fY29udGV4dF90YWtlb3ZlciA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBvcHRzLnNlcnZlck1heFdpbmRvd0JpdHMgPT09ICdudW1iZXInKSB7CiAgICAgICAgYWNjZXB0ZWQuc2VydmVyX21heF93aW5kb3dfYml0cyA9IG9wdHMuc2VydmVyTWF4V2luZG93Qml0czsKICAgICAgfQogICAgICBpZiAodHlwZW9mIG9wdHMuY2xpZW50TWF4V2luZG93Qml0cyA9PT0gJ251bWJlcicpIHsKICAgICAgICBhY2NlcHRlZC5jbGllbnRfbWF4X3dpbmRvd19iaXRzID0gb3B0cy5jbGllbnRNYXhXaW5kb3dCaXRzOwogICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkLmNsaWVudF9tYXhfd2luZG93X2JpdHMgPT09IHRydWUgfHwgb3B0cy5jbGllbnRNYXhXaW5kb3dCaXRzID09PSBmYWxzZSkgewogICAgICAgIGRlbGV0ZSBhY2NlcHRlZC5jbGllbnRfbWF4X3dpbmRvd19iaXRzOwogICAgICB9CiAgICAgIHJldHVybiBhY2NlcHRlZDsKICAgIH0KCiAgICAvKioKICAgICAqIEFjY2VwdCB0aGUgZXh0ZW5zaW9uIG5lZ290aWF0aW9uIHJlc3BvbnNlLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXl9IHJlc3BvbnNlIFRoZSBleHRlbnNpb24gbmVnb3RpYXRpb24gcmVzcG9uc2UKICAgICAqIEByZXR1cm4ge09iamVjdH0gQWNjZXB0ZWQgY29uZmlndXJhdGlvbgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgYWNjZXB0QXNDbGllbnQocmVzcG9uc2UpIHsKICAgICAgY29uc3QgcGFyYW1zID0gcmVzcG9uc2VbMF07CiAgICAgIGlmICh0aGlzLl9vcHRpb25zLmNsaWVudE5vQ29udGV4dFRha2VvdmVyID09PSBmYWxzZSAmJiBwYXJhbXMuY2xpZW50X25vX2NvbnRleHRfdGFrZW92ZXIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuZXhwZWN0ZWQgcGFyYW1ldGVyICJjbGllbnRfbm9fY29udGV4dF90YWtlb3ZlciInKTsKICAgICAgfQogICAgICBpZiAoIXBhcmFtcy5jbGllbnRfbWF4X3dpbmRvd19iaXRzKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9vcHRpb25zLmNsaWVudE1heFdpbmRvd0JpdHMgPT09ICdudW1iZXInKSB7CiAgICAgICAgICBwYXJhbXMuY2xpZW50X21heF93aW5kb3dfYml0cyA9IHRoaXMuX29wdGlvbnMuY2xpZW50TWF4V2luZG93Qml0czsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fb3B0aW9ucy5jbGllbnRNYXhXaW5kb3dCaXRzID09PSBmYWxzZSB8fCB0eXBlb2YgdGhpcy5fb3B0aW9ucy5jbGllbnRNYXhXaW5kb3dCaXRzID09PSAnbnVtYmVyJyAmJiBwYXJhbXMuY2xpZW50X21heF93aW5kb3dfYml0cyA+IHRoaXMuX29wdGlvbnMuY2xpZW50TWF4V2luZG93Qml0cykgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBvciBpbnZhbGlkIHBhcmFtZXRlciAiY2xpZW50X21heF93aW5kb3dfYml0cyInKTsKICAgICAgfQogICAgICByZXR1cm4gcGFyYW1zOwogICAgfQoKICAgIC8qKgogICAgICogTm9ybWFsaXplIHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIHtBcnJheX0gY29uZmlndXJhdGlvbnMgVGhlIGV4dGVuc2lvbiBuZWdvdGlhdGlvbiBvZmZlcnMvcmVwb25zZQogICAgICogQHJldHVybiB7QXJyYXl9IFRoZSBvZmZlcnMvcmVzcG9uc2Ugd2l0aCBub3JtYWxpemVkIHBhcmFtZXRlcnMKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIG5vcm1hbGl6ZVBhcmFtcyhjb25maWd1cmF0aW9ucykgewogICAgICBjb25maWd1cmF0aW9ucy5mb3JFYWNoKHBhcmFtcyA9PiB7CiAgICAgICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgICBsZXQgdmFsdWUgPSBwYXJhbXNba2V5XTsKICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFyYW1ldGVyICIke2tleX0iIG11c3QgaGF2ZSBvbmx5IGEgc2luZ2xlIHZhbHVlYCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlWzBdOwogICAgICAgICAgaWYgKGtleSA9PT0gJ2NsaWVudF9tYXhfd2luZG93X2JpdHMnKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGNvbnN0IG51bSA9ICt2YWx1ZTsKICAgICAgICAgICAgICBpZiAoIU51bWJlci5pc0ludGVnZXIobnVtKSB8fCBudW0gPCA4IHx8IG51bSA+IDE1KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBJbnZhbGlkIHZhbHVlIGZvciBwYXJhbWV0ZXIgIiR7a2V5fSI6ICR7dmFsdWV9YCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhbHVlID0gbnVtOwogICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9pc1NlcnZlcikgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYEludmFsaWQgdmFsdWUgZm9yIHBhcmFtZXRlciAiJHtrZXl9IjogJHt2YWx1ZX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdzZXJ2ZXJfbWF4X3dpbmRvd19iaXRzJykgewogICAgICAgICAgICBjb25zdCBudW0gPSArdmFsdWU7CiAgICAgICAgICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihudW0pIHx8IG51bSA8IDggfHwgbnVtID4gMTUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBJbnZhbGlkIHZhbHVlIGZvciBwYXJhbWV0ZXIgIiR7a2V5fSI6ICR7dmFsdWV9YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFsdWUgPSBudW07CiAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2NsaWVudF9ub19jb250ZXh0X3Rha2VvdmVyJyB8fCBrZXkgPT09ICdzZXJ2ZXJfbm9fY29udGV4dF90YWtlb3ZlcicpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgSW52YWxpZCB2YWx1ZSBmb3IgcGFyYW1ldGVyICIke2tleX0iOiAke3ZhbHVlfWApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcGFyYW1ldGVyICIke2tleX0iYCk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGNvbmZpZ3VyYXRpb25zOwogICAgfQoKICAgIC8qKgogICAgICogRGVjb21wcmVzcyBkYXRhLiBDb25jdXJyZW5jeSBsaW1pdGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7QnVmZmVyfSBkYXRhIENvbXByZXNzZWQgZGF0YQogICAgICogQHBhcmFtIHtCb29sZWFufSBmaW4gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRoaXMgaXMgdGhlIGxhc3QgZnJhZ21lbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIENhbGxiYWNrCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIGRlY29tcHJlc3MoZGF0YSwgZmluLCBjYWxsYmFjaykgewogICAgICB6bGliTGltaXRlci5hZGQoZG9uZSA9PiB7CiAgICAgICAgdGhpcy5fZGVjb21wcmVzcyhkYXRhLCBmaW4sIChlcnIsIHJlc3VsdCkgPT4gewogICAgICAgICAgZG9uZSgpOwogICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHQpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbXByZXNzIGRhdGEuIENvbmN1cnJlbmN5IGxpbWl0ZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsoQnVmZmVyfFN0cmluZyl9IGRhdGEgRGF0YSB0byBjb21wcmVzcwogICAgICogQHBhcmFtIHtCb29sZWFufSBmaW4gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRoaXMgaXMgdGhlIGxhc3QgZnJhZ21lbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIENhbGxiYWNrCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIGNvbXByZXNzKGRhdGEsIGZpbiwgY2FsbGJhY2spIHsKICAgICAgemxpYkxpbWl0ZXIuYWRkKGRvbmUgPT4gewogICAgICAgIHRoaXMuX2NvbXByZXNzKGRhdGEsIGZpbiwgKGVyciwgcmVzdWx0KSA9PiB7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgICBjYWxsYmFjayhlcnIsIHJlc3VsdCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogRGVjb21wcmVzcyBkYXRhLgogICAgICoKICAgICAqIEBwYXJhbSB7QnVmZmVyfSBkYXRhIENvbXByZXNzZWQgZGF0YQogICAgICogQHBhcmFtIHtCb29sZWFufSBmaW4gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRoaXMgaXMgdGhlIGxhc3QgZnJhZ21lbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIENhbGxiYWNrCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBfZGVjb21wcmVzcyhkYXRhLCBmaW4sIGNhbGxiYWNrKSB7CiAgICAgIGNvbnN0IGVuZHBvaW50ID0gdGhpcy5faXNTZXJ2ZXIgPyAnY2xpZW50JyA6ICdzZXJ2ZXInOwogICAgICBpZiAoIXRoaXMuX2luZmxhdGUpIHsKICAgICAgICBjb25zdCBrZXkgPSBgJHtlbmRwb2ludH1fbWF4X3dpbmRvd19iaXRzYDsKICAgICAgICBjb25zdCB3aW5kb3dCaXRzID0gdHlwZW9mIHRoaXMucGFyYW1zW2tleV0gIT09ICdudW1iZXInID8gemxpYi5aX0RFRkFVTFRfV0lORE9XQklUUyA6IHRoaXMucGFyYW1zW2tleV07CiAgICAgICAgdGhpcy5faW5mbGF0ZSA9IHpsaWIuY3JlYXRlSW5mbGF0ZVJhdyhfb2JqZWN0U3ByZWFkJDMoX29iamVjdFNwcmVhZCQzKHt9LCB0aGlzLl9vcHRpb25zLnpsaWJJbmZsYXRlT3B0aW9ucyksIHt9LCB7CiAgICAgICAgICB3aW5kb3dCaXRzCiAgICAgICAgfSkpOwogICAgICAgIHRoaXMuX2luZmxhdGVba1Blck1lc3NhZ2VEZWZsYXRlXSA9IHRoaXM7CiAgICAgICAgdGhpcy5faW5mbGF0ZVtrVG90YWxMZW5ndGhdID0gMDsKICAgICAgICB0aGlzLl9pbmZsYXRlW2tCdWZmZXJzXSA9IFtdOwogICAgICAgIHRoaXMuX2luZmxhdGUub24oJ2Vycm9yJywgaW5mbGF0ZU9uRXJyb3IpOwogICAgICAgIHRoaXMuX2luZmxhdGUub24oJ2RhdGEnLCBpbmZsYXRlT25EYXRhKTsKICAgICAgfQogICAgICB0aGlzLl9pbmZsYXRlW2tDYWxsYmFja10gPSBjYWxsYmFjazsKICAgICAgdGhpcy5faW5mbGF0ZS53cml0ZShkYXRhKTsKICAgICAgaWYgKGZpbikgdGhpcy5faW5mbGF0ZS53cml0ZShUUkFJTEVSKTsKICAgICAgdGhpcy5faW5mbGF0ZS5mbHVzaCgoKSA9PiB7CiAgICAgICAgY29uc3QgZXJyID0gdGhpcy5faW5mbGF0ZVtrRXJyb3JdOwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHRoaXMuX2luZmxhdGUuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX2luZmxhdGUgPSBudWxsOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0YSA9IGJ1ZmZlclV0aWwuY29uY2F0KHRoaXMuX2luZmxhdGVba0J1ZmZlcnNdLCB0aGlzLl9pbmZsYXRlW2tUb3RhbExlbmd0aF0pOwogICAgICAgIGlmICh0aGlzLl9pbmZsYXRlLl9yZWFkYWJsZVN0YXRlLmVuZEVtaXR0ZWQpIHsKICAgICAgICAgIHRoaXMuX2luZmxhdGUuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX2luZmxhdGUgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9pbmZsYXRlW2tUb3RhbExlbmd0aF0gPSAwOwogICAgICAgICAgdGhpcy5faW5mbGF0ZVtrQnVmZmVyc10gPSBbXTsKICAgICAgICAgIGlmIChmaW4gJiYgdGhpcy5wYXJhbXNbYCR7ZW5kcG9pbnR9X25vX2NvbnRleHRfdGFrZW92ZXJgXSkgewogICAgICAgICAgICB0aGlzLl9pbmZsYXRlLnJlc2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbXByZXNzIGRhdGEuCiAgICAgKgogICAgICogQHBhcmFtIHsoQnVmZmVyfFN0cmluZyl9IGRhdGEgRGF0YSB0byBjb21wcmVzcwogICAgICogQHBhcmFtIHtCb29sZWFufSBmaW4gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRoaXMgaXMgdGhlIGxhc3QgZnJhZ21lbnQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIENhbGxiYWNrCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBfY29tcHJlc3MoZGF0YSwgZmluLCBjYWxsYmFjaykgewogICAgICBjb25zdCBlbmRwb2ludCA9IHRoaXMuX2lzU2VydmVyID8gJ3NlcnZlcicgOiAnY2xpZW50JzsKICAgICAgaWYgKCF0aGlzLl9kZWZsYXRlKSB7CiAgICAgICAgY29uc3Qga2V5ID0gYCR7ZW5kcG9pbnR9X21heF93aW5kb3dfYml0c2A7CiAgICAgICAgY29uc3Qgd2luZG93Qml0cyA9IHR5cGVvZiB0aGlzLnBhcmFtc1trZXldICE9PSAnbnVtYmVyJyA/IHpsaWIuWl9ERUZBVUxUX1dJTkRPV0JJVFMgOiB0aGlzLnBhcmFtc1trZXldOwogICAgICAgIHRoaXMuX2RlZmxhdGUgPSB6bGliLmNyZWF0ZURlZmxhdGVSYXcoX29iamVjdFNwcmVhZCQzKF9vYmplY3RTcHJlYWQkMyh7fSwgdGhpcy5fb3B0aW9ucy56bGliRGVmbGF0ZU9wdGlvbnMpLCB7fSwgewogICAgICAgICAgd2luZG93Qml0cwogICAgICAgIH0pKTsKICAgICAgICB0aGlzLl9kZWZsYXRlW2tUb3RhbExlbmd0aF0gPSAwOwogICAgICAgIHRoaXMuX2RlZmxhdGVba0J1ZmZlcnNdID0gW107CiAgICAgICAgdGhpcy5fZGVmbGF0ZS5vbignZGF0YScsIGRlZmxhdGVPbkRhdGEpOwogICAgICB9CiAgICAgIHRoaXMuX2RlZmxhdGVba0NhbGxiYWNrXSA9IGNhbGxiYWNrOwogICAgICB0aGlzLl9kZWZsYXRlLndyaXRlKGRhdGEpOwogICAgICB0aGlzLl9kZWZsYXRlLmZsdXNoKHpsaWIuWl9TWU5DX0ZMVVNILCAoKSA9PiB7CiAgICAgICAgaWYgKCF0aGlzLl9kZWZsYXRlKSB7CiAgICAgICAgICAvLwogICAgICAgICAgLy8gVGhlIGRlZmxhdGUgc3RyZWFtIHdhcyBjbG9zZWQgd2hpbGUgZGF0YSB3YXMgYmVpbmcgcHJvY2Vzc2VkLgogICAgICAgICAgLy8KICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IGRhdGEgPSBidWZmZXJVdGlsLmNvbmNhdCh0aGlzLl9kZWZsYXRlW2tCdWZmZXJzXSwgdGhpcy5fZGVmbGF0ZVtrVG90YWxMZW5ndGhdKTsKICAgICAgICBpZiAoZmluKSB7CiAgICAgICAgICBkYXRhID0gbmV3IEZhc3RCdWZmZXIoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5sZW5ndGggLSA0KTsKICAgICAgICB9CgogICAgICAgIC8vCiAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIGNhbGxiYWNrIHdpbGwgbm90IGJlIGNhbGxlZCBhZ2FpbiBpbgogICAgICAgIC8vIGBQZXJNZXNzYWdlRGVmbGF0ZSNjbGVhbnVwKClgLgogICAgICAgIC8vCiAgICAgICAgdGhpcy5fZGVmbGF0ZVtrQ2FsbGJhY2tdID0gbnVsbDsKICAgICAgICB0aGlzLl9kZWZsYXRlW2tUb3RhbExlbmd0aF0gPSAwOwogICAgICAgIHRoaXMuX2RlZmxhdGVba0J1ZmZlcnNdID0gW107CiAgICAgICAgaWYgKGZpbiAmJiB0aGlzLnBhcmFtc1tgJHtlbmRwb2ludH1fbm9fY29udGV4dF90YWtlb3ZlcmBdKSB7CiAgICAgICAgICB0aGlzLl9kZWZsYXRlLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEpOwogICAgICB9KTsKICAgIH0KICB9CiAgcGVybWVzc2FnZURlZmxhdGUgPSBQZXJNZXNzYWdlRGVmbGF0ZTsKCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgemxpYi5EZWZsYXRlUmF3YCBzdHJlYW0gYCdkYXRhJ2AgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gY2h1bmsgQSBjaHVuayBvZiBkYXRhCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBkZWZsYXRlT25EYXRhKGNodW5rKSB7CiAgICB0aGlzW2tCdWZmZXJzXS5wdXNoKGNodW5rKTsKICAgIHRoaXNba1RvdGFsTGVuZ3RoXSArPSBjaHVuay5sZW5ndGg7CiAgfQoKICAvKioKICAgKiBUaGUgbGlzdGVuZXIgb2YgdGhlIGB6bGliLkluZmxhdGVSYXdgIHN0cmVhbSBgJ2RhdGEnYCBldmVudC4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBjaHVuayBBIGNodW5rIG9mIGRhdGEKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGluZmxhdGVPbkRhdGEoY2h1bmspIHsKICAgIHRoaXNba1RvdGFsTGVuZ3RoXSArPSBjaHVuay5sZW5ndGg7CiAgICBpZiAodGhpc1trUGVyTWVzc2FnZURlZmxhdGVdLl9tYXhQYXlsb2FkIDwgMSB8fCB0aGlzW2tUb3RhbExlbmd0aF0gPD0gdGhpc1trUGVyTWVzc2FnZURlZmxhdGVdLl9tYXhQYXlsb2FkKSB7CiAgICAgIHRoaXNba0J1ZmZlcnNdLnB1c2goY2h1bmspOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzW2tFcnJvcl0gPSBuZXcgUmFuZ2VFcnJvcignTWF4IHBheWxvYWQgc2l6ZSBleGNlZWRlZCcpOwogICAgdGhpc1trRXJyb3JdLmNvZGUgPSAnV1NfRVJSX1VOU1VQUE9SVEVEX01FU1NBR0VfTEVOR1RIJzsKICAgIHRoaXNba0Vycm9yXVtrU3RhdHVzQ29kZV0gPSAxMDA5OwogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignZGF0YScsIGluZmxhdGVPbkRhdGEpOwogICAgdGhpcy5yZXNldCgpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgemxpYi5JbmZsYXRlUmF3YCBzdHJlYW0gYCdlcnJvcidgIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHtFcnJvcn0gZXJyIFRoZSBlbWl0dGVkIGVycm9yCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpbmZsYXRlT25FcnJvcihlcnIpIHsKICAgIC8vCiAgICAvLyBUaGVyZSBpcyBubyBuZWVkIHRvIGNhbGwgYFpsaWIjY2xvc2UoKWAgYXMgdGhlIGhhbmRsZSBpcyBhdXRvbWF0aWNhbGx5CiAgICAvLyBjbG9zZWQgd2hlbiBhbiBlcnJvciBpcyBlbWl0dGVkLgogICAgLy8KICAgIHRoaXNba1Blck1lc3NhZ2VEZWZsYXRlXS5faW5mbGF0ZSA9IG51bGw7CiAgICBlcnJba1N0YXR1c0NvZGVdID0gMTAwNzsKICAgIHRoaXNba0NhbGxiYWNrXShlcnIpOwogIH0KICByZXR1cm4gcGVybWVzc2FnZURlZmxhdGU7Cn0KCnZhciB2YWxpZGF0aW9uID0ge2V4cG9ydHM6IHt9fTsKCnZhciBoYXNSZXF1aXJlZFZhbGlkYXRpb247CmZ1bmN0aW9uIHJlcXVpcmVWYWxpZGF0aW9uKCkgewogIGlmIChoYXNSZXF1aXJlZFZhbGlkYXRpb24pIHJldHVybiB2YWxpZGF0aW9uLmV4cG9ydHM7CiAgaGFzUmVxdWlyZWRWYWxpZGF0aW9uID0gMTsKICBjb25zdCB7CiAgICBpc1V0ZjgKICB9ID0gcmVxdWlyZSQkMCQzOwogIGNvbnN0IHsKICAgIGhhc0Jsb2IKICB9ID0gcmVxdWlyZUNvbnN0YW50cyQzKCk7CgogIC8vCiAgLy8gQWxsb3dlZCB0b2tlbiBjaGFyYWN0ZXJzOgogIC8vCiAgLy8gJyEnLCAnIycsICckJywgJyUnLCAnJicsICcnJywgJyonLCAnKycsICctJywKICAvLyAnLicsIDAtOSwgQS1aLCAnXicsICdfJywgJ2AnLCBhLXosICd8JywgJ34nCiAgLy8KICAvLyB0b2tlbkNoYXJzWzMyXSA9PT0gMCAvLyAnICcKICAvLyB0b2tlbkNoYXJzWzMzXSA9PT0gMSAvLyAnIScKICAvLyB0b2tlbkNoYXJzWzM0XSA9PT0gMCAvLyAnIicKICAvLyAuLi4KICAvLwogIC8vIHByZXR0aWVyLWlnbm9yZQogIGNvbnN0IHRva2VuQ2hhcnMgPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwKICAvLyAwIC0gMTUKICAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLAogIC8vIDE2IC0gMzEKICAwLCAxLCAwLCAxLCAxLCAxLCAxLCAxLCAwLCAwLCAxLCAxLCAwLCAxLCAxLCAwLAogIC8vIDMyIC0gNDcKICAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAwLCAwLCAwLCAwLCAwLCAwLAogIC8vIDQ4IC0gNjMKICAwLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLAogIC8vIDY0IC0gNzkKICAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAwLCAwLCAwLCAxLCAxLAogIC8vIDgwIC0gOTUKICAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLCAxLAogIC8vIDk2IC0gMTExCiAgMSwgMSwgMSwgMSwgMSwgMSwgMSwgMSwgMSwgMSwgMSwgMCwgMSwgMCwgMSwgMCAvLyAxMTIgLSAxMjcKICBdOwoKICAvKioKICAgKiBDaGVja3MgaWYgYSBzdGF0dXMgY29kZSBpcyBhbGxvd2VkIGluIGEgY2xvc2UgZnJhbWUuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gY29kZSBUaGUgc3RhdHVzIGNvZGUKICAgKiBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIHN0YXR1cyBjb2RlIGlzIHZhbGlkLCBlbHNlIGBmYWxzZWAKICAgKiBAcHVibGljCiAgICovCiAgZnVuY3Rpb24gaXNWYWxpZFN0YXR1c0NvZGUoY29kZSkgewogICAgcmV0dXJuIGNvZGUgPj0gMTAwMCAmJiBjb2RlIDw9IDEwMTQgJiYgY29kZSAhPT0gMTAwNCAmJiBjb2RlICE9PSAxMDA1ICYmIGNvZGUgIT09IDEwMDYgfHwgY29kZSA+PSAzMDAwICYmIGNvZGUgPD0gNDk5OTsKICB9CgogIC8qKgogICAqIENoZWNrcyBpZiBhIGdpdmVuIGJ1ZmZlciBjb250YWlucyBvbmx5IGNvcnJlY3QgVVRGLTguCiAgICogUG9ydGVkIGZyb20gaHR0cHM6Ly93d3cuY2wuY2FtLmFjLnVrLyU3RW1nazI1L3Vjcy91dGY4X2NoZWNrLmMgYnkKICAgKiBNYXJrdXMgS3Vobi4KICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBidWYgVGhlIGJ1ZmZlciB0byBjaGVjawogICAqIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiBgYnVmYCBjb250YWlucyBvbmx5IGNvcnJlY3QgVVRGLTgsIGVsc2UgYGZhbHNlYAogICAqIEBwdWJsaWMKICAgKi8KICBmdW5jdGlvbiBfaXNWYWxpZFVURjgoYnVmKSB7CiAgICBjb25zdCBsZW4gPSBidWYubGVuZ3RoOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgaWYgKChidWZbaV0gJiAweDgwKSA9PT0gMCkgewogICAgICAgIC8vIDB4eHh4eHh4CiAgICAgICAgaSsrOwogICAgICB9IGVsc2UgaWYgKChidWZbaV0gJiAweGUwKSA9PT0gMHhjMCkgewogICAgICAgIC8vIDExMHh4eHh4IDEweHh4eHh4CiAgICAgICAgaWYgKGkgKyAxID09PSBsZW4gfHwgKGJ1ZltpICsgMV0gJiAweGMwKSAhPT0gMHg4MCB8fCAoYnVmW2ldICYgMHhmZSkgPT09IDB4YzAgLy8gT3ZlcmxvbmcKICAgICAgICApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaSArPSAyOwogICAgICB9IGVsc2UgaWYgKChidWZbaV0gJiAweGYwKSA9PT0gMHhlMCkgewogICAgICAgIC8vIDExMTB4eHh4IDEweHh4eHh4IDEweHh4eHh4CiAgICAgICAgaWYgKGkgKyAyID49IGxlbiB8fCAoYnVmW2kgKyAxXSAmIDB4YzApICE9PSAweDgwIHx8IChidWZbaSArIDJdICYgMHhjMCkgIT09IDB4ODAgfHwgYnVmW2ldID09PSAweGUwICYmIChidWZbaSArIDFdICYgMHhlMCkgPT09IDB4ODAgfHwKICAgICAgICAvLyBPdmVybG9uZwogICAgICAgIGJ1ZltpXSA9PT0gMHhlZCAmJiAoYnVmW2kgKyAxXSAmIDB4ZTApID09PSAweGEwIC8vIFN1cnJvZ2F0ZSAoVStEODAwIC0gVStERkZGKQogICAgICAgICkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpICs9IDM7CiAgICAgIH0gZWxzZSBpZiAoKGJ1ZltpXSAmIDB4ZjgpID09PSAweGYwKSB7CiAgICAgICAgLy8gMTExMTB4eHggMTB4eHh4eHggMTB4eHh4eHggMTB4eHh4eHgKICAgICAgICBpZiAoaSArIDMgPj0gbGVuIHx8IChidWZbaSArIDFdICYgMHhjMCkgIT09IDB4ODAgfHwgKGJ1ZltpICsgMl0gJiAweGMwKSAhPT0gMHg4MCB8fCAoYnVmW2kgKyAzXSAmIDB4YzApICE9PSAweDgwIHx8IGJ1ZltpXSA9PT0gMHhmMCAmJiAoYnVmW2kgKyAxXSAmIDB4ZjApID09PSAweDgwIHx8CiAgICAgICAgLy8gT3ZlcmxvbmcKICAgICAgICBidWZbaV0gPT09IDB4ZjQgJiYgYnVmW2kgKyAxXSA+IDB4OGYgfHwgYnVmW2ldID4gMHhmNCAvLyA+IFUrMTBGRkZGCiAgICAgICAgKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGkgKz0gNDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqCiAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIGEgdmFsdWUgaXMgYSBgQmxvYmAuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBiZSB0ZXN0ZWQKICAgKiBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIGBCbG9iYCwgZWxzZSBgZmFsc2VgCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0Jsb2IodmFsdWUpIHsKICAgIHJldHVybiBoYXNCbG9iICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmFycmF5QnVmZmVyID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiB2YWx1ZS50eXBlID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgdmFsdWUuc3RyZWFtID09PSAnZnVuY3Rpb24nICYmICh2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnQmxvYicgfHwgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gJ0ZpbGUnKTsKICB9CiAgdmFsaWRhdGlvbi5leHBvcnRzID0gewogICAgaXNCbG9iLAogICAgaXNWYWxpZFN0YXR1c0NvZGUsCiAgICBpc1ZhbGlkVVRGODogX2lzVmFsaWRVVEY4LAogICAgdG9rZW5DaGFycwogIH07CiAgaWYgKGlzVXRmOCkgewogICAgdmFsaWRhdGlvbi5leHBvcnRzLmlzVmFsaWRVVEY4ID0gZnVuY3Rpb24gKGJ1ZikgewogICAgICByZXR1cm4gYnVmLmxlbmd0aCA8IDI0ID8gX2lzVmFsaWRVVEY4KGJ1ZikgOiBpc1V0ZjgoYnVmKTsKICAgIH07CiAgfSAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAgKi9lbHNlIGlmICghcHJvY2Vzcy5lbnYuV1NfTk9fVVRGXzhfVkFMSURBVEUpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGlzVmFsaWRVVEY4ID0gcmVxdWlyZSgndXRmLTgtdmFsaWRhdGUnKTsKICAgICAgdmFsaWRhdGlvbi5leHBvcnRzLmlzVmFsaWRVVEY4ID0gZnVuY3Rpb24gKGJ1ZikgewogICAgICAgIHJldHVybiBidWYubGVuZ3RoIDwgMzIgPyBfaXNWYWxpZFVURjgoYnVmKSA6IGlzVmFsaWRVVEY4KGJ1Zik7CiAgICAgIH07CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vIENvbnRpbnVlIHJlZ2FyZGxlc3Mgb2YgdGhlIGVycm9yLgogICAgfQogIH0KICByZXR1cm4gdmFsaWRhdGlvbi5leHBvcnRzOwp9Cgp2YXIgcmVjZWl2ZXI7CnZhciBoYXNSZXF1aXJlZFJlY2VpdmVyOwpmdW5jdGlvbiByZXF1aXJlUmVjZWl2ZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkUmVjZWl2ZXIpIHJldHVybiByZWNlaXZlcjsKICBoYXNSZXF1aXJlZFJlY2VpdmVyID0gMTsKICBjb25zdCB7CiAgICBXcml0YWJsZQogIH0gPSByZXF1aXJlJCQwJDQ7CiAgY29uc3QgUGVyTWVzc2FnZURlZmxhdGUgPSByZXF1aXJlUGVybWVzc2FnZURlZmxhdGUoKTsKICBjb25zdCB7CiAgICBCSU5BUllfVFlQRVMsCiAgICBFTVBUWV9CVUZGRVIsCiAgICBrU3RhdHVzQ29kZSwKICAgIGtXZWJTb2NrZXQKICB9ID0gcmVxdWlyZUNvbnN0YW50cyQzKCk7CiAgY29uc3QgewogICAgY29uY2F0LAogICAgdG9BcnJheUJ1ZmZlciwKICAgIHVubWFzawogIH0gPSByZXF1aXJlQnVmZmVyVXRpbCgpOwogIGNvbnN0IHsKICAgIGlzVmFsaWRTdGF0dXNDb2RlLAogICAgaXNWYWxpZFVURjgKICB9ID0gcmVxdWlyZVZhbGlkYXRpb24oKTsKICBjb25zdCBGYXN0QnVmZmVyID0gQnVmZmVyW1N5bWJvbC5zcGVjaWVzXTsKICBjb25zdCBHRVRfSU5GTyA9IDA7CiAgY29uc3QgR0VUX1BBWUxPQURfTEVOR1RIXzE2ID0gMTsKICBjb25zdCBHRVRfUEFZTE9BRF9MRU5HVEhfNjQgPSAyOwogIGNvbnN0IEdFVF9NQVNLID0gMzsKICBjb25zdCBHRVRfREFUQSA9IDQ7CiAgY29uc3QgSU5GTEFUSU5HID0gNTsKICBjb25zdCBERUZFUl9FVkVOVCA9IDY7CgogIC8qKgogICAqIEh5QmkgUmVjZWl2ZXIgaW1wbGVtZW50YXRpb24uCiAgICoKICAgKiBAZXh0ZW5kcyBXcml0YWJsZQogICAqLwogIGNsYXNzIFJlY2VpdmVyIGV4dGVuZHMgV3JpdGFibGUgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgUmVjZWl2ZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBPcHRpb25zIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5hbGxvd1N5bmNocm9ub3VzRXZlbnRzPXRydWVdIFNwZWNpZmllcyB3aGV0aGVyCiAgICAgKiAgICAgYW55IG9mIHRoZSBgJ21lc3NhZ2UnYCwgYCdwaW5nJ2AsIGFuZCBgJ3BvbmcnYCBldmVudHMgY2FuIGJlIGVtaXR0ZWQKICAgICAqICAgICBtdWx0aXBsZSB0aW1lcyBpbiB0aGUgc2FtZSB0aWNrCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmluYXJ5VHlwZT1ub2RlYnVmZmVyXSBUaGUgdHlwZSBmb3IgYmluYXJ5IGRhdGEKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy5leHRlbnNpb25zXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgbmVnb3RpYXRlZAogICAgICogICAgIGV4dGVuc2lvbnMKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuaXNTZXJ2ZXI9ZmFsc2VdIFNwZWNpZmllcyB3aGV0aGVyIHRvIG9wZXJhdGUgaW4KICAgICAqICAgICBjbGllbnQgb3Igc2VydmVyIG1vZGUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5tYXhQYXlsb2FkPTBdIFRoZSBtYXhpbXVtIGFsbG93ZWQgbWVzc2FnZSBsZW5ndGgKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvcgogICAgICogICAgIG5vdCB0byBza2lwIFVURi04IHZhbGlkYXRpb24gZm9yIHRleHQgYW5kIGNsb3NlIG1lc3NhZ2VzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLl9hbGxvd1N5bmNocm9ub3VzRXZlbnRzID0gb3B0aW9ucy5hbGxvd1N5bmNocm9ub3VzRXZlbnRzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmFsbG93U3luY2hyb25vdXNFdmVudHMgOiB0cnVlOwogICAgICB0aGlzLl9iaW5hcnlUeXBlID0gb3B0aW9ucy5iaW5hcnlUeXBlIHx8IEJJTkFSWV9UWVBFU1swXTsKICAgICAgdGhpcy5fZXh0ZW5zaW9ucyA9IG9wdGlvbnMuZXh0ZW5zaW9ucyB8fCB7fTsKICAgICAgdGhpcy5faXNTZXJ2ZXIgPSAhIW9wdGlvbnMuaXNTZXJ2ZXI7CiAgICAgIHRoaXMuX21heFBheWxvYWQgPSBvcHRpb25zLm1heFBheWxvYWQgfCAwOwogICAgICB0aGlzLl9za2lwVVRGOFZhbGlkYXRpb24gPSAhIW9wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uOwogICAgICB0aGlzW2tXZWJTb2NrZXRdID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9idWZmZXJlZEJ5dGVzID0gMDsKICAgICAgdGhpcy5fYnVmZmVycyA9IFtdOwogICAgICB0aGlzLl9jb21wcmVzc2VkID0gZmFsc2U7CiAgICAgIHRoaXMuX3BheWxvYWRMZW5ndGggPSAwOwogICAgICB0aGlzLl9tYXNrID0gdW5kZWZpbmVkOwogICAgICB0aGlzLl9mcmFnbWVudGVkID0gMDsKICAgICAgdGhpcy5fbWFza2VkID0gZmFsc2U7CiAgICAgIHRoaXMuX2ZpbiA9IGZhbHNlOwogICAgICB0aGlzLl9vcGNvZGUgPSAwOwogICAgICB0aGlzLl90b3RhbFBheWxvYWRMZW5ndGggPSAwOwogICAgICB0aGlzLl9tZXNzYWdlTGVuZ3RoID0gMDsKICAgICAgdGhpcy5fZnJhZ21lbnRzID0gW107CiAgICAgIHRoaXMuX2Vycm9yZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fbG9vcCA9IGZhbHNlOwogICAgICB0aGlzLl9zdGF0ZSA9IEdFVF9JTkZPOwogICAgfQoKICAgIC8qKgogICAgICogSW1wbGVtZW50cyBgV3JpdGFibGUucHJvdG90eXBlLl93cml0ZSgpYC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0J1ZmZlcn0gY2h1bmsgVGhlIGNodW5rIG9mIGRhdGEgdG8gd3JpdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBlbmNvZGluZyBUaGUgY2hhcmFjdGVyIGVuY29kaW5nIG9mIGBjaHVua2AKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNiIENhbGxiYWNrCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBfd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYikgewogICAgICBpZiAodGhpcy5fb3Bjb2RlID09PSAweDA4ICYmIHRoaXMuX3N0YXRlID09IEdFVF9JTkZPKSByZXR1cm4gY2IoKTsKICAgICAgdGhpcy5fYnVmZmVyZWRCeXRlcyArPSBjaHVuay5sZW5ndGg7CiAgICAgIHRoaXMuX2J1ZmZlcnMucHVzaChjaHVuayk7CiAgICAgIHRoaXMuc3RhcnRMb29wKGNiKTsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnN1bWVzIGBuYCBieXRlcyBmcm9tIHRoZSBidWZmZXJlZCBkYXRhLgogICAgICoKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgYnl0ZXMgdG8gY29uc3VtZQogICAgICogQHJldHVybiB7QnVmZmVyfSBUaGUgY29uc3VtZWQgYnl0ZXMKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGNvbnN1bWUobikgewogICAgICB0aGlzLl9idWZmZXJlZEJ5dGVzIC09IG47CiAgICAgIGlmIChuID09PSB0aGlzLl9idWZmZXJzWzBdLmxlbmd0aCkgcmV0dXJuIHRoaXMuX2J1ZmZlcnMuc2hpZnQoKTsKICAgICAgaWYgKG4gPCB0aGlzLl9idWZmZXJzWzBdLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGJ1ZiA9IHRoaXMuX2J1ZmZlcnNbMF07CiAgICAgICAgdGhpcy5fYnVmZmVyc1swXSA9IG5ldyBGYXN0QnVmZmVyKGJ1Zi5idWZmZXIsIGJ1Zi5ieXRlT2Zmc2V0ICsgbiwgYnVmLmxlbmd0aCAtIG4pOwogICAgICAgIHJldHVybiBuZXcgRmFzdEJ1ZmZlcihidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgbik7CiAgICAgIH0KICAgICAgY29uc3QgZHN0ID0gQnVmZmVyLmFsbG9jVW5zYWZlKG4pOwogICAgICBkbyB7CiAgICAgICAgY29uc3QgYnVmID0gdGhpcy5fYnVmZmVyc1swXTsKICAgICAgICBjb25zdCBvZmZzZXQgPSBkc3QubGVuZ3RoIC0gbjsKICAgICAgICBpZiAobiA+PSBidWYubGVuZ3RoKSB7CiAgICAgICAgICBkc3Quc2V0KHRoaXMuX2J1ZmZlcnMuc2hpZnQoKSwgb2Zmc2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZHN0LnNldChuZXcgVWludDhBcnJheShidWYuYnVmZmVyLCBidWYuYnl0ZU9mZnNldCwgbiksIG9mZnNldCk7CiAgICAgICAgICB0aGlzLl9idWZmZXJzWzBdID0gbmV3IEZhc3RCdWZmZXIoYnVmLmJ1ZmZlciwgYnVmLmJ5dGVPZmZzZXQgKyBuLCBidWYubGVuZ3RoIC0gbik7CiAgICAgICAgfQogICAgICAgIG4gLT0gYnVmLmxlbmd0aDsKICAgICAgfSB3aGlsZSAobiA+IDApOwogICAgICByZXR1cm4gZHN0OwogICAgfQoKICAgIC8qKgogICAgICogU3RhcnRzIHRoZSBwYXJzaW5nIGxvb3AuCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2IgQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHN0YXJ0TG9vcChjYikgewogICAgICB0aGlzLl9sb29wID0gdHJ1ZTsKICAgICAgZG8gewogICAgICAgIHN3aXRjaCAodGhpcy5fc3RhdGUpIHsKICAgICAgICAgIGNhc2UgR0VUX0lORk86CiAgICAgICAgICAgIHRoaXMuZ2V0SW5mbyhjYik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBHRVRfUEFZTE9BRF9MRU5HVEhfMTY6CiAgICAgICAgICAgIHRoaXMuZ2V0UGF5bG9hZExlbmd0aDE2KGNiKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIEdFVF9QQVlMT0FEX0xFTkdUSF82NDoKICAgICAgICAgICAgdGhpcy5nZXRQYXlsb2FkTGVuZ3RoNjQoY2IpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgR0VUX01BU0s6CiAgICAgICAgICAgIHRoaXMuZ2V0TWFzaygpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgR0VUX0RBVEE6CiAgICAgICAgICAgIHRoaXMuZ2V0RGF0YShjYik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBJTkZMQVRJTkc6CiAgICAgICAgICBjYXNlIERFRkVSX0VWRU5UOgogICAgICAgICAgICB0aGlzLl9sb29wID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gd2hpbGUgKHRoaXMuX2xvb3ApOwogICAgICBpZiAoIXRoaXMuX2Vycm9yZWQpIGNiKCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWFkcyB0aGUgZmlyc3QgdHdvIGJ5dGVzIG9mIGEgZnJhbWUuCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2IgQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGdldEluZm8oY2IpIHsKICAgICAgaWYgKHRoaXMuX2J1ZmZlcmVkQnl0ZXMgPCAyKSB7CiAgICAgICAgdGhpcy5fbG9vcCA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBidWYgPSB0aGlzLmNvbnN1bWUoMik7CiAgICAgIGlmICgoYnVmWzBdICYgMHgzMCkgIT09IDB4MDApIHsKICAgICAgICBjb25zdCBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoUmFuZ2VFcnJvciwgJ1JTVjIgYW5kIFJTVjMgbXVzdCBiZSBjbGVhcicsIHRydWUsIDEwMDIsICdXU19FUlJfVU5FWFBFQ1RFRF9SU1ZfMl8zJyk7CiAgICAgICAgY2IoZXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBjb21wcmVzc2VkID0gKGJ1ZlswXSAmIDB4NDApID09PSAweDQwOwogICAgICBpZiAoY29tcHJlc3NlZCAmJiAhdGhpcy5fZXh0ZW5zaW9uc1tQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXSkgewogICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCAnUlNWMSBtdXN0IGJlIGNsZWFyJywgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9VTkVYUEVDVEVEX1JTVl8xJyk7CiAgICAgICAgY2IoZXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9maW4gPSAoYnVmWzBdICYgMHg4MCkgPT09IDB4ODA7CiAgICAgIHRoaXMuX29wY29kZSA9IGJ1ZlswXSAmIDB4MGY7CiAgICAgIHRoaXMuX3BheWxvYWRMZW5ndGggPSBidWZbMV0gJiAweDdmOwogICAgICBpZiAodGhpcy5fb3Bjb2RlID09PSAweDAwKSB7CiAgICAgICAgaWYgKGNvbXByZXNzZWQpIHsKICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCAnUlNWMSBtdXN0IGJlIGNsZWFyJywgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9VTkVYUEVDVEVEX1JTVl8xJyk7CiAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5fZnJhZ21lbnRlZCkgewogICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKFJhbmdlRXJyb3IsICdpbnZhbGlkIG9wY29kZSAwJywgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9JTlZBTElEX09QQ09ERScpOwogICAgICAgICAgY2IoZXJyb3IpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLl9vcGNvZGUgPSB0aGlzLl9mcmFnbWVudGVkOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX29wY29kZSA9PT0gMHgwMSB8fCB0aGlzLl9vcGNvZGUgPT09IDB4MDIpIHsKICAgICAgICBpZiAodGhpcy5fZnJhZ21lbnRlZCkgewogICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKFJhbmdlRXJyb3IsIGBpbnZhbGlkIG9wY29kZSAke3RoaXMuX29wY29kZX1gLCB0cnVlLCAxMDAyLCAnV1NfRVJSX0lOVkFMSURfT1BDT0RFJyk7CiAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuX2NvbXByZXNzZWQgPSBjb21wcmVzc2VkOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX29wY29kZSA+IDB4MDcgJiYgdGhpcy5fb3Bjb2RlIDwgMHgwYikgewogICAgICAgIGlmICghdGhpcy5fZmluKSB7CiAgICAgICAgICBjb25zdCBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoUmFuZ2VFcnJvciwgJ0ZJTiBtdXN0IGJlIHNldCcsIHRydWUsIDEwMDIsICdXU19FUlJfRVhQRUNURURfRklOJyk7CiAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChjb21wcmVzc2VkKSB7CiAgICAgICAgICBjb25zdCBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoUmFuZ2VFcnJvciwgJ1JTVjEgbXVzdCBiZSBjbGVhcicsIHRydWUsIDEwMDIsICdXU19FUlJfVU5FWFBFQ1RFRF9SU1ZfMScpOwogICAgICAgICAgY2IoZXJyb3IpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fcGF5bG9hZExlbmd0aCA+IDB4N2QgfHwgdGhpcy5fb3Bjb2RlID09PSAweDA4ICYmIHRoaXMuX3BheWxvYWRMZW5ndGggPT09IDEpIHsKICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCBgaW52YWxpZCBwYXlsb2FkIGxlbmd0aCAke3RoaXMuX3BheWxvYWRMZW5ndGh9YCwgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9JTlZBTElEX0NPTlRST0xfUEFZTE9BRF9MRU5HVEgnKTsKICAgICAgICAgIGNiKGVycm9yKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKFJhbmdlRXJyb3IsIGBpbnZhbGlkIG9wY29kZSAke3RoaXMuX29wY29kZX1gLCB0cnVlLCAxMDAyLCAnV1NfRVJSX0lOVkFMSURfT1BDT0RFJyk7CiAgICAgICAgY2IoZXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoIXRoaXMuX2ZpbiAmJiAhdGhpcy5fZnJhZ21lbnRlZCkgdGhpcy5fZnJhZ21lbnRlZCA9IHRoaXMuX29wY29kZTsKICAgICAgdGhpcy5fbWFza2VkID0gKGJ1ZlsxXSAmIDB4ODApID09PSAweDgwOwogICAgICBpZiAodGhpcy5faXNTZXJ2ZXIpIHsKICAgICAgICBpZiAoIXRoaXMuX21hc2tlZCkgewogICAgICAgICAgY29uc3QgZXJyb3IgPSB0aGlzLmNyZWF0ZUVycm9yKFJhbmdlRXJyb3IsICdNQVNLIG11c3QgYmUgc2V0JywgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9FWFBFQ1RFRF9NQVNLJyk7CiAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMuX21hc2tlZCkgewogICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCAnTUFTSyBtdXN0IGJlIGNsZWFyJywgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9VTkVYUEVDVEVEX01BU0snKTsKICAgICAgICBjYihlcnJvcik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9wYXlsb2FkTGVuZ3RoID09PSAxMjYpIHRoaXMuX3N0YXRlID0gR0VUX1BBWUxPQURfTEVOR1RIXzE2O2Vsc2UgaWYgKHRoaXMuX3BheWxvYWRMZW5ndGggPT09IDEyNykgdGhpcy5fc3RhdGUgPSBHRVRfUEFZTE9BRF9MRU5HVEhfNjQ7ZWxzZSB0aGlzLmhhdmVMZW5ndGgoY2IpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBleHRlbmRlZCBwYXlsb2FkIGxlbmd0aCAoNysxNikuCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2IgQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGdldFBheWxvYWRMZW5ndGgxNihjYikgewogICAgICBpZiAodGhpcy5fYnVmZmVyZWRCeXRlcyA8IDIpIHsKICAgICAgICB0aGlzLl9sb29wID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX3BheWxvYWRMZW5ndGggPSB0aGlzLmNvbnN1bWUoMikucmVhZFVJbnQxNkJFKDApOwogICAgICB0aGlzLmhhdmVMZW5ndGgoY2IpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBleHRlbmRlZCBwYXlsb2FkIGxlbmd0aCAoNys2NCkuCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2IgQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGdldFBheWxvYWRMZW5ndGg2NChjYikgewogICAgICBpZiAodGhpcy5fYnVmZmVyZWRCeXRlcyA8IDgpIHsKICAgICAgICB0aGlzLl9sb29wID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IGJ1ZiA9IHRoaXMuY29uc3VtZSg4KTsKICAgICAgY29uc3QgbnVtID0gYnVmLnJlYWRVSW50MzJCRSgwKTsKCiAgICAgIC8vCiAgICAgIC8vIFRoZSBtYXhpbXVtIHNhZmUgaW50ZWdlciBpbiBKYXZhU2NyaXB0IGlzIDJeNTMgLSAxLiBBbiBlcnJvciBpcyByZXR1cm5lZAogICAgICAvLyBpZiBwYXlsb2FkIGxlbmd0aCBpcyBncmVhdGVyIHRoYW4gdGhpcyBudW1iZXIuCiAgICAgIC8vCiAgICAgIGlmIChudW0gPiBNYXRoLnBvdygyLCA1MyAtIDMyKSAtIDEpIHsKICAgICAgICBjb25zdCBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoUmFuZ2VFcnJvciwgJ1Vuc3VwcG9ydGVkIFdlYlNvY2tldCBmcmFtZTogcGF5bG9hZCBsZW5ndGggPiAyXjUzIC0gMScsIGZhbHNlLCAxMDA5LCAnV1NfRVJSX1VOU1VQUE9SVEVEX0RBVEFfUEFZTE9BRF9MRU5HVEgnKTsKICAgICAgICBjYihlcnJvcik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX3BheWxvYWRMZW5ndGggPSBudW0gKiBNYXRoLnBvdygyLCAzMikgKyBidWYucmVhZFVJbnQzMkJFKDQpOwogICAgICB0aGlzLmhhdmVMZW5ndGgoY2IpOwogICAgfQoKICAgIC8qKgogICAgICogUGF5bG9hZCBsZW5ndGggaGFzIGJlZW4gcmVhZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYiBDYWxsYmFjawogICAgICogQHByaXZhdGUKICAgICAqLwogICAgaGF2ZUxlbmd0aChjYikgewogICAgICBpZiAodGhpcy5fcGF5bG9hZExlbmd0aCAmJiB0aGlzLl9vcGNvZGUgPCAweDA4KSB7CiAgICAgICAgdGhpcy5fdG90YWxQYXlsb2FkTGVuZ3RoICs9IHRoaXMuX3BheWxvYWRMZW5ndGg7CiAgICAgICAgaWYgKHRoaXMuX3RvdGFsUGF5bG9hZExlbmd0aCA+IHRoaXMuX21heFBheWxvYWQgJiYgdGhpcy5fbWF4UGF5bG9hZCA+IDApIHsKICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCAnTWF4IHBheWxvYWQgc2l6ZSBleGNlZWRlZCcsIGZhbHNlLCAxMDA5LCAnV1NfRVJSX1VOU1VQUE9SVEVEX01FU1NBR0VfTEVOR1RIJyk7CiAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLl9tYXNrZWQpIHRoaXMuX3N0YXRlID0gR0VUX01BU0s7ZWxzZSB0aGlzLl9zdGF0ZSA9IEdFVF9EQVRBOwogICAgfQoKICAgIC8qKgogICAgICogUmVhZHMgbWFzayBieXRlcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBnZXRNYXNrKCkgewogICAgICBpZiAodGhpcy5fYnVmZmVyZWRCeXRlcyA8IDQpIHsKICAgICAgICB0aGlzLl9sb29wID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX21hc2sgPSB0aGlzLmNvbnN1bWUoNCk7CiAgICAgIHRoaXMuX3N0YXRlID0gR0VUX0RBVEE7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZWFkcyBkYXRhIGJ5dGVzLgogICAgICoKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNiIENhbGxiYWNrCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBnZXREYXRhKGNiKSB7CiAgICAgIGxldCBkYXRhID0gRU1QVFlfQlVGRkVSOwogICAgICBpZiAodGhpcy5fcGF5bG9hZExlbmd0aCkgewogICAgICAgIGlmICh0aGlzLl9idWZmZXJlZEJ5dGVzIDwgdGhpcy5fcGF5bG9hZExlbmd0aCkgewogICAgICAgICAgdGhpcy5fbG9vcCA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBkYXRhID0gdGhpcy5jb25zdW1lKHRoaXMuX3BheWxvYWRMZW5ndGgpOwogICAgICAgIGlmICh0aGlzLl9tYXNrZWQgJiYgKHRoaXMuX21hc2tbMF0gfCB0aGlzLl9tYXNrWzFdIHwgdGhpcy5fbWFza1syXSB8IHRoaXMuX21hc2tbM10pICE9PSAwKSB7CiAgICAgICAgICB1bm1hc2soZGF0YSwgdGhpcy5fbWFzayk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLl9vcGNvZGUgPiAweDA3KSB7CiAgICAgICAgdGhpcy5jb250cm9sTWVzc2FnZShkYXRhLCBjYik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9jb21wcmVzc2VkKSB7CiAgICAgICAgdGhpcy5fc3RhdGUgPSBJTkZMQVRJTkc7CiAgICAgICAgdGhpcy5kZWNvbXByZXNzKGRhdGEsIGNiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGRhdGEubGVuZ3RoKSB7CiAgICAgICAgLy8KICAgICAgICAvLyBUaGlzIG1lc3NhZ2UgaXMgbm90IGNvbXByZXNzZWQgc28gaXRzIGxlbmd0aCBpcyB0aGUgc3VtIG9mIHRoZSBwYXlsb2FkCiAgICAgICAgLy8gbGVuZ3RoIG9mIGFsbCBmcmFnbWVudHMuCiAgICAgICAgLy8KICAgICAgICB0aGlzLl9tZXNzYWdlTGVuZ3RoID0gdGhpcy5fdG90YWxQYXlsb2FkTGVuZ3RoOwogICAgICAgIHRoaXMuX2ZyYWdtZW50cy5wdXNoKGRhdGEpOwogICAgICB9CiAgICAgIHRoaXMuZGF0YU1lc3NhZ2UoY2IpOwogICAgfQoKICAgIC8qKgogICAgICogRGVjb21wcmVzc2VzIGRhdGEuCiAgICAgKgogICAgICogQHBhcmFtIHtCdWZmZXJ9IGRhdGEgQ29tcHJlc3NlZCBkYXRhCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYiBDYWxsYmFjawogICAgICogQHByaXZhdGUKICAgICAqLwogICAgZGVjb21wcmVzcyhkYXRhLCBjYikgewogICAgICBjb25zdCBwZXJNZXNzYWdlRGVmbGF0ZSA9IHRoaXMuX2V4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV07CiAgICAgIHBlck1lc3NhZ2VEZWZsYXRlLmRlY29tcHJlc3MoZGF0YSwgdGhpcy5fZmluLCAoZXJyLCBidWYpID0+IHsKICAgICAgICBpZiAoZXJyKSByZXR1cm4gY2IoZXJyKTsKICAgICAgICBpZiAoYnVmLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5fbWVzc2FnZUxlbmd0aCArPSBidWYubGVuZ3RoOwogICAgICAgICAgaWYgKHRoaXMuX21lc3NhZ2VMZW5ndGggPiB0aGlzLl9tYXhQYXlsb2FkICYmIHRoaXMuX21heFBheWxvYWQgPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCAnTWF4IHBheWxvYWQgc2l6ZSBleGNlZWRlZCcsIGZhbHNlLCAxMDA5LCAnV1NfRVJSX1VOU1VQUE9SVEVEX01FU1NBR0VfTEVOR1RIJyk7CiAgICAgICAgICAgIGNiKGVycm9yKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fZnJhZ21lbnRzLnB1c2goYnVmKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kYXRhTWVzc2FnZShjYik7CiAgICAgICAgaWYgKHRoaXMuX3N0YXRlID09PSBHRVRfSU5GTykgdGhpcy5zdGFydExvb3AoY2IpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEhhbmRsZXMgYSBkYXRhIG1lc3NhZ2UuCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2IgQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGRhdGFNZXNzYWdlKGNiKSB7CiAgICAgIGlmICghdGhpcy5fZmluKSB7CiAgICAgICAgdGhpcy5fc3RhdGUgPSBHRVRfSU5GTzsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgbWVzc2FnZUxlbmd0aCA9IHRoaXMuX21lc3NhZ2VMZW5ndGg7CiAgICAgIGNvbnN0IGZyYWdtZW50cyA9IHRoaXMuX2ZyYWdtZW50czsKICAgICAgdGhpcy5fdG90YWxQYXlsb2FkTGVuZ3RoID0gMDsKICAgICAgdGhpcy5fbWVzc2FnZUxlbmd0aCA9IDA7CiAgICAgIHRoaXMuX2ZyYWdtZW50ZWQgPSAwOwogICAgICB0aGlzLl9mcmFnbWVudHMgPSBbXTsKICAgICAgaWYgKHRoaXMuX29wY29kZSA9PT0gMikgewogICAgICAgIGxldCBkYXRhOwogICAgICAgIGlmICh0aGlzLl9iaW5hcnlUeXBlID09PSAnbm9kZWJ1ZmZlcicpIHsKICAgICAgICAgIGRhdGEgPSBjb25jYXQoZnJhZ21lbnRzLCBtZXNzYWdlTGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JpbmFyeVR5cGUgPT09ICdhcnJheWJ1ZmZlcicpIHsKICAgICAgICAgIGRhdGEgPSB0b0FycmF5QnVmZmVyKGNvbmNhdChmcmFnbWVudHMsIG1lc3NhZ2VMZW5ndGgpKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2JpbmFyeVR5cGUgPT09ICdibG9iJykgewogICAgICAgICAgZGF0YSA9IG5ldyBCbG9iKGZyYWdtZW50cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGEgPSBmcmFnbWVudHM7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9hbGxvd1N5bmNocm9ub3VzRXZlbnRzKSB7CiAgICAgICAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCBkYXRhLCB0cnVlKTsKICAgICAgICAgIHRoaXMuX3N0YXRlID0gR0VUX0lORk87CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3N0YXRlID0gREVGRVJfRVZFTlQ7CiAgICAgICAgICBzZXRJbW1lZGlhdGUoKCkgPT4gewogICAgICAgICAgICB0aGlzLmVtaXQoJ21lc3NhZ2UnLCBkYXRhLCB0cnVlKTsKICAgICAgICAgICAgdGhpcy5fc3RhdGUgPSBHRVRfSU5GTzsKICAgICAgICAgICAgdGhpcy5zdGFydExvb3AoY2IpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGJ1ZiA9IGNvbmNhdChmcmFnbWVudHMsIG1lc3NhZ2VMZW5ndGgpOwogICAgICAgIGlmICghdGhpcy5fc2tpcFVURjhWYWxpZGF0aW9uICYmICFpc1ZhbGlkVVRGOChidWYpKSB7CiAgICAgICAgICBjb25zdCBlcnJvciA9IHRoaXMuY3JlYXRlRXJyb3IoRXJyb3IsICdpbnZhbGlkIFVURi04IHNlcXVlbmNlJywgdHJ1ZSwgMTAwNywgJ1dTX0VSUl9JTlZBTElEX1VURjgnKTsKICAgICAgICAgIGNiKGVycm9yKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3N0YXRlID09PSBJTkZMQVRJTkcgfHwgdGhpcy5fYWxsb3dTeW5jaHJvbm91c0V2ZW50cykgewogICAgICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlJywgYnVmLCBmYWxzZSk7CiAgICAgICAgICB0aGlzLl9zdGF0ZSA9IEdFVF9JTkZPOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9zdGF0ZSA9IERFRkVSX0VWRU5UOwogICAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHsKICAgICAgICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlJywgYnVmLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuX3N0YXRlID0gR0VUX0lORk87CiAgICAgICAgICAgIHRoaXMuc3RhcnRMb29wKGNiKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSGFuZGxlcyBhIGNvbnRyb2wgbWVzc2FnZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0J1ZmZlcn0gZGF0YSBEYXRhIHRvIGhhbmRsZQogICAgICogQHJldHVybiB7KEVycm9yfFJhbmdlRXJyb3J8dW5kZWZpbmVkKX0gQSBwb3NzaWJsZSBlcnJvcgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgY29udHJvbE1lc3NhZ2UoZGF0YSwgY2IpIHsKICAgICAgaWYgKHRoaXMuX29wY29kZSA9PT0gMHgwOCkgewogICAgICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5fbG9vcCA9IGZhbHNlOwogICAgICAgICAgdGhpcy5lbWl0KCdjb25jbHVkZScsIDEwMDUsIEVNUFRZX0JVRkZFUik7CiAgICAgICAgICB0aGlzLmVuZCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjb2RlID0gZGF0YS5yZWFkVUludDE2QkUoMCk7CiAgICAgICAgICBpZiAoIWlzVmFsaWRTdGF0dXNDb2RlKGNvZGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihSYW5nZUVycm9yLCBgaW52YWxpZCBzdGF0dXMgY29kZSAke2NvZGV9YCwgdHJ1ZSwgMTAwMiwgJ1dTX0VSUl9JTlZBTElEX0NMT1NFX0NPREUnKTsKICAgICAgICAgICAgY2IoZXJyb3IpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBidWYgPSBuZXcgRmFzdEJ1ZmZlcihkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgMiwgZGF0YS5sZW5ndGggLSAyKTsKICAgICAgICAgIGlmICghdGhpcy5fc2tpcFVURjhWYWxpZGF0aW9uICYmICFpc1ZhbGlkVVRGOChidWYpKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gdGhpcy5jcmVhdGVFcnJvcihFcnJvciwgJ2ludmFsaWQgVVRGLTggc2VxdWVuY2UnLCB0cnVlLCAxMDA3LCAnV1NfRVJSX0lOVkFMSURfVVRGOCcpOwogICAgICAgICAgICBjYihlcnJvcik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2xvb3AgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuZW1pdCgnY29uY2x1ZGUnLCBjb2RlLCBidWYpOwogICAgICAgICAgdGhpcy5lbmQoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc3RhdGUgPSBHRVRfSU5GTzsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX2FsbG93U3luY2hyb25vdXNFdmVudHMpIHsKICAgICAgICB0aGlzLmVtaXQodGhpcy5fb3Bjb2RlID09PSAweDA5ID8gJ3BpbmcnIDogJ3BvbmcnLCBkYXRhKTsKICAgICAgICB0aGlzLl9zdGF0ZSA9IEdFVF9JTkZPOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3N0YXRlID0gREVGRVJfRVZFTlQ7CiAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHsKICAgICAgICAgIHRoaXMuZW1pdCh0aGlzLl9vcGNvZGUgPT09IDB4MDkgPyAncGluZycgOiAncG9uZycsIGRhdGEpOwogICAgICAgICAgdGhpcy5fc3RhdGUgPSBHRVRfSU5GTzsKICAgICAgICAgIHRoaXMuc3RhcnRMb29wKGNiKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQnVpbGRzIGFuIGVycm9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKG5ldzpFcnJvcnxSYW5nZUVycm9yKX0gRXJyb3JDdG9yIFRoZSBlcnJvciBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIGVycm9yIG1lc3NhZ2UKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gcHJlZml4IFNwZWNpZmllcyB3aGV0aGVyIG9yIG5vdCB0byBhZGQgYSBkZWZhdWx0IHByZWZpeCB0bwogICAgICogICAgIGBtZXNzYWdlYAogICAgICogQHBhcmFtIHtOdW1iZXJ9IHN0YXR1c0NvZGUgVGhlIHN0YXR1cyBjb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXJyb3JDb2RlIFRoZSBleHBvc2VkIGVycm9yIGNvZGUKICAgICAqIEByZXR1cm4geyhFcnJvcnxSYW5nZUVycm9yKX0gVGhlIGVycm9yCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVFcnJvcihFcnJvckN0b3IsIG1lc3NhZ2UsIHByZWZpeCwgc3RhdHVzQ29kZSwgZXJyb3JDb2RlKSB7CiAgICAgIHRoaXMuX2xvb3AgPSBmYWxzZTsKICAgICAgdGhpcy5fZXJyb3JlZCA9IHRydWU7CiAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvckN0b3IocHJlZml4ID8gYEludmFsaWQgV2ViU29ja2V0IGZyYW1lOiAke21lc3NhZ2V9YCA6IG1lc3NhZ2UpOwogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZShlcnIsIHRoaXMuY3JlYXRlRXJyb3IpOwogICAgICBlcnIuY29kZSA9IGVycm9yQ29kZTsKICAgICAgZXJyW2tTdGF0dXNDb2RlXSA9IHN0YXR1c0NvZGU7CiAgICAgIHJldHVybiBlcnI7CiAgICB9CiAgfQogIHJlY2VpdmVyID0gUmVjZWl2ZXI7CiAgcmV0dXJuIHJlY2VpdmVyOwp9CgovKiBlc2xpbnQgbm8tdW51c2VkLXZhcnM6IFsiZXJyb3IiLCB7ICJ2YXJzSWdub3JlUGF0dGVybiI6ICJeRHVwbGV4IiB9XSAqLwp2YXIgc2VuZGVyOwp2YXIgaGFzUmVxdWlyZWRTZW5kZXI7CmZ1bmN0aW9uIHJlcXVpcmVTZW5kZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkU2VuZGVyKSByZXR1cm4gc2VuZGVyOwogIGhhc1JlcXVpcmVkU2VuZGVyID0gMTsKICBjb25zdCB7CiAgICByYW5kb21GaWxsU3luYwogIH0gPSByZXF1aXJlJCQxJDI7CiAgY29uc3QgUGVyTWVzc2FnZURlZmxhdGUgPSByZXF1aXJlUGVybWVzc2FnZURlZmxhdGUoKTsKICBjb25zdCB7CiAgICBFTVBUWV9CVUZGRVIsCiAgICBrV2ViU29ja2V0LAogICAgTk9PUAogIH0gPSByZXF1aXJlQ29uc3RhbnRzJDMoKTsKICBjb25zdCB7CiAgICBpc0Jsb2IsCiAgICBpc1ZhbGlkU3RhdHVzQ29kZQogIH0gPSByZXF1aXJlVmFsaWRhdGlvbigpOwogIGNvbnN0IHsKICAgIG1hc2s6IGFwcGx5TWFzaywKICAgIHRvQnVmZmVyCiAgfSA9IHJlcXVpcmVCdWZmZXJVdGlsKCk7CiAgY29uc3Qga0J5dGVMZW5ndGggPSBTeW1ib2woJ2tCeXRlTGVuZ3RoJyk7CiAgY29uc3QgbWFza0J1ZmZlciA9IEJ1ZmZlci5hbGxvYyg0KTsKICBjb25zdCBSQU5ET01fUE9PTF9TSVpFID0gOCAqIDEwMjQ7CiAgbGV0IHJhbmRvbVBvb2w7CiAgbGV0IHJhbmRvbVBvb2xQb2ludGVyID0gUkFORE9NX1BPT0xfU0laRTsKICBjb25zdCBERUZBVUxUID0gMDsKICBjb25zdCBERUZMQVRJTkcgPSAxOwogIGNvbnN0IEdFVF9CTE9CX0RBVEEgPSAyOwoKICAvKioKICAgKiBIeUJpIFNlbmRlciBpbXBsZW1lbnRhdGlvbi4KICAgKi8KICBjbGFzcyBTZW5kZXIgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgU2VuZGVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEBwYXJhbSB7RHVwbGV4fSBzb2NrZXQgVGhlIGNvbm5lY3Rpb24gc29ja2V0CiAgICAgKiBAcGFyYW0ge09iamVjdH0gW2V4dGVuc2lvbnNdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBuZWdvdGlhdGVkIGV4dGVuc2lvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtnZW5lcmF0ZU1hc2tdIFRoZSBmdW5jdGlvbiB1c2VkIHRvIGdlbmVyYXRlIHRoZSBtYXNraW5nCiAgICAgKiAgICAga2V5CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHNvY2tldCwgZXh0ZW5zaW9ucywgZ2VuZXJhdGVNYXNrKSB7CiAgICAgIHRoaXMuX2V4dGVuc2lvbnMgPSBleHRlbnNpb25zIHx8IHt9OwogICAgICBpZiAoZ2VuZXJhdGVNYXNrKSB7CiAgICAgICAgdGhpcy5fZ2VuZXJhdGVNYXNrID0gZ2VuZXJhdGVNYXNrOwogICAgICAgIHRoaXMuX21hc2tCdWZmZXIgPSBCdWZmZXIuYWxsb2MoNCk7CiAgICAgIH0KICAgICAgdGhpcy5fc29ja2V0ID0gc29ja2V0OwogICAgICB0aGlzLl9maXJzdEZyYWdtZW50ID0gdHJ1ZTsKICAgICAgdGhpcy5fY29tcHJlc3MgPSBmYWxzZTsKICAgICAgdGhpcy5fYnVmZmVyZWRCeXRlcyA9IDA7CiAgICAgIHRoaXMuX3F1ZXVlID0gW107CiAgICAgIHRoaXMuX3N0YXRlID0gREVGQVVMVDsKICAgICAgdGhpcy5vbmVycm9yID0gTk9PUDsKICAgICAgdGhpc1trV2ViU29ja2V0XSA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICAvKioKICAgICAqIEZyYW1lcyBhIHBpZWNlIG9mIGRhdGEgYWNjb3JkaW5nIHRvIHRoZSBIeUJpIFdlYlNvY2tldCBwcm90b2NvbC4KICAgICAqCiAgICAgKiBAcGFyYW0geyhCdWZmZXJ8U3RyaW5nKX0gZGF0YSBUaGUgZGF0YSB0byBmcmFtZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZmluPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gc2V0IHRoZQogICAgICogICAgIEZJTiBiaXQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25zLmdlbmVyYXRlTWFza10gVGhlIGZ1bmN0aW9uIHVzZWQgdG8gZ2VuZXJhdGUgdGhlCiAgICAgKiAgICAgbWFza2luZyBrZXkKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMubWFzaz1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIG1hc2sKICAgICAqICAgICBgZGF0YWAKICAgICAqIEBwYXJhbSB7QnVmZmVyfSBbb3B0aW9ucy5tYXNrQnVmZmVyXSBUaGUgYnVmZmVyIHVzZWQgdG8gc3RvcmUgdGhlIG1hc2tpbmcKICAgICAqICAgICBrZXkKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLm9wY29kZSBUaGUgb3Bjb2RlCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnJlYWRPbmx5PWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBgZGF0YWAgY2FuIGJlCiAgICAgKiAgICAgbW9kaWZpZWQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucnN2MT1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIHNldCB0aGUKICAgICAqICAgICBSU1YxIGJpdAogICAgICogQHJldHVybiB7KEJ1ZmZlcnxTdHJpbmcpW119IFRoZSBmcmFtZWQgZGF0YQogICAgICogQHB1YmxpYwogICAgICovCiAgICBzdGF0aWMgZnJhbWUoZGF0YSwgb3B0aW9ucykgewogICAgICBsZXQgbWFzazsKICAgICAgbGV0IG1lcmdlID0gZmFsc2U7CiAgICAgIGxldCBvZmZzZXQgPSAyOwogICAgICBsZXQgc2tpcE1hc2tpbmcgPSBmYWxzZTsKICAgICAgaWYgKG9wdGlvbnMubWFzaykgewogICAgICAgIG1hc2sgPSBvcHRpb25zLm1hc2tCdWZmZXIgfHwgbWFza0J1ZmZlcjsKICAgICAgICBpZiAob3B0aW9ucy5nZW5lcmF0ZU1hc2spIHsKICAgICAgICAgIG9wdGlvbnMuZ2VuZXJhdGVNYXNrKG1hc2spOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAocmFuZG9tUG9vbFBvaW50ZXIgPT09IFJBTkRPTV9QT09MX1NJWkUpIHsKICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgICovCiAgICAgICAgICAgIGlmIChyYW5kb21Qb29sID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgIC8vIFRoaXMgaXMgbGF6aWx5IGluaXRpYWxpemVkIGJlY2F1c2Ugc2VydmVyLXNlbnQgZnJhbWVzIG11c3Qgbm90CiAgICAgICAgICAgICAgLy8gYmUgbWFza2VkIHNvIGl0IG1heSBuZXZlciBiZSB1c2VkLgogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgcmFuZG9tUG9vbCA9IEJ1ZmZlci5hbGxvYyhSQU5ET01fUE9PTF9TSVpFKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByYW5kb21GaWxsU3luYyhyYW5kb21Qb29sLCAwLCBSQU5ET01fUE9PTF9TSVpFKTsKICAgICAgICAgICAgcmFuZG9tUG9vbFBvaW50ZXIgPSAwOwogICAgICAgICAgfQogICAgICAgICAgbWFza1swXSA9IHJhbmRvbVBvb2xbcmFuZG9tUG9vbFBvaW50ZXIrK107CiAgICAgICAgICBtYXNrWzFdID0gcmFuZG9tUG9vbFtyYW5kb21Qb29sUG9pbnRlcisrXTsKICAgICAgICAgIG1hc2tbMl0gPSByYW5kb21Qb29sW3JhbmRvbVBvb2xQb2ludGVyKytdOwogICAgICAgICAgbWFza1szXSA9IHJhbmRvbVBvb2xbcmFuZG9tUG9vbFBvaW50ZXIrK107CiAgICAgICAgfQogICAgICAgIHNraXBNYXNraW5nID0gKG1hc2tbMF0gfCBtYXNrWzFdIHwgbWFza1syXSB8IG1hc2tbM10pID09PSAwOwogICAgICAgIG9mZnNldCA9IDY7CiAgICAgIH0KICAgICAgbGV0IGRhdGFMZW5ndGg7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoKCFvcHRpb25zLm1hc2sgfHwgc2tpcE1hc2tpbmcpICYmIG9wdGlvbnNba0J5dGVMZW5ndGhdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGRhdGFMZW5ndGggPSBvcHRpb25zW2tCeXRlTGVuZ3RoXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEpOwogICAgICAgICAgZGF0YUxlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhTGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgICAgbWVyZ2UgPSBvcHRpb25zLm1hc2sgJiYgb3B0aW9ucy5yZWFkT25seSAmJiAhc2tpcE1hc2tpbmc7CiAgICAgIH0KICAgICAgbGV0IHBheWxvYWRMZW5ndGggPSBkYXRhTGVuZ3RoOwogICAgICBpZiAoZGF0YUxlbmd0aCA+PSA2NTUzNikgewogICAgICAgIG9mZnNldCArPSA4OwogICAgICAgIHBheWxvYWRMZW5ndGggPSAxMjc7CiAgICAgIH0gZWxzZSBpZiAoZGF0YUxlbmd0aCA+IDEyNSkgewogICAgICAgIG9mZnNldCArPSAyOwogICAgICAgIHBheWxvYWRMZW5ndGggPSAxMjY7CiAgICAgIH0KICAgICAgY29uc3QgdGFyZ2V0ID0gQnVmZmVyLmFsbG9jVW5zYWZlKG1lcmdlID8gZGF0YUxlbmd0aCArIG9mZnNldCA6IG9mZnNldCk7CiAgICAgIHRhcmdldFswXSA9IG9wdGlvbnMuZmluID8gb3B0aW9ucy5vcGNvZGUgfCAweDgwIDogb3B0aW9ucy5vcGNvZGU7CiAgICAgIGlmIChvcHRpb25zLnJzdjEpIHRhcmdldFswXSB8PSAweDQwOwogICAgICB0YXJnZXRbMV0gPSBwYXlsb2FkTGVuZ3RoOwogICAgICBpZiAocGF5bG9hZExlbmd0aCA9PT0gMTI2KSB7CiAgICAgICAgdGFyZ2V0LndyaXRlVUludDE2QkUoZGF0YUxlbmd0aCwgMik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZExlbmd0aCA9PT0gMTI3KSB7CiAgICAgICAgdGFyZ2V0WzJdID0gdGFyZ2V0WzNdID0gMDsKICAgICAgICB0YXJnZXQud3JpdGVVSW50QkUoZGF0YUxlbmd0aCwgNCwgNik7CiAgICAgIH0KICAgICAgaWYgKCFvcHRpb25zLm1hc2spIHJldHVybiBbdGFyZ2V0LCBkYXRhXTsKICAgICAgdGFyZ2V0WzFdIHw9IDB4ODA7CiAgICAgIHRhcmdldFtvZmZzZXQgLSA0XSA9IG1hc2tbMF07CiAgICAgIHRhcmdldFtvZmZzZXQgLSAzXSA9IG1hc2tbMV07CiAgICAgIHRhcmdldFtvZmZzZXQgLSAyXSA9IG1hc2tbMl07CiAgICAgIHRhcmdldFtvZmZzZXQgLSAxXSA9IG1hc2tbM107CiAgICAgIGlmIChza2lwTWFza2luZykgcmV0dXJuIFt0YXJnZXQsIGRhdGFdOwogICAgICBpZiAobWVyZ2UpIHsKICAgICAgICBhcHBseU1hc2soZGF0YSwgbWFzaywgdGFyZ2V0LCBvZmZzZXQsIGRhdGFMZW5ndGgpOwogICAgICAgIHJldHVybiBbdGFyZ2V0XTsKICAgICAgfQogICAgICBhcHBseU1hc2soZGF0YSwgbWFzaywgZGF0YSwgMCwgZGF0YUxlbmd0aCk7CiAgICAgIHJldHVybiBbdGFyZ2V0LCBkYXRhXTsKICAgIH0KCiAgICAvKioKICAgICAqIFNlbmRzIGEgY2xvc2UgbWVzc2FnZSB0byB0aGUgb3RoZXIgcGVlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge051bWJlcn0gW2NvZGVdIFRoZSBzdGF0dXMgY29kZSBjb21wb25lbnQgb2YgdGhlIGJvZHkKICAgICAqIEBwYXJhbSB7KFN0cmluZ3xCdWZmZXIpfSBbZGF0YV0gVGhlIG1lc3NhZ2UgY29tcG9uZW50IG9mIHRoZSBib2R5CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFttYXNrPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gbWFzayB0aGUgbWVzc2FnZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NiXSBDYWxsYmFjawogICAgICogQHB1YmxpYwogICAgICovCiAgICBjbG9zZShjb2RlLCBkYXRhLCBtYXNrLCBjYikgewogICAgICBsZXQgYnVmOwogICAgICBpZiAoY29kZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgYnVmID0gRU1QVFlfQlVGRkVSOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb2RlICE9PSAnbnVtYmVyJyB8fCAhaXNWYWxpZFN0YXR1c0NvZGUoY29kZSkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdGaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgdmFsaWQgZXJyb3IgY29kZSBudW1iZXInKTsKICAgICAgfSBlbHNlIGlmIChkYXRhID09PSB1bmRlZmluZWQgfHwgIWRhdGEubGVuZ3RoKSB7CiAgICAgICAgYnVmID0gQnVmZmVyLmFsbG9jVW5zYWZlKDIpOwogICAgICAgIGJ1Zi53cml0ZVVJbnQxNkJFKGNvZGUsIDApOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKGRhdGEpOwogICAgICAgIGlmIChsZW5ndGggPiAxMjMpIHsKICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgbWVzc2FnZSBtdXN0IG5vdCBiZSBncmVhdGVyIHRoYW4gMTIzIGJ5dGVzJyk7CiAgICAgICAgfQogICAgICAgIGJ1ZiA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSgyICsgbGVuZ3RoKTsKICAgICAgICBidWYud3JpdGVVSW50MTZCRShjb2RlLCAwKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWYud3JpdGUoZGF0YSwgMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1Zi5zZXQoZGF0YSwgMik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgW2tCeXRlTGVuZ3RoXTogYnVmLmxlbmd0aCwKICAgICAgICBmaW46IHRydWUsCiAgICAgICAgZ2VuZXJhdGVNYXNrOiB0aGlzLl9nZW5lcmF0ZU1hc2ssCiAgICAgICAgbWFzaywKICAgICAgICBtYXNrQnVmZmVyOiB0aGlzLl9tYXNrQnVmZmVyLAogICAgICAgIG9wY29kZTogMHgwOCwKICAgICAgICByZWFkT25seTogZmFsc2UsCiAgICAgICAgcnN2MTogZmFsc2UKICAgICAgfTsKICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBERUZBVUxUKSB7CiAgICAgICAgdGhpcy5lbnF1ZXVlKFt0aGlzLmRpc3BhdGNoLCBidWYsIGZhbHNlLCBvcHRpb25zLCBjYl0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2VuZEZyYW1lKFNlbmRlci5mcmFtZShidWYsIG9wdGlvbnMpLCBjYik7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNlbmRzIGEgcGluZyBtZXNzYWdlIHRvIHRoZSBvdGhlciBwZWVyLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFttYXNrPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gbWFzayBgZGF0YWAKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gQ2FsbGJhY2sKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgcGluZyhkYXRhLCBtYXNrLCBjYikgewogICAgICBsZXQgYnl0ZUxlbmd0aDsKICAgICAgbGV0IHJlYWRPbmx5OwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgYnl0ZUxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKGRhdGEpOwogICAgICAgIHJlYWRPbmx5ID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNCbG9iKGRhdGEpKSB7CiAgICAgICAgYnl0ZUxlbmd0aCA9IGRhdGEuc2l6ZTsKICAgICAgICByZWFkT25seSA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB0b0J1ZmZlcihkYXRhKTsKICAgICAgICBieXRlTGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgICAgcmVhZE9ubHkgPSB0b0J1ZmZlci5yZWFkT25seTsKICAgICAgfQogICAgICBpZiAoYnl0ZUxlbmd0aCA+IDEyNSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgZGF0YSBzaXplIG11c3Qgbm90IGJlIGdyZWF0ZXIgdGhhbiAxMjUgYnl0ZXMnKTsKICAgICAgfQogICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgIFtrQnl0ZUxlbmd0aF06IGJ5dGVMZW5ndGgsCiAgICAgICAgZmluOiB0cnVlLAogICAgICAgIGdlbmVyYXRlTWFzazogdGhpcy5fZ2VuZXJhdGVNYXNrLAogICAgICAgIG1hc2ssCiAgICAgICAgbWFza0J1ZmZlcjogdGhpcy5fbWFza0J1ZmZlciwKICAgICAgICBvcGNvZGU6IDB4MDksCiAgICAgICAgcmVhZE9ubHksCiAgICAgICAgcnN2MTogZmFsc2UKICAgICAgfTsKICAgICAgaWYgKGlzQmxvYihkYXRhKSkgewogICAgICAgIGlmICh0aGlzLl9zdGF0ZSAhPT0gREVGQVVMVCkgewogICAgICAgICAgdGhpcy5lbnF1ZXVlKFt0aGlzLmdldEJsb2JEYXRhLCBkYXRhLCBmYWxzZSwgb3B0aW9ucywgY2JdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5nZXRCbG9iRGF0YShkYXRhLCBmYWxzZSwgb3B0aW9ucywgY2IpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLl9zdGF0ZSAhPT0gREVGQVVMVCkgewogICAgICAgIHRoaXMuZW5xdWV1ZShbdGhpcy5kaXNwYXRjaCwgZGF0YSwgZmFsc2UsIG9wdGlvbnMsIGNiXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZW5kRnJhbWUoU2VuZGVyLmZyYW1lKGRhdGEsIG9wdGlvbnMpLCBjYik7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNlbmRzIGEgcG9uZyBtZXNzYWdlIHRvIHRoZSBvdGhlciBwZWVyLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFttYXNrPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gbWFzayBgZGF0YWAKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gQ2FsbGJhY2sKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgcG9uZyhkYXRhLCBtYXNrLCBjYikgewogICAgICBsZXQgYnl0ZUxlbmd0aDsKICAgICAgbGV0IHJlYWRPbmx5OwogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgYnl0ZUxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKGRhdGEpOwogICAgICAgIHJlYWRPbmx5ID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNCbG9iKGRhdGEpKSB7CiAgICAgICAgYnl0ZUxlbmd0aCA9IGRhdGEuc2l6ZTsKICAgICAgICByZWFkT25seSA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEgPSB0b0J1ZmZlcihkYXRhKTsKICAgICAgICBieXRlTGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgICAgcmVhZE9ubHkgPSB0b0J1ZmZlci5yZWFkT25seTsKICAgICAgfQogICAgICBpZiAoYnl0ZUxlbmd0aCA+IDEyNSkgewogICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdUaGUgZGF0YSBzaXplIG11c3Qgbm90IGJlIGdyZWF0ZXIgdGhhbiAxMjUgYnl0ZXMnKTsKICAgICAgfQogICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgIFtrQnl0ZUxlbmd0aF06IGJ5dGVMZW5ndGgsCiAgICAgICAgZmluOiB0cnVlLAogICAgICAgIGdlbmVyYXRlTWFzazogdGhpcy5fZ2VuZXJhdGVNYXNrLAogICAgICAgIG1hc2ssCiAgICAgICAgbWFza0J1ZmZlcjogdGhpcy5fbWFza0J1ZmZlciwKICAgICAgICBvcGNvZGU6IDB4MGEsCiAgICAgICAgcmVhZE9ubHksCiAgICAgICAgcnN2MTogZmFsc2UKICAgICAgfTsKICAgICAgaWYgKGlzQmxvYihkYXRhKSkgewogICAgICAgIGlmICh0aGlzLl9zdGF0ZSAhPT0gREVGQVVMVCkgewogICAgICAgICAgdGhpcy5lbnF1ZXVlKFt0aGlzLmdldEJsb2JEYXRhLCBkYXRhLCBmYWxzZSwgb3B0aW9ucywgY2JdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5nZXRCbG9iRGF0YShkYXRhLCBmYWxzZSwgb3B0aW9ucywgY2IpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLl9zdGF0ZSAhPT0gREVGQVVMVCkgewogICAgICAgIHRoaXMuZW5xdWV1ZShbdGhpcy5kaXNwYXRjaCwgZGF0YSwgZmFsc2UsIG9wdGlvbnMsIGNiXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZW5kRnJhbWUoU2VuZGVyLmZyYW1lKGRhdGEsIG9wdGlvbnMpLCBjYik7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNlbmRzIGEgZGF0YSBtZXNzYWdlIHRvIHRoZSBvdGhlciBwZWVyLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBPcHRpb25zIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5iaW5hcnk9ZmFsc2VdIFNwZWNpZmllcyB3aGV0aGVyIGBkYXRhYCBpcyBiaW5hcnkKICAgICAqICAgICBvciB0ZXh0CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmNvbXByZXNzPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8KICAgICAqICAgICBjb21wcmVzcyBgZGF0YWAKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZmluPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciB0aGUgZnJhZ21lbnQgaXMgdGhlCiAgICAgKiAgICAgbGFzdCBvbmUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMubWFzaz1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIG1hc2sKICAgICAqICAgICBgZGF0YWAKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gQ2FsbGJhY2sKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgc2VuZChkYXRhLCBvcHRpb25zLCBjYikgewogICAgICBjb25zdCBwZXJNZXNzYWdlRGVmbGF0ZSA9IHRoaXMuX2V4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV07CiAgICAgIGxldCBvcGNvZGUgPSBvcHRpb25zLmJpbmFyeSA/IDIgOiAxOwogICAgICBsZXQgcnN2MSA9IG9wdGlvbnMuY29tcHJlc3M7CiAgICAgIGxldCBieXRlTGVuZ3RoOwogICAgICBsZXQgcmVhZE9ubHk7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBieXRlTGVuZ3RoID0gQnVmZmVyLmJ5dGVMZW5ndGgoZGF0YSk7CiAgICAgICAgcmVhZE9ubHkgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChpc0Jsb2IoZGF0YSkpIHsKICAgICAgICBieXRlTGVuZ3RoID0gZGF0YS5zaXplOwogICAgICAgIHJlYWRPbmx5ID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGF0YSA9IHRvQnVmZmVyKGRhdGEpOwogICAgICAgIGJ5dGVMZW5ndGggPSBkYXRhLmxlbmd0aDsKICAgICAgICByZWFkT25seSA9IHRvQnVmZmVyLnJlYWRPbmx5OwogICAgICB9CiAgICAgIGlmICh0aGlzLl9maXJzdEZyYWdtZW50KSB7CiAgICAgICAgdGhpcy5fZmlyc3RGcmFnbWVudCA9IGZhbHNlOwogICAgICAgIGlmIChyc3YxICYmIHBlck1lc3NhZ2VEZWZsYXRlICYmIHBlck1lc3NhZ2VEZWZsYXRlLnBhcmFtc1twZXJNZXNzYWdlRGVmbGF0ZS5faXNTZXJ2ZXIgPyAnc2VydmVyX25vX2NvbnRleHRfdGFrZW92ZXInIDogJ2NsaWVudF9ub19jb250ZXh0X3Rha2VvdmVyJ10pIHsKICAgICAgICAgIHJzdjEgPSBieXRlTGVuZ3RoID49IHBlck1lc3NhZ2VEZWZsYXRlLl90aHJlc2hvbGQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2NvbXByZXNzID0gcnN2MTsKICAgICAgfSBlbHNlIHsKICAgICAgICByc3YxID0gZmFsc2U7CiAgICAgICAgb3Bjb2RlID0gMDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5maW4pIHRoaXMuX2ZpcnN0RnJhZ21lbnQgPSB0cnVlOwogICAgICBjb25zdCBvcHRzID0gewogICAgICAgIFtrQnl0ZUxlbmd0aF06IGJ5dGVMZW5ndGgsCiAgICAgICAgZmluOiBvcHRpb25zLmZpbiwKICAgICAgICBnZW5lcmF0ZU1hc2s6IHRoaXMuX2dlbmVyYXRlTWFzaywKICAgICAgICBtYXNrOiBvcHRpb25zLm1hc2ssCiAgICAgICAgbWFza0J1ZmZlcjogdGhpcy5fbWFza0J1ZmZlciwKICAgICAgICBvcGNvZGUsCiAgICAgICAgcmVhZE9ubHksCiAgICAgICAgcnN2MQogICAgICB9OwogICAgICBpZiAoaXNCbG9iKGRhdGEpKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBERUZBVUxUKSB7CiAgICAgICAgICB0aGlzLmVucXVldWUoW3RoaXMuZ2V0QmxvYkRhdGEsIGRhdGEsIHRoaXMuX2NvbXByZXNzLCBvcHRzLCBjYl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmdldEJsb2JEYXRhKGRhdGEsIHRoaXMuX2NvbXByZXNzLCBvcHRzLCBjYik7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMuX3N0YXRlICE9PSBERUZBVUxUKSB7CiAgICAgICAgdGhpcy5lbnF1ZXVlKFt0aGlzLmRpc3BhdGNoLCBkYXRhLCB0aGlzLl9jb21wcmVzcywgb3B0cywgY2JdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmRpc3BhdGNoKGRhdGEsIHRoaXMuX2NvbXByZXNzLCBvcHRzLCBjYik7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGNvbnRlbnRzIG9mIGEgYmxvYiBhcyBiaW5hcnkgZGF0YS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Jsb2J9IGJsb2IgVGhlIGJsb2IKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW2NvbXByZXNzPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gY29tcHJlc3MKICAgICAqICAgICB0aGUgZGF0YQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZmluPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gc2V0IHRoZQogICAgICogICAgIEZJTiBiaXQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25zLmdlbmVyYXRlTWFza10gVGhlIGZ1bmN0aW9uIHVzZWQgdG8gZ2VuZXJhdGUgdGhlCiAgICAgKiAgICAgbWFza2luZyBrZXkKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMubWFzaz1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIG1hc2sKICAgICAqICAgICBgZGF0YWAKICAgICAqIEBwYXJhbSB7QnVmZmVyfSBbb3B0aW9ucy5tYXNrQnVmZmVyXSBUaGUgYnVmZmVyIHVzZWQgdG8gc3RvcmUgdGhlIG1hc2tpbmcKICAgICAqICAgICBrZXkKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLm9wY29kZSBUaGUgb3Bjb2RlCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnJlYWRPbmx5PWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBgZGF0YWAgY2FuIGJlCiAgICAgKiAgICAgbW9kaWZpZWQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucnN2MT1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIHNldCB0aGUKICAgICAqICAgICBSU1YxIGJpdAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NiXSBDYWxsYmFjawogICAgICogQHByaXZhdGUKICAgICAqLwogICAgZ2V0QmxvYkRhdGEoYmxvYiwgY29tcHJlc3MsIG9wdGlvbnMsIGNiKSB7CiAgICAgIHRoaXMuX2J1ZmZlcmVkQnl0ZXMgKz0gb3B0aW9uc1trQnl0ZUxlbmd0aF07CiAgICAgIHRoaXMuX3N0YXRlID0gR0VUX0JMT0JfREFUQTsKICAgICAgYmxvYi5hcnJheUJ1ZmZlcigpLnRoZW4oYXJyYXlCdWZmZXIgPT4gewogICAgICAgIGlmICh0aGlzLl9zb2NrZXQuZGVzdHJveWVkKSB7CiAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ1RoZSBzb2NrZXQgd2FzIGNsb3NlZCB3aGlsZSB0aGUgYmxvYiB3YXMgYmVpbmcgcmVhZCcpOwoKICAgICAgICAgIC8vCiAgICAgICAgICAvLyBgY2FsbENhbGxiYWNrc2AgaXMgY2FsbGVkIGluIHRoZSBuZXh0IHRpY2sgdG8gZW5zdXJlIHRoYXQgZXJyb3JzCiAgICAgICAgICAvLyB0aGF0IG1pZ2h0IGJlIHRocm93biBpbiB0aGUgY2FsbGJhY2tzIGJlaGF2ZSBsaWtlIGVycm9ycyB0aHJvd24KICAgICAgICAgIC8vIG91dHNpZGUgdGhlIHByb21pc2UgY2hhaW4uCiAgICAgICAgICAvLwogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYWxsQ2FsbGJhY2tzLCB0aGlzLCBlcnIsIGNiKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fYnVmZmVyZWRCeXRlcyAtPSBvcHRpb25zW2tCeXRlTGVuZ3RoXTsKICAgICAgICBjb25zdCBkYXRhID0gdG9CdWZmZXIoYXJyYXlCdWZmZXIpOwogICAgICAgIGlmICghY29tcHJlc3MpIHsKICAgICAgICAgIHRoaXMuX3N0YXRlID0gREVGQVVMVDsKICAgICAgICAgIHRoaXMuc2VuZEZyYW1lKFNlbmRlci5mcmFtZShkYXRhLCBvcHRpb25zKSwgY2IpOwogICAgICAgICAgdGhpcy5kZXF1ZXVlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2goZGF0YSwgY29tcHJlc3MsIG9wdGlvbnMsIGNiKTsKICAgICAgICB9CiAgICAgIH0pLmNhdGNoKGVyciA9PiB7CiAgICAgICAgLy8KICAgICAgICAvLyBgb25FcnJvcmAgaXMgY2FsbGVkIGluIHRoZSBuZXh0IHRpY2sgZm9yIHRoZSBzYW1lIHJlYXNvbiB0aGF0CiAgICAgICAgLy8gYGNhbGxDYWxsYmFja3NgIGFib3ZlIGlzLgogICAgICAgIC8vCiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhvbkVycm9yLCB0aGlzLCBlcnIsIGNiKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVzIGEgbWVzc2FnZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyhCdWZmZXJ8U3RyaW5nKX0gZGF0YSBUaGUgbWVzc2FnZSB0byBzZW5kCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtjb21wcmVzcz1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvIGNvbXByZXNzCiAgICAgKiAgICAgYGRhdGFgCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBPcHRpb25zIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5maW49ZmFsc2VdIFNwZWNpZmllcyB3aGV0aGVyIG9yIG5vdCB0byBzZXQgdGhlCiAgICAgKiAgICAgRklOIGJpdAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuZ2VuZXJhdGVNYXNrXSBUaGUgZnVuY3Rpb24gdXNlZCB0byBnZW5lcmF0ZSB0aGUKICAgICAqICAgICBtYXNraW5nIGtleQogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5tYXNrPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gbWFzawogICAgICogICAgIGBkYXRhYAogICAgICogQHBhcmFtIHtCdWZmZXJ9IFtvcHRpb25zLm1hc2tCdWZmZXJdIFRoZSBidWZmZXIgdXNlZCB0byBzdG9yZSB0aGUgbWFza2luZwogICAgICogICAgIGtleQogICAgICogQHBhcmFtIHtOdW1iZXJ9IG9wdGlvbnMub3Bjb2RlIFRoZSBvcGNvZGUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmVhZE9ubHk9ZmFsc2VdIFNwZWNpZmllcyB3aGV0aGVyIGBkYXRhYCBjYW4gYmUKICAgICAqICAgICBtb2RpZmllZAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5yc3YxPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gc2V0IHRoZQogICAgICogICAgIFJTVjEgYml0CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2JdIENhbGxiYWNrCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBkaXNwYXRjaChkYXRhLCBjb21wcmVzcywgb3B0aW9ucywgY2IpIHsKICAgICAgaWYgKCFjb21wcmVzcykgewogICAgICAgIHRoaXMuc2VuZEZyYW1lKFNlbmRlci5mcmFtZShkYXRhLCBvcHRpb25zKSwgY2IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBwZXJNZXNzYWdlRGVmbGF0ZSA9IHRoaXMuX2V4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV07CiAgICAgIHRoaXMuX2J1ZmZlcmVkQnl0ZXMgKz0gb3B0aW9uc1trQnl0ZUxlbmd0aF07CiAgICAgIHRoaXMuX3N0YXRlID0gREVGTEFUSU5HOwogICAgICBwZXJNZXNzYWdlRGVmbGF0ZS5jb21wcmVzcyhkYXRhLCBvcHRpb25zLmZpbiwgKF8sIGJ1ZikgPT4gewogICAgICAgIGlmICh0aGlzLl9zb2NrZXQuZGVzdHJveWVkKSB7CiAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ1RoZSBzb2NrZXQgd2FzIGNsb3NlZCB3aGlsZSBkYXRhIHdhcyBiZWluZyBjb21wcmVzc2VkJyk7CiAgICAgICAgICBjYWxsQ2FsbGJhY2tzKHRoaXMsIGVyciwgY2IpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLl9idWZmZXJlZEJ5dGVzIC09IG9wdGlvbnNba0J5dGVMZW5ndGhdOwogICAgICAgIHRoaXMuX3N0YXRlID0gREVGQVVMVDsKICAgICAgICBvcHRpb25zLnJlYWRPbmx5ID0gZmFsc2U7CiAgICAgICAgdGhpcy5zZW5kRnJhbWUoU2VuZGVyLmZyYW1lKGJ1Ziwgb3B0aW9ucyksIGNiKTsKICAgICAgICB0aGlzLmRlcXVldWUoKTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyBxdWV1ZWQgc2VuZCBvcGVyYXRpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGRlcXVldWUoKSB7CiAgICAgIHdoaWxlICh0aGlzLl9zdGF0ZSA9PT0gREVGQVVMVCAmJiB0aGlzLl9xdWV1ZS5sZW5ndGgpIHsKICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLl9xdWV1ZS5zaGlmdCgpOwogICAgICAgIHRoaXMuX2J1ZmZlcmVkQnl0ZXMgLT0gcGFyYW1zWzNdW2tCeXRlTGVuZ3RoXTsKICAgICAgICBSZWZsZWN0LmFwcGx5KHBhcmFtc1swXSwgdGhpcywgcGFyYW1zLnNsaWNlKDEpKTsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRW5xdWV1ZXMgYSBzZW5kIG9wZXJhdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5fSBwYXJhbXMgU2VuZCBvcGVyYXRpb24gcGFyYW1ldGVycy4KICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGVucXVldWUocGFyYW1zKSB7CiAgICAgIHRoaXMuX2J1ZmZlcmVkQnl0ZXMgKz0gcGFyYW1zWzNdW2tCeXRlTGVuZ3RoXTsKICAgICAgdGhpcy5fcXVldWUucHVzaChwYXJhbXMpOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZHMgYSBmcmFtZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyhCdWZmZXIgfCBTdHJpbmcpW119IGxpc3QgVGhlIGZyYW1lIHRvIHNlbmQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gQ2FsbGJhY2sKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHNlbmRGcmFtZShsaXN0LCBjYikgewogICAgICBpZiAobGlzdC5sZW5ndGggPT09IDIpIHsKICAgICAgICB0aGlzLl9zb2NrZXQuY29yaygpOwogICAgICAgIHRoaXMuX3NvY2tldC53cml0ZShsaXN0WzBdKTsKICAgICAgICB0aGlzLl9zb2NrZXQud3JpdGUobGlzdFsxXSwgY2IpOwogICAgICAgIHRoaXMuX3NvY2tldC51bmNvcmsoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9zb2NrZXQud3JpdGUobGlzdFswXSwgY2IpOwogICAgICB9CiAgICB9CiAgfQogIHNlbmRlciA9IFNlbmRlcjsKCiAgLyoqCiAgICogQ2FsbHMgcXVldWVkIGNhbGxiYWNrcyB3aXRoIGFuIGVycm9yLgogICAqCiAgICogQHBhcmFtIHtTZW5kZXJ9IHNlbmRlciBUaGUgYFNlbmRlcmAgaW5zdGFuY2UKICAgKiBAcGFyYW0ge0Vycm9yfSBlcnIgVGhlIGVycm9yIHRvIGNhbGwgdGhlIGNhbGxiYWNrcyB3aXRoCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NiXSBUaGUgZmlyc3QgY2FsbGJhY2sKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNhbGxDYWxsYmFja3Moc2VuZGVyLCBlcnIsIGNiKSB7CiAgICBpZiAodHlwZW9mIGNiID09PSAnZnVuY3Rpb24nKSBjYihlcnIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZW5kZXIuX3F1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBhcmFtcyA9IHNlbmRlci5fcXVldWVbaV07CiAgICAgIGNvbnN0IGNhbGxiYWNrID0gcGFyYW1zW3BhcmFtcy5sZW5ndGggLSAxXTsKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2soZXJyKTsKICAgIH0KICB9CgogIC8qKgogICAqIEhhbmRsZXMgYSBgU2VuZGVyYCBlcnJvci4KICAgKgogICAqIEBwYXJhbSB7U2VuZGVyfSBzZW5kZXIgVGhlIGBTZW5kZXJgIGluc3RhbmNlCiAgICogQHBhcmFtIHtFcnJvcn0gZXJyIFRoZSBlcnJvcgogICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gVGhlIGZpcnN0IHBlbmRpbmcgY2FsbGJhY2sKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9uRXJyb3Ioc2VuZGVyLCBlcnIsIGNiKSB7CiAgICBjYWxsQ2FsbGJhY2tzKHNlbmRlciwgZXJyLCBjYik7CiAgICBzZW5kZXIub25lcnJvcihlcnIpOwogIH0KICByZXR1cm4gc2VuZGVyOwp9Cgp2YXIgZXZlbnRUYXJnZXQ7CnZhciBoYXNSZXF1aXJlZEV2ZW50VGFyZ2V0OwpmdW5jdGlvbiByZXF1aXJlRXZlbnRUYXJnZXQoKSB7CiAgaWYgKGhhc1JlcXVpcmVkRXZlbnRUYXJnZXQpIHJldHVybiBldmVudFRhcmdldDsKICBoYXNSZXF1aXJlZEV2ZW50VGFyZ2V0ID0gMTsKICBjb25zdCB7CiAgICBrRm9yT25FdmVudEF0dHJpYnV0ZSwKICAgIGtMaXN0ZW5lcgogIH0gPSByZXF1aXJlQ29uc3RhbnRzJDMoKTsKICBjb25zdCBrQ29kZSA9IFN5bWJvbCgna0NvZGUnKTsKICBjb25zdCBrRGF0YSA9IFN5bWJvbCgna0RhdGEnKTsKICBjb25zdCBrRXJyb3IgPSBTeW1ib2woJ2tFcnJvcicpOwogIGNvbnN0IGtNZXNzYWdlID0gU3ltYm9sKCdrTWVzc2FnZScpOwogIGNvbnN0IGtSZWFzb24gPSBTeW1ib2woJ2tSZWFzb24nKTsKICBjb25zdCBrVGFyZ2V0ID0gU3ltYm9sKCdrVGFyZ2V0Jyk7CiAgY29uc3Qga1R5cGUgPSBTeW1ib2woJ2tUeXBlJyk7CiAgY29uc3Qga1dhc0NsZWFuID0gU3ltYm9sKCdrV2FzQ2xlYW4nKTsKCiAgLyoqCiAgICogQ2xhc3MgcmVwcmVzZW50aW5nIGFuIGV2ZW50LgogICAqLwogIGNsYXNzIEV2ZW50IHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGBFdmVudGAuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgKiBAdGhyb3dzIHtUeXBlRXJyb3J9IElmIHRoZSBgdHlwZWAgYXJndW1lbnQgaXMgbm90IHNwZWNpZmllZAogICAgICovCiAgICBjb25zdHJ1Y3Rvcih0eXBlKSB7CiAgICAgIHRoaXNba1RhcmdldF0gPSBudWxsOwogICAgICB0aGlzW2tUeXBlXSA9IHR5cGU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAdHlwZSB7Kn0KICAgICAqLwogICAgZ2V0IHRhcmdldCgpIHsKICAgICAgcmV0dXJuIHRoaXNba1RhcmdldF07CiAgICB9CgogICAgLyoqCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBnZXQgdHlwZSgpIHsKICAgICAgcmV0dXJuIHRoaXNba1R5cGVdOwogICAgfQogIH0KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRXZlbnQucHJvdG90eXBlLCAndGFyZ2V0JywgewogICAgZW51bWVyYWJsZTogdHJ1ZQogIH0pOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFdmVudC5wcm90b3R5cGUsICd0eXBlJywgewogICAgZW51bWVyYWJsZTogdHJ1ZQogIH0pOwoKICAvKioKICAgKiBDbGFzcyByZXByZXNlbnRpbmcgYSBjbG9zZSBldmVudC4KICAgKgogICAqIEBleHRlbmRzIEV2ZW50CiAgICovCiAgY2xhc3MgQ2xvc2VFdmVudCBleHRlbmRzIEV2ZW50IHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGBDbG9zZUV2ZW50YC4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gQSBkaWN0aW9uYXJ5IG9iamVjdCB0aGF0IGFsbG93cyBmb3Igc2V0dGluZwogICAgICogICAgIGF0dHJpYnV0ZXMgdmlhIG9iamVjdCBtZW1iZXJzIG9mIHRoZSBzYW1lIG5hbWUKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5jb2RlPTBdIFRoZSBzdGF0dXMgY29kZSBleHBsYWluaW5nIHdoeSB0aGUKICAgICAqICAgICBjb25uZWN0aW9uIHdhcyBjbG9zZWQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5yZWFzb249JyddIEEgaHVtYW4tcmVhZGFibGUgc3RyaW5nIGV4cGxhaW5pbmcgd2h5CiAgICAgKiAgICAgdGhlIGNvbm5lY3Rpb24gd2FzIGNsb3NlZAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy53YXNDbGVhbj1mYWxzZV0gSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHRoZQogICAgICogICAgIGNvbm5lY3Rpb24gd2FzIGNsZWFubHkgY2xvc2VkCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHR5cGUsIG9wdGlvbnMgPSB7fSkgewogICAgICBzdXBlcih0eXBlKTsKICAgICAgdGhpc1trQ29kZV0gPSBvcHRpb25zLmNvZGUgPT09IHVuZGVmaW5lZCA/IDAgOiBvcHRpb25zLmNvZGU7CiAgICAgIHRoaXNba1JlYXNvbl0gPSBvcHRpb25zLnJlYXNvbiA9PT0gdW5kZWZpbmVkID8gJycgOiBvcHRpb25zLnJlYXNvbjsKICAgICAgdGhpc1trV2FzQ2xlYW5dID0gb3B0aW9ucy53YXNDbGVhbiA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBvcHRpb25zLndhc0NsZWFuOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge051bWJlcn0KICAgICAqLwogICAgZ2V0IGNvZGUoKSB7CiAgICAgIHJldHVybiB0aGlzW2tDb2RlXTsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldCByZWFzb24oKSB7CiAgICAgIHJldHVybiB0aGlzW2tSZWFzb25dOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIGdldCB3YXNDbGVhbigpIHsKICAgICAgcmV0dXJuIHRoaXNba1dhc0NsZWFuXTsKICAgIH0KICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENsb3NlRXZlbnQucHJvdG90eXBlLCAnY29kZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUKICB9KTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ2xvc2VFdmVudC5wcm90b3R5cGUsICdyZWFzb24nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENsb3NlRXZlbnQucHJvdG90eXBlLCAnd2FzQ2xlYW4nLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSk7CgogIC8qKgogICAqIENsYXNzIHJlcHJlc2VudGluZyBhbiBlcnJvciBldmVudC4KICAgKgogICAqIEBleHRlbmRzIEV2ZW50CiAgICovCiAgY2xhc3MgRXJyb3JFdmVudCBleHRlbmRzIEV2ZW50IHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGBFcnJvckV2ZW50YC4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gQSBkaWN0aW9uYXJ5IG9iamVjdCB0aGF0IGFsbG93cyBmb3Igc2V0dGluZwogICAgICogICAgIGF0dHJpYnV0ZXMgdmlhIG9iamVjdCBtZW1iZXJzIG9mIHRoZSBzYW1lIG5hbWUKICAgICAqIEBwYXJhbSB7Kn0gW29wdGlvbnMuZXJyb3I9bnVsbF0gVGhlIGVycm9yIHRoYXQgZ2VuZXJhdGVkIHRoaXMgZXZlbnQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5tZXNzYWdlPScnXSBUaGUgZXJyb3IgbWVzc2FnZQogICAgICovCiAgICBjb25zdHJ1Y3Rvcih0eXBlLCBvcHRpb25zID0ge30pIHsKICAgICAgc3VwZXIodHlwZSk7CiAgICAgIHRoaXNba0Vycm9yXSA9IG9wdGlvbnMuZXJyb3IgPT09IHVuZGVmaW5lZCA/IG51bGwgOiBvcHRpb25zLmVycm9yOwogICAgICB0aGlzW2tNZXNzYWdlXSA9IG9wdGlvbnMubWVzc2FnZSA9PT0gdW5kZWZpbmVkID8gJycgOiBvcHRpb25zLm1lc3NhZ2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBAdHlwZSB7Kn0KICAgICAqLwogICAgZ2V0IGVycm9yKCkgewogICAgICByZXR1cm4gdGhpc1trRXJyb3JdOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge1N0cmluZ30KICAgICAqLwogICAgZ2V0IG1lc3NhZ2UoKSB7CiAgICAgIHJldHVybiB0aGlzW2tNZXNzYWdlXTsKICAgIH0KICB9CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVycm9yRXZlbnQucHJvdG90eXBlLCAnZXJyb3InLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlCiAgfSk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVycm9yRXZlbnQucHJvdG90eXBlLCAnbWVzc2FnZScsIHsKICAgIGVudW1lcmFibGU6IHRydWUKICB9KTsKCiAgLyoqCiAgICogQ2xhc3MgcmVwcmVzZW50aW5nIGEgbWVzc2FnZSBldmVudC4KICAgKgogICAqIEBleHRlbmRzIEV2ZW50CiAgICovCiAgY2xhc3MgTWVzc2FnZUV2ZW50IGV4dGVuZHMgRXZlbnQgewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgYE1lc3NhZ2VFdmVudGAuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIG5hbWUgb2YgdGhlIGV2ZW50CiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIEEgZGljdGlvbmFyeSBvYmplY3QgdGhhdCBhbGxvd3MgZm9yIHNldHRpbmcKICAgICAqICAgICBhdHRyaWJ1dGVzIHZpYSBvYmplY3QgbWVtYmVycyBvZiB0aGUgc2FtZSBuYW1lCiAgICAgKiBAcGFyYW0geyp9IFtvcHRpb25zLmRhdGE9bnVsbF0gVGhlIG1lc3NhZ2UgY29udGVudAogICAgICovCiAgICBjb25zdHJ1Y3Rvcih0eXBlLCBvcHRpb25zID0ge30pIHsKICAgICAgc3VwZXIodHlwZSk7CiAgICAgIHRoaXNba0RhdGFdID0gb3B0aW9ucy5kYXRhID09PSB1bmRlZmluZWQgPyBudWxsIDogb3B0aW9ucy5kYXRhOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUgeyp9CiAgICAgKi8KICAgIGdldCBkYXRhKCkgewogICAgICByZXR1cm4gdGhpc1trRGF0YV07CiAgICB9CiAgfQogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNZXNzYWdlRXZlbnQucHJvdG90eXBlLCAnZGF0YScsIHsKICAgIGVudW1lcmFibGU6IHRydWUKICB9KTsKCiAgLyoqCiAgICogVGhpcyBwcm92aWRlcyBtZXRob2RzIGZvciBlbXVsYXRpbmcgdGhlIGBFdmVudFRhcmdldGAgaW50ZXJmYWNlLiBJdCdzIG5vdAogICAqIG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHkuCiAgICoKICAgKiBAbWl4aW4KICAgKi8KICBjb25zdCBFdmVudFRhcmdldCA9IHsKICAgIC8qKgogICAgICogUmVnaXN0ZXIgYW4gZXZlbnQgbGlzdGVuZXIuCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBldmVudCB0eXBlIHRvIGxpc3RlbiBmb3IKICAgICAqIEBwYXJhbSB7KEZ1bmN0aW9ufE9iamVjdCl9IGhhbmRsZXIgVGhlIGxpc3RlbmVyIHRvIGFkZAogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBBbiBvcHRpb25zIG9iamVjdCBzcGVjaWZpZXMgY2hhcmFjdGVyaXN0aWNzIGFib3V0CiAgICAgKiAgICAgdGhlIGV2ZW50IGxpc3RlbmVyCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLm9uY2U9ZmFsc2VdIEEgYEJvb2xlYW5gIGluZGljYXRpbmcgdGhhdCB0aGUKICAgICAqICAgICBsaXN0ZW5lciBzaG91bGQgYmUgaW52b2tlZCBhdCBtb3N0IG9uY2UgYWZ0ZXIgYmVpbmcgYWRkZWQuIElmIGB0cnVlYCwKICAgICAqICAgICB0aGUgbGlzdGVuZXIgd291bGQgYmUgYXV0b21hdGljYWxseSByZW1vdmVkIHdoZW4gaW52b2tlZC4KICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyLCBvcHRpb25zID0ge30pIHsKICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLmxpc3RlbmVycyh0eXBlKSkgewogICAgICAgIGlmICghb3B0aW9uc1trRm9yT25FdmVudEF0dHJpYnV0ZV0gJiYgbGlzdGVuZXJba0xpc3RlbmVyXSA9PT0gaGFuZGxlciAmJiAhbGlzdGVuZXJba0Zvck9uRXZlbnRBdHRyaWJ1dGVdKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIGxldCB3cmFwcGVyOwogICAgICBpZiAodHlwZSA9PT0gJ21lc3NhZ2UnKSB7CiAgICAgICAgd3JhcHBlciA9IGZ1bmN0aW9uIG9uTWVzc2FnZShkYXRhLCBpc0JpbmFyeSkgewogICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgTWVzc2FnZUV2ZW50KCdtZXNzYWdlJywgewogICAgICAgICAgICBkYXRhOiBpc0JpbmFyeSA/IGRhdGEgOiBkYXRhLnRvU3RyaW5nKCkKICAgICAgICAgIH0pOwogICAgICAgICAgZXZlbnRba1RhcmdldF0gPSB0aGlzOwogICAgICAgICAgY2FsbExpc3RlbmVyKGhhbmRsZXIsIHRoaXMsIGV2ZW50KTsKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdjbG9zZScpIHsKICAgICAgICB3cmFwcGVyID0gZnVuY3Rpb24gb25DbG9zZShjb2RlLCBtZXNzYWdlKSB7CiAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBDbG9zZUV2ZW50KCdjbG9zZScsIHsKICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgcmVhc29uOiBtZXNzYWdlLnRvU3RyaW5nKCksCiAgICAgICAgICAgIHdhc0NsZWFuOiB0aGlzLl9jbG9zZUZyYW1lUmVjZWl2ZWQgJiYgdGhpcy5fY2xvc2VGcmFtZVNlbnQKICAgICAgICAgIH0pOwogICAgICAgICAgZXZlbnRba1RhcmdldF0gPSB0aGlzOwogICAgICAgICAgY2FsbExpc3RlbmVyKGhhbmRsZXIsIHRoaXMsIGV2ZW50KTsKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgICB3cmFwcGVyID0gZnVuY3Rpb24gb25FcnJvcihlcnJvcikgewogICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRXJyb3JFdmVudCgnZXJyb3InLCB7CiAgICAgICAgICAgIGVycm9yLAogICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlCiAgICAgICAgICB9KTsKICAgICAgICAgIGV2ZW50W2tUYXJnZXRdID0gdGhpczsKICAgICAgICAgIGNhbGxMaXN0ZW5lcihoYW5kbGVyLCB0aGlzLCBldmVudCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnb3BlbicpIHsKICAgICAgICB3cmFwcGVyID0gZnVuY3Rpb24gb25PcGVuKCkgewogICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoJ29wZW4nKTsKICAgICAgICAgIGV2ZW50W2tUYXJnZXRdID0gdGhpczsKICAgICAgICAgIGNhbGxMaXN0ZW5lcihoYW5kbGVyLCB0aGlzLCBldmVudCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgd3JhcHBlcltrRm9yT25FdmVudEF0dHJpYnV0ZV0gPSAhIW9wdGlvbnNba0Zvck9uRXZlbnRBdHRyaWJ1dGVdOwogICAgICB3cmFwcGVyW2tMaXN0ZW5lcl0gPSBoYW5kbGVyOwogICAgICBpZiAob3B0aW9ucy5vbmNlKSB7CiAgICAgICAgdGhpcy5vbmNlKHR5cGUsIHdyYXBwZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub24odHlwZSwgd3JhcHBlcik7CiAgICAgIH0KICAgIH0sCiAgICAvKioKICAgICAqIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lci4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGV2ZW50IHR5cGUgdG8gcmVtb3ZlCiAgICAgKiBAcGFyYW0geyhGdW5jdGlvbnxPYmplY3QpfSBoYW5kbGVyIFRoZSBsaXN0ZW5lciB0byByZW1vdmUKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGVyKSB7CiAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy5saXN0ZW5lcnModHlwZSkpIHsKICAgICAgICBpZiAobGlzdGVuZXJba0xpc3RlbmVyXSA9PT0gaGFuZGxlciAmJiAhbGlzdGVuZXJba0Zvck9uRXZlbnRBdHRyaWJ1dGVdKSB7CiAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgZXZlbnRUYXJnZXQgPSB7CiAgICBDbG9zZUV2ZW50LAogICAgRXJyb3JFdmVudCwKICAgIEV2ZW50LAogICAgRXZlbnRUYXJnZXQsCiAgICBNZXNzYWdlRXZlbnQKICB9OwoKICAvKioKICAgKiBDYWxsIGFuIGV2ZW50IGxpc3RlbmVyCiAgICoKICAgKiBAcGFyYW0geyhGdW5jdGlvbnxPYmplY3QpfSBsaXN0ZW5lciBUaGUgbGlzdGVuZXIgdG8gY2FsbAogICAqIEBwYXJhbSB7Kn0gdGhpc0FyZyBUaGUgdmFsdWUgdG8gdXNlIGFzIGB0aGlzYGAgd2hlbiBjYWxsaW5nIHRoZSBsaXN0ZW5lcgogICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IFRoZSBldmVudCB0byBwYXNzIHRvIHRoZSBsaXN0ZW5lcgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY2FsbExpc3RlbmVyKGxpc3RlbmVyLCB0aGlzQXJnLCBldmVudCkgewogICAgaWYgKHR5cGVvZiBsaXN0ZW5lciA9PT0gJ29iamVjdCcgJiYgbGlzdGVuZXIuaGFuZGxlRXZlbnQpIHsKICAgICAgbGlzdGVuZXIuaGFuZGxlRXZlbnQuY2FsbChsaXN0ZW5lciwgZXZlbnQpOwogICAgfSBlbHNlIHsKICAgICAgbGlzdGVuZXIuY2FsbCh0aGlzQXJnLCBldmVudCk7CiAgICB9CiAgfQogIHJldHVybiBldmVudFRhcmdldDsKfQoKdmFyIGV4dGVuc2lvbjsKdmFyIGhhc1JlcXVpcmVkRXh0ZW5zaW9uOwpmdW5jdGlvbiByZXF1aXJlRXh0ZW5zaW9uKCkgewogIGlmIChoYXNSZXF1aXJlZEV4dGVuc2lvbikgcmV0dXJuIGV4dGVuc2lvbjsKICBoYXNSZXF1aXJlZEV4dGVuc2lvbiA9IDE7CiAgY29uc3QgewogICAgdG9rZW5DaGFycwogIH0gPSByZXF1aXJlVmFsaWRhdGlvbigpOwoKICAvKioKICAgKiBBZGRzIGFuIG9mZmVyIHRvIHRoZSBtYXAgb2YgZXh0ZW5zaW9uIG9mZmVycyBvciBhIHBhcmFtZXRlciB0byB0aGUgbWFwIG9mCiAgICogcGFyYW1ldGVycy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBkZXN0IFRoZSBtYXAgb2YgZXh0ZW5zaW9uIG9mZmVycyBvciBwYXJhbWV0ZXJzCiAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIGV4dGVuc2lvbiBvciBwYXJhbWV0ZXIgbmFtZQogICAqIEBwYXJhbSB7KE9iamVjdHxCb29sZWFufFN0cmluZyl9IGVsZW0gVGhlIGV4dGVuc2lvbiBwYXJhbWV0ZXJzIG9yIHRoZQogICAqICAgICBwYXJhbWV0ZXIgdmFsdWUKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHB1c2goZGVzdCwgbmFtZSwgZWxlbSkgewogICAgaWYgKGRlc3RbbmFtZV0gPT09IHVuZGVmaW5lZCkgZGVzdFtuYW1lXSA9IFtlbGVtXTtlbHNlIGRlc3RbbmFtZV0ucHVzaChlbGVtKTsKICB9CgogIC8qKgogICAqIFBhcnNlcyB0aGUgYFNlYy1XZWJTb2NrZXQtRXh0ZW5zaW9uc2AgaGVhZGVyIGludG8gYW4gb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IGhlYWRlciBUaGUgZmllbGQgdmFsdWUgb2YgdGhlIGhlYWRlcgogICAqIEByZXR1cm4ge09iamVjdH0gVGhlIHBhcnNlZCBvYmplY3QKICAgKiBAcHVibGljCiAgICovCiAgZnVuY3Rpb24gcGFyc2UoaGVhZGVyKSB7CiAgICBjb25zdCBvZmZlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgbGV0IHBhcmFtcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBsZXQgbXVzdFVuZXNjYXBlID0gZmFsc2U7CiAgICBsZXQgaXNFc2NhcGluZyA9IGZhbHNlOwogICAgbGV0IGluUXVvdGVzID0gZmFsc2U7CiAgICBsZXQgZXh0ZW5zaW9uTmFtZTsKICAgIGxldCBwYXJhbU5hbWU7CiAgICBsZXQgc3RhcnQgPSAtMTsKICAgIGxldCBjb2RlID0gLTE7CiAgICBsZXQgZW5kID0gLTE7CiAgICBsZXQgaSA9IDA7CiAgICBmb3IgKDsgaSA8IGhlYWRlci5sZW5ndGg7IGkrKykgewogICAgICBjb2RlID0gaGVhZGVyLmNoYXJDb2RlQXQoaSk7CiAgICAgIGlmIChleHRlbnNpb25OYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoZW5kID09PSAtMSAmJiB0b2tlbkNoYXJzW2NvZGVdID09PSAxKSB7CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xKSBzdGFydCA9IGk7CiAgICAgICAgfSBlbHNlIGlmIChpICE9PSAwICYmIChjb2RlID09PSAweDIwIC8qICcgJyAqLyB8fCBjb2RlID09PSAweDA5KSAvKiAnXHQnICovKSB7CiAgICAgICAgICBpZiAoZW5kID09PSAtMSAmJiBzdGFydCAhPT0gLTEpIGVuZCA9IGk7CiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSAweDNiIC8qICc7JyAqLyB8fCBjb2RlID09PSAweDJjIC8qICcsJyAqLykgewogICAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbmQgPT09IC0xKSBlbmQgPSBpOwogICAgICAgICAgY29uc3QgbmFtZSA9IGhlYWRlci5zbGljZShzdGFydCwgZW5kKTsKICAgICAgICAgIGlmIChjb2RlID09PSAweDJjKSB7CiAgICAgICAgICAgIHB1c2gob2ZmZXJzLCBuYW1lLCBwYXJhbXMpOwogICAgICAgICAgICBwYXJhbXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0ZW5zaW9uTmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBzdGFydCA9IGVuZCA9IC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocGFyYW1OYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoZW5kID09PSAtMSAmJiB0b2tlbkNoYXJzW2NvZGVdID09PSAxKSB7CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xKSBzdGFydCA9IGk7CiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSAweDIwIHx8IGNvZGUgPT09IDB4MDkpIHsKICAgICAgICAgIGlmIChlbmQgPT09IC0xICYmIHN0YXJ0ICE9PSAtMSkgZW5kID0gaTsKICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPT09IDB4M2IgfHwgY29kZSA9PT0gMHgyYykgewogICAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbmQgPT09IC0xKSBlbmQgPSBpOwogICAgICAgICAgcHVzaChwYXJhbXMsIGhlYWRlci5zbGljZShzdGFydCwgZW5kKSwgdHJ1ZSk7CiAgICAgICAgICBpZiAoY29kZSA9PT0gMHgyYykgewogICAgICAgICAgICBwdXNoKG9mZmVycywgZXh0ZW5zaW9uTmFtZSwgcGFyYW1zKTsKICAgICAgICAgICAgcGFyYW1zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgZXh0ZW5zaW9uTmFtZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXJ0ID0gZW5kID0gLTE7CiAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSAweDNkIC8qICc9JyAqLyAmJiBzdGFydCAhPT0gLTEgJiYgZW5kID09PSAtMSkgewogICAgICAgICAgcGFyYW1OYW1lID0gaGVhZGVyLnNsaWNlKHN0YXJ0LCBpKTsKICAgICAgICAgIHN0YXJ0ID0gZW5kID0gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgVW5leHBlY3RlZCBjaGFyYWN0ZXIgYXQgaW5kZXggJHtpfWApOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLwogICAgICAgIC8vIFRoZSB2YWx1ZSBvZiBhIHF1b3RlZC1zdHJpbmcgYWZ0ZXIgdW5lc2NhcGluZyBtdXN0IGNvbmZvcm0gdG8gdGhlCiAgICAgICAgLy8gdG9rZW4gQUJORiwgc28gb25seSB0b2tlbiBjaGFyYWN0ZXJzIGFyZSB2YWxpZC4KICAgICAgICAvLyBSZWY6IGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmM2NDU1I3NlY3Rpb24tOS4xCiAgICAgICAgLy8KICAgICAgICBpZiAoaXNFc2NhcGluZykgewogICAgICAgICAgaWYgKHRva2VuQ2hhcnNbY29kZV0gIT09IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBVbmV4cGVjdGVkIGNoYXJhY3RlciBhdCBpbmRleCAke2l9YCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xKSBzdGFydCA9IGk7ZWxzZSBpZiAoIW11c3RVbmVzY2FwZSkgbXVzdFVuZXNjYXBlID0gdHJ1ZTsKICAgICAgICAgIGlzRXNjYXBpbmcgPSBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKGluUXVvdGVzKSB7CiAgICAgICAgICBpZiAodG9rZW5DaGFyc1tjb2RlXSA9PT0gMSkgewogICAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xKSBzdGFydCA9IGk7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPT09IDB4MjIgLyogJyInICovICYmIHN0YXJ0ICE9PSAtMSkgewogICAgICAgICAgICBpblF1b3RlcyA9IGZhbHNlOwogICAgICAgICAgICBlbmQgPSBpOwogICAgICAgICAgfSBlbHNlIGlmIChjb2RlID09PSAweDVjIC8qICdcJyAqLykgewogICAgICAgICAgICBpc0VzY2FwaW5nID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgVW5leHBlY3RlZCBjaGFyYWN0ZXIgYXQgaW5kZXggJHtpfWApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gMHgyMiAmJiBoZWFkZXIuY2hhckNvZGVBdChpIC0gMSkgPT09IDB4M2QpIHsKICAgICAgICAgIGluUXVvdGVzID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGVuZCA9PT0gLTEgJiYgdG9rZW5DaGFyc1tjb2RlXSA9PT0gMSkgewogICAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgc3RhcnQgPSBpOwogICAgICAgIH0gZWxzZSBpZiAoc3RhcnQgIT09IC0xICYmIChjb2RlID09PSAweDIwIHx8IGNvZGUgPT09IDB4MDkpKSB7CiAgICAgICAgICBpZiAoZW5kID09PSAtMSkgZW5kID0gaTsKICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPT09IDB4M2IgfHwgY29kZSA9PT0gMHgyYykgewogICAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlbmQgPT09IC0xKSBlbmQgPSBpOwogICAgICAgICAgbGV0IHZhbHVlID0gaGVhZGVyLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICAgICAgaWYgKG11c3RVbmVzY2FwZSkgewogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL1xcL2csICcnKTsKICAgICAgICAgICAgbXVzdFVuZXNjYXBlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoKHBhcmFtcywgcGFyYW1OYW1lLCB2YWx1ZSk7CiAgICAgICAgICBpZiAoY29kZSA9PT0gMHgyYykgewogICAgICAgICAgICBwdXNoKG9mZmVycywgZXh0ZW5zaW9uTmFtZSwgcGFyYW1zKTsKICAgICAgICAgICAgcGFyYW1zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICAgICAgZXh0ZW5zaW9uTmFtZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmFtTmFtZSA9IHVuZGVmaW5lZDsKICAgICAgICAgIHN0YXJ0ID0gZW5kID0gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgVW5leHBlY3RlZCBjaGFyYWN0ZXIgYXQgaW5kZXggJHtpfWApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHN0YXJ0ID09PSAtMSB8fCBpblF1b3RlcyB8fCBjb2RlID09PSAweDIwIHx8IGNvZGUgPT09IDB4MDkpIHsKICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdVbmV4cGVjdGVkIGVuZCBvZiBpbnB1dCcpOwogICAgfQogICAgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IGk7CiAgICBjb25zdCB0b2tlbiA9IGhlYWRlci5zbGljZShzdGFydCwgZW5kKTsKICAgIGlmIChleHRlbnNpb25OYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgcHVzaChvZmZlcnMsIHRva2VuLCBwYXJhbXMpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHBhcmFtTmFtZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcHVzaChwYXJhbXMsIHRva2VuLCB0cnVlKTsKICAgICAgfSBlbHNlIGlmIChtdXN0VW5lc2NhcGUpIHsKICAgICAgICBwdXNoKHBhcmFtcywgcGFyYW1OYW1lLCB0b2tlbi5yZXBsYWNlKC9cXC9nLCAnJykpOwogICAgICB9IGVsc2UgewogICAgICAgIHB1c2gocGFyYW1zLCBwYXJhbU5hbWUsIHRva2VuKTsKICAgICAgfQogICAgICBwdXNoKG9mZmVycywgZXh0ZW5zaW9uTmFtZSwgcGFyYW1zKTsKICAgIH0KICAgIHJldHVybiBvZmZlcnM7CiAgfQoKICAvKioKICAgKiBCdWlsZHMgdGhlIGBTZWMtV2ViU29ja2V0LUV4dGVuc2lvbnNgIGhlYWRlciBmaWVsZCB2YWx1ZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBleHRlbnNpb25zIFRoZSBtYXAgb2YgZXh0ZW5zaW9ucyBhbmQgcGFyYW1ldGVycyB0byBmb3JtYXQKICAgKiBAcmV0dXJuIHtTdHJpbmd9IEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgZ2l2ZW4gb2JqZWN0CiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIGZvcm1hdChleHRlbnNpb25zKSB7CiAgICByZXR1cm4gT2JqZWN0LmtleXMoZXh0ZW5zaW9ucykubWFwKGV4dGVuc2lvbiA9PiB7CiAgICAgIGxldCBjb25maWd1cmF0aW9ucyA9IGV4dGVuc2lvbnNbZXh0ZW5zaW9uXTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbmZpZ3VyYXRpb25zKSkgY29uZmlndXJhdGlvbnMgPSBbY29uZmlndXJhdGlvbnNdOwogICAgICByZXR1cm4gY29uZmlndXJhdGlvbnMubWFwKHBhcmFtcyA9PiB7CiAgICAgICAgcmV0dXJuIFtleHRlbnNpb25dLmNvbmNhdChPYmplY3Qua2V5cyhwYXJhbXMpLm1hcChrID0+IHsKICAgICAgICAgIGxldCB2YWx1ZXMgPSBwYXJhbXNba107CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWVzKSkgdmFsdWVzID0gW3ZhbHVlc107CiAgICAgICAgICByZXR1cm4gdmFsdWVzLm1hcCh2ID0+IHYgPT09IHRydWUgPyBrIDogYCR7a309JHt2fWApLmpvaW4oJzsgJyk7CiAgICAgICAgfSkpLmpvaW4oJzsgJyk7CiAgICAgIH0pLmpvaW4oJywgJyk7CiAgICB9KS5qb2luKCcsICcpOwogIH0KICBleHRlbnNpb24gPSB7CiAgICBmb3JtYXQsCiAgICBwYXJzZQogIH07CiAgcmV0dXJuIGV4dGVuc2lvbjsKfQoKZnVuY3Rpb24gb3duS2V5cyQyKGUsIHIpIHsgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOyByICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcikuZW51bWVyYWJsZTsgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7IH0gcmV0dXJuIHQ7IH0KZnVuY3Rpb24gX29iamVjdFNwcmVhZCQyKGUpIHsgZm9yICh2YXIgciA9IDE7IHIgPCBhcmd1bWVudHMubGVuZ3RoOyByKyspIHsgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyXSA/IGFyZ3VtZW50c1tyXSA6IHt9OyByICUgMiA/IG93bktleXMkMihPYmplY3QodCksICEwKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IF9kZWZpbmVQcm9wZXJ0eShlLCByLCB0W3JdKTsgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMkMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcikpOyB9KTsgfSByZXR1cm4gZTsgfQp2YXIgd2Vic29ja2V0Owp2YXIgaGFzUmVxdWlyZWRXZWJzb2NrZXQ7CmZ1bmN0aW9uIHJlcXVpcmVXZWJzb2NrZXQoKSB7CiAgaWYgKGhhc1JlcXVpcmVkV2Vic29ja2V0KSByZXR1cm4gd2Vic29ja2V0OwogIGhhc1JlcXVpcmVkV2Vic29ja2V0ID0gMTsKICBjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlJCQwJDI7CiAgY29uc3QgaHR0cHMgPSByZXF1aXJlJCQxJDM7CiAgY29uc3QgaHR0cCA9IHJlcXVpcmUkJDI7CiAgY29uc3QgbmV0ID0gcmVxdWlyZSQkMSQ0OwogIGNvbnN0IHRscyA9IHJlcXVpcmUkJDQ7CiAgY29uc3QgewogICAgcmFuZG9tQnl0ZXMsCiAgICBjcmVhdGVIYXNoCiAgfSA9IHJlcXVpcmUkJDEkMjsKICBjb25zdCB7CiAgICBVUkwKICB9ID0gcmVxdWlyZSQkNzsKICBjb25zdCBQZXJNZXNzYWdlRGVmbGF0ZSA9IHJlcXVpcmVQZXJtZXNzYWdlRGVmbGF0ZSgpOwogIGNvbnN0IFJlY2VpdmVyID0gcmVxdWlyZVJlY2VpdmVyKCk7CiAgY29uc3QgU2VuZGVyID0gcmVxdWlyZVNlbmRlcigpOwogIGNvbnN0IHsKICAgIGlzQmxvYgogIH0gPSByZXF1aXJlVmFsaWRhdGlvbigpOwogIGNvbnN0IHsKICAgIEJJTkFSWV9UWVBFUywKICAgIEVNUFRZX0JVRkZFUiwKICAgIEdVSUQsCiAgICBrRm9yT25FdmVudEF0dHJpYnV0ZSwKICAgIGtMaXN0ZW5lciwKICAgIGtTdGF0dXNDb2RlLAogICAga1dlYlNvY2tldCwKICAgIE5PT1AKICB9ID0gcmVxdWlyZUNvbnN0YW50cyQzKCk7CiAgY29uc3QgewogICAgRXZlbnRUYXJnZXQ6IHsKICAgICAgYWRkRXZlbnRMaXN0ZW5lciwKICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcgogICAgfQogIH0gPSByZXF1aXJlRXZlbnRUYXJnZXQoKTsKICBjb25zdCB7CiAgICBmb3JtYXQsCiAgICBwYXJzZQogIH0gPSByZXF1aXJlRXh0ZW5zaW9uKCk7CiAgY29uc3QgewogICAgdG9CdWZmZXIKICB9ID0gcmVxdWlyZUJ1ZmZlclV0aWwoKTsKICBjb25zdCBjbG9zZVRpbWVvdXQgPSAzMCAqIDEwMDA7CiAgY29uc3Qga0Fib3J0ZWQgPSBTeW1ib2woJ2tBYm9ydGVkJyk7CiAgY29uc3QgcHJvdG9jb2xWZXJzaW9ucyA9IFs4LCAxM107CiAgY29uc3QgcmVhZHlTdGF0ZXMgPSBbJ0NPTk5FQ1RJTkcnLCAnT1BFTicsICdDTE9TSU5HJywgJ0NMT1NFRCddOwogIGNvbnN0IHN1YnByb3RvY29sUmVnZXggPSAvXlshIyQlJicqK1wtLjAtOUEtWl5fYHxhLXp+XSskLzsKCiAgLyoqCiAgICogQ2xhc3MgcmVwcmVzZW50aW5nIGEgV2ViU29ja2V0LgogICAqCiAgICogQGV4dGVuZHMgRXZlbnRFbWl0dGVyCiAgICovCiAgY2xhc3MgV2ViU29ja2V0IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGBXZWJTb2NrZXRgLgogICAgICoKICAgICAqIEBwYXJhbSB7KFN0cmluZ3xVUkwpfSBhZGRyZXNzIFRoZSBVUkwgdG8gd2hpY2ggdG8gY29ubmVjdAogICAgICogQHBhcmFtIHsoU3RyaW5nfFN0cmluZ1tdKX0gW3Byb3RvY29sc10gVGhlIHN1YnByb3RvY29scwogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBDb25uZWN0aW9uIG9wdGlvbnMKICAgICAqLwogICAgY29uc3RydWN0b3IoYWRkcmVzcywgcHJvdG9jb2xzLCBvcHRpb25zKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuX2JpbmFyeVR5cGUgPSBCSU5BUllfVFlQRVNbMF07CiAgICAgIHRoaXMuX2Nsb3NlQ29kZSA9IDEwMDY7CiAgICAgIHRoaXMuX2Nsb3NlRnJhbWVSZWNlaXZlZCA9IGZhbHNlOwogICAgICB0aGlzLl9jbG9zZUZyYW1lU2VudCA9IGZhbHNlOwogICAgICB0aGlzLl9jbG9zZU1lc3NhZ2UgPSBFTVBUWV9CVUZGRVI7CiAgICAgIHRoaXMuX2Nsb3NlVGltZXIgPSBudWxsOwogICAgICB0aGlzLl9lcnJvckVtaXR0ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fZXh0ZW5zaW9ucyA9IHt9OwogICAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZTsKICAgICAgdGhpcy5fcHJvdG9jb2wgPSAnJzsKICAgICAgdGhpcy5fcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DT05ORUNUSU5HOwogICAgICB0aGlzLl9yZWNlaXZlciA9IG51bGw7CiAgICAgIHRoaXMuX3NlbmRlciA9IG51bGw7CiAgICAgIHRoaXMuX3NvY2tldCA9IG51bGw7CiAgICAgIGlmIChhZGRyZXNzICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5fYnVmZmVyZWRBbW91bnQgPSAwOwogICAgICAgIHRoaXMuX2lzU2VydmVyID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcmVkaXJlY3RzID0gMDsKICAgICAgICBpZiAocHJvdG9jb2xzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHByb3RvY29scyA9IFtdOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocHJvdG9jb2xzKSkgewogICAgICAgICAgaWYgKHR5cGVvZiBwcm90b2NvbHMgPT09ICdvYmplY3QnICYmIHByb3RvY29scyAhPT0gbnVsbCkgewogICAgICAgICAgICBvcHRpb25zID0gcHJvdG9jb2xzOwogICAgICAgICAgICBwcm90b2NvbHMgPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByb3RvY29scyA9IFtwcm90b2NvbHNdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbml0QXNDbGllbnQodGhpcywgYWRkcmVzcywgcHJvdG9jb2xzLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9hdXRvUG9uZyA9IG9wdGlvbnMuYXV0b1Bvbmc7CiAgICAgICAgdGhpcy5faXNTZXJ2ZXIgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBGb3IgaGlzdG9yaWNhbCByZWFzb25zLCB0aGUgY3VzdG9tICJub2RlYnVmZmVyIiB0eXBlIGlzIHVzZWQgYnkgdGhlIGRlZmF1bHQKICAgICAqIGluc3RlYWQgb2YgImJsb2IiLgogICAgICoKICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldCBiaW5hcnlUeXBlKCkgewogICAgICByZXR1cm4gdGhpcy5fYmluYXJ5VHlwZTsKICAgIH0KICAgIHNldCBiaW5hcnlUeXBlKHR5cGUpIHsKICAgICAgaWYgKCFCSU5BUllfVFlQRVMuaW5jbHVkZXModHlwZSkpIHJldHVybjsKICAgICAgdGhpcy5fYmluYXJ5VHlwZSA9IHR5cGU7CgogICAgICAvLwogICAgICAvLyBBbGxvdyB0byBjaGFuZ2UgYGJpbmFyeVR5cGVgIG9uIHRoZSBmbHkuCiAgICAgIC8vCiAgICAgIGlmICh0aGlzLl9yZWNlaXZlcikgdGhpcy5fcmVjZWl2ZXIuX2JpbmFyeVR5cGUgPSB0eXBlOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge051bWJlcn0KICAgICAqLwogICAgZ2V0IGJ1ZmZlcmVkQW1vdW50KCkgewogICAgICBpZiAoIXRoaXMuX3NvY2tldCkgcmV0dXJuIHRoaXMuX2J1ZmZlcmVkQW1vdW50OwogICAgICByZXR1cm4gdGhpcy5fc29ja2V0Ll93cml0YWJsZVN0YXRlLmxlbmd0aCArIHRoaXMuX3NlbmRlci5fYnVmZmVyZWRCeXRlczsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldCBleHRlbnNpb25zKCkgewogICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fZXh0ZW5zaW9ucykuam9pbigpOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIGdldCBpc1BhdXNlZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhdXNlZDsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAqLwogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIGdldCBvbmNsb3NlKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAqLwogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIGdldCBvbmVycm9yKCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtGdW5jdGlvbn0KICAgICAqLwogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIGdldCBvbm9wZW4oKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQHR5cGUge0Z1bmN0aW9ufQogICAgICovCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgZ2V0IG9ubWVzc2FnZSgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICovCiAgICBnZXQgcHJvdG9jb2woKSB7CiAgICAgIHJldHVybiB0aGlzLl9wcm90b2NvbDsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtOdW1iZXJ9CiAgICAgKi8KICAgIGdldCByZWFkeVN0YXRlKCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZHlTdGF0ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldCB1cmwoKSB7CiAgICAgIHJldHVybiB0aGlzLl91cmw7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXQgdXAgdGhlIHNvY2tldCBhbmQgdGhlIGludGVybmFsIHJlc291cmNlcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge0R1cGxleH0gc29ja2V0IFRoZSBuZXR3b3JrIHNvY2tldCBiZXR3ZWVuIHRoZSBzZXJ2ZXIgYW5kIGNsaWVudAogICAgICogQHBhcmFtIHtCdWZmZXJ9IGhlYWQgVGhlIGZpcnN0IHBhY2tldCBvZiB0aGUgdXBncmFkZWQgc3RyZWFtCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBPcHRpb25zIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5hbGxvd1N5bmNocm9ub3VzRXZlbnRzPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlcgogICAgICogICAgIGFueSBvZiB0aGUgYCdtZXNzYWdlJ2AsIGAncGluZydgLCBhbmQgYCdwb25nJ2AgZXZlbnRzIGNhbiBiZSBlbWl0dGVkCiAgICAgKiAgICAgbXVsdGlwbGUgdGltZXMgaW4gdGhlIHNhbWUgdGljawogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuZ2VuZXJhdGVNYXNrXSBUaGUgZnVuY3Rpb24gdXNlZCB0byBnZW5lcmF0ZSB0aGUKICAgICAqICAgICBtYXNraW5nIGtleQogICAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLm1heFBheWxvYWQ9MF0gVGhlIG1heGltdW0gYWxsb3dlZCBtZXNzYWdlIHNpemUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvcgogICAgICogICAgIG5vdCB0byBza2lwIFVURi04IHZhbGlkYXRpb24gZm9yIHRleHQgYW5kIGNsb3NlIG1lc3NhZ2VzCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBzZXRTb2NrZXQoc29ja2V0LCBoZWFkLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IHJlY2VpdmVyID0gbmV3IFJlY2VpdmVyKHsKICAgICAgICBhbGxvd1N5bmNocm9ub3VzRXZlbnRzOiBvcHRpb25zLmFsbG93U3luY2hyb25vdXNFdmVudHMsCiAgICAgICAgYmluYXJ5VHlwZTogdGhpcy5iaW5hcnlUeXBlLAogICAgICAgIGV4dGVuc2lvbnM6IHRoaXMuX2V4dGVuc2lvbnMsCiAgICAgICAgaXNTZXJ2ZXI6IHRoaXMuX2lzU2VydmVyLAogICAgICAgIG1heFBheWxvYWQ6IG9wdGlvbnMubWF4UGF5bG9hZCwKICAgICAgICBza2lwVVRGOFZhbGlkYXRpb246IG9wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uCiAgICAgIH0pOwogICAgICBjb25zdCBzZW5kZXIgPSBuZXcgU2VuZGVyKHNvY2tldCwgdGhpcy5fZXh0ZW5zaW9ucywgb3B0aW9ucy5nZW5lcmF0ZU1hc2spOwogICAgICB0aGlzLl9yZWNlaXZlciA9IHJlY2VpdmVyOwogICAgICB0aGlzLl9zZW5kZXIgPSBzZW5kZXI7CiAgICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDsKICAgICAgcmVjZWl2ZXJba1dlYlNvY2tldF0gPSB0aGlzOwogICAgICBzZW5kZXJba1dlYlNvY2tldF0gPSB0aGlzOwogICAgICBzb2NrZXRba1dlYlNvY2tldF0gPSB0aGlzOwogICAgICByZWNlaXZlci5vbignY29uY2x1ZGUnLCByZWNlaXZlck9uQ29uY2x1ZGUpOwogICAgICByZWNlaXZlci5vbignZHJhaW4nLCByZWNlaXZlck9uRHJhaW4pOwogICAgICByZWNlaXZlci5vbignZXJyb3InLCByZWNlaXZlck9uRXJyb3IpOwogICAgICByZWNlaXZlci5vbignbWVzc2FnZScsIHJlY2VpdmVyT25NZXNzYWdlKTsKICAgICAgcmVjZWl2ZXIub24oJ3BpbmcnLCByZWNlaXZlck9uUGluZyk7CiAgICAgIHJlY2VpdmVyLm9uKCdwb25nJywgcmVjZWl2ZXJPblBvbmcpOwogICAgICBzZW5kZXIub25lcnJvciA9IHNlbmRlck9uRXJyb3I7CgogICAgICAvLwogICAgICAvLyBUaGVzZSBtZXRob2RzIG1heSBub3QgYmUgYXZhaWxhYmxlIGlmIGBzb2NrZXRgIGlzIGp1c3QgYSBgRHVwbGV4YC4KICAgICAgLy8KICAgICAgaWYgKHNvY2tldC5zZXRUaW1lb3V0KSBzb2NrZXQuc2V0VGltZW91dCgwKTsKICAgICAgaWYgKHNvY2tldC5zZXROb0RlbGF5KSBzb2NrZXQuc2V0Tm9EZWxheSgpOwogICAgICBpZiAoaGVhZC5sZW5ndGggPiAwKSBzb2NrZXQudW5zaGlmdChoZWFkKTsKICAgICAgc29ja2V0Lm9uKCdjbG9zZScsIHNvY2tldE9uQ2xvc2UpOwogICAgICBzb2NrZXQub24oJ2RhdGEnLCBzb2NrZXRPbkRhdGEpOwogICAgICBzb2NrZXQub24oJ2VuZCcsIHNvY2tldE9uRW5kKTsKICAgICAgc29ja2V0Lm9uKCdlcnJvcicsIHNvY2tldE9uRXJyb3IpOwogICAgICB0aGlzLl9yZWFkeVN0YXRlID0gV2ViU29ja2V0Lk9QRU47CiAgICAgIHRoaXMuZW1pdCgnb3BlbicpOwogICAgfQoKICAgIC8qKgogICAgICogRW1pdCB0aGUgYCdjbG9zZSdgIGV2ZW50LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIGVtaXRDbG9zZSgpIHsKICAgICAgaWYgKCF0aGlzLl9zb2NrZXQpIHsKICAgICAgICB0aGlzLl9yZWFkeVN0YXRlID0gV2ViU29ja2V0LkNMT1NFRDsKICAgICAgICB0aGlzLmVtaXQoJ2Nsb3NlJywgdGhpcy5fY2xvc2VDb2RlLCB0aGlzLl9jbG9zZU1lc3NhZ2UpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodGhpcy5fZXh0ZW5zaW9uc1tQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXSkgewogICAgICAgIHRoaXMuX2V4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV0uY2xlYW51cCgpOwogICAgICB9CiAgICAgIHRoaXMuX3JlY2VpdmVyLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICB0aGlzLl9yZWFkeVN0YXRlID0gV2ViU29ja2V0LkNMT1NFRDsKICAgICAgdGhpcy5lbWl0KCdjbG9zZScsIHRoaXMuX2Nsb3NlQ29kZSwgdGhpcy5fY2xvc2VNZXNzYWdlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0YXJ0IGEgY2xvc2luZyBoYW5kc2hha2UuCiAgICAgKgogICAgICogICAgICAgICAgKy0tLS0tLS0tLS0rICAgKy0tLS0tLS0tLS0tKyAgICstLS0tLS0tLS0tKwogICAgICogICAgIC0gLSAtfHdzLmNsb3NlKCl8LS0+fGNsb3NlIGZyYW1lfC0tPnx3cy5jbG9zZSgpfC0gLSAtCiAgICAgKiAgICB8ICAgICArLS0tLS0tLS0tLSsgICArLS0tLS0tLS0tLS0rICAgKy0tLS0tLS0tLS0rICAgICB8CiAgICAgKiAgICAgICAgICArLS0tLS0tLS0tLSsgICArLS0tLS0tLS0tLS0rICAgICAgICAgfAogICAgICogQ0xPU0lORyAgfHdzLmNsb3NlKCl8PC0tfGNsb3NlIGZyYW1lfDwtLSstLS0tLSsgICAgICAgQ0xPU0lORwogICAgICogICAgICAgICAgKy0tLS0tLS0tLS0rICAgKy0tLS0tLS0tLS0tKyAgIHwKICAgICAqICAgIHwgICAgICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgICB8ICAgKy0tLSsgICAgICAgIHwKICAgICAqICAgICAgICAgICAgICAgICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rLS0+fGZpbnwgLSAtIC0gLQogICAgICogICAgfCAgICAgICAgICstLS0rICAgICAgICAgICAgICAgICAgICAgIHwgICArLS0tKwogICAgICogICAgIC0gLSAtIC0gLXxmaW58PC0tLS0tLS0tLS0tLS0tLS0tLS0tLSsKICAgICAqICAgICAgICAgICAgICArLS0tKwogICAgICoKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBbY29kZV0gU3RhdHVzIGNvZGUgZXhwbGFpbmluZyB3aHkgdGhlIGNvbm5lY3Rpb24gaXMgY2xvc2luZwogICAgICogQHBhcmFtIHsoU3RyaW5nfEJ1ZmZlcil9IFtkYXRhXSBUaGUgcmVhc29uIHdoeSB0aGUgY29ubmVjdGlvbiBpcwogICAgICogICAgIGNsb3NpbmcKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgY2xvc2UoY29kZSwgZGF0YSkgewogICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSByZXR1cm47CiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5DT05ORUNUSU5HKSB7CiAgICAgICAgY29uc3QgbXNnID0gJ1dlYlNvY2tldCB3YXMgY2xvc2VkIGJlZm9yZSB0aGUgY29ubmVjdGlvbiB3YXMgZXN0YWJsaXNoZWQnOwogICAgICAgIGFib3J0SGFuZHNoYWtlKHRoaXMsIHRoaXMuX3JlcSwgbXNnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNMT1NJTkcpIHsKICAgICAgICBpZiAodGhpcy5fY2xvc2VGcmFtZVNlbnQgJiYgKHRoaXMuX2Nsb3NlRnJhbWVSZWNlaXZlZCB8fCB0aGlzLl9yZWNlaXZlci5fd3JpdGFibGVTdGF0ZS5lcnJvckVtaXR0ZWQpKSB7CiAgICAgICAgICB0aGlzLl9zb2NrZXQuZW5kKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9yZWFkeVN0YXRlID0gV2ViU29ja2V0LkNMT1NJTkc7CiAgICAgIHRoaXMuX3NlbmRlci5jbG9zZShjb2RlLCBkYXRhLCAhdGhpcy5faXNTZXJ2ZXIsIGVyciA9PiB7CiAgICAgICAgLy8KICAgICAgICAvLyBUaGlzIGVycm9yIGlzIGhhbmRsZWQgYnkgdGhlIGAnZXJyb3InYCBsaXN0ZW5lciBvbiB0aGUgc29ja2V0LiBXZSBvbmx5CiAgICAgICAgLy8gd2FudCB0byBrbm93IGlmIHRoZSBjbG9zZSBmcmFtZSBoYXMgYmVlbiBzZW50IGhlcmUuCiAgICAgICAgLy8KICAgICAgICBpZiAoZXJyKSByZXR1cm47CiAgICAgICAgdGhpcy5fY2xvc2VGcmFtZVNlbnQgPSB0cnVlOwogICAgICAgIGlmICh0aGlzLl9jbG9zZUZyYW1lUmVjZWl2ZWQgfHwgdGhpcy5fcmVjZWl2ZXIuX3dyaXRhYmxlU3RhdGUuZXJyb3JFbWl0dGVkKSB7CiAgICAgICAgICB0aGlzLl9zb2NrZXQuZW5kKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2V0Q2xvc2VUaW1lcih0aGlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIFBhdXNlIHRoZSBzb2NrZXQuCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICBwYXVzZSgpIHsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgdGhpcy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX3BhdXNlZCA9IHRydWU7CiAgICAgIHRoaXMuX3NvY2tldC5wYXVzZSgpOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBhIHBpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSBbZGF0YV0gVGhlIGRhdGEgdG8gc2VuZAogICAgICogQHBhcmFtIHtCb29sZWFufSBbbWFza10gSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHRvIG1hc2sgYGRhdGFgCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2JdIENhbGxiYWNrIHdoaWNoIGlzIGV4ZWN1dGVkIHdoZW4gdGhlIHBpbmcgaXMgc2VudAogICAgICogQHB1YmxpYwogICAgICovCiAgICBwaW5nKGRhdGEsIG1hc2ssIGNiKSB7CiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5DT05ORUNUSU5HKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXZWJTb2NrZXQgaXMgbm90IG9wZW46IHJlYWR5U3RhdGUgMCAoQ09OTkVDVElORyknKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYiA9IGRhdGE7CiAgICAgICAgZGF0YSA9IG1hc2sgPSB1bmRlZmluZWQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG1hc2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYiA9IG1hc2s7CiAgICAgICAgbWFzayA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdudW1iZXInKSBkYXRhID0gZGF0YS50b1N0cmluZygpOwogICAgICBpZiAodGhpcy5yZWFkeVN0YXRlICE9PSBXZWJTb2NrZXQuT1BFTikgewogICAgICAgIHNlbmRBZnRlckNsb3NlKHRoaXMsIGRhdGEsIGNiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG1hc2sgPT09IHVuZGVmaW5lZCkgbWFzayA9ICF0aGlzLl9pc1NlcnZlcjsKICAgICAgdGhpcy5fc2VuZGVyLnBpbmcoZGF0YSB8fCBFTVBUWV9CVUZGRVIsIG1hc2ssIGNiKTsKICAgIH0KCiAgICAvKioKICAgICAqIFNlbmQgYSBwb25nLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gW2RhdGFdIFRoZSBkYXRhIHRvIHNlbmQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW21hc2tdIEluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCB0byBtYXNrIGBkYXRhYAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NiXSBDYWxsYmFjayB3aGljaCBpcyBleGVjdXRlZCB3aGVuIHRoZSBwb25nIGlzIHNlbnQKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgcG9uZyhkYXRhLCBtYXNrLCBjYikgewogICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ09OTkVDVElORykgewogICAgICAgIHRocm93IG5ldyBFcnJvcignV2ViU29ja2V0IGlzIG5vdCBvcGVuOiByZWFkeVN0YXRlIDAgKENPTk5FQ1RJTkcpJyk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2IgPSBkYXRhOwogICAgICAgIGRhdGEgPSBtYXNrID0gdW5kZWZpbmVkOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtYXNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2IgPSBtYXNrOwogICAgICAgIG1hc2sgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnbnVtYmVyJykgZGF0YSA9IGRhdGEudG9TdHJpbmcoKTsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICBzZW5kQWZ0ZXJDbG9zZSh0aGlzLCBkYXRhLCBjYik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChtYXNrID09PSB1bmRlZmluZWQpIG1hc2sgPSAhdGhpcy5faXNTZXJ2ZXI7CiAgICAgIHRoaXMuX3NlbmRlci5wb25nKGRhdGEgfHwgRU1QVFlfQlVGRkVSLCBtYXNrLCBjYik7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXN1bWUgdGhlIHNvY2tldC4KICAgICAqCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIHJlc3VtZSgpIHsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgdGhpcy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX3BhdXNlZCA9IGZhbHNlOwogICAgICBpZiAoIXRoaXMuX3JlY2VpdmVyLl93cml0YWJsZVN0YXRlLm5lZWREcmFpbikgdGhpcy5fc29ja2V0LnJlc3VtZSgpOwogICAgfQoKICAgIC8qKgogICAgICogU2VuZCBhIGRhdGEgbWVzc2FnZS4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IGRhdGEgVGhlIG1lc3NhZ2UgdG8gc2VuZAogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBPcHRpb25zIG9iamVjdAogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5iaW5hcnldIFNwZWNpZmllcyB3aGV0aGVyIGBkYXRhYCBpcyBiaW5hcnkgb3IKICAgICAqICAgICB0ZXh0CiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmNvbXByZXNzXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gY29tcHJlc3MKICAgICAqICAgICBgZGF0YWAKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZmluPXRydWVdIFNwZWNpZmllcyB3aGV0aGVyIHRoZSBmcmFnbWVudCBpcyB0aGUKICAgICAqICAgICBsYXN0IG9uZQogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5tYXNrXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8gbWFzayBgZGF0YWAKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYl0gQ2FsbGJhY2sgd2hpY2ggaXMgZXhlY3V0ZWQgd2hlbiBkYXRhIGlzIHdyaXR0ZW4gb3V0CiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIHNlbmQoZGF0YSwgb3B0aW9ucywgY2IpIHsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYlNvY2tldCBpcyBub3Qgb3BlbjogcmVhZHlTdGF0ZSAwIChDT05ORUNUSU5HKScpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNiID0gb3B0aW9uczsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnbnVtYmVyJykgZGF0YSA9IGRhdGEudG9TdHJpbmcoKTsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgICBzZW5kQWZ0ZXJDbG9zZSh0aGlzLCBkYXRhLCBjYik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IG9wdHMgPSBfb2JqZWN0U3ByZWFkJDIoewogICAgICAgIGJpbmFyeTogdHlwZW9mIGRhdGEgIT09ICdzdHJpbmcnLAogICAgICAgIG1hc2s6ICF0aGlzLl9pc1NlcnZlciwKICAgICAgICBjb21wcmVzczogdHJ1ZSwKICAgICAgICBmaW46IHRydWUKICAgICAgfSwgb3B0aW9ucyk7CiAgICAgIGlmICghdGhpcy5fZXh0ZW5zaW9uc1tQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXSkgewogICAgICAgIG9wdHMuY29tcHJlc3MgPSBmYWxzZTsKICAgICAgfQogICAgICB0aGlzLl9zZW5kZXIuc2VuZChkYXRhIHx8IEVNUFRZX0JVRkZFUiwgb3B0cywgY2IpOwogICAgfQoKICAgIC8qKgogICAgICogRm9yY2libHkgY2xvc2UgdGhlIGNvbm5lY3Rpb24uCiAgICAgKgogICAgICogQHB1YmxpYwogICAgICovCiAgICB0ZXJtaW5hdGUoKSB7CiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5DTE9TRUQpIHJldHVybjsKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcpIHsKICAgICAgICBjb25zdCBtc2cgPSAnV2ViU29ja2V0IHdhcyBjbG9zZWQgYmVmb3JlIHRoZSBjb25uZWN0aW9uIHdhcyBlc3RhYmxpc2hlZCc7CiAgICAgICAgYWJvcnRIYW5kc2hha2UodGhpcywgdGhpcy5fcmVxLCBtc2cpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodGhpcy5fc29ja2V0KSB7CiAgICAgICAgdGhpcy5fcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DTE9TSU5HOwogICAgICAgIHRoaXMuX3NvY2tldC5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIEBjb25zdGFudCB7TnVtYmVyfSBDT05ORUNUSU5HCiAgICogQG1lbWJlcm9mIFdlYlNvY2tldAogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQsICdDT05ORUNUSU5HJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIHZhbHVlOiByZWFkeVN0YXRlcy5pbmRleE9mKCdDT05ORUNUSU5HJykKICB9KTsKCiAgLyoqCiAgICogQGNvbnN0YW50IHtOdW1iZXJ9IENPTk5FQ1RJTkcKICAgKiBAbWVtYmVyb2YgV2ViU29ja2V0LnByb3RvdHlwZQogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQucHJvdG90eXBlLCAnQ09OTkVDVElORycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogcmVhZHlTdGF0ZXMuaW5kZXhPZignQ09OTkVDVElORycpCiAgfSk7CgogIC8qKgogICAqIEBjb25zdGFudCB7TnVtYmVyfSBPUEVOCiAgICogQG1lbWJlcm9mIFdlYlNvY2tldAogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQsICdPUEVOJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIHZhbHVlOiByZWFkeVN0YXRlcy5pbmRleE9mKCdPUEVOJykKICB9KTsKCiAgLyoqCiAgICogQGNvbnN0YW50IHtOdW1iZXJ9IE9QRU4KICAgKiBAbWVtYmVyb2YgV2ViU29ja2V0LnByb3RvdHlwZQogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQucHJvdG90eXBlLCAnT1BFTicsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogcmVhZHlTdGF0ZXMuaW5kZXhPZignT1BFTicpCiAgfSk7CgogIC8qKgogICAqIEBjb25zdGFudCB7TnVtYmVyfSBDTE9TSU5HCiAgICogQG1lbWJlcm9mIFdlYlNvY2tldAogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQsICdDTE9TSU5HJywgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIHZhbHVlOiByZWFkeVN0YXRlcy5pbmRleE9mKCdDTE9TSU5HJykKICB9KTsKCiAgLyoqCiAgICogQGNvbnN0YW50IHtOdW1iZXJ9IENMT1NJTkcKICAgKiBAbWVtYmVyb2YgV2ViU29ja2V0LnByb3RvdHlwZQogICAqLwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQucHJvdG90eXBlLCAnQ0xPU0lORycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogcmVhZHlTdGF0ZXMuaW5kZXhPZignQ0xPU0lORycpCiAgfSk7CgogIC8qKgogICAqIEBjb25zdGFudCB7TnVtYmVyfSBDTE9TRUQKICAgKiBAbWVtYmVyb2YgV2ViU29ja2V0CiAgICovCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFdlYlNvY2tldCwgJ0NMT1NFRCcsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICB2YWx1ZTogcmVhZHlTdGF0ZXMuaW5kZXhPZignQ0xPU0VEJykKICB9KTsKCiAgLyoqCiAgICogQGNvbnN0YW50IHtOdW1iZXJ9IENMT1NFRAogICAqIEBtZW1iZXJvZiBXZWJTb2NrZXQucHJvdG90eXBlCiAgICovCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFdlYlNvY2tldC5wcm90b3R5cGUsICdDTE9TRUQnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgdmFsdWU6IHJlYWR5U3RhdGVzLmluZGV4T2YoJ0NMT1NFRCcpCiAgfSk7CiAgWydiaW5hcnlUeXBlJywgJ2J1ZmZlcmVkQW1vdW50JywgJ2V4dGVuc2lvbnMnLCAnaXNQYXVzZWQnLCAncHJvdG9jb2wnLCAncmVhZHlTdGF0ZScsICd1cmwnXS5mb3JFYWNoKHByb3BlcnR5ID0+IHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShXZWJTb2NrZXQucHJvdG90eXBlLCBwcm9wZXJ0eSwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICB9KTsKICB9KTsKCiAgLy8KICAvLyBBZGQgdGhlIGBvbm9wZW5gLCBgb25lcnJvcmAsIGBvbmNsb3NlYCwgYW5kIGBvbm1lc3NhZ2VgIGF0dHJpYnV0ZXMuCiAgLy8gU2VlIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL2NvbW1zLmh0bWwjdGhlLXdlYnNvY2tldC1pbnRlcmZhY2UKICAvLwogIFsnb3BlbicsICdlcnJvcicsICdjbG9zZScsICdtZXNzYWdlJ10uZm9yRWFjaChtZXRob2QgPT4gewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFdlYlNvY2tldC5wcm90b3R5cGUsIGBvbiR7bWV0aG9kfWAsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0KCkgewogICAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy5saXN0ZW5lcnMobWV0aG9kKSkgewogICAgICAgICAgaWYgKGxpc3RlbmVyW2tGb3JPbkV2ZW50QXR0cmlidXRlXSkgcmV0dXJuIGxpc3RlbmVyW2tMaXN0ZW5lcl07CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICBzZXQoaGFuZGxlcikgewogICAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy5saXN0ZW5lcnMobWV0aG9kKSkgewogICAgICAgICAgaWYgKGxpc3RlbmVyW2tGb3JPbkV2ZW50QXR0cmlidXRlXSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKG1ldGhvZCwgbGlzdGVuZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKG1ldGhvZCwgaGFuZGxlciwgewogICAgICAgICAgW2tGb3JPbkV2ZW50QXR0cmlidXRlXTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9KTsKICBXZWJTb2NrZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBhZGRFdmVudExpc3RlbmVyOwogIFdlYlNvY2tldC5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHJlbW92ZUV2ZW50TGlzdGVuZXI7CiAgd2Vic29ja2V0ID0gV2ViU29ja2V0OwoKICAvKioKICAgKiBJbml0aWFsaXplIGEgV2ViU29ja2V0IGNsaWVudC4KICAgKgogICAqIEBwYXJhbSB7V2ViU29ja2V0fSB3ZWJzb2NrZXQgVGhlIGNsaWVudCB0byBpbml0aWFsaXplCiAgICogQHBhcmFtIHsoU3RyaW5nfFVSTCl9IGFkZHJlc3MgVGhlIFVSTCB0byB3aGljaCB0byBjb25uZWN0CiAgICogQHBhcmFtIHtBcnJheX0gcHJvdG9jb2xzIFRoZSBzdWJwcm90b2NvbHMKICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIENvbm5lY3Rpb24gb3B0aW9ucwogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuYWxsb3dTeW5jaHJvbm91c0V2ZW50cz10cnVlXSBTcGVjaWZpZXMgd2hldGhlciBhbnkKICAgKiAgICAgb2YgdGhlIGAnbWVzc2FnZSdgLCBgJ3BpbmcnYCwgYW5kIGAncG9uZydgIGV2ZW50cyBjYW4gYmUgZW1pdHRlZCBtdWx0aXBsZQogICAqICAgICB0aW1lcyBpbiB0aGUgc2FtZSB0aWNrCiAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5hdXRvUG9uZz10cnVlXSBTcGVjaWZpZXMgd2hldGhlciBvciBub3QgdG8KICAgKiAgICAgYXV0b21hdGljYWxseSBzZW5kIGEgcG9uZyBpbiByZXNwb25zZSB0byBhIHBpbmcKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb3B0aW9ucy5maW5pc2hSZXF1ZXN0XSBBIGZ1bmN0aW9uIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICogICAgIGN1c3RvbWl6ZSB0aGUgaGVhZGVycyBvZiBlYWNoIGh0dHAgcmVxdWVzdCBiZWZvcmUgaXQgaXMgc2VudAogICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZm9sbG93UmVkaXJlY3RzPWZhbHNlXSBXaGV0aGVyIG9yIG5vdCB0byBmb2xsb3cKICAgKiAgICAgcmVkaXJlY3RzCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuZ2VuZXJhdGVNYXNrXSBUaGUgZnVuY3Rpb24gdXNlZCB0byBnZW5lcmF0ZSB0aGUKICAgKiAgICAgbWFza2luZyBrZXkKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMuaGFuZHNoYWtlVGltZW91dF0gVGltZW91dCBpbiBtaWxsaXNlY29uZHMgZm9yIHRoZQogICAqICAgICBoYW5kc2hha2UgcmVxdWVzdAogICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5tYXhQYXlsb2FkPTEwNDg1NzYwMF0gVGhlIG1heGltdW0gYWxsb3dlZCBtZXNzYWdlCiAgICogICAgIHNpemUKICAgKiBAcGFyYW0ge051bWJlcn0gW29wdGlvbnMubWF4UmVkaXJlY3RzPTEwXSBUaGUgbWF4aW11bSBudW1iZXIgb2YgcmVkaXJlY3RzCiAgICogICAgIGFsbG93ZWQKICAgKiBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMub3JpZ2luXSBWYWx1ZSBvZiB0aGUgYE9yaWdpbmAgb3IKICAgKiAgICAgYFNlYy1XZWJTb2NrZXQtT3JpZ2luYCBoZWFkZXIKICAgKiBAcGFyYW0geyhCb29sZWFufE9iamVjdCl9IFtvcHRpb25zLnBlck1lc3NhZ2VEZWZsYXRlPXRydWVdIEVuYWJsZS9kaXNhYmxlCiAgICogICAgIHBlcm1lc3NhZ2UtZGVmbGF0ZQogICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5wcm90b2NvbFZlcnNpb249MTNdIFZhbHVlIG9mIHRoZQogICAqICAgICBgU2VjLVdlYlNvY2tldC1WZXJzaW9uYCBoZWFkZXIKICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnNraXBVVEY4VmFsaWRhdGlvbj1mYWxzZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3IKICAgKiAgICAgbm90IHRvIHNraXAgVVRGLTggdmFsaWRhdGlvbiBmb3IgdGV4dCBhbmQgY2xvc2UgbWVzc2FnZXMKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGluaXRBc0NsaWVudCh3ZWJzb2NrZXQsIGFkZHJlc3MsIHByb3RvY29scywgb3B0aW9ucykgewogICAgY29uc3Qgb3B0cyA9IF9vYmplY3RTcHJlYWQkMihfb2JqZWN0U3ByZWFkJDIoewogICAgICBhbGxvd1N5bmNocm9ub3VzRXZlbnRzOiB0cnVlLAogICAgICBhdXRvUG9uZzogdHJ1ZSwKICAgICAgcHJvdG9jb2xWZXJzaW9uOiBwcm90b2NvbFZlcnNpb25zWzFdLAogICAgICBtYXhQYXlsb2FkOiAxMDAgKiAxMDI0ICogMTAyNCwKICAgICAgc2tpcFVURjhWYWxpZGF0aW9uOiBmYWxzZSwKICAgICAgcGVyTWVzc2FnZURlZmxhdGU6IHRydWUsCiAgICAgIGZvbGxvd1JlZGlyZWN0czogZmFsc2UsCiAgICAgIG1heFJlZGlyZWN0czogMTAKICAgIH0sIG9wdGlvbnMpLCB7fSwgewogICAgICBzb2NrZXRQYXRoOiB1bmRlZmluZWQsCiAgICAgIGhvc3RuYW1lOiB1bmRlZmluZWQsCiAgICAgIHByb3RvY29sOiB1bmRlZmluZWQsCiAgICAgIHRpbWVvdXQ6IHVuZGVmaW5lZCwKICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgaG9zdDogdW5kZWZpbmVkLAogICAgICBwYXRoOiB1bmRlZmluZWQsCiAgICAgIHBvcnQ6IHVuZGVmaW5lZAogICAgfSk7CiAgICB3ZWJzb2NrZXQuX2F1dG9Qb25nID0gb3B0cy5hdXRvUG9uZzsKICAgIGlmICghcHJvdG9jb2xWZXJzaW9ucy5pbmNsdWRlcyhvcHRzLnByb3RvY29sVmVyc2lvbikpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoYFVuc3VwcG9ydGVkIHByb3RvY29sIHZlcnNpb246ICR7b3B0cy5wcm90b2NvbFZlcnNpb259IGAgKyBgKHN1cHBvcnRlZCB2ZXJzaW9uczogJHtwcm90b2NvbFZlcnNpb25zLmpvaW4oJywgJyl9KWApOwogICAgfQogICAgbGV0IHBhcnNlZFVybDsKICAgIGlmIChhZGRyZXNzIGluc3RhbmNlb2YgVVJMKSB7CiAgICAgIHBhcnNlZFVybCA9IGFkZHJlc3M7CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIHBhcnNlZFVybCA9IG5ldyBVUkwoYWRkcmVzcyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYEludmFsaWQgVVJMOiAke2FkZHJlc3N9YCk7CiAgICAgIH0KICAgIH0KICAgIGlmIChwYXJzZWRVcmwucHJvdG9jb2wgPT09ICdodHRwOicpIHsKICAgICAgcGFyc2VkVXJsLnByb3RvY29sID0gJ3dzOic7CiAgICB9IGVsc2UgaWYgKHBhcnNlZFVybC5wcm90b2NvbCA9PT0gJ2h0dHBzOicpIHsKICAgICAgcGFyc2VkVXJsLnByb3RvY29sID0gJ3dzczonOwogICAgfQogICAgd2Vic29ja2V0Ll91cmwgPSBwYXJzZWRVcmwuaHJlZjsKICAgIGNvbnN0IGlzU2VjdXJlID0gcGFyc2VkVXJsLnByb3RvY29sID09PSAnd3NzOic7CiAgICBjb25zdCBpc0lwY1VybCA9IHBhcnNlZFVybC5wcm90b2NvbCA9PT0gJ3dzK3VuaXg6JzsKICAgIGxldCBpbnZhbGlkVXJsTWVzc2FnZTsKICAgIGlmIChwYXJzZWRVcmwucHJvdG9jb2wgIT09ICd3czonICYmICFpc1NlY3VyZSAmJiAhaXNJcGNVcmwpIHsKICAgICAgaW52YWxpZFVybE1lc3NhZ2UgPSAnVGhlIFVSTFwncyBwcm90b2NvbCBtdXN0IGJlIG9uZSBvZiAid3M6IiwgIndzczoiLCAnICsgJyJodHRwOiIsICJodHRwcyIsIG9yICJ3cyt1bml4OiInOwogICAgfSBlbHNlIGlmIChpc0lwY1VybCAmJiAhcGFyc2VkVXJsLnBhdGhuYW1lKSB7CiAgICAgIGludmFsaWRVcmxNZXNzYWdlID0gIlRoZSBVUkwncyBwYXRobmFtZSBpcyBlbXB0eSI7CiAgICB9IGVsc2UgaWYgKHBhcnNlZFVybC5oYXNoKSB7CiAgICAgIGludmFsaWRVcmxNZXNzYWdlID0gJ1RoZSBVUkwgY29udGFpbnMgYSBmcmFnbWVudCBpZGVudGlmaWVyJzsKICAgIH0KICAgIGlmIChpbnZhbGlkVXJsTWVzc2FnZSkgewogICAgICBjb25zdCBlcnIgPSBuZXcgU3ludGF4RXJyb3IoaW52YWxpZFVybE1lc3NhZ2UpOwogICAgICBpZiAod2Vic29ja2V0Ll9yZWRpcmVjdHMgPT09IDApIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW1pdEVycm9yQW5kQ2xvc2Uod2Vic29ja2V0LCBlcnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgY29uc3QgZGVmYXVsdFBvcnQgPSBpc1NlY3VyZSA/IDQ0MyA6IDgwOwogICAgY29uc3Qga2V5ID0gcmFuZG9tQnl0ZXMoMTYpLnRvU3RyaW5nKCdiYXNlNjQnKTsKICAgIGNvbnN0IHJlcXVlc3QgPSBpc1NlY3VyZSA/IGh0dHBzLnJlcXVlc3QgOiBodHRwLnJlcXVlc3Q7CiAgICBjb25zdCBwcm90b2NvbFNldCA9IG5ldyBTZXQoKTsKICAgIGxldCBwZXJNZXNzYWdlRGVmbGF0ZTsKICAgIG9wdHMuY3JlYXRlQ29ubmVjdGlvbiA9IG9wdHMuY3JlYXRlQ29ubmVjdGlvbiB8fCAoaXNTZWN1cmUgPyB0bHNDb25uZWN0IDogbmV0Q29ubmVjdCk7CiAgICBvcHRzLmRlZmF1bHRQb3J0ID0gb3B0cy5kZWZhdWx0UG9ydCB8fCBkZWZhdWx0UG9ydDsKICAgIG9wdHMucG9ydCA9IHBhcnNlZFVybC5wb3J0IHx8IGRlZmF1bHRQb3J0OwogICAgb3B0cy5ob3N0ID0gcGFyc2VkVXJsLmhvc3RuYW1lLnN0YXJ0c1dpdGgoJ1snKSA/IHBhcnNlZFVybC5ob3N0bmFtZS5zbGljZSgxLCAtMSkgOiBwYXJzZWRVcmwuaG9zdG5hbWU7CiAgICBvcHRzLmhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkJDIoX29iamVjdFNwcmVhZCQyKHt9LCBvcHRzLmhlYWRlcnMpLCB7fSwgewogICAgICAnU2VjLVdlYlNvY2tldC1WZXJzaW9uJzogb3B0cy5wcm90b2NvbFZlcnNpb24sCiAgICAgICdTZWMtV2ViU29ja2V0LUtleSc6IGtleSwKICAgICAgQ29ubmVjdGlvbjogJ1VwZ3JhZGUnLAogICAgICBVcGdyYWRlOiAnd2Vic29ja2V0JwogICAgfSk7CiAgICBvcHRzLnBhdGggPSBwYXJzZWRVcmwucGF0aG5hbWUgKyBwYXJzZWRVcmwuc2VhcmNoOwogICAgb3B0cy50aW1lb3V0ID0gb3B0cy5oYW5kc2hha2VUaW1lb3V0OwogICAgaWYgKG9wdHMucGVyTWVzc2FnZURlZmxhdGUpIHsKICAgICAgcGVyTWVzc2FnZURlZmxhdGUgPSBuZXcgUGVyTWVzc2FnZURlZmxhdGUob3B0cy5wZXJNZXNzYWdlRGVmbGF0ZSAhPT0gdHJ1ZSA/IG9wdHMucGVyTWVzc2FnZURlZmxhdGUgOiB7fSwgZmFsc2UsIG9wdHMubWF4UGF5bG9hZCk7CiAgICAgIG9wdHMuaGVhZGVyc1snU2VjLVdlYlNvY2tldC1FeHRlbnNpb25zJ10gPSBmb3JtYXQoewogICAgICAgIFtQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXTogcGVyTWVzc2FnZURlZmxhdGUub2ZmZXIoKQogICAgICB9KTsKICAgIH0KICAgIGlmIChwcm90b2NvbHMubGVuZ3RoKSB7CiAgICAgIGZvciAoY29uc3QgcHJvdG9jb2wgb2YgcHJvdG9jb2xzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwcm90b2NvbCAhPT0gJ3N0cmluZycgfHwgIXN1YnByb3RvY29sUmVnZXgudGVzdChwcm90b2NvbCkgfHwgcHJvdG9jb2xTZXQuaGFzKHByb3RvY29sKSkgewogICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdBbiBpbnZhbGlkIG9yIGR1cGxpY2F0ZWQgc3VicHJvdG9jb2wgd2FzIHNwZWNpZmllZCcpOwogICAgICAgIH0KICAgICAgICBwcm90b2NvbFNldC5hZGQocHJvdG9jb2wpOwogICAgICB9CiAgICAgIG9wdHMuaGVhZGVyc1snU2VjLVdlYlNvY2tldC1Qcm90b2NvbCddID0gcHJvdG9jb2xzLmpvaW4oJywnKTsKICAgIH0KICAgIGlmIChvcHRzLm9yaWdpbikgewogICAgICBpZiAob3B0cy5wcm90b2NvbFZlcnNpb24gPCAxMykgewogICAgICAgIG9wdHMuaGVhZGVyc1snU2VjLVdlYlNvY2tldC1PcmlnaW4nXSA9IG9wdHMub3JpZ2luOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdHMuaGVhZGVycy5PcmlnaW4gPSBvcHRzLm9yaWdpbjsKICAgICAgfQogICAgfQogICAgaWYgKHBhcnNlZFVybC51c2VybmFtZSB8fCBwYXJzZWRVcmwucGFzc3dvcmQpIHsKICAgICAgb3B0cy5hdXRoID0gYCR7cGFyc2VkVXJsLnVzZXJuYW1lfToke3BhcnNlZFVybC5wYXNzd29yZH1gOwogICAgfQogICAgaWYgKGlzSXBjVXJsKSB7CiAgICAgIGNvbnN0IHBhcnRzID0gb3B0cy5wYXRoLnNwbGl0KCc6Jyk7CiAgICAgIG9wdHMuc29ja2V0UGF0aCA9IHBhcnRzWzBdOwogICAgICBvcHRzLnBhdGggPSBwYXJ0c1sxXTsKICAgIH0KICAgIGxldCByZXE7CiAgICBpZiAob3B0cy5mb2xsb3dSZWRpcmVjdHMpIHsKICAgICAgaWYgKHdlYnNvY2tldC5fcmVkaXJlY3RzID09PSAwKSB7CiAgICAgICAgd2Vic29ja2V0Ll9vcmlnaW5hbElwYyA9IGlzSXBjVXJsOwogICAgICAgIHdlYnNvY2tldC5fb3JpZ2luYWxTZWN1cmUgPSBpc1NlY3VyZTsKICAgICAgICB3ZWJzb2NrZXQuX29yaWdpbmFsSG9zdE9yU29ja2V0UGF0aCA9IGlzSXBjVXJsID8gb3B0cy5zb2NrZXRQYXRoIDogcGFyc2VkVXJsLmhvc3Q7CiAgICAgICAgY29uc3QgaGVhZGVycyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5oZWFkZXJzOwoKICAgICAgICAvLwogICAgICAgIC8vIFNoYWxsb3cgY29weSB0aGUgdXNlciBwcm92aWRlZCBvcHRpb25zIHNvIHRoYXQgaGVhZGVycyBjYW4gYmUgY2hhbmdlZAogICAgICAgIC8vIHdpdGhvdXQgbXV0YXRpbmcgdGhlIG9yaWdpbmFsIG9iamVjdC4KICAgICAgICAvLwogICAgICAgIG9wdGlvbnMgPSBfb2JqZWN0U3ByZWFkJDIoX29iamVjdFNwcmVhZCQyKHt9LCBvcHRpb25zKSwge30sIHsKICAgICAgICAgIGhlYWRlcnM6IHt9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhlYWRlcnMpIHsKICAgICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGhlYWRlcnMpKSB7CiAgICAgICAgICAgIG9wdGlvbnMuaGVhZGVyc1trZXkudG9Mb3dlckNhc2UoKV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAod2Vic29ja2V0Lmxpc3RlbmVyQ291bnQoJ3JlZGlyZWN0JykgPT09IDApIHsKICAgICAgICBjb25zdCBpc1NhbWVIb3N0ID0gaXNJcGNVcmwgPyB3ZWJzb2NrZXQuX29yaWdpbmFsSXBjID8gb3B0cy5zb2NrZXRQYXRoID09PSB3ZWJzb2NrZXQuX29yaWdpbmFsSG9zdE9yU29ja2V0UGF0aCA6IGZhbHNlIDogd2Vic29ja2V0Ll9vcmlnaW5hbElwYyA/IGZhbHNlIDogcGFyc2VkVXJsLmhvc3QgPT09IHdlYnNvY2tldC5fb3JpZ2luYWxIb3N0T3JTb2NrZXRQYXRoOwogICAgICAgIGlmICghaXNTYW1lSG9zdCB8fCB3ZWJzb2NrZXQuX29yaWdpbmFsU2VjdXJlICYmICFpc1NlY3VyZSkgewogICAgICAgICAgLy8KICAgICAgICAgIC8vIE1hdGNoIGN1cmwgNy43Ny4wIGJlaGF2aW9yIGFuZCBkcm9wIHRoZSBmb2xsb3dpbmcgaGVhZGVycy4gVGhlc2UKICAgICAgICAgIC8vIGhlYWRlcnMgYXJlIGFsc28gZHJvcHBlZCB3aGVuIGZvbGxvd2luZyBhIHJlZGlyZWN0IHRvIGEgc3ViZG9tYWluLgogICAgICAgICAgLy8KICAgICAgICAgIGRlbGV0ZSBvcHRzLmhlYWRlcnMuYXV0aG9yaXphdGlvbjsKICAgICAgICAgIGRlbGV0ZSBvcHRzLmhlYWRlcnMuY29va2llOwogICAgICAgICAgaWYgKCFpc1NhbWVIb3N0KSBkZWxldGUgb3B0cy5oZWFkZXJzLmhvc3Q7CiAgICAgICAgICBvcHRzLmF1dGggPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLwogICAgICAvLyBNYXRjaCBjdXJsIDcuNzcuMCBiZWhhdmlvciBhbmQgbWFrZSB0aGUgZmlyc3QgYEF1dGhvcml6YXRpb25gIGhlYWRlciB3aW4uCiAgICAgIC8vIElmIHRoZSBgQXV0aG9yaXphdGlvbmAgaGVhZGVyIGlzIHNldCwgdGhlbiB0aGVyZSBpcyBub3RoaW5nIHRvIGRvIGFzIGl0CiAgICAgIC8vIHdpbGwgdGFrZSBwcmVjZWRlbmNlLgogICAgICAvLwogICAgICBpZiAob3B0cy5hdXRoICYmICFvcHRpb25zLmhlYWRlcnMuYXV0aG9yaXphdGlvbikgewogICAgICAgIG9wdGlvbnMuaGVhZGVycy5hdXRob3JpemF0aW9uID0gJ0Jhc2ljICcgKyBCdWZmZXIuZnJvbShvcHRzLmF1dGgpLnRvU3RyaW5nKCdiYXNlNjQnKTsKICAgICAgfQogICAgICByZXEgPSB3ZWJzb2NrZXQuX3JlcSA9IHJlcXVlc3Qob3B0cyk7CiAgICAgIGlmICh3ZWJzb2NrZXQuX3JlZGlyZWN0cykgewogICAgICAgIC8vCiAgICAgICAgLy8gVW5saWtlIHdoYXQgaXMgZG9uZSBmb3IgdGhlIGAndXBncmFkZSdgIGV2ZW50LCBubyBlYXJseSBleGl0IGlzCiAgICAgICAgLy8gdHJpZ2dlcmVkIGhlcmUgaWYgdGhlIHVzZXIgY2FsbHMgYHdlYnNvY2tldC5jbG9zZSgpYCBvcgogICAgICAgIC8vIGB3ZWJzb2NrZXQudGVybWluYXRlKClgIGZyb20gYSBsaXN0ZW5lciBvZiB0aGUgYCdyZWRpcmVjdCdgIGV2ZW50LiBUaGlzCiAgICAgICAgLy8gaXMgYmVjYXVzZSB0aGUgdXNlciBjYW4gYWxzbyBjYWxsIGByZXF1ZXN0LmRlc3Ryb3koKWAgd2l0aCBhbiBlcnJvcgogICAgICAgIC8vIGJlZm9yZSBjYWxsaW5nIGB3ZWJzb2NrZXQuY2xvc2UoKWAgb3IgYHdlYnNvY2tldC50ZXJtaW5hdGUoKWAgYW5kIHRoaXMKICAgICAgICAvLyB3b3VsZCByZXN1bHQgaW4gYW4gZXJyb3IgYmVpbmcgZW1pdHRlZCBvbiB0aGUgYHJlcXVlc3RgIG9iamVjdCB3aXRoIG5vCiAgICAgICAgLy8gYCdlcnJvcidgIGV2ZW50IGxpc3RlbmVycyBhdHRhY2hlZC4KICAgICAgICAvLwogICAgICAgIHdlYnNvY2tldC5lbWl0KCdyZWRpcmVjdCcsIHdlYnNvY2tldC51cmwsIHJlcSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlcSA9IHdlYnNvY2tldC5fcmVxID0gcmVxdWVzdChvcHRzKTsKICAgIH0KICAgIGlmIChvcHRzLnRpbWVvdXQpIHsKICAgICAgcmVxLm9uKCd0aW1lb3V0JywgKCkgPT4gewogICAgICAgIGFib3J0SGFuZHNoYWtlKHdlYnNvY2tldCwgcmVxLCAnT3BlbmluZyBoYW5kc2hha2UgaGFzIHRpbWVkIG91dCcpOwogICAgICB9KTsKICAgIH0KICAgIHJlcS5vbignZXJyb3InLCBlcnIgPT4gewogICAgICBpZiAocmVxID09PSBudWxsIHx8IHJlcVtrQWJvcnRlZF0pIHJldHVybjsKICAgICAgcmVxID0gd2Vic29ja2V0Ll9yZXEgPSBudWxsOwogICAgICBlbWl0RXJyb3JBbmRDbG9zZSh3ZWJzb2NrZXQsIGVycik7CiAgICB9KTsKICAgIHJlcS5vbigncmVzcG9uc2UnLCByZXMgPT4gewogICAgICBjb25zdCBsb2NhdGlvbiA9IHJlcy5oZWFkZXJzLmxvY2F0aW9uOwogICAgICBjb25zdCBzdGF0dXNDb2RlID0gcmVzLnN0YXR1c0NvZGU7CiAgICAgIGlmIChsb2NhdGlvbiAmJiBvcHRzLmZvbGxvd1JlZGlyZWN0cyAmJiBzdGF0dXNDb2RlID49IDMwMCAmJiBzdGF0dXNDb2RlIDwgNDAwKSB7CiAgICAgICAgaWYgKCsrd2Vic29ja2V0Ll9yZWRpcmVjdHMgPiBvcHRzLm1heFJlZGlyZWN0cykgewogICAgICAgICAgYWJvcnRIYW5kc2hha2Uod2Vic29ja2V0LCByZXEsICdNYXhpbXVtIHJlZGlyZWN0cyBleGNlZWRlZCcpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXEuYWJvcnQoKTsKICAgICAgICBsZXQgYWRkcjsKICAgICAgICB0cnkgewogICAgICAgICAgYWRkciA9IG5ldyBVUkwobG9jYXRpb24sIGFkZHJlc3MpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnN0IGVyciA9IG5ldyBTeW50YXhFcnJvcihgSW52YWxpZCBVUkw6ICR7bG9jYXRpb259YCk7CiAgICAgICAgICBlbWl0RXJyb3JBbmRDbG9zZSh3ZWJzb2NrZXQsIGVycik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGluaXRBc0NsaWVudCh3ZWJzb2NrZXQsIGFkZHIsIHByb3RvY29scywgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSBpZiAoIXdlYnNvY2tldC5lbWl0KCd1bmV4cGVjdGVkLXJlc3BvbnNlJywgcmVxLCByZXMpKSB7CiAgICAgICAgYWJvcnRIYW5kc2hha2Uod2Vic29ja2V0LCByZXEsIGBVbmV4cGVjdGVkIHNlcnZlciByZXNwb25zZTogJHtyZXMuc3RhdHVzQ29kZX1gKTsKICAgICAgfQogICAgfSk7CiAgICByZXEub24oJ3VwZ3JhZGUnLCAocmVzLCBzb2NrZXQsIGhlYWQpID0+IHsKICAgICAgd2Vic29ja2V0LmVtaXQoJ3VwZ3JhZGUnLCByZXMpOwoKICAgICAgLy8KICAgICAgLy8gVGhlIHVzZXIgbWF5IGhhdmUgY2xvc2VkIHRoZSBjb25uZWN0aW9uIGZyb20gYSBsaXN0ZW5lciBvZiB0aGUKICAgICAgLy8gYCd1cGdyYWRlJ2AgZXZlbnQuCiAgICAgIC8vCiAgICAgIGlmICh3ZWJzb2NrZXQucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcpIHJldHVybjsKICAgICAgcmVxID0gd2Vic29ja2V0Ll9yZXEgPSBudWxsOwogICAgICBjb25zdCB1cGdyYWRlID0gcmVzLmhlYWRlcnMudXBncmFkZTsKICAgICAgaWYgKHVwZ3JhZGUgPT09IHVuZGVmaW5lZCB8fCB1cGdyYWRlLnRvTG93ZXJDYXNlKCkgIT09ICd3ZWJzb2NrZXQnKSB7CiAgICAgICAgYWJvcnRIYW5kc2hha2Uod2Vic29ja2V0LCBzb2NrZXQsICdJbnZhbGlkIFVwZ3JhZGUgaGVhZGVyJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IGRpZ2VzdCA9IGNyZWF0ZUhhc2goJ3NoYTEnKS51cGRhdGUoa2V5ICsgR1VJRCkuZGlnZXN0KCdiYXNlNjQnKTsKICAgICAgaWYgKHJlcy5oZWFkZXJzWydzZWMtd2Vic29ja2V0LWFjY2VwdCddICE9PSBkaWdlc3QpIHsKICAgICAgICBhYm9ydEhhbmRzaGFrZSh3ZWJzb2NrZXQsIHNvY2tldCwgJ0ludmFsaWQgU2VjLVdlYlNvY2tldC1BY2NlcHQgaGVhZGVyJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHNlcnZlclByb3QgPSByZXMuaGVhZGVyc1snc2VjLXdlYnNvY2tldC1wcm90b2NvbCddOwogICAgICBsZXQgcHJvdEVycm9yOwogICAgICBpZiAoc2VydmVyUHJvdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKCFwcm90b2NvbFNldC5zaXplKSB7CiAgICAgICAgICBwcm90RXJyb3IgPSAnU2VydmVyIHNlbnQgYSBzdWJwcm90b2NvbCBidXQgbm9uZSB3YXMgcmVxdWVzdGVkJzsKICAgICAgICB9IGVsc2UgaWYgKCFwcm90b2NvbFNldC5oYXMoc2VydmVyUHJvdCkpIHsKICAgICAgICAgIHByb3RFcnJvciA9ICdTZXJ2ZXIgc2VudCBhbiBpbnZhbGlkIHN1YnByb3RvY29sJzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAocHJvdG9jb2xTZXQuc2l6ZSkgewogICAgICAgIHByb3RFcnJvciA9ICdTZXJ2ZXIgc2VudCBubyBzdWJwcm90b2NvbCc7CiAgICAgIH0KICAgICAgaWYgKHByb3RFcnJvcikgewogICAgICAgIGFib3J0SGFuZHNoYWtlKHdlYnNvY2tldCwgc29ja2V0LCBwcm90RXJyb3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoc2VydmVyUHJvdCkgd2Vic29ja2V0Ll9wcm90b2NvbCA9IHNlcnZlclByb3Q7CiAgICAgIGNvbnN0IHNlY1dlYlNvY2tldEV4dGVuc2lvbnMgPSByZXMuaGVhZGVyc1snc2VjLXdlYnNvY2tldC1leHRlbnNpb25zJ107CiAgICAgIGlmIChzZWNXZWJTb2NrZXRFeHRlbnNpb25zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIXBlck1lc3NhZ2VEZWZsYXRlKSB7CiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gJ1NlcnZlciBzZW50IGEgU2VjLVdlYlNvY2tldC1FeHRlbnNpb25zIGhlYWRlciBidXQgbm8gZXh0ZW5zaW9uICcgKyAnd2FzIHJlcXVlc3RlZCc7CiAgICAgICAgICBhYm9ydEhhbmRzaGFrZSh3ZWJzb2NrZXQsIHNvY2tldCwgbWVzc2FnZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxldCBleHRlbnNpb25zOwogICAgICAgIHRyeSB7CiAgICAgICAgICBleHRlbnNpb25zID0gcGFyc2Uoc2VjV2ViU29ja2V0RXh0ZW5zaW9ucyk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gJ0ludmFsaWQgU2VjLVdlYlNvY2tldC1FeHRlbnNpb25zIGhlYWRlcic7CiAgICAgICAgICBhYm9ydEhhbmRzaGFrZSh3ZWJzb2NrZXQsIHNvY2tldCwgbWVzc2FnZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGV4dGVuc2lvbk5hbWVzID0gT2JqZWN0LmtleXMoZXh0ZW5zaW9ucyk7CiAgICAgICAgaWYgKGV4dGVuc2lvbk5hbWVzLmxlbmd0aCAhPT0gMSB8fCBleHRlbnNpb25OYW1lc1swXSAhPT0gUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZSkgewogICAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdTZXJ2ZXIgaW5kaWNhdGVkIGFuIGV4dGVuc2lvbiB0aGF0IHdhcyBub3QgcmVxdWVzdGVkJzsKICAgICAgICAgIGFib3J0SGFuZHNoYWtlKHdlYnNvY2tldCwgc29ja2V0LCBtZXNzYWdlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHBlck1lc3NhZ2VEZWZsYXRlLmFjY2VwdChleHRlbnNpb25zW1Blck1lc3NhZ2VEZWZsYXRlLmV4dGVuc2lvbk5hbWVdKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSAnSW52YWxpZCBTZWMtV2ViU29ja2V0LUV4dGVuc2lvbnMgaGVhZGVyJzsKICAgICAgICAgIGFib3J0SGFuZHNoYWtlKHdlYnNvY2tldCwgc29ja2V0LCBtZXNzYWdlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgd2Vic29ja2V0Ll9leHRlbnNpb25zW1Blck1lc3NhZ2VEZWZsYXRlLmV4dGVuc2lvbk5hbWVdID0gcGVyTWVzc2FnZURlZmxhdGU7CiAgICAgIH0KICAgICAgd2Vic29ja2V0LnNldFNvY2tldChzb2NrZXQsIGhlYWQsIHsKICAgICAgICBhbGxvd1N5bmNocm9ub3VzRXZlbnRzOiBvcHRzLmFsbG93U3luY2hyb25vdXNFdmVudHMsCiAgICAgICAgZ2VuZXJhdGVNYXNrOiBvcHRzLmdlbmVyYXRlTWFzaywKICAgICAgICBtYXhQYXlsb2FkOiBvcHRzLm1heFBheWxvYWQsCiAgICAgICAgc2tpcFVURjhWYWxpZGF0aW9uOiBvcHRzLnNraXBVVEY4VmFsaWRhdGlvbgogICAgICB9KTsKICAgIH0pOwogICAgaWYgKG9wdHMuZmluaXNoUmVxdWVzdCkgewogICAgICBvcHRzLmZpbmlzaFJlcXVlc3QocmVxLCB3ZWJzb2NrZXQpOwogICAgfSBlbHNlIHsKICAgICAgcmVxLmVuZCgpOwogICAgfQogIH0KCiAgLyoqCiAgICogRW1pdCB0aGUgYCdlcnJvcidgIGFuZCBgJ2Nsb3NlJ2AgZXZlbnRzLgogICAqCiAgICogQHBhcmFtIHtXZWJTb2NrZXR9IHdlYnNvY2tldCBUaGUgV2ViU29ja2V0IGluc3RhbmNlCiAgICogQHBhcmFtIHtFcnJvcn0gVGhlIGVycm9yIHRvIGVtaXQKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGVtaXRFcnJvckFuZENsb3NlKHdlYnNvY2tldCwgZXJyKSB7CiAgICB3ZWJzb2NrZXQuX3JlYWR5U3RhdGUgPSBXZWJTb2NrZXQuQ0xPU0lORzsKICAgIC8vCiAgICAvLyBUaGUgZm9sbG93aW5nIGFzc2lnbm1lbnQgaXMgcHJhY3RpY2FsbHkgdXNlbGVzcyBhbmQgaXMgZG9uZSBvbmx5IGZvcgogICAgLy8gY29uc2lzdGVuY3kuCiAgICAvLwogICAgd2Vic29ja2V0Ll9lcnJvckVtaXR0ZWQgPSB0cnVlOwogICAgd2Vic29ja2V0LmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgIHdlYnNvY2tldC5lbWl0Q2xvc2UoKTsKICB9CgogIC8qKgogICAqIENyZWF0ZSBhIGBuZXQuU29ja2V0YCBhbmQgaW5pdGlhdGUgYSBjb25uZWN0aW9uLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQ29ubmVjdGlvbiBvcHRpb25zCiAgICogQHJldHVybiB7bmV0LlNvY2tldH0gVGhlIG5ld2x5IGNyZWF0ZWQgc29ja2V0IHVzZWQgdG8gc3RhcnQgdGhlIGNvbm5lY3Rpb24KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5ldENvbm5lY3Qob3B0aW9ucykgewogICAgb3B0aW9ucy5wYXRoID0gb3B0aW9ucy5zb2NrZXRQYXRoOwogICAgcmV0dXJuIG5ldC5jb25uZWN0KG9wdGlvbnMpOwogIH0KCiAgLyoqCiAgICogQ3JlYXRlIGEgYHRscy5UTFNTb2NrZXRgIGFuZCBpbml0aWF0ZSBhIGNvbm5lY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBDb25uZWN0aW9uIG9wdGlvbnMKICAgKiBAcmV0dXJuIHt0bHMuVExTU29ja2V0fSBUaGUgbmV3bHkgY3JlYXRlZCBzb2NrZXQgdXNlZCB0byBzdGFydCB0aGUgY29ubmVjdGlvbgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdGxzQ29ubmVjdChvcHRpb25zKSB7CiAgICBvcHRpb25zLnBhdGggPSB1bmRlZmluZWQ7CiAgICBpZiAoIW9wdGlvbnMuc2VydmVybmFtZSAmJiBvcHRpb25zLnNlcnZlcm5hbWUgIT09ICcnKSB7CiAgICAgIG9wdGlvbnMuc2VydmVybmFtZSA9IG5ldC5pc0lQKG9wdGlvbnMuaG9zdCkgPyAnJyA6IG9wdGlvbnMuaG9zdDsKICAgIH0KICAgIHJldHVybiB0bHMuY29ubmVjdChvcHRpb25zKTsKICB9CgogIC8qKgogICAqIEFib3J0IHRoZSBoYW5kc2hha2UgYW5kIGVtaXQgYW4gZXJyb3IuCiAgICoKICAgKiBAcGFyYW0ge1dlYlNvY2tldH0gd2Vic29ja2V0IFRoZSBXZWJTb2NrZXQgaW5zdGFuY2UKICAgKiBAcGFyYW0geyhodHRwLkNsaWVudFJlcXVlc3R8bmV0LlNvY2tldHx0bHMuU29ja2V0KX0gc3RyZWFtIFRoZSByZXF1ZXN0IHRvCiAgICogICAgIGFib3J0IG9yIHRoZSBzb2NrZXQgdG8gZGVzdHJveQogICAqIEBwYXJhbSB7U3RyaW5nfSBtZXNzYWdlIFRoZSBlcnJvciBtZXNzYWdlCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhYm9ydEhhbmRzaGFrZSh3ZWJzb2NrZXQsIHN0cmVhbSwgbWVzc2FnZSkgewogICAgd2Vic29ja2V0Ll9yZWFkeVN0YXRlID0gV2ViU29ja2V0LkNMT1NJTkc7CiAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IobWVzc2FnZSk7CiAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZShlcnIsIGFib3J0SGFuZHNoYWtlKTsKICAgIGlmIChzdHJlYW0uc2V0SGVhZGVyKSB7CiAgICAgIHN0cmVhbVtrQWJvcnRlZF0gPSB0cnVlOwogICAgICBzdHJlYW0uYWJvcnQoKTsKICAgICAgaWYgKHN0cmVhbS5zb2NrZXQgJiYgIXN0cmVhbS5zb2NrZXQuZGVzdHJveWVkKSB7CiAgICAgICAgLy8KICAgICAgICAvLyBPbiBOb2RlLmpzID49IDE0LjMuMCBgcmVxdWVzdC5hYm9ydCgpYCBkb2VzIG5vdCBkZXN0cm95IHRoZSBzb2NrZXQgaWYKICAgICAgICAvLyBjYWxsZWQgYWZ0ZXIgdGhlIHJlcXVlc3QgY29tcGxldGVkLiBTZWUKICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9pc3N1ZXMvMTg2OS4KICAgICAgICAvLwogICAgICAgIHN0cmVhbS5zb2NrZXQuZGVzdHJveSgpOwogICAgICB9CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdEVycm9yQW5kQ2xvc2UsIHdlYnNvY2tldCwgZXJyKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbS5kZXN0cm95KGVycik7CiAgICAgIHN0cmVhbS5vbmNlKCdlcnJvcicsIHdlYnNvY2tldC5lbWl0LmJpbmQod2Vic29ja2V0LCAnZXJyb3InKSk7CiAgICAgIHN0cmVhbS5vbmNlKCdjbG9zZScsIHdlYnNvY2tldC5lbWl0Q2xvc2UuYmluZCh3ZWJzb2NrZXQpKTsKICAgIH0KICB9CgogIC8qKgogICAqIEhhbmRsZSBjYXNlcyB3aGVyZSB0aGUgYHBpbmcoKWAsIGBwb25nKClgLCBvciBgc2VuZCgpYCBtZXRob2RzIGFyZSBjYWxsZWQKICAgKiB3aGVuIHRoZSBgcmVhZHlTdGF0ZWAgYXR0cmlidXRlIGlzIGBDTE9TSU5HYCBvciBgQ0xPU0VEYC4KICAgKgogICAqIEBwYXJhbSB7V2ViU29ja2V0fSB3ZWJzb2NrZXQgVGhlIFdlYlNvY2tldCBpbnN0YW5jZQogICAqIEBwYXJhbSB7Kn0gW2RhdGFdIFRoZSBkYXRhIHRvIHNlbmQKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2JdIENhbGxiYWNrCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzZW5kQWZ0ZXJDbG9zZSh3ZWJzb2NrZXQsIGRhdGEsIGNiKSB7CiAgICBpZiAoZGF0YSkgewogICAgICBjb25zdCBsZW5ndGggPSBpc0Jsb2IoZGF0YSkgPyBkYXRhLnNpemUgOiB0b0J1ZmZlcihkYXRhKS5sZW5ndGg7CgogICAgICAvLwogICAgICAvLyBUaGUgYF9idWZmZXJlZEFtb3VudGAgcHJvcGVydHkgaXMgdXNlZCBvbmx5IHdoZW4gdGhlIHBlZXIgaXMgYSBjbGllbnQgYW5kCiAgICAgIC8vIHRoZSBvcGVuaW5nIGhhbmRzaGFrZSBmYWlscy4gVW5kZXIgdGhlc2UgY2lyY3Vtc3RhbmNlcywgaW4gZmFjdCwgdGhlCiAgICAgIC8vIGBzZXRTb2NrZXQoKWAgbWV0aG9kIGlzIG5vdCBjYWxsZWQsIHNvIHRoZSBgX3NvY2tldGAgYW5kIGBfc2VuZGVyYAogICAgICAvLyBwcm9wZXJ0aWVzIGFyZSBzZXQgdG8gYG51bGxgLgogICAgICAvLwogICAgICBpZiAod2Vic29ja2V0Ll9zb2NrZXQpIHdlYnNvY2tldC5fc2VuZGVyLl9idWZmZXJlZEJ5dGVzICs9IGxlbmd0aDtlbHNlIHdlYnNvY2tldC5fYnVmZmVyZWRBbW91bnQgKz0gbGVuZ3RoOwogICAgfQogICAgaWYgKGNiKSB7CiAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihgV2ViU29ja2V0IGlzIG5vdCBvcGVuOiByZWFkeVN0YXRlICR7d2Vic29ja2V0LnJlYWR5U3RhdGV9IGAgKyBgKCR7cmVhZHlTdGF0ZXNbd2Vic29ja2V0LnJlYWR5U3RhdGVdfSlgKTsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYiwgZXJyKTsKICAgIH0KICB9CgogIC8qKgogICAqIFRoZSBsaXN0ZW5lciBvZiB0aGUgYFJlY2VpdmVyYCBgJ2NvbmNsdWRlJ2AgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0ge051bWJlcn0gY29kZSBUaGUgc3RhdHVzIGNvZGUKICAgKiBAcGFyYW0ge0J1ZmZlcn0gcmVhc29uIFRoZSByZWFzb24gZm9yIGNsb3NpbmcKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlY2VpdmVyT25Db25jbHVkZShjb2RlLCByZWFzb24pIHsKICAgIGNvbnN0IHdlYnNvY2tldCA9IHRoaXNba1dlYlNvY2tldF07CiAgICB3ZWJzb2NrZXQuX2Nsb3NlRnJhbWVSZWNlaXZlZCA9IHRydWU7CiAgICB3ZWJzb2NrZXQuX2Nsb3NlTWVzc2FnZSA9IHJlYXNvbjsKICAgIHdlYnNvY2tldC5fY2xvc2VDb2RlID0gY29kZTsKICAgIGlmICh3ZWJzb2NrZXQuX3NvY2tldFtrV2ViU29ja2V0XSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICB3ZWJzb2NrZXQuX3NvY2tldC5yZW1vdmVMaXN0ZW5lcignZGF0YScsIHNvY2tldE9uRGF0YSk7CiAgICBwcm9jZXNzLm5leHRUaWNrKHJlc3VtZSwgd2Vic29ja2V0Ll9zb2NrZXQpOwogICAgaWYgKGNvZGUgPT09IDEwMDUpIHdlYnNvY2tldC5jbG9zZSgpO2Vsc2Ugd2Vic29ja2V0LmNsb3NlKGNvZGUsIHJlYXNvbik7CiAgfQoKICAvKioKICAgKiBUaGUgbGlzdGVuZXIgb2YgdGhlIGBSZWNlaXZlcmAgYCdkcmFpbidgIGV2ZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZWNlaXZlck9uRHJhaW4oKSB7CiAgICBjb25zdCB3ZWJzb2NrZXQgPSB0aGlzW2tXZWJTb2NrZXRdOwogICAgaWYgKCF3ZWJzb2NrZXQuaXNQYXVzZWQpIHdlYnNvY2tldC5fc29ja2V0LnJlc3VtZSgpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgUmVjZWl2ZXJgIGAnZXJyb3InYCBldmVudC4KICAgKgogICAqIEBwYXJhbSB7KFJhbmdlRXJyb3J8RXJyb3IpfSBlcnIgVGhlIGVtaXR0ZWQgZXJyb3IKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlY2VpdmVyT25FcnJvcihlcnIpIHsKICAgIGNvbnN0IHdlYnNvY2tldCA9IHRoaXNba1dlYlNvY2tldF07CiAgICBpZiAod2Vic29ja2V0Ll9zb2NrZXRba1dlYlNvY2tldF0gIT09IHVuZGVmaW5lZCkgewogICAgICB3ZWJzb2NrZXQuX3NvY2tldC5yZW1vdmVMaXN0ZW5lcignZGF0YScsIHNvY2tldE9uRGF0YSk7CgogICAgICAvLwogICAgICAvLyBPbiBOb2RlLmpzIDwgMTQuMC4wIHRoZSBgJ2Vycm9yJ2AgZXZlbnQgaXMgZW1pdHRlZCBzeW5jaHJvbm91c2x5LiBTZWUKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYnNvY2tldHMvd3MvaXNzdWVzLzE5NDAuCiAgICAgIC8vCiAgICAgIHByb2Nlc3MubmV4dFRpY2socmVzdW1lLCB3ZWJzb2NrZXQuX3NvY2tldCk7CiAgICAgIHdlYnNvY2tldC5jbG9zZShlcnJba1N0YXR1c0NvZGVdKTsKICAgIH0KICAgIGlmICghd2Vic29ja2V0Ll9lcnJvckVtaXR0ZWQpIHsKICAgICAgd2Vic29ja2V0Ll9lcnJvckVtaXR0ZWQgPSB0cnVlOwogICAgICB3ZWJzb2NrZXQuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgfQogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgUmVjZWl2ZXJgIGAnZmluaXNoJ2AgZXZlbnQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlY2VpdmVyT25GaW5pc2goKSB7CiAgICB0aGlzW2tXZWJTb2NrZXRdLmVtaXRDbG9zZSgpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgUmVjZWl2ZXJgIGAnbWVzc2FnZSdgIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ8QXJyYXlCdWZmZXJ8QnVmZmVyW10pfSBkYXRhIFRoZSBtZXNzYWdlCiAgICogQHBhcmFtIHtCb29sZWFufSBpc0JpbmFyeSBTcGVjaWZpZXMgd2hldGhlciB0aGUgbWVzc2FnZSBpcyBiaW5hcnkgb3Igbm90CiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZWNlaXZlck9uTWVzc2FnZShkYXRhLCBpc0JpbmFyeSkgewogICAgdGhpc1trV2ViU29ja2V0XS5lbWl0KCdtZXNzYWdlJywgZGF0YSwgaXNCaW5hcnkpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgUmVjZWl2ZXJgIGAncGluZydgIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IGRhdGEgVGhlIGRhdGEgaW5jbHVkZWQgaW4gdGhlIHBpbmcgZnJhbWUKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlY2VpdmVyT25QaW5nKGRhdGEpIHsKICAgIGNvbnN0IHdlYnNvY2tldCA9IHRoaXNba1dlYlNvY2tldF07CiAgICBpZiAod2Vic29ja2V0Ll9hdXRvUG9uZykgd2Vic29ja2V0LnBvbmcoZGF0YSwgIXRoaXMuX2lzU2VydmVyLCBOT09QKTsKICAgIHdlYnNvY2tldC5lbWl0KCdwaW5nJywgZGF0YSk7CiAgfQoKICAvKioKICAgKiBUaGUgbGlzdGVuZXIgb2YgdGhlIGBSZWNlaXZlcmAgYCdwb25nJ2AgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gZGF0YSBUaGUgZGF0YSBpbmNsdWRlZCBpbiB0aGUgcG9uZyBmcmFtZQogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVjZWl2ZXJPblBvbmcoZGF0YSkgewogICAgdGhpc1trV2ViU29ja2V0XS5lbWl0KCdwb25nJywgZGF0YSk7CiAgfQoKICAvKioKICAgKiBSZXN1bWUgYSByZWFkYWJsZSBzdHJlYW0KICAgKgogICAqIEBwYXJhbSB7UmVhZGFibGV9IHN0cmVhbSBUaGUgcmVhZGFibGUgc3RyZWFtCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiByZXN1bWUoc3RyZWFtKSB7CiAgICBzdHJlYW0ucmVzdW1lKCk7CiAgfQoKICAvKioKICAgKiBUaGUgYFNlbmRlcmAgZXJyb3IgZXZlbnQgaGFuZGxlci4KICAgKgogICAqIEBwYXJhbSB7RXJyb3J9IFRoZSBlcnJvcgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2VuZGVyT25FcnJvcihlcnIpIHsKICAgIGNvbnN0IHdlYnNvY2tldCA9IHRoaXNba1dlYlNvY2tldF07CiAgICBpZiAod2Vic29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5DTE9TRUQpIHJldHVybjsKICAgIGlmICh3ZWJzb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHsKICAgICAgd2Vic29ja2V0Ll9yZWFkeVN0YXRlID0gV2ViU29ja2V0LkNMT1NJTkc7CiAgICAgIHNldENsb3NlVGltZXIod2Vic29ja2V0KTsKICAgIH0KCiAgICAvLwogICAgLy8gYHNvY2tldC5lbmQoKWAgaXMgdXNlZCBpbnN0ZWFkIG9mIGBzb2NrZXQuZGVzdHJveSgpYCB0byBhbGxvdyB0aGUgb3RoZXIKICAgIC8vIHBlZXIgdG8gZmluaXNoIHNlbmRpbmcgcXVldWVkIGRhdGEuIFRoZXJlIGlzIG5vIG5lZWQgdG8gc2V0IGEgdGltZXIgaGVyZQogICAgLy8gYmVjYXVzZSBgQ0xPU0lOR2AgbWVhbnMgdGhhdCBpdCBpcyBhbHJlYWR5IHNldCBvciBub3QgbmVlZGVkLgogICAgLy8KICAgIHRoaXMuX3NvY2tldC5lbmQoKTsKICAgIGlmICghd2Vic29ja2V0Ll9lcnJvckVtaXR0ZWQpIHsKICAgICAgd2Vic29ja2V0Ll9lcnJvckVtaXR0ZWQgPSB0cnVlOwogICAgICB3ZWJzb2NrZXQuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgfQogIH0KCiAgLyoqCiAgICogU2V0IGEgdGltZXIgdG8gZGVzdHJveSB0aGUgdW5kZXJseWluZyByYXcgc29ja2V0IG9mIGEgV2ViU29ja2V0LgogICAqCiAgICogQHBhcmFtIHtXZWJTb2NrZXR9IHdlYnNvY2tldCBUaGUgV2ViU29ja2V0IGluc3RhbmNlCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzZXRDbG9zZVRpbWVyKHdlYnNvY2tldCkgewogICAgd2Vic29ja2V0Ll9jbG9zZVRpbWVyID0gc2V0VGltZW91dCh3ZWJzb2NrZXQuX3NvY2tldC5kZXN0cm95LmJpbmQod2Vic29ja2V0Ll9zb2NrZXQpLCBjbG9zZVRpbWVvdXQpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBzb2NrZXQgYCdjbG9zZSdgIGV2ZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzb2NrZXRPbkNsb3NlKCkgewogICAgY29uc3Qgd2Vic29ja2V0ID0gdGhpc1trV2ViU29ja2V0XTsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgc29ja2V0T25DbG9zZSk7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgc29ja2V0T25EYXRhKTsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIHNvY2tldE9uRW5kKTsKICAgIHdlYnNvY2tldC5fcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DTE9TSU5HOwogICAgbGV0IGNodW5rOwoKICAgIC8vCiAgICAvLyBUaGUgY2xvc2UgZnJhbWUgbWlnaHQgbm90IGhhdmUgYmVlbiByZWNlaXZlZCBvciB0aGUgYCdlbmQnYCBldmVudCBlbWl0dGVkLAogICAgLy8gZm9yIGV4YW1wbGUsIGlmIHRoZSBzb2NrZXQgd2FzIGRlc3Ryb3llZCBkdWUgdG8gYW4gZXJyb3IuIEVuc3VyZSB0aGF0IHRoZQogICAgLy8gYHJlY2VpdmVyYCBzdHJlYW0gaXMgY2xvc2VkIGFmdGVyIHdyaXRpbmcgYW55IHJlbWFpbmluZyBidWZmZXJlZCBkYXRhIHRvCiAgICAvLyBpdC4gSWYgdGhlIHJlYWRhYmxlIHNpZGUgb2YgdGhlIHNvY2tldCBpcyBpbiBmbG93aW5nIG1vZGUgdGhlbiB0aGVyZSBpcyBubwogICAgLy8gYnVmZmVyZWQgZGF0YSBhcyBldmVyeXRoaW5nIGhhcyBiZWVuIGFscmVhZHkgd3JpdHRlbiBhbmQgYHJlYWRhYmxlLnJlYWQoKWAKICAgIC8vIHdpbGwgcmV0dXJuIGBudWxsYC4gSWYgaW5zdGVhZCwgdGhlIHNvY2tldCBpcyBwYXVzZWQsIGFueSBwb3NzaWJsZSBidWZmZXJlZAogICAgLy8gZGF0YSB3aWxsIGJlIHJlYWQgYXMgYSBzaW5nbGUgY2h1bmsuCiAgICAvLwogICAgaWYgKCF0aGlzLl9yZWFkYWJsZVN0YXRlLmVuZEVtaXR0ZWQgJiYgIXdlYnNvY2tldC5fY2xvc2VGcmFtZVJlY2VpdmVkICYmICF3ZWJzb2NrZXQuX3JlY2VpdmVyLl93cml0YWJsZVN0YXRlLmVycm9yRW1pdHRlZCAmJiAoY2h1bmsgPSB3ZWJzb2NrZXQuX3NvY2tldC5yZWFkKCkpICE9PSBudWxsKSB7CiAgICAgIHdlYnNvY2tldC5fcmVjZWl2ZXIud3JpdGUoY2h1bmspOwogICAgfQogICAgd2Vic29ja2V0Ll9yZWNlaXZlci5lbmQoKTsKICAgIHRoaXNba1dlYlNvY2tldF0gPSB1bmRlZmluZWQ7CiAgICBjbGVhclRpbWVvdXQod2Vic29ja2V0Ll9jbG9zZVRpbWVyKTsKICAgIGlmICh3ZWJzb2NrZXQuX3JlY2VpdmVyLl93cml0YWJsZVN0YXRlLmZpbmlzaGVkIHx8IHdlYnNvY2tldC5fcmVjZWl2ZXIuX3dyaXRhYmxlU3RhdGUuZXJyb3JFbWl0dGVkKSB7CiAgICAgIHdlYnNvY2tldC5lbWl0Q2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgIHdlYnNvY2tldC5fcmVjZWl2ZXIub24oJ2Vycm9yJywgcmVjZWl2ZXJPbkZpbmlzaCk7CiAgICAgIHdlYnNvY2tldC5fcmVjZWl2ZXIub24oJ2ZpbmlzaCcsIHJlY2VpdmVyT25GaW5pc2gpOwogICAgfQogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBzb2NrZXQgYCdkYXRhJ2AgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gY2h1bmsgQSBjaHVuayBvZiBkYXRhCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBzb2NrZXRPbkRhdGEoY2h1bmspIHsKICAgIGlmICghdGhpc1trV2ViU29ja2V0XS5fcmVjZWl2ZXIud3JpdGUoY2h1bmspKSB7CiAgICAgIHRoaXMucGF1c2UoKTsKICAgIH0KICB9CgogIC8qKgogICAqIFRoZSBsaXN0ZW5lciBvZiB0aGUgc29ja2V0IGAnZW5kJ2AgZXZlbnQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNvY2tldE9uRW5kKCkgewogICAgY29uc3Qgd2Vic29ja2V0ID0gdGhpc1trV2ViU29ja2V0XTsKICAgIHdlYnNvY2tldC5fcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DTE9TSU5HOwogICAgd2Vic29ja2V0Ll9yZWNlaXZlci5lbmQoKTsKICAgIHRoaXMuZW5kKCk7CiAgfQoKICAvKioKICAgKiBUaGUgbGlzdGVuZXIgb2YgdGhlIHNvY2tldCBgJ2Vycm9yJ2AgZXZlbnQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNvY2tldE9uRXJyb3IoKSB7CiAgICBjb25zdCB3ZWJzb2NrZXQgPSB0aGlzW2tXZWJTb2NrZXRdOwogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBzb2NrZXRPbkVycm9yKTsKICAgIHRoaXMub24oJ2Vycm9yJywgTk9PUCk7CiAgICBpZiAod2Vic29ja2V0KSB7CiAgICAgIHdlYnNvY2tldC5fcmVhZHlTdGF0ZSA9IFdlYlNvY2tldC5DTE9TSU5HOwogICAgICB0aGlzLmRlc3Ryb3koKTsKICAgIH0KICB9CiAgcmV0dXJuIHdlYnNvY2tldDsKfQoKZnVuY3Rpb24gb3duS2V5cyQxKGUsIHIpIHsgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOyByICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcikuZW51bWVyYWJsZTsgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7IH0gcmV0dXJuIHQ7IH0KZnVuY3Rpb24gX29iamVjdFNwcmVhZCQxKGUpIHsgZm9yICh2YXIgciA9IDE7IHIgPCBhcmd1bWVudHMubGVuZ3RoOyByKyspIHsgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyXSA/IGFyZ3VtZW50c1tyXSA6IHt9OyByICUgMiA/IG93bktleXMkMShPYmplY3QodCksICEwKS5mb3JFYWNoKGZ1bmN0aW9uIChyKSB7IF9kZWZpbmVQcm9wZXJ0eShlLCByLCB0W3JdKTsgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMkMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcikpOyB9KTsgfSByZXR1cm4gZTsgfQp2YXIgc3RyZWFtOwp2YXIgaGFzUmVxdWlyZWRTdHJlYW07CmZ1bmN0aW9uIHJlcXVpcmVTdHJlYW0oKSB7CiAgaWYgKGhhc1JlcXVpcmVkU3RyZWFtKSByZXR1cm4gc3RyZWFtOwogIGhhc1JlcXVpcmVkU3RyZWFtID0gMTsKICByZXF1aXJlV2Vic29ja2V0KCk7CiAgY29uc3QgewogICAgRHVwbGV4CiAgfSA9IHJlcXVpcmUkJDAkNDsKCiAgLyoqCiAgICogRW1pdHMgdGhlIGAnY2xvc2UnYCBldmVudCBvbiBhIHN0cmVhbS4KICAgKgogICAqIEBwYXJhbSB7RHVwbGV4fSBzdHJlYW0gVGhlIHN0cmVhbS4KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGVtaXRDbG9zZShzdHJlYW0pIHsKICAgIHN0cmVhbS5lbWl0KCdjbG9zZScpOwogIH0KCiAgLyoqCiAgICogVGhlIGxpc3RlbmVyIG9mIHRoZSBgJ2VuZCdgIGV2ZW50LgogICAqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBkdXBsZXhPbkVuZCgpIHsKICAgIGlmICghdGhpcy5kZXN0cm95ZWQgJiYgdGhpcy5fd3JpdGFibGVTdGF0ZS5maW5pc2hlZCkgewogICAgICB0aGlzLmRlc3Ryb3koKTsKICAgIH0KICB9CgogIC8qKgogICAqIFRoZSBsaXN0ZW5lciBvZiB0aGUgYCdlcnJvcidgIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHtFcnJvcn0gZXJyIFRoZSBlcnJvcgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZHVwbGV4T25FcnJvcihlcnIpIHsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgZHVwbGV4T25FcnJvcik7CiAgICB0aGlzLmRlc3Ryb3koKTsKICAgIGlmICh0aGlzLmxpc3RlbmVyQ291bnQoJ2Vycm9yJykgPT09IDApIHsKICAgICAgLy8gRG8gbm90IHN1cHByZXNzIHRoZSB0aHJvd2luZyBiZWhhdmlvci4KICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7CiAgICB9CiAgfQoKICAvKioKICAgKiBXcmFwcyBhIGBXZWJTb2NrZXRgIGluIGEgZHVwbGV4IHN0cmVhbS4KICAgKgogICAqIEBwYXJhbSB7V2ViU29ja2V0fSB3cyBUaGUgYFdlYlNvY2tldGAgdG8gd3JhcAogICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgZm9yIHRoZSBgRHVwbGV4YCBjb25zdHJ1Y3RvcgogICAqIEByZXR1cm4ge0R1cGxleH0gVGhlIGR1cGxleCBzdHJlYW0KICAgKiBAcHVibGljCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlV2ViU29ja2V0U3RyZWFtKHdzLCBvcHRpb25zKSB7CiAgICBsZXQgdGVybWluYXRlT25EZXN0cm95ID0gdHJ1ZTsKICAgIGNvbnN0IGR1cGxleCA9IG5ldyBEdXBsZXgoX29iamVjdFNwcmVhZCQxKF9vYmplY3RTcHJlYWQkMSh7fSwgb3B0aW9ucyksIHt9LCB7CiAgICAgIGF1dG9EZXN0cm95OiBmYWxzZSwKICAgICAgZW1pdENsb3NlOiBmYWxzZSwKICAgICAgb2JqZWN0TW9kZTogZmFsc2UsCiAgICAgIHdyaXRhYmxlT2JqZWN0TW9kZTogZmFsc2UKICAgIH0pKTsKICAgIHdzLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gbWVzc2FnZShtc2csIGlzQmluYXJ5KSB7CiAgICAgIGNvbnN0IGRhdGEgPSAhaXNCaW5hcnkgJiYgZHVwbGV4Ll9yZWFkYWJsZVN0YXRlLm9iamVjdE1vZGUgPyBtc2cudG9TdHJpbmcoKSA6IG1zZzsKICAgICAgaWYgKCFkdXBsZXgucHVzaChkYXRhKSkgd3MucGF1c2UoKTsKICAgIH0pOwogICAgd3Mub25jZSgnZXJyb3InLCBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgaWYgKGR1cGxleC5kZXN0cm95ZWQpIHJldHVybjsKCiAgICAgIC8vIFByZXZlbnQgYHdzLnRlcm1pbmF0ZSgpYCBmcm9tIGJlaW5nIGNhbGxlZCBieSBgZHVwbGV4Ll9kZXN0cm95KClgLgogICAgICAvLwogICAgICAvLyAtIElmIHRoZSBgJ2Vycm9yJ2AgZXZlbnQgaXMgZW1pdHRlZCBiZWZvcmUgdGhlIGAnb3BlbidgIGV2ZW50LCB0aGVuCiAgICAgIC8vICAgYHdzLnRlcm1pbmF0ZSgpYCBpcyBhIG5vb3AgYXMgbm8gc29ja2V0IGlzIGFzc2lnbmVkLgogICAgICAvLyAtIE90aGVyd2lzZSwgdGhlIGVycm9yIGlzIHJlLWVtaXR0ZWQgYnkgdGhlIGxpc3RlbmVyIG9mIHRoZSBgJ2Vycm9yJ2AKICAgICAgLy8gICBldmVudCBvZiB0aGUgYFJlY2VpdmVyYCBvYmplY3QuIFRoZSBsaXN0ZW5lciBhbHJlYWR5IGNsb3NlcyB0aGUKICAgICAgLy8gICBjb25uZWN0aW9uIGJ5IGNhbGxpbmcgYHdzLmNsb3NlKClgLiBUaGlzIGFsbG93cyBhIGNsb3NlIGZyYW1lIHRvIGJlCiAgICAgIC8vICAgc2VudCB0byB0aGUgb3RoZXIgcGVlci4gSWYgYHdzLnRlcm1pbmF0ZSgpYCBpcyBjYWxsZWQgcmlnaHQgYWZ0ZXIgdGhpcywKICAgICAgLy8gICB0aGVuIHRoZSBjbG9zZSBmcmFtZSBtaWdodCBub3QgYmUgc2VudC4KICAgICAgdGVybWluYXRlT25EZXN0cm95ID0gZmFsc2U7CiAgICAgIGR1cGxleC5kZXN0cm95KGVycik7CiAgICB9KTsKICAgIHdzLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgIGlmIChkdXBsZXguZGVzdHJveWVkKSByZXR1cm47CiAgICAgIGR1cGxleC5wdXNoKG51bGwpOwogICAgfSk7CiAgICBkdXBsZXguX2Rlc3Ryb3kgPSBmdW5jdGlvbiAoZXJyLCBjYWxsYmFjaykgewogICAgICBpZiAod3MucmVhZHlTdGF0ZSA9PT0gd3MuQ0xPU0VEKSB7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRDbG9zZSwgZHVwbGV4KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IGNhbGxlZCA9IGZhbHNlOwogICAgICB3cy5vbmNlKCdlcnJvcicsIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICAgIHdzLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24gY2xvc2UoKSB7CiAgICAgICAgaWYgKCFjYWxsZWQpIGNhbGxiYWNrKGVycik7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhlbWl0Q2xvc2UsIGR1cGxleCk7CiAgICAgIH0pOwogICAgICBpZiAodGVybWluYXRlT25EZXN0cm95KSB3cy50ZXJtaW5hdGUoKTsKICAgIH07CiAgICBkdXBsZXguX2ZpbmFsID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIGlmICh3cy5yZWFkeVN0YXRlID09PSB3cy5DT05ORUNUSU5HKSB7CiAgICAgICAgd3Mub25jZSgnb3BlbicsIGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICBkdXBsZXguX2ZpbmFsKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgYF9zb2NrZXRgIHByb3BlcnR5IGlzIGBudWxsYCBpdCBtZWFucyB0aGF0IGB3c2AgaXMgYQogICAgICAvLyBjbGllbnQgd2Vic29ja2V0IGFuZCB0aGUgaGFuZHNoYWtlIGZhaWxlZC4gSW4gZmFjdCwgd2hlbiB0aGlzIGhhcHBlbnMsIGEKICAgICAgLy8gc29ja2V0IGlzIG5ldmVyIGFzc2lnbmVkIHRvIHRoZSB3ZWJzb2NrZXQuIFdhaXQgZm9yIHRoZSBgJ2Vycm9yJ2AgZXZlbnQKICAgICAgLy8gdGhhdCB3aWxsIGJlIGVtaXR0ZWQgYnkgdGhlIHdlYnNvY2tldC4KICAgICAgaWYgKHdzLl9zb2NrZXQgPT09IG51bGwpIHJldHVybjsKICAgICAgaWYgKHdzLl9zb2NrZXQuX3dyaXRhYmxlU3RhdGUuZmluaXNoZWQpIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIGlmIChkdXBsZXguX3JlYWRhYmxlU3RhdGUuZW5kRW1pdHRlZCkgZHVwbGV4LmRlc3Ryb3koKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3cy5fc29ja2V0Lm9uY2UoJ2ZpbmlzaCcsIGZ1bmN0aW9uIGZpbmlzaCgpIHsKICAgICAgICAgIC8vIGBkdXBsZXhgIGlzIG5vdCBkZXN0cm95ZWQgaGVyZSBiZWNhdXNlIHRoZSBgJ2VuZCdgIGV2ZW50IHdpbGwgYmUKICAgICAgICAgIC8vIGVtaXR0ZWQgb24gYGR1cGxleGAgYWZ0ZXIgdGhpcyBgJ2ZpbmlzaCdgIGV2ZW50LiBUaGUgRU9GIHNpZ25hbGluZwogICAgICAgICAgLy8gYG51bGxgIGNodW5rIGlzLCBpbiBmYWN0LCBwdXNoZWQgd2hlbiB0aGUgd2Vic29ja2V0IGVtaXRzIGAnY2xvc2UnYC4KICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfSk7CiAgICAgICAgd3MuY2xvc2UoKTsKICAgICAgfQogICAgfTsKICAgIGR1cGxleC5fcmVhZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHdzLmlzUGF1c2VkKSB3cy5yZXN1bWUoKTsKICAgIH07CiAgICBkdXBsZXguX3dyaXRlID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHsKICAgICAgaWYgKHdzLnJlYWR5U3RhdGUgPT09IHdzLkNPTk5FQ1RJTkcpIHsKICAgICAgICB3cy5vbmNlKCdvcGVuJywgZnVuY3Rpb24gb3BlbigpIHsKICAgICAgICAgIGR1cGxleC5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHdzLnNlbmQoY2h1bmssIGNhbGxiYWNrKTsKICAgIH07CiAgICBkdXBsZXgub24oJ2VuZCcsIGR1cGxleE9uRW5kKTsKICAgIGR1cGxleC5vbignZXJyb3InLCBkdXBsZXhPbkVycm9yKTsKICAgIHJldHVybiBkdXBsZXg7CiAgfQogIHN0cmVhbSA9IGNyZWF0ZVdlYlNvY2tldFN0cmVhbTsKICByZXR1cm4gc3RyZWFtOwp9Cgp2YXIgc3VicHJvdG9jb2w7CnZhciBoYXNSZXF1aXJlZFN1YnByb3RvY29sOwpmdW5jdGlvbiByZXF1aXJlU3VicHJvdG9jb2woKSB7CiAgaWYgKGhhc1JlcXVpcmVkU3VicHJvdG9jb2wpIHJldHVybiBzdWJwcm90b2NvbDsKICBoYXNSZXF1aXJlZFN1YnByb3RvY29sID0gMTsKICBjb25zdCB7CiAgICB0b2tlbkNoYXJzCiAgfSA9IHJlcXVpcmVWYWxpZGF0aW9uKCk7CgogIC8qKgogICAqIFBhcnNlcyB0aGUgYFNlYy1XZWJTb2NrZXQtUHJvdG9jb2xgIGhlYWRlciBpbnRvIGEgc2V0IG9mIHN1YnByb3RvY29sIG5hbWVzLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IGhlYWRlciBUaGUgZmllbGQgdmFsdWUgb2YgdGhlIGhlYWRlcgogICAqIEByZXR1cm4ge1NldH0gVGhlIHN1YnByb3RvY29sIG5hbWVzCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIHBhcnNlKGhlYWRlcikgewogICAgY29uc3QgcHJvdG9jb2xzID0gbmV3IFNldCgpOwogICAgbGV0IHN0YXJ0ID0gLTE7CiAgICBsZXQgZW5kID0gLTE7CiAgICBsZXQgaSA9IDA7CiAgICBmb3IgKGk7IGkgPCBoZWFkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY29kZSA9IGhlYWRlci5jaGFyQ29kZUF0KGkpOwogICAgICBpZiAoZW5kID09PSAtMSAmJiB0b2tlbkNoYXJzW2NvZGVdID09PSAxKSB7CiAgICAgICAgaWYgKHN0YXJ0ID09PSAtMSkgc3RhcnQgPSBpOwogICAgICB9IGVsc2UgaWYgKGkgIT09IDAgJiYgKGNvZGUgPT09IDB4MjAgLyogJyAnICovIHx8IGNvZGUgPT09IDB4MDkpIC8qICdcdCcgKi8pIHsKICAgICAgICBpZiAoZW5kID09PSAtMSAmJiBzdGFydCAhPT0gLTEpIGVuZCA9IGk7CiAgICAgIH0gZWxzZSBpZiAoY29kZSA9PT0gMHgyYyAvKiAnLCcgKi8pIHsKICAgICAgICBpZiAoc3RhcnQgPT09IC0xKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVuZCA9PT0gLTEpIGVuZCA9IGk7CiAgICAgICAgY29uc3QgcHJvdG9jb2wgPSBoZWFkZXIuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgaWYgKHByb3RvY29scy5oYXMocHJvdG9jb2wpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFRoZSAiJHtwcm90b2NvbH0iIHN1YnByb3RvY29sIGlzIGR1cGxpY2F0ZWRgKTsKICAgICAgICB9CiAgICAgICAgcHJvdG9jb2xzLmFkZChwcm90b2NvbCk7CiAgICAgICAgc3RhcnQgPSBlbmQgPSAtMTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFVuZXhwZWN0ZWQgY2hhcmFjdGVyIGF0IGluZGV4ICR7aX1gKTsKICAgICAgfQogICAgfQogICAgaWYgKHN0YXJ0ID09PSAtMSB8fCBlbmQgIT09IC0xKSB7CiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignVW5leHBlY3RlZCBlbmQgb2YgaW5wdXQnKTsKICAgIH0KICAgIGNvbnN0IHByb3RvY29sID0gaGVhZGVyLnNsaWNlKHN0YXJ0LCBpKTsKICAgIGlmIChwcm90b2NvbHMuaGFzKHByb3RvY29sKSkgewogICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYFRoZSAiJHtwcm90b2NvbH0iIHN1YnByb3RvY29sIGlzIGR1cGxpY2F0ZWRgKTsKICAgIH0KICAgIHByb3RvY29scy5hZGQocHJvdG9jb2wpOwogICAgcmV0dXJuIHByb3RvY29sczsKICB9CiAgc3VicHJvdG9jb2wgPSB7CiAgICBwYXJzZQogIH07CiAgcmV0dXJuIHN1YnByb3RvY29sOwp9CgpmdW5jdGlvbiBvd25LZXlzKGUsIHIpIHsgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOyByICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24gKHIpIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcikuZW51bWVyYWJsZTsgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7IH0gcmV0dXJuIHQ7IH0KZnVuY3Rpb24gX29iamVjdFNwcmVhZChlKSB7IGZvciAodmFyIHIgPSAxOyByIDwgYXJndW1lbnRzLmxlbmd0aDsgcisrKSB7IHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcl0gPyBhcmd1bWVudHNbcl0gOiB7fTsgciAlIDIgPyBvd25LZXlzKE9iamVjdCh0KSwgITApLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgX2RlZmluZVByb3BlcnR5KGUsIHIsIHRbcl0pOyB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24gKHIpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcikpOyB9KTsgfSByZXR1cm4gZTsgfQp2YXIgd2Vic29ja2V0U2VydmVyOwp2YXIgaGFzUmVxdWlyZWRXZWJzb2NrZXRTZXJ2ZXI7CmZ1bmN0aW9uIHJlcXVpcmVXZWJzb2NrZXRTZXJ2ZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkV2Vic29ja2V0U2VydmVyKSByZXR1cm4gd2Vic29ja2V0U2VydmVyOwogIGhhc1JlcXVpcmVkV2Vic29ja2V0U2VydmVyID0gMTsKICBjb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlJCQwJDI7CiAgY29uc3QgaHR0cCA9IHJlcXVpcmUkJDI7CiAgY29uc3QgewogICAgY3JlYXRlSGFzaAogIH0gPSByZXF1aXJlJCQxJDI7CiAgY29uc3QgZXh0ZW5zaW9uID0gcmVxdWlyZUV4dGVuc2lvbigpOwogIGNvbnN0IFBlck1lc3NhZ2VEZWZsYXRlID0gcmVxdWlyZVBlcm1lc3NhZ2VEZWZsYXRlKCk7CiAgY29uc3Qgc3VicHJvdG9jb2wgPSByZXF1aXJlU3VicHJvdG9jb2woKTsKICBjb25zdCBXZWJTb2NrZXQgPSByZXF1aXJlV2Vic29ja2V0KCk7CiAgY29uc3QgewogICAgR1VJRCwKICAgIGtXZWJTb2NrZXQKICB9ID0gcmVxdWlyZUNvbnN0YW50cyQzKCk7CiAgY29uc3Qga2V5UmVnZXggPSAvXlsrLzAtOUEtWmEtel17MjJ9PT0kLzsKICBjb25zdCBSVU5OSU5HID0gMDsKICBjb25zdCBDTE9TSU5HID0gMTsKICBjb25zdCBDTE9TRUQgPSAyOwoKICAvKioKICAgKiBDbGFzcyByZXByZXNlbnRpbmcgYSBXZWJTb2NrZXQgc2VydmVyLgogICAqCiAgICogQGV4dGVuZHMgRXZlbnRFbWl0dGVyCiAgICovCiAgY2xhc3MgV2ViU29ja2V0U2VydmVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgYFdlYlNvY2tldFNlcnZlcmAgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQ29uZmlndXJhdGlvbiBvcHRpb25zCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmFsbG93U3luY2hyb25vdXNFdmVudHM9dHJ1ZV0gU3BlY2lmaWVzIHdoZXRoZXIKICAgICAqICAgICBhbnkgb2YgdGhlIGAnbWVzc2FnZSdgLCBgJ3BpbmcnYCwgYW5kIGAncG9uZydgIGV2ZW50cyBjYW4gYmUgZW1pdHRlZAogICAgICogICAgIG11bHRpcGxlIHRpbWVzIGluIHRoZSBzYW1lIHRpY2sKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuYXV0b1Bvbmc9dHJ1ZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvCiAgICAgKiAgICAgYXV0b21hdGljYWxseSBzZW5kIGEgcG9uZyBpbiByZXNwb25zZSB0byBhIHBpbmcKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5iYWNrbG9nPTUxMV0gVGhlIG1heGltdW0gbGVuZ3RoIG9mIHRoZSBxdWV1ZSBvZgogICAgICogICAgIHBlbmRpbmcgY29ubmVjdGlvbnMKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY2xpZW50VHJhY2tpbmc9dHJ1ZV0gU3BlY2lmaWVzIHdoZXRoZXIgb3Igbm90IHRvCiAgICAgKiAgICAgdHJhY2sgY2xpZW50cwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuaGFuZGxlUHJvdG9jb2xzXSBBIGhvb2sgdG8gaGFuZGxlIHByb3RvY29scwogICAgICogQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmhvc3RdIFRoZSBob3N0bmFtZSB3aGVyZSB0byBiaW5kIHRoZSBzZXJ2ZXIKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5tYXhQYXlsb2FkPTEwNDg1NzYwMF0gVGhlIG1heGltdW0gYWxsb3dlZCBtZXNzYWdlCiAgICAgKiAgICAgc2l6ZQogICAgICogQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5ub1NlcnZlcj1mYWxzZV0gRW5hYmxlIG5vIHNlcnZlciBtb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMucGF0aF0gQWNjZXB0IG9ubHkgY29ubmVjdGlvbnMgbWF0Y2hpbmcgdGhpcyBwYXRoCiAgICAgKiBAcGFyYW0geyhCb29sZWFufE9iamVjdCl9IFtvcHRpb25zLnBlck1lc3NhZ2VEZWZsYXRlPWZhbHNlXSBFbmFibGUvZGlzYWJsZQogICAgICogICAgIHBlcm1lc3NhZ2UtZGVmbGF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLnBvcnRdIFRoZSBwb3J0IHdoZXJlIHRvIGJpbmQgdGhlIHNlcnZlcgogICAgICogQHBhcmFtIHsoaHR0cC5TZXJ2ZXJ8aHR0cHMuU2VydmVyKX0gW29wdGlvbnMuc2VydmVyXSBBIHByZS1jcmVhdGVkIEhUVFAvUwogICAgICogICAgIHNlcnZlciB0byB1c2UKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uPWZhbHNlXSBTcGVjaWZpZXMgd2hldGhlciBvcgogICAgICogICAgIG5vdCB0byBza2lwIFVURi04IHZhbGlkYXRpb24gZm9yIHRleHQgYW5kIGNsb3NlIG1lc3NhZ2VzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb3B0aW9ucy52ZXJpZnlDbGllbnRdIEEgaG9vayB0byByZWplY3QgY29ubmVjdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvcHRpb25zLldlYlNvY2tldD1XZWJTb2NrZXRdIFNwZWNpZmllcyB0aGUgYFdlYlNvY2tldGAKICAgICAqICAgICBjbGFzcyB0byB1c2UuIEl0IG11c3QgYmUgdGhlIGBXZWJTb2NrZXRgIGNsYXNzIG9yIGNsYXNzIHRoYXQgZXh0ZW5kcyBpdAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBBIGxpc3RlbmVyIGZvciB0aGUgYGxpc3RlbmluZ2AgZXZlbnQKICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucywgY2FsbGJhY2spIHsKICAgICAgc3VwZXIoKTsKICAgICAgb3B0aW9ucyA9IF9vYmplY3RTcHJlYWQoewogICAgICAgIGFsbG93U3luY2hyb25vdXNFdmVudHM6IHRydWUsCiAgICAgICAgYXV0b1Bvbmc6IHRydWUsCiAgICAgICAgbWF4UGF5bG9hZDogMTAwICogMTAyNCAqIDEwMjQsCiAgICAgICAgc2tpcFVURjhWYWxpZGF0aW9uOiBmYWxzZSwKICAgICAgICBwZXJNZXNzYWdlRGVmbGF0ZTogZmFsc2UsCiAgICAgICAgaGFuZGxlUHJvdG9jb2xzOiBudWxsLAogICAgICAgIGNsaWVudFRyYWNraW5nOiB0cnVlLAogICAgICAgIHZlcmlmeUNsaWVudDogbnVsbCwKICAgICAgICBub1NlcnZlcjogZmFsc2UsCiAgICAgICAgYmFja2xvZzogbnVsbCwKICAgICAgICAvLyB1c2UgZGVmYXVsdCAoNTExIGFzIGltcGxlbWVudGVkIGluIG5ldC5qcykKICAgICAgICBzZXJ2ZXI6IG51bGwsCiAgICAgICAgaG9zdDogbnVsbCwKICAgICAgICBwYXRoOiBudWxsLAogICAgICAgIHBvcnQ6IG51bGwsCiAgICAgICAgV2ViU29ja2V0CiAgICAgIH0sIG9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wb3J0ID09IG51bGwgJiYgIW9wdGlvbnMuc2VydmVyICYmICFvcHRpb25zLm5vU2VydmVyIHx8IG9wdGlvbnMucG9ydCAhPSBudWxsICYmIChvcHRpb25zLnNlcnZlciB8fCBvcHRpb25zLm5vU2VydmVyKSB8fCBvcHRpb25zLnNlcnZlciAmJiBvcHRpb25zLm5vU2VydmVyKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignT25lIGFuZCBvbmx5IG9uZSBvZiB0aGUgInBvcnQiLCAic2VydmVyIiwgb3IgIm5vU2VydmVyIiBvcHRpb25zICcgKyAnbXVzdCBiZSBzcGVjaWZpZWQnKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5wb3J0ICE9IG51bGwpIHsKICAgICAgICB0aGlzLl9zZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcigocmVxLCByZXMpID0+IHsKICAgICAgICAgIGNvbnN0IGJvZHkgPSBodHRwLlNUQVRVU19DT0RFU1s0MjZdOwogICAgICAgICAgcmVzLndyaXRlSGVhZCg0MjYsIHsKICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogYm9keS5sZW5ndGgsCiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9wbGFpbicKICAgICAgICAgIH0pOwogICAgICAgICAgcmVzLmVuZChib2R5KTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLl9zZXJ2ZXIubGlzdGVuKG9wdGlvbnMucG9ydCwgb3B0aW9ucy5ob3N0LCBvcHRpb25zLmJhY2tsb2csIGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnNlcnZlcikgewogICAgICAgIHRoaXMuX3NlcnZlciA9IG9wdGlvbnMuc2VydmVyOwogICAgICB9CiAgICAgIGlmICh0aGlzLl9zZXJ2ZXIpIHsKICAgICAgICBjb25zdCBlbWl0Q29ubmVjdGlvbiA9IHRoaXMuZW1pdC5iaW5kKHRoaXMsICdjb25uZWN0aW9uJyk7CiAgICAgICAgdGhpcy5fcmVtb3ZlTGlzdGVuZXJzID0gYWRkTGlzdGVuZXJzKHRoaXMuX3NlcnZlciwgewogICAgICAgICAgbGlzdGVuaW5nOiB0aGlzLmVtaXQuYmluZCh0aGlzLCAnbGlzdGVuaW5nJyksCiAgICAgICAgICBlcnJvcjogdGhpcy5lbWl0LmJpbmQodGhpcywgJ2Vycm9yJyksCiAgICAgICAgICB1cGdyYWRlOiAocmVxLCBzb2NrZXQsIGhlYWQpID0+IHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVVcGdyYWRlKHJlcSwgc29ja2V0LCBoZWFkLCBlbWl0Q29ubmVjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMucGVyTWVzc2FnZURlZmxhdGUgPT09IHRydWUpIG9wdGlvbnMucGVyTWVzc2FnZURlZmxhdGUgPSB7fTsKICAgICAgaWYgKG9wdGlvbnMuY2xpZW50VHJhY2tpbmcpIHsKICAgICAgICB0aGlzLmNsaWVudHMgPSBuZXcgU2V0KCk7CiAgICAgICAgdGhpcy5fc2hvdWxkRW1pdENsb3NlID0gZmFsc2U7CiAgICAgIH0KICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgICAgdGhpcy5fc3RhdGUgPSBSVU5OSU5HOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgYm91bmQgYWRkcmVzcywgdGhlIGFkZHJlc3MgZmFtaWx5IG5hbWUsIGFuZCBwb3J0IG9mIHRoZSBzZXJ2ZXIKICAgICAqIGFzIHJlcG9ydGVkIGJ5IHRoZSBvcGVyYXRpbmcgc3lzdGVtIGlmIGxpc3RlbmluZyBvbiBhbiBJUCBzb2NrZXQuCiAgICAgKiBJZiB0aGUgc2VydmVyIGlzIGxpc3RlbmluZyBvbiBhIHBpcGUgb3IgVU5JWCBkb21haW4gc29ja2V0LCB0aGUgbmFtZSBpcwogICAgICogcmV0dXJuZWQgYXMgYSBzdHJpbmcuCiAgICAgKgogICAgICogQHJldHVybiB7KE9iamVjdHxTdHJpbmd8bnVsbCl9IFRoZSBhZGRyZXNzIG9mIHRoZSBzZXJ2ZXIKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgYWRkcmVzcygpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5ub1NlcnZlcikgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIHNlcnZlciBpcyBvcGVyYXRpbmcgaW4gIm5vU2VydmVyIiBtb2RlJyk7CiAgICAgIH0KICAgICAgaWYgKCF0aGlzLl9zZXJ2ZXIpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fc2VydmVyLmFkZHJlc3MoKTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0b3AgdGhlIHNlcnZlciBmcm9tIGFjY2VwdGluZyBuZXcgY29ubmVjdGlvbnMgYW5kIGVtaXQgdGhlIGAnY2xvc2UnYCBldmVudAogICAgICogd2hlbiBhbGwgZXhpc3RpbmcgY29ubmVjdGlvbnMgYXJlIGNsb3NlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2JdIEEgb25lLXRpbWUgbGlzdGVuZXIgZm9yIHRoZSBgJ2Nsb3NlJ2AgZXZlbnQKICAgICAqIEBwdWJsaWMKICAgICAqLwogICAgY2xvc2UoY2IpIHsKICAgICAgaWYgKHRoaXMuX3N0YXRlID09PSBDTE9TRUQpIHsKICAgICAgICBpZiAoY2IpIHsKICAgICAgICAgIHRoaXMub25jZSgnY2xvc2UnLCAoKSA9PiB7CiAgICAgICAgICAgIGNiKG5ldyBFcnJvcignVGhlIHNlcnZlciBpcyBub3QgcnVubmluZycpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRDbG9zZSwgdGhpcyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChjYikgdGhpcy5vbmNlKCdjbG9zZScsIGNiKTsKICAgICAgaWYgKHRoaXMuX3N0YXRlID09PSBDTE9TSU5HKSByZXR1cm47CiAgICAgIHRoaXMuX3N0YXRlID0gQ0xPU0lORzsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5ub1NlcnZlciB8fCB0aGlzLm9wdGlvbnMuc2VydmVyKSB7CiAgICAgICAgaWYgKHRoaXMuX3NlcnZlcikgewogICAgICAgICAgdGhpcy5fcmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICB0aGlzLl9yZW1vdmVMaXN0ZW5lcnMgPSB0aGlzLl9zZXJ2ZXIgPSBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jbGllbnRzKSB7CiAgICAgICAgICBpZiAoIXRoaXMuY2xpZW50cy5zaXplKSB7CiAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdENsb3NlLCB0aGlzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3Nob3VsZEVtaXRDbG9zZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZW1pdENsb3NlLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2VydmVyID0gdGhpcy5fc2VydmVyOwogICAgICAgIHRoaXMuX3JlbW92ZUxpc3RlbmVycygpOwogICAgICAgIHRoaXMuX3JlbW92ZUxpc3RlbmVycyA9IHRoaXMuX3NlcnZlciA9IG51bGw7CgogICAgICAgIC8vCiAgICAgICAgLy8gVGhlIEhUVFAvUyBzZXJ2ZXIgd2FzIGNyZWF0ZWQgaW50ZXJuYWxseS4gQ2xvc2UgaXQsIGFuZCByZWx5IG9uIGl0cwogICAgICAgIC8vIGAnY2xvc2UnYCBldmVudC4KICAgICAgICAvLwogICAgICAgIHNlcnZlci5jbG9zZSgoKSA9PiB7CiAgICAgICAgICBlbWl0Q2xvc2UodGhpcyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNlZSBpZiBhIGdpdmVuIHJlcXVlc3Qgc2hvdWxkIGJlIGhhbmRsZWQgYnkgdGhpcyBzZXJ2ZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHBhcmFtIHtodHRwLkluY29taW5nTWVzc2FnZX0gcmVxIFJlcXVlc3Qgb2JqZWN0IHRvIGluc3BlY3QKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IGB0cnVlYCBpZiB0aGUgcmVxdWVzdCBpcyB2YWxpZCwgZWxzZSBgZmFsc2VgCiAgICAgKiBAcHVibGljCiAgICAgKi8KICAgIHNob3VsZEhhbmRsZShyZXEpIHsKICAgICAgaWYgKHRoaXMub3B0aW9ucy5wYXRoKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSByZXEudXJsLmluZGV4T2YoJz8nKTsKICAgICAgICBjb25zdCBwYXRobmFtZSA9IGluZGV4ICE9PSAtMSA/IHJlcS51cmwuc2xpY2UoMCwgaW5kZXgpIDogcmVxLnVybDsKICAgICAgICBpZiAocGF0aG5hbWUgIT09IHRoaXMub3B0aW9ucy5wYXRoKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBIYW5kbGUgYSBIVFRQIFVwZ3JhZGUgcmVxdWVzdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge2h0dHAuSW5jb21pbmdNZXNzYWdlfSByZXEgVGhlIHJlcXVlc3Qgb2JqZWN0CiAgICAgKiBAcGFyYW0ge0R1cGxleH0gc29ja2V0IFRoZSBuZXR3b3JrIHNvY2tldCBiZXR3ZWVuIHRoZSBzZXJ2ZXIgYW5kIGNsaWVudAogICAgICogQHBhcmFtIHtCdWZmZXJ9IGhlYWQgVGhlIGZpcnN0IHBhY2tldCBvZiB0aGUgdXBncmFkZWQgc3RyZWFtCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYiBDYWxsYmFjawogICAgICogQHB1YmxpYwogICAgICovCiAgICBoYW5kbGVVcGdyYWRlKHJlcSwgc29ja2V0LCBoZWFkLCBjYikgewogICAgICBzb2NrZXQub24oJ2Vycm9yJywgc29ja2V0T25FcnJvcik7CiAgICAgIGNvbnN0IGtleSA9IHJlcS5oZWFkZXJzWydzZWMtd2Vic29ja2V0LWtleSddOwogICAgICBjb25zdCB1cGdyYWRlID0gcmVxLmhlYWRlcnMudXBncmFkZTsKICAgICAgY29uc3QgdmVyc2lvbiA9ICtyZXEuaGVhZGVyc1snc2VjLXdlYnNvY2tldC12ZXJzaW9uJ107CiAgICAgIGlmIChyZXEubWV0aG9kICE9PSAnR0VUJykgewogICAgICAgIGNvbnN0IG1lc3NhZ2UgPSAnSW52YWxpZCBIVFRQIG1ldGhvZCc7CiAgICAgICAgYWJvcnRIYW5kc2hha2VPckVtaXR3c0NsaWVudEVycm9yKHRoaXMsIHJlcSwgc29ja2V0LCA0MDUsIG1lc3NhZ2UpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodXBncmFkZSA9PT0gdW5kZWZpbmVkIHx8IHVwZ3JhZGUudG9Mb3dlckNhc2UoKSAhPT0gJ3dlYnNvY2tldCcpIHsKICAgICAgICBjb25zdCBtZXNzYWdlID0gJ0ludmFsaWQgVXBncmFkZSBoZWFkZXInOwogICAgICAgIGFib3J0SGFuZHNoYWtlT3JFbWl0d3NDbGllbnRFcnJvcih0aGlzLCByZXEsIHNvY2tldCwgNDAwLCBtZXNzYWdlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8ICFrZXlSZWdleC50ZXN0KGtleSkpIHsKICAgICAgICBjb25zdCBtZXNzYWdlID0gJ01pc3Npbmcgb3IgaW52YWxpZCBTZWMtV2ViU29ja2V0LUtleSBoZWFkZXInOwogICAgICAgIGFib3J0SGFuZHNoYWtlT3JFbWl0d3NDbGllbnRFcnJvcih0aGlzLCByZXEsIHNvY2tldCwgNDAwLCBtZXNzYWdlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHZlcnNpb24gIT09IDggJiYgdmVyc2lvbiAhPT0gMTMpIHsKICAgICAgICBjb25zdCBtZXNzYWdlID0gJ01pc3Npbmcgb3IgaW52YWxpZCBTZWMtV2ViU29ja2V0LVZlcnNpb24gaGVhZGVyJzsKICAgICAgICBhYm9ydEhhbmRzaGFrZU9yRW1pdHdzQ2xpZW50RXJyb3IodGhpcywgcmVxLCBzb2NrZXQsIDQwMCwgbWVzc2FnZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghdGhpcy5zaG91bGRIYW5kbGUocmVxKSkgewogICAgICAgIGFib3J0SGFuZHNoYWtlKHNvY2tldCwgNDAwKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3Qgc2VjV2ViU29ja2V0UHJvdG9jb2wgPSByZXEuaGVhZGVyc1snc2VjLXdlYnNvY2tldC1wcm90b2NvbCddOwogICAgICBsZXQgcHJvdG9jb2xzID0gbmV3IFNldCgpOwogICAgICBpZiAoc2VjV2ViU29ja2V0UHJvdG9jb2wgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBwcm90b2NvbHMgPSBzdWJwcm90b2NvbC5wYXJzZShzZWNXZWJTb2NrZXRQcm90b2NvbCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gJ0ludmFsaWQgU2VjLVdlYlNvY2tldC1Qcm90b2NvbCBoZWFkZXInOwogICAgICAgICAgYWJvcnRIYW5kc2hha2VPckVtaXR3c0NsaWVudEVycm9yKHRoaXMsIHJlcSwgc29ja2V0LCA0MDAsIG1lc3NhZ2UpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBzZWNXZWJTb2NrZXRFeHRlbnNpb25zID0gcmVxLmhlYWRlcnNbJ3NlYy13ZWJzb2NrZXQtZXh0ZW5zaW9ucyddOwogICAgICBjb25zdCBleHRlbnNpb25zID0ge307CiAgICAgIGlmICh0aGlzLm9wdGlvbnMucGVyTWVzc2FnZURlZmxhdGUgJiYgc2VjV2ViU29ja2V0RXh0ZW5zaW9ucyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29uc3QgcGVyTWVzc2FnZURlZmxhdGUgPSBuZXcgUGVyTWVzc2FnZURlZmxhdGUodGhpcy5vcHRpb25zLnBlck1lc3NhZ2VEZWZsYXRlLCB0cnVlLCB0aGlzLm9wdGlvbnMubWF4UGF5bG9hZCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IG9mZmVycyA9IGV4dGVuc2lvbi5wYXJzZShzZWNXZWJTb2NrZXRFeHRlbnNpb25zKTsKICAgICAgICAgIGlmIChvZmZlcnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV0pIHsKICAgICAgICAgICAgcGVyTWVzc2FnZURlZmxhdGUuYWNjZXB0KG9mZmVyc1tQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXSk7CiAgICAgICAgICAgIGV4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV0gPSBwZXJNZXNzYWdlRGVmbGF0ZTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSAnSW52YWxpZCBvciB1bmFjY2VwdGFibGUgU2VjLVdlYlNvY2tldC1FeHRlbnNpb25zIGhlYWRlcic7CiAgICAgICAgICBhYm9ydEhhbmRzaGFrZU9yRW1pdHdzQ2xpZW50RXJyb3IodGhpcywgcmVxLCBzb2NrZXQsIDQwMCwgbWVzc2FnZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICAvLwogICAgICAvLyBPcHRpb25hbGx5IGNhbGwgZXh0ZXJuYWwgY2xpZW50IHZlcmlmaWNhdGlvbiBoYW5kbGVyLgogICAgICAvLwogICAgICBpZiAodGhpcy5vcHRpb25zLnZlcmlmeUNsaWVudCkgewogICAgICAgIGNvbnN0IGluZm8gPSB7CiAgICAgICAgICBvcmlnaW46IHJlcS5oZWFkZXJzW2Ake3ZlcnNpb24gPT09IDggPyAnc2VjLXdlYnNvY2tldC1vcmlnaW4nIDogJ29yaWdpbid9YF0sCiAgICAgICAgICBzZWN1cmU6ICEhKHJlcS5zb2NrZXQuYXV0aG9yaXplZCB8fCByZXEuc29ja2V0LmVuY3J5cHRlZCksCiAgICAgICAgICByZXEKICAgICAgICB9OwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmVyaWZ5Q2xpZW50Lmxlbmd0aCA9PT0gMikgewogICAgICAgICAgdGhpcy5vcHRpb25zLnZlcmlmeUNsaWVudChpbmZvLCAodmVyaWZpZWQsIGNvZGUsIG1lc3NhZ2UsIGhlYWRlcnMpID0+IHsKICAgICAgICAgICAgaWYgKCF2ZXJpZmllZCkgewogICAgICAgICAgICAgIHJldHVybiBhYm9ydEhhbmRzaGFrZShzb2NrZXQsIGNvZGUgfHwgNDAxLCBtZXNzYWdlLCBoZWFkZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNvbXBsZXRlVXBncmFkZShleHRlbnNpb25zLCBrZXksIHByb3RvY29scywgcmVxLCBzb2NrZXQsIGhlYWQsIGNiKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy52ZXJpZnlDbGllbnQoaW5mbykpIHJldHVybiBhYm9ydEhhbmRzaGFrZShzb2NrZXQsIDQwMSk7CiAgICAgIH0KICAgICAgdGhpcy5jb21wbGV0ZVVwZ3JhZGUoZXh0ZW5zaW9ucywga2V5LCBwcm90b2NvbHMsIHJlcSwgc29ja2V0LCBoZWFkLCBjYik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVcGdyYWRlIHRoZSBjb25uZWN0aW9uIHRvIFdlYlNvY2tldC4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZXh0ZW5zaW9ucyBUaGUgYWNjZXB0ZWQgZXh0ZW5zaW9ucwogICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUgdmFsdWUgb2YgdGhlIGBTZWMtV2ViU29ja2V0LUtleWAgaGVhZGVyCiAgICAgKiBAcGFyYW0ge1NldH0gcHJvdG9jb2xzIFRoZSBzdWJwcm90b2NvbHMKICAgICAqIEBwYXJhbSB7aHR0cC5JbmNvbWluZ01lc3NhZ2V9IHJlcSBUaGUgcmVxdWVzdCBvYmplY3QKICAgICAqIEBwYXJhbSB7RHVwbGV4fSBzb2NrZXQgVGhlIG5ldHdvcmsgc29ja2V0IGJldHdlZW4gdGhlIHNlcnZlciBhbmQgY2xpZW50CiAgICAgKiBAcGFyYW0ge0J1ZmZlcn0gaGVhZCBUaGUgZmlyc3QgcGFja2V0IG9mIHRoZSB1cGdyYWRlZCBzdHJlYW0KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNiIENhbGxiYWNrCiAgICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgY2FsbGVkIG1vcmUgdGhhbiBvbmNlIHdpdGggdGhlIHNhbWUgc29ja2V0CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBjb21wbGV0ZVVwZ3JhZGUoZXh0ZW5zaW9ucywga2V5LCBwcm90b2NvbHMsIHJlcSwgc29ja2V0LCBoZWFkLCBjYikgewogICAgICAvLwogICAgICAvLyBEZXN0cm95IHRoZSBzb2NrZXQgaWYgdGhlIGNsaWVudCBoYXMgYWxyZWFkeSBzZW50IGEgRklOIHBhY2tldC4KICAgICAgLy8KICAgICAgaWYgKCFzb2NrZXQucmVhZGFibGUgfHwgIXNvY2tldC53cml0YWJsZSkgcmV0dXJuIHNvY2tldC5kZXN0cm95KCk7CiAgICAgIGlmIChzb2NrZXRba1dlYlNvY2tldF0pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcnZlci5oYW5kbGVVcGdyYWRlKCkgd2FzIGNhbGxlZCBtb3JlIHRoYW4gb25jZSB3aXRoIHRoZSBzYW1lICcgKyAnc29ja2V0LCBwb3NzaWJseSBkdWUgdG8gYSBtaXNjb25maWd1cmF0aW9uJyk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX3N0YXRlID4gUlVOTklORykgcmV0dXJuIGFib3J0SGFuZHNoYWtlKHNvY2tldCwgNTAzKTsKICAgICAgY29uc3QgZGlnZXN0ID0gY3JlYXRlSGFzaCgnc2hhMScpLnVwZGF0ZShrZXkgKyBHVUlEKS5kaWdlc3QoJ2Jhc2U2NCcpOwogICAgICBjb25zdCBoZWFkZXJzID0gWydIVFRQLzEuMSAxMDEgU3dpdGNoaW5nIFByb3RvY29scycsICdVcGdyYWRlOiB3ZWJzb2NrZXQnLCAnQ29ubmVjdGlvbjogVXBncmFkZScsIGBTZWMtV2ViU29ja2V0LUFjY2VwdDogJHtkaWdlc3R9YF07CiAgICAgIGNvbnN0IHdzID0gbmV3IHRoaXMub3B0aW9ucy5XZWJTb2NrZXQobnVsbCwgdW5kZWZpbmVkLCB0aGlzLm9wdGlvbnMpOwogICAgICBpZiAocHJvdG9jb2xzLnNpemUpIHsKICAgICAgICAvLwogICAgICAgIC8vIE9wdGlvbmFsbHkgY2FsbCBleHRlcm5hbCBwcm90b2NvbCBzZWxlY3Rpb24gaGFuZGxlci4KICAgICAgICAvLwogICAgICAgIGNvbnN0IHByb3RvY29sID0gdGhpcy5vcHRpb25zLmhhbmRsZVByb3RvY29scyA/IHRoaXMub3B0aW9ucy5oYW5kbGVQcm90b2NvbHMocHJvdG9jb2xzLCByZXEpIDogcHJvdG9jb2xzLnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICAgICAgICBpZiAocHJvdG9jb2wpIHsKICAgICAgICAgIGhlYWRlcnMucHVzaChgU2VjLVdlYlNvY2tldC1Qcm90b2NvbDogJHtwcm90b2NvbH1gKTsKICAgICAgICAgIHdzLl9wcm90b2NvbCA9IHByb3RvY29sOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZXh0ZW5zaW9uc1tQZXJNZXNzYWdlRGVmbGF0ZS5leHRlbnNpb25OYW1lXSkgewogICAgICAgIGNvbnN0IHBhcmFtcyA9IGV4dGVuc2lvbnNbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV0ucGFyYW1zOwogICAgICAgIGNvbnN0IHZhbHVlID0gZXh0ZW5zaW9uLmZvcm1hdCh7CiAgICAgICAgICBbUGVyTWVzc2FnZURlZmxhdGUuZXh0ZW5zaW9uTmFtZV06IFtwYXJhbXNdCiAgICAgICAgfSk7CiAgICAgICAgaGVhZGVycy5wdXNoKGBTZWMtV2ViU29ja2V0LUV4dGVuc2lvbnM6ICR7dmFsdWV9YCk7CiAgICAgICAgd3MuX2V4dGVuc2lvbnMgPSBleHRlbnNpb25zOwogICAgICB9CgogICAgICAvLwogICAgICAvLyBBbGxvdyBleHRlcm5hbCBtb2RpZmljYXRpb24vaW5zcGVjdGlvbiBvZiBoYW5kc2hha2UgaGVhZGVycy4KICAgICAgLy8KICAgICAgdGhpcy5lbWl0KCdoZWFkZXJzJywgaGVhZGVycywgcmVxKTsKICAgICAgc29ja2V0LndyaXRlKGhlYWRlcnMuY29uY2F0KCdcclxuJykuam9pbignXHJcbicpKTsKICAgICAgc29ja2V0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIHNvY2tldE9uRXJyb3IpOwogICAgICB3cy5zZXRTb2NrZXQoc29ja2V0LCBoZWFkLCB7CiAgICAgICAgYWxsb3dTeW5jaHJvbm91c0V2ZW50czogdGhpcy5vcHRpb25zLmFsbG93U3luY2hyb25vdXNFdmVudHMsCiAgICAgICAgbWF4UGF5bG9hZDogdGhpcy5vcHRpb25zLm1heFBheWxvYWQsCiAgICAgICAgc2tpcFVURjhWYWxpZGF0aW9uOiB0aGlzLm9wdGlvbnMuc2tpcFVURjhWYWxpZGF0aW9uCiAgICAgIH0pOwogICAgICBpZiAodGhpcy5jbGllbnRzKSB7CiAgICAgICAgdGhpcy5jbGllbnRzLmFkZCh3cyk7CiAgICAgICAgd3Mub24oJ2Nsb3NlJywgKCkgPT4gewogICAgICAgICAgdGhpcy5jbGllbnRzLmRlbGV0ZSh3cyk7CiAgICAgICAgICBpZiAodGhpcy5fc2hvdWxkRW1pdENsb3NlICYmICF0aGlzLmNsaWVudHMuc2l6ZSkgewogICAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGVtaXRDbG9zZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY2Iod3MsIHJlcSk7CiAgICB9CiAgfQogIHdlYnNvY2tldFNlcnZlciA9IFdlYlNvY2tldFNlcnZlcjsKCiAgLyoqCiAgICogQWRkIGV2ZW50IGxpc3RlbmVycyBvbiBhbiBgRXZlbnRFbWl0dGVyYCB1c2luZyBhIG1hcCBvZiA8ZXZlbnQsIGxpc3RlbmVyPgogICAqIHBhaXJzLgogICAqCiAgICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IHNlcnZlciBUaGUgZXZlbnQgZW1pdHRlcgogICAqIEBwYXJhbSB7T2JqZWN0LjxTdHJpbmcsIEZ1bmN0aW9uPn0gbWFwIFRoZSBsaXN0ZW5lcnMgdG8gYWRkCiAgICogQHJldHVybiB7RnVuY3Rpb259IEEgZnVuY3Rpb24gdGhhdCB3aWxsIHJlbW92ZSB0aGUgYWRkZWQgbGlzdGVuZXJzIHdoZW4KICAgKiAgICAgY2FsbGVkCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhZGRMaXN0ZW5lcnMoc2VydmVyLCBtYXApIHsKICAgIGZvciAoY29uc3QgZXZlbnQgb2YgT2JqZWN0LmtleXMobWFwKSkgc2VydmVyLm9uKGV2ZW50LCBtYXBbZXZlbnRdKTsKICAgIHJldHVybiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcnMoKSB7CiAgICAgIGZvciAoY29uc3QgZXZlbnQgb2YgT2JqZWN0LmtleXMobWFwKSkgewogICAgICAgIHNlcnZlci5yZW1vdmVMaXN0ZW5lcihldmVudCwgbWFwW2V2ZW50XSk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBFbWl0IGEgYCdjbG9zZSdgIGV2ZW50IG9uIGFuIGBFdmVudEVtaXR0ZXJgLgogICAqCiAgICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IHNlcnZlciBUaGUgZXZlbnQgZW1pdHRlcgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZW1pdENsb3NlKHNlcnZlcikgewogICAgc2VydmVyLl9zdGF0ZSA9IENMT1NFRDsKICAgIHNlcnZlci5lbWl0KCdjbG9zZScpOwogIH0KCiAgLyoqCiAgICogSGFuZGxlIHNvY2tldCBlcnJvcnMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNvY2tldE9uRXJyb3IoKSB7CiAgICB0aGlzLmRlc3Ryb3koKTsKICB9CgogIC8qKgogICAqIENsb3NlIHRoZSBjb25uZWN0aW9uIHdoZW4gcHJlY29uZGl0aW9ucyBhcmUgbm90IGZ1bGZpbGxlZC4KICAgKgogICAqIEBwYXJhbSB7RHVwbGV4fSBzb2NrZXQgVGhlIHNvY2tldCBvZiB0aGUgdXBncmFkZSByZXF1ZXN0CiAgICogQHBhcmFtIHtOdW1iZXJ9IGNvZGUgVGhlIEhUVFAgcmVzcG9uc2Ugc3RhdHVzIGNvZGUKICAgKiBAcGFyYW0ge1N0cmluZ30gW21lc3NhZ2VdIFRoZSBIVFRQIHJlc3BvbnNlIGJvZHkKICAgKiBAcGFyYW0ge09iamVjdH0gW2hlYWRlcnNdIEFkZGl0aW9uYWwgSFRUUCByZXNwb25zZSBoZWFkZXJzCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhYm9ydEhhbmRzaGFrZShzb2NrZXQsIGNvZGUsIG1lc3NhZ2UsIGhlYWRlcnMpIHsKICAgIC8vCiAgICAvLyBUaGUgc29ja2V0IGlzIHdyaXRhYmxlIHVubGVzcyB0aGUgdXNlciBkZXN0cm95ZWQgb3IgZW5kZWQgaXQgYmVmb3JlIGNhbGxpbmcKICAgIC8vIGBzZXJ2ZXIuaGFuZGxlVXBncmFkZSgpYCBvciBpbiB0aGUgYHZlcmlmeUNsaWVudGAgZnVuY3Rpb24sIHdoaWNoIGlzIGEgdXNlcgogICAgLy8gZXJyb3IuIEhhbmRsaW5nIHRoaXMgZG9lcyBub3QgbWFrZSBtdWNoIHNlbnNlIGFzIHRoZSB3b3JzdCB0aGF0IGNhbiBoYXBwZW4KICAgIC8vIGlzIHRoYXQgc29tZSBvZiB0aGUgZGF0YSB3cml0dGVuIGJ5IHRoZSB1c2VyIG1pZ2h0IGJlIGRpc2NhcmRlZCBkdWUgdG8gdGhlCiAgICAvLyBjYWxsIHRvIGBzb2NrZXQuZW5kKClgIGJlbG93LCB3aGljaCB0cmlnZ2VycyBhbiBgJ2Vycm9yJ2AgZXZlbnQgdGhhdCBpbgogICAgLy8gdHVybiBjYXVzZXMgdGhlIHNvY2tldCB0byBiZSBkZXN0cm95ZWQuCiAgICAvLwogICAgbWVzc2FnZSA9IG1lc3NhZ2UgfHwgaHR0cC5TVEFUVVNfQ09ERVNbY29kZV07CiAgICBoZWFkZXJzID0gX29iamVjdFNwcmVhZCh7CiAgICAgIENvbm5lY3Rpb246ICdjbG9zZScsCiAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9odG1sJywKICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogQnVmZmVyLmJ5dGVMZW5ndGgobWVzc2FnZSkKICAgIH0sIGhlYWRlcnMpOwogICAgc29ja2V0Lm9uY2UoJ2ZpbmlzaCcsIHNvY2tldC5kZXN0cm95KTsKICAgIHNvY2tldC5lbmQoYEhUVFAvMS4xICR7Y29kZX0gJHtodHRwLlNUQVRVU19DT0RFU1tjb2RlXX1cclxuYCArIE9iamVjdC5rZXlzKGhlYWRlcnMpLm1hcChoID0+IGAke2h9OiAke2hlYWRlcnNbaF19YCkuam9pbignXHJcbicpICsgJ1xyXG5cclxuJyArIG1lc3NhZ2UpOwogIH0KCiAgLyoqCiAgICogRW1pdCBhIGAnd3NDbGllbnRFcnJvcidgIGV2ZW50IG9uIGEgYFdlYlNvY2tldFNlcnZlcmAgaWYgdGhlcmUgaXMgYXQgbGVhc3QKICAgKiBvbmUgbGlzdGVuZXIgZm9yIGl0LCBvdGhlcndpc2UgY2FsbCBgYWJvcnRIYW5kc2hha2UoKWAuCiAgICoKICAgKiBAcGFyYW0ge1dlYlNvY2tldFNlcnZlcn0gc2VydmVyIFRoZSBXZWJTb2NrZXQgc2VydmVyCiAgICogQHBhcmFtIHtodHRwLkluY29taW5nTWVzc2FnZX0gcmVxIFRoZSByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSB7RHVwbGV4fSBzb2NrZXQgVGhlIHNvY2tldCBvZiB0aGUgdXBncmFkZSByZXF1ZXN0CiAgICogQHBhcmFtIHtOdW1iZXJ9IGNvZGUgVGhlIEhUVFAgcmVzcG9uc2Ugc3RhdHVzIGNvZGUKICAgKiBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgSFRUUCByZXNwb25zZSBib2R5CiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhYm9ydEhhbmRzaGFrZU9yRW1pdHdzQ2xpZW50RXJyb3Ioc2VydmVyLCByZXEsIHNvY2tldCwgY29kZSwgbWVzc2FnZSkgewogICAgaWYgKHNlcnZlci5saXN0ZW5lckNvdW50KCd3c0NsaWVudEVycm9yJykpIHsKICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZShlcnIsIGFib3J0SGFuZHNoYWtlT3JFbWl0d3NDbGllbnRFcnJvcik7CiAgICAgIHNlcnZlci5lbWl0KCd3c0NsaWVudEVycm9yJywgZXJyLCBzb2NrZXQsIHJlcSk7CiAgICB9IGVsc2UgewogICAgICBhYm9ydEhhbmRzaGFrZShzb2NrZXQsIGNvZGUsIG1lc3NhZ2UpOwogICAgfQogIH0KICByZXR1cm4gd2Vic29ja2V0U2VydmVyOwp9Cgp2YXIgd3M7CnZhciBoYXNSZXF1aXJlZFdzJDE7CmZ1bmN0aW9uIHJlcXVpcmVXcyQxKCkgewogIGlmIChoYXNSZXF1aXJlZFdzJDEpIHJldHVybiB3czsKICBoYXNSZXF1aXJlZFdzJDEgPSAxOwogIGNvbnN0IFdlYlNvY2tldCA9IHJlcXVpcmVXZWJzb2NrZXQoKTsKICBXZWJTb2NrZXQuY3JlYXRlV2ViU29ja2V0U3RyZWFtID0gcmVxdWlyZVN0cmVhbSgpOwogIFdlYlNvY2tldC5TZXJ2ZXIgPSByZXF1aXJlV2Vic29ja2V0U2VydmVyKCk7CiAgV2ViU29ja2V0LlJlY2VpdmVyID0gcmVxdWlyZVJlY2VpdmVyKCk7CiAgV2ViU29ja2V0LlNlbmRlciA9IHJlcXVpcmVTZW5kZXIoKTsKICBXZWJTb2NrZXQuV2ViU29ja2V0ID0gV2ViU29ja2V0OwogIFdlYlNvY2tldC5XZWJTb2NrZXRTZXJ2ZXIgPSBXZWJTb2NrZXQuU2VydmVyOwogIHdzID0gV2ViU29ja2V0OwogIHJldHVybiB3czsKfQoKdmFyIEJ1ZmZlcmVkRHVwbGV4ID0ge307Cgp2YXIgaGFzUmVxdWlyZWRCdWZmZXJlZER1cGxleDsKZnVuY3Rpb24gcmVxdWlyZUJ1ZmZlcmVkRHVwbGV4KCkgewogIGlmIChoYXNSZXF1aXJlZEJ1ZmZlcmVkRHVwbGV4KSByZXR1cm4gQnVmZmVyZWREdXBsZXg7CiAgaGFzUmVxdWlyZWRCdWZmZXJlZER1cGxleCA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlcmVkRHVwbGV4LCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgQnVmZmVyZWREdXBsZXguQnVmZmVyZWREdXBsZXggPSB2b2lkIDA7CiAgQnVmZmVyZWREdXBsZXgud3JpdGV2ID0gd3JpdGV2OwogIGNvbnN0IHJlYWRhYmxlX3N0cmVhbV8xID0gb3Vyc0V4cG9ydHM7CiAgY29uc3QgYnVmZmVyXzEgPSByZXF1aXJlJCQwJDM7CiAgZnVuY3Rpb24gd3JpdGV2KGNodW5rcywgY2IpIHsKICAgIGNvbnN0IGJ1ZmZlcnMgPSBuZXcgQXJyYXkoY2h1bmtzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodHlwZW9mIGNodW5rc1tpXS5jaHVuayA9PT0gJ3N0cmluZycpIHsKICAgICAgICBidWZmZXJzW2ldID0gYnVmZmVyXzEuQnVmZmVyLmZyb20oY2h1bmtzW2ldLmNodW5rLCAndXRmOCcpOwogICAgICB9IGVsc2UgewogICAgICAgIGJ1ZmZlcnNbaV0gPSBjaHVua3NbaV0uY2h1bms7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3dyaXRlKGJ1ZmZlcl8xLkJ1ZmZlci5jb25jYXQoYnVmZmVycyksICdiaW5hcnknLCBjYik7CiAgfQogIGxldCBCdWZmZXJlZER1cGxleCQxID0gY2xhc3MgQnVmZmVyZWREdXBsZXggZXh0ZW5kcyByZWFkYWJsZV9zdHJlYW1fMS5EdXBsZXggewogICAgY29uc3RydWN0b3Iob3B0cywgcHJveHksIHNvY2tldCkgewogICAgICBzdXBlcih7CiAgICAgICAgb2JqZWN0TW9kZTogdHJ1ZQogICAgICB9KTsKICAgICAgdGhpcy5wcm94eSA9IHByb3h5OwogICAgICB0aGlzLnNvY2tldCA9IHNvY2tldDsKICAgICAgdGhpcy53cml0ZVF1ZXVlID0gW107CiAgICAgIGlmICghb3B0cy5vYmplY3RNb2RlKSB7CiAgICAgICAgdGhpcy5fd3JpdGV2ID0gd3JpdGV2LmJpbmQodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5pc1NvY2tldE9wZW4gPSBmYWxzZTsKICAgICAgdGhpcy5wcm94eS5vbignZGF0YScsIGNodW5rID0+IHsKICAgICAgICBpZiAoIXRoaXMuZGVzdHJveWVkICYmIHRoaXMucmVhZGFibGUpIHsKICAgICAgICAgIHRoaXMucHVzaChjaHVuayk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIF9yZWFkKHNpemUpIHsKICAgICAgdGhpcy5wcm94eS5yZWFkKHNpemUpOwogICAgfQogICAgX3dyaXRlKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICAgICAgaWYgKCF0aGlzLmlzU29ja2V0T3BlbikgewogICAgICAgIHRoaXMud3JpdGVRdWV1ZS5wdXNoKHsKICAgICAgICAgIGNodW5rLAogICAgICAgICAgZW5jb2RpbmcsCiAgICAgICAgICBjYgogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMud3JpdGVUb1Byb3h5KGNodW5rLCBlbmNvZGluZywgY2IpOwogICAgICB9CiAgICB9CiAgICBfZmluYWwoY2FsbGJhY2spIHsKICAgICAgdGhpcy53cml0ZVF1ZXVlID0gW107CiAgICAgIHRoaXMucHJveHkuZW5kKGNhbGxiYWNrKTsKICAgIH0KICAgIF9kZXN0cm95KGVyciwgY2FsbGJhY2spIHsKICAgICAgdGhpcy53cml0ZVF1ZXVlID0gW107CiAgICAgIHRoaXMucHJveHkuZGVzdHJveSgpOwogICAgICBjYWxsYmFjayhlcnIpOwogICAgfQogICAgc29ja2V0UmVhZHkoKSB7CiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdCcpOwogICAgICB0aGlzLmlzU29ja2V0T3BlbiA9IHRydWU7CiAgICAgIHRoaXMucHJvY2Vzc1dyaXRlUXVldWUoKTsKICAgIH0KICAgIHdyaXRlVG9Qcm94eShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgICAgIGlmICh0aGlzLnByb3h5LndyaXRlKGNodW5rLCBlbmNvZGluZykgPT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy5wcm94eS5vbmNlKCdkcmFpbicsIGNiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYigpOwogICAgICB9CiAgICB9CiAgICBwcm9jZXNzV3JpdGVRdWV1ZSgpIHsKICAgICAgd2hpbGUgKHRoaXMud3JpdGVRdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgY2h1bmssCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGNiCiAgICAgICAgfSA9IHRoaXMud3JpdGVRdWV1ZS5zaGlmdCgpOwogICAgICAgIHRoaXMud3JpdGVUb1Byb3h5KGNodW5rLCBlbmNvZGluZywgY2IpOwogICAgICB9CiAgICB9CiAgfTsKICBCdWZmZXJlZER1cGxleC5CdWZmZXJlZER1cGxleCA9IEJ1ZmZlcmVkRHVwbGV4JDE7CiAgcmV0dXJuIEJ1ZmZlcmVkRHVwbGV4Owp9Cgp2YXIgaGFzUmVxdWlyZWRXczsKZnVuY3Rpb24gcmVxdWlyZVdzKCkgewogIGlmIChoYXNSZXF1aXJlZFdzKSByZXR1cm4gd3MkMTsKICBoYXNSZXF1aXJlZFdzID0gMTsKICB2YXIgX19pbXBvcnREZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAgICJkZWZhdWx0IjogbW9kCiAgICB9OwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdzJDEsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICB3cyQxLnN0cmVhbUJ1aWxkZXIgPSB3cyQxLmJyb3dzZXJTdHJlYW1CdWlsZGVyID0gdm9pZCAwOwogIGNvbnN0IGJ1ZmZlcl8xID0gcmVxdWlyZSQkMCQzOwogIGNvbnN0IHdzXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZVdzJDEoKSk7CiAgY29uc3QgZGVidWdfMSA9IF9faW1wb3J0RGVmYXVsdChzcmNFeHBvcnRzKTsKICBjb25zdCByZWFkYWJsZV9zdHJlYW1fMSA9IG91cnNFeHBvcnRzOwogIGNvbnN0IGlzX2Jyb3dzZXJfMSA9IF9faW1wb3J0RGVmYXVsdChpc0Jyb3dzZXIkMSk7CiAgY29uc3QgQnVmZmVyZWREdXBsZXhfMSA9IHJlcXVpcmVCdWZmZXJlZER1cGxleCgpOwogIGNvbnN0IGRlYnVnID0gKDAsIGRlYnVnXzEuZGVmYXVsdCkoJ21xdHRqczp3cycpOwogIGNvbnN0IFdTU19PUFRJT05TID0gWydyZWplY3RVbmF1dGhvcml6ZWQnLCAnY2EnLCAnY2VydCcsICdrZXknLCAncGZ4JywgJ3Bhc3NwaHJhc2UnXTsKICBmdW5jdGlvbiBidWlsZFVybChvcHRzLCBjbGllbnQpIHsKICAgIGxldCB1cmwgPSBgJHtvcHRzLnByb3RvY29sfTovLyR7b3B0cy5ob3N0bmFtZX06JHtvcHRzLnBvcnR9JHtvcHRzLnBhdGh9YDsKICAgIGlmICh0eXBlb2Ygb3B0cy50cmFuc2Zvcm1Xc1VybCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB1cmwgPSBvcHRzLnRyYW5zZm9ybVdzVXJsKHVybCwgb3B0cywgY2xpZW50KTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfQogIGZ1bmN0aW9uIHNldERlZmF1bHRPcHRzKG9wdHMpIHsKICAgIGNvbnN0IG9wdGlvbnMgPSBvcHRzOwogICAgaWYgKCFvcHRzLnBvcnQpIHsKICAgICAgaWYgKG9wdHMucHJvdG9jb2wgPT09ICd3c3MnKSB7CiAgICAgICAgb3B0aW9ucy5wb3J0ID0gNDQzOwogICAgICB9IGVsc2UgewogICAgICAgIG9wdGlvbnMucG9ydCA9IDgwOwogICAgICB9CiAgICB9CiAgICBpZiAoIW9wdHMucGF0aCkgewogICAgICBvcHRpb25zLnBhdGggPSAnLyc7CiAgICB9CiAgICBpZiAoIW9wdHMud3NPcHRpb25zKSB7CiAgICAgIG9wdGlvbnMud3NPcHRpb25zID0ge307CiAgICB9CiAgICBpZiAoIWlzX2Jyb3dzZXJfMS5kZWZhdWx0ICYmICFvcHRzLmZvcmNlTmF0aXZlV2ViU29ja2V0ICYmIG9wdHMucHJvdG9jb2wgPT09ICd3c3MnKSB7CiAgICAgIFdTU19PUFRJT05TLmZvckVhY2gocHJvcCA9PiB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvcHRzLCBwcm9wKSAmJiAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9wdHMud3NPcHRpb25zLCBwcm9wKSkgewogICAgICAgICAgb3B0aW9ucy53c09wdGlvbnNbcHJvcF0gPSBvcHRzW3Byb3BdOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gb3B0aW9uczsKICB9CiAgZnVuY3Rpb24gc2V0RGVmYXVsdEJyb3dzZXJPcHRzKG9wdHMpIHsKICAgIGNvbnN0IG9wdGlvbnMgPSBzZXREZWZhdWx0T3B0cyhvcHRzKTsKICAgIGlmICghb3B0aW9ucy5ob3N0bmFtZSkgewogICAgICBvcHRpb25zLmhvc3RuYW1lID0gb3B0aW9ucy5ob3N0OwogICAgfQogICAgaWYgKCFvcHRpb25zLmhvc3RuYW1lKSB7CiAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZGV0ZXJtaW5lIGhvc3QuIFNwZWNpZnkgaG9zdCBtYW51YWxseS4nKTsKICAgICAgfQogICAgICBjb25zdCBwYXJzZWQgPSBuZXcgVVJMKGRvY3VtZW50LlVSTCk7CiAgICAgIG9wdGlvbnMuaG9zdG5hbWUgPSBwYXJzZWQuaG9zdG5hbWU7CiAgICAgIGlmICghb3B0aW9ucy5wb3J0KSB7CiAgICAgICAgb3B0aW9ucy5wb3J0ID0gTnVtYmVyKHBhcnNlZC5wb3J0KTsKICAgICAgfQogICAgfQogICAgaWYgKG9wdGlvbnMub2JqZWN0TW9kZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIG9wdGlvbnMub2JqZWN0TW9kZSA9ICEob3B0aW9ucy5iaW5hcnkgPT09IHRydWUgfHwgb3B0aW9ucy5iaW5hcnkgPT09IHVuZGVmaW5lZCk7CiAgICB9CiAgICByZXR1cm4gb3B0aW9uczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlV2ViU29ja2V0KGNsaWVudCwgdXJsLCBvcHRzKSB7CiAgICBkZWJ1ZygnY3JlYXRlV2ViU29ja2V0Jyk7CiAgICBkZWJ1ZyhgcHJvdG9jb2w6ICR7b3B0cy5wcm90b2NvbElkfSAke29wdHMucHJvdG9jb2xWZXJzaW9ufWApOwogICAgY29uc3Qgd2Vic29ja2V0U3ViUHJvdG9jb2wgPSBvcHRzLnByb3RvY29sSWQgPT09ICdNUUlzZHAnICYmIG9wdHMucHJvdG9jb2xWZXJzaW9uID09PSAzID8gJ21xdHR2My4xJyA6ICdtcXR0JzsKICAgIGRlYnVnKGBjcmVhdGluZyBuZXcgV2Vic29ja2V0IGZvciB1cmw6ICR7dXJsfSBhbmQgcHJvdG9jb2w6ICR7d2Vic29ja2V0U3ViUHJvdG9jb2x9YCk7CiAgICBsZXQgc29ja2V0OwogICAgaWYgKG9wdHMuY3JlYXRlV2Vic29ja2V0KSB7CiAgICAgIHNvY2tldCA9IG9wdHMuY3JlYXRlV2Vic29ja2V0KHVybCwgW3dlYnNvY2tldFN1YlByb3RvY29sXSwgb3B0cyk7CiAgICB9IGVsc2UgewogICAgICBzb2NrZXQgPSBuZXcgd3NfMS5kZWZhdWx0KHVybCwgW3dlYnNvY2tldFN1YlByb3RvY29sXSwgb3B0cy53c09wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHNvY2tldDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQnJvd3NlcldlYlNvY2tldChjbGllbnQsIG9wdHMpIHsKICAgIGNvbnN0IHdlYnNvY2tldFN1YlByb3RvY29sID0gb3B0cy5wcm90b2NvbElkID09PSAnTVFJc2RwJyAmJiBvcHRzLnByb3RvY29sVmVyc2lvbiA9PT0gMyA/ICdtcXR0djMuMScgOiAnbXF0dCc7CiAgICBjb25zdCB1cmwgPSBidWlsZFVybChvcHRzLCBjbGllbnQpOwogICAgbGV0IHNvY2tldDsKICAgIGlmIChvcHRzLmNyZWF0ZVdlYnNvY2tldCkgewogICAgICBzb2NrZXQgPSBvcHRzLmNyZWF0ZVdlYnNvY2tldCh1cmwsIFt3ZWJzb2NrZXRTdWJQcm90b2NvbF0sIG9wdHMpOwogICAgfSBlbHNlIHsKICAgICAgc29ja2V0ID0gbmV3IFdlYlNvY2tldCh1cmwsIFt3ZWJzb2NrZXRTdWJQcm90b2NvbF0pOwogICAgfQogICAgc29ja2V0LmJpbmFyeVR5cGUgPSAnYXJyYXlidWZmZXInOwogICAgcmV0dXJuIHNvY2tldDsKICB9CiAgY29uc3Qgc3RyZWFtQnVpbGRlciA9IChjbGllbnQsIG9wdHMpID0+IHsKICAgIGRlYnVnKCdzdHJlYW1CdWlsZGVyJyk7CiAgICBjb25zdCBvcHRpb25zID0gc2V0RGVmYXVsdE9wdHMob3B0cyk7CiAgICBvcHRpb25zLmhvc3RuYW1lID0gb3B0aW9ucy5ob3N0bmFtZSB8fCBvcHRpb25zLmhvc3QgfHwgJ2xvY2FsaG9zdCc7CiAgICBjb25zdCB1cmwgPSBidWlsZFVybChvcHRpb25zLCBjbGllbnQpOwogICAgY29uc3Qgc29ja2V0ID0gY3JlYXRlV2ViU29ja2V0KGNsaWVudCwgdXJsLCBvcHRpb25zKTsKICAgIGNvbnN0IHdlYlNvY2tldFN0cmVhbSA9IHdzXzEuZGVmYXVsdC5jcmVhdGVXZWJTb2NrZXRTdHJlYW0oc29ja2V0LCBvcHRpb25zLndzT3B0aW9ucyk7CiAgICB3ZWJTb2NrZXRTdHJlYW1bJ3VybCddID0gdXJsOwogICAgc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgd2ViU29ja2V0U3RyZWFtLmRlc3Ryb3koKTsKICAgIH0pOwogICAgcmV0dXJuIHdlYlNvY2tldFN0cmVhbTsKICB9OwogIHdzJDEuc3RyZWFtQnVpbGRlciA9IHN0cmVhbUJ1aWxkZXI7CiAgY29uc3QgYnJvd3NlclN0cmVhbUJ1aWxkZXIgPSAoY2xpZW50LCBvcHRzKSA9PiB7CiAgICBkZWJ1ZygnYnJvd3NlclN0cmVhbUJ1aWxkZXInKTsKICAgIGxldCBzdHJlYW07CiAgICBjb25zdCBvcHRpb25zID0gc2V0RGVmYXVsdEJyb3dzZXJPcHRzKG9wdHMpOwogICAgY29uc3QgYnVmZmVyU2l6ZSA9IG9wdGlvbnMuYnJvd3NlckJ1ZmZlclNpemUgfHwgMTAyNCAqIDUxMjsKICAgIGNvbnN0IGJ1ZmZlclRpbWVvdXQgPSBvcHRzLmJyb3dzZXJCdWZmZXJUaW1lb3V0IHx8IDEwMDA7CiAgICBjb25zdCBjb2VyY2VUb0J1ZmZlciA9ICFvcHRzLm9iamVjdE1vZGU7CiAgICBjb25zdCBzb2NrZXQgPSBjcmVhdGVCcm93c2VyV2ViU29ja2V0KGNsaWVudCwgb3B0cyk7CiAgICBjb25zdCBwcm94eSA9IGJ1aWxkUHJveHkob3B0cywgc29ja2V0V3JpdGVCcm93c2VyLCBzb2NrZXRFbmRCcm93c2VyKTsKICAgIGlmICghb3B0cy5vYmplY3RNb2RlKSB7CiAgICAgIHByb3h5Ll93cml0ZXYgPSBCdWZmZXJlZER1cGxleF8xLndyaXRldi5iaW5kKHByb3h5KTsKICAgIH0KICAgIHByb3h5Lm9uKCdjbG9zZScsICgpID0+IHsKICAgICAgc29ja2V0LmNsb3NlKCk7CiAgICB9KTsKICAgIGNvbnN0IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID0gdHlwZW9mIHNvY2tldC5hZGRFdmVudExpc3RlbmVyICE9PSAndW5kZWZpbmVkJzsKICAgIGlmIChzb2NrZXQucmVhZHlTdGF0ZSA9PT0gc29ja2V0Lk9QRU4pIHsKICAgICAgc3RyZWFtID0gcHJveHk7CiAgICAgIHN0cmVhbS5zb2NrZXQgPSBzb2NrZXQ7CiAgICB9IGVsc2UgewogICAgICBzdHJlYW0gPSBuZXcgQnVmZmVyZWREdXBsZXhfMS5CdWZmZXJlZER1cGxleChvcHRzLCBwcm94eSwgc29ja2V0KTsKICAgICAgaWYgKGV2ZW50TGlzdGVuZXJTdXBwb3J0KSB7CiAgICAgICAgc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoJ29wZW4nLCBvbk9wZW4pOwogICAgICB9IGVsc2UgewogICAgICAgIHNvY2tldC5vbm9wZW4gPSBvbk9wZW47CiAgICAgIH0KICAgIH0KICAgIGlmIChldmVudExpc3RlbmVyU3VwcG9ydCkgewogICAgICBzb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignY2xvc2UnLCBvbkNsb3NlKTsKICAgICAgc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25FcnJvcik7CiAgICAgIHNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgb25NZXNzYWdlKTsKICAgIH0gZWxzZSB7CiAgICAgIHNvY2tldC5vbmNsb3NlID0gb25DbG9zZTsKICAgICAgc29ja2V0Lm9uZXJyb3IgPSBvbkVycm9yOwogICAgICBzb2NrZXQub25tZXNzYWdlID0gb25NZXNzYWdlOwogICAgfQogICAgZnVuY3Rpb24gYnVpbGRQcm94eShwT3B0aW9ucywgc29ja2V0V3JpdGUsIHNvY2tldEVuZCkgewogICAgICBjb25zdCBfcHJveHkgPSBuZXcgcmVhZGFibGVfc3RyZWFtXzEuVHJhbnNmb3JtKHsKICAgICAgICBvYmplY3RNb2RlOiBwT3B0aW9ucy5vYmplY3RNb2RlCiAgICAgIH0pOwogICAgICBfcHJveHkuX3dyaXRlID0gc29ja2V0V3JpdGU7CiAgICAgIF9wcm94eS5fZmx1c2ggPSBzb2NrZXRFbmQ7CiAgICAgIHJldHVybiBfcHJveHk7CiAgICB9CiAgICBmdW5jdGlvbiBvbk9wZW4oKSB7CiAgICAgIGRlYnVnKCdXZWJTb2NrZXQgb25PcGVuJyk7CiAgICAgIGlmIChzdHJlYW0gaW5zdGFuY2VvZiBCdWZmZXJlZER1cGxleF8xLkJ1ZmZlcmVkRHVwbGV4KSB7CiAgICAgICAgc3RyZWFtLnNvY2tldFJlYWR5KCk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG9uQ2xvc2UoZXZlbnQpIHsKICAgICAgZGVidWcoJ1dlYlNvY2tldCBvbkNsb3NlJywgZXZlbnQpOwogICAgICBzdHJlYW0uZW5kKCk7CiAgICAgIHN0cmVhbS5kZXN0cm95KCk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkVycm9yKGVycikgewogICAgICBkZWJ1ZygnV2ViU29ja2V0IG9uRXJyb3InLCBlcnIpOwogICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignV2ViU29ja2V0IGVycm9yJyk7CiAgICAgIGVycm9yWydldmVudCddID0gZXJyOwogICAgICBzdHJlYW0uZGVzdHJveShlcnJvcik7CiAgICB9CiAgICBhc3luYyBmdW5jdGlvbiBvbk1lc3NhZ2UoZXZlbnQpIHsKICAgICAgaWYgKCFwcm94eSB8fCBwcm94eS5kZXN0cm95ZWQgfHwgIXByb3h5LnJlYWRhYmxlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGxldCB7CiAgICAgICAgZGF0YQogICAgICB9ID0gZXZlbnQ7CiAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIGRhdGEgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShkYXRhKTtlbHNlIGlmIChkYXRhIGluc3RhbmNlb2YgQmxvYikgZGF0YSA9IGJ1ZmZlcl8xLkJ1ZmZlci5mcm9tKGF3YWl0IG5ldyBSZXNwb25zZShkYXRhKS5hcnJheUJ1ZmZlcigpKTtlbHNlIGRhdGEgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShkYXRhLCAndXRmOCcpOwogICAgICBwcm94eS5wdXNoKGRhdGEpOwogICAgfQogICAgZnVuY3Rpb24gc29ja2V0V3JpdGVCcm93c2VyKGNodW5rLCBlbmMsIG5leHQpIHsKICAgICAgaWYgKHNvY2tldC5idWZmZXJlZEFtb3VudCA+IGJ1ZmZlclNpemUpIHsKICAgICAgICBzZXRUaW1lb3V0KHNvY2tldFdyaXRlQnJvd3NlciwgYnVmZmVyVGltZW91dCwgY2h1bmssIGVuYywgbmV4dCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChjb2VyY2VUb0J1ZmZlciAmJiB0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY2h1bmsgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShjaHVuaywgJ3V0ZjgnKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIHNvY2tldC5zZW5kKGNodW5rKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgcmV0dXJuIG5leHQoZXJyKTsKICAgICAgfQogICAgICBuZXh0KCk7CiAgICB9CiAgICBmdW5jdGlvbiBzb2NrZXRFbmRCcm93c2VyKGRvbmUpIHsKICAgICAgc29ja2V0LmNsb3NlKCk7CiAgICAgIGRvbmUoKTsKICAgIH0KICAgIHJldHVybiBzdHJlYW07CiAgfTsKICB3cyQxLmJyb3dzZXJTdHJlYW1CdWlsZGVyID0gYnJvd3NlclN0cmVhbUJ1aWxkZXI7CiAgcmV0dXJuIHdzJDE7Cn0KCnZhciB0Y3AgPSB7fTsKCnZhciBzb2NrcyA9IHt9OwoKdmFyIGJ1aWxkID0ge307Cgp2YXIgc29ja3NjbGllbnQgPSB7fTsKCnZhciBzbWFydGJ1ZmZlciA9IHt9OwoKdmFyIHV0aWxzID0ge307Cgp2YXIgaGFzUmVxdWlyZWRVdGlsczsKZnVuY3Rpb24gcmVxdWlyZVV0aWxzKCkgewogIGlmIChoYXNSZXF1aXJlZFV0aWxzKSByZXR1cm4gdXRpbHM7CiAgaGFzUmVxdWlyZWRVdGlscyA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHV0aWxzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgY29uc3QgYnVmZmVyXzEgPSByZXF1aXJlJCQwJDM7CiAgLyoqCiAgICogRXJyb3Igc3RyaW5ncwogICAqLwogIGNvbnN0IEVSUk9SUyA9IHsKICAgIElOVkFMSURfRU5DT0RJTkc6ICdJbnZhbGlkIGVuY29kaW5nIHByb3ZpZGVkLiBQbGVhc2Ugc3BlY2lmeSBhIHZhbGlkIGVuY29kaW5nIHRoZSBpbnRlcm5hbCBOb2RlLmpzIEJ1ZmZlciBzdXBwb3J0cy4nLAogICAgSU5WQUxJRF9TTUFSVEJVRkZFUl9TSVpFOiAnSW52YWxpZCBzaXplIHByb3ZpZGVkLiBTaXplIG11c3QgYmUgYSB2YWxpZCBpbnRlZ2VyIGdyZWF0ZXIgdGhhbiB6ZXJvLicsCiAgICBJTlZBTElEX1NNQVJUQlVGRkVSX0JVRkZFUjogJ0ludmFsaWQgQnVmZmVyIHByb3ZpZGVkIGluIFNtYXJ0QnVmZmVyT3B0aW9ucy4nLAogICAgSU5WQUxJRF9TTUFSVEJVRkZFUl9PQkpFQ1Q6ICdJbnZhbGlkIFNtYXJ0QnVmZmVyT3B0aW9ucyBvYmplY3Qgc3VwcGxpZWQgdG8gU21hcnRCdWZmZXIgY29uc3RydWN0b3Igb3IgZmFjdG9yeSBtZXRob2RzLicsCiAgICBJTlZBTElEX09GRlNFVDogJ0FuIGludmFsaWQgb2Zmc2V0IHZhbHVlIHdhcyBwcm92aWRlZC4nLAogICAgSU5WQUxJRF9PRkZTRVRfTk9OX05VTUJFUjogJ0FuIGludmFsaWQgb2Zmc2V0IHZhbHVlIHdhcyBwcm92aWRlZC4gQSBudW1lcmljIHZhbHVlIGlzIHJlcXVpcmVkLicsCiAgICBJTlZBTElEX0xFTkdUSDogJ0FuIGludmFsaWQgbGVuZ3RoIHZhbHVlIHdhcyBwcm92aWRlZC4nLAogICAgSU5WQUxJRF9MRU5HVEhfTk9OX05VTUJFUjogJ0FuIGludmFsaWQgbGVuZ3RoIHZhbHVlIHdhcyBwcm92aXZlZC4gQSBudW1lcmljIHZhbHVlIGlzIHJlcXVpcmVkLicsCiAgICBJTlZBTElEX1RBUkdFVF9PRkZTRVQ6ICdUYXJnZXQgb2Zmc2V0IGlzIGJleW9uZCB0aGUgYm91bmRzIG9mIHRoZSBpbnRlcm5hbCBTbWFydEJ1ZmZlciBkYXRhLicsCiAgICBJTlZBTElEX1RBUkdFVF9MRU5HVEg6ICdTcGVjaWZpZWQgbGVuZ3RoIHZhbHVlIG1vdmVzIGN1cnNvciBiZXlvbmcgdGhlIGJvdW5kcyBvZiB0aGUgaW50ZXJuYWwgU21hcnRCdWZmZXIgZGF0YS4nLAogICAgSU5WQUxJRF9SRUFEX0JFWU9ORF9CT1VORFM6ICdBdHRlbXB0ZWQgdG8gcmVhZCBiZXlvbmQgdGhlIGJvdW5kcyBvZiB0aGUgbWFuYWdlZCBkYXRhLicsCiAgICBJTlZBTElEX1dSSVRFX0JFWU9ORF9CT1VORFM6ICdBdHRlbXB0ZWQgdG8gd3JpdGUgYmV5b25kIHRoZSBib3VuZHMgb2YgdGhlIG1hbmFnZWQgZGF0YS4nCiAgfTsKICB1dGlscy5FUlJPUlMgPSBFUlJPUlM7CiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gZW5jb2RpbmcgaXMgYSB2YWxpZCBCdWZmZXIgZW5jb2RpbmcuIChUaHJvd3MgYW4gZXhjZXB0aW9uIGlmIGNoZWNrIGZhaWxzKQogICAqCiAgICogQHBhcmFtIHsgU3RyaW5nIH0gZW5jb2RpbmcgVGhlIGVuY29kaW5nIHN0cmluZyB0byBjaGVjay4KICAgKi8KICBmdW5jdGlvbiBjaGVja0VuY29kaW5nKGVuY29kaW5nKSB7CiAgICBpZiAoIWJ1ZmZlcl8xLkJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoRVJST1JTLklOVkFMSURfRU5DT0RJTkcpOwogICAgfQogIH0KICB1dGlscy5jaGVja0VuY29kaW5nID0gY2hlY2tFbmNvZGluZzsKICAvKioKICAgKiBDaGVja3MgaWYgYSBnaXZlbiBudW1iZXIgaXMgYSBmaW5pdGUgaW50ZWdlci4gKFRocm93cyBhbiBleGNlcHRpb24gaWYgY2hlY2sgZmFpbHMpCiAgICoKICAgKiBAcGFyYW0geyBOdW1iZXIgfSB2YWx1ZSBUaGUgbnVtYmVyIHZhbHVlIHRvIGNoZWNrLgogICAqLwogIGZ1bmN0aW9uIGlzRmluaXRlSW50ZWdlcih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUodmFsdWUpICYmIGlzSW50ZWdlcih2YWx1ZSk7CiAgfQogIHV0aWxzLmlzRmluaXRlSW50ZWdlciA9IGlzRmluaXRlSW50ZWdlcjsKICAvKioKICAgKiBDaGVja3MgaWYgYW4gb2Zmc2V0L2xlbmd0aCB2YWx1ZSBpcyB2YWxpZC4gKFRocm93cyBhbiBleGNlcHRpb24gaWYgY2hlY2sgZmFpbHMpCiAgICoKICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqIEBwYXJhbSBvZmZzZXQgVHJ1ZSBpZiBjaGVja2luZyBhbiBvZmZzZXQsIGZhbHNlIGlmIGNoZWNraW5nIGEgbGVuZ3RoLgogICAqLwogIGZ1bmN0aW9uIGNoZWNrT2Zmc2V0T3JMZW5ndGhWYWx1ZSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICAvLyBDaGVjayBmb3Igbm9uIGZpbml0ZS9ub24gaW50ZWdlcnMKICAgICAgaWYgKCFpc0Zpbml0ZUludGVnZXIodmFsdWUpIHx8IHZhbHVlIDwgMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihvZmZzZXQgPyBFUlJPUlMuSU5WQUxJRF9PRkZTRVQgOiBFUlJPUlMuSU5WQUxJRF9MRU5HVEgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3Iob2Zmc2V0ID8gRVJST1JTLklOVkFMSURfT0ZGU0VUX05PTl9OVU1CRVIgOiBFUlJPUlMuSU5WQUxJRF9MRU5HVEhfTk9OX05VTUJFUik7CiAgICB9CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBhIGxlbmd0aCB2YWx1ZSBpcyB2YWxpZC4gKFRocm93cyBhbiBleGNlcHRpb24gaWYgY2hlY2sgZmFpbHMpCiAgICoKICAgKiBAcGFyYW0geyBOdW1iZXIgfSBsZW5ndGggVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqLwogIGZ1bmN0aW9uIGNoZWNrTGVuZ3RoVmFsdWUobGVuZ3RoKSB7CiAgICBjaGVja09mZnNldE9yTGVuZ3RoVmFsdWUobGVuZ3RoLCBmYWxzZSk7CiAgfQogIHV0aWxzLmNoZWNrTGVuZ3RoVmFsdWUgPSBjaGVja0xlbmd0aFZhbHVlOwogIC8qKgogICAqIENoZWNrcyBpZiBhIG9mZnNldCB2YWx1ZSBpcyB2YWxpZC4gKFRocm93cyBhbiBleGNlcHRpb24gaWYgY2hlY2sgZmFpbHMpCiAgICoKICAgKiBAcGFyYW0geyBOdW1iZXIgfSBvZmZzZXQgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAqLwogIGZ1bmN0aW9uIGNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KSB7CiAgICBjaGVja09mZnNldE9yTGVuZ3RoVmFsdWUob2Zmc2V0LCB0cnVlKTsKICB9CiAgdXRpbHMuY2hlY2tPZmZzZXRWYWx1ZSA9IGNoZWNrT2Zmc2V0VmFsdWU7CiAgLyoqCiAgICogQ2hlY2tzIGlmIGEgdGFyZ2V0IG9mZnNldCB2YWx1ZSBpcyBvdXQgb2YgYm91bmRzLiAoVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZiBjaGVjayBmYWlscykKICAgKgogICAqIEBwYXJhbSB7IE51bWJlciB9IG9mZnNldCBUaGUgb2Zmc2V0IHZhbHVlIHRvIGNoZWNrLgogICAqIEBwYXJhbSB7IFNtYXJ0QnVmZmVyIH0gYnVmZiBUaGUgU21hcnRCdWZmZXIgaW5zdGFuY2UgdG8gY2hlY2sgYWdhaW5zdC4KICAgKi8KICBmdW5jdGlvbiBjaGVja1RhcmdldE9mZnNldChvZmZzZXQsIGJ1ZmYpIHsKICAgIGlmIChvZmZzZXQgPCAwIHx8IG9mZnNldCA+IGJ1ZmYubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihFUlJPUlMuSU5WQUxJRF9UQVJHRVRfT0ZGU0VUKTsKICAgIH0KICB9CiAgdXRpbHMuY2hlY2tUYXJnZXRPZmZzZXQgPSBjaGVja1RhcmdldE9mZnNldDsKICAvKioKICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYSBnaXZlbiBudW1iZXIgaXMgYSBpbnRlZ2VyLgogICAqIEBwYXJhbSB2YWx1ZSBUaGUgbnVtYmVyIHRvIGNoZWNrLgogICAqLwogIGZ1bmN0aW9uIGlzSW50ZWdlcih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUodmFsdWUpICYmIE1hdGguZmxvb3IodmFsdWUpID09PSB2YWx1ZTsKICB9CiAgLyoqCiAgICogVGhyb3dzIGlmIE5vZGUuanMgdmVyc2lvbiBpcyB0b28gbG93IHRvIHN1cHBvcnQgYmlnaW50CiAgICovCiAgZnVuY3Rpb24gYmlnSW50QW5kQnVmZmVySW50NjRDaGVjayhidWZmZXJNZXRob2QpIHsKICAgIGlmICh0eXBlb2YgQmlnSW50ID09PSAndW5kZWZpbmVkJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsYXRmb3JtIGRvZXMgbm90IHN1cHBvcnQgSlMgQmlnSW50IHR5cGUuJyk7CiAgICB9CiAgICBpZiAodHlwZW9mIGJ1ZmZlcl8xLkJ1ZmZlci5wcm90b3R5cGVbYnVmZmVyTWV0aG9kXSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBQbGF0Zm9ybSBkb2VzIG5vdCBzdXBwb3J0IEJ1ZmZlci5wcm90b3R5cGUuJHtidWZmZXJNZXRob2R9LmApOwogICAgfQogIH0KICB1dGlscy5iaWdJbnRBbmRCdWZmZXJJbnQ2NENoZWNrID0gYmlnSW50QW5kQnVmZmVySW50NjRDaGVjazsKICByZXR1cm4gdXRpbHM7Cn0KCnZhciBoYXNSZXF1aXJlZFNtYXJ0YnVmZmVyOwpmdW5jdGlvbiByZXF1aXJlU21hcnRidWZmZXIoKSB7CiAgaWYgKGhhc1JlcXVpcmVkU21hcnRidWZmZXIpIHJldHVybiBzbWFydGJ1ZmZlcjsKICBoYXNSZXF1aXJlZFNtYXJ0YnVmZmVyID0gMTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc21hcnRidWZmZXIsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb25zdCB1dGlsc18xID0gcmVxdWlyZVV0aWxzKCk7CiAgLy8gVGhlIGRlZmF1bHQgQnVmZmVyIHNpemUgaWYgb25lIGlzIG5vdCBwcm92aWRlZC4KICBjb25zdCBERUZBVUxUX1NNQVJUQlVGRkVSX1NJWkUgPSA0MDk2OwogIC8vIFRoZSBkZWZhdWx0IHN0cmluZyBlbmNvZGluZyB0byB1c2UgZm9yIHJlYWRpbmcvd3JpdGluZyBzdHJpbmdzLgogIGNvbnN0IERFRkFVTFRfU01BUlRCVUZGRVJfRU5DT0RJTkcgPSAndXRmOCc7CiAgY2xhc3MgU21hcnRCdWZmZXIgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEBwYXJhbSBvcHRpb25zIHsgU21hcnRCdWZmZXJPcHRpb25zIH0gVGhlIFNtYXJ0QnVmZmVyT3B0aW9ucyB0byBhcHBseSB0byB0aGlzIGluc3RhbmNlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5fZW5jb2RpbmcgPSBERUZBVUxUX1NNQVJUQlVGRkVSX0VOQ09ESU5HOwogICAgICB0aGlzLl93cml0ZU9mZnNldCA9IDA7CiAgICAgIHRoaXMuX3JlYWRPZmZzZXQgPSAwOwogICAgICBpZiAoU21hcnRCdWZmZXIuaXNTbWFydEJ1ZmZlck9wdGlvbnMob3B0aW9ucykpIHsKICAgICAgICAvLyBDaGVja3MgZm9yIGVuY29kaW5nCiAgICAgICAgaWYgKG9wdGlvbnMuZW5jb2RpbmcpIHsKICAgICAgICAgIHV0aWxzXzEuY2hlY2tFbmNvZGluZyhvcHRpb25zLmVuY29kaW5nKTsKICAgICAgICAgIHRoaXMuX2VuY29kaW5nID0gb3B0aW9ucy5lbmNvZGluZzsKICAgICAgICB9CiAgICAgICAgLy8gQ2hlY2tzIGZvciBpbml0aWFsIHNpemUgbGVuZ3RoCiAgICAgICAgaWYgKG9wdGlvbnMuc2l6ZSkgewogICAgICAgICAgaWYgKHV0aWxzXzEuaXNGaW5pdGVJbnRlZ2VyKG9wdGlvbnMuc2l6ZSkgJiYgb3B0aW9ucy5zaXplID4gMCkgewogICAgICAgICAgICB0aGlzLl9idWZmID0gQnVmZmVyLmFsbG9jVW5zYWZlKG9wdGlvbnMuc2l6ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXRpbHNfMS5FUlJPUlMuSU5WQUxJRF9TTUFSVEJVRkZFUl9TSVpFKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIENoZWNrIGZvciBpbml0aWFsIEJ1ZmZlcgogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5idWZmKSB7CiAgICAgICAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKG9wdGlvbnMuYnVmZikpIHsKICAgICAgICAgICAgdGhpcy5fYnVmZiA9IG9wdGlvbnMuYnVmZjsKICAgICAgICAgICAgdGhpcy5sZW5ndGggPSBvcHRpb25zLmJ1ZmYubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHV0aWxzXzEuRVJST1JTLklOVkFMSURfU01BUlRCVUZGRVJfQlVGRkVSKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYnVmZiA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShERUZBVUxUX1NNQVJUQlVGRkVSX1NJWkUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBzb21ldGhpbmcgd2FzIHBhc3NlZCBidXQgaXQncyBub3QgYSBTbWFydEJ1ZmZlck9wdGlvbnMgb2JqZWN0CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHV0aWxzXzEuRVJST1JTLklOVkFMSURfU01BUlRCVUZGRVJfT0JKRUNUKTsKICAgICAgICB9CiAgICAgICAgLy8gT3RoZXJ3aXNlIGRlZmF1bHQgdG8gc2FuZSBvcHRpb25zCiAgICAgICAgdGhpcy5fYnVmZiA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShERUZBVUxUX1NNQVJUQlVGRkVSX1NJWkUpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgU21hcnRCdWZmZXIgaW5zdGFuY2Ugd2l0aCB0aGUgcHJvdmlkZWQgaW50ZXJuYWwgQnVmZmVyIHNpemUgYW5kIG9wdGlvbmFsIGVuY29kaW5nLgogICAgICoKICAgICAqIEBwYXJhbSBzaXplIHsgTnVtYmVyIH0gVGhlIHNpemUgb2YgdGhlIGludGVybmFsIEJ1ZmZlci4KICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UgZm9yIHN0cmluZ3MuCiAgICAgKgogICAgICogQHJldHVybiB7IFNtYXJ0QnVmZmVyIH0KICAgICAqLwogICAgc3RhdGljIGZyb21TaXplKHNpemUsIGVuY29kaW5nKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcyh7CiAgICAgICAgc2l6ZTogc2l6ZSwKICAgICAgICBlbmNvZGluZzogZW5jb2RpbmcKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgU21hcnRCdWZmZXIgaW5zdGFuY2Ugd2l0aCB0aGUgcHJvdmlkZWQgQnVmZmVyIGFuZCBvcHRpb25hbCBlbmNvZGluZy4KICAgICAqCiAgICAgKiBAcGFyYW0gYnVmZmVyIHsgQnVmZmVyIH0gVGhlIEJ1ZmZlciB0byB1c2UgYXMgdGhlIGludGVybmFsIEJ1ZmZlciB2YWx1ZS4KICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UgZm9yIHN0cmluZ3MuCiAgICAgKgogICAgICogQHJldHVybiB7IFNtYXJ0QnVmZmVyIH0KICAgICAqLwogICAgc3RhdGljIGZyb21CdWZmZXIoYnVmZiwgZW5jb2RpbmcpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzKHsKICAgICAgICBidWZmOiBidWZmLAogICAgICAgIGVuY29kaW5nOiBlbmNvZGluZwogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBTbWFydEJ1ZmZlciBpbnN0YW5jZSB3aXRoIHRoZSBwcm92aWRlZCBTbWFydEJ1ZmZlck9wdGlvbnMgb3B0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyB7IFNtYXJ0QnVmZmVyT3B0aW9ucyB9IFRoZSBvcHRpb25zIHRvIHVzZSB3aGVuIGNyZWF0aW5nIHRoZSBTbWFydEJ1ZmZlciBpbnN0YW5jZS4KICAgICAqLwogICAgc3RhdGljIGZyb21PcHRpb25zKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzKG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBUeXBlIGNoZWNraW5nIGZ1bmN0aW9uIHRoYXQgZGV0ZXJtaW5lcyBpZiBhbiBvYmplY3QgaXMgYSBTbWFydEJ1ZmZlck9wdGlvbnMgb2JqZWN0LgogICAgICovCiAgICBzdGF0aWMgaXNTbWFydEJ1ZmZlck9wdGlvbnMob3B0aW9ucykgewogICAgICBjb25zdCBjYXN0T3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHJldHVybiBjYXN0T3B0aW9ucyAmJiAoY2FzdE9wdGlvbnMuZW5jb2RpbmcgIT09IHVuZGVmaW5lZCB8fCBjYXN0T3B0aW9ucy5zaXplICE9PSB1bmRlZmluZWQgfHwgY2FzdE9wdGlvbnMuYnVmZiAhPT0gdW5kZWZpbmVkKTsKICAgIH0KICAgIC8vIFNpZ25lZCBpbnRlZ2VycwogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBJbnQ4IHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgcmVhZCBwb3NpdGlvbiBvciBhbiBvcHRpb25hbGx5IHByb3ZpZGVkIG9mZnNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byByZWFkIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0KICAgICAqLwogICAgcmVhZEludDgob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCwgMSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gSW50MTZCRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWRJbnQxNkJFKG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2QkUsIDIsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlYWRzIGFuIEludDE2TEUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBOdW1iZXIgfQogICAgICovCiAgICByZWFkSW50MTZMRShvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlYWROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFLCAyLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBJbnQzMkJFIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgcmVhZCBwb3NpdGlvbiBvciBhbiBvcHRpb25hbGx5IHByb3ZpZGVkIG9mZnNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byByZWFkIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0KICAgICAqLwogICAgcmVhZEludDMyQkUob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJCRSwgNCwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gSW50MzJMRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWRJbnQzMkxFKG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUsIDQsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlYWRzIGEgQmlnSW50NjRCRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IEJpZ0ludCB9CiAgICAgKi8KICAgIHJlYWRCaWdJbnQ2NEJFKG9mZnNldCkgewogICAgICB1dGlsc18xLmJpZ0ludEFuZEJ1ZmZlckludDY0Q2hlY2soJ3JlYWRCaWdJbnQ2NEJFJyk7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnSW50NjRCRSwgOCwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYSBCaWdJbnQ2NExFIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgcmVhZCBwb3NpdGlvbiBvciBhbiBvcHRpb25hbGx5IHByb3ZpZGVkIG9mZnNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byByZWFkIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICAgKiBAcmV0dXJuIHsgQmlnSW50IH0KICAgICAqLwogICAgcmVhZEJpZ0ludDY0TEUob2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygncmVhZEJpZ0ludDY0TEUnKTsKICAgICAgcmV0dXJuIHRoaXMuX3JlYWROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLnJlYWRCaWdJbnQ2NExFLCA4LCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYW4gSW50OCB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlSW50OCh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHRoaXMuX3dyaXRlTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDgsIDEsIHZhbHVlLCBvZmZzZXQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhbiBJbnQ4IHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEludDgodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDgsIDEsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYW4gSW50MTZCRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlSW50MTZCRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkJFLCAyLCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhbiBJbnQxNkJFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEludDE2QkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUsIDIsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYW4gSW50MTZMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlSW50MTZMRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFLCAyLCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhbiBJbnQxNkxFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEludDE2TEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2TEUsIDIsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYW4gSW50MzJCRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlSW50MzJCRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkJFLCA0LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhbiBJbnQzMkJFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEludDMyQkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYW4gSW50MzJMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlSW50MzJMRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkxFLCA0LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhbiBJbnQzMkxFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEludDMyTEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYSBCaWdJbnQ2NEJFIHZhbHVlIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uIChvciBhdCBvcHRpb25hbCBvZmZzZXQpLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IEJpZ0ludCB9IFRoZSB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVCaWdJbnQ2NEJFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgdXRpbHNfMS5iaWdJbnRBbmRCdWZmZXJJbnQ2NENoZWNrKCd3cml0ZUJpZ0ludDY0QkUnKTsKICAgICAgcmV0dXJuIHRoaXMuX3dyaXRlTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUJpZ0ludDY0QkUsIDgsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGEgQmlnSW50NjRCRSB2YWx1ZSBhdCB0aGUgZ2l2ZW4gb2Zmc2V0IHZhbHVlLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IEJpZ0ludCB9IFRoZSB2YWx1ZSB0byBpbnNlcnQuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byBpbnNlcnQgdGhlIHZhbHVlIGF0LgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnRCaWdJbnQ2NEJFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgdXRpbHNfMS5iaWdJbnRBbmRCdWZmZXJJbnQ2NENoZWNrKCd3cml0ZUJpZ0ludDY0QkUnKTsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVCaWdJbnQ2NEJFLCA4LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgQmlnSW50NjRMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBCaWdJbnQgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlQmlnSW50NjRMRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygnd3JpdGVCaWdJbnQ2NExFJyk7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVCaWdJbnQ2NExFLCA4LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhIEludDY0TEUgdmFsdWUgYXQgdGhlIGdpdmVuIG9mZnNldCB2YWx1ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBCaWdJbnQgfSBUaGUgdmFsdWUgdG8gaW5zZXJ0LgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gaW5zZXJ0IHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgaW5zZXJ0QmlnSW50NjRMRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygnd3JpdGVCaWdJbnQ2NExFJyk7CiAgICAgIHJldHVybiB0aGlzLl9pbnNlcnROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlQmlnSW50NjRMRSwgOCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvLyBVbnNpZ25lZCBJbnRlZ2VycwogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBVSW50OCB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWRVSW50OChvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlYWROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCwgMSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gVUludDE2QkUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBOdW1iZXIgfQogICAgICovCiAgICByZWFkVUludDE2QkUob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2QkUsIDIsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlYWRzIGFuIFVJbnQxNkxFIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgcmVhZCBwb3NpdGlvbiBvciBhbiBvcHRpb25hbGx5IHByb3ZpZGVkIG9mZnNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byByZWFkIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0KICAgICAqLwogICAgcmVhZFVJbnQxNkxFKG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkxFLCAyLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBVSW50MzJCRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWRVSW50MzJCRShvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlYWROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJCRSwgNCwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gVUludDMyTEUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBOdW1iZXIgfQogICAgICovCiAgICByZWFkVUludDMyTEUob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUsIDQsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlYWRzIGEgQmlnVUludDY0QkUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBCaWdJbnQgfQogICAgICovCiAgICByZWFkQmlnVUludDY0QkUob2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygncmVhZEJpZ1VJbnQ2NEJFJyk7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnVUludDY0QkUsIDgsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlYWRzIGEgQmlnVUludDY0TEUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBCaWdJbnQgfQogICAgICovCiAgICByZWFkQmlnVUludDY0TEUob2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygncmVhZEJpZ1VJbnQ2NExFJyk7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkQmlnVUludDY0TEUsIDgsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhbiBVSW50OCB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlVUludDgodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDgsIDEsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGFuIFVJbnQ4IHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydFVJbnQ4KHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCwgMSwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhbiBVSW50MTZCRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlVUludDE2QkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUsIDIsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGFuIFVJbnQxNkJFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydFVJbnQxNkJFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZCRSwgMiwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhbiBVSW50MTZMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlVUludDE2TEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUsIDIsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGFuIFVJbnQxNkxFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydFVJbnQxNkxFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZMRSwgMiwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhbiBVSW50MzJCRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlVUludDMyQkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGFuIFVJbnQzMkJFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydFVJbnQzMkJFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJCRSwgNCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhbiBVSW50MzJMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlVUludDMyTEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGFuIFVJbnQzMkxFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydFVJbnQzMkxFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJMRSwgNCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhIEJpZ1VJbnQ2NEJFIHZhbHVlIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uIChvciBhdCBvcHRpb25hbCBvZmZzZXQpLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVCaWdVSW50NjRCRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygnd3JpdGVCaWdVSW50NjRCRScpOwogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlQmlnVUludDY0QkUsIDgsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGEgQmlnVUludDY0QkUgdmFsdWUgYXQgdGhlIGdpdmVuIG9mZnNldCB2YWx1ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gaW5zZXJ0LgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gaW5zZXJ0IHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgaW5zZXJ0QmlnVUludDY0QkUodmFsdWUsIG9mZnNldCkgewogICAgICB1dGlsc18xLmJpZ0ludEFuZEJ1ZmZlckludDY0Q2hlY2soJ3dyaXRlQmlnVUludDY0QkUnKTsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVCaWdVSW50NjRCRSwgOCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhIEJpZ1VJbnQ2NExFIHZhbHVlIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uIChvciBhdCBvcHRpb25hbCBvZmZzZXQpLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVCaWdVSW50NjRMRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuYmlnSW50QW5kQnVmZmVySW50NjRDaGVjaygnd3JpdGVCaWdVSW50NjRMRScpOwogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlQmlnVUludDY0TEUsIDgsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGEgQmlnVUludDY0TEUgdmFsdWUgYXQgdGhlIGdpdmVuIG9mZnNldCB2YWx1ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gaW5zZXJ0LgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gaW5zZXJ0IHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgaW5zZXJ0QmlnVUludDY0TEUodmFsdWUsIG9mZnNldCkgewogICAgICB1dGlsc18xLmJpZ0ludEFuZEJ1ZmZlckludDY0Q2hlY2soJ3dyaXRlQmlnVUludDY0TEUnKTsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVCaWdVSW50NjRMRSwgOCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvLyBGbG9hdGluZyBQb2ludAogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBGbG9hdEJFIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgcmVhZCBwb3NpdGlvbiBvciBhbiBvcHRpb25hbGx5IHByb3ZpZGVkIG9mZnNldC4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byByZWFkIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICAgKiBAcmV0dXJuIHsgTnVtYmVyIH0KICAgICAqLwogICAgcmVhZEZsb2F0QkUob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSwgNCwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gRmxvYXRMRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWRGbG9hdExFKG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0TEUsIDQsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhIEZsb2F0QkUgdmFsdWUgdG8gdGhlIGN1cnJlbnQgd3JpdGUgcG9zaXRpb24gKG9yIGF0IG9wdGlvbmFsIG9mZnNldCkuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIHdyaXRlLgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gd3JpdGUgdGhlIHZhbHVlIGF0LgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICB3cml0ZUZsb2F0QkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSwgNCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgYSBGbG9hdEJFIHZhbHVlIGF0IHRoZSBnaXZlbiBvZmZzZXQgdmFsdWUuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgTnVtYmVyIH0gVGhlIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIGluc2VydCB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIGluc2VydEZsb2F0QkUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYSBGbG9hdExFIHZhbHVlIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uIChvciBhdCBvcHRpb25hbCBvZmZzZXQpLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVGbG9hdExFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3dyaXRlTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUsIDQsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGEgRmxvYXRMRSB2YWx1ZSBhdCB0aGUgZ2l2ZW4gb2Zmc2V0IHZhbHVlLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byBpbnNlcnQuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byBpbnNlcnQgdGhlIHZhbHVlIGF0LgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnRGbG9hdExFKHZhbHVlLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX2luc2VydE51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdExFLCA0LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8vIERvdWJsZSBGbG9hdGluZyBQb2ludAogICAgLyoqCiAgICAgKiBSZWFkcyBhbiBEb3VibEVCRSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IHJlYWQgcG9zaXRpb24gb3IgYW4gb3B0aW9uYWxseSBwcm92aWRlZCBvZmZzZXQuCiAgICAgKgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gcmVhZCBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlYWREb3VibGVCRShvZmZzZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlYWROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSwgOCwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYW4gRG91YmxlTEUgdmFsdWUgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uIG9yIGFuIG9wdGlvbmFsbHkgcHJvdmlkZWQgb2Zmc2V0LgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgICAqIEByZXR1cm4geyBOdW1iZXIgfQogICAgICovCiAgICByZWFkRG91YmxlTEUob2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWFkTnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlTEUsIDgsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhIERvdWJsZUJFIHZhbHVlIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uIChvciBhdCBvcHRpb25hbCBvZmZzZXQpLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVEb3VibGVCRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU51bWJlclZhbHVlKEJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVCRSwgOCwgdmFsdWUsIG9mZnNldCk7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgYSBEb3VibGVCRSB2YWx1ZSBhdCB0aGUgZ2l2ZW4gb2Zmc2V0IHZhbHVlLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9IFRoZSB2YWx1ZSB0byBpbnNlcnQuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byBpbnNlcnQgdGhlIHZhbHVlIGF0LgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnREb3VibGVCRSh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnNlcnROdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlQkUsIDgsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBXcml0ZXMgYSBEb3VibGVMRSB2YWx1ZSB0byB0aGUgY3VycmVudCB3cml0ZSBwb3NpdGlvbiAob3IgYXQgb3B0aW9uYWwgb2Zmc2V0KS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgdmFsdWUgYXQuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlRG91YmxlTEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5fd3JpdGVOdW1iZXJWYWx1ZShCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlTEUsIDgsIHZhbHVlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBJbnNlcnRzIGEgRG91YmxlTEUgdmFsdWUgYXQgdGhlIGdpdmVuIG9mZnNldCB2YWx1ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBOdW1iZXIgfSBUaGUgdmFsdWUgdG8gaW5zZXJ0LgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gaW5zZXJ0IHRoZSB2YWx1ZSBhdC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgaW5zZXJ0RG91YmxlTEUodmFsdWUsIG9mZnNldCkgewogICAgICByZXR1cm4gdGhpcy5faW5zZXJ0TnVtYmVyVmFsdWUoQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFLCA4LCB2YWx1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8vIFN0cmluZ3MKICAgIC8qKgogICAgICogUmVhZHMgYSBTdHJpbmcgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBhcmcxIHsgTnVtYmVyIHwgU3RyaW5nIH0gVGhlIG51bWJlciBvZiBieXRlcyB0byByZWFkIGFzIGEgU3RyaW5nLCBvciB0aGUgQnVmZmVyRW5jb2RpbmcgdG8gdXNlIGZvcgogICAgICogICAgICAgICAgICAgdGhlIHN0cmluZyAoRGVmYXVsdHMgdG8gaW5zdGFuY2UgbGV2ZWwgZW5jb2RpbmcpLgogICAgICogQHBhcmFtIGVuY29kaW5nIHsgU3RyaW5nIH0gVGhlIEJ1ZmZlckVuY29kaW5nIHRvIHVzZSBmb3IgdGhlIHN0cmluZyAoRGVmYXVsdHMgdG8gaW5zdGFuY2UgbGV2ZWwgZW5jb2RpbmcpLgogICAgICoKICAgICAqIEByZXR1cm4geyBTdHJpbmcgfQogICAgICovCiAgICByZWFkU3RyaW5nKGFyZzEsIGVuY29kaW5nKSB7CiAgICAgIGxldCBsZW5ndGhWYWw7CiAgICAgIC8vIExlbmd0aCBwcm92aWRlZAogICAgICBpZiAodHlwZW9mIGFyZzEgPT09ICdudW1iZXInKSB7CiAgICAgICAgdXRpbHNfMS5jaGVja0xlbmd0aFZhbHVlKGFyZzEpOwogICAgICAgIGxlbmd0aFZhbCA9IE1hdGgubWluKGFyZzEsIHRoaXMubGVuZ3RoIC0gdGhpcy5fcmVhZE9mZnNldCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5jb2RpbmcgPSBhcmcxOwogICAgICAgIGxlbmd0aFZhbCA9IHRoaXMubGVuZ3RoIC0gdGhpcy5fcmVhZE9mZnNldDsKICAgICAgfQogICAgICAvLyBDaGVjayBlbmNvZGluZwogICAgICBpZiAodHlwZW9mIGVuY29kaW5nICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHV0aWxzXzEuY2hlY2tFbmNvZGluZyhlbmNvZGluZyk7CiAgICAgIH0KICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9idWZmLnNsaWNlKHRoaXMuX3JlYWRPZmZzZXQsIHRoaXMuX3JlYWRPZmZzZXQgKyBsZW5ndGhWYWwpLnRvU3RyaW5nKGVuY29kaW5nIHx8IHRoaXMuX2VuY29kaW5nKTsKICAgICAgdGhpcy5fcmVhZE9mZnNldCArPSBsZW5ndGhWYWw7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0cyBhIFN0cmluZwogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IFN0cmluZyB9IFRoZSBTdHJpbmcgdmFsdWUgdG8gaW5zZXJ0LgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IFRoZSBvZmZzZXQgdG8gaW5zZXJ0IHRoZSBzdHJpbmcgYXQuCiAgICAgKiBAcGFyYW0gZW5jb2RpbmcgeyBTdHJpbmcgfSBUaGUgQnVmZmVyRW5jb2RpbmcgdG8gdXNlIGZvciB3cml0aW5nIHN0cmluZ3MgKGRlZmF1bHRzIHRvIGluc3RhbmNlIGVuY29kaW5nKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgaW5zZXJ0U3RyaW5nKHZhbHVlLCBvZmZzZXQsIGVuY29kaW5nKSB7CiAgICAgIHV0aWxzXzEuY2hlY2tPZmZzZXRWYWx1ZShvZmZzZXQpOwogICAgICByZXR1cm4gdGhpcy5faGFuZGxlU3RyaW5nKHZhbHVlLCB0cnVlLCBvZmZzZXQsIGVuY29kaW5nKTsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgU3RyaW5nCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgU3RyaW5nIH0gVGhlIFN0cmluZyB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBhcmcyIHsgTnVtYmVyIHwgU3RyaW5nIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgc3RyaW5nIGF0LCBvciB0aGUgQnVmZmVyRW5jb2RpbmcgdG8gdXNlLgogICAgICogQHBhcmFtIGVuY29kaW5nIHsgU3RyaW5nIH0gVGhlIEJ1ZmZlckVuY29kaW5nIHRvIHVzZSBmb3Igd3JpdGluZyBzdHJpbmdzIChkZWZhdWx0cyB0byBpbnN0YW5jZSBlbmNvZGluZykuCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlU3RyaW5nKHZhbHVlLCBhcmcyLCBlbmNvZGluZykgewogICAgICByZXR1cm4gdGhpcy5faGFuZGxlU3RyaW5nKHZhbHVlLCBmYWxzZSwgYXJnMiwgZW5jb2RpbmcpOwogICAgfQogICAgLyoqCiAgICAgKiBSZWFkcyBhIG51bGwtdGVybWluYXRlZCBTdHJpbmcgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvc2l0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UgZm9yIHRoZSBzdHJpbmcgKERlZmF1bHRzIHRvIGluc3RhbmNlIGxldmVsIGVuY29kaW5nKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHsgU3RyaW5nIH0KICAgICAqLwogICAgcmVhZFN0cmluZ05UKGVuY29kaW5nKSB7CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgdXRpbHNfMS5jaGVja0VuY29kaW5nKGVuY29kaW5nKTsKICAgICAgfQogICAgICAvLyBTZXQgbnVsbCBjaGFyYWN0ZXIgcG9zaXRpb24gdG8gdGhlIGVuZCBTbWFydEJ1ZmZlciBpbnN0YW5jZS4KICAgICAgbGV0IG51bGxQb3MgPSB0aGlzLmxlbmd0aDsKICAgICAgLy8gRmluZCBuZXh0IG51bGwgY2hhcmFjdGVyIChpZiBvbmUgaXMgbm90IGZvdW5kLCBkZWZhdWx0IGZyb20gYWJvdmUgaXMgdXNlZCkKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuX3JlYWRPZmZzZXQ7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuX2J1ZmZbaV0gPT09IDB4MDApIHsKICAgICAgICAgIG51bGxQb3MgPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIFJlYWQgc3RyaW5nIHZhbHVlCiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fYnVmZi5zbGljZSh0aGlzLl9yZWFkT2Zmc2V0LCBudWxsUG9zKTsKICAgICAgLy8gSW5jcmVtZW50IGludGVybmFsIEJ1ZmZlciByZWFkIG9mZnNldAogICAgICB0aGlzLl9yZWFkT2Zmc2V0ID0gbnVsbFBvcyArIDE7CiAgICAgIHJldHVybiB2YWx1ZS50b1N0cmluZyhlbmNvZGluZyB8fCB0aGlzLl9lbmNvZGluZyk7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgYSBudWxsLXRlcm1pbmF0ZWQgU3RyaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IFN0cmluZyB9IFRoZSBTdHJpbmcgdmFsdWUgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gYXJnMiB7IE51bWJlciB8IFN0cmluZyB9IFRoZSBvZmZzZXQgdG8gd3JpdGUgdGhlIHN0cmluZyB0bywgb3IgdGhlIEJ1ZmZlckVuY29kaW5nIHRvIHVzZS4KICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UgZm9yIHdyaXRpbmcgc3RyaW5ncyAoZGVmYXVsdHMgdG8gaW5zdGFuY2UgZW5jb2RpbmcpLgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnRTdHJpbmdOVCh2YWx1ZSwgb2Zmc2V0LCBlbmNvZGluZykgewogICAgICB1dGlsc18xLmNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KTsKICAgICAgLy8gV3JpdGUgVmFsdWVzCiAgICAgIHRoaXMuaW5zZXJ0U3RyaW5nKHZhbHVlLCBvZmZzZXQsIGVuY29kaW5nKTsKICAgICAgdGhpcy5pbnNlcnRVSW50OCgweDAwLCBvZmZzZXQgKyB2YWx1ZS5sZW5ndGgpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgbnVsbC10ZXJtaW5hdGVkIFN0cmluZy4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBTdHJpbmcgfSBUaGUgU3RyaW5nIHZhbHVlIHRvIHdyaXRlLgogICAgICogQHBhcmFtIGFyZzIgeyBOdW1iZXIgfCBTdHJpbmcgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSBzdHJpbmcgdG8sIG9yIHRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UuCiAgICAgKiBAcGFyYW0gZW5jb2RpbmcgeyBTdHJpbmcgfSBUaGUgQnVmZmVyRW5jb2RpbmcgdG8gdXNlIGZvciB3cml0aW5nIHN0cmluZ3MgKGRlZmF1bHRzIHRvIGluc3RhbmNlIGVuY29kaW5nKS4KICAgICAqCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwogICAgd3JpdGVTdHJpbmdOVCh2YWx1ZSwgYXJnMiwgZW5jb2RpbmcpIHsKICAgICAgLy8gV3JpdGUgVmFsdWVzCiAgICAgIHRoaXMud3JpdGVTdHJpbmcodmFsdWUsIGFyZzIsIGVuY29kaW5nKTsKICAgICAgdGhpcy53cml0ZVVJbnQ4KDB4MDAsIHR5cGVvZiBhcmcyID09PSAnbnVtYmVyJyA/IGFyZzIgKyB2YWx1ZS5sZW5ndGggOiB0aGlzLndyaXRlT2Zmc2V0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvLyBCdWZmZXJzCiAgICAvKioKICAgICAqIFJlYWRzIGEgQnVmZmVyIGZyb20gdGhlIGludGVybmFsIHJlYWQgcG9zaXRpb24uCiAgICAgKgogICAgICogQHBhcmFtIGxlbmd0aCB7IE51bWJlciB9IFRoZSBsZW5ndGggb2YgZGF0YSB0byByZWFkIGFzIGEgQnVmZmVyLgogICAgICoKICAgICAqIEByZXR1cm4geyBCdWZmZXIgfQogICAgICovCiAgICByZWFkQnVmZmVyKGxlbmd0aCkgewogICAgICBpZiAodHlwZW9mIGxlbmd0aCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICB1dGlsc18xLmNoZWNrTGVuZ3RoVmFsdWUobGVuZ3RoKTsKICAgICAgfQogICAgICBjb25zdCBsZW5ndGhWYWwgPSB0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyA/IGxlbmd0aCA6IHRoaXMubGVuZ3RoOwogICAgICBjb25zdCBlbmRQb2ludCA9IE1hdGgubWluKHRoaXMubGVuZ3RoLCB0aGlzLl9yZWFkT2Zmc2V0ICsgbGVuZ3RoVmFsKTsKICAgICAgLy8gUmVhZCBidWZmZXIgdmFsdWUKICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9idWZmLnNsaWNlKHRoaXMuX3JlYWRPZmZzZXQsIGVuZFBvaW50KTsKICAgICAgLy8gSW5jcmVtZW50IGludGVybmFsIEJ1ZmZlciByZWFkIG9mZnNldAogICAgICB0aGlzLl9yZWFkT2Zmc2V0ID0gZW5kUG9pbnQ7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgQnVmZmVyIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IEJ1ZmZlciB9IFRoZSBCdWZmZXIgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgQnVmZmVyIHRvLgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnRCdWZmZXIodmFsdWUsIG9mZnNldCkgewogICAgICB1dGlsc18xLmNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KTsKICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUJ1ZmZlcih2YWx1ZSwgdHJ1ZSwgb2Zmc2V0KTsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgQnVmZmVyIHRvIHRoZSBjdXJyZW50IHdyaXRlIHBvc2l0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IEJ1ZmZlciB9IFRoZSBCdWZmZXIgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgQnVmZmVyIHRvLgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICB3cml0ZUJ1ZmZlcih2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVCdWZmZXIodmFsdWUsIGZhbHNlLCBvZmZzZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBSZWFkcyBhIG51bGwtdGVybWluYXRlZCBCdWZmZXIgZnJvbSB0aGUgY3VycmVudCByZWFkIHBvaXNpdG9uLgogICAgICoKICAgICAqIEByZXR1cm4geyBCdWZmZXIgfQogICAgICovCiAgICByZWFkQnVmZmVyTlQoKSB7CiAgICAgIC8vIFNldCBudWxsIGNoYXJhY3RlciBwb3NpdGlvbiB0byB0aGUgZW5kIFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICBsZXQgbnVsbFBvcyA9IHRoaXMubGVuZ3RoOwogICAgICAvLyBGaW5kIG5leHQgbnVsbCBjaGFyYWN0ZXIgKGlmIG9uZSBpcyBub3QgZm91bmQsIGRlZmF1bHQgZnJvbSBhYm92ZSBpcyB1c2VkKQogICAgICBmb3IgKGxldCBpID0gdGhpcy5fcmVhZE9mZnNldDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5fYnVmZltpXSA9PT0gMHgwMCkgewogICAgICAgICAgbnVsbFBvcyA9IGk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gUmVhZCB2YWx1ZQogICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2J1ZmYuc2xpY2UodGhpcy5fcmVhZE9mZnNldCwgbnVsbFBvcyk7CiAgICAgIC8vIEluY3JlbWVudCBpbnRlcm5hbCBCdWZmZXIgcmVhZCBvZmZzZXQKICAgICAgdGhpcy5fcmVhZE9mZnNldCA9IG51bGxQb3MgKyAxOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgYSBudWxsLXRlcm1pbmF0ZWQgQnVmZmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSB7IEJ1ZmZlciB9IFRoZSBCdWZmZXIgdG8gd3JpdGUuCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gVGhlIG9mZnNldCB0byB3cml0ZSB0aGUgQnVmZmVyIHRvLgogICAgICoKICAgICAqIEByZXR1cm4gdGhpcwogICAgICovCiAgICBpbnNlcnRCdWZmZXJOVCh2YWx1ZSwgb2Zmc2V0KSB7CiAgICAgIHV0aWxzXzEuY2hlY2tPZmZzZXRWYWx1ZShvZmZzZXQpOwogICAgICAvLyBXcml0ZSBWYWx1ZXMKICAgICAgdGhpcy5pbnNlcnRCdWZmZXIodmFsdWUsIG9mZnNldCk7CiAgICAgIHRoaXMuaW5zZXJ0VUludDgoMHgwMCwgb2Zmc2V0ICsgdmFsdWUubGVuZ3RoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFdyaXRlcyBhIG51bGwtdGVybWluYXRlZCBCdWZmZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgQnVmZmVyIH0gVGhlIEJ1ZmZlciB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSBCdWZmZXIgdG8uCiAgICAgKgogICAgICogQHJldHVybiB0aGlzCiAgICAgKi8KICAgIHdyaXRlQnVmZmVyTlQodmFsdWUsIG9mZnNldCkgewogICAgICAvLyBDaGVja3MgZm9yIHZhbGlkIG51bWJlcmljIHZhbHVlOwogICAgICBpZiAodHlwZW9mIG9mZnNldCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICB1dGlsc18xLmNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KTsKICAgICAgfQogICAgICAvLyBXcml0ZSBWYWx1ZXMKICAgICAgdGhpcy53cml0ZUJ1ZmZlcih2YWx1ZSwgb2Zmc2V0KTsKICAgICAgdGhpcy53cml0ZVVJbnQ4KDB4MDAsIHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInID8gb2Zmc2V0ICsgdmFsdWUubGVuZ3RoIDogdGhpcy5fd3JpdGVPZmZzZXQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ2xlYXJzIHRoZSBTbWFydEJ1ZmZlciBpbnN0YW5jZSB0byBpdHMgb3JpZ2luYWwgZW1wdHkgc3RhdGUuCiAgICAgKi8KICAgIGNsZWFyKCkgewogICAgICB0aGlzLl93cml0ZU9mZnNldCA9IDA7CiAgICAgIHRoaXMuX3JlYWRPZmZzZXQgPSAwOwogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBHZXRzIHRoZSByZW1haW5pbmcgZGF0YSBsZWZ0IHRvIGJlIHJlYWQgZnJvbSB0aGUgU21hcnRCdWZmZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIHJlbWFpbmluZygpIHsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoIC0gdGhpcy5fcmVhZE9mZnNldDsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgY3VycmVudCByZWFkIG9mZnNldCB2YWx1ZSBvZiB0aGUgU21hcnRCdWZmZXIgaW5zdGFuY2UuCiAgICAgKgogICAgICogQHJldHVybiB7IE51bWJlciB9CiAgICAgKi8KICAgIGdldCByZWFkT2Zmc2V0KCkgewogICAgICByZXR1cm4gdGhpcy5fcmVhZE9mZnNldDsKICAgIH0KICAgIC8qKgogICAgICogU2V0cyB0aGUgcmVhZCBvZmZzZXQgdmFsdWUgb2YgdGhlIFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSAtIFRoZSBvZmZzZXQgdmFsdWUgdG8gc2V0LgogICAgICovCiAgICBzZXQgcmVhZE9mZnNldChvZmZzZXQpIHsKICAgICAgdXRpbHNfMS5jaGVja09mZnNldFZhbHVlKG9mZnNldCk7CiAgICAgIC8vIENoZWNrIGZvciBib3VuZHMuCiAgICAgIHV0aWxzXzEuY2hlY2tUYXJnZXRPZmZzZXQob2Zmc2V0LCB0aGlzKTsKICAgICAgdGhpcy5fcmVhZE9mZnNldCA9IG9mZnNldDsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgY3VycmVudCB3cml0ZSBvZmZzZXQgdmFsdWUgb2YgdGhlIFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEByZXR1cm4geyBOdW1iZXIgfQogICAgICovCiAgICBnZXQgd3JpdGVPZmZzZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLl93cml0ZU9mZnNldDsKICAgIH0KICAgIC8qKgogICAgICogU2V0cyB0aGUgd3JpdGUgb2Zmc2V0IHZhbHVlIG9mIHRoZSBTbWFydEJ1ZmZlciBpbnN0YW5jZS4KICAgICAqCiAgICAgKiBAcGFyYW0gb2Zmc2V0IHsgTnVtYmVyIH0gLSBUaGUgb2Zmc2V0IHZhbHVlIHRvIHNldC4KICAgICAqLwogICAgc2V0IHdyaXRlT2Zmc2V0KG9mZnNldCkgewogICAgICB1dGlsc18xLmNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KTsKICAgICAgLy8gQ2hlY2sgZm9yIGJvdW5kcy4KICAgICAgdXRpbHNfMS5jaGVja1RhcmdldE9mZnNldChvZmZzZXQsIHRoaXMpOwogICAgICB0aGlzLl93cml0ZU9mZnNldCA9IG9mZnNldDsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgY3VycmVudGx5IHNldCBzdHJpbmcgZW5jb2Rpbmcgb2YgdGhlIFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEByZXR1cm4geyBCdWZmZXJFbmNvZGluZyB9IFRoZSBzdHJpbmcgQnVmZmVyIGVuY29kaW5nIGN1cnJlbnRseSBzZXQuCiAgICAgKi8KICAgIGdldCBlbmNvZGluZygpIHsKICAgICAgcmV0dXJuIHRoaXMuX2VuY29kaW5nOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBzdHJpbmcgZW5jb2Rpbmcgb2YgdGhlIFNtYXJ0QnVmZmVyIGluc3RhbmNlLgogICAgICoKICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IEJ1ZmZlckVuY29kaW5nIH0gVGhlIHN0cmluZyBCdWZmZXIgZW5jb2RpbmcgdG8gc2V0LgogICAgICovCiAgICBzZXQgZW5jb2RpbmcoZW5jb2RpbmcpIHsKICAgICAgdXRpbHNfMS5jaGVja0VuY29kaW5nKGVuY29kaW5nKTsKICAgICAgdGhpcy5fZW5jb2RpbmcgPSBlbmNvZGluZzsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgdW5kZXJseWluZyBpbnRlcm5hbCBCdWZmZXIuIChUaGlzIGluY2x1ZGVzIHVubWFuYWdlZCBkYXRhIGluIHRoZSBCdWZmZXIpCiAgICAgKgogICAgICogQHJldHVybiB7IEJ1ZmZlciB9IFRoZSBCdWZmZXIgdmFsdWUuCiAgICAgKi8KICAgIGdldCBpbnRlcm5hbEJ1ZmZlcigpIHsKICAgICAgcmV0dXJuIHRoaXMuX2J1ZmY7CiAgICB9CiAgICAvKioKICAgICAqIEdldHMgdGhlIHZhbHVlIG9mIHRoZSBpbnRlcm5hbCBtYW5hZ2VkIEJ1ZmZlciAoSW5jbHVkZXMgbWFuYWdlZCBkYXRhIG9ubHkpCiAgICAgKgogICAgICogQHBhcmFtIHsgQnVmZmVyIH0KICAgICAqLwogICAgdG9CdWZmZXIoKSB7CiAgICAgIHJldHVybiB0aGlzLl9idWZmLnNsaWNlKDAsIHRoaXMubGVuZ3RoKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0cyB0aGUgU3RyaW5nIHZhbHVlIG9mIHRoZSBpbnRlcm5hbCBtYW5hZ2VkIEJ1ZmZlcgogICAgICoKICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byBkaXNwbGF5IHRoZSBCdWZmZXIgYXMgKGRlZmF1bHRzIHRvIGluc3RhbmNlIGxldmVsIGVuY29kaW5nKS4KICAgICAqLwogICAgdG9TdHJpbmcoZW5jb2RpbmcpIHsKICAgICAgY29uc3QgZW5jb2RpbmdWYWwgPSB0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnID8gZW5jb2RpbmcgOiB0aGlzLl9lbmNvZGluZzsKICAgICAgLy8gQ2hlY2sgZm9yIGludmFsaWQgZW5jb2RpbmcuCiAgICAgIHV0aWxzXzEuY2hlY2tFbmNvZGluZyhlbmNvZGluZ1ZhbCk7CiAgICAgIHJldHVybiB0aGlzLl9idWZmLnRvU3RyaW5nKGVuY29kaW5nVmFsLCAwLCB0aGlzLmxlbmd0aCk7CiAgICB9CiAgICAvKioKICAgICAqIERlc3Ryb3lzIHRoZSBTbWFydEJ1ZmZlciBpbnN0YW5jZS4KICAgICAqLwogICAgZGVzdHJveSgpIHsKICAgICAgdGhpcy5jbGVhcigpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogSGFuZGxlcyBpbnNlcnRpbmcgYW5kIHdyaXRpbmcgc3RyaW5ncy4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBTdHJpbmcgfSBUaGUgU3RyaW5nIHZhbHVlIHRvIGluc2VydC4KICAgICAqIEBwYXJhbSBpc0luc2VydCB7IEJvb2xlYW4gfSBUcnVlIGlmIGluc2VydGluZyBhIHN0cmluZywgZmFsc2UgaWYgd3JpdGluZy4KICAgICAqIEBwYXJhbSBhcmcyIHsgTnVtYmVyIHwgU3RyaW5nIH0gVGhlIG9mZnNldCB0byBpbnNlcnQgdGhlIHN0cmluZyBhdCwgb3IgdGhlIEJ1ZmZlckVuY29kaW5nIHRvIHVzZS4KICAgICAqIEBwYXJhbSBlbmNvZGluZyB7IFN0cmluZyB9IFRoZSBCdWZmZXJFbmNvZGluZyB0byB1c2UgZm9yIHdyaXRpbmcgc3RyaW5ncyAoZGVmYXVsdHMgdG8gaW5zdGFuY2UgZW5jb2RpbmcpLgogICAgICovCiAgICBfaGFuZGxlU3RyaW5nKHZhbHVlLCBpc0luc2VydCwgYXJnMywgZW5jb2RpbmcpIHsKICAgICAgbGV0IG9mZnNldFZhbCA9IHRoaXMuX3dyaXRlT2Zmc2V0OwogICAgICBsZXQgZW5jb2RpbmdWYWwgPSB0aGlzLl9lbmNvZGluZzsKICAgICAgLy8gQ2hlY2sgZm9yIG9mZnNldAogICAgICBpZiAodHlwZW9mIGFyZzMgPT09ICdudW1iZXInKSB7CiAgICAgICAgb2Zmc2V0VmFsID0gYXJnMzsKICAgICAgICAvLyBDaGVjayBmb3IgZW5jb2RpbmcKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnMyA9PT0gJ3N0cmluZycpIHsKICAgICAgICB1dGlsc18xLmNoZWNrRW5jb2RpbmcoYXJnMyk7CiAgICAgICAgZW5jb2RpbmdWYWwgPSBhcmczOwogICAgICB9CiAgICAgIC8vIENoZWNrIGZvciBlbmNvZGluZyAodGhpcmQgcGFyYW0pCiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdXRpbHNfMS5jaGVja0VuY29kaW5nKGVuY29kaW5nKTsKICAgICAgICBlbmNvZGluZ1ZhbCA9IGVuY29kaW5nOwogICAgICB9CiAgICAgIC8vIENhbGN1bGF0ZSBieXRlbGVuZ3RoIG9mIHN0cmluZy4KICAgICAgY29uc3QgYnl0ZUxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKHZhbHVlLCBlbmNvZGluZ1ZhbCk7CiAgICAgIC8vIEVuc3VyZSB0aGVyZSBpcyBlbm91Z2ggaW50ZXJuYWwgQnVmZmVyIGNhcGFjaXR5LgogICAgICBpZiAoaXNJbnNlcnQpIHsKICAgICAgICB0aGlzLmVuc3VyZUluc2VydGFibGUoYnl0ZUxlbmd0aCwgb2Zmc2V0VmFsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9lbnN1cmVXcml0ZWFibGUoYnl0ZUxlbmd0aCwgb2Zmc2V0VmFsKTsKICAgICAgfQogICAgICAvLyBXcml0ZSB2YWx1ZQogICAgICB0aGlzLl9idWZmLndyaXRlKHZhbHVlLCBvZmZzZXRWYWwsIGJ5dGVMZW5ndGgsIGVuY29kaW5nVmFsKTsKICAgICAgLy8gSW5jcmVtZW50IGludGVybmFsIEJ1ZmZlciB3cml0ZSBvZmZzZXQ7CiAgICAgIGlmIChpc0luc2VydCkgewogICAgICAgIHRoaXMuX3dyaXRlT2Zmc2V0ICs9IGJ5dGVMZW5ndGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYW4gb2Zmc2V0IHdhcyBnaXZlbiwgY2hlY2sgdG8gc2VlIGlmIHdlIHdyb3RlIGJleW9uZCB0aGUgY3VycmVudCB3cml0ZU9mZnNldC4KICAgICAgICBpZiAodHlwZW9mIGFyZzMgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLl93cml0ZU9mZnNldCA9IE1hdGgubWF4KHRoaXMuX3dyaXRlT2Zmc2V0LCBvZmZzZXRWYWwgKyBieXRlTGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gSWYgbm8gb2Zmc2V0IHdhcyBnaXZlbiwgd2Ugd3JvdGUgdG8gdGhlIGVuZCBvZiB0aGUgU21hcnRCdWZmZXIgc28gaW5jcmVtZW50IHdyaXRlT2Zmc2V0LgogICAgICAgICAgdGhpcy5fd3JpdGVPZmZzZXQgKz0gYnl0ZUxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIEhhbmRsZXMgd3JpdGluZyBvciBpbnNlcnQgb2YgYSBCdWZmZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZhbHVlIHsgQnVmZmVyIH0gVGhlIEJ1ZmZlciB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSBCdWZmZXIgdG8uCiAgICAgKi8KICAgIF9oYW5kbGVCdWZmZXIodmFsdWUsIGlzSW5zZXJ0LCBvZmZzZXQpIHsKICAgICAgY29uc3Qgb2Zmc2V0VmFsID0gdHlwZW9mIG9mZnNldCA9PT0gJ251bWJlcicgPyBvZmZzZXQgOiB0aGlzLl93cml0ZU9mZnNldDsKICAgICAgLy8gRW5zdXJlIHRoZXJlIGlzIGVub3VnaCBpbnRlcm5hbCBCdWZmZXIgY2FwYWNpdHkuCiAgICAgIGlmIChpc0luc2VydCkgewogICAgICAgIHRoaXMuZW5zdXJlSW5zZXJ0YWJsZSh2YWx1ZS5sZW5ndGgsIG9mZnNldFZhbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZW5zdXJlV3JpdGVhYmxlKHZhbHVlLmxlbmd0aCwgb2Zmc2V0VmFsKTsKICAgICAgfQogICAgICAvLyBXcml0ZSBidWZmZXIgdmFsdWUKICAgICAgdmFsdWUuY29weSh0aGlzLl9idWZmLCBvZmZzZXRWYWwpOwogICAgICAvLyBJbmNyZW1lbnQgaW50ZXJuYWwgQnVmZmVyIHdyaXRlIG9mZnNldDsKICAgICAgaWYgKGlzSW5zZXJ0KSB7CiAgICAgICAgdGhpcy5fd3JpdGVPZmZzZXQgKz0gdmFsdWUubGVuZ3RoOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIGFuIG9mZnNldCB3YXMgZ2l2ZW4sIGNoZWNrIHRvIHNlZSBpZiB3ZSB3cm90ZSBiZXlvbmQgdGhlIGN1cnJlbnQgd3JpdGVPZmZzZXQuCiAgICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLl93cml0ZU9mZnNldCA9IE1hdGgubWF4KHRoaXMuX3dyaXRlT2Zmc2V0LCBvZmZzZXRWYWwgKyB2YWx1ZS5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJZiBubyBvZmZzZXQgd2FzIGdpdmVuLCB3ZSB3cm90ZSB0byB0aGUgZW5kIG9mIHRoZSBTbWFydEJ1ZmZlciBzbyBpbmNyZW1lbnQgd3JpdGVPZmZzZXQuCiAgICAgICAgICB0aGlzLl93cml0ZU9mZnNldCArPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBFbnN1cmVzIHRoYXQgdGhlIGludGVybmFsIEJ1ZmZlciBpcyBsYXJnZSBlbm91Z2ggdG8gcmVhZCBkYXRhLgogICAgICoKICAgICAqIEBwYXJhbSBsZW5ndGggeyBOdW1iZXIgfSBUaGUgbGVuZ3RoIG9mIHRoZSBkYXRhIHRoYXQgbmVlZHMgdG8gYmUgcmVhZC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IG9mIHRoZSBkYXRhIHRoYXQgbmVlZHMgdG8gYmUgcmVhZC4KICAgICAqLwogICAgZW5zdXJlUmVhZGFibGUobGVuZ3RoLCBvZmZzZXQpIHsKICAgICAgLy8gT2Zmc2V0IHZhbHVlIGRlZmF1bHRzIHRvIG1hbmFnZWQgcmVhZCBvZmZzZXQuCiAgICAgIGxldCBvZmZzZXRWYWwgPSB0aGlzLl9yZWFkT2Zmc2V0OwogICAgICAvLyBJZiBhbiBvZmZzZXQgd2FzIHByb3ZpZGVkLCB1c2UgaXQuCiAgICAgIGlmICh0eXBlb2Ygb2Zmc2V0ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIC8vIENoZWNrcyBmb3IgdmFsaWQgbnVtYmVyaWMgdmFsdWU7CiAgICAgICAgdXRpbHNfMS5jaGVja09mZnNldFZhbHVlKG9mZnNldCk7CiAgICAgICAgLy8gT3ZlcmlkZSB3aXRoIGN1c3RvbSBvZmZzZXQuCiAgICAgICAgb2Zmc2V0VmFsID0gb2Zmc2V0OwogICAgICB9CiAgICAgIC8vIENoZWNrcyBpZiBvZmZzZXQgaXMgYmVsb3cgemVybywgb3IgdGhlIG9mZnNldCtsZW5ndGggb2Zmc2V0IGlzIGJleW9uZCB0aGUgdG90YWwgbGVuZ3RoIG9mIHRoZSBtYW5hZ2VkIGRhdGEuCiAgICAgIGlmIChvZmZzZXRWYWwgPCAwIHx8IG9mZnNldFZhbCArIGxlbmd0aCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHV0aWxzXzEuRVJST1JTLklOVkFMSURfUkVBRF9CRVlPTkRfQk9VTkRTKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBFbnN1cmVzIHRoYXQgdGhlIGludGVybmFsIEJ1ZmZlciBpcyBsYXJnZSBlbm91Z2ggdG8gaW5zZXJ0IGRhdGEuCiAgICAgKgogICAgICogQHBhcmFtIGRhdGFMZW5ndGggeyBOdW1iZXIgfSBUaGUgbGVuZ3RoIG9mIHRoZSBkYXRhIHRoYXQgbmVlZHMgdG8gYmUgd3JpdHRlbi4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IG9mIHRoZSBkYXRhIHRvIGJlIHdyaXR0ZW4uCiAgICAgKi8KICAgIGVuc3VyZUluc2VydGFibGUoZGF0YUxlbmd0aCwgb2Zmc2V0KSB7CiAgICAgIC8vIENoZWNrcyBmb3IgdmFsaWQgbnVtYmVyaWMgdmFsdWU7CiAgICAgIHV0aWxzXzEuY2hlY2tPZmZzZXRWYWx1ZShvZmZzZXQpOwogICAgICAvLyBFbnN1cmUgdGhlcmUgaXMgZW5vdWdoIGludGVybmFsIEJ1ZmZlciBjYXBhY2l0eS4KICAgICAgdGhpcy5fZW5zdXJlQ2FwYWNpdHkodGhpcy5sZW5ndGggKyBkYXRhTGVuZ3RoKTsKICAgICAgLy8gSWYgYW4gb2Zmc2V0IHdhcyBwcm92aWRlZCBhbmQgaXRzIG5vdCB0aGUgdmVyeSBlbmQgb2YgdGhlIGJ1ZmZlciwgY29weSBkYXRhIGludG8gYXBwcm9wcmlhdGUgbG9jYXRpb24gaW4gcmVnYXJkcyB0byB0aGUgb2Zmc2V0LgogICAgICBpZiAob2Zmc2V0IDwgdGhpcy5sZW5ndGgpIHsKICAgICAgICB0aGlzLl9idWZmLmNvcHkodGhpcy5fYnVmZiwgb2Zmc2V0ICsgZGF0YUxlbmd0aCwgb2Zmc2V0LCB0aGlzLl9idWZmLmxlbmd0aCk7CiAgICAgIH0KICAgICAgLy8gQWRqdXN0IHRyYWNrZWQgc21hcnQgYnVmZmVyIGxlbmd0aAogICAgICBpZiAob2Zmc2V0ICsgZGF0YUxlbmd0aCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBvZmZzZXQgKyBkYXRhTGVuZ3RoOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubGVuZ3RoICs9IGRhdGFMZW5ndGg7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRW5zdXJlcyB0aGF0IHRoZSBpbnRlcm5hbCBCdWZmZXIgaXMgbGFyZ2UgZW5vdWdoIHRvIHdyaXRlIGRhdGEuCiAgICAgKgogICAgICogQHBhcmFtIGRhdGFMZW5ndGggeyBOdW1iZXIgfSBUaGUgbGVuZ3RoIG9mIHRoZSBkYXRhIHRoYXQgbmVlZHMgdG8gYmUgd3JpdHRlbi4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IG9mIHRoZSBkYXRhIHRvIGJlIHdyaXR0ZW4gKGRlZmF1bHRzIHRvIHdyaXRlT2Zmc2V0KS4KICAgICAqLwogICAgX2Vuc3VyZVdyaXRlYWJsZShkYXRhTGVuZ3RoLCBvZmZzZXQpIHsKICAgICAgY29uc3Qgb2Zmc2V0VmFsID0gdHlwZW9mIG9mZnNldCA9PT0gJ251bWJlcicgPyBvZmZzZXQgOiB0aGlzLl93cml0ZU9mZnNldDsKICAgICAgLy8gRW5zdXJlIGVub3VnaCBjYXBhY2l0eSB0byB3cml0ZSBkYXRhLgogICAgICB0aGlzLl9lbnN1cmVDYXBhY2l0eShvZmZzZXRWYWwgKyBkYXRhTGVuZ3RoKTsKICAgICAgLy8gQWRqdXN0IFNtYXJ0QnVmZmVyIGxlbmd0aCAoaWYgb2Zmc2V0ICsgbGVuZ3RoIGlzIGxhcmdlciB0aGFuIG1hbmFnZWQgbGVuZ3RoLCBhZGp1c3QgbGVuZ3RoKQogICAgICBpZiAob2Zmc2V0VmFsICsgZGF0YUxlbmd0aCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5sZW5ndGggPSBvZmZzZXRWYWwgKyBkYXRhTGVuZ3RoOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEVuc3VyZXMgdGhhdCB0aGUgaW50ZXJuYWwgQnVmZmVyIGlzIGxhcmdlIGVub3VnaCB0byB3cml0ZSBhdCBsZWFzdCB0aGUgZ2l2ZW4gYW1vdW50IG9mIGRhdGEuCiAgICAgKgogICAgICogQHBhcmFtIG1pbkxlbmd0aCB7IE51bWJlciB9IFRoZSBtaW5pbXVtIGxlbmd0aCBvZiB0aGUgZGF0YSBuZWVkcyB0byBiZSB3cml0dGVuLgogICAgICovCiAgICBfZW5zdXJlQ2FwYWNpdHkobWluTGVuZ3RoKSB7CiAgICAgIGNvbnN0IG9sZExlbmd0aCA9IHRoaXMuX2J1ZmYubGVuZ3RoOwogICAgICBpZiAobWluTGVuZ3RoID4gb2xkTGVuZ3RoKSB7CiAgICAgICAgbGV0IGRhdGEgPSB0aGlzLl9idWZmOwogICAgICAgIGxldCBuZXdMZW5ndGggPSBvbGRMZW5ndGggKiAzIC8gMiArIDE7CiAgICAgICAgaWYgKG5ld0xlbmd0aCA8IG1pbkxlbmd0aCkgewogICAgICAgICAgbmV3TGVuZ3RoID0gbWluTGVuZ3RoOwogICAgICAgIH0KICAgICAgICB0aGlzLl9idWZmID0gQnVmZmVyLmFsbG9jVW5zYWZlKG5ld0xlbmd0aCk7CiAgICAgICAgZGF0YS5jb3B5KHRoaXMuX2J1ZmYsIDAsIDAsIG9sZExlbmd0aCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVhZHMgYSBudW1lcmljIG51bWJlciB2YWx1ZSB1c2luZyB0aGUgcHJvdmlkZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHR5cGVwYXJhbSBUIHsgbnVtYmVyIHwgYmlnaW50IH0gVGhlIHR5cGUgb2YgdGhlIHZhbHVlIHRvIGJlIHJlYWQKICAgICAqCiAgICAgKiBAcGFyYW0gZnVuYyB7IEZ1bmN0aW9uKG9mZnNldDogbnVtYmVyKSA9PiBudW1iZXIgfSBUaGUgZnVuY3Rpb24gdG8gcmVhZCBkYXRhIG9uIHRoZSBpbnRlcm5hbCBCdWZmZXIgd2l0aC4KICAgICAqIEBwYXJhbSBieXRlU2l6ZSB7IE51bWJlciB9IFRoZSBudW1iZXIgb2YgYnl0ZXMgcmVhZC4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSBUaGUgb2Zmc2V0IHRvIHJlYWQgZnJvbSAob3B0aW9uYWwpLiBXaGVuIHRoaXMgaXMgbm90IHByb3ZpZGVkLCB0aGUgbWFuYWdlZCByZWFkT2Zmc2V0IGlzIHVzZWQgaW5zdGVhZC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7IFQgfSB0aGUgbnVtYmVyIHZhbHVlCiAgICAgKi8KICAgIF9yZWFkTnVtYmVyVmFsdWUoZnVuYywgYnl0ZVNpemUsIG9mZnNldCkgewogICAgICB0aGlzLmVuc3VyZVJlYWRhYmxlKGJ5dGVTaXplLCBvZmZzZXQpOwogICAgICAvLyBDYWxsIEJ1ZmZlci5yZWFkWFhYWCgpOwogICAgICBjb25zdCB2YWx1ZSA9IGZ1bmMuY2FsbCh0aGlzLl9idWZmLCB0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJyA/IG9mZnNldCA6IHRoaXMuX3JlYWRPZmZzZXQpOwogICAgICAvLyBBZGp1c3QgaW50ZXJuYWwgcmVhZCBvZmZzZXQgaWYgYW4gb3B0aW9uYWwgcmVhZCBvZmZzZXQgd2FzIG5vdCBwcm92aWRlZC4KICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgdGhpcy5fcmVhZE9mZnNldCArPSBieXRlU2l6ZTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIEluc2VydHMgYSBudW1lcmljIG51bWJlciB2YWx1ZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gb2Zmc2V0IGFuZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAdHlwZXBhcmFtIFQgeyBudW1iZXIgfCBiaWdpbnQgfSBUaGUgdHlwZSBvZiB0aGUgdmFsdWUgdG8gYmUgd3JpdHRlbgogICAgICoKICAgICAqIEBwYXJhbSBmdW5jIHsgRnVuY3Rpb24ob2Zmc2V0OiBULCBvZmZzZXQ/KSA9PiBudW1iZXJ9IFRoZSBmdW5jdGlvbiB0byB3cml0ZSBkYXRhIG9uIHRoZSBpbnRlcm5hbCBCdWZmZXIgd2l0aC4KICAgICAqIEBwYXJhbSBieXRlU2l6ZSB7IE51bWJlciB9IFRoZSBudW1iZXIgb2YgYnl0ZXMgd3JpdHRlbi4KICAgICAqIEBwYXJhbSB2YWx1ZSB7IFQgfSBUaGUgbnVtYmVyIHZhbHVlIHRvIHdyaXRlLgogICAgICogQHBhcmFtIG9mZnNldCB7IE51bWJlciB9IHRoZSBvZmZzZXQgdG8gd3JpdGUgdGhlIG51bWJlciBhdCAoUkVRVUlSRUQpLgogICAgICoKICAgICAqIEByZXR1cm5zIFNtYXJ0QnVmZmVyIHRoaXMgYnVmZmVyCiAgICAgKi8KICAgIF9pbnNlcnROdW1iZXJWYWx1ZShmdW5jLCBieXRlU2l6ZSwgdmFsdWUsIG9mZnNldCkgewogICAgICAvLyBDaGVjayBmb3IgaW52YWxpZCBvZmZzZXQgdmFsdWVzLgogICAgICB1dGlsc18xLmNoZWNrT2Zmc2V0VmFsdWUob2Zmc2V0KTsKICAgICAgLy8gRW5zdXJlIHRoZXJlIGlzIGVub3VnaCBpbnRlcm5hbCBCdWZmZXIgY2FwYWNpdHkuIChyYXcgb2Zmc2V0IGlzIHBhc3NlZCkKICAgICAgdGhpcy5lbnN1cmVJbnNlcnRhYmxlKGJ5dGVTaXplLCBvZmZzZXQpOwogICAgICAvLyBDYWxsIGJ1ZmZlci53cml0ZVhYWFgoKTsKICAgICAgZnVuYy5jYWxsKHRoaXMuX2J1ZmYsIHZhbHVlLCBvZmZzZXQpOwogICAgICAvLyBBZGp1c3RzIGludGVybmFsbHkgbWFuYWdlZCB3cml0ZSBvZmZzZXQuCiAgICAgIHRoaXMuX3dyaXRlT2Zmc2V0ICs9IGJ5dGVTaXplOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogV3JpdGVzIGEgbnVtZXJpYyBudW1iZXIgdmFsdWUgYmFzZWQgb24gdGhlIGdpdmVuIG9mZnNldCBhbmQgdmFsdWUuCiAgICAgKgogICAgICogQHR5cGVwYXJhbSBUIHsgbnVtYmVyIHwgYmlnaW50IH0gVGhlIHR5cGUgb2YgdGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4KICAgICAqCiAgICAgKiBAcGFyYW0gZnVuYyB7IEZ1bmN0aW9uKG9mZnNldDogVCwgb2Zmc2V0PykgPT4gbnVtYmVyfSBUaGUgZnVuY3Rpb24gdG8gd3JpdGUgZGF0YSBvbiB0aGUgaW50ZXJuYWwgQnVmZmVyIHdpdGguCiAgICAgKiBAcGFyYW0gYnl0ZVNpemUgeyBOdW1iZXIgfSBUaGUgbnVtYmVyIG9mIGJ5dGVzIHdyaXR0ZW4uCiAgICAgKiBAcGFyYW0gdmFsdWUgeyBUIH0gVGhlIG51bWJlciB2YWx1ZSB0byB3cml0ZS4KICAgICAqIEBwYXJhbSBvZmZzZXQgeyBOdW1iZXIgfSB0aGUgb2Zmc2V0IHRvIHdyaXRlIHRoZSBudW1iZXIgYXQgKFJFUVVJUkVEKS4KICAgICAqCiAgICAgKiBAcmV0dXJucyBTbWFydEJ1ZmZlciB0aGlzIGJ1ZmZlcgogICAgICovCiAgICBfd3JpdGVOdW1iZXJWYWx1ZShmdW5jLCBieXRlU2l6ZSwgdmFsdWUsIG9mZnNldCkgewogICAgICAvLyBJZiBhbiBvZmZzZXQgd2FzIHByb3ZpZGVkLCB2YWxpZGF0ZSBpdC4KICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgd3JpdGluZyBiZXlvbmQgdGhlIGJvdW5kcyBvZiB0aGUgbWFuYWdlZCBkYXRhLgogICAgICAgIGlmIChvZmZzZXQgPCAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IodXRpbHNfMS5FUlJPUlMuSU5WQUxJRF9XUklURV9CRVlPTkRfQk9VTkRTKTsKICAgICAgICB9CiAgICAgICAgdXRpbHNfMS5jaGVja09mZnNldFZhbHVlKG9mZnNldCk7CiAgICAgIH0KICAgICAgLy8gRGVmYXVsdCB0byB3cml0ZU9mZnNldCBpZiBubyBvZmZzZXQgdmFsdWUgd2FzIGdpdmVuLgogICAgICBjb25zdCBvZmZzZXRWYWwgPSB0eXBlb2Ygb2Zmc2V0ID09PSAnbnVtYmVyJyA/IG9mZnNldCA6IHRoaXMuX3dyaXRlT2Zmc2V0OwogICAgICAvLyBFbnN1cmUgdGhlcmUgaXMgZW5vdWdoIGludGVybmFsIEJ1ZmZlciBjYXBhY2l0eS4gKHJhdyBvZmZzZXQgaXMgcGFzc2VkKQogICAgICB0aGlzLl9lbnN1cmVXcml0ZWFibGUoYnl0ZVNpemUsIG9mZnNldFZhbCk7CiAgICAgIGZ1bmMuY2FsbCh0aGlzLl9idWZmLCB2YWx1ZSwgb2Zmc2V0VmFsKTsKICAgICAgLy8gSWYgYW4gb2Zmc2V0IHdhcyBnaXZlbiwgY2hlY2sgdG8gc2VlIGlmIHdlIHdyb3RlIGJleW9uZCB0aGUgY3VycmVudCB3cml0ZU9mZnNldC4KICAgICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhpcy5fd3JpdGVPZmZzZXQgPSBNYXRoLm1heCh0aGlzLl93cml0ZU9mZnNldCwgb2Zmc2V0VmFsICsgYnl0ZVNpemUpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIG5vIG51bWVyaWMgb2Zmc2V0IHdhcyBnaXZlbiwgd2Ugd3JvdGUgdG8gdGhlIGVuZCBvZiB0aGUgU21hcnRCdWZmZXIgc28gaW5jcmVtZW50IHdyaXRlT2Zmc2V0LgogICAgICAgIHRoaXMuX3dyaXRlT2Zmc2V0ICs9IGJ5dGVTaXplOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0KICBzbWFydGJ1ZmZlci5TbWFydEJ1ZmZlciA9IFNtYXJ0QnVmZmVyOwogIHJldHVybiBzbWFydGJ1ZmZlcjsKfQoKdmFyIGNvbnN0YW50cyQyID0ge307Cgp2YXIgaGFzUmVxdWlyZWRDb25zdGFudHMkMjsKZnVuY3Rpb24gcmVxdWlyZUNvbnN0YW50cyQyKCkgewogIGlmIChoYXNSZXF1aXJlZENvbnN0YW50cyQyKSByZXR1cm4gY29uc3RhbnRzJDI7CiAgaGFzUmVxdWlyZWRDb25zdGFudHMkMiA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnN0YW50cyQyLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgY29uc3RhbnRzJDIuU09DS1M1X05PX0FDQ0VQVEFCTEVfQVVUSCA9IGNvbnN0YW50cyQyLlNPQ0tTNV9DVVNUT01fQVVUSF9FTkQgPSBjb25zdGFudHMkMi5TT0NLUzVfQ1VTVE9NX0FVVEhfU1RBUlQgPSBjb25zdGFudHMkMi5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMgPSBjb25zdGFudHMkMi5Tb2Nrc0NsaWVudFN0YXRlID0gY29uc3RhbnRzJDIuU29ja3M1UmVzcG9uc2UgPSBjb25zdGFudHMkMi5Tb2NrczVIb3N0VHlwZSA9IGNvbnN0YW50cyQyLlNvY2tzNUF1dGggPSBjb25zdGFudHMkMi5Tb2NrczRSZXNwb25zZSA9IGNvbnN0YW50cyQyLlNvY2tzQ29tbWFuZCA9IGNvbnN0YW50cyQyLkVSUk9SUyA9IGNvbnN0YW50cyQyLkRFRkFVTFRfVElNRU9VVCA9IHZvaWQgMDsKICBjb25zdCBERUZBVUxUX1RJTUVPVVQgPSAzMDAwMDsKICBjb25zdGFudHMkMi5ERUZBVUxUX1RJTUVPVVQgPSBERUZBVUxUX1RJTUVPVVQ7CiAgLy8gcHJldHRpZXItaWdub3JlCiAgY29uc3QgRVJST1JTID0gewogICAgSW52YWxpZFNvY2tzQ29tbWFuZDogJ0FuIGludmFsaWQgU09DS1MgY29tbWFuZCB3YXMgcHJvdmlkZWQuIFZhbGlkIG9wdGlvbnMgYXJlIGNvbm5lY3QsIGJpbmQsIGFuZCBhc3NvY2lhdGUuJywKICAgIEludmFsaWRTb2Nrc0NvbW1hbmRGb3JPcGVyYXRpb246ICdBbiBpbnZhbGlkIFNPQ0tTIGNvbW1hbmQgd2FzIHByb3ZpZGVkLiBPbmx5IGEgc3Vic2V0IG9mIGNvbW1hbmRzIGFyZSBzdXBwb3J0ZWQgZm9yIHRoaXMgb3BlcmF0aW9uLicsCiAgICBJbnZhbGlkU29ja3NDb21tYW5kQ2hhaW46ICdBbiBpbnZhbGlkIFNPQ0tTIGNvbW1hbmQgd2FzIHByb3ZpZGVkLiBDaGFpbmluZyBjdXJyZW50bHkgb25seSBzdXBwb3J0cyB0aGUgY29ubmVjdCBjb21tYW5kLicsCiAgICBJbnZhbGlkU29ja3NDbGllbnRPcHRpb25zRGVzdGluYXRpb246ICdBbiBpbnZhbGlkIGRlc3RpbmF0aW9uIGhvc3Qgd2FzIHByb3ZpZGVkLicsCiAgICBJbnZhbGlkU29ja3NDbGllbnRPcHRpb25zRXhpc3RpbmdTb2NrZXQ6ICdBbiBpbnZhbGlkIGV4aXN0aW5nIHNvY2tldCB3YXMgcHJvdmlkZWQuIFRoaXMgc2hvdWxkIGJlIGFuIGluc3RhbmNlIG9mIHN0cmVhbS5EdXBsZXguJywKICAgIEludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNQcm94eTogJ0ludmFsaWQgU09DS1MgcHJveHkgZGV0YWlscyB3ZXJlIHByb3ZpZGVkLicsCiAgICBJbnZhbGlkU29ja3NDbGllbnRPcHRpb25zVGltZW91dDogJ0FuIGludmFsaWQgdGltZW91dCB2YWx1ZSB3YXMgcHJvdmlkZWQuIFBsZWFzZSBlbnRlciBhIHZhbHVlIGFib3ZlIDAgKGluIG1zKS4nLAogICAgSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc1Byb3hpZXNMZW5ndGg6ICdBdCBsZWFzdCB0d28gc29ja3MgcHJveGllcyBtdXN0IGJlIHByb3ZpZGVkIGZvciBjaGFpbmluZy4nLAogICAgSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc0N1c3RvbUF1dGhSYW5nZTogJ0N1c3RvbSBhdXRoIG11c3QgYmUgYSB2YWx1ZSBiZXR3ZWVuIDB4ODAgYW5kIDB4RkUuJywKICAgIEludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNDdXN0b21BdXRoT3B0aW9uczogJ1doZW4gYSBjdXN0b21fYXV0aF9tZXRob2QgaXMgcHJvdmlkZWQsIGN1c3RvbV9hdXRoX3JlcXVlc3RfaGFuZGxlciwgY3VzdG9tX2F1dGhfcmVzcG9uc2Vfc2l6ZSwgYW5kIGN1c3RvbV9hdXRoX3Jlc3BvbnNlX2hhbmRsZXIgbXVzdCBhbHNvIGJlIHByb3ZpZGVkIGFuZCB2YWxpZC4nLAogICAgTmVnb3RpYXRpb25FcnJvcjogJ05lZ290aWF0aW9uIGVycm9yJywKICAgIFNvY2tldENsb3NlZDogJ1NvY2tldCBjbG9zZWQnLAogICAgUHJveHlDb25uZWN0aW9uVGltZWRPdXQ6ICdQcm94eSBjb25uZWN0aW9uIHRpbWVkIG91dCcsCiAgICBJbnRlcm5hbEVycm9yOiAnU29ja3NDbGllbnQgaW50ZXJuYWwgZXJyb3IgKHRoaXMgc2hvdWxkIG5vdCBoYXBwZW4pJywKICAgIEludmFsaWRTb2NrczRIYW5kc2hha2VSZXNwb25zZTogJ1JlY2VpdmVkIGludmFsaWQgU29ja3M0IGhhbmRzaGFrZSByZXNwb25zZScsCiAgICBTb2NrczRQcm94eVJlamVjdGVkQ29ubmVjdGlvbjogJ1NvY2tzNCBQcm94eSByZWplY3RlZCBjb25uZWN0aW9uJywKICAgIEludmFsaWRTb2NrczRJbmNvbWluZ0Nvbm5lY3Rpb25SZXNwb25zZTogJ1NvY2tzNCBpbnZhbGlkIGluY29taW5nIGNvbm5lY3Rpb24gcmVzcG9uc2UnLAogICAgU29ja3M0UHJveHlSZWplY3RlZEluY29taW5nQm91bmRDb25uZWN0aW9uOiAnU29ja3M0IFByb3h5IHJlamVjdGVkIGluY29taW5nIGJvdW5kIGNvbm5lY3Rpb24nLAogICAgSW52YWxpZFNvY2tzNUluaXRpYWxIYW5kc2hha2VSZXNwb25zZTogJ1JlY2VpdmVkIGludmFsaWQgU29ja3M1IGluaXRpYWwgaGFuZHNoYWtlIHJlc3BvbnNlJywKICAgIEludmFsaWRTb2NrczVJbnRpYWlsSGFuZHNoYWtlU29ja3NWZXJzaW9uOiAnUmVjZWl2ZWQgaW52YWxpZCBTb2NrczUgaW5pdGlhbCBoYW5kc2hha2UgKGludmFsaWQgc29ja3MgdmVyc2lvbiknLAogICAgSW52YWxpZFNvY2tzNUluaXRpYWxIYW5kc2hha2VOb0FjY2VwdGVkQXV0aFR5cGU6ICdSZWNlaXZlZCBpbnZhbGlkIFNvY2tzNSBpbml0aWFsIGhhbmRzaGFrZSAobm8gYWNjZXB0ZWQgYXV0aGVudGljYXRpb24gdHlwZSknLAogICAgSW52YWxpZFNvY2tzNUluaXRpYWxIYW5kc2hha2VVbmtub3duQXV0aFR5cGU6ICdSZWNlaXZlZCBpbnZhbGlkIFNvY2tzNSBpbml0aWFsIGhhbmRzaGFrZSAodW5rbm93biBhdXRoZW50aWNhdGlvbiB0eXBlKScsCiAgICBTb2NrczVBdXRoZW50aWNhdGlvbkZhaWxlZDogJ1NvY2tzNSBBdXRoZW50aWNhdGlvbiBmYWlsZWQnLAogICAgSW52YWxpZFNvY2tzNUZpbmFsSGFuZHNoYWtlOiAnUmVjZWl2ZWQgaW52YWxpZCBTb2NrczUgZmluYWwgaGFuZHNoYWtlIHJlc3BvbnNlJywKICAgIEludmFsaWRTb2NrczVGaW5hbEhhbmRzaGFrZVJlamVjdGVkOiAnU29ja3M1IHByb3h5IHJlamVjdGVkIGNvbm5lY3Rpb24nLAogICAgSW52YWxpZFNvY2tzNUluY29taW5nQ29ubmVjdGlvblJlc3BvbnNlOiAnUmVjZWl2ZWQgaW52YWxpZCBTb2NrczUgaW5jb21pbmcgY29ubmVjdGlvbiByZXNwb25zZScsCiAgICBTb2NrczVQcm94eVJlamVjdGVkSW5jb21pbmdCb3VuZENvbm5lY3Rpb246ICdTb2NrczUgUHJveHkgcmVqZWN0ZWQgaW5jb21pbmcgYm91bmQgY29ubmVjdGlvbicKICB9OwogIGNvbnN0YW50cyQyLkVSUk9SUyA9IEVSUk9SUzsKICBjb25zdCBTT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMgPSB7CiAgICBTb2NrczVJbml0aWFsSGFuZHNoYWtlUmVzcG9uc2U6IDIsCiAgICBTb2NrczVVc2VyUGFzc0F1dGhlbnRpY2F0aW9uUmVzcG9uc2U6IDIsCiAgICAvLyBDb21tYW5kIHJlc3BvbnNlICsgaW5jb21pbmcgY29ubmVjdGlvbiAoYmluZCkKICAgIFNvY2tzNVJlc3BvbnNlSGVhZGVyOiA1LAogICAgLy8gV2UgbmVlZCBhdCBsZWFzdCA1IHRvIHJlYWQgdGhlIGhvc3RuYW1lIGxlbmd0aCwgdGhlbiB3ZSB3YWl0IGZvciB0aGUgYWRkcmVzcytwb3J0IGluZm9ybWF0aW9uLgogICAgU29ja3M1UmVzcG9uc2VJUHY0OiAxMCwKICAgIC8vIDQgaGVhZGVyICsgNCBpcCArIDIgcG9ydAogICAgU29ja3M1UmVzcG9uc2VJUHY2OiAyMiwKICAgIC8vIDQgaGVhZGVyICsgMTYgaXAgKyAyIHBvcnQKICAgIFNvY2tzNVJlc3BvbnNlSG9zdG5hbWU6IGhvc3ROYW1lTGVuZ3RoID0+IGhvc3ROYW1lTGVuZ3RoICsgNywKICAgIC8vIDQgaGVhZGVyICsgMSBob3N0IGxlbmd0aCArIGhvc3QgKyAyIHBvcnQKICAgIC8vIENvbW1hbmQgcmVzcG9uc2UgKyBpbmNvbWluZyBjb25uZWN0aW9uIChiaW5kKQogICAgU29ja3M0UmVzcG9uc2U6IDggLy8gMiBoZWFkZXIgKyAyIHBvcnQgKyA0IGlwCiAgfTsKICBjb25zdGFudHMkMi5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMgPSBTT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVM7CiAgdmFyIFNvY2tzQ29tbWFuZDsKICAoZnVuY3Rpb24gKFNvY2tzQ29tbWFuZCkgewogICAgU29ja3NDb21tYW5kW1NvY2tzQ29tbWFuZFsiY29ubmVjdCJdID0gMV0gPSAiY29ubmVjdCI7CiAgICBTb2Nrc0NvbW1hbmRbU29ja3NDb21tYW5kWyJiaW5kIl0gPSAyXSA9ICJiaW5kIjsKICAgIFNvY2tzQ29tbWFuZFtTb2Nrc0NvbW1hbmRbImFzc29jaWF0ZSJdID0gM10gPSAiYXNzb2NpYXRlIjsKICB9KShTb2Nrc0NvbW1hbmQgfHwgKGNvbnN0YW50cyQyLlNvY2tzQ29tbWFuZCA9IFNvY2tzQ29tbWFuZCA9IHt9KSk7CiAgdmFyIFNvY2tzNFJlc3BvbnNlOwogIChmdW5jdGlvbiAoU29ja3M0UmVzcG9uc2UpIHsKICAgIFNvY2tzNFJlc3BvbnNlW1NvY2tzNFJlc3BvbnNlWyJHcmFudGVkIl0gPSA5MF0gPSAiR3JhbnRlZCI7CiAgICBTb2NrczRSZXNwb25zZVtTb2NrczRSZXNwb25zZVsiRmFpbGVkIl0gPSA5MV0gPSAiRmFpbGVkIjsKICAgIFNvY2tzNFJlc3BvbnNlW1NvY2tzNFJlc3BvbnNlWyJSZWplY3RlZCJdID0gOTJdID0gIlJlamVjdGVkIjsKICAgIFNvY2tzNFJlc3BvbnNlW1NvY2tzNFJlc3BvbnNlWyJSZWplY3RlZElkZW50Il0gPSA5M10gPSAiUmVqZWN0ZWRJZGVudCI7CiAgfSkoU29ja3M0UmVzcG9uc2UgfHwgKGNvbnN0YW50cyQyLlNvY2tzNFJlc3BvbnNlID0gU29ja3M0UmVzcG9uc2UgPSB7fSkpOwogIHZhciBTb2NrczVBdXRoOwogIChmdW5jdGlvbiAoU29ja3M1QXV0aCkgewogICAgU29ja3M1QXV0aFtTb2NrczVBdXRoWyJOb0F1dGgiXSA9IDBdID0gIk5vQXV0aCI7CiAgICBTb2NrczVBdXRoW1NvY2tzNUF1dGhbIkdTU0FwaSJdID0gMV0gPSAiR1NTQXBpIjsKICAgIFNvY2tzNUF1dGhbU29ja3M1QXV0aFsiVXNlclBhc3MiXSA9IDJdID0gIlVzZXJQYXNzIjsKICB9KShTb2NrczVBdXRoIHx8IChjb25zdGFudHMkMi5Tb2NrczVBdXRoID0gU29ja3M1QXV0aCA9IHt9KSk7CiAgY29uc3QgU09DS1M1X0NVU1RPTV9BVVRIX1NUQVJUID0gMHg4MDsKICBjb25zdGFudHMkMi5TT0NLUzVfQ1VTVE9NX0FVVEhfU1RBUlQgPSBTT0NLUzVfQ1VTVE9NX0FVVEhfU1RBUlQ7CiAgY29uc3QgU09DS1M1X0NVU1RPTV9BVVRIX0VORCA9IDB4ZmU7CiAgY29uc3RhbnRzJDIuU09DS1M1X0NVU1RPTV9BVVRIX0VORCA9IFNPQ0tTNV9DVVNUT01fQVVUSF9FTkQ7CiAgY29uc3QgU09DS1M1X05PX0FDQ0VQVEFCTEVfQVVUSCA9IDB4ZmY7CiAgY29uc3RhbnRzJDIuU09DS1M1X05PX0FDQ0VQVEFCTEVfQVVUSCA9IFNPQ0tTNV9OT19BQ0NFUFRBQkxFX0FVVEg7CiAgdmFyIFNvY2tzNVJlc3BvbnNlOwogIChmdW5jdGlvbiAoU29ja3M1UmVzcG9uc2UpIHsKICAgIFNvY2tzNVJlc3BvbnNlW1NvY2tzNVJlc3BvbnNlWyJHcmFudGVkIl0gPSAwXSA9ICJHcmFudGVkIjsKICAgIFNvY2tzNVJlc3BvbnNlW1NvY2tzNVJlc3BvbnNlWyJGYWlsdXJlIl0gPSAxXSA9ICJGYWlsdXJlIjsKICAgIFNvY2tzNVJlc3BvbnNlW1NvY2tzNVJlc3BvbnNlWyJOb3RBbGxvd2VkIl0gPSAyXSA9ICJOb3RBbGxvd2VkIjsKICAgIFNvY2tzNVJlc3BvbnNlW1NvY2tzNVJlc3BvbnNlWyJOZXR3b3JrVW5yZWFjaGFibGUiXSA9IDNdID0gIk5ldHdvcmtVbnJlYWNoYWJsZSI7CiAgICBTb2NrczVSZXNwb25zZVtTb2NrczVSZXNwb25zZVsiSG9zdFVucmVhY2hhYmxlIl0gPSA0XSA9ICJIb3N0VW5yZWFjaGFibGUiOwogICAgU29ja3M1UmVzcG9uc2VbU29ja3M1UmVzcG9uc2VbIkNvbm5lY3Rpb25SZWZ1c2VkIl0gPSA1XSA9ICJDb25uZWN0aW9uUmVmdXNlZCI7CiAgICBTb2NrczVSZXNwb25zZVtTb2NrczVSZXNwb25zZVsiVFRMRXhwaXJlZCJdID0gNl0gPSAiVFRMRXhwaXJlZCI7CiAgICBTb2NrczVSZXNwb25zZVtTb2NrczVSZXNwb25zZVsiQ29tbWFuZE5vdFN1cHBvcnRlZCJdID0gN10gPSAiQ29tbWFuZE5vdFN1cHBvcnRlZCI7CiAgICBTb2NrczVSZXNwb25zZVtTb2NrczVSZXNwb25zZVsiQWRkcmVzc05vdFN1cHBvcnRlZCJdID0gOF0gPSAiQWRkcmVzc05vdFN1cHBvcnRlZCI7CiAgfSkoU29ja3M1UmVzcG9uc2UgfHwgKGNvbnN0YW50cyQyLlNvY2tzNVJlc3BvbnNlID0gU29ja3M1UmVzcG9uc2UgPSB7fSkpOwogIHZhciBTb2NrczVIb3N0VHlwZTsKICAoZnVuY3Rpb24gKFNvY2tzNUhvc3RUeXBlKSB7CiAgICBTb2NrczVIb3N0VHlwZVtTb2NrczVIb3N0VHlwZVsiSVB2NCJdID0gMV0gPSAiSVB2NCI7CiAgICBTb2NrczVIb3N0VHlwZVtTb2NrczVIb3N0VHlwZVsiSG9zdG5hbWUiXSA9IDNdID0gIkhvc3RuYW1lIjsKICAgIFNvY2tzNUhvc3RUeXBlW1NvY2tzNUhvc3RUeXBlWyJJUHY2Il0gPSA0XSA9ICJJUHY2IjsKICB9KShTb2NrczVIb3N0VHlwZSB8fCAoY29uc3RhbnRzJDIuU29ja3M1SG9zdFR5cGUgPSBTb2NrczVIb3N0VHlwZSA9IHt9KSk7CiAgdmFyIFNvY2tzQ2xpZW50U3RhdGU7CiAgKGZ1bmN0aW9uIChTb2Nrc0NsaWVudFN0YXRlKSB7CiAgICBTb2Nrc0NsaWVudFN0YXRlW1NvY2tzQ2xpZW50U3RhdGVbIkNyZWF0ZWQiXSA9IDBdID0gIkNyZWF0ZWQiOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJDb25uZWN0aW5nIl0gPSAxXSA9ICJDb25uZWN0aW5nIjsKICAgIFNvY2tzQ2xpZW50U3RhdGVbU29ja3NDbGllbnRTdGF0ZVsiQ29ubmVjdGVkIl0gPSAyXSA9ICJDb25uZWN0ZWQiOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJTZW50SW5pdGlhbEhhbmRzaGFrZSJdID0gM10gPSAiU2VudEluaXRpYWxIYW5kc2hha2UiOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJSZWNlaXZlZEluaXRpYWxIYW5kc2hha2VSZXNwb25zZSJdID0gNF0gPSAiUmVjZWl2ZWRJbml0aWFsSGFuZHNoYWtlUmVzcG9uc2UiOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJTZW50QXV0aGVudGljYXRpb24iXSA9IDVdID0gIlNlbnRBdXRoZW50aWNhdGlvbiI7CiAgICBTb2Nrc0NsaWVudFN0YXRlW1NvY2tzQ2xpZW50U3RhdGVbIlJlY2VpdmVkQXV0aGVudGljYXRpb25SZXNwb25zZSJdID0gNl0gPSAiUmVjZWl2ZWRBdXRoZW50aWNhdGlvblJlc3BvbnNlIjsKICAgIFNvY2tzQ2xpZW50U3RhdGVbU29ja3NDbGllbnRTdGF0ZVsiU2VudEZpbmFsSGFuZHNoYWtlIl0gPSA3XSA9ICJTZW50RmluYWxIYW5kc2hha2UiOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJSZWNlaXZlZEZpbmFsUmVzcG9uc2UiXSA9IDhdID0gIlJlY2VpdmVkRmluYWxSZXNwb25zZSI7CiAgICBTb2Nrc0NsaWVudFN0YXRlW1NvY2tzQ2xpZW50U3RhdGVbIkJvdW5kV2FpdGluZ0ZvckNvbm5lY3Rpb24iXSA9IDldID0gIkJvdW5kV2FpdGluZ0ZvckNvbm5lY3Rpb24iOwogICAgU29ja3NDbGllbnRTdGF0ZVtTb2Nrc0NsaWVudFN0YXRlWyJFc3RhYmxpc2hlZCJdID0gMTBdID0gIkVzdGFibGlzaGVkIjsKICAgIFNvY2tzQ2xpZW50U3RhdGVbU29ja3NDbGllbnRTdGF0ZVsiRGlzY29ubmVjdGVkIl0gPSAxMV0gPSAiRGlzY29ubmVjdGVkIjsKICAgIFNvY2tzQ2xpZW50U3RhdGVbU29ja3NDbGllbnRTdGF0ZVsiRXJyb3IiXSA9IDk5XSA9ICJFcnJvciI7CiAgfSkoU29ja3NDbGllbnRTdGF0ZSB8fCAoY29uc3RhbnRzJDIuU29ja3NDbGllbnRTdGF0ZSA9IFNvY2tzQ2xpZW50U3RhdGUgPSB7fSkpOwogIHJldHVybiBjb25zdGFudHMkMjsKfQoKdmFyIGhlbHBlcnMkMSA9IHt9OwoKdmFyIHV0aWwgPSB7fTsKCnZhciBoYXNSZXF1aXJlZFV0aWw7CmZ1bmN0aW9uIHJlcXVpcmVVdGlsKCkgewogIGlmIChoYXNSZXF1aXJlZFV0aWwpIHJldHVybiB1dGlsOwogIGhhc1JlcXVpcmVkVXRpbCA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHV0aWwsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICB1dGlsLnNodWZmbGVBcnJheSA9IHV0aWwuU29ja3NDbGllbnRFcnJvciA9IHZvaWQgMDsKICAvKioKICAgKiBFcnJvciB3cmFwcGVyIGZvciBTb2Nrc0NsaWVudAogICAqLwogIGNsYXNzIFNvY2tzQ2xpZW50RXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfQogIH0KICB1dGlsLlNvY2tzQ2xpZW50RXJyb3IgPSBTb2Nrc0NsaWVudEVycm9yOwogIC8qKgogICAqIFNodWZmbGVzIGEgZ2l2ZW4gYXJyYXkuCiAgICogQHBhcmFtIGFycmF5IFRoZSBhcnJheSB0byBzaHVmZmxlLgogICAqLwogIGZ1bmN0aW9uIHNodWZmbGVBcnJheShhcnJheSkgewogICAgZm9yIChsZXQgaSA9IGFycmF5Lmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKICAgICAgY29uc3QgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChpICsgMSkpOwogICAgICBbYXJyYXlbaV0sIGFycmF5W2pdXSA9IFthcnJheVtqXSwgYXJyYXlbaV1dOwogICAgfQogIH0KICB1dGlsLnNodWZmbGVBcnJheSA9IHNodWZmbGVBcnJheTsKICByZXR1cm4gdXRpbDsKfQoKdmFyIGlwQWRkcmVzcyA9IHt9OwoKdmFyIGlwdjQgPSB7fTsKCnZhciBjb21tb24gPSB7fTsKCnZhciBoYXNSZXF1aXJlZENvbW1vbjsKZnVuY3Rpb24gcmVxdWlyZUNvbW1vbigpIHsKICBpZiAoaGFzUmVxdWlyZWRDb21tb24pIHJldHVybiBjb21tb247CiAgaGFzUmVxdWlyZWRDb21tb24gPSAxOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb21tb24sICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb21tb24uaXNDb3JyZWN0ID0gY29tbW9uLmlzSW5TdWJuZXQgPSB2b2lkIDA7CiAgZnVuY3Rpb24gaXNJblN1Ym5ldChhZGRyZXNzKSB7CiAgICBpZiAodGhpcy5zdWJuZXRNYXNrIDwgYWRkcmVzcy5zdWJuZXRNYXNrKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmICh0aGlzLm1hc2soYWRkcmVzcy5zdWJuZXRNYXNrKSA9PT0gYWRkcmVzcy5tYXNrKCkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbW1vbi5pc0luU3VibmV0ID0gaXNJblN1Ym5ldDsKICBmdW5jdGlvbiBpc0NvcnJlY3QoZGVmYXVsdEJpdHMpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0aGlzLmFkZHJlc3NNaW51c1N1ZmZpeCAhPT0gdGhpcy5jb3JyZWN0Rm9ybSgpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0aGlzLnN1Ym5ldE1hc2sgPT09IGRlZmF1bHRCaXRzICYmICF0aGlzLnBhcnNlZFN1Ym5ldCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnBhcnNlZFN1Ym5ldCA9PT0gU3RyaW5nKHRoaXMuc3VibmV0TWFzayk7CiAgICB9OwogIH0KICBjb21tb24uaXNDb3JyZWN0ID0gaXNDb3JyZWN0OwogIHJldHVybiBjb21tb247Cn0KCnZhciBjb25zdGFudHMkMSA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkQ29uc3RhbnRzJDE7CmZ1bmN0aW9uIHJlcXVpcmVDb25zdGFudHMkMSgpIHsKICBpZiAoaGFzUmVxdWlyZWRDb25zdGFudHMkMSkgcmV0dXJuIGNvbnN0YW50cyQxOwogIGhhc1JlcXVpcmVkQ29uc3RhbnRzJDEgPSAxOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb25zdGFudHMkMSwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGNvbnN0YW50cyQxLlJFX1NVQk5FVF9TVFJJTkcgPSBjb25zdGFudHMkMS5SRV9BRERSRVNTID0gY29uc3RhbnRzJDEuR1JPVVBTID0gY29uc3RhbnRzJDEuQklUUyA9IHZvaWQgMDsKICBjb25zdGFudHMkMS5CSVRTID0gMzI7CiAgY29uc3RhbnRzJDEuR1JPVVBTID0gNDsKICBjb25zdGFudHMkMS5SRV9BRERSRVNTID0gL14oMjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KVwuKDI1WzAtNV18MlswLTRdWzAtOV18WzAxXT9bMC05XVswLTldPylcLigyNVswLTVdfDJbMC00XVswLTldfFswMV0/WzAtOV1bMC05XT8pXC4oMjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KSQvZzsKICBjb25zdGFudHMkMS5SRV9TVUJORVRfU1RSSU5HID0gL1wvXGR7MSwyfSQvOwogIHJldHVybiBjb25zdGFudHMkMTsKfQoKdmFyIGFkZHJlc3NFcnJvciA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkQWRkcmVzc0Vycm9yOwpmdW5jdGlvbiByZXF1aXJlQWRkcmVzc0Vycm9yKCkgewogIGlmIChoYXNSZXF1aXJlZEFkZHJlc3NFcnJvcikgcmV0dXJuIGFkZHJlc3NFcnJvcjsKICBoYXNSZXF1aXJlZEFkZHJlc3NFcnJvciA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFkZHJlc3NFcnJvciwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGFkZHJlc3NFcnJvci5BZGRyZXNzRXJyb3IgPSB2b2lkIDA7CiAgY2xhc3MgQWRkcmVzc0Vycm9yIGV4dGVuZHMgRXJyb3IgewogICAgY29uc3RydWN0b3IobWVzc2FnZSwgcGFyc2VNZXNzYWdlKSB7CiAgICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgICB0aGlzLm5hbWUgPSAnQWRkcmVzc0Vycm9yJzsKICAgICAgaWYgKHBhcnNlTWVzc2FnZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMucGFyc2VNZXNzYWdlID0gcGFyc2VNZXNzYWdlOwogICAgICB9CiAgICB9CiAgfQogIGFkZHJlc3NFcnJvci5BZGRyZXNzRXJyb3IgPSBBZGRyZXNzRXJyb3I7CiAgcmV0dXJuIGFkZHJlc3NFcnJvcjsKfQoKdmFyIGpzYm4gPSB7ZXhwb3J0czoge319OwoKdmFyIGhhc1JlcXVpcmVkSnNibjsKZnVuY3Rpb24gcmVxdWlyZUpzYm4oKSB7CiAgaWYgKGhhc1JlcXVpcmVkSnNibikgcmV0dXJuIGpzYm4uZXhwb3J0czsKICBoYXNSZXF1aXJlZEpzYm4gPSAxOwogIChmdW5jdGlvbiAobW9kdWxlLCBleHBvcnRzKSB7CiAgICAoZnVuY3Rpb24gKCkgewogICAgICAvLyBDb3B5cmlnaHQgKGMpIDIwMDUgIFRvbSBXdQogICAgICAvLyBBbGwgUmlnaHRzIFJlc2VydmVkLgogICAgICAvLyBTZWUgIkxJQ0VOU0UiIGZvciBkZXRhaWxzLgoKICAgICAgLy8gQmFzaWMgSmF2YVNjcmlwdCBCTiBsaWJyYXJ5IC0gc3Vic2V0IHVzZWZ1bCBmb3IgUlNBIGVuY3J5cHRpb24uCgogICAgICAvLyBCaXRzIHBlciBkaWdpdAogICAgICB2YXIgZGJpdHM7CgogICAgICAvLyBKYXZhU2NyaXB0IGVuZ2luZSBhbmFseXNpcwogICAgICB2YXIgY2FuYXJ5ID0gMHhkZWFkYmVlZmNhZmU7CiAgICAgIHZhciBqX2xtID0gKGNhbmFyeSAmIDB4ZmZmZmZmKSA9PSAweGVmY2FmZTsKCiAgICAgIC8vIChwdWJsaWMpIENvbnN0cnVjdG9yCiAgICAgIGZ1bmN0aW9uIEJpZ0ludGVnZXIoYSwgYiwgYykgewogICAgICAgIGlmIChhICE9IG51bGwpIGlmICgibnVtYmVyIiA9PSB0eXBlb2YgYSkgdGhpcy5mcm9tTnVtYmVyKGEsIGIsIGMpO2Vsc2UgaWYgKGIgPT0gbnVsbCAmJiAic3RyaW5nIiAhPSB0eXBlb2YgYSkgdGhpcy5mcm9tU3RyaW5nKGEsIDI1Nik7ZWxzZSB0aGlzLmZyb21TdHJpbmcoYSwgYik7CiAgICAgIH0KCiAgICAgIC8vIHJldHVybiBuZXcsIHVuc2V0IEJpZ0ludGVnZXIKICAgICAgZnVuY3Rpb24gbmJpKCkgewogICAgICAgIHJldHVybiBuZXcgQmlnSW50ZWdlcihudWxsKTsKICAgICAgfQoKICAgICAgLy8gYW06IENvbXB1dGUgd19qICs9ICh4KnRoaXNfaSksIHByb3BhZ2F0ZSBjYXJyaWVzLAogICAgICAvLyBjIGlzIGluaXRpYWwgY2FycnksIHJldHVybnMgZmluYWwgY2FycnkuCiAgICAgIC8vIGMgPCAzKmR2YWx1ZSwgeCA8IDIqZHZhbHVlLCB0aGlzX2kgPCBkdmFsdWUKICAgICAgLy8gV2UgbmVlZCB0byBzZWxlY3QgdGhlIGZhc3Rlc3Qgb25lIHRoYXQgd29ya3MgaW4gdGhpcyBlbnZpcm9ubWVudC4KCiAgICAgIC8vIGFtMTogdXNlIGEgc2luZ2xlIG11bHQgYW5kIGRpdmlkZSB0byBnZXQgdGhlIGhpZ2ggYml0cywKICAgICAgLy8gbWF4IGRpZ2l0IGJpdHMgc2hvdWxkIGJlIDI2IGJlY2F1c2UKICAgICAgLy8gbWF4IGludGVybmFsIHZhbHVlID0gMipkdmFsdWVeMi0yKmR2YWx1ZSAoPCAyXjUzKQogICAgICBmdW5jdGlvbiBhbTEoaSwgeCwgdywgaiwgYywgbikgewogICAgICAgIHdoaWxlICgtLW4gPj0gMCkgewogICAgICAgICAgdmFyIHYgPSB4ICogdGhpc1tpKytdICsgd1tqXSArIGM7CiAgICAgICAgICBjID0gTWF0aC5mbG9vcih2IC8gMHg0MDAwMDAwKTsKICAgICAgICAgIHdbaisrXSA9IHYgJiAweDNmZmZmZmY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICAgIC8vIGFtMiBhdm9pZHMgYSBiaWcgbXVsdC1hbmQtZXh0cmFjdCBjb21wbGV0ZWx5LgogICAgICAvLyBNYXggZGlnaXQgYml0cyBzaG91bGQgYmUgPD0gMzAgYmVjYXVzZSB3ZSBkbyBiaXR3aXNlIG9wcwogICAgICAvLyBvbiB2YWx1ZXMgdXAgdG8gMipoZHZhbHVlXjItaGR2YWx1ZS0xICg8IDJeMzEpCiAgICAgIGZ1bmN0aW9uIGFtMihpLCB4LCB3LCBqLCBjLCBuKSB7CiAgICAgICAgdmFyIHhsID0geCAmIDB4N2ZmZiwKICAgICAgICAgIHhoID0geCA+PiAxNTsKICAgICAgICB3aGlsZSAoLS1uID49IDApIHsKICAgICAgICAgIHZhciBsID0gdGhpc1tpXSAmIDB4N2ZmZjsKICAgICAgICAgIHZhciBoID0gdGhpc1tpKytdID4+IDE1OwogICAgICAgICAgdmFyIG0gPSB4aCAqIGwgKyBoICogeGw7CiAgICAgICAgICBsID0geGwgKiBsICsgKChtICYgMHg3ZmZmKSA8PCAxNSkgKyB3W2pdICsgKGMgJiAweDNmZmZmZmZmKTsKICAgICAgICAgIGMgPSAobCA+Pj4gMzApICsgKG0gPj4+IDE1KSArIHhoICogaCArIChjID4+PiAzMCk7CiAgICAgICAgICB3W2orK10gPSBsICYgMHgzZmZmZmZmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0KICAgICAgLy8gQWx0ZXJuYXRlbHksIHNldCBtYXggZGlnaXQgYml0cyB0byAyOCBzaW5jZSBzb21lCiAgICAgIC8vIGJyb3dzZXJzIHNsb3cgZG93biB3aGVuIGRlYWxpbmcgd2l0aCAzMi1iaXQgbnVtYmVycy4KICAgICAgZnVuY3Rpb24gYW0zKGksIHgsIHcsIGosIGMsIG4pIHsKICAgICAgICB2YXIgeGwgPSB4ICYgMHgzZmZmLAogICAgICAgICAgeGggPSB4ID4+IDE0OwogICAgICAgIHdoaWxlICgtLW4gPj0gMCkgewogICAgICAgICAgdmFyIGwgPSB0aGlzW2ldICYgMHgzZmZmOwogICAgICAgICAgdmFyIGggPSB0aGlzW2krK10gPj4gMTQ7CiAgICAgICAgICB2YXIgbSA9IHhoICogbCArIGggKiB4bDsKICAgICAgICAgIGwgPSB4bCAqIGwgKyAoKG0gJiAweDNmZmYpIDw8IDE0KSArIHdbal0gKyBjOwogICAgICAgICAgYyA9IChsID4+IDI4KSArIChtID4+IDE0KSArIHhoICogaDsKICAgICAgICAgIHdbaisrXSA9IGwgJiAweGZmZmZmZmY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICAgIHZhciBpbkJyb3dzZXIgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIjsKICAgICAgaWYgKGluQnJvd3NlciAmJiBqX2xtICYmIG5hdmlnYXRvci5hcHBOYW1lID09ICJNaWNyb3NvZnQgSW50ZXJuZXQgRXhwbG9yZXIiKSB7CiAgICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYW0gPSBhbTI7CiAgICAgICAgZGJpdHMgPSAzMDsKICAgICAgfSBlbHNlIGlmIChpbkJyb3dzZXIgJiYgal9sbSAmJiBuYXZpZ2F0b3IuYXBwTmFtZSAhPSAiTmV0c2NhcGUiKSB7CiAgICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYW0gPSBhbTE7CiAgICAgICAgZGJpdHMgPSAyNjsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBNb3ppbGxhL05ldHNjYXBlIHNlZW1zIHRvIHByZWZlciBhbTMKICAgICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5hbSA9IGFtMzsKICAgICAgICBkYml0cyA9IDI4OwogICAgICB9CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLkRCID0gZGJpdHM7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLkRNID0gKDEgPDwgZGJpdHMpIC0gMTsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuRFYgPSAxIDw8IGRiaXRzOwogICAgICB2YXIgQklfRlAgPSA1MjsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuRlYgPSBNYXRoLnBvdygyLCBCSV9GUCk7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLkYxID0gQklfRlAgLSBkYml0czsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuRjIgPSAyICogZGJpdHMgLSBCSV9GUDsKCiAgICAgIC8vIERpZ2l0IGNvbnZlcnNpb25zCiAgICAgIHZhciBCSV9STSA9ICIwMTIzNDU2Nzg5YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXoiOwogICAgICB2YXIgQklfUkMgPSBuZXcgQXJyYXkoKTsKICAgICAgdmFyIHJyLCB2djsKICAgICAgcnIgPSAiMCIuY2hhckNvZGVBdCgwKTsKICAgICAgZm9yICh2diA9IDA7IHZ2IDw9IDk7ICsrdnYpIEJJX1JDW3JyKytdID0gdnY7CiAgICAgIHJyID0gImEiLmNoYXJDb2RlQXQoMCk7CiAgICAgIGZvciAodnYgPSAxMDsgdnYgPCAzNjsgKyt2dikgQklfUkNbcnIrK10gPSB2djsKICAgICAgcnIgPSAiQSIuY2hhckNvZGVBdCgwKTsKICAgICAgZm9yICh2diA9IDEwOyB2diA8IDM2OyArK3Z2KSBCSV9SQ1tycisrXSA9IHZ2OwogICAgICBmdW5jdGlvbiBpbnQyY2hhcihuKSB7CiAgICAgICAgcmV0dXJuIEJJX1JNLmNoYXJBdChuKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnRBdChzLCBpKSB7CiAgICAgICAgdmFyIGMgPSBCSV9SQ1tzLmNoYXJDb2RlQXQoaSldOwogICAgICAgIHJldHVybiBjID09IG51bGwgPyAtMSA6IGM7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIGNvcHkgdGhpcyB0byByCiAgICAgIGZ1bmN0aW9uIGJucENvcHlUbyhyKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMudCAtIDE7IGkgPj0gMDsgLS1pKSByW2ldID0gdGhpc1tpXTsKICAgICAgICByLnQgPSB0aGlzLnQ7CiAgICAgICAgci5zID0gdGhpcy5zOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSBzZXQgZnJvbSBpbnRlZ2VyIHZhbHVlIHgsIC1EViA8PSB4IDwgRFYKICAgICAgZnVuY3Rpb24gYm5wRnJvbUludCh4KSB7CiAgICAgICAgdGhpcy50ID0gMTsKICAgICAgICB0aGlzLnMgPSB4IDwgMCA/IC0xIDogMDsKICAgICAgICBpZiAoeCA+IDApIHRoaXNbMF0gPSB4O2Vsc2UgaWYgKHggPCAtMSkgdGhpc1swXSA9IHggKyB0aGlzLkRWO2Vsc2UgdGhpcy50ID0gMDsKICAgICAgfQoKICAgICAgLy8gcmV0dXJuIGJpZ2ludCBpbml0aWFsaXplZCB0byB2YWx1ZQogICAgICBmdW5jdGlvbiBuYnYoaSkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgci5mcm9tSW50KGkpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSBzZXQgZnJvbSBzdHJpbmcgYW5kIHJhZGl4CiAgICAgIGZ1bmN0aW9uIGJucEZyb21TdHJpbmcocywgYikgewogICAgICAgIHZhciBrOwogICAgICAgIGlmIChiID09IDE2KSBrID0gNDtlbHNlIGlmIChiID09IDgpIGsgPSAzO2Vsc2UgaWYgKGIgPT0gMjU2KSBrID0gODsgLy8gYnl0ZSBhcnJheQogICAgICAgIGVsc2UgaWYgKGIgPT0gMikgayA9IDE7ZWxzZSBpZiAoYiA9PSAzMikgayA9IDU7ZWxzZSBpZiAoYiA9PSA0KSBrID0gMjtlbHNlIHsKICAgICAgICAgIHRoaXMuZnJvbVJhZGl4KHMsIGIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLnQgPSAwOwogICAgICAgIHRoaXMucyA9IDA7CiAgICAgICAgdmFyIGkgPSBzLmxlbmd0aCwKICAgICAgICAgIG1pID0gZmFsc2UsCiAgICAgICAgICBzaCA9IDA7CiAgICAgICAgd2hpbGUgKC0taSA+PSAwKSB7CiAgICAgICAgICB2YXIgeCA9IGsgPT0gOCA/IHNbaV0gJiAweGZmIDogaW50QXQocywgaSk7CiAgICAgICAgICBpZiAoeCA8IDApIHsKICAgICAgICAgICAgaWYgKHMuY2hhckF0KGkpID09ICItIikgbWkgPSB0cnVlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIG1pID0gZmFsc2U7CiAgICAgICAgICBpZiAoc2ggPT0gMCkgdGhpc1t0aGlzLnQrK10gPSB4O2Vsc2UgaWYgKHNoICsgayA+IHRoaXMuREIpIHsKICAgICAgICAgICAgdGhpc1t0aGlzLnQgLSAxXSB8PSAoeCAmICgxIDw8IHRoaXMuREIgLSBzaCkgLSAxKSA8PCBzaDsKICAgICAgICAgICAgdGhpc1t0aGlzLnQrK10gPSB4ID4+IHRoaXMuREIgLSBzaDsKICAgICAgICAgIH0gZWxzZSB0aGlzW3RoaXMudCAtIDFdIHw9IHggPDwgc2g7CiAgICAgICAgICBzaCArPSBrOwogICAgICAgICAgaWYgKHNoID49IHRoaXMuREIpIHNoIC09IHRoaXMuREI7CiAgICAgICAgfQogICAgICAgIGlmIChrID09IDggJiYgKHNbMF0gJiAweDgwKSAhPSAwKSB7CiAgICAgICAgICB0aGlzLnMgPSAtMTsKICAgICAgICAgIGlmIChzaCA+IDApIHRoaXNbdGhpcy50IC0gMV0gfD0gKDEgPDwgdGhpcy5EQiAtIHNoKSAtIDEgPDwgc2g7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xhbXAoKTsKICAgICAgICBpZiAobWkpIEJpZ0ludGVnZXIuWkVSTy5zdWJUbyh0aGlzLCB0aGlzKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgY2xhbXAgb2ZmIGV4Y2VzcyBoaWdoIHdvcmRzCiAgICAgIGZ1bmN0aW9uIGJucENsYW1wKCkgewogICAgICAgIHZhciBjID0gdGhpcy5zICYgdGhpcy5ETTsKICAgICAgICB3aGlsZSAodGhpcy50ID4gMCAmJiB0aGlzW3RoaXMudCAtIDFdID09IGMpIC0tdGhpcy50OwogICAgICB9CgogICAgICAvLyAocHVibGljKSByZXR1cm4gc3RyaW5nIHJlcHJlc2VudGF0aW9uIGluIGdpdmVuIHJhZGl4CiAgICAgIGZ1bmN0aW9uIGJuVG9TdHJpbmcoYikgewogICAgICAgIGlmICh0aGlzLnMgPCAwKSByZXR1cm4gIi0iICsgdGhpcy5uZWdhdGUoKS50b1N0cmluZyhiKTsKICAgICAgICB2YXIgazsKICAgICAgICBpZiAoYiA9PSAxNikgayA9IDQ7ZWxzZSBpZiAoYiA9PSA4KSBrID0gMztlbHNlIGlmIChiID09IDIpIGsgPSAxO2Vsc2UgaWYgKGIgPT0gMzIpIGsgPSA1O2Vsc2UgaWYgKGIgPT0gNCkgayA9IDI7ZWxzZSByZXR1cm4gdGhpcy50b1JhZGl4KGIpOwogICAgICAgIHZhciBrbSA9ICgxIDw8IGspIC0gMSwKICAgICAgICAgIGQsCiAgICAgICAgICBtID0gZmFsc2UsCiAgICAgICAgICByID0gIiIsCiAgICAgICAgICBpID0gdGhpcy50OwogICAgICAgIHZhciBwID0gdGhpcy5EQiAtIGkgKiB0aGlzLkRCICUgazsKICAgICAgICBpZiAoaS0tID4gMCkgewogICAgICAgICAgaWYgKHAgPCB0aGlzLkRCICYmIChkID0gdGhpc1tpXSA+PiBwKSA+IDApIHsKICAgICAgICAgICAgbSA9IHRydWU7CiAgICAgICAgICAgIHIgPSBpbnQyY2hhcihkKTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChpID49IDApIHsKICAgICAgICAgICAgaWYgKHAgPCBrKSB7CiAgICAgICAgICAgICAgZCA9ICh0aGlzW2ldICYgKDEgPDwgcCkgLSAxKSA8PCBrIC0gcDsKICAgICAgICAgICAgICBkIHw9IHRoaXNbLS1pXSA+PiAocCArPSB0aGlzLkRCIC0gayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZCA9IHRoaXNbaV0gPj4gKHAgLT0gaykgJiBrbTsKICAgICAgICAgICAgICBpZiAocCA8PSAwKSB7CiAgICAgICAgICAgICAgICBwICs9IHRoaXMuREI7CiAgICAgICAgICAgICAgICAtLWk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkID4gMCkgbSA9IHRydWU7CiAgICAgICAgICAgIGlmIChtKSByICs9IGludDJjaGFyKGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbSA/IHIgOiAiMCI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIC10aGlzCiAgICAgIGZ1bmN0aW9uIGJuTmVnYXRlKCkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgQmlnSW50ZWdlci5aRVJPLnN1YlRvKHRoaXMsIHIpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSB8dGhpc3wKICAgICAgZnVuY3Rpb24gYm5BYnMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucyA8IDAgPyB0aGlzLm5lZ2F0ZSgpIDogdGhpczsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgcmV0dXJuICsgaWYgdGhpcyA+IGEsIC0gaWYgdGhpcyA8IGEsIDAgaWYgZXF1YWwKICAgICAgZnVuY3Rpb24gYm5Db21wYXJlVG8oYSkgewogICAgICAgIHZhciByID0gdGhpcy5zIC0gYS5zOwogICAgICAgIGlmIChyICE9IDApIHJldHVybiByOwogICAgICAgIHZhciBpID0gdGhpcy50OwogICAgICAgIHIgPSBpIC0gYS50OwogICAgICAgIGlmIChyICE9IDApIHJldHVybiB0aGlzLnMgPCAwID8gLXIgOiByOwogICAgICAgIHdoaWxlICgtLWkgPj0gMCkgaWYgKChyID0gdGhpc1tpXSAtIGFbaV0pICE9IDApIHJldHVybiByOwogICAgICAgIHJldHVybiAwOwogICAgICB9CgogICAgICAvLyByZXR1cm5zIGJpdCBsZW5ndGggb2YgdGhlIGludGVnZXIgeAogICAgICBmdW5jdGlvbiBuYml0cyh4KSB7CiAgICAgICAgdmFyIHIgPSAxLAogICAgICAgICAgdDsKICAgICAgICBpZiAoKHQgPSB4ID4+PiAxNikgIT0gMCkgewogICAgICAgICAgeCA9IHQ7CiAgICAgICAgICByICs9IDE2OwogICAgICAgIH0KICAgICAgICBpZiAoKHQgPSB4ID4+IDgpICE9IDApIHsKICAgICAgICAgIHggPSB0OwogICAgICAgICAgciArPSA4OwogICAgICAgIH0KICAgICAgICBpZiAoKHQgPSB4ID4+IDQpICE9IDApIHsKICAgICAgICAgIHggPSB0OwogICAgICAgICAgciArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoKHQgPSB4ID4+IDIpICE9IDApIHsKICAgICAgICAgIHggPSB0OwogICAgICAgICAgciArPSAyOwogICAgICAgIH0KICAgICAgICBpZiAoKHQgPSB4ID4+IDEpICE9IDApIHsKICAgICAgICAgIHggPSB0OwogICAgICAgICAgciArPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgcmV0dXJuIHRoZSBudW1iZXIgb2YgYml0cyBpbiAidGhpcyIKICAgICAgZnVuY3Rpb24gYm5CaXRMZW5ndGgoKSB7CiAgICAgICAgaWYgKHRoaXMudCA8PSAwKSByZXR1cm4gMDsKICAgICAgICByZXR1cm4gdGhpcy5EQiAqICh0aGlzLnQgLSAxKSArIG5iaXRzKHRoaXNbdGhpcy50IC0gMV0gXiB0aGlzLnMgJiB0aGlzLkRNKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IHRoaXMgPDwgbipEQgogICAgICBmdW5jdGlvbiBibnBETFNoaWZ0VG8obiwgcikgewogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IHRoaXMudCAtIDE7IGkgPj0gMDsgLS1pKSByW2kgKyBuXSA9IHRoaXNbaV07CiAgICAgICAgZm9yIChpID0gbiAtIDE7IGkgPj0gMDsgLS1pKSByW2ldID0gMDsKICAgICAgICByLnQgPSB0aGlzLnQgKyBuOwogICAgICAgIHIucyA9IHRoaXMuczsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IHRoaXMgPj4gbipEQgogICAgICBmdW5jdGlvbiBibnBEUlNoaWZ0VG8obiwgcikgewogICAgICAgIGZvciAodmFyIGkgPSBuOyBpIDwgdGhpcy50OyArK2kpIHJbaSAtIG5dID0gdGhpc1tpXTsKICAgICAgICByLnQgPSBNYXRoLm1heCh0aGlzLnQgLSBuLCAwKTsKICAgICAgICByLnMgPSB0aGlzLnM7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHIgPSB0aGlzIDw8IG4KICAgICAgZnVuY3Rpb24gYm5wTFNoaWZ0VG8obiwgcikgewogICAgICAgIHZhciBicyA9IG4gJSB0aGlzLkRCOwogICAgICAgIHZhciBjYnMgPSB0aGlzLkRCIC0gYnM7CiAgICAgICAgdmFyIGJtID0gKDEgPDwgY2JzKSAtIDE7CiAgICAgICAgdmFyIGRzID0gTWF0aC5mbG9vcihuIC8gdGhpcy5EQiksCiAgICAgICAgICBjID0gdGhpcy5zIDw8IGJzICYgdGhpcy5ETSwKICAgICAgICAgIGk7CiAgICAgICAgZm9yIChpID0gdGhpcy50IC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIHJbaSArIGRzICsgMV0gPSB0aGlzW2ldID4+IGNicyB8IGM7CiAgICAgICAgICBjID0gKHRoaXNbaV0gJiBibSkgPDwgYnM7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGRzIC0gMTsgaSA+PSAwOyAtLWkpIHJbaV0gPSAwOwogICAgICAgIHJbZHNdID0gYzsKICAgICAgICByLnQgPSB0aGlzLnQgKyBkcyArIDE7CiAgICAgICAgci5zID0gdGhpcy5zOwogICAgICAgIHIuY2xhbXAoKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IHRoaXMgPj4gbgogICAgICBmdW5jdGlvbiBibnBSU2hpZnRUbyhuLCByKSB7CiAgICAgICAgci5zID0gdGhpcy5zOwogICAgICAgIHZhciBkcyA9IE1hdGguZmxvb3IobiAvIHRoaXMuREIpOwogICAgICAgIGlmIChkcyA+PSB0aGlzLnQpIHsKICAgICAgICAgIHIudCA9IDA7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBicyA9IG4gJSB0aGlzLkRCOwogICAgICAgIHZhciBjYnMgPSB0aGlzLkRCIC0gYnM7CiAgICAgICAgdmFyIGJtID0gKDEgPDwgYnMpIC0gMTsKICAgICAgICByWzBdID0gdGhpc1tkc10gPj4gYnM7CiAgICAgICAgZm9yICh2YXIgaSA9IGRzICsgMTsgaSA8IHRoaXMudDsgKytpKSB7CiAgICAgICAgICByW2kgLSBkcyAtIDFdIHw9ICh0aGlzW2ldICYgYm0pIDw8IGNiczsKICAgICAgICAgIHJbaSAtIGRzXSA9IHRoaXNbaV0gPj4gYnM7CiAgICAgICAgfQogICAgICAgIGlmIChicyA+IDApIHJbdGhpcy50IC0gZHMgLSAxXSB8PSAodGhpcy5zICYgYm0pIDw8IGNiczsKICAgICAgICByLnQgPSB0aGlzLnQgLSBkczsKICAgICAgICByLmNsYW1wKCk7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHIgPSB0aGlzIC0gYQogICAgICBmdW5jdGlvbiBibnBTdWJUbyhhLCByKSB7CiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgYyA9IDAsCiAgICAgICAgICBtID0gTWF0aC5taW4oYS50LCB0aGlzLnQpOwogICAgICAgIHdoaWxlIChpIDwgbSkgewogICAgICAgICAgYyArPSB0aGlzW2ldIC0gYVtpXTsKICAgICAgICAgIHJbaSsrXSA9IGMgJiB0aGlzLkRNOwogICAgICAgICAgYyA+Pj0gdGhpcy5EQjsKICAgICAgICB9CiAgICAgICAgaWYgKGEudCA8IHRoaXMudCkgewogICAgICAgICAgYyAtPSBhLnM7CiAgICAgICAgICB3aGlsZSAoaSA8IHRoaXMudCkgewogICAgICAgICAgICBjICs9IHRoaXNbaV07CiAgICAgICAgICAgIHJbaSsrXSA9IGMgJiB0aGlzLkRNOwogICAgICAgICAgICBjID4+PSB0aGlzLkRCOwogICAgICAgICAgfQogICAgICAgICAgYyArPSB0aGlzLnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGMgKz0gdGhpcy5zOwogICAgICAgICAgd2hpbGUgKGkgPCBhLnQpIHsKICAgICAgICAgICAgYyAtPSBhW2ldOwogICAgICAgICAgICByW2krK10gPSBjICYgdGhpcy5ETTsKICAgICAgICAgICAgYyA+Pj0gdGhpcy5EQjsKICAgICAgICAgIH0KICAgICAgICAgIGMgLT0gYS5zOwogICAgICAgIH0KICAgICAgICByLnMgPSBjIDwgMCA/IC0xIDogMDsKICAgICAgICBpZiAoYyA8IC0xKSByW2krK10gPSB0aGlzLkRWICsgYztlbHNlIGlmIChjID4gMCkgcltpKytdID0gYzsKICAgICAgICByLnQgPSBpOwogICAgICAgIHIuY2xhbXAoKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IHRoaXMgKiBhLCByICE9IHRoaXMsYSAoSEFDIDE0LjEyKQogICAgICAvLyAidGhpcyIgc2hvdWxkIGJlIHRoZSBsYXJnZXIgb25lIGlmIGFwcHJvcHJpYXRlLgogICAgICBmdW5jdGlvbiBibnBNdWx0aXBseVRvKGEsIHIpIHsKICAgICAgICB2YXIgeCA9IHRoaXMuYWJzKCksCiAgICAgICAgICB5ID0gYS5hYnMoKTsKICAgICAgICB2YXIgaSA9IHgudDsKICAgICAgICByLnQgPSBpICsgeS50OwogICAgICAgIHdoaWxlICgtLWkgPj0gMCkgcltpXSA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHkudDsgKytpKSByW2kgKyB4LnRdID0geC5hbSgwLCB5W2ldLCByLCBpLCAwLCB4LnQpOwogICAgICAgIHIucyA9IDA7CiAgICAgICAgci5jbGFtcCgpOwogICAgICAgIGlmICh0aGlzLnMgIT0gYS5zKSBCaWdJbnRlZ2VyLlpFUk8uc3ViVG8ociwgcik7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHIgPSB0aGlzXjIsIHIgIT0gdGhpcyAoSEFDIDE0LjE2KQogICAgICBmdW5jdGlvbiBibnBTcXVhcmVUbyhyKSB7CiAgICAgICAgdmFyIHggPSB0aGlzLmFicygpOwogICAgICAgIHZhciBpID0gci50ID0gMiAqIHgudDsKICAgICAgICB3aGlsZSAoLS1pID49IDApIHJbaV0gPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB4LnQgLSAxOyArK2kpIHsKICAgICAgICAgIHZhciBjID0geC5hbShpLCB4W2ldLCByLCAyICogaSwgMCwgMSk7CiAgICAgICAgICBpZiAoKHJbaSArIHgudF0gKz0geC5hbShpICsgMSwgMiAqIHhbaV0sIHIsIDIgKiBpICsgMSwgYywgeC50IC0gaSAtIDEpKSA+PSB4LkRWKSB7CiAgICAgICAgICAgIHJbaSArIHgudF0gLT0geC5EVjsKICAgICAgICAgICAgcltpICsgeC50ICsgMV0gPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoci50ID4gMCkgcltyLnQgLSAxXSArPSB4LmFtKGksIHhbaV0sIHIsIDIgKiBpLCAwLCAxKTsKICAgICAgICByLnMgPSAwOwogICAgICAgIHIuY2xhbXAoKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgZGl2aWRlIHRoaXMgYnkgbSwgcXVvdGllbnQgYW5kIHJlbWFpbmRlciB0byBxLCByIChIQUMgMTQuMjApCiAgICAgIC8vIHIgIT0gcSwgdGhpcyAhPSBtLiAgcSBvciByIG1heSBiZSBudWxsLgogICAgICBmdW5jdGlvbiBibnBEaXZSZW1UbyhtLCBxLCByKSB7CiAgICAgICAgdmFyIHBtID0gbS5hYnMoKTsKICAgICAgICBpZiAocG0udCA8PSAwKSByZXR1cm47CiAgICAgICAgdmFyIHB0ID0gdGhpcy5hYnMoKTsKICAgICAgICBpZiAocHQudCA8IHBtLnQpIHsKICAgICAgICAgIGlmIChxICE9IG51bGwpIHEuZnJvbUludCgwKTsKICAgICAgICAgIGlmIChyICE9IG51bGwpIHRoaXMuY29weVRvKHIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAociA9PSBudWxsKSByID0gbmJpKCk7CiAgICAgICAgdmFyIHkgPSBuYmkoKSwKICAgICAgICAgIHRzID0gdGhpcy5zLAogICAgICAgICAgbXMgPSBtLnM7CiAgICAgICAgdmFyIG5zaCA9IHRoaXMuREIgLSBuYml0cyhwbVtwbS50IC0gMV0pOyAvLyBub3JtYWxpemUgbW9kdWx1cwogICAgICAgIGlmIChuc2ggPiAwKSB7CiAgICAgICAgICBwbS5sU2hpZnRUbyhuc2gsIHkpOwogICAgICAgICAgcHQubFNoaWZ0VG8obnNoLCByKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcG0uY29weVRvKHkpOwogICAgICAgICAgcHQuY29weVRvKHIpOwogICAgICAgIH0KICAgICAgICB2YXIgeXMgPSB5LnQ7CiAgICAgICAgdmFyIHkwID0geVt5cyAtIDFdOwogICAgICAgIGlmICh5MCA9PSAwKSByZXR1cm47CiAgICAgICAgdmFyIHl0ID0geTAgKiAoMSA8PCB0aGlzLkYxKSArICh5cyA+IDEgPyB5W3lzIC0gMl0gPj4gdGhpcy5GMiA6IDApOwogICAgICAgIHZhciBkMSA9IHRoaXMuRlYgLyB5dCwKICAgICAgICAgIGQyID0gKDEgPDwgdGhpcy5GMSkgLyB5dCwKICAgICAgICAgIGUgPSAxIDw8IHRoaXMuRjI7CiAgICAgICAgdmFyIGkgPSByLnQsCiAgICAgICAgICBqID0gaSAtIHlzLAogICAgICAgICAgdCA9IHEgPT0gbnVsbCA/IG5iaSgpIDogcTsKICAgICAgICB5LmRsU2hpZnRUbyhqLCB0KTsKICAgICAgICBpZiAoci5jb21wYXJlVG8odCkgPj0gMCkgewogICAgICAgICAgcltyLnQrK10gPSAxOwogICAgICAgICAgci5zdWJUbyh0LCByKTsKICAgICAgICB9CiAgICAgICAgQmlnSW50ZWdlci5PTkUuZGxTaGlmdFRvKHlzLCB0KTsKICAgICAgICB0LnN1YlRvKHksIHkpOyAvLyAibmVnYXRpdmUiIHkgc28gd2UgY2FuIHJlcGxhY2Ugc3ViIHdpdGggYW0gbGF0ZXIKICAgICAgICB3aGlsZSAoeS50IDwgeXMpIHlbeS50KytdID0gMDsKICAgICAgICB3aGlsZSAoLS1qID49IDApIHsKICAgICAgICAgIC8vIEVzdGltYXRlIHF1b3RpZW50IGRpZ2l0CiAgICAgICAgICB2YXIgcWQgPSByWy0taV0gPT0geTAgPyB0aGlzLkRNIDogTWF0aC5mbG9vcihyW2ldICogZDEgKyAocltpIC0gMV0gKyBlKSAqIGQyKTsKICAgICAgICAgIGlmICgocltpXSArPSB5LmFtKDAsIHFkLCByLCBqLCAwLCB5cykpIDwgcWQpIHsKICAgICAgICAgICAgLy8gVHJ5IGl0IG91dAogICAgICAgICAgICB5LmRsU2hpZnRUbyhqLCB0KTsKICAgICAgICAgICAgci5zdWJUbyh0LCByKTsKICAgICAgICAgICAgd2hpbGUgKHJbaV0gPCAtLXFkKSByLnN1YlRvKHQsIHIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocSAhPSBudWxsKSB7CiAgICAgICAgICByLmRyU2hpZnRUbyh5cywgcSk7CiAgICAgICAgICBpZiAodHMgIT0gbXMpIEJpZ0ludGVnZXIuWkVSTy5zdWJUbyhxLCBxKTsKICAgICAgICB9CiAgICAgICAgci50ID0geXM7CiAgICAgICAgci5jbGFtcCgpOwogICAgICAgIGlmIChuc2ggPiAwKSByLnJTaGlmdFRvKG5zaCwgcik7IC8vIERlbm9ybWFsaXplIHJlbWFpbmRlcgogICAgICAgIGlmICh0cyA8IDApIEJpZ0ludGVnZXIuWkVSTy5zdWJUbyhyLCByKTsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyBtb2QgYQogICAgICBmdW5jdGlvbiBibk1vZChhKSB7CiAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICB0aGlzLmFicygpLmRpdlJlbVRvKGEsIG51bGwsIHIpOwogICAgICAgIGlmICh0aGlzLnMgPCAwICYmIHIuY29tcGFyZVRvKEJpZ0ludGVnZXIuWkVSTykgPiAwKSBhLnN1YlRvKHIsIHIpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyBNb2R1bGFyIHJlZHVjdGlvbiB1c2luZyAiY2xhc3NpYyIgYWxnb3JpdGhtCiAgICAgIGZ1bmN0aW9uIENsYXNzaWMobSkgewogICAgICAgIHRoaXMubSA9IG07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY0NvbnZlcnQoeCkgewogICAgICAgIGlmICh4LnMgPCAwIHx8IHguY29tcGFyZVRvKHRoaXMubSkgPj0gMCkgcmV0dXJuIHgubW9kKHRoaXMubSk7ZWxzZSByZXR1cm4geDsKICAgICAgfQogICAgICBmdW5jdGlvbiBjUmV2ZXJ0KHgpIHsKICAgICAgICByZXR1cm4geDsKICAgICAgfQogICAgICBmdW5jdGlvbiBjUmVkdWNlKHgpIHsKICAgICAgICB4LmRpdlJlbVRvKHRoaXMubSwgbnVsbCwgeCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY011bFRvKHgsIHksIHIpIHsKICAgICAgICB4Lm11bHRpcGx5VG8oeSwgcik7CiAgICAgICAgdGhpcy5yZWR1Y2Uocik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY1NxclRvKHgsIHIpIHsKICAgICAgICB4LnNxdWFyZVRvKHIpOwogICAgICAgIHRoaXMucmVkdWNlKHIpOwogICAgICB9CiAgICAgIENsYXNzaWMucHJvdG90eXBlLmNvbnZlcnQgPSBjQ29udmVydDsKICAgICAgQ2xhc3NpYy5wcm90b3R5cGUucmV2ZXJ0ID0gY1JldmVydDsKICAgICAgQ2xhc3NpYy5wcm90b3R5cGUucmVkdWNlID0gY1JlZHVjZTsKICAgICAgQ2xhc3NpYy5wcm90b3R5cGUubXVsVG8gPSBjTXVsVG87CiAgICAgIENsYXNzaWMucHJvdG90eXBlLnNxclRvID0gY1NxclRvOwoKICAgICAgLy8gKHByb3RlY3RlZCkgcmV0dXJuICItMS90aGlzICUgMl5EQiI7IHVzZWZ1bCBmb3IgTW9udC4gcmVkdWN0aW9uCiAgICAgIC8vIGp1c3RpZmljYXRpb246CiAgICAgIC8vICAgICAgICAgeHkgPT0gMSAobW9kIG0pCiAgICAgIC8vICAgICAgICAgeHkgPSAgMStrbQogICAgICAvLyAgIHh5KDIteHkpID0gKDEra20pKDEta20pCiAgICAgIC8vIHhbeSgyLXh5KV0gPSAxLWteMm1eMgogICAgICAvLyB4W3koMi14eSldID09IDEgKG1vZCBtXjIpCiAgICAgIC8vIGlmIHkgaXMgMS94IG1vZCBtLCB0aGVuIHkoMi14eSkgaXMgMS94IG1vZCBtXjIKICAgICAgLy8gc2hvdWxkIHJlZHVjZSB4IGFuZCB5KDIteHkpIGJ5IG1eMiBhdCBlYWNoIHN0ZXAgdG8ga2VlcCBzaXplIGJvdW5kZWQuCiAgICAgIC8vIEpTIG11bHRpcGx5ICJvdmVyZmxvd3MiIGRpZmZlcmVudGx5IGZyb20gQy9DKyssIHNvIGNhcmUgaXMgbmVlZGVkIGhlcmUuCiAgICAgIGZ1bmN0aW9uIGJucEludkRpZ2l0KCkgewogICAgICAgIGlmICh0aGlzLnQgPCAxKSByZXR1cm4gMDsKICAgICAgICB2YXIgeCA9IHRoaXNbMF07CiAgICAgICAgaWYgKCh4ICYgMSkgPT0gMCkgcmV0dXJuIDA7CiAgICAgICAgdmFyIHkgPSB4ICYgMzsgLy8geSA9PSAxL3ggbW9kIDJeMgogICAgICAgIHkgPSB5ICogKDIgLSAoeCAmIDB4ZikgKiB5KSAmIDB4ZjsgLy8geSA9PSAxL3ggbW9kIDJeNAogICAgICAgIHkgPSB5ICogKDIgLSAoeCAmIDB4ZmYpICogeSkgJiAweGZmOyAvLyB5ID09IDEveCBtb2QgMl44CiAgICAgICAgeSA9IHkgKiAoMiAtICgoeCAmIDB4ZmZmZikgKiB5ICYgMHhmZmZmKSkgJiAweGZmZmY7IC8vIHkgPT0gMS94IG1vZCAyXjE2CiAgICAgICAgLy8gbGFzdCBzdGVwIC0gY2FsY3VsYXRlIGludmVyc2UgbW9kIERWIGRpcmVjdGx5OwogICAgICAgIC8vIGFzc3VtZXMgMTYgPCBEQiA8PSAzMiBhbmQgYXNzdW1lcyBhYmlsaXR5IHRvIGhhbmRsZSA0OC1iaXQgaW50cwogICAgICAgIHkgPSB5ICogKDIgLSB4ICogeSAlIHRoaXMuRFYpICUgdGhpcy5EVjsgLy8geSA9PSAxL3ggbW9kIDJeZGJpdHMKICAgICAgICAvLyB3ZSByZWFsbHkgd2FudCB0aGUgbmVnYXRpdmUgaW52ZXJzZSwgYW5kIC1EViA8IHkgPCBEVgogICAgICAgIHJldHVybiB5ID4gMCA/IHRoaXMuRFYgLSB5IDogLXk7CiAgICAgIH0KCiAgICAgIC8vIE1vbnRnb21lcnkgcmVkdWN0aW9uCiAgICAgIGZ1bmN0aW9uIE1vbnRnb21lcnkobSkgewogICAgICAgIHRoaXMubSA9IG07CiAgICAgICAgdGhpcy5tcCA9IG0uaW52RGlnaXQoKTsKICAgICAgICB0aGlzLm1wbCA9IHRoaXMubXAgJiAweDdmZmY7CiAgICAgICAgdGhpcy5tcGggPSB0aGlzLm1wID4+IDE1OwogICAgICAgIHRoaXMudW0gPSAoMSA8PCBtLkRCIC0gMTUpIC0gMTsKICAgICAgICB0aGlzLm10MiA9IDIgKiBtLnQ7CiAgICAgIH0KCiAgICAgIC8vIHhSIG1vZCBtCiAgICAgIGZ1bmN0aW9uIG1vbnRDb252ZXJ0KHgpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHguYWJzKCkuZGxTaGlmdFRvKHRoaXMubS50LCByKTsKICAgICAgICByLmRpdlJlbVRvKHRoaXMubSwgbnVsbCwgcik7CiAgICAgICAgaWYgKHgucyA8IDAgJiYgci5jb21wYXJlVG8oQmlnSW50ZWdlci5aRVJPKSA+IDApIHRoaXMubS5zdWJUbyhyLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8geC9SIG1vZCBtCiAgICAgIGZ1bmN0aW9uIG1vbnRSZXZlcnQoeCkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgeC5jb3B5VG8ocik7CiAgICAgICAgdGhpcy5yZWR1Y2Uocik7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIHggPSB4L1IgbW9kIG0gKEhBQyAxNC4zMikKICAgICAgZnVuY3Rpb24gbW9udFJlZHVjZSh4KSB7CiAgICAgICAgd2hpbGUgKHgudCA8PSB0aGlzLm10MikKICAgICAgICAvLyBwYWQgeCBzbyBhbSBoYXMgZW5vdWdoIHJvb20gbGF0ZXIKICAgICAgICB4W3gudCsrXSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm0udDsgKytpKSB7CiAgICAgICAgICAvLyBmYXN0ZXIgd2F5IG9mIGNhbGN1bGF0aW5nIHUwID0geFtpXSptcCBtb2QgRFYKICAgICAgICAgIHZhciBqID0geFtpXSAmIDB4N2ZmZjsKICAgICAgICAgIHZhciB1MCA9IGogKiB0aGlzLm1wbCArICgoaiAqIHRoaXMubXBoICsgKHhbaV0gPj4gMTUpICogdGhpcy5tcGwgJiB0aGlzLnVtKSA8PCAxNSkgJiB4LkRNOwogICAgICAgICAgLy8gdXNlIGFtIHRvIGNvbWJpbmUgdGhlIG11bHRpcGx5LXNoaWZ0LWFkZCBpbnRvIG9uZSBjYWxsCiAgICAgICAgICBqID0gaSArIHRoaXMubS50OwogICAgICAgICAgeFtqXSArPSB0aGlzLm0uYW0oMCwgdTAsIHgsIGksIDAsIHRoaXMubS50KTsKICAgICAgICAgIC8vIHByb3BhZ2F0ZSBjYXJyeQogICAgICAgICAgd2hpbGUgKHhbal0gPj0geC5EVikgewogICAgICAgICAgICB4W2pdIC09IHguRFY7CiAgICAgICAgICAgIHhbKytqXSsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB4LmNsYW1wKCk7CiAgICAgICAgeC5kclNoaWZ0VG8odGhpcy5tLnQsIHgpOwogICAgICAgIGlmICh4LmNvbXBhcmVUbyh0aGlzLm0pID49IDApIHguc3ViVG8odGhpcy5tLCB4KTsKICAgICAgfQoKICAgICAgLy8gciA9ICJ4XjIvUiBtb2QgbSI7IHggIT0gcgogICAgICBmdW5jdGlvbiBtb250U3FyVG8oeCwgcikgewogICAgICAgIHguc3F1YXJlVG8ocik7CiAgICAgICAgdGhpcy5yZWR1Y2Uocik7CiAgICAgIH0KCiAgICAgIC8vIHIgPSAieHkvUiBtb2QgbSI7IHgseSAhPSByCiAgICAgIGZ1bmN0aW9uIG1vbnRNdWxUbyh4LCB5LCByKSB7CiAgICAgICAgeC5tdWx0aXBseVRvKHksIHIpOwogICAgICAgIHRoaXMucmVkdWNlKHIpOwogICAgICB9CiAgICAgIE1vbnRnb21lcnkucHJvdG90eXBlLmNvbnZlcnQgPSBtb250Q29udmVydDsKICAgICAgTW9udGdvbWVyeS5wcm90b3R5cGUucmV2ZXJ0ID0gbW9udFJldmVydDsKICAgICAgTW9udGdvbWVyeS5wcm90b3R5cGUucmVkdWNlID0gbW9udFJlZHVjZTsKICAgICAgTW9udGdvbWVyeS5wcm90b3R5cGUubXVsVG8gPSBtb250TXVsVG87CiAgICAgIE1vbnRnb21lcnkucHJvdG90eXBlLnNxclRvID0gbW9udFNxclRvOwoKICAgICAgLy8gKHByb3RlY3RlZCkgdHJ1ZSBpZmYgdGhpcyBpcyBldmVuCiAgICAgIGZ1bmN0aW9uIGJucElzRXZlbigpIHsKICAgICAgICByZXR1cm4gKHRoaXMudCA+IDAgPyB0aGlzWzBdICYgMSA6IHRoaXMucykgPT0gMDsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgdGhpc15lLCBlIDwgMl4zMiwgZG9pbmcgc3FyIGFuZCBtdWwgd2l0aCAiciIgKEhBQyAxNC43OSkKICAgICAgZnVuY3Rpb24gYm5wRXhwKGUsIHopIHsKICAgICAgICBpZiAoZSA+IDB4ZmZmZmZmZmYgfHwgZSA8IDEpIHJldHVybiBCaWdJbnRlZ2VyLk9ORTsKICAgICAgICB2YXIgciA9IG5iaSgpLAogICAgICAgICAgcjIgPSBuYmkoKSwKICAgICAgICAgIGcgPSB6LmNvbnZlcnQodGhpcyksCiAgICAgICAgICBpID0gbmJpdHMoZSkgLSAxOwogICAgICAgIGcuY29weVRvKHIpOwogICAgICAgIHdoaWxlICgtLWkgPj0gMCkgewogICAgICAgICAgei5zcXJUbyhyLCByMik7CiAgICAgICAgICBpZiAoKGUgJiAxIDw8IGkpID4gMCkgei5tdWxUbyhyMiwgZywgcik7ZWxzZSB7CiAgICAgICAgICAgIHZhciB0ID0gcjsKICAgICAgICAgICAgciA9IHIyOwogICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB6LnJldmVydChyKTsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpc15lICUgbSwgMCA8PSBlIDwgMl4zMgogICAgICBmdW5jdGlvbiBibk1vZFBvd0ludChlLCBtKSB7CiAgICAgICAgdmFyIHo7CiAgICAgICAgaWYgKGUgPCAyNTYgfHwgbS5pc0V2ZW4oKSkgeiA9IG5ldyBDbGFzc2ljKG0pO2Vsc2UgeiA9IG5ldyBNb250Z29tZXJ5KG0pOwogICAgICAgIHJldHVybiB0aGlzLmV4cChlLCB6KTsKICAgICAgfQoKICAgICAgLy8gcHJvdGVjdGVkCiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmNvcHlUbyA9IGJucENvcHlUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuZnJvbUludCA9IGJucEZyb21JbnQ7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmZyb21TdHJpbmcgPSBibnBGcm9tU3RyaW5nOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5jbGFtcCA9IGJucENsYW1wOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5kbFNoaWZ0VG8gPSBibnBETFNoaWZ0VG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmRyU2hpZnRUbyA9IGJucERSU2hpZnRUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubFNoaWZ0VG8gPSBibnBMU2hpZnRUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuclNoaWZ0VG8gPSBibnBSU2hpZnRUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuc3ViVG8gPSBibnBTdWJUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubXVsdGlwbHlUbyA9IGJucE11bHRpcGx5VG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnNxdWFyZVRvID0gYm5wU3F1YXJlVG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmRpdlJlbVRvID0gYm5wRGl2UmVtVG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmludkRpZ2l0ID0gYm5wSW52RGlnaXQ7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmlzRXZlbiA9IGJucElzRXZlbjsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuZXhwID0gYm5wRXhwOwoKICAgICAgLy8gcHVibGljCiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnRvU3RyaW5nID0gYm5Ub1N0cmluZzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubmVnYXRlID0gYm5OZWdhdGU7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmFicyA9IGJuQWJzOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5jb21wYXJlVG8gPSBibkNvbXBhcmVUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYml0TGVuZ3RoID0gYm5CaXRMZW5ndGg7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLm1vZCA9IGJuTW9kOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5tb2RQb3dJbnQgPSBibk1vZFBvd0ludDsKCiAgICAgIC8vICJjb25zdGFudHMiCiAgICAgIEJpZ0ludGVnZXIuWkVSTyA9IG5idigwKTsKICAgICAgQmlnSW50ZWdlci5PTkUgPSBuYnYoMSk7CgogICAgICAvLyBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwOSAgVG9tIFd1CiAgICAgIC8vIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgICAgIC8vIFNlZSAiTElDRU5TRSIgZm9yIGRldGFpbHMuCgogICAgICAvLyBFeHRlbmRlZCBKYXZhU2NyaXB0IEJOIGZ1bmN0aW9ucywgcmVxdWlyZWQgZm9yIFJTQSBwcml2YXRlIG9wcy4KCiAgICAgIC8vIFZlcnNpb24gMS4xOiBuZXcgQmlnSW50ZWdlcigiMCIsIDEwKSByZXR1cm5zICJwcm9wZXIiIHplcm8KICAgICAgLy8gVmVyc2lvbiAxLjI6IHNxdWFyZSgpIEFQSSwgaXNQcm9iYWJsZVByaW1lIGZpeAoKICAgICAgLy8gKHB1YmxpYykKICAgICAgZnVuY3Rpb24gYm5DbG9uZSgpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuY29weVRvKHIpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSByZXR1cm4gdmFsdWUgYXMgaW50ZWdlcgogICAgICBmdW5jdGlvbiBibkludFZhbHVlKCkgewogICAgICAgIGlmICh0aGlzLnMgPCAwKSB7CiAgICAgICAgICBpZiAodGhpcy50ID09IDEpIHJldHVybiB0aGlzWzBdIC0gdGhpcy5EVjtlbHNlIGlmICh0aGlzLnQgPT0gMCkgcmV0dXJuIC0xOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy50ID09IDEpIHJldHVybiB0aGlzWzBdO2Vsc2UgaWYgKHRoaXMudCA9PSAwKSByZXR1cm4gMDsKICAgICAgICAvLyBhc3N1bWVzIDE2IDwgREIgPCAzMgogICAgICAgIHJldHVybiAodGhpc1sxXSAmICgxIDw8IDMyIC0gdGhpcy5EQikgLSAxKSA8PCB0aGlzLkRCIHwgdGhpc1swXTsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgcmV0dXJuIHZhbHVlIGFzIGJ5dGUKICAgICAgZnVuY3Rpb24gYm5CeXRlVmFsdWUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudCA9PSAwID8gdGhpcy5zIDogdGhpc1swXSA8PCAyNCA+PiAyNDsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgcmV0dXJuIHZhbHVlIGFzIHNob3J0IChhc3N1bWVzIERCPj0xNikKICAgICAgZnVuY3Rpb24gYm5TaG9ydFZhbHVlKCkgewogICAgICAgIHJldHVybiB0aGlzLnQgPT0gMCA/IHRoaXMucyA6IHRoaXNbMF0gPDwgMTYgPj4gMTY7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHJldHVybiB4IHMudC4gcl54IDwgRFYKICAgICAgZnVuY3Rpb24gYm5wQ2h1bmtTaXplKHIpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLkxOMiAqIHRoaXMuREIgLyBNYXRoLmxvZyhyKSk7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIDAgaWYgdGhpcyA9PSAwLCAxIGlmIHRoaXMgPiAwCiAgICAgIGZ1bmN0aW9uIGJuU2lnTnVtKCkgewogICAgICAgIGlmICh0aGlzLnMgPCAwKSByZXR1cm4gLTE7ZWxzZSBpZiAodGhpcy50IDw9IDAgfHwgdGhpcy50ID09IDEgJiYgdGhpc1swXSA8PSAwKSByZXR1cm4gMDtlbHNlIHJldHVybiAxOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSBjb252ZXJ0IHRvIHJhZGl4IHN0cmluZwogICAgICBmdW5jdGlvbiBibnBUb1JhZGl4KGIpIHsKICAgICAgICBpZiAoYiA9PSBudWxsKSBiID0gMTA7CiAgICAgICAgaWYgKHRoaXMuc2lnbnVtKCkgPT0gMCB8fCBiIDwgMiB8fCBiID4gMzYpIHJldHVybiAiMCI7CiAgICAgICAgdmFyIGNzID0gdGhpcy5jaHVua1NpemUoYik7CiAgICAgICAgdmFyIGEgPSBNYXRoLnBvdyhiLCBjcyk7CiAgICAgICAgdmFyIGQgPSBuYnYoYSksCiAgICAgICAgICB5ID0gbmJpKCksCiAgICAgICAgICB6ID0gbmJpKCksCiAgICAgICAgICByID0gIiI7CiAgICAgICAgdGhpcy5kaXZSZW1UbyhkLCB5LCB6KTsKICAgICAgICB3aGlsZSAoeS5zaWdudW0oKSA+IDApIHsKICAgICAgICAgIHIgPSAoYSArIHouaW50VmFsdWUoKSkudG9TdHJpbmcoYikuc3Vic3RyKDEpICsgcjsKICAgICAgICAgIHkuZGl2UmVtVG8oZCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB6LmludFZhbHVlKCkudG9TdHJpbmcoYikgKyByOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSBjb252ZXJ0IGZyb20gcmFkaXggc3RyaW5nCiAgICAgIGZ1bmN0aW9uIGJucEZyb21SYWRpeChzLCBiKSB7CiAgICAgICAgdGhpcy5mcm9tSW50KDApOwogICAgICAgIGlmIChiID09IG51bGwpIGIgPSAxMDsKICAgICAgICB2YXIgY3MgPSB0aGlzLmNodW5rU2l6ZShiKTsKICAgICAgICB2YXIgZCA9IE1hdGgucG93KGIsIGNzKSwKICAgICAgICAgIG1pID0gZmFsc2UsCiAgICAgICAgICBqID0gMCwKICAgICAgICAgIHcgPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgdmFyIHggPSBpbnRBdChzLCBpKTsKICAgICAgICAgIGlmICh4IDwgMCkgewogICAgICAgICAgICBpZiAocy5jaGFyQXQoaSkgPT0gIi0iICYmIHRoaXMuc2lnbnVtKCkgPT0gMCkgbWkgPSB0cnVlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHcgPSBiICogdyArIHg7CiAgICAgICAgICBpZiAoKytqID49IGNzKSB7CiAgICAgICAgICAgIHRoaXMuZE11bHRpcGx5KGQpOwogICAgICAgICAgICB0aGlzLmRBZGRPZmZzZXQodywgMCk7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3ID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGogPiAwKSB7CiAgICAgICAgICB0aGlzLmRNdWx0aXBseShNYXRoLnBvdyhiLCBqKSk7CiAgICAgICAgICB0aGlzLmRBZGRPZmZzZXQodywgMCk7CiAgICAgICAgfQogICAgICAgIGlmIChtaSkgQmlnSW50ZWdlci5aRVJPLnN1YlRvKHRoaXMsIHRoaXMpOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSBhbHRlcm5hdGUgY29uc3RydWN0b3IKICAgICAgZnVuY3Rpb24gYm5wRnJvbU51bWJlcihhLCBiLCBjKSB7CiAgICAgICAgaWYgKCJudW1iZXIiID09IHR5cGVvZiBiKSB7CiAgICAgICAgICAvLyBuZXcgQmlnSW50ZWdlcihpbnQsaW50LFJORykKICAgICAgICAgIGlmIChhIDwgMikgdGhpcy5mcm9tSW50KDEpO2Vsc2UgewogICAgICAgICAgICB0aGlzLmZyb21OdW1iZXIoYSwgYyk7CiAgICAgICAgICAgIGlmICghdGhpcy50ZXN0Qml0KGEgLSAxKSkKICAgICAgICAgICAgICAvLyBmb3JjZSBNU0Igc2V0CiAgICAgICAgICAgICAgdGhpcy5iaXR3aXNlVG8oQmlnSW50ZWdlci5PTkUuc2hpZnRMZWZ0KGEgLSAxKSwgb3Bfb3IsIHRoaXMpOwogICAgICAgICAgICBpZiAodGhpcy5pc0V2ZW4oKSkgdGhpcy5kQWRkT2Zmc2V0KDEsIDApOyAvLyBmb3JjZSBvZGQKICAgICAgICAgICAgd2hpbGUgKCF0aGlzLmlzUHJvYmFibGVQcmltZShiKSkgewogICAgICAgICAgICAgIHRoaXMuZEFkZE9mZnNldCgyLCAwKTsKICAgICAgICAgICAgICBpZiAodGhpcy5iaXRMZW5ndGgoKSA+IGEpIHRoaXMuc3ViVG8oQmlnSW50ZWdlci5PTkUuc2hpZnRMZWZ0KGEgLSAxKSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gbmV3IEJpZ0ludGVnZXIoaW50LFJORykKICAgICAgICAgIHZhciB4ID0gbmV3IEFycmF5KCksCiAgICAgICAgICAgIHQgPSBhICYgNzsKICAgICAgICAgIHgubGVuZ3RoID0gKGEgPj4gMykgKyAxOwogICAgICAgICAgYi5uZXh0Qnl0ZXMoeCk7CiAgICAgICAgICBpZiAodCA+IDApIHhbMF0gJj0gKDEgPDwgdCkgLSAxO2Vsc2UgeFswXSA9IDA7CiAgICAgICAgICB0aGlzLmZyb21TdHJpbmcoeCwgMjU2KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIGNvbnZlcnQgdG8gYmlnZW5kaWFuIGJ5dGUgYXJyYXkKICAgICAgZnVuY3Rpb24gYm5Ub0J5dGVBcnJheSgpIHsKICAgICAgICB2YXIgaSA9IHRoaXMudCwKICAgICAgICAgIHIgPSBuZXcgQXJyYXkoKTsKICAgICAgICByWzBdID0gdGhpcy5zOwogICAgICAgIHZhciBwID0gdGhpcy5EQiAtIGkgKiB0aGlzLkRCICUgOCwKICAgICAgICAgIGQsCiAgICAgICAgICBrID0gMDsKICAgICAgICBpZiAoaS0tID4gMCkgewogICAgICAgICAgaWYgKHAgPCB0aGlzLkRCICYmIChkID0gdGhpc1tpXSA+PiBwKSAhPSAodGhpcy5zICYgdGhpcy5ETSkgPj4gcCkgcltrKytdID0gZCB8IHRoaXMucyA8PCB0aGlzLkRCIC0gcDsKICAgICAgICAgIHdoaWxlIChpID49IDApIHsKICAgICAgICAgICAgaWYgKHAgPCA4KSB7CiAgICAgICAgICAgICAgZCA9ICh0aGlzW2ldICYgKDEgPDwgcCkgLSAxKSA8PCA4IC0gcDsKICAgICAgICAgICAgICBkIHw9IHRoaXNbLS1pXSA+PiAocCArPSB0aGlzLkRCIC0gOCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZCA9IHRoaXNbaV0gPj4gKHAgLT0gOCkgJiAweGZmOwogICAgICAgICAgICAgIGlmIChwIDw9IDApIHsKICAgICAgICAgICAgICAgIHAgKz0gdGhpcy5EQjsKICAgICAgICAgICAgICAgIC0taTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChkICYgMHg4MCkgIT0gMCkgZCB8PSAtMjU2OwogICAgICAgICAgICBpZiAoayA9PSAwICYmICh0aGlzLnMgJiAweDgwKSAhPSAoZCAmIDB4ODApKSArK2s7CiAgICAgICAgICAgIGlmIChrID4gMCB8fCBkICE9IHRoaXMucykgcltrKytdID0gZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYm5FcXVhbHMoYSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBhcmVUbyhhKSA9PSAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGJuTWluKGEpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21wYXJlVG8oYSkgPCAwID8gdGhpcyA6IGE7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYm5NYXgoYSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBhcmVUbyhhKSA+IDAgPyB0aGlzIDogYTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IHRoaXMgb3AgYSAoYml0d2lzZSkKICAgICAgZnVuY3Rpb24gYm5wQml0d2lzZVRvKGEsIG9wLCByKSB7CiAgICAgICAgdmFyIGksCiAgICAgICAgICBmLAogICAgICAgICAgbSA9IE1hdGgubWluKGEudCwgdGhpcy50KTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbTsgKytpKSByW2ldID0gb3AodGhpc1tpXSwgYVtpXSk7CiAgICAgICAgaWYgKGEudCA8IHRoaXMudCkgewogICAgICAgICAgZiA9IGEucyAmIHRoaXMuRE07CiAgICAgICAgICBmb3IgKGkgPSBtOyBpIDwgdGhpcy50OyArK2kpIHJbaV0gPSBvcCh0aGlzW2ldLCBmKTsKICAgICAgICAgIHIudCA9IHRoaXMudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZiA9IHRoaXMucyAmIHRoaXMuRE07CiAgICAgICAgICBmb3IgKGkgPSBtOyBpIDwgYS50OyArK2kpIHJbaV0gPSBvcChmLCBhW2ldKTsKICAgICAgICAgIHIudCA9IGEudDsKICAgICAgICB9CiAgICAgICAgci5zID0gb3AodGhpcy5zLCBhLnMpOwogICAgICAgIHIuY2xhbXAoKTsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyAmIGEKICAgICAgZnVuY3Rpb24gb3BfYW5kKHgsIHkpIHsKICAgICAgICByZXR1cm4geCAmIHk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYm5BbmQoYSkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgdGhpcy5iaXR3aXNlVG8oYSwgb3BfYW5kLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyB8IGEKICAgICAgZnVuY3Rpb24gb3Bfb3IoeCwgeSkgewogICAgICAgIHJldHVybiB4IHwgeTsKICAgICAgfQogICAgICBmdW5jdGlvbiBibk9yKGEpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuYml0d2lzZVRvKGEsIG9wX29yLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyBeIGEKICAgICAgZnVuY3Rpb24gb3BfeG9yKHgsIHkpIHsKICAgICAgICByZXR1cm4geCBeIHk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYm5Yb3IoYSkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgdGhpcy5iaXR3aXNlVG8oYSwgb3BfeG9yLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyAmIH5hCiAgICAgIGZ1bmN0aW9uIG9wX2FuZG5vdCh4LCB5KSB7CiAgICAgICAgcmV0dXJuIHggJiB+eTsKICAgICAgfQogICAgICBmdW5jdGlvbiBibkFuZE5vdChhKSB7CiAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICB0aGlzLmJpdHdpc2VUbyhhLCBvcF9hbmRub3QsIHIpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSB+dGhpcwogICAgICBmdW5jdGlvbiBibk5vdCgpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50OyArK2kpIHJbaV0gPSB0aGlzLkRNICYgfnRoaXNbaV07CiAgICAgICAgci50ID0gdGhpcy50OwogICAgICAgIHIucyA9IH50aGlzLnM7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXMgPDwgbgogICAgICBmdW5jdGlvbiBiblNoaWZ0TGVmdChuKSB7CiAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICBpZiAobiA8IDApIHRoaXMuclNoaWZ0VG8oLW4sIHIpO2Vsc2UgdGhpcy5sU2hpZnRUbyhuLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyA+PiBuCiAgICAgIGZ1bmN0aW9uIGJuU2hpZnRSaWdodChuKSB7CiAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICBpZiAobiA8IDApIHRoaXMubFNoaWZ0VG8oLW4sIHIpO2Vsc2UgdGhpcy5yU2hpZnRUbyhuLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gcmV0dXJuIGluZGV4IG9mIGxvd2VzdCAxLWJpdCBpbiB4LCB4IDwgMl4zMQogICAgICBmdW5jdGlvbiBsYml0KHgpIHsKICAgICAgICBpZiAoeCA9PSAwKSByZXR1cm4gLTE7CiAgICAgICAgdmFyIHIgPSAwOwogICAgICAgIGlmICgoeCAmIDB4ZmZmZikgPT0gMCkgewogICAgICAgICAgeCA+Pj0gMTY7CiAgICAgICAgICByICs9IDE2OwogICAgICAgIH0KICAgICAgICBpZiAoKHggJiAweGZmKSA9PSAwKSB7CiAgICAgICAgICB4ID4+PSA4OwogICAgICAgICAgciArPSA4OwogICAgICAgIH0KICAgICAgICBpZiAoKHggJiAweGYpID09IDApIHsKICAgICAgICAgIHggPj49IDQ7CiAgICAgICAgICByICs9IDQ7CiAgICAgICAgfQogICAgICAgIGlmICgoeCAmIDMpID09IDApIHsKICAgICAgICAgIHggPj49IDI7CiAgICAgICAgICByICs9IDI7CiAgICAgICAgfQogICAgICAgIGlmICgoeCAmIDEpID09IDApICsrcjsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgcmV0dXJucyBpbmRleCBvZiBsb3dlc3QgMS1iaXQgKG9yIC0xIGlmIG5vbmUpCiAgICAgIGZ1bmN0aW9uIGJuR2V0TG93ZXN0U2V0Qml0KCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50OyArK2kpIGlmICh0aGlzW2ldICE9IDApIHJldHVybiBpICogdGhpcy5EQiArIGxiaXQodGhpc1tpXSk7CiAgICAgICAgaWYgKHRoaXMucyA8IDApIHJldHVybiB0aGlzLnQgKiB0aGlzLkRCOwogICAgICAgIHJldHVybiAtMTsKICAgICAgfQoKICAgICAgLy8gcmV0dXJuIG51bWJlciBvZiAxIGJpdHMgaW4geAogICAgICBmdW5jdGlvbiBjYml0KHgpIHsKICAgICAgICB2YXIgciA9IDA7CiAgICAgICAgd2hpbGUgKHggIT0gMCkgewogICAgICAgICAgeCAmPSB4IC0gMTsKICAgICAgICAgICsrcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHJldHVybiBudW1iZXIgb2Ygc2V0IGJpdHMKICAgICAgZnVuY3Rpb24gYm5CaXRDb3VudCgpIHsKICAgICAgICB2YXIgciA9IDAsCiAgICAgICAgICB4ID0gdGhpcy5zICYgdGhpcy5ETTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudDsgKytpKSByICs9IGNiaXQodGhpc1tpXSBeIHgpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSB0cnVlIGlmZiBudGggYml0IGlzIHNldAogICAgICBmdW5jdGlvbiBiblRlc3RCaXQobikgewogICAgICAgIHZhciBqID0gTWF0aC5mbG9vcihuIC8gdGhpcy5EQik7CiAgICAgICAgaWYgKGogPj0gdGhpcy50KSByZXR1cm4gdGhpcy5zICE9IDA7CiAgICAgICAgcmV0dXJuICh0aGlzW2pdICYgMSA8PCBuICUgdGhpcy5EQikgIT0gMDsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgdGhpcyBvcCAoMTw8bikKICAgICAgZnVuY3Rpb24gYm5wQ2hhbmdlQml0KG4sIG9wKSB7CiAgICAgICAgdmFyIHIgPSBCaWdJbnRlZ2VyLk9ORS5zaGlmdExlZnQobik7CiAgICAgICAgdGhpcy5iaXR3aXNlVG8ociwgb3AsIHIpOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSB0aGlzIHwgKDE8PG4pCiAgICAgIGZ1bmN0aW9uIGJuU2V0Qml0KG4pIHsKICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VCaXQobiwgb3Bfb3IpOwogICAgICB9CgogICAgICAvLyAocHVibGljKSB0aGlzICYgfigxPDxuKQogICAgICBmdW5jdGlvbiBibkNsZWFyQml0KG4pIHsKICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VCaXQobiwgb3BfYW5kbm90KTsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyBeICgxPDxuKQogICAgICBmdW5jdGlvbiBibkZsaXBCaXQobikgewogICAgICAgIHJldHVybiB0aGlzLmNoYW5nZUJpdChuLCBvcF94b3IpOwogICAgICB9CgogICAgICAvLyAocHJvdGVjdGVkKSByID0gdGhpcyArIGEKICAgICAgZnVuY3Rpb24gYm5wQWRkVG8oYSwgcikgewogICAgICAgIHZhciBpID0gMCwKICAgICAgICAgIGMgPSAwLAogICAgICAgICAgbSA9IE1hdGgubWluKGEudCwgdGhpcy50KTsKICAgICAgICB3aGlsZSAoaSA8IG0pIHsKICAgICAgICAgIGMgKz0gdGhpc1tpXSArIGFbaV07CiAgICAgICAgICByW2krK10gPSBjICYgdGhpcy5ETTsKICAgICAgICAgIGMgPj49IHRoaXMuREI7CiAgICAgICAgfQogICAgICAgIGlmIChhLnQgPCB0aGlzLnQpIHsKICAgICAgICAgIGMgKz0gYS5zOwogICAgICAgICAgd2hpbGUgKGkgPCB0aGlzLnQpIHsKICAgICAgICAgICAgYyArPSB0aGlzW2ldOwogICAgICAgICAgICByW2krK10gPSBjICYgdGhpcy5ETTsKICAgICAgICAgICAgYyA+Pj0gdGhpcy5EQjsKICAgICAgICAgIH0KICAgICAgICAgIGMgKz0gdGhpcy5zOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjICs9IHRoaXMuczsKICAgICAgICAgIHdoaWxlIChpIDwgYS50KSB7CiAgICAgICAgICAgIGMgKz0gYVtpXTsKICAgICAgICAgICAgcltpKytdID0gYyAmIHRoaXMuRE07CiAgICAgICAgICAgIGMgPj49IHRoaXMuREI7CiAgICAgICAgICB9CiAgICAgICAgICBjICs9IGEuczsKICAgICAgICB9CiAgICAgICAgci5zID0gYyA8IDAgPyAtMSA6IDA7CiAgICAgICAgaWYgKGMgPiAwKSByW2krK10gPSBjO2Vsc2UgaWYgKGMgPCAtMSkgcltpKytdID0gdGhpcy5EViArIGM7CiAgICAgICAgci50ID0gaTsKICAgICAgICByLmNsYW1wKCk7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXMgKyBhCiAgICAgIGZ1bmN0aW9uIGJuQWRkKGEpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuYWRkVG8oYSwgcik7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXMgLSBhCiAgICAgIGZ1bmN0aW9uIGJuU3VidHJhY3QoYSkgewogICAgICAgIHZhciByID0gbmJpKCk7CiAgICAgICAgdGhpcy5zdWJUbyhhLCByKTsKICAgICAgICByZXR1cm4gcjsKICAgICAgfQoKICAgICAgLy8gKHB1YmxpYykgdGhpcyAqIGEKICAgICAgZnVuY3Rpb24gYm5NdWx0aXBseShhKSB7CiAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICB0aGlzLm11bHRpcGx5VG8oYSwgcik7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXNeMgogICAgICBmdW5jdGlvbiBiblNxdWFyZSgpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuc3F1YXJlVG8ocik7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXMgLyBhCiAgICAgIGZ1bmN0aW9uIGJuRGl2aWRlKGEpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuZGl2UmVtVG8oYSwgciwgbnVsbCk7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIHRoaXMgJSBhCiAgICAgIGZ1bmN0aW9uIGJuUmVtYWluZGVyKGEpIHsKICAgICAgICB2YXIgciA9IG5iaSgpOwogICAgICAgIHRoaXMuZGl2UmVtVG8oYSwgbnVsbCwgcik7CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICAgIC8vIChwdWJsaWMpIFt0aGlzL2EsdGhpcyVhXQogICAgICBmdW5jdGlvbiBibkRpdmlkZUFuZFJlbWFpbmRlcihhKSB7CiAgICAgICAgdmFyIHEgPSBuYmkoKSwKICAgICAgICAgIHIgPSBuYmkoKTsKICAgICAgICB0aGlzLmRpdlJlbVRvKGEsIHEsIHIpOwogICAgICAgIHJldHVybiBuZXcgQXJyYXkocSwgcik7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHRoaXMgKj0gbiwgdGhpcyA+PSAwLCAxIDwgbiA8IERWCiAgICAgIGZ1bmN0aW9uIGJucERNdWx0aXBseShuKSB7CiAgICAgICAgdGhpc1t0aGlzLnRdID0gdGhpcy5hbSgwLCBuIC0gMSwgdGhpcywgMCwgMCwgdGhpcy50KTsKICAgICAgICArK3RoaXMudDsKICAgICAgICB0aGlzLmNsYW1wKCk7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHRoaXMgKz0gbiA8PCB3IHdvcmRzLCB0aGlzID49IDAKICAgICAgZnVuY3Rpb24gYm5wREFkZE9mZnNldChuLCB3KSB7CiAgICAgICAgaWYgKG4gPT0gMCkgcmV0dXJuOwogICAgICAgIHdoaWxlICh0aGlzLnQgPD0gdykgdGhpc1t0aGlzLnQrK10gPSAwOwogICAgICAgIHRoaXNbd10gKz0gbjsKICAgICAgICB3aGlsZSAodGhpc1t3XSA+PSB0aGlzLkRWKSB7CiAgICAgICAgICB0aGlzW3ddIC09IHRoaXMuRFY7CiAgICAgICAgICBpZiAoKyt3ID49IHRoaXMudCkgdGhpc1t0aGlzLnQrK10gPSAwOwogICAgICAgICAgKyt0aGlzW3ddOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQSAibnVsbCIgcmVkdWNlcgogICAgICBmdW5jdGlvbiBOdWxsRXhwKCkge30KICAgICAgZnVuY3Rpb24gbk5vcCh4KSB7CiAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbk11bFRvKHgsIHksIHIpIHsKICAgICAgICB4Lm11bHRpcGx5VG8oeSwgcik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gblNxclRvKHgsIHIpIHsKICAgICAgICB4LnNxdWFyZVRvKHIpOwogICAgICB9CiAgICAgIE51bGxFeHAucHJvdG90eXBlLmNvbnZlcnQgPSBuTm9wOwogICAgICBOdWxsRXhwLnByb3RvdHlwZS5yZXZlcnQgPSBuTm9wOwogICAgICBOdWxsRXhwLnByb3RvdHlwZS5tdWxUbyA9IG5NdWxUbzsKICAgICAgTnVsbEV4cC5wcm90b3R5cGUuc3FyVG8gPSBuU3FyVG87CgogICAgICAvLyAocHVibGljKSB0aGlzXmUKICAgICAgZnVuY3Rpb24gYm5Qb3coZSkgewogICAgICAgIHJldHVybiB0aGlzLmV4cChlLCBuZXcgTnVsbEV4cCgpKTsKICAgICAgfQoKICAgICAgLy8gKHByb3RlY3RlZCkgciA9IGxvd2VyIG4gd29yZHMgb2YgInRoaXMgKiBhIiwgYS50IDw9IG4KICAgICAgLy8gInRoaXMiIHNob3VsZCBiZSB0aGUgbGFyZ2VyIG9uZSBpZiBhcHByb3ByaWF0ZS4KICAgICAgZnVuY3Rpb24gYm5wTXVsdGlwbHlMb3dlclRvKGEsIG4sIHIpIHsKICAgICAgICB2YXIgaSA9IE1hdGgubWluKHRoaXMudCArIGEudCwgbik7CiAgICAgICAgci5zID0gMDsgLy8gYXNzdW1lcyBhLHRoaXMgPj0gMAogICAgICAgIHIudCA9IGk7CiAgICAgICAgd2hpbGUgKGkgPiAwKSByWy0taV0gPSAwOwogICAgICAgIHZhciBqOwogICAgICAgIGZvciAoaiA9IHIudCAtIHRoaXMudDsgaSA8IGo7ICsraSkgcltpICsgdGhpcy50XSA9IHRoaXMuYW0oMCwgYVtpXSwgciwgaSwgMCwgdGhpcy50KTsKICAgICAgICBmb3IgKGogPSBNYXRoLm1pbihhLnQsIG4pOyBpIDwgajsgKytpKSB0aGlzLmFtKDAsIGFbaV0sIHIsIGksIDAsIG4gLSBpKTsKICAgICAgICByLmNsYW1wKCk7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHIgPSAidGhpcyAqIGEiIHdpdGhvdXQgbG93ZXIgbiB3b3JkcywgbiA+IDAKICAgICAgLy8gInRoaXMiIHNob3VsZCBiZSB0aGUgbGFyZ2VyIG9uZSBpZiBhcHByb3ByaWF0ZS4KICAgICAgZnVuY3Rpb24gYm5wTXVsdGlwbHlVcHBlclRvKGEsIG4sIHIpIHsKICAgICAgICAtLW47CiAgICAgICAgdmFyIGkgPSByLnQgPSB0aGlzLnQgKyBhLnQgLSBuOwogICAgICAgIHIucyA9IDA7IC8vIGFzc3VtZXMgYSx0aGlzID49IDAKICAgICAgICB3aGlsZSAoLS1pID49IDApIHJbaV0gPSAwOwogICAgICAgIGZvciAoaSA9IE1hdGgubWF4KG4gLSB0aGlzLnQsIDApOyBpIDwgYS50OyArK2kpIHJbdGhpcy50ICsgaSAtIG5dID0gdGhpcy5hbShuIC0gaSwgYVtpXSwgciwgMCwgMCwgdGhpcy50ICsgaSAtIG4pOwogICAgICAgIHIuY2xhbXAoKTsKICAgICAgICByLmRyU2hpZnRUbygxLCByKTsKICAgICAgfQoKICAgICAgLy8gQmFycmV0dCBtb2R1bGFyIHJlZHVjdGlvbgogICAgICBmdW5jdGlvbiBCYXJyZXR0KG0pIHsKICAgICAgICAvLyBzZXR1cCBCYXJyZXR0CiAgICAgICAgdGhpcy5yMiA9IG5iaSgpOwogICAgICAgIHRoaXMucTMgPSBuYmkoKTsKICAgICAgICBCaWdJbnRlZ2VyLk9ORS5kbFNoaWZ0VG8oMiAqIG0udCwgdGhpcy5yMik7CiAgICAgICAgdGhpcy5tdSA9IHRoaXMucjIuZGl2aWRlKG0pOwogICAgICAgIHRoaXMubSA9IG07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYmFycmV0dENvbnZlcnQoeCkgewogICAgICAgIGlmICh4LnMgPCAwIHx8IHgudCA+IDIgKiB0aGlzLm0udCkgcmV0dXJuIHgubW9kKHRoaXMubSk7ZWxzZSBpZiAoeC5jb21wYXJlVG8odGhpcy5tKSA8IDApIHJldHVybiB4O2Vsc2UgewogICAgICAgICAgdmFyIHIgPSBuYmkoKTsKICAgICAgICAgIHguY29weVRvKHIpOwogICAgICAgICAgdGhpcy5yZWR1Y2Uocik7CiAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYmFycmV0dFJldmVydCh4KSB7CiAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KCiAgICAgIC8vIHggPSB4IG1vZCBtIChIQUMgMTQuNDIpCiAgICAgIGZ1bmN0aW9uIGJhcnJldHRSZWR1Y2UoeCkgewogICAgICAgIHguZHJTaGlmdFRvKHRoaXMubS50IC0gMSwgdGhpcy5yMik7CiAgICAgICAgaWYgKHgudCA+IHRoaXMubS50ICsgMSkgewogICAgICAgICAgeC50ID0gdGhpcy5tLnQgKyAxOwogICAgICAgICAgeC5jbGFtcCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLm11Lm11bHRpcGx5VXBwZXJUbyh0aGlzLnIyLCB0aGlzLm0udCArIDEsIHRoaXMucTMpOwogICAgICAgIHRoaXMubS5tdWx0aXBseUxvd2VyVG8odGhpcy5xMywgdGhpcy5tLnQgKyAxLCB0aGlzLnIyKTsKICAgICAgICB3aGlsZSAoeC5jb21wYXJlVG8odGhpcy5yMikgPCAwKSB4LmRBZGRPZmZzZXQoMSwgdGhpcy5tLnQgKyAxKTsKICAgICAgICB4LnN1YlRvKHRoaXMucjIsIHgpOwogICAgICAgIHdoaWxlICh4LmNvbXBhcmVUbyh0aGlzLm0pID49IDApIHguc3ViVG8odGhpcy5tLCB4KTsKICAgICAgfQoKICAgICAgLy8gciA9IHheMiBtb2QgbTsgeCAhPSByCiAgICAgIGZ1bmN0aW9uIGJhcnJldHRTcXJUbyh4LCByKSB7CiAgICAgICAgeC5zcXVhcmVUbyhyKTsKICAgICAgICB0aGlzLnJlZHVjZShyKTsKICAgICAgfQoKICAgICAgLy8gciA9IHgqeSBtb2QgbTsgeCx5ICE9IHIKICAgICAgZnVuY3Rpb24gYmFycmV0dE11bFRvKHgsIHksIHIpIHsKICAgICAgICB4Lm11bHRpcGx5VG8oeSwgcik7CiAgICAgICAgdGhpcy5yZWR1Y2Uocik7CiAgICAgIH0KICAgICAgQmFycmV0dC5wcm90b3R5cGUuY29udmVydCA9IGJhcnJldHRDb252ZXJ0OwogICAgICBCYXJyZXR0LnByb3RvdHlwZS5yZXZlcnQgPSBiYXJyZXR0UmV2ZXJ0OwogICAgICBCYXJyZXR0LnByb3RvdHlwZS5yZWR1Y2UgPSBiYXJyZXR0UmVkdWNlOwogICAgICBCYXJyZXR0LnByb3RvdHlwZS5tdWxUbyA9IGJhcnJldHRNdWxUbzsKICAgICAgQmFycmV0dC5wcm90b3R5cGUuc3FyVG8gPSBiYXJyZXR0U3FyVG87CgogICAgICAvLyAocHVibGljKSB0aGlzXmUgJSBtIChIQUMgMTQuODUpCiAgICAgIGZ1bmN0aW9uIGJuTW9kUG93KGUsIG0pIHsKICAgICAgICB2YXIgaSA9IGUuYml0TGVuZ3RoKCksCiAgICAgICAgICBrLAogICAgICAgICAgciA9IG5idigxKSwKICAgICAgICAgIHo7CiAgICAgICAgaWYgKGkgPD0gMCkgcmV0dXJuIHI7ZWxzZSBpZiAoaSA8IDE4KSBrID0gMTtlbHNlIGlmIChpIDwgNDgpIGsgPSAzO2Vsc2UgaWYgKGkgPCAxNDQpIGsgPSA0O2Vsc2UgaWYgKGkgPCA3NjgpIGsgPSA1O2Vsc2UgayA9IDY7CiAgICAgICAgaWYgKGkgPCA4KSB6ID0gbmV3IENsYXNzaWMobSk7ZWxzZSBpZiAobS5pc0V2ZW4oKSkgeiA9IG5ldyBCYXJyZXR0KG0pO2Vsc2UgeiA9IG5ldyBNb250Z29tZXJ5KG0pOwoKICAgICAgICAvLyBwcmVjb21wdXRhdGlvbgogICAgICAgIHZhciBnID0gbmV3IEFycmF5KCksCiAgICAgICAgICBuID0gMywKICAgICAgICAgIGsxID0gayAtIDEsCiAgICAgICAgICBrbSA9ICgxIDw8IGspIC0gMTsKICAgICAgICBnWzFdID0gei5jb252ZXJ0KHRoaXMpOwogICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgdmFyIGcyID0gbmJpKCk7CiAgICAgICAgICB6LnNxclRvKGdbMV0sIGcyKTsKICAgICAgICAgIHdoaWxlIChuIDw9IGttKSB7CiAgICAgICAgICAgIGdbbl0gPSBuYmkoKTsKICAgICAgICAgICAgei5tdWxUbyhnMiwgZ1tuIC0gMl0sIGdbbl0pOwogICAgICAgICAgICBuICs9IDI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqID0gZS50IC0gMSwKICAgICAgICAgIHcsCiAgICAgICAgICBpczEgPSB0cnVlLAogICAgICAgICAgcjIgPSBuYmkoKSwKICAgICAgICAgIHQ7CiAgICAgICAgaSA9IG5iaXRzKGVbal0pIC0gMTsKICAgICAgICB3aGlsZSAoaiA+PSAwKSB7CiAgICAgICAgICBpZiAoaSA+PSBrMSkgdyA9IGVbal0gPj4gaSAtIGsxICYga207ZWxzZSB7CiAgICAgICAgICAgIHcgPSAoZVtqXSAmICgxIDw8IGkgKyAxKSAtIDEpIDw8IGsxIC0gaTsKICAgICAgICAgICAgaWYgKGogPiAwKSB3IHw9IGVbaiAtIDFdID4+IHRoaXMuREIgKyBpIC0gazE7CiAgICAgICAgICB9CiAgICAgICAgICBuID0gazsKICAgICAgICAgIHdoaWxlICgodyAmIDEpID09IDApIHsKICAgICAgICAgICAgdyA+Pj0gMTsKICAgICAgICAgICAgLS1uOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChpIC09IG4pIDwgMCkgewogICAgICAgICAgICBpICs9IHRoaXMuREI7CiAgICAgICAgICAgIC0tajsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpczEpIHsKICAgICAgICAgICAgLy8gcmV0ID09IDEsIGRvbid0IGJvdGhlciBzcXVhcmluZyBvciBtdWx0aXBseWluZyBpdAogICAgICAgICAgICBnW3ddLmNvcHlUbyhyKTsKICAgICAgICAgICAgaXMxID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGlsZSAobiA+IDEpIHsKICAgICAgICAgICAgICB6LnNxclRvKHIsIHIyKTsKICAgICAgICAgICAgICB6LnNxclRvKHIyLCByKTsKICAgICAgICAgICAgICBuIC09IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG4gPiAwKSB6LnNxclRvKHIsIHIyKTtlbHNlIHsKICAgICAgICAgICAgICB0ID0gcjsKICAgICAgICAgICAgICByID0gcjI7CiAgICAgICAgICAgICAgcjIgPSB0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHoubXVsVG8ocjIsIGdbd10sIHIpOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGogPj0gMCAmJiAoZVtqXSAmIDEgPDwgaSkgPT0gMCkgewogICAgICAgICAgICB6LnNxclRvKHIsIHIyKTsKICAgICAgICAgICAgdCA9IHI7CiAgICAgICAgICAgIHIgPSByMjsKICAgICAgICAgICAgcjIgPSB0OwogICAgICAgICAgICBpZiAoLS1pIDwgMCkgewogICAgICAgICAgICAgIGkgPSB0aGlzLkRCIC0gMTsKICAgICAgICAgICAgICAtLWo7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHoucmV2ZXJ0KHIpOwogICAgICB9CgogICAgICAvLyAocHVibGljKSBnY2QodGhpcyxhKSAoSEFDIDE0LjU0KQogICAgICBmdW5jdGlvbiBibkdDRChhKSB7CiAgICAgICAgdmFyIHggPSB0aGlzLnMgPCAwID8gdGhpcy5uZWdhdGUoKSA6IHRoaXMuY2xvbmUoKTsKICAgICAgICB2YXIgeSA9IGEucyA8IDAgPyBhLm5lZ2F0ZSgpIDogYS5jbG9uZSgpOwogICAgICAgIGlmICh4LmNvbXBhcmVUbyh5KSA8IDApIHsKICAgICAgICAgIHZhciB0ID0geDsKICAgICAgICAgIHggPSB5OwogICAgICAgICAgeSA9IHQ7CiAgICAgICAgfQogICAgICAgIHZhciBpID0geC5nZXRMb3dlc3RTZXRCaXQoKSwKICAgICAgICAgIGcgPSB5LmdldExvd2VzdFNldEJpdCgpOwogICAgICAgIGlmIChnIDwgMCkgcmV0dXJuIHg7CiAgICAgICAgaWYgKGkgPCBnKSBnID0gaTsKICAgICAgICBpZiAoZyA+IDApIHsKICAgICAgICAgIHguclNoaWZ0VG8oZywgeCk7CiAgICAgICAgICB5LnJTaGlmdFRvKGcsIHkpOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoeC5zaWdudW0oKSA+IDApIHsKICAgICAgICAgIGlmICgoaSA9IHguZ2V0TG93ZXN0U2V0Qml0KCkpID4gMCkgeC5yU2hpZnRUbyhpLCB4KTsKICAgICAgICAgIGlmICgoaSA9IHkuZ2V0TG93ZXN0U2V0Qml0KCkpID4gMCkgeS5yU2hpZnRUbyhpLCB5KTsKICAgICAgICAgIGlmICh4LmNvbXBhcmVUbyh5KSA+PSAwKSB7CiAgICAgICAgICAgIHguc3ViVG8oeSwgeCk7CiAgICAgICAgICAgIHguclNoaWZ0VG8oMSwgeCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB5LnN1YlRvKHgsIHkpOwogICAgICAgICAgICB5LnJTaGlmdFRvKDEsIHkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZyA+IDApIHkubFNoaWZ0VG8oZywgeSk7CiAgICAgICAgcmV0dXJuIHk7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHRoaXMgJSBuLCBuIDwgMl4yNgogICAgICBmdW5jdGlvbiBibnBNb2RJbnQobikgewogICAgICAgIGlmIChuIDw9IDApIHJldHVybiAwOwogICAgICAgIHZhciBkID0gdGhpcy5EViAlIG4sCiAgICAgICAgICByID0gdGhpcy5zIDwgMCA/IG4gLSAxIDogMDsKICAgICAgICBpZiAodGhpcy50ID4gMCkgaWYgKGQgPT0gMCkgciA9IHRoaXNbMF0gJSBuO2Vsc2UgZm9yICh2YXIgaSA9IHRoaXMudCAtIDE7IGkgPj0gMDsgLS1pKSByID0gKGQgKiByICsgdGhpc1tpXSkgJSBuOwogICAgICAgIHJldHVybiByOwogICAgICB9CgogICAgICAvLyAocHVibGljKSAxL3RoaXMgJSBtIChIQUMgMTQuNjEpCiAgICAgIGZ1bmN0aW9uIGJuTW9kSW52ZXJzZShtKSB7CiAgICAgICAgdmFyIGFjID0gbS5pc0V2ZW4oKTsKICAgICAgICBpZiAodGhpcy5pc0V2ZW4oKSAmJiBhYyB8fCBtLnNpZ251bSgpID09IDApIHJldHVybiBCaWdJbnRlZ2VyLlpFUk87CiAgICAgICAgdmFyIHUgPSBtLmNsb25lKCksCiAgICAgICAgICB2ID0gdGhpcy5jbG9uZSgpOwogICAgICAgIHZhciBhID0gbmJ2KDEpLAogICAgICAgICAgYiA9IG5idigwKSwKICAgICAgICAgIGMgPSBuYnYoMCksCiAgICAgICAgICBkID0gbmJ2KDEpOwogICAgICAgIHdoaWxlICh1LnNpZ251bSgpICE9IDApIHsKICAgICAgICAgIHdoaWxlICh1LmlzRXZlbigpKSB7CiAgICAgICAgICAgIHUuclNoaWZ0VG8oMSwgdSk7CiAgICAgICAgICAgIGlmIChhYykgewogICAgICAgICAgICAgIGlmICghYS5pc0V2ZW4oKSB8fCAhYi5pc0V2ZW4oKSkgewogICAgICAgICAgICAgICAgYS5hZGRUbyh0aGlzLCBhKTsKICAgICAgICAgICAgICAgIGIuc3ViVG8obSwgYik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGEuclNoaWZ0VG8oMSwgYSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWIuaXNFdmVuKCkpIGIuc3ViVG8obSwgYik7CiAgICAgICAgICAgIGIuclNoaWZ0VG8oMSwgYik7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAodi5pc0V2ZW4oKSkgewogICAgICAgICAgICB2LnJTaGlmdFRvKDEsIHYpOwogICAgICAgICAgICBpZiAoYWMpIHsKICAgICAgICAgICAgICBpZiAoIWMuaXNFdmVuKCkgfHwgIWQuaXNFdmVuKCkpIHsKICAgICAgICAgICAgICAgIGMuYWRkVG8odGhpcywgYyk7CiAgICAgICAgICAgICAgICBkLnN1YlRvKG0sIGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjLnJTaGlmdFRvKDEsIGMpOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFkLmlzRXZlbigpKSBkLnN1YlRvKG0sIGQpOwogICAgICAgICAgICBkLnJTaGlmdFRvKDEsIGQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHUuY29tcGFyZVRvKHYpID49IDApIHsKICAgICAgICAgICAgdS5zdWJUbyh2LCB1KTsKICAgICAgICAgICAgaWYgKGFjKSBhLnN1YlRvKGMsIGEpOwogICAgICAgICAgICBiLnN1YlRvKGQsIGIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdi5zdWJUbyh1LCB2KTsKICAgICAgICAgICAgaWYgKGFjKSBjLnN1YlRvKGEsIGMpOwogICAgICAgICAgICBkLnN1YlRvKGIsIGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodi5jb21wYXJlVG8oQmlnSW50ZWdlci5PTkUpICE9IDApIHJldHVybiBCaWdJbnRlZ2VyLlpFUk87CiAgICAgICAgaWYgKGQuY29tcGFyZVRvKG0pID49IDApIHJldHVybiBkLnN1YnRyYWN0KG0pOwogICAgICAgIGlmIChkLnNpZ251bSgpIDwgMCkgZC5hZGRUbyhtLCBkKTtlbHNlIHJldHVybiBkOwogICAgICAgIGlmIChkLnNpZ251bSgpIDwgMCkgcmV0dXJuIGQuYWRkKG0pO2Vsc2UgcmV0dXJuIGQ7CiAgICAgIH0KICAgICAgdmFyIGxvd3ByaW1lcyA9IFsyLCAzLCA1LCA3LCAxMSwgMTMsIDE3LCAxOSwgMjMsIDI5LCAzMSwgMzcsIDQxLCA0MywgNDcsIDUzLCA1OSwgNjEsIDY3LCA3MSwgNzMsIDc5LCA4MywgODksIDk3LCAxMDEsIDEwMywgMTA3LCAxMDksIDExMywgMTI3LCAxMzEsIDEzNywgMTM5LCAxNDksIDE1MSwgMTU3LCAxNjMsIDE2NywgMTczLCAxNzksIDE4MSwgMTkxLCAxOTMsIDE5NywgMTk5LCAyMTEsIDIyMywgMjI3LCAyMjksIDIzMywgMjM5LCAyNDEsIDI1MSwgMjU3LCAyNjMsIDI2OSwgMjcxLCAyNzcsIDI4MSwgMjgzLCAyOTMsIDMwNywgMzExLCAzMTMsIDMxNywgMzMxLCAzMzcsIDM0NywgMzQ5LCAzNTMsIDM1OSwgMzY3LCAzNzMsIDM3OSwgMzgzLCAzODksIDM5NywgNDAxLCA0MDksIDQxOSwgNDIxLCA0MzEsIDQzMywgNDM5LCA0NDMsIDQ0OSwgNDU3LCA0NjEsIDQ2MywgNDY3LCA0NzksIDQ4NywgNDkxLCA0OTksIDUwMywgNTA5LCA1MjEsIDUyMywgNTQxLCA1NDcsIDU1NywgNTYzLCA1NjksIDU3MSwgNTc3LCA1ODcsIDU5MywgNTk5LCA2MDEsIDYwNywgNjEzLCA2MTcsIDYxOSwgNjMxLCA2NDEsIDY0MywgNjQ3LCA2NTMsIDY1OSwgNjYxLCA2NzMsIDY3NywgNjgzLCA2OTEsIDcwMSwgNzA5LCA3MTksIDcyNywgNzMzLCA3MzksIDc0MywgNzUxLCA3NTcsIDc2MSwgNzY5LCA3NzMsIDc4NywgNzk3LCA4MDksIDgxMSwgODIxLCA4MjMsIDgyNywgODI5LCA4MzksIDg1MywgODU3LCA4NTksIDg2MywgODc3LCA4ODEsIDg4MywgODg3LCA5MDcsIDkxMSwgOTE5LCA5MjksIDkzNywgOTQxLCA5NDcsIDk1MywgOTY3LCA5NzEsIDk3NywgOTgzLCA5OTEsIDk5N107CiAgICAgIHZhciBscGxpbSA9ICgxIDw8IDI2KSAvIGxvd3ByaW1lc1tsb3dwcmltZXMubGVuZ3RoIC0gMV07CgogICAgICAvLyAocHVibGljKSB0ZXN0IHByaW1hbGl0eSB3aXRoIGNlcnRhaW50eSA+PSAxLS41XnQKICAgICAgZnVuY3Rpb24gYm5Jc1Byb2JhYmxlUHJpbWUodCkgewogICAgICAgIHZhciBpLAogICAgICAgICAgeCA9IHRoaXMuYWJzKCk7CiAgICAgICAgaWYgKHgudCA9PSAxICYmIHhbMF0gPD0gbG93cHJpbWVzW2xvd3ByaW1lcy5sZW5ndGggLSAxXSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxvd3ByaW1lcy5sZW5ndGg7ICsraSkgaWYgKHhbMF0gPT0gbG93cHJpbWVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYgKHguaXNFdmVuKCkpIHJldHVybiBmYWxzZTsKICAgICAgICBpID0gMTsKICAgICAgICB3aGlsZSAoaSA8IGxvd3ByaW1lcy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBtID0gbG93cHJpbWVzW2ldLAogICAgICAgICAgICBqID0gaSArIDE7CiAgICAgICAgICB3aGlsZSAoaiA8IGxvd3ByaW1lcy5sZW5ndGggJiYgbSA8IGxwbGltKSBtICo9IGxvd3ByaW1lc1tqKytdOwogICAgICAgICAgbSA9IHgubW9kSW50KG0pOwogICAgICAgICAgd2hpbGUgKGkgPCBqKSBpZiAobSAlIGxvd3ByaW1lc1tpKytdID09IDApIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgubWlsbGVyUmFiaW4odCk7CiAgICAgIH0KCiAgICAgIC8vIChwcm90ZWN0ZWQpIHRydWUgaWYgcHJvYmFibHkgcHJpbWUgKEhBQyA0LjI0LCBNaWxsZXItUmFiaW4pCiAgICAgIGZ1bmN0aW9uIGJucE1pbGxlclJhYmluKHQpIHsKICAgICAgICB2YXIgbjEgPSB0aGlzLnN1YnRyYWN0KEJpZ0ludGVnZXIuT05FKTsKICAgICAgICB2YXIgayA9IG4xLmdldExvd2VzdFNldEJpdCgpOwogICAgICAgIGlmIChrIDw9IDApIHJldHVybiBmYWxzZTsKICAgICAgICB2YXIgciA9IG4xLnNoaWZ0UmlnaHQoayk7CiAgICAgICAgdCA9IHQgKyAxID4+IDE7CiAgICAgICAgaWYgKHQgPiBsb3dwcmltZXMubGVuZ3RoKSB0ID0gbG93cHJpbWVzLmxlbmd0aDsKICAgICAgICB2YXIgYSA9IG5iaSgpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdDsgKytpKSB7CiAgICAgICAgICAvL1BpY2sgYmFzZXMgYXQgcmFuZG9tLCBpbnN0ZWFkIG9mIHN0YXJ0aW5nIGF0IDIKICAgICAgICAgIGEuZnJvbUludChsb3dwcmltZXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbG93cHJpbWVzLmxlbmd0aCldKTsKICAgICAgICAgIHZhciB5ID0gYS5tb2RQb3cociwgdGhpcyk7CiAgICAgICAgICBpZiAoeS5jb21wYXJlVG8oQmlnSW50ZWdlci5PTkUpICE9IDAgJiYgeS5jb21wYXJlVG8objEpICE9IDApIHsKICAgICAgICAgICAgdmFyIGogPSAxOwogICAgICAgICAgICB3aGlsZSAoaisrIDwgayAmJiB5LmNvbXBhcmVUbyhuMSkgIT0gMCkgewogICAgICAgICAgICAgIHkgPSB5Lm1vZFBvd0ludCgyLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoeS5jb21wYXJlVG8oQmlnSW50ZWdlci5PTkUpID09IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoeS5jb21wYXJlVG8objEpICE9IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIC8vIHByb3RlY3RlZAogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5jaHVua1NpemUgPSBibnBDaHVua1NpemU7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnRvUmFkaXggPSBibnBUb1JhZGl4OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5mcm9tUmFkaXggPSBibnBGcm9tUmFkaXg7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmZyb21OdW1iZXIgPSBibnBGcm9tTnVtYmVyOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5iaXR3aXNlVG8gPSBibnBCaXR3aXNlVG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmNoYW5nZUJpdCA9IGJucENoYW5nZUJpdDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYWRkVG8gPSBibnBBZGRUbzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuZE11bHRpcGx5ID0gYm5wRE11bHRpcGx5OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5kQWRkT2Zmc2V0ID0gYm5wREFkZE9mZnNldDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubXVsdGlwbHlMb3dlclRvID0gYm5wTXVsdGlwbHlMb3dlclRvOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5tdWx0aXBseVVwcGVyVG8gPSBibnBNdWx0aXBseVVwcGVyVG87CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLm1vZEludCA9IGJucE1vZEludDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubWlsbGVyUmFiaW4gPSBibnBNaWxsZXJSYWJpbjsKCiAgICAgIC8vIHB1YmxpYwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5jbG9uZSA9IGJuQ2xvbmU7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmludFZhbHVlID0gYm5JbnRWYWx1ZTsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYnl0ZVZhbHVlID0gYm5CeXRlVmFsdWU7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnNob3J0VmFsdWUgPSBiblNob3J0VmFsdWU7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnNpZ251bSA9IGJuU2lnTnVtOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS50b0J5dGVBcnJheSA9IGJuVG9CeXRlQXJyYXk7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmVxdWFscyA9IGJuRXF1YWxzOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5taW4gPSBibk1pbjsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubWF4ID0gYm5NYXg7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmFuZCA9IGJuQW5kOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5vciA9IGJuT3I7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnhvciA9IGJuWG9yOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5hbmROb3QgPSBibkFuZE5vdDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUubm90ID0gYm5Ob3Q7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLnNoaWZ0TGVmdCA9IGJuU2hpZnRMZWZ0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5zaGlmdFJpZ2h0ID0gYm5TaGlmdFJpZ2h0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5nZXRMb3dlc3RTZXRCaXQgPSBibkdldExvd2VzdFNldEJpdDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuYml0Q291bnQgPSBibkJpdENvdW50OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS50ZXN0Qml0ID0gYm5UZXN0Qml0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5zZXRCaXQgPSBiblNldEJpdDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuY2xlYXJCaXQgPSBibkNsZWFyQml0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5mbGlwQml0ID0gYm5GbGlwQml0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5hZGQgPSBibkFkZDsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuc3VidHJhY3QgPSBiblN1YnRyYWN0OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5tdWx0aXBseSA9IGJuTXVsdGlwbHk7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmRpdmlkZSA9IGJuRGl2aWRlOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5yZW1haW5kZXIgPSBiblJlbWFpbmRlcjsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuZGl2aWRlQW5kUmVtYWluZGVyID0gYm5EaXZpZGVBbmRSZW1haW5kZXI7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLm1vZFBvdyA9IGJuTW9kUG93OwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5tb2RJbnZlcnNlID0gYm5Nb2RJbnZlcnNlOwogICAgICBCaWdJbnRlZ2VyLnByb3RvdHlwZS5wb3cgPSBiblBvdzsKICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuZ2NkID0gYm5HQ0Q7CiAgICAgIEJpZ0ludGVnZXIucHJvdG90eXBlLmlzUHJvYmFibGVQcmltZSA9IGJuSXNQcm9iYWJsZVByaW1lOwoKICAgICAgLy8gSlNCTi1zcGVjaWZpYyBleHRlbnNpb24KICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuc3F1YXJlID0gYm5TcXVhcmU7CgogICAgICAvLyBFeHBvc2UgdGhlIEJhcnJldHQgZnVuY3Rpb24KICAgICAgQmlnSW50ZWdlci5wcm90b3R5cGUuQmFycmV0dCA9IEJhcnJldHQ7CgogICAgICAvLyBCaWdJbnRlZ2VyIGludGVyZmFjZXMgbm90IGltcGxlbWVudGVkIGluIGpzYm46CgogICAgICAvLyBCaWdJbnRlZ2VyKGludCBzaWdudW0sIGJ5dGVbXSBtYWduaXR1ZGUpCiAgICAgIC8vIGRvdWJsZSBkb3VibGVWYWx1ZSgpCiAgICAgIC8vIGZsb2F0IGZsb2F0VmFsdWUoKQogICAgICAvLyBpbnQgaGFzaENvZGUoKQogICAgICAvLyBsb25nIGxvbmdWYWx1ZSgpCiAgICAgIC8vIHN0YXRpYyBCaWdJbnRlZ2VyIHZhbHVlT2YobG9uZyB2YWwpCgogICAgICAvLyBSYW5kb20gbnVtYmVyIGdlbmVyYXRvciAtIHJlcXVpcmVzIGEgUFJORyBiYWNrZW5kLCBlLmcuIHBybmc0LmpzCgogICAgICAvLyBGb3IgYmVzdCByZXN1bHRzLCBwdXQgY29kZSBsaWtlCiAgICAgIC8vIDxib2R5IG9uQ2xpY2s9J3JuZ19zZWVkX3RpbWUoKTsnIG9uS2V5UHJlc3M9J3JuZ19zZWVkX3RpbWUoKTsnPgogICAgICAvLyBpbiB5b3VyIG1haW4gSFRNTCBkb2N1bWVudC4KCiAgICAgIHZhciBybmdfc3RhdGU7CiAgICAgIHZhciBybmdfcG9vbDsKICAgICAgdmFyIHJuZ19wcHRyOwoKICAgICAgLy8gTWl4IGluIGEgMzItYml0IGludGVnZXIgaW50byB0aGUgcG9vbAogICAgICBmdW5jdGlvbiBybmdfc2VlZF9pbnQoeCkgewogICAgICAgIHJuZ19wb29sW3JuZ19wcHRyKytdIF49IHggJiAyNTU7CiAgICAgICAgcm5nX3Bvb2xbcm5nX3BwdHIrK10gXj0geCA+PiA4ICYgMjU1OwogICAgICAgIHJuZ19wb29sW3JuZ19wcHRyKytdIF49IHggPj4gMTYgJiAyNTU7CiAgICAgICAgcm5nX3Bvb2xbcm5nX3BwdHIrK10gXj0geCA+PiAyNCAmIDI1NTsKICAgICAgICBpZiAocm5nX3BwdHIgPj0gcm5nX3BzaXplKSBybmdfcHB0ciAtPSBybmdfcHNpemU7CiAgICAgIH0KCiAgICAgIC8vIE1peCBpbiB0aGUgY3VycmVudCB0aW1lICh3L21pbGxpc2Vjb25kcykgaW50byB0aGUgcG9vbAogICAgICBmdW5jdGlvbiBybmdfc2VlZF90aW1lKCkgewogICAgICAgIHJuZ19zZWVkX2ludChuZXcgRGF0ZSgpLmdldFRpbWUoKSk7CiAgICAgIH0KCiAgICAgIC8vIEluaXRpYWxpemUgdGhlIHBvb2wgd2l0aCBqdW5rIGlmIG5lZWRlZC4KICAgICAgaWYgKHJuZ19wb29sID09IG51bGwpIHsKICAgICAgICBybmdfcG9vbCA9IG5ldyBBcnJheSgpOwogICAgICAgIHJuZ19wcHRyID0gMDsKICAgICAgICB2YXIgdDsKICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmNyeXB0bykgewogICAgICAgICAgaWYgKHdpbmRvdy5jcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICAgICAgICAgIC8vIFVzZSB3ZWJjcnlwdG8gaWYgYXZhaWxhYmxlCiAgICAgICAgICAgIHZhciB1YSA9IG5ldyBVaW50OEFycmF5KDMyKTsKICAgICAgICAgICAgd2luZG93LmNyeXB0by5nZXRSYW5kb21WYWx1ZXModWEpOwogICAgICAgICAgICBmb3IgKHQgPSAwOyB0IDwgMzI7ICsrdCkgcm5nX3Bvb2xbcm5nX3BwdHIrK10gPSB1YVt0XTsKICAgICAgICAgIH0gZWxzZSBpZiAobmF2aWdhdG9yLmFwcE5hbWUgPT0gIk5ldHNjYXBlIiAmJiBuYXZpZ2F0b3IuYXBwVmVyc2lvbiA8ICI1IikgewogICAgICAgICAgICAvLyBFeHRyYWN0IGVudHJvcHkgKDI1NiBiaXRzKSBmcm9tIE5TNCBSTkcgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgIHZhciB6ID0gd2luZG93LmNyeXB0by5yYW5kb20oMzIpOwogICAgICAgICAgICBmb3IgKHQgPSAwOyB0IDwgei5sZW5ndGg7ICsrdCkgcm5nX3Bvb2xbcm5nX3BwdHIrK10gPSB6LmNoYXJDb2RlQXQodCkgJiAyNTU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChybmdfcHB0ciA8IHJuZ19wc2l6ZSkgewogICAgICAgICAgLy8gZXh0cmFjdCBzb21lIHJhbmRvbW5lc3MgZnJvbSBNYXRoLnJhbmRvbSgpCiAgICAgICAgICB0ID0gTWF0aC5mbG9vcig2NTUzNiAqIE1hdGgucmFuZG9tKCkpOwogICAgICAgICAgcm5nX3Bvb2xbcm5nX3BwdHIrK10gPSB0ID4+PiA4OwogICAgICAgICAgcm5nX3Bvb2xbcm5nX3BwdHIrK10gPSB0ICYgMjU1OwogICAgICAgIH0KICAgICAgICBybmdfcHB0ciA9IDA7CiAgICAgICAgcm5nX3NlZWRfdGltZSgpOwogICAgICAgIC8vcm5nX3NlZWRfaW50KHdpbmRvdy5zY3JlZW5YKTsKICAgICAgICAvL3JuZ19zZWVkX2ludCh3aW5kb3cuc2NyZWVuWSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm5nX2dldF9ieXRlKCkgewogICAgICAgIGlmIChybmdfc3RhdGUgPT0gbnVsbCkgewogICAgICAgICAgcm5nX3NlZWRfdGltZSgpOwogICAgICAgICAgcm5nX3N0YXRlID0gcHJuZ19uZXdzdGF0ZSgpOwogICAgICAgICAgcm5nX3N0YXRlLmluaXQocm5nX3Bvb2wpOwogICAgICAgICAgZm9yIChybmdfcHB0ciA9IDA7IHJuZ19wcHRyIDwgcm5nX3Bvb2wubGVuZ3RoOyArK3JuZ19wcHRyKSBybmdfcG9vbFtybmdfcHB0cl0gPSAwOwogICAgICAgICAgcm5nX3BwdHIgPSAwOwogICAgICAgICAgLy9ybmdfcG9vbCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIC8vIFRPRE86IGFsbG93IHJlc2VlZGluZyBhZnRlciBmaXJzdCByZXF1ZXN0CiAgICAgICAgcmV0dXJuIHJuZ19zdGF0ZS5uZXh0KCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm5nX2dldF9ieXRlcyhiYSkgewogICAgICAgIHZhciBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYS5sZW5ndGg7ICsraSkgYmFbaV0gPSBybmdfZ2V0X2J5dGUoKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBTZWN1cmVSYW5kb20oKSB7fQogICAgICBTZWN1cmVSYW5kb20ucHJvdG90eXBlLm5leHRCeXRlcyA9IHJuZ19nZXRfYnl0ZXM7CgogICAgICAvLyBwcm5nNC5qcyAtIHVzZXMgQXJjZm91ciBhcyBhIFBSTkcKCiAgICAgIGZ1bmN0aW9uIEFyY2ZvdXIoKSB7CiAgICAgICAgdGhpcy5pID0gMDsKICAgICAgICB0aGlzLmogPSAwOwogICAgICAgIHRoaXMuUyA9IG5ldyBBcnJheSgpOwogICAgICB9CgogICAgICAvLyBJbml0aWFsaXplIGFyY2ZvdXIgY29udGV4dCBmcm9tIGtleSwgYW4gYXJyYXkgb2YgaW50cywgZWFjaCBmcm9tIFswLi4yNTVdCiAgICAgIGZ1bmN0aW9uIEFSQzRpbml0KGtleSkgewogICAgICAgIHZhciBpLCBqLCB0OwogICAgICAgIGZvciAoaSA9IDA7IGkgPCAyNTY7ICsraSkgdGhpcy5TW2ldID0gaTsKICAgICAgICBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICAgICAgICAgIGogPSBqICsgdGhpcy5TW2ldICsga2V5W2kgJSBrZXkubGVuZ3RoXSAmIDI1NTsKICAgICAgICAgIHQgPSB0aGlzLlNbaV07CiAgICAgICAgICB0aGlzLlNbaV0gPSB0aGlzLlNbal07CiAgICAgICAgICB0aGlzLlNbal0gPSB0OwogICAgICAgIH0KICAgICAgICB0aGlzLmkgPSAwOwogICAgICAgIHRoaXMuaiA9IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gQVJDNG5leHQoKSB7CiAgICAgICAgdmFyIHQ7CiAgICAgICAgdGhpcy5pID0gdGhpcy5pICsgMSAmIDI1NTsKICAgICAgICB0aGlzLmogPSB0aGlzLmogKyB0aGlzLlNbdGhpcy5pXSAmIDI1NTsKICAgICAgICB0ID0gdGhpcy5TW3RoaXMuaV07CiAgICAgICAgdGhpcy5TW3RoaXMuaV0gPSB0aGlzLlNbdGhpcy5qXTsKICAgICAgICB0aGlzLlNbdGhpcy5qXSA9IHQ7CiAgICAgICAgcmV0dXJuIHRoaXMuU1t0ICsgdGhpcy5TW3RoaXMuaV0gJiAyNTVdOwogICAgICB9CiAgICAgIEFyY2ZvdXIucHJvdG90eXBlLmluaXQgPSBBUkM0aW5pdDsKICAgICAgQXJjZm91ci5wcm90b3R5cGUubmV4dCA9IEFSQzRuZXh0OwoKICAgICAgLy8gUGx1ZyBpbiB5b3VyIFJORyBjb25zdHJ1Y3RvciBoZXJlCiAgICAgIGZ1bmN0aW9uIHBybmdfbmV3c3RhdGUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBBcmNmb3VyKCk7CiAgICAgIH0KCiAgICAgIC8vIFBvb2wgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNCBhbmQgZ3JlYXRlciB0aGFuIDMyLgogICAgICAvLyBBbiBhcnJheSBvZiBieXRlcyB0aGUgc2l6ZSBvZiB0aGUgcG9vbCB3aWxsIGJlIHBhc3NlZCB0byBpbml0KCkKICAgICAgdmFyIHJuZ19wc2l6ZSA9IDI1NjsKICAgICAgewogICAgICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgICAgZGVmYXVsdDogQmlnSW50ZWdlciwKICAgICAgICAgIEJpZ0ludGVnZXI6IEJpZ0ludGVnZXIsCiAgICAgICAgICBTZWN1cmVSYW5kb206IFNlY3VyZVJhbmRvbQogICAgICAgIH07CiAgICAgIH0KICAgIH0pLmNhbGwoY29tbW9uanNHbG9iYWwpOwogIH0pKGpzYm4pOwogIHJldHVybiBqc2JuLmV4cG9ydHM7Cn0KCnZhciBzcHJpbnRmID0ge307CgovKiBnbG9iYWwgd2luZG93LCBleHBvcnRzLCBkZWZpbmUgKi8KdmFyIGhhc1JlcXVpcmVkU3ByaW50ZjsKZnVuY3Rpb24gcmVxdWlyZVNwcmludGYoKSB7CiAgaWYgKGhhc1JlcXVpcmVkU3ByaW50ZikgcmV0dXJuIHNwcmludGY7CiAgaGFzUmVxdWlyZWRTcHJpbnRmID0gMTsKICAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAgICFmdW5jdGlvbiAoKSB7CgogICAgICB2YXIgcmUgPSB7CiAgICAgICAgbm90X3N0cmluZzogL1tec10vLAogICAgICAgIG5vdF9ib29sOiAvW150XS8sCiAgICAgICAgbm90X3R5cGU6IC9bXlRdLywKICAgICAgICBub3RfcHJpbWl0aXZlOiAvW152XS8sCiAgICAgICAgbnVtYmVyOiAvW2RpZWZnXS8sCiAgICAgICAgbnVtZXJpY19hcmc6IC9bYmNkaWVmZ3V4WF0vLAogICAgICAgIGpzb246IC9bal0vLAogICAgICAgIG5vdF9qc29uOiAvW15qXS8sCiAgICAgICAgdGV4dDogL15bXlx4MjVdKy8sCiAgICAgICAgbW9kdWxvOiAvXlx4MjV7Mn0vLAogICAgICAgIHBsYWNlaG9sZGVyOiAvXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW14pXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZ2lqb3N0VHV2eFhdKS8sCiAgICAgICAga2V5OiAvXihbYS16X11bYS16X1xkXSopL2ksCiAgICAgICAga2V5X2FjY2VzczogL15cLihbYS16X11bYS16X1xkXSopL2ksCiAgICAgICAgaW5kZXhfYWNjZXNzOiAvXlxbKFxkKylcXS8sCiAgICAgICAgc2lnbjogL15bKy1dLwogICAgICB9OwogICAgICBmdW5jdGlvbiBzcHJpbnRmKGtleSkgewogICAgICAgIC8vIGBhcmd1bWVudHNgIGlzIG5vdCBhbiBhcnJheSwgYnV0IHNob3VsZCBiZSBmaW5lIGZvciB0aGlzIGNhbGwKICAgICAgICByZXR1cm4gc3ByaW50Zl9mb3JtYXQoc3ByaW50Zl9wYXJzZShrZXkpLCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHZzcHJpbnRmKGZtdCwgYXJndikgewogICAgICAgIHJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIFtmbXRdLmNvbmNhdChhcmd2IHx8IFtdKSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3ByaW50Zl9mb3JtYXQocGFyc2VfdHJlZSwgYXJndikgewogICAgICAgIHZhciBjdXJzb3IgPSAxLAogICAgICAgICAgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwKICAgICAgICAgIGFyZywKICAgICAgICAgIG91dHB1dCA9ICcnLAogICAgICAgICAgaSwKICAgICAgICAgIGssCiAgICAgICAgICBwaCwKICAgICAgICAgIHBhZCwKICAgICAgICAgIHBhZF9jaGFyYWN0ZXIsCiAgICAgICAgICBwYWRfbGVuZ3RoLAogICAgICAgICAgaXNfcG9zaXRpdmUsCiAgICAgICAgICBzaWduOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhcnNlX3RyZWVbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIG91dHB1dCArPSBwYXJzZV90cmVlW2ldOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGFyc2VfdHJlZVtpXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgcGggPSBwYXJzZV90cmVlW2ldOyAvLyBjb252ZW5pZW5jZSBwdXJwb3NlcyBvbmx5CiAgICAgICAgICAgIGlmIChwaC5rZXlzKSB7CiAgICAgICAgICAgICAgLy8ga2V5d29yZCBhcmd1bWVudAogICAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yXTsKICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgcGgua2V5cy5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgaWYgKGFyZyA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHNwcmludGYoJ1tzcHJpbnRmXSBDYW5ub3QgYWNjZXNzIHByb3BlcnR5ICIlcyIgb2YgdW5kZWZpbmVkIHZhbHVlICIlcyInLCBwaC5rZXlzW2tdLCBwaC5rZXlzW2sgLSAxXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJnID0gYXJnW3BoLmtleXNba11dOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwaC5wYXJhbV9ubykgewogICAgICAgICAgICAgIC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGV4cGxpY2l0KQogICAgICAgICAgICAgIGFyZyA9IGFyZ3ZbcGgucGFyYW1fbm9dOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQogICAgICAgICAgICAgIGFyZyA9IGFyZ3ZbY3Vyc29yKytdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZS5ub3RfdHlwZS50ZXN0KHBoLnR5cGUpICYmIHJlLm5vdF9wcmltaXRpdmUudGVzdChwaC50eXBlKSAmJiBhcmcgaW5zdGFuY2VvZiBGdW5jdGlvbikgewogICAgICAgICAgICAgIGFyZyA9IGFyZygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZS5udW1lcmljX2FyZy50ZXN0KHBoLnR5cGUpICYmIHR5cGVvZiBhcmcgIT09ICdudW1iZXInICYmIGlzTmFOKGFyZykpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKHNwcmludGYoJ1tzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCcsIGFyZykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZS5udW1iZXIudGVzdChwaC50eXBlKSkgewogICAgICAgICAgICAgIGlzX3Bvc2l0aXZlID0gYXJnID49IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoIChwaC50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICBhcmcgPSBwYXJzZUludChhcmcsIDEwKS50b1N0cmluZygyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ2MnOgogICAgICAgICAgICAgICAgYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludChhcmcsIDEwKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdkJzoKICAgICAgICAgICAgICBjYXNlICdpJzoKICAgICAgICAgICAgICAgIGFyZyA9IHBhcnNlSW50KGFyZywgMTApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnaic6CiAgICAgICAgICAgICAgICBhcmcgPSBKU09OLnN0cmluZ2lmeShhcmcsIG51bGwsIHBoLndpZHRoID8gcGFyc2VJbnQocGgud2lkdGgpIDogMCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdlJzoKICAgICAgICAgICAgICAgIGFyZyA9IHBoLnByZWNpc2lvbiA/IHBhcnNlRmxvYXQoYXJnKS50b0V4cG9uZW50aWFsKHBoLnByZWNpc2lvbikgOiBwYXJzZUZsb2F0KGFyZykudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZic6CiAgICAgICAgICAgICAgICBhcmcgPSBwaC5wcmVjaXNpb24gPyBwYXJzZUZsb2F0KGFyZykudG9GaXhlZChwaC5wcmVjaXNpb24pIDogcGFyc2VGbG9hdChhcmcpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnZyc6CiAgICAgICAgICAgICAgICBhcmcgPSBwaC5wcmVjaXNpb24gPyBTdHJpbmcoTnVtYmVyKGFyZy50b1ByZWNpc2lvbihwaC5wcmVjaXNpb24pKSkgOiBwYXJzZUZsb2F0KGFyZyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdvJzoKICAgICAgICAgICAgICAgIGFyZyA9IChwYXJzZUludChhcmcsIDEwKSA+Pj4gMCkudG9TdHJpbmcoOCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICdzJzoKICAgICAgICAgICAgICAgIGFyZyA9IFN0cmluZyhhcmcpOwogICAgICAgICAgICAgICAgYXJnID0gcGgucHJlY2lzaW9uID8gYXJnLnN1YnN0cmluZygwLCBwaC5wcmVjaXNpb24pIDogYXJnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAndCc6CiAgICAgICAgICAgICAgICBhcmcgPSBTdHJpbmcoISFhcmcpOwogICAgICAgICAgICAgICAgYXJnID0gcGgucHJlY2lzaW9uID8gYXJnLnN1YnN0cmluZygwLCBwaC5wcmVjaXNpb24pIDogYXJnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnVCc6CiAgICAgICAgICAgICAgICBhcmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIGFyZyA9IHBoLnByZWNpc2lvbiA/IGFyZy5zdWJzdHJpbmcoMCwgcGgucHJlY2lzaW9uKSA6IGFyZzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ3UnOgogICAgICAgICAgICAgICAgYXJnID0gcGFyc2VJbnQoYXJnLCAxMCkgPj4+IDA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICd2JzoKICAgICAgICAgICAgICAgIGFyZyA9IGFyZy52YWx1ZU9mKCk7CiAgICAgICAgICAgICAgICBhcmcgPSBwaC5wcmVjaXNpb24gPyBhcmcuc3Vic3RyaW5nKDAsIHBoLnByZWNpc2lvbikgOiBhcmc7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICd4JzoKICAgICAgICAgICAgICAgIGFyZyA9IChwYXJzZUludChhcmcsIDEwKSA+Pj4gMCkudG9TdHJpbmcoMTYpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnWCc6CiAgICAgICAgICAgICAgICBhcmcgPSAocGFyc2VJbnQoYXJnLCAxMCkgPj4+IDApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlLmpzb24udGVzdChwaC50eXBlKSkgewogICAgICAgICAgICAgIG91dHB1dCArPSBhcmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHJlLm51bWJlci50ZXN0KHBoLnR5cGUpICYmICghaXNfcG9zaXRpdmUgfHwgcGguc2lnbikpIHsKICAgICAgICAgICAgICAgIHNpZ24gPSBpc19wb3NpdGl2ZSA/ICcrJyA6ICctJzsKICAgICAgICAgICAgICAgIGFyZyA9IGFyZy50b1N0cmluZygpLnJlcGxhY2UocmUuc2lnbiwgJycpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaWduID0gJyc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhZF9jaGFyYWN0ZXIgPSBwaC5wYWRfY2hhciA/IHBoLnBhZF9jaGFyID09PSAnMCcgPyAnMCcgOiBwaC5wYWRfY2hhci5jaGFyQXQoMSkgOiAnICc7CiAgICAgICAgICAgICAgcGFkX2xlbmd0aCA9IHBoLndpZHRoIC0gKHNpZ24gKyBhcmcpLmxlbmd0aDsKICAgICAgICAgICAgICBwYWQgPSBwaC53aWR0aCA/IHBhZF9sZW5ndGggPiAwID8gcGFkX2NoYXJhY3Rlci5yZXBlYXQocGFkX2xlbmd0aCkgOiAnJyA6ICcnOwogICAgICAgICAgICAgIG91dHB1dCArPSBwaC5hbGlnbiA/IHNpZ24gKyBhcmcgKyBwYWQgOiBwYWRfY2hhcmFjdGVyID09PSAnMCcgPyBzaWduICsgcGFkICsgYXJnIDogcGFkICsgc2lnbiArIGFyZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9CiAgICAgIHZhciBzcHJpbnRmX2NhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgZnVuY3Rpb24gc3ByaW50Zl9wYXJzZShmbXQpIHsKICAgICAgICBpZiAoc3ByaW50Zl9jYWNoZVtmbXRdKSB7CiAgICAgICAgICByZXR1cm4gc3ByaW50Zl9jYWNoZVtmbXRdOwogICAgICAgIH0KICAgICAgICB2YXIgX2ZtdCA9IGZtdCwKICAgICAgICAgIG1hdGNoLAogICAgICAgICAgcGFyc2VfdHJlZSA9IFtdLAogICAgICAgICAgYXJnX25hbWVzID0gMDsKICAgICAgICB3aGlsZSAoX2ZtdCkgewogICAgICAgICAgaWYgKChtYXRjaCA9IHJlLnRleHQuZXhlYyhfZm10KSkgIT09IG51bGwpIHsKICAgICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKICAgICAgICAgIH0gZWxzZSBpZiAoKG1hdGNoID0gcmUubW9kdWxvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBhcnNlX3RyZWUucHVzaCgnJScpOwogICAgICAgICAgfSBlbHNlIGlmICgobWF0Y2ggPSByZS5wbGFjZWhvbGRlci5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobWF0Y2hbMl0pIHsKICAgICAgICAgICAgICBhcmdfbmFtZXMgfD0gMTsKICAgICAgICAgICAgICB2YXIgZmllbGRfbGlzdCA9IFtdLAogICAgICAgICAgICAgICAgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwKICAgICAgICAgICAgICAgIGZpZWxkX21hdGNoID0gW107CiAgICAgICAgICAgICAgaWYgKChmaWVsZF9tYXRjaCA9IHJlLmtleS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CiAgICAgICAgICAgICAgICB3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewogICAgICAgICAgICAgICAgICBpZiAoKGZpZWxkX21hdGNoID0gcmUua2V5X2FjY2Vzcy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmaWVsZF9tYXRjaCA9IHJlLmluZGV4X2FjY2Vzcy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXknKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ1tzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Jyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hdGNoWzJdID0gZmllbGRfbGlzdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcmdfbmFtZXMgfD0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXJnX25hbWVzID09PSAzKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyc2VfdHJlZS5wdXNoKHsKICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogbWF0Y2hbMF0sCiAgICAgICAgICAgICAgcGFyYW1fbm86IG1hdGNoWzFdLAogICAgICAgICAgICAgIGtleXM6IG1hdGNoWzJdLAogICAgICAgICAgICAgIHNpZ246IG1hdGNoWzNdLAogICAgICAgICAgICAgIHBhZF9jaGFyOiBtYXRjaFs0XSwKICAgICAgICAgICAgICBhbGlnbjogbWF0Y2hbNV0sCiAgICAgICAgICAgICAgd2lkdGg6IG1hdGNoWzZdLAogICAgICAgICAgICAgIHByZWNpc2lvbjogbWF0Y2hbN10sCiAgICAgICAgICAgICAgdHlwZTogbWF0Y2hbOF0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ1tzcHJpbnRmXSB1bmV4cGVjdGVkIHBsYWNlaG9sZGVyJyk7CiAgICAgICAgICB9CiAgICAgICAgICBfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNwcmludGZfY2FjaGVbZm10XSA9IHBhcnNlX3RyZWU7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBleHBvcnQgdG8gZWl0aGVyIGJyb3dzZXIgb3Igbm9kZS5qcwogICAgICAgKi8KICAgICAgLyogZXNsaW50LWRpc2FibGUgcXVvdGUtcHJvcHMgKi8KICAgICAgewogICAgICAgIGV4cG9ydHNbJ3NwcmludGYnXSA9IHNwcmludGY7CiAgICAgICAgZXhwb3J0c1sndnNwcmludGYnXSA9IHZzcHJpbnRmOwogICAgICB9CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHdpbmRvd1snc3ByaW50ZiddID0gc3ByaW50ZjsKICAgICAgICB3aW5kb3dbJ3ZzcHJpbnRmJ10gPSB2c3ByaW50ZjsKICAgICAgfQogICAgICAvKiBlc2xpbnQtZW5hYmxlIHF1b3RlLXByb3BzICovCiAgICB9KCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgCiAgfSkoc3ByaW50Zik7CiAgcmV0dXJuIHNwcmludGY7Cn0KCnZhciBoYXNSZXF1aXJlZElwdjQ7CmZ1bmN0aW9uIHJlcXVpcmVJcHY0KCkgewogIGlmIChoYXNSZXF1aXJlZElwdjQpIHJldHVybiBpcHY0OwogIGhhc1JlcXVpcmVkSXB2NCA9IDE7CiAgLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi8KICB2YXIgX19jcmVhdGVCaW5kaW5nID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogICAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICAgIGRlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7CiAgfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIG9bazJdID0gbVtrXTsKICB9KTsKICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHYKICAgIH0pOwogIH0gOiBmdW5jdGlvbiAobywgdikgewogICAgb1siZGVmYXVsdCJdID0gdjsKICB9KTsKICB2YXIgX19pbXBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBpZiAobW9kICE9IG51bGwpIGZvciAodmFyIGsgaW4gbW9kKSBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtb2QsIGspKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogICAgX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaXB2NCwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGlwdjQuQWRkcmVzczQgPSB2b2lkIDA7CiAgY29uc3QgY29tbW9uID0gX19pbXBvcnRTdGFyKHJlcXVpcmVDb21tb24oKSk7CiAgY29uc3QgY29uc3RhbnRzID0gX19pbXBvcnRTdGFyKHJlcXVpcmVDb25zdGFudHMkMSgpKTsKICBjb25zdCBhZGRyZXNzX2Vycm9yXzEgPSByZXF1aXJlQWRkcmVzc0Vycm9yKCk7CiAgY29uc3QganNibl8xID0gcmVxdWlyZUpzYm4oKTsKICBjb25zdCBzcHJpbnRmX2pzXzEgPSByZXF1aXJlU3ByaW50ZigpOwogIC8qKgogICAqIFJlcHJlc2VudHMgYW4gSVB2NCBhZGRyZXNzCiAgICogQGNsYXNzIEFkZHJlc3M0CiAgICogQHBhcmFtIHtzdHJpbmd9IGFkZHJlc3MgLSBBbiBJUHY0IGFkZHJlc3Mgc3RyaW5nCiAgICovCiAgY2xhc3MgQWRkcmVzczQgewogICAgY29uc3RydWN0b3IoYWRkcmVzcykgewogICAgICB0aGlzLmdyb3VwcyA9IGNvbnN0YW50cy5HUk9VUFM7CiAgICAgIHRoaXMucGFyc2VkQWRkcmVzcyA9IFtdOwogICAgICB0aGlzLnBhcnNlZFN1Ym5ldCA9ICcnOwogICAgICB0aGlzLnN1Ym5ldCA9ICcvMzInOwogICAgICB0aGlzLnN1Ym5ldE1hc2sgPSAzMjsKICAgICAgdGhpcy52NCA9IHRydWU7CiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGFkZHJlc3MgaXMgY29ycmVjdCwgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNAogICAgICAgKiBAaW5zdGFuY2UKICAgICAgICogQHJldHVybnMge0Jvb2xlYW59CiAgICAgICAqLwogICAgICB0aGlzLmlzQ29ycmVjdCA9IGNvbW1vbi5pc0NvcnJlY3QoY29uc3RhbnRzLkJJVFMpOwogICAgICAvKioKICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBhZGRyZXNzIGlzIGluIHRoZSBzdWJuZXQgb2YgdGhlIGN1cnJlbnQgYWRkcmVzcwogICAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAgICogQGluc3RhbmNlCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICAgKi8KICAgICAgdGhpcy5pc0luU3VibmV0ID0gY29tbW9uLmlzSW5TdWJuZXQ7CiAgICAgIHRoaXMuYWRkcmVzcyA9IGFkZHJlc3M7CiAgICAgIGNvbnN0IHN1Ym5ldCA9IGNvbnN0YW50cy5SRV9TVUJORVRfU1RSSU5HLmV4ZWMoYWRkcmVzcyk7CiAgICAgIGlmIChzdWJuZXQpIHsKICAgICAgICB0aGlzLnBhcnNlZFN1Ym5ldCA9IHN1Ym5ldFswXS5yZXBsYWNlKCcvJywgJycpOwogICAgICAgIHRoaXMuc3VibmV0TWFzayA9IHBhcnNlSW50KHRoaXMucGFyc2VkU3VibmV0LCAxMCk7CiAgICAgICAgdGhpcy5zdWJuZXQgPSBgLyR7dGhpcy5zdWJuZXRNYXNrfWA7CiAgICAgICAgaWYgKHRoaXMuc3VibmV0TWFzayA8IDAgfHwgdGhpcy5zdWJuZXRNYXNrID4gY29uc3RhbnRzLkJJVFMpIHsKICAgICAgICAgIHRocm93IG5ldyBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yKCdJbnZhbGlkIHN1Ym5ldCBtYXNrLicpOwogICAgICAgIH0KICAgICAgICBhZGRyZXNzID0gYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50cy5SRV9TVUJORVRfU1RSSU5HLCAnJyk7CiAgICAgIH0KICAgICAgdGhpcy5hZGRyZXNzTWludXNTdWZmaXggPSBhZGRyZXNzOwogICAgICB0aGlzLnBhcnNlZEFkZHJlc3MgPSB0aGlzLnBhcnNlKGFkZHJlc3MpOwogICAgfQogICAgc3RhdGljIGlzVmFsaWQoYWRkcmVzcykgewogICAgICB0cnkgewogICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1uZXcKICAgICAgICBuZXcgQWRkcmVzczQoYWRkcmVzcyk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIC8qCiAgICAgKiBQYXJzZXMgYSB2NCBhZGRyZXNzCiAgICAgKi8KICAgIHBhcnNlKGFkZHJlc3MpIHsKICAgICAgY29uc3QgZ3JvdXBzID0gYWRkcmVzcy5zcGxpdCgnLicpOwogICAgICBpZiAoIWFkZHJlc3MubWF0Y2goY29uc3RhbnRzLlJFX0FERFJFU1MpKSB7CiAgICAgICAgdGhyb3cgbmV3IGFkZHJlc3NfZXJyb3JfMS5BZGRyZXNzRXJyb3IoJ0ludmFsaWQgSVB2NCBhZGRyZXNzLicpOwogICAgICB9CiAgICAgIHJldHVybiBncm91cHM7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGNvcnJlY3QgZm9ybSBvZiBhbiBhZGRyZXNzCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgY29ycmVjdEZvcm0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcnNlZEFkZHJlc3MubWFwKHBhcnQgPT4gcGFyc2VJbnQocGFydCwgMTApKS5qb2luKCcuJyk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgaGV4IHN0cmluZyB0byBhbiBJUHY0IGFkZHJlc3Mgb2JqZWN0CiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBzdGF0aWMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoZXggLSBhIGhleCBzdHJpbmcgdG8gY29udmVydAogICAgICogQHJldHVybnMge0FkZHJlc3M0fQogICAgICovCiAgICBzdGF0aWMgZnJvbUhleChoZXgpIHsKICAgICAgY29uc3QgcGFkZGVkID0gaGV4LnJlcGxhY2UoLzovZywgJycpLnBhZFN0YXJ0KDgsICcwJyk7CiAgICAgIGNvbnN0IGdyb3VwcyA9IFtdOwogICAgICBsZXQgaTsKICAgICAgZm9yIChpID0gMDsgaSA8IDg7IGkgKz0gMikgewogICAgICAgIGNvbnN0IGggPSBwYWRkZWQuc2xpY2UoaSwgaSArIDIpOwogICAgICAgIGdyb3Vwcy5wdXNoKHBhcnNlSW50KGgsIDE2KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBBZGRyZXNzNChncm91cHMuam9pbignLicpKTsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydHMgYW4gaW50ZWdlciBpbnRvIGEgSVB2NCBhZGRyZXNzIG9iamVjdAogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAc3RhdGljCiAgICAgKiBAcGFyYW0ge2ludGVnZXJ9IGludGVnZXIgLSBhIG51bWJlciB0byBjb252ZXJ0CiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczR9CiAgICAgKi8KICAgIHN0YXRpYyBmcm9tSW50ZWdlcihpbnRlZ2VyKSB7CiAgICAgIHJldHVybiBBZGRyZXNzNC5mcm9tSGV4KGludGVnZXIudG9TdHJpbmcoMTYpKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIGFuIGFkZHJlc3MgZnJvbSBpbi1hZGRyLmFycGEgZm9ybQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAc3RhdGljCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXJwYUZvcm1BZGRyZXNzIC0gYW4gJ2luLWFkZHIuYXJwYScgZm9ybSBpcHY0IGFkZHJlc3MKICAgICAqIEByZXR1cm5zIHtBZHJlc3M0fQogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBhZGRyZXNzID0gQWRkcmVzczQuZnJvbUFycGEoNDIuMi4wLjE5Mi5pbi1hZGRyLmFycGEuKQogICAgICogYWRkcmVzcy5jb3JyZWN0Rm9ybSgpOyAvLyAnMTkyLjAuMi40MicKICAgICAqLwogICAgc3RhdGljIGZyb21BcnBhKGFycGFGb3JtQWRkcmVzcykgewogICAgICAvLyByZW1vdmUgZW5kaW5nICIuaW4tYWRkci5hcnBhLiIgb3IganVzdCAiLiIKICAgICAgY29uc3QgbGVhZGVyID0gYXJwYUZvcm1BZGRyZXNzLnJlcGxhY2UoLyhcLmluLWFkZHJcLmFycGEpP1wuJC8sICcnKTsKICAgICAgY29uc3QgYWRkcmVzcyA9IGxlYWRlci5zcGxpdCgnLicpLnJldmVyc2UoKS5qb2luKCcuJyk7CiAgICAgIHJldHVybiBuZXcgQWRkcmVzczQoYWRkcmVzcyk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIGFuIElQdjQgYWRkcmVzcyBvYmplY3QgdG8gYSBoZXggc3RyaW5nCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgdG9IZXgoKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcnNlZEFkZHJlc3MubWFwKHBhcnQgPT4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnJTAyeCcsIHBhcnNlSW50KHBhcnQsIDEwKSkpLmpvaW4oJzonKTsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydHMgYW4gSVB2NCBhZGRyZXNzIG9iamVjdCB0byBhbiBhcnJheSBvZiBieXRlcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBcnJheX0KICAgICAqLwogICAgdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGFyc2VkQWRkcmVzcy5tYXAocGFydCA9PiBwYXJzZUludChwYXJ0LCAxMCkpOwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhbiBJUHY0IGFkZHJlc3Mgb2JqZWN0IHRvIGFuIElQdjYgYWRkcmVzcyBncm91cAogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHRvR3JvdXA2KCkgewogICAgICBjb25zdCBvdXRwdXQgPSBbXTsKICAgICAgbGV0IGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBjb25zdGFudHMuR1JPVVBTOyBpICs9IDIpIHsKICAgICAgICBjb25zdCBoZXggPSAoMCwgc3ByaW50Zl9qc18xLnNwcmludGYpKCclMDJ4JTAyeCcsIHBhcnNlSW50KHRoaXMucGFyc2VkQWRkcmVzc1tpXSwgMTApLCBwYXJzZUludCh0aGlzLnBhcnNlZEFkZHJlc3NbaSArIDFdLCAxMCkpOwogICAgICAgIG91dHB1dC5wdXNoKCgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyV4JywgcGFyc2VJbnQoaGV4LCAxNikpKTsKICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0LmpvaW4oJzonKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgYWRkcmVzcyBhcyBhIEJpZ0ludGVnZXIKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNAogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QmlnSW50ZWdlcn0KICAgICAqLwogICAgYmlnSW50ZWdlcigpIHsKICAgICAgcmV0dXJuIG5ldyBqc2JuXzEuQmlnSW50ZWdlcih0aGlzLnBhcnNlZEFkZHJlc3MubWFwKG4gPT4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnJTAyeCcsIHBhcnNlSW50KG4sIDEwKSkpLmpvaW4oJycpLCAxNik7CiAgICB9CiAgICAvKioKICAgICAqIEhlbHBlciBmdW5jdGlvbiBnZXR0aW5nIHN0YXJ0IGFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0JpZ0ludGVnZXJ9CiAgICAgKi8KICAgIF9zdGFydEFkZHJlc3MoKSB7CiAgICAgIHJldHVybiBuZXcganNibl8xLkJpZ0ludGVnZXIodGhpcy5tYXNrKCkgKyAnMCcucmVwZWF0KGNvbnN0YW50cy5CSVRTIC0gdGhpcy5zdWJuZXRNYXNrKSwgMik7CiAgICB9CiAgICAvKioKICAgICAqIFRoZSBmaXJzdCBhZGRyZXNzIGluIHRoZSByYW5nZSBnaXZlbiBieSB0aGlzIGFkZHJlc3MnIHN1Ym5ldC4KICAgICAqIE9mdGVuIHJlZmVycmVkIHRvIGFzIHRoZSBOZXR3b3JrIEFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0FkZHJlc3M0fQogICAgICovCiAgICBzdGFydEFkZHJlc3MoKSB7CiAgICAgIHJldHVybiBBZGRyZXNzNC5mcm9tQmlnSW50ZWdlcih0aGlzLl9zdGFydEFkZHJlc3MoKSk7CiAgICB9CiAgICAvKioKICAgICAqIFRoZSBmaXJzdCBob3N0IGFkZHJlc3MgaW4gdGhlIHJhbmdlIGdpdmVuIGJ5IHRoaXMgYWRkcmVzcydzIHN1Ym5ldCBpZQogICAgICogdGhlIGZpcnN0IGFkZHJlc3MgYWZ0ZXIgdGhlIE5ldHdvcmsgQWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBZGRyZXNzNH0KICAgICAqLwogICAgc3RhcnRBZGRyZXNzRXhjbHVzaXZlKCkgewogICAgICBjb25zdCBhZGp1c3QgPSBuZXcganNibl8xLkJpZ0ludGVnZXIoJzEnKTsKICAgICAgcmV0dXJuIEFkZHJlc3M0LmZyb21CaWdJbnRlZ2VyKHRoaXMuX3N0YXJ0QWRkcmVzcygpLmFkZChhZGp1c3QpKTsKICAgIH0KICAgIC8qKgogICAgICogSGVscGVyIGZ1bmN0aW9uIGdldHRpbmcgZW5kIGFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0JpZ0ludGVnZXJ9CiAgICAgKi8KICAgIF9lbmRBZGRyZXNzKCkgewogICAgICByZXR1cm4gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKHRoaXMubWFzaygpICsgJzEnLnJlcGVhdChjb25zdGFudHMuQklUUyAtIHRoaXMuc3VibmV0TWFzayksIDIpOwogICAgfQogICAgLyoqCiAgICAgKiBUaGUgbGFzdCBhZGRyZXNzIGluIHRoZSByYW5nZSBnaXZlbiBieSB0aGlzIGFkZHJlc3MnIHN1Ym5ldAogICAgICogT2Z0ZW4gcmVmZXJyZWQgdG8gYXMgdGhlIEJyb2FkY2FzdAogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBZGRyZXNzNH0KICAgICAqLwogICAgZW5kQWRkcmVzcygpIHsKICAgICAgcmV0dXJuIEFkZHJlc3M0LmZyb21CaWdJbnRlZ2VyKHRoaXMuX2VuZEFkZHJlc3MoKSk7CiAgICB9CiAgICAvKioKICAgICAqIFRoZSBsYXN0IGhvc3QgYWRkcmVzcyBpbiB0aGUgcmFuZ2UgZ2l2ZW4gYnkgdGhpcyBhZGRyZXNzJ3Mgc3VibmV0IGllCiAgICAgKiB0aGUgbGFzdCBhZGRyZXNzIHByaW9yIHRvIHRoZSBCcm9hZGNhc3QgQWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M0CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBZGRyZXNzNH0KICAgICAqLwogICAgZW5kQWRkcmVzc0V4Y2x1c2l2ZSgpIHsKICAgICAgY29uc3QgYWRqdXN0ID0gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKCcxJyk7CiAgICAgIHJldHVybiBBZGRyZXNzNC5mcm9tQmlnSW50ZWdlcih0aGlzLl9lbmRBZGRyZXNzKCkuc3VidHJhY3QoYWRqdXN0KSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgQmlnSW50ZWdlciB0byBhIHY0IGFkZHJlc3Mgb2JqZWN0CiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBzdGF0aWMKICAgICAqIEBwYXJhbSB7QmlnSW50ZWdlcn0gYmlnSW50ZWdlciAtIGEgQmlnSW50ZWdlciB0byBjb252ZXJ0CiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczR9CiAgICAgKi8KICAgIHN0YXRpYyBmcm9tQmlnSW50ZWdlcihiaWdJbnRlZ2VyKSB7CiAgICAgIHJldHVybiBBZGRyZXNzNC5mcm9tSW50ZWdlcihwYXJzZUludChiaWdJbnRlZ2VyLnRvU3RyaW5nKCksIDEwKSk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIGZpcnN0IG4gYml0cyBvZiB0aGUgYWRkcmVzcywgZGVmYXVsdGluZyB0byB0aGUKICAgICAqIHN1Ym5ldCBtYXNrCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgbWFzayhtYXNrKSB7CiAgICAgIGlmIChtYXNrID09PSB1bmRlZmluZWQpIHsKICAgICAgICBtYXNrID0gdGhpcy5zdWJuZXRNYXNrOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmdldEJpdHNCYXNlMigwLCBtYXNrKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgYml0cyBpbiB0aGUgZ2l2ZW4gcmFuZ2UgYXMgYSBiYXNlLTIgc3RyaW5nCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczQKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge3N0cmluZ30KICAgICAqLwogICAgZ2V0Qml0c0Jhc2UyKHN0YXJ0LCBlbmQpIHsKICAgICAgcmV0dXJuIHRoaXMuYmluYXJ5WmVyb1BhZCgpLnNsaWNlKHN0YXJ0LCBlbmQpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHJldmVyc2VkIGlwNi5hcnBhIGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNAogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5vbWl0U3VmZml4IC0gb21pdCB0aGUgImluLWFkZHIuYXJwYSIgc3VmZml4CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIHJldmVyc2VGb3JtKG9wdGlvbnMpIHsKICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CiAgICAgIGNvbnN0IHJldmVyc2VkID0gdGhpcy5jb3JyZWN0Rm9ybSgpLnNwbGl0KCcuJykucmV2ZXJzZSgpLmpvaW4oJy4nKTsKICAgICAgaWYgKG9wdGlvbnMub21pdFN1ZmZpeCkgewogICAgICAgIHJldHVybiByZXZlcnNlZDsKICAgICAgfQogICAgICByZXR1cm4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnJXMuaW4tYWRkci5hcnBhLicsIHJldmVyc2VkKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBhZGRyZXNzIGlzIGEgbXVsdGljYXN0IGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNAogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgICAqLwogICAgaXNNdWx0aWNhc3QoKSB7CiAgICAgIHJldHVybiB0aGlzLmlzSW5TdWJuZXQobmV3IEFkZHJlc3M0KCcyMjQuMC4wLjAvNCcpKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyBhIHplcm8tcGFkZGVkIGJhc2UtMiBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNAogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAgICovCiAgICBiaW5hcnlaZXJvUGFkKCkgewogICAgICByZXR1cm4gdGhpcy5iaWdJbnRlZ2VyKCkudG9TdHJpbmcoMikucGFkU3RhcnQoY29uc3RhbnRzLkJJVFMsICcwJyk7CiAgICB9CiAgICAvKioKICAgICAqIEdyb3VwcyBhbiBJUHY0IGFkZHJlc3MgZm9yIGluY2x1c2lvbiBhdCB0aGUgZW5kIG9mIGFuIElQdjYgYWRkcmVzcwogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgZ3JvdXBGb3JWNigpIHsKICAgICAgY29uc3Qgc2VnbWVudHMgPSB0aGlzLnBhcnNlZEFkZHJlc3M7CiAgICAgIHJldHVybiB0aGlzLmFkZHJlc3MucmVwbGFjZShjb25zdGFudHMuUkVfQUREUkVTUywgKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnPHNwYW4gY2xhc3M9ImhvdmVyLWdyb3VwIGdyb3VwLXY0IGdyb3VwLTYiPiVzPC9zcGFuPi48c3BhbiBjbGFzcz0iaG92ZXItZ3JvdXAgZ3JvdXAtdjQgZ3JvdXAtNyI+JXM8L3NwYW4+Jywgc2VnbWVudHMuc2xpY2UoMCwgMikuam9pbignLicpLCBzZWdtZW50cy5zbGljZSgyLCA0KS5qb2luKCcuJykpKTsKICAgIH0KICB9CiAgaXB2NC5BZGRyZXNzNCA9IEFkZHJlc3M0OwogIHJldHVybiBpcHY0Owp9Cgp2YXIgaXB2NiA9IHt9OwoKdmFyIGNvbnN0YW50cyA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkQ29uc3RhbnRzOwpmdW5jdGlvbiByZXF1aXJlQ29uc3RhbnRzKCkgewogIGlmIChoYXNSZXF1aXJlZENvbnN0YW50cykgcmV0dXJuIGNvbnN0YW50czsKICBoYXNSZXF1aXJlZENvbnN0YW50cyA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGNvbnN0YW50cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGNvbnN0YW50cy5SRV9VUkxfV0lUSF9QT1JUID0gY29uc3RhbnRzLlJFX1VSTCA9IGNvbnN0YW50cy5SRV9aT05FX1NUUklORyA9IGNvbnN0YW50cy5SRV9TVUJORVRfU1RSSU5HID0gY29uc3RhbnRzLlJFX0JBRF9BRERSRVNTID0gY29uc3RhbnRzLlJFX0JBRF9DSEFSQUNURVJTID0gY29uc3RhbnRzLlRZUEVTID0gY29uc3RhbnRzLlNDT1BFUyA9IGNvbnN0YW50cy5HUk9VUFMgPSBjb25zdGFudHMuQklUUyA9IHZvaWQgMDsKICBjb25zdGFudHMuQklUUyA9IDEyODsKICBjb25zdGFudHMuR1JPVVBTID0gODsKICAvKioKICAgKiBSZXByZXNlbnRzIElQdjYgYWRkcmVzcyBzY29wZXMKICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgKiBAc3RhdGljCiAgICovCiAgY29uc3RhbnRzLlNDT1BFUyA9IHsKICAgIDA6ICdSZXNlcnZlZCcsCiAgICAxOiAnSW50ZXJmYWNlIGxvY2FsJywKICAgIDI6ICdMaW5rIGxvY2FsJywKICAgIDQ6ICdBZG1pbiBsb2NhbCcsCiAgICA1OiAnU2l0ZSBsb2NhbCcsCiAgICA4OiAnT3JnYW5pemF0aW9uIGxvY2FsJywKICAgIDE0OiAnR2xvYmFsJywKICAgIDE1OiAnUmVzZXJ2ZWQnCiAgfTsKICAvKioKICAgKiBSZXByZXNlbnRzIElQdjYgYWRkcmVzcyB0eXBlcwogICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAqIEBzdGF0aWMKICAgKi8KICBjb25zdGFudHMuVFlQRVMgPSB7CiAgICAnZmYwMTo6MS8xMjgnOiAnTXVsdGljYXN0IChBbGwgbm9kZXMgb24gdGhpcyBpbnRlcmZhY2UpJywKICAgICdmZjAxOjoyLzEyOCc6ICdNdWx0aWNhc3QgKEFsbCByb3V0ZXJzIG9uIHRoaXMgaW50ZXJmYWNlKScsCiAgICAnZmYwMjo6MS8xMjgnOiAnTXVsdGljYXN0IChBbGwgbm9kZXMgb24gdGhpcyBsaW5rKScsCiAgICAnZmYwMjo6Mi8xMjgnOiAnTXVsdGljYXN0IChBbGwgcm91dGVycyBvbiB0aGlzIGxpbmspJywKICAgICdmZjA1OjoyLzEyOCc6ICdNdWx0aWNhc3QgKEFsbCByb3V0ZXJzIGluIHRoaXMgc2l0ZSknLAogICAgJ2ZmMDI6OjUvMTI4JzogJ011bHRpY2FzdCAoT1NQRnYzIEFsbFNQRiByb3V0ZXJzKScsCiAgICAnZmYwMjo6Ni8xMjgnOiAnTXVsdGljYXN0IChPU1BGdjMgQWxsRFIgcm91dGVycyknLAogICAgJ2ZmMDI6OjkvMTI4JzogJ011bHRpY2FzdCAoUklQIHJvdXRlcnMpJywKICAgICdmZjAyOjphLzEyOCc6ICdNdWx0aWNhc3QgKEVJR1JQIHJvdXRlcnMpJywKICAgICdmZjAyOjpkLzEyOCc6ICdNdWx0aWNhc3QgKFBJTSByb3V0ZXJzKScsCiAgICAnZmYwMjo6MTYvMTI4JzogJ011bHRpY2FzdCAoTUxEdjIgcmVwb3J0cyknLAogICAgJ2ZmMDE6OmZiLzEyOCc6ICdNdWx0aWNhc3QgKG1ETlN2NiknLAogICAgJ2ZmMDI6OmZiLzEyOCc6ICdNdWx0aWNhc3QgKG1ETlN2NiknLAogICAgJ2ZmMDU6OmZiLzEyOCc6ICdNdWx0aWNhc3QgKG1ETlN2NiknLAogICAgJ2ZmMDI6OjE6Mi8xMjgnOiAnTXVsdGljYXN0IChBbGwgREhDUCBzZXJ2ZXJzIGFuZCByZWxheSBhZ2VudHMgb24gdGhpcyBsaW5rKScsCiAgICAnZmYwNTo6MToyLzEyOCc6ICdNdWx0aWNhc3QgKEFsbCBESENQIHNlcnZlcnMgYW5kIHJlbGF5IGFnZW50cyBpbiB0aGlzIHNpdGUpJywKICAgICdmZjAyOjoxOjMvMTI4JzogJ011bHRpY2FzdCAoQWxsIERIQ1Agc2VydmVycyBvbiB0aGlzIGxpbmspJywKICAgICdmZjA1OjoxOjMvMTI4JzogJ011bHRpY2FzdCAoQWxsIERIQ1Agc2VydmVycyBpbiB0aGlzIHNpdGUpJywKICAgICc6Oi8xMjgnOiAnVW5zcGVjaWZpZWQnLAogICAgJzo6MS8xMjgnOiAnTG9vcGJhY2snLAogICAgJ2ZmMDA6Oi84JzogJ011bHRpY2FzdCcsCiAgICAnZmU4MDo6LzEwJzogJ0xpbmstbG9jYWwgdW5pY2FzdCcKICB9OwogIC8qKgogICAqIEEgcmVndWxhciBleHByZXNzaW9uIHRoYXQgbWF0Y2hlcyBiYWQgY2hhcmFjdGVycyBpbiBhbiBJUHY2IGFkZHJlc3MKICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgKiBAc3RhdGljCiAgICovCiAgY29uc3RhbnRzLlJFX0JBRF9DSEFSQUNURVJTID0gLyhbXjAtOWEtZjovJV0pL2dpOwogIC8qKgogICAqIEEgcmVndWxhciBleHByZXNzaW9uIHRoYXQgbWF0Y2hlcyBhbiBpbmNvcnJlY3QgSVB2NiBhZGRyZXNzCiAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICogQHN0YXRpYwogICAqLwogIGNvbnN0YW50cy5SRV9CQURfQUREUkVTUyA9IC8oWzAtOWEtZl17NSx9fDp7Myx9fFteOl06JHxeOlteOl18XC8kKS9naTsKICAvKioKICAgKiBBIHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IG1hdGNoZXMgYW4gSVB2NiBzdWJuZXQKICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgKiBAc3RhdGljCiAgICovCiAgY29uc3RhbnRzLlJFX1NVQk5FVF9TVFJJTkcgPSAvXC9cZHsxLDN9KD89JXwkKS87CiAgLyoqCiAgICogQSByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBtYXRjaGVzIGFuIElQdjYgem9uZQogICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAqIEBzdGF0aWMKICAgKi8KICBjb25zdGFudHMuUkVfWk9ORV9TVFJJTkcgPSAvJS4qJC87CiAgY29uc3RhbnRzLlJFX1VSTCA9IG5ldyBSZWdFeHAoL15cW3swLDF9KFswLTlhLWY6XSspXF17MCwxfS8pOwogIGNvbnN0YW50cy5SRV9VUkxfV0lUSF9QT1JUID0gbmV3IFJlZ0V4cCgvXFsoWzAtOWEtZjpdKylcXTooWzAtOV17MSw1fSkvKTsKICByZXR1cm4gY29uc3RhbnRzOwp9Cgp2YXIgaGVscGVycyA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkSGVscGVycyQxOwpmdW5jdGlvbiByZXF1aXJlSGVscGVycyQxKCkgewogIGlmIChoYXNSZXF1aXJlZEhlbHBlcnMkMSkgcmV0dXJuIGhlbHBlcnM7CiAgaGFzUmVxdWlyZWRIZWxwZXJzJDEgPSAxOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShoZWxwZXJzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgaGVscGVycy5zaW1wbGVHcm91cCA9IGhlbHBlcnMuc3BhbkxlYWRpbmdaZXJvZXMgPSBoZWxwZXJzLnNwYW5BbGwgPSBoZWxwZXJzLnNwYW5BbGxaZXJvZXMgPSB2b2lkIDA7CiAgY29uc3Qgc3ByaW50Zl9qc18xID0gcmVxdWlyZVNwcmludGYoKTsKICAvKioKICAgKiBAcmV0dXJucyB7U3RyaW5nfSB0aGUgc3RyaW5nIHdpdGggYWxsIHplcm9lcyBjb250YWluZWQgaW4gYSA8c3Bhbj4KICAgKi8KICBmdW5jdGlvbiBzcGFuQWxsWmVyb2VzKHMpIHsKICAgIHJldHVybiBzLnJlcGxhY2UoLygwKykvZywgJzxzcGFuIGNsYXNzPSJ6ZXJvIj4kMTwvc3Bhbj4nKTsKICB9CiAgaGVscGVycy5zcGFuQWxsWmVyb2VzID0gc3BhbkFsbFplcm9lczsKICAvKioKICAgKiBAcmV0dXJucyB7U3RyaW5nfSB0aGUgc3RyaW5nIHdpdGggZWFjaCBjaGFyYWN0ZXIgY29udGFpbmVkIGluIGEgPHNwYW4+CiAgICovCiAgZnVuY3Rpb24gc3BhbkFsbChzLCBvZmZzZXQgPSAwKSB7CiAgICBjb25zdCBsZXR0ZXJzID0gcy5zcGxpdCgnJyk7CiAgICByZXR1cm4gbGV0dGVycy5tYXAoKG4sIGkpID0+ICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJzxzcGFuIGNsYXNzPSJkaWdpdCB2YWx1ZS0lcyBwb3NpdGlvbi0lZCI+JXM8L3NwYW4+JywgbiwgaSArIG9mZnNldCwgc3BhbkFsbFplcm9lcyhuKSkgLy8gWFhYIFVzZSAjYmFzZS0yIC52YWx1ZS0wIGluc3RlYWQ/CiAgICApLmpvaW4oJycpOwogIH0KICBoZWxwZXJzLnNwYW5BbGwgPSBzcGFuQWxsOwogIGZ1bmN0aW9uIHNwYW5MZWFkaW5nWmVyb2VzU2ltcGxlKGdyb3VwKSB7CiAgICByZXR1cm4gZ3JvdXAucmVwbGFjZSgvXigwKykvLCAnPHNwYW4gY2xhc3M9Inplcm8iPiQxPC9zcGFuPicpOwogIH0KICAvKioKICAgKiBAcmV0dXJucyB7U3RyaW5nfSB0aGUgc3RyaW5nIHdpdGggbGVhZGluZyB6ZXJvZXMgY29udGFpbmVkIGluIGEgPHNwYW4+CiAgICovCiAgZnVuY3Rpb24gc3BhbkxlYWRpbmdaZXJvZXMoYWRkcmVzcykgewogICAgY29uc3QgZ3JvdXBzID0gYWRkcmVzcy5zcGxpdCgnOicpOwogICAgcmV0dXJuIGdyb3Vwcy5tYXAoZyA9PiBzcGFuTGVhZGluZ1plcm9lc1NpbXBsZShnKSkuam9pbignOicpOwogIH0KICBoZWxwZXJzLnNwYW5MZWFkaW5nWmVyb2VzID0gc3BhbkxlYWRpbmdaZXJvZXM7CiAgLyoqCiAgICogR3JvdXBzIGFuIGFkZHJlc3MKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBhIGdyb3VwZWQgYWRkcmVzcwogICAqLwogIGZ1bmN0aW9uIHNpbXBsZUdyb3VwKGFkZHJlc3NTdHJpbmcsIG9mZnNldCA9IDApIHsKICAgIGNvbnN0IGdyb3VwcyA9IGFkZHJlc3NTdHJpbmcuc3BsaXQoJzonKTsKICAgIHJldHVybiBncm91cHMubWFwKChnLCBpKSA9PiB7CiAgICAgIGlmICgvZ3JvdXAtdjQvLnRlc3QoZykpIHsKICAgICAgICByZXR1cm4gZzsKICAgICAgfQogICAgICByZXR1cm4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnPHNwYW4gY2xhc3M9ImhvdmVyLWdyb3VwIGdyb3VwLSVkIj4lczwvc3Bhbj4nLCBpICsgb2Zmc2V0LCBzcGFuTGVhZGluZ1plcm9lc1NpbXBsZShnKSk7CiAgICB9KTsKICB9CiAgaGVscGVycy5zaW1wbGVHcm91cCA9IHNpbXBsZUdyb3VwOwogIHJldHVybiBoZWxwZXJzOwp9Cgp2YXIgcmVndWxhckV4cHJlc3Npb25zID0ge307Cgp2YXIgaGFzUmVxdWlyZWRSZWd1bGFyRXhwcmVzc2lvbnM7CmZ1bmN0aW9uIHJlcXVpcmVSZWd1bGFyRXhwcmVzc2lvbnMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkUmVndWxhckV4cHJlc3Npb25zKSByZXR1cm4gcmVndWxhckV4cHJlc3Npb25zOwogIGhhc1JlcXVpcmVkUmVndWxhckV4cHJlc3Npb25zID0gMTsKICB2YXIgX19jcmVhdGVCaW5kaW5nID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogICAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICAgIGRlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7CiAgfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIG9bazJdID0gbVtrXTsKICB9KTsKICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHYKICAgIH0pOwogIH0gOiBmdW5jdGlvbiAobywgdikgewogICAgb1siZGVmYXVsdCJdID0gdjsKICB9KTsKICB2YXIgX19pbXBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBpZiAobW9kICE9IG51bGwpIGZvciAodmFyIGsgaW4gbW9kKSBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtb2QsIGspKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogICAgX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkocmVndWxhckV4cHJlc3Npb25zLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgcmVndWxhckV4cHJlc3Npb25zLnBvc3NpYmxlRWxpc2lvbnMgPSByZWd1bGFyRXhwcmVzc2lvbnMuc2ltcGxlUmVndWxhckV4cHJlc3Npb24gPSByZWd1bGFyRXhwcmVzc2lvbnMuQUREUkVTU19CT1VOREFSWSA9IHJlZ3VsYXJFeHByZXNzaW9ucy5wYWRHcm91cCA9IHJlZ3VsYXJFeHByZXNzaW9ucy5ncm91cFBvc3NpYmlsaXRpZXMgPSB2b2lkIDA7CiAgY29uc3QgdjYgPSBfX2ltcG9ydFN0YXIocmVxdWlyZUNvbnN0YW50cygpKTsKICBjb25zdCBzcHJpbnRmX2pzXzEgPSByZXF1aXJlU3ByaW50ZigpOwogIGZ1bmN0aW9uIGdyb3VwUG9zc2liaWxpdGllcyhwb3NzaWJpbGl0aWVzKSB7CiAgICByZXR1cm4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnKCVzKScsIHBvc3NpYmlsaXRpZXMuam9pbignfCcpKTsKICB9CiAgcmVndWxhckV4cHJlc3Npb25zLmdyb3VwUG9zc2liaWxpdGllcyA9IGdyb3VwUG9zc2liaWxpdGllczsKICBmdW5jdGlvbiBwYWRHcm91cChncm91cCkgewogICAgaWYgKGdyb3VwLmxlbmd0aCA8IDQpIHsKICAgICAgcmV0dXJuICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJzB7MCwlZH0lcycsIDQgLSBncm91cC5sZW5ndGgsIGdyb3VwKTsKICAgIH0KICAgIHJldHVybiBncm91cDsKICB9CiAgcmVndWxhckV4cHJlc3Npb25zLnBhZEdyb3VwID0gcGFkR3JvdXA7CiAgcmVndWxhckV4cHJlc3Npb25zLkFERFJFU1NfQk9VTkRBUlkgPSAnW15BLUZhLWYwLTk6XSc7CiAgZnVuY3Rpb24gc2ltcGxlUmVndWxhckV4cHJlc3Npb24oZ3JvdXBzKSB7CiAgICBjb25zdCB6ZXJvSW5kZXhlcyA9IFtdOwogICAgZ3JvdXBzLmZvckVhY2goKGdyb3VwLCBpKSA9PiB7CiAgICAgIGNvbnN0IGdyb3VwSW50ZWdlciA9IHBhcnNlSW50KGdyb3VwLCAxNik7CiAgICAgIGlmIChncm91cEludGVnZXIgPT09IDApIHsKICAgICAgICB6ZXJvSW5kZXhlcy5wdXNoKGkpOwogICAgICB9CiAgICB9KTsKICAgIC8vIFlvdSBjYW4gdGVjaG5pY2FsbHkgZWxpZGUgYSBzaW5nbGUgMCwgdGhpcyBjcmVhdGVzIHRoZSByZWd1bGFyIGV4cHJlc3Npb25zCiAgICAvLyB0byBtYXRjaCB0aGF0IGV2ZW50dWFsaXR5CiAgICBjb25zdCBwb3NzaWJpbGl0aWVzID0gemVyb0luZGV4ZXMubWFwKHplcm9JbmRleCA9PiBncm91cHMubWFwKChncm91cCwgaSkgPT4gewogICAgICBpZiAoaSA9PT0gemVyb0luZGV4KSB7CiAgICAgICAgY29uc3QgZWxpc2lvbiA9IGkgPT09IDAgfHwgaSA9PT0gdjYuR1JPVVBTIC0gMSA/ICc6JyA6ICcnOwogICAgICAgIHJldHVybiBncm91cFBvc3NpYmlsaXRpZXMoW3BhZEdyb3VwKGdyb3VwKSwgZWxpc2lvbl0pOwogICAgICB9CiAgICAgIHJldHVybiBwYWRHcm91cChncm91cCk7CiAgICB9KS5qb2luKCc6JykpOwogICAgLy8gVGhlIHNpbXBsZXN0IGNhc2UKICAgIHBvc3NpYmlsaXRpZXMucHVzaChncm91cHMubWFwKHBhZEdyb3VwKS5qb2luKCc6JykpOwogICAgcmV0dXJuIGdyb3VwUG9zc2liaWxpdGllcyhwb3NzaWJpbGl0aWVzKTsKICB9CiAgcmVndWxhckV4cHJlc3Npb25zLnNpbXBsZVJlZ3VsYXJFeHByZXNzaW9uID0gc2ltcGxlUmVndWxhckV4cHJlc3Npb247CiAgZnVuY3Rpb24gcG9zc2libGVFbGlzaW9ucyhlbGlkZWRHcm91cHMsIG1vcmVMZWZ0LCBtb3JlUmlnaHQpIHsKICAgIGNvbnN0IGxlZnQgPSBtb3JlTGVmdCA/ICcnIDogJzonOwogICAgY29uc3QgcmlnaHQgPSBtb3JlUmlnaHQgPyAnJyA6ICc6JzsKICAgIGNvbnN0IHBvc3NpYmlsaXRpZXMgPSBbXTsKICAgIC8vIDEuIGVsaXNpb24gb2YgZXZlcnl0aGluZyAoOjopCiAgICBpZiAoIW1vcmVMZWZ0ICYmICFtb3JlUmlnaHQpIHsKICAgICAgcG9zc2liaWxpdGllcy5wdXNoKCc6OicpOwogICAgfQogICAgLy8gMi4gY29tcGxldGUgZWxpc2lvbiBvZiB0aGUgbWlkZGxlCiAgICBpZiAobW9yZUxlZnQgJiYgbW9yZVJpZ2h0KSB7CiAgICAgIHBvc3NpYmlsaXRpZXMucHVzaCgnJyk7CiAgICB9CiAgICBpZiAobW9yZVJpZ2h0ICYmICFtb3JlTGVmdCB8fCAhbW9yZVJpZ2h0ICYmIG1vcmVMZWZ0KSB7CiAgICAgIC8vIDMuIGNvbXBsZXRlIGVsaXNpb24gb2Ygb25lIHNpZGUKICAgICAgcG9zc2liaWxpdGllcy5wdXNoKCc6Jyk7CiAgICB9CiAgICAvLyA0LiBlbGlzaW9uIGZyb20gdGhlIGxlZnQgc2lkZQogICAgcG9zc2liaWxpdGllcy5wdXNoKCgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyVzKDowezEsNH0pezEsJWR9JywgbGVmdCwgZWxpZGVkR3JvdXBzIC0gMSkpOwogICAgLy8gNS4gZWxpc2lvbiBmcm9tIHRoZSByaWdodCBzaWRlCiAgICBwb3NzaWJpbGl0aWVzLnB1c2goKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnKDB7MSw0fTopezEsJWR9JXMnLCBlbGlkZWRHcm91cHMgLSAxLCByaWdodCkpOwogICAgLy8gNi4gbm8gZWxpc2lvbgogICAgcG9zc2liaWxpdGllcy5wdXNoKCgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJygwezEsNH06KXslZH0wezEsNH0nLCBlbGlkZWRHcm91cHMgLSAxKSk7CiAgICAvLyA3LiBlbGlzaW9uIChpbmNsdWRpbmcgc2xvcHB5IGVsaXNpb24pIGZyb20gdGhlIG1pZGRsZQogICAgZm9yIChsZXQgZ3JvdXBzID0gMTsgZ3JvdXBzIDwgZWxpZGVkR3JvdXBzIC0gMTsgZ3JvdXBzKyspIHsKICAgICAgZm9yIChsZXQgcG9zaXRpb24gPSAxOyBwb3NpdGlvbiA8IGVsaWRlZEdyb3VwcyAtIGdyb3VwczsgcG9zaXRpb24rKykgewogICAgICAgIHBvc3NpYmlsaXRpZXMucHVzaCgoMCwgc3ByaW50Zl9qc18xLnNwcmludGYpKCcoMHsxLDR9Oil7JWR9OigwezEsNH06KXslZH0wezEsNH0nLCBwb3NpdGlvbiwgZWxpZGVkR3JvdXBzIC0gcG9zaXRpb24gLSBncm91cHMgLSAxKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBncm91cFBvc3NpYmlsaXRpZXMocG9zc2liaWxpdGllcyk7CiAgfQogIHJlZ3VsYXJFeHByZXNzaW9ucy5wb3NzaWJsZUVsaXNpb25zID0gcG9zc2libGVFbGlzaW9uczsKICByZXR1cm4gcmVndWxhckV4cHJlc3Npb25zOwp9Cgp2YXIgaGFzUmVxdWlyZWRJcHY2OwpmdW5jdGlvbiByZXF1aXJlSXB2NigpIHsKICBpZiAoaGFzUmVxdWlyZWRJcHY2KSByZXR1cm4gaXB2NjsKICBoYXNSZXF1aXJlZElwdjYgPSAxOwogIC8qIGVzbGludC1kaXNhYmxlIHByZWZlci1kZXN0cnVjdHVyaW5nICovCiAgLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi8KICB2YXIgX19jcmVhdGVCaW5kaW5nID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogICAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICAgIGRlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7CiAgfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIG9bazJdID0gbVtrXTsKICB9KTsKICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHYKICAgIH0pOwogIH0gOiBmdW5jdGlvbiAobywgdikgewogICAgb1siZGVmYXVsdCJdID0gdjsKICB9KTsKICB2YXIgX19pbXBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBpZiAobW9kICE9IG51bGwpIGZvciAodmFyIGsgaW4gbW9kKSBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtb2QsIGspKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogICAgX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaXB2NiwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGlwdjYuQWRkcmVzczYgPSB2b2lkIDA7CiAgY29uc3QgY29tbW9uID0gX19pbXBvcnRTdGFyKHJlcXVpcmVDb21tb24oKSk7CiAgY29uc3QgY29uc3RhbnRzNCA9IF9faW1wb3J0U3RhcihyZXF1aXJlQ29uc3RhbnRzJDEoKSk7CiAgY29uc3QgY29uc3RhbnRzNiA9IF9faW1wb3J0U3RhcihyZXF1aXJlQ29uc3RhbnRzKCkpOwogIGNvbnN0IGhlbHBlcnMgPSBfX2ltcG9ydFN0YXIocmVxdWlyZUhlbHBlcnMkMSgpKTsKICBjb25zdCBpcHY0XzEgPSByZXF1aXJlSXB2NCgpOwogIGNvbnN0IHJlZ3VsYXJfZXhwcmVzc2lvbnNfMSA9IHJlcXVpcmVSZWd1bGFyRXhwcmVzc2lvbnMoKTsKICBjb25zdCBhZGRyZXNzX2Vycm9yXzEgPSByZXF1aXJlQWRkcmVzc0Vycm9yKCk7CiAgY29uc3QganNibl8xID0gcmVxdWlyZUpzYm4oKTsKICBjb25zdCBzcHJpbnRmX2pzXzEgPSByZXF1aXJlU3ByaW50ZigpOwogIGZ1bmN0aW9uIGFzc2VydChjb25kaXRpb24pIHsKICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQXNzZXJ0aW9uIGZhaWxlZC4nKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkQ29tbWFzKG51bWJlcikgewogICAgY29uc3QgciA9IC8oXGQrKShcZHszfSkvOwogICAgd2hpbGUgKHIudGVzdChudW1iZXIpKSB7CiAgICAgIG51bWJlciA9IG51bWJlci5yZXBsYWNlKHIsICckMSwkMicpOwogICAgfQogICAgcmV0dXJuIG51bWJlcjsKICB9CiAgZnVuY3Rpb24gc3BhbkxlYWRpbmdaZXJvZXM0KG4pIHsKICAgIG4gPSBuLnJlcGxhY2UoL14oMHsxLH0pKFsxLTldKykkLywgJzxzcGFuIGNsYXNzPSJwYXJzZS1lcnJvciI+JDE8L3NwYW4+JDInKTsKICAgIG4gPSBuLnJlcGxhY2UoL14oMHsxLH0pKDApJC8sICc8c3BhbiBjbGFzcz0icGFyc2UtZXJyb3IiPiQxPC9zcGFuPiQyJyk7CiAgICByZXR1cm4gbjsKICB9CiAgLyoKICAgKiBBIGhlbHBlciBmdW5jdGlvbiB0byBjb21wYWN0IGFuIGFycmF5CiAgICovCiAgZnVuY3Rpb24gY29tcGFjdChhZGRyZXNzLCBzbGljZSkgewogICAgY29uc3QgczEgPSBbXTsKICAgIGNvbnN0IHMyID0gW107CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBhZGRyZXNzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChpIDwgc2xpY2VbMF0pIHsKICAgICAgICBzMS5wdXNoKGFkZHJlc3NbaV0pOwogICAgICB9IGVsc2UgaWYgKGkgPiBzbGljZVsxXSkgewogICAgICAgIHMyLnB1c2goYWRkcmVzc1tpXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzMS5jb25jYXQoWydjb21wYWN0J10pLmNvbmNhdChzMik7CiAgfQogIGZ1bmN0aW9uIHBhZGRlZEhleChvY3RldCkgewogICAgcmV0dXJuICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyUwNHgnLCBwYXJzZUludChvY3RldCwgMTYpKTsKICB9CiAgZnVuY3Rpb24gdW5zaWduQnl0ZShiKSB7CiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYml0d2lzZQogICAgcmV0dXJuIGIgJiAweGZmOwogIH0KICAvKioKICAgKiBSZXByZXNlbnRzIGFuIElQdjYgYWRkcmVzcwogICAqIEBjbGFzcyBBZGRyZXNzNgogICAqIEBwYXJhbSB7c3RyaW5nfSBhZGRyZXNzIC0gQW4gSVB2NiBhZGRyZXNzIHN0cmluZwogICAqIEBwYXJhbSB7bnVtYmVyfSBbZ3JvdXBzPThdIC0gSG93IG1hbnkgb2N0ZXRzIHRvIHBhcnNlCiAgICogQGV4YW1wbGUKICAgKiB2YXIgYWRkcmVzcyA9IG5ldyBBZGRyZXNzNignMjAwMTo6LzMyJyk7CiAgICovCiAgY2xhc3MgQWRkcmVzczYgewogICAgY29uc3RydWN0b3IoYWRkcmVzcywgb3B0aW9uYWxHcm91cHMpIHsKICAgICAgdGhpcy5hZGRyZXNzTWludXNTdWZmaXggPSAnJzsKICAgICAgdGhpcy5wYXJzZWRTdWJuZXQgPSAnJzsKICAgICAgdGhpcy5zdWJuZXQgPSAnLzEyOCc7CiAgICAgIHRoaXMuc3VibmV0TWFzayA9IDEyODsKICAgICAgdGhpcy52NCA9IGZhbHNlOwogICAgICB0aGlzLnpvbmUgPSAnJzsKICAgICAgLy8gI3JlZ2lvbiBBdHRyaWJ1dGVzCiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGdpdmVuIGFkZHJlc3MgaXMgaW4gdGhlIHN1Ym5ldCBvZiB0aGUgY3VycmVudCBhZGRyZXNzCiAgICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICAgKiBAaW5zdGFuY2UKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICAgICAqLwogICAgICB0aGlzLmlzSW5TdWJuZXQgPSBjb21tb24uaXNJblN1Ym5ldDsKICAgICAgLyoqCiAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYWRkcmVzcyBpcyBjb3JyZWN0LCBmYWxzZSBvdGhlcndpc2UKICAgICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgICAqIEBpbnN0YW5jZQogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgICAgICovCiAgICAgIHRoaXMuaXNDb3JyZWN0ID0gY29tbW9uLmlzQ29ycmVjdChjb25zdGFudHM2LkJJVFMpOwogICAgICBpZiAob3B0aW9uYWxHcm91cHMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuZ3JvdXBzID0gY29uc3RhbnRzNi5HUk9VUFM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5ncm91cHMgPSBvcHRpb25hbEdyb3VwczsKICAgICAgfQogICAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzOwogICAgICBjb25zdCBzdWJuZXQgPSBjb25zdGFudHM2LlJFX1NVQk5FVF9TVFJJTkcuZXhlYyhhZGRyZXNzKTsKICAgICAgaWYgKHN1Ym5ldCkgewogICAgICAgIHRoaXMucGFyc2VkU3VibmV0ID0gc3VibmV0WzBdLnJlcGxhY2UoJy8nLCAnJyk7CiAgICAgICAgdGhpcy5zdWJuZXRNYXNrID0gcGFyc2VJbnQodGhpcy5wYXJzZWRTdWJuZXQsIDEwKTsKICAgICAgICB0aGlzLnN1Ym5ldCA9IGAvJHt0aGlzLnN1Ym5ldE1hc2t9YDsKICAgICAgICBpZiAoTnVtYmVyLmlzTmFOKHRoaXMuc3VibmV0TWFzaykgfHwgdGhpcy5zdWJuZXRNYXNrIDwgMCB8fCB0aGlzLnN1Ym5ldE1hc2sgPiBjb25zdGFudHM2LkJJVFMpIHsKICAgICAgICAgIHRocm93IG5ldyBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yKCdJbnZhbGlkIHN1Ym5ldCBtYXNrLicpOwogICAgICAgIH0KICAgICAgICBhZGRyZXNzID0gYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50czYuUkVfU1VCTkVUX1NUUklORywgJycpOwogICAgICB9IGVsc2UgaWYgKC9cLy8udGVzdChhZGRyZXNzKSkgewogICAgICAgIHRocm93IG5ldyBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yKCdJbnZhbGlkIHN1Ym5ldCBtYXNrLicpOwogICAgICB9CiAgICAgIGNvbnN0IHpvbmUgPSBjb25zdGFudHM2LlJFX1pPTkVfU1RSSU5HLmV4ZWMoYWRkcmVzcyk7CiAgICAgIGlmICh6b25lKSB7CiAgICAgICAgdGhpcy56b25lID0gem9uZVswXTsKICAgICAgICBhZGRyZXNzID0gYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50czYuUkVfWk9ORV9TVFJJTkcsICcnKTsKICAgICAgfQogICAgICB0aGlzLmFkZHJlc3NNaW51c1N1ZmZpeCA9IGFkZHJlc3M7CiAgICAgIHRoaXMucGFyc2VkQWRkcmVzcyA9IHRoaXMucGFyc2UodGhpcy5hZGRyZXNzTWludXNTdWZmaXgpOwogICAgfQogICAgc3RhdGljIGlzVmFsaWQoYWRkcmVzcykgewogICAgICB0cnkgewogICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1uZXcKICAgICAgICBuZXcgQWRkcmVzczYoYWRkcmVzcyk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIEJpZ0ludGVnZXIgdG8gYSB2NiBhZGRyZXNzIG9iamVjdAogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAc3RhdGljCiAgICAgKiBAcGFyYW0ge0JpZ0ludGVnZXJ9IGJpZ0ludGVnZXIgLSBhIEJpZ0ludGVnZXIgdG8gY29udmVydAogICAgICogQHJldHVybnMge0FkZHJlc3M2fQogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBiaWdJbnRlZ2VyID0gbmV3IEJpZ0ludGVnZXIoJzEwMDAwMDAwMDAwMDAnKTsKICAgICAqIHZhciBhZGRyZXNzID0gQWRkcmVzczYuZnJvbUJpZ0ludGVnZXIoYmlnSW50ZWdlcik7CiAgICAgKiBhZGRyZXNzLmNvcnJlY3RGb3JtKCk7IC8vICc6OmU4OmQ0YTU6MTAwMCcKICAgICAqLwogICAgc3RhdGljIGZyb21CaWdJbnRlZ2VyKGJpZ0ludGVnZXIpIHsKICAgICAgY29uc3QgaGV4ID0gYmlnSW50ZWdlci50b1N0cmluZygxNikucGFkU3RhcnQoMzIsICcwJyk7CiAgICAgIGNvbnN0IGdyb3VwcyA9IFtdOwogICAgICBsZXQgaTsKICAgICAgZm9yIChpID0gMDsgaSA8IGNvbnN0YW50czYuR1JPVVBTOyBpKyspIHsKICAgICAgICBncm91cHMucHVzaChoZXguc2xpY2UoaSAqIDQsIChpICsgMSkgKiA0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBBZGRyZXNzNihncm91cHMuam9pbignOicpKTsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIFVSTCAod2l0aCBvcHRpb25hbCBwb3J0IG51bWJlcikgdG8gYW4gYWRkcmVzcyBvYmplY3QKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQHN0YXRpYwogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIGEgVVJMIHdpdGggb3B0aW9uYWwgcG9ydCBudW1iZXIKICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgYWRkcmVzc0FuZFBvcnQgPSBBZGRyZXNzNi5mcm9tVVJMKCdodHRwOi8vW2ZmZmY6Ol06ODA4MC9mb28vJyk7CiAgICAgKiBhZGRyZXNzQW5kUG9ydC5hZGRyZXNzLmNvcnJlY3RGb3JtKCk7IC8vICdmZmZmOjonCiAgICAgKiBhZGRyZXNzQW5kUG9ydC5wb3J0OyAvLyA4MDgwCiAgICAgKi8KICAgIHN0YXRpYyBmcm9tVVJMKHVybCkgewogICAgICBsZXQgaG9zdDsKICAgICAgbGV0IHBvcnQgPSBudWxsOwogICAgICBsZXQgcmVzdWx0OwogICAgICAvLyBJZiB3ZSBoYXZlIGJyYWNrZXRzIHBhcnNlIHRoZW0gYW5kIGZpbmQgYSBwb3J0CiAgICAgIGlmICh1cmwuaW5kZXhPZignWycpICE9PSAtMSAmJiB1cmwuaW5kZXhPZignXTonKSAhPT0gLTEpIHsKICAgICAgICByZXN1bHQgPSBjb25zdGFudHM2LlJFX1VSTF9XSVRIX1BPUlQuZXhlYyh1cmwpOwogICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVycm9yOiAnZmFpbGVkIHRvIHBhcnNlIGFkZHJlc3Mgd2l0aCBwb3J0JywKICAgICAgICAgICAgYWRkcmVzczogbnVsbCwKICAgICAgICAgICAgcG9ydDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaG9zdCA9IHJlc3VsdFsxXTsKICAgICAgICBwb3J0ID0gcmVzdWx0WzJdOwogICAgICAgIC8vIElmIHRoZXJlJ3MgYSBVUkwgZXh0cmFjdCB0aGUgYWRkcmVzcwogICAgICB9IGVsc2UgaWYgKHVybC5pbmRleE9mKCcvJykgIT09IC0xKSB7CiAgICAgICAgLy8gUmVtb3ZlIHRoZSBwcm90b2NvbCBwcmVmaXgKICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvXlthLXowLTldKzpcL1wvLywgJycpOwogICAgICAgIC8vIFBhcnNlIHRoZSBhZGRyZXNzCiAgICAgICAgcmVzdWx0ID0gY29uc3RhbnRzNi5SRV9VUkwuZXhlYyh1cmwpOwogICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVycm9yOiAnZmFpbGVkIHRvIHBhcnNlIGFkZHJlc3MgZnJvbSBVUkwnLAogICAgICAgICAgICBhZGRyZXNzOiBudWxsLAogICAgICAgICAgICBwb3J0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBob3N0ID0gcmVzdWx0WzFdOwogICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGFzc2lnbiB0aGUgVVJMIHRvIHRoZSBob3N0IGFuZCBsZXQgdGhlIGxpYnJhcnkgcGFyc2UgaXQKICAgICAgfSBlbHNlIHsKICAgICAgICBob3N0ID0gdXJsOwogICAgICB9CiAgICAgIC8vIElmIHRoZXJlJ3MgYSBwb3J0IGNvbnZlcnQgaXQgdG8gYW4gaW50ZWdlcgogICAgICBpZiAocG9ydCkgewogICAgICAgIHBvcnQgPSBwYXJzZUludChwb3J0LCAxMCk7CiAgICAgICAgLy8gc3F1ZWxjaCBvdXQgb2YgcmFuZ2UgcG9ydHMKICAgICAgICBpZiAocG9ydCA8IDAgfHwgcG9ydCA+IDY1NTM2KSB7CiAgICAgICAgICBwb3J0ID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU3RhbmRhcmRpemUgYHVuZGVmaW5lZGAgdG8gYG51bGxgCiAgICAgICAgcG9ydCA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBhZGRyZXNzOiBuZXcgQWRkcmVzczYoaG9zdCksCiAgICAgICAgcG9ydAogICAgICB9OwogICAgfQogICAgLyoqCiAgICAgKiBDcmVhdGUgYW4gSVB2Ni1tYXBwZWQgYWRkcmVzcyBnaXZlbiBhbiBJUHY0IGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQHN0YXRpYwogICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZHJlc3MgLSBBbiBJUHY0IGFkZHJlc3Mgc3RyaW5nCiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczZ9CiAgICAgKiBAZXhhbXBsZQogICAgICogdmFyIGFkZHJlc3MgPSBBZGRyZXNzNi5mcm9tQWRkcmVzczQoJzE5Mi4xNjguMC4xJyk7CiAgICAgKiBhZGRyZXNzLmNvcnJlY3RGb3JtKCk7IC8vICc6OmZmZmY6YzBhODoxJwogICAgICogYWRkcmVzcy50bzRpbjYoKTsgLy8gJzo6ZmZmZjoxOTIuMTY4LjAuMScKICAgICAqLwogICAgc3RhdGljIGZyb21BZGRyZXNzNChhZGRyZXNzKSB7CiAgICAgIGNvbnN0IGFkZHJlc3M0ID0gbmV3IGlwdjRfMS5BZGRyZXNzNChhZGRyZXNzKTsKICAgICAgY29uc3QgbWFzazYgPSBjb25zdGFudHM2LkJJVFMgLSAoY29uc3RhbnRzNC5CSVRTIC0gYWRkcmVzczQuc3VibmV0TWFzayk7CiAgICAgIHJldHVybiBuZXcgQWRkcmVzczYoYDo6ZmZmZjoke2FkZHJlc3M0LmNvcnJlY3RGb3JtKCl9LyR7bWFzazZ9YCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiBhbiBhZGRyZXNzIGZyb20gaXA2LmFycGEgZm9ybQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAc3RhdGljCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYXJwYUZvcm1BZGRyZXNzIC0gYW4gJ2lwNi5hcnBhJyBmb3JtIGFkZHJlc3MKICAgICAqIEByZXR1cm5zIHtBZHJlc3M2fQogICAgICogQGV4YW1wbGUKICAgICAqIHZhciBhZGRyZXNzID0gQWRkcmVzczYuZnJvbUFycGEoZS5mLmYuZi4zLmMuMi42LmYuZi5mLmUuNi42LjguZS4xLjAuNi43LjkuNC5lLmMuMC4wLjAuMC4xLjAuMC4yLmlwNi5hcnBhLikKICAgICAqIGFkZHJlc3MuY29ycmVjdEZvcm0oKTsgLy8gJzIwMDE6MDpjZTQ5Ojc2MDE6ZTg2NjplZmZmOjYyYzM6ZmZmZScKICAgICAqLwogICAgc3RhdGljIGZyb21BcnBhKGFycGFGb3JtQWRkcmVzcykgewogICAgICAvLyByZW1vdmUgZW5kaW5nICIuaXA2LmFycGEuIiBvciBqdXN0ICIuIgogICAgICBsZXQgYWRkcmVzcyA9IGFycGFGb3JtQWRkcmVzcy5yZXBsYWNlKC8oXC5pcDZcLmFycGEpP1wuJC8sICcnKTsKICAgICAgY29uc3Qgc2VtaWNvbG9uQW1vdW50ID0gNzsKICAgICAgLy8gY29ycmVjdCBpcDYuYXJwYSBmb3JtIHdpdGggZW5kaW5nIHJlbW92ZWQgd2lsbCBiZSA2MyBjaGFyYWN0ZXJzCiAgICAgIGlmIChhZGRyZXNzLmxlbmd0aCAhPT0gNjMpIHsKICAgICAgICB0aHJvdyBuZXcgYWRkcmVzc19lcnJvcl8xLkFkZHJlc3NFcnJvcigiSW52YWxpZCAnaXA2LmFycGEnIGZvcm0uIik7CiAgICAgIH0KICAgICAgY29uc3QgcGFydHMgPSBhZGRyZXNzLnNwbGl0KCcuJykucmV2ZXJzZSgpOwogICAgICBmb3IgKGxldCBpID0gc2VtaWNvbG9uQW1vdW50OyBpID4gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgaW5zZXJ0SW5kZXggPSBpICogNDsKICAgICAgICBwYXJ0cy5zcGxpY2UoaW5zZXJ0SW5kZXgsIDAsICc6Jyk7CiAgICAgIH0KICAgICAgYWRkcmVzcyA9IHBhcnRzLmpvaW4oJycpOwogICAgICByZXR1cm4gbmV3IEFkZHJlc3M2KGFkZHJlc3MpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIE1pY3Jvc29mdCBVTkMgdHJhbnNjcmlwdGlvbiBvZiB0aGUgYWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IHRoZSBNaWNyb3NvZnQgVU5DIHRyYW5zY3JpcHRpb24gb2YgdGhlIGFkZHJlc3MKICAgICAqLwogICAgbWljcm9zb2Z0VHJhbnNjcmlwdGlvbigpIHsKICAgICAgcmV0dXJuICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyVzLmlwdjYtbGl0ZXJhbC5uZXQnLCB0aGlzLmNvcnJlY3RGb3JtKCkucmVwbGFjZSgvOi9nLCAnLScpKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBmaXJzdCBuIGJpdHMgb2YgdGhlIGFkZHJlc3MsIGRlZmF1bHRpbmcgdG8gdGhlIHN1Ym5ldCBtYXNrCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXNrPXN1Ym5ldF0gLSB0aGUgbnVtYmVyIG9mIGJpdHMgdG8gbWFzawogICAgICogQHJldHVybnMge1N0cmluZ30gdGhlIGZpcnN0IG4gYml0cyBvZiB0aGUgYWRkcmVzcyBhcyBhIHN0cmluZwogICAgICovCiAgICBtYXNrKG1hc2sgPSB0aGlzLnN1Ym5ldE1hc2spIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0Qml0c0Jhc2UyKDAsIG1hc2spOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIG51bWJlciBvZiBwb3NzaWJsZSBzdWJuZXRzIG9mIGEgZ2l2ZW4gc2l6ZSBpbiB0aGUgYWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc2l6ZT0xMjhdIC0gdGhlIHN1Ym5ldCBzaXplCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICAvLyBUT0RPOiBwcm9iYWJseSB1c2VmdWwgdG8gaGF2ZSBhIG51bWVyaWMgdmVyc2lvbiBvZiB0aGlzIHRvbwogICAgcG9zc2libGVTdWJuZXRzKHN1Ym5ldFNpemUgPSAxMjgpIHsKICAgICAgY29uc3QgYXZhaWxhYmxlQml0cyA9IGNvbnN0YW50czYuQklUUyAtIHRoaXMuc3VibmV0TWFzazsKICAgICAgY29uc3Qgc3VibmV0Qml0cyA9IE1hdGguYWJzKHN1Ym5ldFNpemUgLSBjb25zdGFudHM2LkJJVFMpOwogICAgICBjb25zdCBzdWJuZXRQb3dlcnMgPSBhdmFpbGFibGVCaXRzIC0gc3VibmV0Qml0czsKICAgICAgaWYgKHN1Ym5ldFBvd2VycyA8IDApIHsKICAgICAgICByZXR1cm4gJzAnOwogICAgICB9CiAgICAgIHJldHVybiBhZGRDb21tYXMobmV3IGpzYm5fMS5CaWdJbnRlZ2VyKCcyJywgMTApLnBvdyhzdWJuZXRQb3dlcnMpLnRvU3RyaW5nKDEwKSk7CiAgICB9CiAgICAvKioKICAgICAqIEhlbHBlciBmdW5jdGlvbiBnZXR0aW5nIHN0YXJ0IGFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0JpZ0ludGVnZXJ9CiAgICAgKi8KICAgIF9zdGFydEFkZHJlc3MoKSB7CiAgICAgIHJldHVybiBuZXcganNibl8xLkJpZ0ludGVnZXIodGhpcy5tYXNrKCkgKyAnMCcucmVwZWF0KGNvbnN0YW50czYuQklUUyAtIHRoaXMuc3VibmV0TWFzayksIDIpOwogICAgfQogICAgLyoqCiAgICAgKiBUaGUgZmlyc3QgYWRkcmVzcyBpbiB0aGUgcmFuZ2UgZ2l2ZW4gYnkgdGhpcyBhZGRyZXNzJyBzdWJuZXQKICAgICAqIE9mdGVuIHJlZmVycmVkIHRvIGFzIHRoZSBOZXR3b3JrIEFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0FkZHJlc3M2fQogICAgICovCiAgICBzdGFydEFkZHJlc3MoKSB7CiAgICAgIHJldHVybiBBZGRyZXNzNi5mcm9tQmlnSW50ZWdlcih0aGlzLl9zdGFydEFkZHJlc3MoKSk7CiAgICB9CiAgICAvKioKICAgICAqIFRoZSBmaXJzdCBob3N0IGFkZHJlc3MgaW4gdGhlIHJhbmdlIGdpdmVuIGJ5IHRoaXMgYWRkcmVzcydzIHN1Ym5ldCBpZQogICAgICogdGhlIGZpcnN0IGFkZHJlc3MgYWZ0ZXIgdGhlIE5ldHdvcmsgQWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBZGRyZXNzNn0KICAgICAqLwogICAgc3RhcnRBZGRyZXNzRXhjbHVzaXZlKCkgewogICAgICBjb25zdCBhZGp1c3QgPSBuZXcganNibl8xLkJpZ0ludGVnZXIoJzEnKTsKICAgICAgcmV0dXJuIEFkZHJlc3M2LmZyb21CaWdJbnRlZ2VyKHRoaXMuX3N0YXJ0QWRkcmVzcygpLmFkZChhZGp1c3QpKTsKICAgIH0KICAgIC8qKgogICAgICogSGVscGVyIGZ1bmN0aW9uIGdldHRpbmcgZW5kIGFkZHJlc3MuCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0JpZ0ludGVnZXJ9CiAgICAgKi8KICAgIF9lbmRBZGRyZXNzKCkgewogICAgICByZXR1cm4gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKHRoaXMubWFzaygpICsgJzEnLnJlcGVhdChjb25zdGFudHM2LkJJVFMgLSB0aGlzLnN1Ym5ldE1hc2spLCAyKTsKICAgIH0KICAgIC8qKgogICAgICogVGhlIGxhc3QgYWRkcmVzcyBpbiB0aGUgcmFuZ2UgZ2l2ZW4gYnkgdGhpcyBhZGRyZXNzJyBzdWJuZXQKICAgICAqIE9mdGVuIHJlZmVycmVkIHRvIGFzIHRoZSBCcm9hZGNhc3QKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczZ9CiAgICAgKi8KICAgIGVuZEFkZHJlc3MoKSB7CiAgICAgIHJldHVybiBBZGRyZXNzNi5mcm9tQmlnSW50ZWdlcih0aGlzLl9lbmRBZGRyZXNzKCkpOwogICAgfQogICAgLyoqCiAgICAgKiBUaGUgbGFzdCBob3N0IGFkZHJlc3MgaW4gdGhlIHJhbmdlIGdpdmVuIGJ5IHRoaXMgYWRkcmVzcydzIHN1Ym5ldCBpZQogICAgICogdGhlIGxhc3QgYWRkcmVzcyBwcmlvciB0byB0aGUgQnJvYWRjYXN0IEFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczZ9CiAgICAgKi8KICAgIGVuZEFkZHJlc3NFeGNsdXNpdmUoKSB7CiAgICAgIGNvbnN0IGFkanVzdCA9IG5ldyBqc2JuXzEuQmlnSW50ZWdlcignMScpOwogICAgICByZXR1cm4gQWRkcmVzczYuZnJvbUJpZ0ludGVnZXIodGhpcy5fZW5kQWRkcmVzcygpLnN1YnRyYWN0KGFkanVzdCkpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHNjb3BlIG9mIHRoZSBhZGRyZXNzCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgZ2V0U2NvcGUoKSB7CiAgICAgIGxldCBzY29wZSA9IGNvbnN0YW50czYuU0NPUEVTW3RoaXMuZ2V0Qml0cygxMiwgMTYpLmludFZhbHVlKCldOwogICAgICBpZiAodGhpcy5nZXRUeXBlKCkgPT09ICdHbG9iYWwgdW5pY2FzdCcgJiYgc2NvcGUgIT09ICdMaW5rIGxvY2FsJykgewogICAgICAgIHNjb3BlID0gJ0dsb2JhbCc7CiAgICAgIH0KICAgICAgcmV0dXJuIHNjb3BlIHx8ICdVbmtub3duJzsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSB0eXBlIG9mIHRoZSBhZGRyZXNzCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgZ2V0VHlwZSgpIHsKICAgICAgZm9yIChjb25zdCBzdWJuZXQgb2YgT2JqZWN0LmtleXMoY29uc3RhbnRzNi5UWVBFUykpIHsKICAgICAgICBpZiAodGhpcy5pc0luU3VibmV0KG5ldyBBZGRyZXNzNihzdWJuZXQpKSkgewogICAgICAgICAgcmV0dXJuIGNvbnN0YW50czYuVFlQRVNbc3VibmV0XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuICdHbG9iYWwgdW5pY2FzdCc7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiB0aGUgYml0cyBpbiB0aGUgZ2l2ZW4gcmFuZ2UgYXMgYSBCaWdJbnRlZ2VyCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0JpZ0ludGVnZXJ9CiAgICAgKi8KICAgIGdldEJpdHMoc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKHRoaXMuZ2V0Qml0c0Jhc2UyKHN0YXJ0LCBlbmQpLCAyKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBiaXRzIGluIHRoZSBnaXZlbiByYW5nZSBhcyBhIGJhc2UtMiBzdHJpbmcKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICBnZXRCaXRzQmFzZTIoc3RhcnQsIGVuZCkgewogICAgICByZXR1cm4gdGhpcy5iaW5hcnlaZXJvUGFkKCkuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiB0aGUgYml0cyBpbiB0aGUgZ2l2ZW4gcmFuZ2UgYXMgYSBiYXNlLTE2IHN0cmluZwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldEJpdHNCYXNlMTYoc3RhcnQsIGVuZCkgewogICAgICBjb25zdCBsZW5ndGggPSBlbmQgLSBzdGFydDsKICAgICAgaWYgKGxlbmd0aCAlIDQgIT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xlbmd0aCBvZiBiaXRzIHRvIHJldHJpZXZlIG11c3QgYmUgZGl2aXNpYmxlIGJ5IGZvdXInKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5nZXRCaXRzKHN0YXJ0LCBlbmQpLnRvU3RyaW5nKDE2KS5wYWRTdGFydChsZW5ndGggLyA0LCAnMCcpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIGJpdHMgdGhhdCBhcmUgc2V0IHBhc3QgdGhlIHN1Ym5ldCBtYXNrIGxlbmd0aAogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KICAgIGdldEJpdHNQYXN0U3VibmV0KCkgewogICAgICByZXR1cm4gdGhpcy5nZXRCaXRzQmFzZTIodGhpcy5zdWJuZXRNYXNrLCBjb25zdGFudHM2LkJJVFMpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHJldmVyc2VkIGlwNi5hcnBhIGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5vbWl0U3VmZml4IC0gb21pdCB0aGUgImlwNi5hcnBhIiBzdWZmaXgKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgcmV2ZXJzZUZvcm0ob3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgY2hhcmFjdGVycyA9IE1hdGguZmxvb3IodGhpcy5zdWJuZXRNYXNrIC8gNCk7CiAgICAgIGNvbnN0IHJldmVyc2VkID0gdGhpcy5jYW5vbmljYWxGb3JtKCkucmVwbGFjZSgvOi9nLCAnJykuc3BsaXQoJycpLnNsaWNlKDAsIGNoYXJhY3RlcnMpLnJldmVyc2UoKS5qb2luKCcuJyk7CiAgICAgIGlmIChjaGFyYWN0ZXJzID4gMCkgewogICAgICAgIGlmIChvcHRpb25zLm9taXRTdWZmaXgpIHsKICAgICAgICAgIHJldHVybiByZXZlcnNlZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyVzLmlwNi5hcnBhLicsIHJldmVyc2VkKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5vbWl0U3VmZml4KSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHJldHVybiAnaXA2LmFycGEuJzsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBjb3JyZWN0IGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICBjb3JyZWN0Rm9ybSgpIHsKICAgICAgbGV0IGk7CiAgICAgIGxldCBncm91cHMgPSBbXTsKICAgICAgbGV0IHplcm9Db3VudGVyID0gMDsKICAgICAgY29uc3QgemVyb2VzID0gW107CiAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLnBhcnNlZEFkZHJlc3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IHBhcnNlSW50KHRoaXMucGFyc2VkQWRkcmVzc1tpXSwgMTYpOwogICAgICAgIGlmICh2YWx1ZSA9PT0gMCkgewogICAgICAgICAgemVyb0NvdW50ZXIrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlICE9PSAwICYmIHplcm9Db3VudGVyID4gMCkgewogICAgICAgICAgaWYgKHplcm9Db3VudGVyID4gMSkgewogICAgICAgICAgICB6ZXJvZXMucHVzaChbaSAtIHplcm9Db3VudGVyLCBpIC0gMV0pOwogICAgICAgICAgfQogICAgICAgICAgemVyb0NvdW50ZXIgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBEbyB3ZSBlbmQgd2l0aCBhIHN0cmluZyBvZiB6ZXJvZXM/CiAgICAgIGlmICh6ZXJvQ291bnRlciA+IDEpIHsKICAgICAgICB6ZXJvZXMucHVzaChbdGhpcy5wYXJzZWRBZGRyZXNzLmxlbmd0aCAtIHplcm9Db3VudGVyLCB0aGlzLnBhcnNlZEFkZHJlc3MubGVuZ3RoIC0gMV0pOwogICAgICB9CiAgICAgIGNvbnN0IHplcm9MZW5ndGhzID0gemVyb2VzLm1hcChuID0+IG5bMV0gLSBuWzBdICsgMSk7CiAgICAgIGlmICh6ZXJvZXMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGluZGV4ID0gemVyb0xlbmd0aHMuaW5kZXhPZihNYXRoLm1heCguLi56ZXJvTGVuZ3RocykpOwogICAgICAgIGdyb3VwcyA9IGNvbXBhY3QodGhpcy5wYXJzZWRBZGRyZXNzLCB6ZXJvZXNbaW5kZXhdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBncm91cHMgPSB0aGlzLnBhcnNlZEFkZHJlc3M7CiAgICAgIH0KICAgICAgZm9yIChpID0gMDsgaSA8IGdyb3Vwcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChncm91cHNbaV0gIT09ICdjb21wYWN0JykgewogICAgICAgICAgZ3JvdXBzW2ldID0gcGFyc2VJbnQoZ3JvdXBzW2ldLCAxNikudG9TdHJpbmcoMTYpOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgY29ycmVjdCA9IGdyb3Vwcy5qb2luKCc6Jyk7CiAgICAgIGNvcnJlY3QgPSBjb3JyZWN0LnJlcGxhY2UoL15jb21wYWN0JC8sICc6OicpOwogICAgICBjb3JyZWN0ID0gY29ycmVjdC5yZXBsYWNlKC9eY29tcGFjdHxjb21wYWN0JC8sICc6Jyk7CiAgICAgIGNvcnJlY3QgPSBjb3JyZWN0LnJlcGxhY2UoL2NvbXBhY3QvLCAnJyk7CiAgICAgIHJldHVybiBjb3JyZWN0OwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gYSB6ZXJvLXBhZGRlZCBiYXNlLTIgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBhZGRyZXNzCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqIEBleGFtcGxlCiAgICAgKiB2YXIgYWRkcmVzcyA9IG5ldyBBZGRyZXNzNignMjAwMTo0ODYwOjQwMDE6ODAzOjoxMDExJyk7CiAgICAgKiBhZGRyZXNzLmJpbmFyeVplcm9QYWQoKTsKICAgICAqIC8vICcwMDEwMDAwMDAwMDAwMDAxMDEwMDEwMDAwMTEwMDAwMDAxMDAwMDAwMDAwMDAwMDEwMDAwMTAwMDAwMDAwMDExCiAgICAgKiAvLyAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMTAwMDAwMDAxMDAwMScKICAgICAqLwogICAgYmluYXJ5WmVyb1BhZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYmlnSW50ZWdlcigpLnRvU3RyaW5nKDIpLnBhZFN0YXJ0KGNvbnN0YW50czYuQklUUywgJzAnKTsKICAgIH0KICAgIC8vIFRPRE86IEltcHJvdmUgdGhlIHNlbWFudGljcyBvZiB0aGlzIGhlbHBlciBmdW5jdGlvbgogICAgcGFyc2U0aW42KGFkZHJlc3MpIHsKICAgICAgY29uc3QgZ3JvdXBzID0gYWRkcmVzcy5zcGxpdCgnOicpOwogICAgICBjb25zdCBsYXN0R3JvdXAgPSBncm91cHMuc2xpY2UoLTEpWzBdOwogICAgICBjb25zdCBhZGRyZXNzNCA9IGxhc3RHcm91cC5tYXRjaChjb25zdGFudHM0LlJFX0FERFJFU1MpOwogICAgICBpZiAoYWRkcmVzczQpIHsKICAgICAgICB0aGlzLnBhcnNlZEFkZHJlc3M0ID0gYWRkcmVzczRbMF07CiAgICAgICAgdGhpcy5hZGRyZXNzNCA9IG5ldyBpcHY0XzEuQWRkcmVzczQodGhpcy5wYXJzZWRBZGRyZXNzNCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFkZHJlc3M0Lmdyb3VwczsgaSsrKSB7CiAgICAgICAgICBpZiAoL14wWzAtOV0rLy50ZXN0KHRoaXMuYWRkcmVzczQucGFyc2VkQWRkcmVzc1tpXSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IGFkZHJlc3NfZXJyb3JfMS5BZGRyZXNzRXJyb3IoIklQdjQgYWRkcmVzc2VzIGNhbid0IGhhdmUgbGVhZGluZyB6ZXJvZXMuIiwgYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50czQuUkVfQUREUkVTUywgdGhpcy5hZGRyZXNzNC5wYXJzZWRBZGRyZXNzLm1hcChzcGFuTGVhZGluZ1plcm9lczQpLmpvaW4oJy4nKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnY0ID0gdHJ1ZTsKICAgICAgICBncm91cHNbZ3JvdXBzLmxlbmd0aCAtIDFdID0gdGhpcy5hZGRyZXNzNC50b0dyb3VwNigpOwogICAgICAgIGFkZHJlc3MgPSBncm91cHMuam9pbignOicpOwogICAgICB9CiAgICAgIHJldHVybiBhZGRyZXNzOwogICAgfQogICAgLy8gVE9ETzogTWFrZSBwcml2YXRlPwogICAgcGFyc2UoYWRkcmVzcykgewogICAgICBhZGRyZXNzID0gdGhpcy5wYXJzZTRpbjYoYWRkcmVzcyk7CiAgICAgIGNvbnN0IGJhZENoYXJhY3RlcnMgPSBhZGRyZXNzLm1hdGNoKGNvbnN0YW50czYuUkVfQkFEX0NIQVJBQ1RFUlMpOwogICAgICBpZiAoYmFkQ2hhcmFjdGVycykgewogICAgICAgIHRocm93IG5ldyBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yKCgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJ0JhZCBjaGFyYWN0ZXIlcyBkZXRlY3RlZCBpbiBhZGRyZXNzOiAlcycsIGJhZENoYXJhY3RlcnMubGVuZ3RoID4gMSA/ICdzJyA6ICcnLCBiYWRDaGFyYWN0ZXJzLmpvaW4oJycpKSwgYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50czYuUkVfQkFEX0NIQVJBQ1RFUlMsICc8c3BhbiBjbGFzcz0icGFyc2UtZXJyb3IiPiQxPC9zcGFuPicpKTsKICAgICAgfQogICAgICBjb25zdCBiYWRBZGRyZXNzID0gYWRkcmVzcy5tYXRjaChjb25zdGFudHM2LlJFX0JBRF9BRERSRVNTKTsKICAgICAgaWYgKGJhZEFkZHJlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgYWRkcmVzc19lcnJvcl8xLkFkZHJlc3NFcnJvcigoMCwgc3ByaW50Zl9qc18xLnNwcmludGYpKCdBZGRyZXNzIGZhaWxlZCByZWdleDogJXMnLCBiYWRBZGRyZXNzLmpvaW4oJycpKSwgYWRkcmVzcy5yZXBsYWNlKGNvbnN0YW50czYuUkVfQkFEX0FERFJFU1MsICc8c3BhbiBjbGFzcz0icGFyc2UtZXJyb3IiPiQxPC9zcGFuPicpKTsKICAgICAgfQogICAgICBsZXQgZ3JvdXBzID0gW107CiAgICAgIGNvbnN0IGhhbHZlcyA9IGFkZHJlc3Muc3BsaXQoJzo6Jyk7CiAgICAgIGlmIChoYWx2ZXMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgbGV0IGZpcnN0ID0gaGFsdmVzWzBdLnNwbGl0KCc6Jyk7CiAgICAgICAgbGV0IGxhc3QgPSBoYWx2ZXNbMV0uc3BsaXQoJzonKTsKICAgICAgICBpZiAoZmlyc3QubGVuZ3RoID09PSAxICYmIGZpcnN0WzBdID09PSAnJykgewogICAgICAgICAgZmlyc3QgPSBbXTsKICAgICAgICB9CiAgICAgICAgaWYgKGxhc3QubGVuZ3RoID09PSAxICYmIGxhc3RbMF0gPT09ICcnKSB7CiAgICAgICAgICBsYXN0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlbWFpbmluZyA9IHRoaXMuZ3JvdXBzIC0gKGZpcnN0Lmxlbmd0aCArIGxhc3QubGVuZ3RoKTsKICAgICAgICBpZiAoIXJlbWFpbmluZykgewogICAgICAgICAgdGhyb3cgbmV3IGFkZHJlc3NfZXJyb3JfMS5BZGRyZXNzRXJyb3IoJ0Vycm9yIHBhcnNpbmcgZ3JvdXBzJyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWxpZGVkR3JvdXBzID0gcmVtYWluaW5nOwogICAgICAgIHRoaXMuZWxpc2lvbkJlZ2luID0gZmlyc3QubGVuZ3RoOwogICAgICAgIHRoaXMuZWxpc2lvbkVuZCA9IGZpcnN0Lmxlbmd0aCArIHRoaXMuZWxpZGVkR3JvdXBzOwogICAgICAgIGdyb3VwcyA9IGdyb3Vwcy5jb25jYXQoZmlyc3QpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVtYWluaW5nOyBpKyspIHsKICAgICAgICAgIGdyb3Vwcy5wdXNoKCcwJyk7CiAgICAgICAgfQogICAgICAgIGdyb3VwcyA9IGdyb3Vwcy5jb25jYXQobGFzdCk7CiAgICAgIH0gZWxzZSBpZiAoaGFsdmVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGdyb3VwcyA9IGFkZHJlc3Muc3BsaXQoJzonKTsKICAgICAgICB0aGlzLmVsaWRlZEdyb3VwcyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IGFkZHJlc3NfZXJyb3JfMS5BZGRyZXNzRXJyb3IoJ1RvbyBtYW55IDo6IGdyb3VwcyBmb3VuZCcpOwogICAgICB9CiAgICAgIGdyb3VwcyA9IGdyb3Vwcy5tYXAoZ3JvdXAgPT4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnJXgnLCBwYXJzZUludChncm91cCwgMTYpKSk7CiAgICAgIGlmIChncm91cHMubGVuZ3RoICE9PSB0aGlzLmdyb3VwcykgewogICAgICAgIHRocm93IG5ldyBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yKCdJbmNvcnJlY3QgbnVtYmVyIG9mIGdyb3VwcyBmb3VuZCcpOwogICAgICB9CiAgICAgIHJldHVybiBncm91cHM7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiB0aGUgY2Fub25pY2FsIGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICBjYW5vbmljYWxGb3JtKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJzZWRBZGRyZXNzLm1hcChwYWRkZWRIZXgpLmpvaW4oJzonKTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBkZWNpbWFsIGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICBkZWNpbWFsKCkgewogICAgICByZXR1cm4gdGhpcy5wYXJzZWRBZGRyZXNzLm1hcChuID0+ICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyUwNWQnLCBwYXJzZUludChuLCAxNikpKS5qb2luKCc6Jyk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiB0aGUgYWRkcmVzcyBhcyBhIEJpZ0ludGVnZXIKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QmlnSW50ZWdlcn0KICAgICAqLwogICAgYmlnSW50ZWdlcigpIHsKICAgICAgcmV0dXJuIG5ldyBqc2JuXzEuQmlnSW50ZWdlcih0aGlzLnBhcnNlZEFkZHJlc3MubWFwKHBhZGRlZEhleCkuam9pbignJyksIDE2KTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIHRoZSBsYXN0IHR3byBncm91cHMgb2YgdGhpcyBhZGRyZXNzIGFzIGFuIElQdjQgYWRkcmVzcyBzdHJpbmcKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczR9CiAgICAgKiBAZXhhbXBsZQogICAgICogdmFyIGFkZHJlc3MgPSBuZXcgQWRkcmVzczYoJzIwMDE6NDg2MDo0MDAxOjoxODI1OmJmMTEnKTsKICAgICAqIGFkZHJlc3MudG80KCkuY29ycmVjdEZvcm0oKTsgLy8gJzI0LjM3LjE5MS4xNycKICAgICAqLwogICAgdG80KCkgewogICAgICBjb25zdCBiaW5hcnkgPSB0aGlzLmJpbmFyeVplcm9QYWQoKS5zcGxpdCgnJyk7CiAgICAgIHJldHVybiBpcHY0XzEuQWRkcmVzczQuZnJvbUhleChuZXcganNibl8xLkJpZ0ludGVnZXIoYmluYXJ5LnNsaWNlKDk2LCAxMjgpLmpvaW4oJycpLCAyKS50b1N0cmluZygxNikpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gdGhlIHY0LWluLXY2IGZvcm0gb2YgdGhlIGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCiAgICB0bzRpbjYoKSB7CiAgICAgIGNvbnN0IGFkZHJlc3M0ID0gdGhpcy50bzQoKTsKICAgICAgY29uc3QgYWRkcmVzczYgPSBuZXcgQWRkcmVzczYodGhpcy5wYXJzZWRBZGRyZXNzLnNsaWNlKDAsIDYpLmpvaW4oJzonKSwgNik7CiAgICAgIGNvbnN0IGNvcnJlY3QgPSBhZGRyZXNzNi5jb3JyZWN0Rm9ybSgpOwogICAgICBsZXQgaW5maXggPSAnJzsKICAgICAgaWYgKCEvOiQvLnRlc3QoY29ycmVjdCkpIHsKICAgICAgICBpbmZpeCA9ICc6JzsKICAgICAgfQogICAgICByZXR1cm4gY29ycmVjdCArIGluZml4ICsgYWRkcmVzczQuYWRkcmVzczsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBUZXJlZG8gcHJvcGVydGllcyBvZiB0aGUgYWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICAgKi8KICAgIGluc3BlY3RUZXJlZG8oKSB7CiAgICAgIC8qCiAgICAgIC0gQml0cyAwIHRvIDMxIGFyZSBzZXQgdG8gdGhlIFRlcmVkbyBwcmVmaXggKG5vcm1hbGx5IDIwMDE6MDAwMDo6LzMyKS4KICAgICAgLSBCaXRzIDMyIHRvIDYzIGVtYmVkIHRoZSBwcmltYXJ5IElQdjQgYWRkcmVzcyBvZiB0aGUgVGVyZWRvIHNlcnZlciB0aGF0CiAgICAgICAgaXMgdXNlZC4KICAgICAgLSBCaXRzIDY0IHRvIDc5IGNhbiBiZSB1c2VkIHRvIGRlZmluZSBzb21lIGZsYWdzLiBDdXJyZW50bHkgb25seSB0aGUKICAgICAgICBoaWdoZXIgb3JkZXIgYml0IGlzIHVzZWQ7IGl0IGlzIHNldCB0byAxIGlmIHRoZSBUZXJlZG8gY2xpZW50IGlzCiAgICAgICAgbG9jYXRlZCBiZWhpbmQgYSBjb25lIE5BVCwgMCBvdGhlcndpc2UuIEZvciBNaWNyb3NvZnQncyBXaW5kb3dzIFZpc3RhCiAgICAgICAgYW5kIFdpbmRvd3MgU2VydmVyIDIwMDggaW1wbGVtZW50YXRpb25zLCBtb3JlIGJpdHMgYXJlIHVzZWQuIEluIHRob3NlCiAgICAgICAgaW1wbGVtZW50YXRpb25zLCB0aGUgZm9ybWF0IGZvciB0aGVzZSAxNiBiaXRzIGlzICJDUkFBQUFVRyBBQUFBQUFBQSIsCiAgICAgICAgd2hlcmUgIkMiIHJlbWFpbnMgdGhlICJDb25lIiBmbGFnLiBUaGUgIlIiIGJpdCBpcyByZXNlcnZlZCBmb3IgZnV0dXJlCiAgICAgICAgdXNlLiBUaGUgIlUiIGJpdCBpcyBmb3IgdGhlIFVuaXZlcnNhbC9Mb2NhbCBmbGFnIChzZXQgdG8gMCkuIFRoZSAiRyIgYml0CiAgICAgICAgaXMgSW5kaXZpZHVhbC9Hcm91cCBmbGFnIChzZXQgdG8gMCkuIFRoZSBBIGJpdHMgYXJlIHNldCB0byBhIDEyLWJpdAogICAgICAgIHJhbmRvbWx5IGdlbmVyYXRlZCBudW1iZXIgY2hvc2VuIGJ5IHRoZSBUZXJlZG8gY2xpZW50IHRvIGludHJvZHVjZQogICAgICAgIGFkZGl0aW9uYWwgcHJvdGVjdGlvbiBmb3IgdGhlIFRlcmVkbyBub2RlIGFnYWluc3QgSVB2Ni1iYXNlZCBzY2FubmluZwogICAgICAgIGF0dGFja3MuCiAgICAgIC0gQml0cyA4MCB0byA5NSBjb250YWlucyB0aGUgb2JmdXNjYXRlZCBVRFAgcG9ydCBudW1iZXIuIFRoaXMgaXMgdGhlCiAgICAgICAgcG9ydCBudW1iZXIgdGhhdCBpcyBtYXBwZWQgYnkgdGhlIE5BVCB0byB0aGUgVGVyZWRvIGNsaWVudCB3aXRoIGFsbAogICAgICAgIGJpdHMgaW52ZXJ0ZWQuCiAgICAgIC0gQml0cyA5NiB0byAxMjcgY29udGFpbnMgdGhlIG9iZnVzY2F0ZWQgSVB2NCBhZGRyZXNzLiBUaGlzIGlzIHRoZQogICAgICAgIHB1YmxpYyBJUHY0IGFkZHJlc3Mgb2YgdGhlIE5BVCB3aXRoIGFsbCBiaXRzIGludmVydGVkLgogICAgICAqLwogICAgICBjb25zdCBwcmVmaXggPSB0aGlzLmdldEJpdHNCYXNlMTYoMCwgMzIpOwogICAgICBjb25zdCB1ZHBQb3J0ID0gdGhpcy5nZXRCaXRzKDgwLCA5NikueG9yKG5ldyBqc2JuXzEuQmlnSW50ZWdlcignZmZmZicsIDE2KSkudG9TdHJpbmcoKTsKICAgICAgY29uc3Qgc2VydmVyNCA9IGlwdjRfMS5BZGRyZXNzNC5mcm9tSGV4KHRoaXMuZ2V0Qml0c0Jhc2UxNigzMiwgNjQpKTsKICAgICAgY29uc3QgY2xpZW50NCA9IGlwdjRfMS5BZGRyZXNzNC5mcm9tSGV4KHRoaXMuZ2V0Qml0cyg5NiwgMTI4KS54b3IobmV3IGpzYm5fMS5CaWdJbnRlZ2VyKCdmZmZmZmZmZicsIDE2KSkudG9TdHJpbmcoMTYpKTsKICAgICAgY29uc3QgZmxhZ3MgPSB0aGlzLmdldEJpdHMoNjQsIDgwKTsKICAgICAgY29uc3QgZmxhZ3NCYXNlMiA9IHRoaXMuZ2V0Qml0c0Jhc2UyKDY0LCA4MCk7CiAgICAgIGNvbnN0IGNvbmVOYXQgPSBmbGFncy50ZXN0Qml0KDE1KTsKICAgICAgY29uc3QgcmVzZXJ2ZWQgPSBmbGFncy50ZXN0Qml0KDE0KTsKICAgICAgY29uc3QgZ3JvdXBJbmRpdmlkdWFsID0gZmxhZ3MudGVzdEJpdCg4KTsKICAgICAgY29uc3QgdW5pdmVyc2FsTG9jYWwgPSBmbGFncy50ZXN0Qml0KDkpOwogICAgICBjb25zdCBub25jZSA9IG5ldyBqc2JuXzEuQmlnSW50ZWdlcihmbGFnc0Jhc2UyLnNsaWNlKDIsIDYpICsgZmxhZ3NCYXNlMi5zbGljZSg4LCAxNiksIDIpLnRvU3RyaW5nKDEwKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmVmaXg6ICgwLCBzcHJpbnRmX2pzXzEuc3ByaW50ZikoJyVzOiVzJywgcHJlZml4LnNsaWNlKDAsIDQpLCBwcmVmaXguc2xpY2UoNCwgOCkpLAogICAgICAgIHNlcnZlcjQ6IHNlcnZlcjQuYWRkcmVzcywKICAgICAgICBjbGllbnQ0OiBjbGllbnQ0LmFkZHJlc3MsCiAgICAgICAgZmxhZ3M6IGZsYWdzQmFzZTIsCiAgICAgICAgY29uZU5hdCwKICAgICAgICBtaWNyb3NvZnQ6IHsKICAgICAgICAgIHJlc2VydmVkLAogICAgICAgICAgdW5pdmVyc2FsTG9jYWwsCiAgICAgICAgICBncm91cEluZGl2aWR1YWwsCiAgICAgICAgICBub25jZQogICAgICAgIH0sCiAgICAgICAgdWRwUG9ydAogICAgICB9OwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIDZ0bzQgcHJvcGVydGllcyBvZiB0aGUgYWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtPYmplY3R9CiAgICAgKi8KICAgIGluc3BlY3Q2dG80KCkgewogICAgICAvKgogICAgICAtIEJpdHMgMCB0byAxNSBhcmUgc2V0IHRvIHRoZSA2dG80IHByZWZpeCAoMjAwMjo6LzE2KS4KICAgICAgLSBCaXRzIDE2IHRvIDQ4IGVtYmVkIHRoZSBJUHY0IGFkZHJlc3Mgb2YgdGhlIDZ0bzQgZ2F0ZXdheSB0aGF0IGlzIHVzZWQuCiAgICAgICovCiAgICAgIGNvbnN0IHByZWZpeCA9IHRoaXMuZ2V0Qml0c0Jhc2UxNigwLCAxNik7CiAgICAgIGNvbnN0IGdhdGV3YXkgPSBpcHY0XzEuQWRkcmVzczQuZnJvbUhleCh0aGlzLmdldEJpdHNCYXNlMTYoMTYsIDQ4KSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJlZml4OiAoMCwgc3ByaW50Zl9qc18xLnNwcmludGYpKCclcycsIHByZWZpeC5zbGljZSgwLCA0KSksCiAgICAgICAgZ2F0ZXdheTogZ2F0ZXdheS5hZGRyZXNzCiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiBhIHY2IDZ0bzQgYWRkcmVzcyBmcm9tIGEgdjYgdjRpbnY2IGFkZHJlc3MKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7QWRkcmVzczZ9CiAgICAgKi8KICAgIHRvNnRvNCgpIHsKICAgICAgaWYgKCF0aGlzLmlzNCgpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgYWRkcjZ0bzQgPSBbJzIwMDInLCB0aGlzLmdldEJpdHNCYXNlMTYoOTYsIDExMiksIHRoaXMuZ2V0Qml0c0Jhc2UxNigxMTIsIDEyOCksICcnLCAnLzE2J10uam9pbignOicpOwogICAgICByZXR1cm4gbmV3IEFkZHJlc3M2KGFkZHI2dG80KTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJuIGEgYnl0ZSBhcnJheQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtBcnJheX0KICAgICAqLwogICAgdG9CeXRlQXJyYXkoKSB7CiAgICAgIGNvbnN0IGJ5dGVBcnJheSA9IHRoaXMuYmlnSW50ZWdlcigpLnRvQnl0ZUFycmF5KCk7CiAgICAgIC8vIHdvcmsgYXJvdW5kIGlzc3VlIHdoZXJlIGB0b0J5dGVBcnJheWAgcmV0dXJucyBhIGxlYWRpbmcgMCBlbGVtZW50CiAgICAgIGlmIChieXRlQXJyYXkubGVuZ3RoID09PSAxNyAmJiBieXRlQXJyYXlbMF0gPT09IDApIHsKICAgICAgICByZXR1cm4gYnl0ZUFycmF5LnNsaWNlKDEpOwogICAgICB9CiAgICAgIHJldHVybiBieXRlQXJyYXk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybiBhbiB1bnNpZ25lZCBieXRlIGFycmF5CiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge0FycmF5fQogICAgICovCiAgICB0b1Vuc2lnbmVkQnl0ZUFycmF5KCkgewogICAgICByZXR1cm4gdGhpcy50b0J5dGVBcnJheSgpLm1hcCh1bnNpZ25CeXRlKTsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIGJ5dGUgYXJyYXkgdG8gYW4gQWRkcmVzczYgb2JqZWN0CiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBzdGF0aWMKICAgICAqIEByZXR1cm5zIHtBZGRyZXNzNn0KICAgICAqLwogICAgc3RhdGljIGZyb21CeXRlQXJyYXkoYnl0ZXMpIHsKICAgICAgcmV0dXJuIHRoaXMuZnJvbVVuc2lnbmVkQnl0ZUFycmF5KGJ5dGVzLm1hcCh1bnNpZ25CeXRlKSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgYW4gdW5zaWduZWQgYnl0ZSBhcnJheSB0byBhbiBBZGRyZXNzNiBvYmplY3QKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQHN0YXRpYwogICAgICogQHJldHVybnMge0FkZHJlc3M2fQogICAgICovCiAgICBzdGF0aWMgZnJvbVVuc2lnbmVkQnl0ZUFycmF5KGJ5dGVzKSB7CiAgICAgIGNvbnN0IEJZVEVfTUFYID0gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKCcyNTYnLCAxMCk7CiAgICAgIGxldCByZXN1bHQgPSBuZXcganNibl8xLkJpZ0ludGVnZXIoJzAnLCAxMCk7CiAgICAgIGxldCBtdWx0aXBsaWVyID0gbmV3IGpzYm5fMS5CaWdJbnRlZ2VyKCcxJywgMTApOwogICAgICBmb3IgKGxldCBpID0gYnl0ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICByZXN1bHQgPSByZXN1bHQuYWRkKG11bHRpcGxpZXIubXVsdGlwbHkobmV3IGpzYm5fMS5CaWdJbnRlZ2VyKGJ5dGVzW2ldLnRvU3RyaW5nKDEwKSwgMTApKSk7CiAgICAgICAgbXVsdGlwbGllciA9IG11bHRpcGxpZXIubXVsdGlwbHkoQllURV9NQVgpOwogICAgICB9CiAgICAgIHJldHVybiBBZGRyZXNzNi5mcm9tQmlnSW50ZWdlcihyZXN1bHQpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGFkZHJlc3MgaXMgaW4gdGhlIGNhbm9uaWNhbCBmb3JtLCBmYWxzZSBvdGhlcndpc2UKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgICAqLwogICAgaXNDYW5vbmljYWwoKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZHJlc3NNaW51c1N1ZmZpeCA9PT0gdGhpcy5jYW5vbmljYWxGb3JtKCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYWRkcmVzcyBpcyBhIGxpbmsgbG9jYWwgYWRkcmVzcywgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICAgKi8KICAgIGlzTGlua0xvY2FsKCkgewogICAgICAvLyBaZXJvZXMgYXJlIHJlcXVpcmVkLCBpLmUuIHdlIGNhbid0IGNoZWNrIGlzSW5TdWJuZXQgd2l0aCAnZmU4MDo6LzEwJwogICAgICBpZiAodGhpcy5nZXRCaXRzQmFzZTIoMCwgNjQpID09PSAnMTExMTExMTAxMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMCcpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYWRkcmVzcyBpcyBhIG11bHRpY2FzdCBhZGRyZXNzLCBmYWxzZSBvdGhlcndpc2UKICAgICAqIEBtZW1iZXJvZiBBZGRyZXNzNgogICAgICogQGluc3RhbmNlCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0KICAgICAqLwogICAgaXNNdWx0aWNhc3QoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFR5cGUoKSA9PT0gJ011bHRpY2FzdCc7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYWRkcmVzcyBpcyBhIHY0LWluLXY2IGFkZHJlc3MsIGZhbHNlIG90aGVyd2lzZQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICovCiAgICBpczQoKSB7CiAgICAgIHJldHVybiB0aGlzLnY0OwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGFkZHJlc3MgaXMgYSBUZXJlZG8gYWRkcmVzcywgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgKiBAbWVtYmVyb2YgQWRkcmVzczYKICAgICAqIEBpbnN0YW5jZQogICAgICogQHJldHVybnMge2Jvb2xlYW59CiAgICAgKi8KICAgIGlzVGVyZWRvKCkgewogICAgICByZXR1cm4gdGhpcy5pc0luU3VibmV0KG5ldyBBZGRyZXNzNignMjAwMTo6LzMyJykpOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGFkZHJlc3MgaXMgYSA2dG80IGFkZHJlc3MsIGZhbHNlIG90aGVyd2lzZQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICovCiAgICBpczZ0bzQoKSB7CiAgICAgIHJldHVybiB0aGlzLmlzSW5TdWJuZXQobmV3IEFkZHJlc3M2KCcyMDAyOjovMTYnKSk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYWRkcmVzcyBpcyBhIGxvb3BiYWNrIGFkZHJlc3MsIGZhbHNlIG90aGVyd2lzZQogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEByZXR1cm5zIHtib29sZWFufQogICAgICovCiAgICBpc0xvb3BiYWNrKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRUeXBlKCkgPT09ICdMb29wYmFjayc7CiAgICB9CiAgICAvLyAjZW5kcmVnaW9uCiAgICAvLyAjcmVnaW9uIEhUTUwKICAgIC8qKgogICAgICogQHJldHVybnMge1N0cmluZ30gdGhlIGFkZHJlc3MgaW4gbGluayBmb3JtIHdpdGggYSBkZWZhdWx0IHBvcnQgb2YgODAKICAgICAqLwogICAgaHJlZihvcHRpb25hbFBvcnQpIHsKICAgICAgaWYgKG9wdGlvbmFsUG9ydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgb3B0aW9uYWxQb3J0ID0gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3B0aW9uYWxQb3J0ID0gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnOiVzJywgb3B0aW9uYWxQb3J0KTsKICAgICAgfQogICAgICByZXR1cm4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnaHR0cDovL1slc10lcy8nLCB0aGlzLmNvcnJlY3RGb3JtKCksIG9wdGlvbmFsUG9ydCk7CiAgICB9CiAgICAvKioKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IGEgbGluayBzdWl0YWJsZSBmb3IgY29udmV5aW5nIHRoZSBhZGRyZXNzIHZpYSBhIFVSTCBoYXNoCiAgICAgKi8KICAgIGxpbmsob3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMuY2xhc3NOYW1lID09PSB1bmRlZmluZWQpIHsKICAgICAgICBvcHRpb25zLmNsYXNzTmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zLnByZWZpeCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgb3B0aW9ucy5wcmVmaXggPSAnLyNhZGRyZXNzPSc7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudjQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIG9wdGlvbnMudjQgPSBmYWxzZTsKICAgICAgfQogICAgICBsZXQgZm9ybUZ1bmN0aW9uID0gdGhpcy5jb3JyZWN0Rm9ybTsKICAgICAgaWYgKG9wdGlvbnMudjQpIHsKICAgICAgICBmb3JtRnVuY3Rpb24gPSB0aGlzLnRvNGluNjsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5jbGFzc05hbWUpIHsKICAgICAgICByZXR1cm4gKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnPGEgaHJlZj0iJTEkcyUyJHMiIGNsYXNzPSIlMyRzIj4lMiRzPC9hPicsIG9wdGlvbnMucHJlZml4LCBmb3JtRnVuY3Rpb24uY2FsbCh0aGlzKSwgb3B0aW9ucy5jbGFzc05hbWUpOwogICAgICB9CiAgICAgIHJldHVybiAoMCwgc3ByaW50Zl9qc18xLnNwcmludGYpKCc8YSBocmVmPSIlMSRzJTIkcyI+JTIkczwvYT4nLCBvcHRpb25zLnByZWZpeCwgZm9ybUZ1bmN0aW9uLmNhbGwodGhpcykpOwogICAgfQogICAgLyoqCiAgICAgKiBHcm91cHMgYW4gYWRkcmVzcwogICAgICogQHJldHVybnMge1N0cmluZ30KICAgICAqLwogICAgZ3JvdXAoKSB7CiAgICAgIGlmICh0aGlzLmVsaWRlZEdyb3VwcyA9PT0gMCkgewogICAgICAgIC8vIFRoZSBzaW1wbGUgY2FzZQogICAgICAgIHJldHVybiBoZWxwZXJzLnNpbXBsZUdyb3VwKHRoaXMuYWRkcmVzcykuam9pbignOicpOwogICAgICB9CiAgICAgIGFzc2VydCh0eXBlb2YgdGhpcy5lbGlkZWRHcm91cHMgPT09ICdudW1iZXInKTsKICAgICAgYXNzZXJ0KHR5cGVvZiB0aGlzLmVsaXNpb25CZWdpbiA9PT0gJ251bWJlcicpOwogICAgICAvLyBUaGUgZWxpZGVkIGNhc2UKICAgICAgY29uc3Qgb3V0cHV0ID0gW107CiAgICAgIGNvbnN0IFtsZWZ0LCByaWdodF0gPSB0aGlzLmFkZHJlc3Muc3BsaXQoJzo6Jyk7CiAgICAgIGlmIChsZWZ0Lmxlbmd0aCkgewogICAgICAgIG91dHB1dC5wdXNoKC4uLmhlbHBlcnMuc2ltcGxlR3JvdXAobGVmdCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKCcnKTsKICAgICAgfQogICAgICBjb25zdCBjbGFzc2VzID0gWydob3Zlci1ncm91cCddOwogICAgICBmb3IgKGxldCBpID0gdGhpcy5lbGlzaW9uQmVnaW47IGkgPCB0aGlzLmVsaXNpb25CZWdpbiArIHRoaXMuZWxpZGVkR3JvdXBzOyBpKyspIHsKICAgICAgICBjbGFzc2VzLnB1c2goKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnZ3JvdXAtJWQnLCBpKSk7CiAgICAgIH0KICAgICAgb3V0cHV0LnB1c2goKDAsIHNwcmludGZfanNfMS5zcHJpbnRmKSgnPHNwYW4gY2xhc3M9IiVzIj48L3NwYW4+JywgY2xhc3Nlcy5qb2luKCcgJykpKTsKICAgICAgaWYgKHJpZ2h0Lmxlbmd0aCkgewogICAgICAgIG91dHB1dC5wdXNoKC4uLmhlbHBlcnMuc2ltcGxlR3JvdXAocmlnaHQsIHRoaXMuZWxpc2lvbkVuZCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKCcnKTsKICAgICAgfQogICAgICBpZiAodGhpcy5pczQoKSkgewogICAgICAgIGFzc2VydCh0aGlzLmFkZHJlc3M0IGluc3RhbmNlb2YgaXB2NF8xLkFkZHJlc3M0KTsKICAgICAgICBvdXRwdXQucG9wKCk7CiAgICAgICAgb3V0cHV0LnB1c2godGhpcy5hZGRyZXNzNC5ncm91cEZvclY2KCkpOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignOicpOwogICAgfQogICAgLy8gI2VuZHJlZ2lvbgogICAgLy8gI3JlZ2lvbiBSZWd1bGFyIGV4cHJlc3Npb25zCiAgICAvKioKICAgICAqIEdlbmVyYXRlIGEgcmVndWxhciBleHByZXNzaW9uIHN0cmluZyB0aGF0IGNhbiBiZSB1c2VkIHRvIGZpbmQgb3IgdmFsaWRhdGUKICAgICAqIGFsbCB2YXJpYXRpb25zIG9mIHRoaXMgYWRkcmVzcwogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc3Vic3RyaW5nU2VhcmNoCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfQogICAgICovCiAgICByZWd1bGFyRXhwcmVzc2lvblN0cmluZyhzdWJzdHJpbmdTZWFyY2ggPSBmYWxzZSkgewogICAgICBsZXQgb3V0cHV0ID0gW107CiAgICAgIC8vIFRPRE86IHJldmlzaXQgd2h5IHRoaXMgaXMgbmVjZXNzYXJ5CiAgICAgIGNvbnN0IGFkZHJlc3M2ID0gbmV3IEFkZHJlc3M2KHRoaXMuY29ycmVjdEZvcm0oKSk7CiAgICAgIGlmIChhZGRyZXNzNi5lbGlkZWRHcm91cHMgPT09IDApIHsKICAgICAgICAvLyBUaGUgc2ltcGxlIGNhc2UKICAgICAgICBvdXRwdXQucHVzaCgoMCwgcmVndWxhcl9leHByZXNzaW9uc18xLnNpbXBsZVJlZ3VsYXJFeHByZXNzaW9uKShhZGRyZXNzNi5wYXJzZWRBZGRyZXNzKSk7CiAgICAgIH0gZWxzZSBpZiAoYWRkcmVzczYuZWxpZGVkR3JvdXBzID09PSBjb25zdGFudHM2LkdST1VQUykgewogICAgICAgIC8vIEEgY29tcGxldGVseSBlbGlkZWQgYWRkcmVzcwogICAgICAgIG91dHB1dC5wdXNoKCgwLCByZWd1bGFyX2V4cHJlc3Npb25zXzEucG9zc2libGVFbGlzaW9ucykoY29uc3RhbnRzNi5HUk9VUFMpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBBIHBhcnRpYWxseSBlbGlkZWQgYWRkcmVzcwogICAgICAgIGNvbnN0IGhhbHZlcyA9IGFkZHJlc3M2LmFkZHJlc3Muc3BsaXQoJzo6Jyk7CiAgICAgICAgaWYgKGhhbHZlc1swXS5sZW5ndGgpIHsKICAgICAgICAgIG91dHB1dC5wdXNoKCgwLCByZWd1bGFyX2V4cHJlc3Npb25zXzEuc2ltcGxlUmVndWxhckV4cHJlc3Npb24pKGhhbHZlc1swXS5zcGxpdCgnOicpKSk7CiAgICAgICAgfQogICAgICAgIGFzc2VydCh0eXBlb2YgYWRkcmVzczYuZWxpZGVkR3JvdXBzID09PSAnbnVtYmVyJyk7CiAgICAgICAgb3V0cHV0LnB1c2goKDAsIHJlZ3VsYXJfZXhwcmVzc2lvbnNfMS5wb3NzaWJsZUVsaXNpb25zKShhZGRyZXNzNi5lbGlkZWRHcm91cHMsIGhhbHZlc1swXS5sZW5ndGggIT09IDAsIGhhbHZlc1sxXS5sZW5ndGggIT09IDApKTsKICAgICAgICBpZiAoaGFsdmVzWzFdLmxlbmd0aCkgewogICAgICAgICAgb3V0cHV0LnB1c2goKDAsIHJlZ3VsYXJfZXhwcmVzc2lvbnNfMS5zaW1wbGVSZWd1bGFyRXhwcmVzc2lvbikoaGFsdmVzWzFdLnNwbGl0KCc6JykpKTsKICAgICAgICB9CiAgICAgICAgb3V0cHV0ID0gW291dHB1dC5qb2luKCc6JyldOwogICAgICB9CiAgICAgIGlmICghc3Vic3RyaW5nU2VhcmNoKSB7CiAgICAgICAgb3V0cHV0ID0gWycoPz1efCcsIHJlZ3VsYXJfZXhwcmVzc2lvbnNfMS5BRERSRVNTX0JPVU5EQVJZLCAnfFteXFx3XFw6XSkoJywgLi4ub3V0cHV0LCAnKSg/PVteXFx3XFw6XXwnLCByZWd1bGFyX2V4cHJlc3Npb25zXzEuQUREUkVTU19CT1VOREFSWSwgJ3wkKSddOwogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9CiAgICAvKioKICAgICAqIEdlbmVyYXRlIGEgcmVndWxhciBleHByZXNzaW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gZmluZCBvciB2YWxpZGF0ZSBhbGwKICAgICAqIHZhcmlhdGlvbnMgb2YgdGhpcyBhZGRyZXNzLgogICAgICogQG1lbWJlcm9mIEFkZHJlc3M2CiAgICAgKiBAaW5zdGFuY2UKICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc3Vic3RyaW5nU2VhcmNoCiAgICAgKiBAcmV0dXJucyB7UmVnRXhwfQogICAgICovCiAgICByZWd1bGFyRXhwcmVzc2lvbihzdWJzdHJpbmdTZWFyY2ggPSBmYWxzZSkgewogICAgICByZXR1cm4gbmV3IFJlZ0V4cCh0aGlzLnJlZ3VsYXJFeHByZXNzaW9uU3RyaW5nKHN1YnN0cmluZ1NlYXJjaCksICdpJyk7CiAgICB9CiAgfQogIGlwdjYuQWRkcmVzczYgPSBBZGRyZXNzNjsKICByZXR1cm4gaXB2NjsKfQoKdmFyIGhhc1JlcXVpcmVkSXBBZGRyZXNzOwpmdW5jdGlvbiByZXF1aXJlSXBBZGRyZXNzKCkgewogIGlmIChoYXNSZXF1aXJlZElwQWRkcmVzcykgcmV0dXJuIGlwQWRkcmVzczsKICBoYXNSZXF1aXJlZElwQWRkcmVzcyA9IDE7CiAgKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogICAgdmFyIF9fY3JlYXRlQmluZGluZyA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobSwgayk7CiAgICAgIGlmICghZGVzYyB8fCAoImdldCIgaW4gZGVzYyA/ICFtLl9fZXNNb2R1bGUgOiBkZXNjLndyaXRhYmxlIHx8IGRlc2MuY29uZmlndXJhYmxlKSkgewogICAgICAgIGRlc2MgPSB7CiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCBkZXNjKTsKICAgIH0gOiBmdW5jdGlvbiAobywgbSwgaywgazIpIHsKICAgICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgICAgb1trMl0gPSBtW2tdOwogICAgfSk7CiAgICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sICJkZWZhdWx0IiwgewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IHYKICAgICAgfSk7CiAgICB9IDogZnVuY3Rpb24gKG8sIHYpIHsKICAgICAgb1siZGVmYXVsdCJdID0gdjsKICAgIH0pOwogICAgdmFyIF9faW1wb3J0U3RhciA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0U3RhciB8fCBmdW5jdGlvbiAobW9kKSB7CiAgICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaWYgKG1vZCAhPSBudWxsKSBmb3IgKHZhciBrIGluIG1vZCkgaWYgKGsgIT09ICJkZWZhdWx0IiAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobW9kLCBrKSkgX19jcmVhdGVCaW5kaW5nKHJlc3VsdCwgbW9kLCBrKTsKICAgICAgX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKICAgIGV4cG9ydHMudjYgPSBleHBvcnRzLkFkZHJlc3NFcnJvciA9IGV4cG9ydHMuQWRkcmVzczYgPSBleHBvcnRzLkFkZHJlc3M0ID0gdm9pZCAwOwogICAgY29uc3QgaXB2NF8xID0gcmVxdWlyZUlwdjQoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiQWRkcmVzczQiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBpcHY0XzEuQWRkcmVzczQ7CiAgICAgIH0KICAgIH0pOwogICAgY29uc3QgaXB2Nl8xID0gcmVxdWlyZUlwdjYoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiQWRkcmVzczYiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBpcHY2XzEuQWRkcmVzczY7CiAgICAgIH0KICAgIH0pOwogICAgY29uc3QgYWRkcmVzc19lcnJvcl8xID0gcmVxdWlyZUFkZHJlc3NFcnJvcigpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJBZGRyZXNzRXJyb3IiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBhZGRyZXNzX2Vycm9yXzEuQWRkcmVzc0Vycm9yOwogICAgICB9CiAgICB9KTsKICAgIGNvbnN0IGhlbHBlcnMgPSBfX2ltcG9ydFN0YXIocmVxdWlyZUhlbHBlcnMkMSgpKTsKICAgIGV4cG9ydHMudjYgPSB7CiAgICAgIGhlbHBlcnMKICAgIH07CiAgfSkoaXBBZGRyZXNzKTsKICByZXR1cm4gaXBBZGRyZXNzOwp9Cgp2YXIgaGFzUmVxdWlyZWRIZWxwZXJzOwpmdW5jdGlvbiByZXF1aXJlSGVscGVycygpIHsKICBpZiAoaGFzUmVxdWlyZWRIZWxwZXJzKSByZXR1cm4gaGVscGVycyQxOwogIGhhc1JlcXVpcmVkSGVscGVycyA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGhlbHBlcnMkMSwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGhlbHBlcnMkMS5pcFRvQnVmZmVyID0gaGVscGVycyQxLmludDMyVG9JcHY0ID0gaGVscGVycyQxLmlwdjRUb0ludDMyID0gaGVscGVycyQxLnZhbGlkYXRlU29ja3NDbGllbnRDaGFpbk9wdGlvbnMgPSBoZWxwZXJzJDEudmFsaWRhdGVTb2Nrc0NsaWVudE9wdGlvbnMgPSB2b2lkIDA7CiAgY29uc3QgdXRpbF8xID0gcmVxdWlyZVV0aWwoKTsKICBjb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmVDb25zdGFudHMkMigpOwogIGNvbnN0IHN0cmVhbSA9IHJlcXVpcmUkJDAkNDsKICBjb25zdCBpcF9hZGRyZXNzXzEgPSByZXF1aXJlSXBBZGRyZXNzKCk7CiAgY29uc3QgbmV0ID0gcmVxdWlyZSQkMSQ0OwogIC8qKgogICAqIFZhbGlkYXRlcyB0aGUgcHJvdmlkZWQgU29ja3NDbGllbnRPcHRpb25zCiAgICogQHBhcmFtIG9wdGlvbnMgeyBTb2Nrc0NsaWVudE9wdGlvbnMgfQogICAqIEBwYXJhbSBhY2NlcHRlZENvbW1hbmRzIHsgc3RyaW5nW10gfSBBIGxpc3Qgb2YgYWNjZXB0ZWQgU29ja3NQcm94eSBjb21tYW5kcy4KICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZVNvY2tzQ2xpZW50T3B0aW9ucyhvcHRpb25zLCBhY2NlcHRlZENvbW1hbmRzID0gWydjb25uZWN0JywgJ2JpbmQnLCAnYXNzb2NpYXRlJ10pIHsKICAgIC8vIENoZWNrIFNPQ0tzIGNvbW1hbmQgb3B0aW9uLgogICAgaWYgKCFjb25zdGFudHNfMS5Tb2Nrc0NvbW1hbmRbb3B0aW9ucy5jb21tYW5kXSkgewogICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NvbW1hbmQsIG9wdGlvbnMpOwogICAgfQogICAgLy8gQ2hlY2sgU29ja3NDb21tYW5kIGZvciBhY2NlcHRhYmxlIGNvbW1hbmQuCiAgICBpZiAoYWNjZXB0ZWRDb21tYW5kcy5pbmRleE9mKG9wdGlvbnMuY29tbWFuZCkgPT09IC0xKSB7CiAgICAgIHRocm93IG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihjb25zdGFudHNfMS5FUlJPUlMuSW52YWxpZFNvY2tzQ29tbWFuZEZvck9wZXJhdGlvbiwgb3B0aW9ucyk7CiAgICB9CiAgICAvLyBDaGVjayBkZXN0aW5hdGlvbgogICAgaWYgKCFpc1ZhbGlkU29ja3NSZW1vdGVIb3N0KG9wdGlvbnMuZGVzdGluYXRpb24pKSB7CiAgICAgIHRocm93IG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihjb25zdGFudHNfMS5FUlJPUlMuSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc0Rlc3RpbmF0aW9uLCBvcHRpb25zKTsKICAgIH0KICAgIC8vIENoZWNrIFNPQ0tTIHByb3h5IHRvIHVzZQogICAgaWYgKCFpc1ZhbGlkU29ja3NQcm94eShvcHRpb25zLnByb3h5KSkgewogICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNQcm94eSwgb3B0aW9ucyk7CiAgICB9CiAgICAvLyBWYWxpZGF0ZSBjdXN0b20gYXV0aCAoaWYgc2V0KQogICAgdmFsaWRhdGVDdXN0b21Qcm94eUF1dGgob3B0aW9ucy5wcm94eSwgb3B0aW9ucyk7CiAgICAvLyBDaGVjayB0aW1lb3V0CiAgICBpZiAob3B0aW9ucy50aW1lb3V0ICYmICFpc1ZhbGlkVGltZW91dFZhbHVlKG9wdGlvbnMudGltZW91dCkpIHsKICAgICAgdGhyb3cgbmV3IHV0aWxfMS5Tb2Nrc0NsaWVudEVycm9yKGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3NDbGllbnRPcHRpb25zVGltZW91dCwgb3B0aW9ucyk7CiAgICB9CiAgICAvLyBDaGVjayBleGlzdGluZ19zb2NrZXQgKGlmIHByb3ZpZGVkKQogICAgaWYgKG9wdGlvbnMuZXhpc3Rpbmdfc29ja2V0ICYmICEob3B0aW9ucy5leGlzdGluZ19zb2NrZXQgaW5zdGFuY2VvZiBzdHJlYW0uRHVwbGV4KSkgewogICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNFeGlzdGluZ1NvY2tldCwgb3B0aW9ucyk7CiAgICB9CiAgfQogIGhlbHBlcnMkMS52YWxpZGF0ZVNvY2tzQ2xpZW50T3B0aW9ucyA9IHZhbGlkYXRlU29ja3NDbGllbnRPcHRpb25zOwogIC8qKgogICAqIFZhbGlkYXRlcyB0aGUgU29ja3NDbGllbnRDaGFpbk9wdGlvbnMKICAgKiBAcGFyYW0gb3B0aW9ucyB7IFNvY2tzQ2xpZW50Q2hhaW5PcHRpb25zIH0KICAgKi8KICBmdW5jdGlvbiB2YWxpZGF0ZVNvY2tzQ2xpZW50Q2hhaW5PcHRpb25zKG9wdGlvbnMpIHsKICAgIC8vIE9ubHkgY29ubmVjdCBpcyBzdXBwb3J0ZWQgd2hlbiBjaGFpbmluZy4KICAgIGlmIChvcHRpb25zLmNvbW1hbmQgIT09ICdjb25uZWN0JykgewogICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NvbW1hbmRDaGFpbiwgb3B0aW9ucyk7CiAgICB9CiAgICAvLyBDaGVjayBkZXN0aW5hdGlvbgogICAgaWYgKCFpc1ZhbGlkU29ja3NSZW1vdGVIb3N0KG9wdGlvbnMuZGVzdGluYXRpb24pKSB7CiAgICAgIHRocm93IG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihjb25zdGFudHNfMS5FUlJPUlMuSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc0Rlc3RpbmF0aW9uLCBvcHRpb25zKTsKICAgIH0KICAgIC8vIFZhbGlkYXRlIHByb3hpZXMgKGxlbmd0aCkKICAgIGlmICghKG9wdGlvbnMucHJveGllcyAmJiBBcnJheS5pc0FycmF5KG9wdGlvbnMucHJveGllcykgJiYgb3B0aW9ucy5wcm94aWVzLmxlbmd0aCA+PSAyKSkgewogICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNQcm94aWVzTGVuZ3RoLCBvcHRpb25zKTsKICAgIH0KICAgIC8vIFZhbGlkYXRlIHByb3hpZXMKICAgIG9wdGlvbnMucHJveGllcy5mb3JFYWNoKHByb3h5ID0+IHsKICAgICAgaWYgKCFpc1ZhbGlkU29ja3NQcm94eShwcm94eSkpIHsKICAgICAgICB0aHJvdyBuZXcgdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3IoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2Nrc0NsaWVudE9wdGlvbnNQcm94eSwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgLy8gVmFsaWRhdGUgY3VzdG9tIGF1dGggKGlmIHNldCkKICAgICAgdmFsaWRhdGVDdXN0b21Qcm94eUF1dGgocHJveHksIG9wdGlvbnMpOwogICAgfSk7CiAgICAvLyBDaGVjayB0aW1lb3V0CiAgICBpZiAob3B0aW9ucy50aW1lb3V0ICYmICFpc1ZhbGlkVGltZW91dFZhbHVlKG9wdGlvbnMudGltZW91dCkpIHsKICAgICAgdGhyb3cgbmV3IHV0aWxfMS5Tb2Nrc0NsaWVudEVycm9yKGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3NDbGllbnRPcHRpb25zVGltZW91dCwgb3B0aW9ucyk7CiAgICB9CiAgfQogIGhlbHBlcnMkMS52YWxpZGF0ZVNvY2tzQ2xpZW50Q2hhaW5PcHRpb25zID0gdmFsaWRhdGVTb2Nrc0NsaWVudENoYWluT3B0aW9uczsKICBmdW5jdGlvbiB2YWxpZGF0ZUN1c3RvbVByb3h5QXV0aChwcm94eSwgb3B0aW9ucykgewogICAgaWYgKHByb3h5LmN1c3RvbV9hdXRoX21ldGhvZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIEludmFsaWQgYXV0aCBtZXRob2QgcmFuZ2UKICAgICAgaWYgKHByb3h5LmN1c3RvbV9hdXRoX21ldGhvZCA8IGNvbnN0YW50c18xLlNPQ0tTNV9DVVNUT01fQVVUSF9TVEFSVCB8fCBwcm94eS5jdXN0b21fYXV0aF9tZXRob2QgPiBjb25zdGFudHNfMS5TT0NLUzVfQ1VTVE9NX0FVVEhfRU5EKSB7CiAgICAgICAgdGhyb3cgbmV3IHV0aWxfMS5Tb2Nrc0NsaWVudEVycm9yKGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3NDbGllbnRPcHRpb25zQ3VzdG9tQXV0aFJhbmdlLCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyBNaXNzaW5nIGN1c3RvbV9hdXRoX3JlcXVlc3RfaGFuZGxlcgogICAgICBpZiAocHJveHkuY3VzdG9tX2F1dGhfcmVxdWVzdF9oYW5kbGVyID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIHByb3h5LmN1c3RvbV9hdXRoX3JlcXVlc3RfaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRocm93IG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihjb25zdGFudHNfMS5FUlJPUlMuSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc0N1c3RvbUF1dGhPcHRpb25zLCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyBNaXNzaW5nIGN1c3RvbV9hdXRoX3Jlc3BvbnNlX3NpemUKICAgICAgaWYgKHByb3h5LmN1c3RvbV9hdXRoX3Jlc3BvbnNlX3NpemUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRocm93IG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihjb25zdGFudHNfMS5FUlJPUlMuSW52YWxpZFNvY2tzQ2xpZW50T3B0aW9uc0N1c3RvbUF1dGhPcHRpb25zLCBvcHRpb25zKTsKICAgICAgfQogICAgICAvLyBNaXNzaW5nL2ludmFsaWQgY3VzdG9tX2F1dGhfcmVzcG9uc2VfaGFuZGxlcgogICAgICBpZiAocHJveHkuY3VzdG9tX2F1dGhfcmVzcG9uc2VfaGFuZGxlciA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBwcm94eS5jdXN0b21fYXV0aF9yZXNwb25zZV9oYW5kbGVyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhyb3cgbmV3IHV0aWxfMS5Tb2Nrc0NsaWVudEVycm9yKGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3NDbGllbnRPcHRpb25zQ3VzdG9tQXV0aE9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIFZhbGlkYXRlcyBhIFNvY2tzUmVtb3RlSG9zdAogICAqIEBwYXJhbSByZW1vdGVIb3N0IHsgU29ja3NSZW1vdGVIb3N0IH0KICAgKi8KICBmdW5jdGlvbiBpc1ZhbGlkU29ja3NSZW1vdGVIb3N0KHJlbW90ZUhvc3QpIHsKICAgIHJldHVybiByZW1vdGVIb3N0ICYmIHR5cGVvZiByZW1vdGVIb3N0Lmhvc3QgPT09ICdzdHJpbmcnICYmIHR5cGVvZiByZW1vdGVIb3N0LnBvcnQgPT09ICdudW1iZXInICYmIHJlbW90ZUhvc3QucG9ydCA+PSAwICYmIHJlbW90ZUhvc3QucG9ydCA8PSA2NTUzNTsKICB9CiAgLyoqCiAgICogVmFsaWRhdGVzIGEgU29ja3NQcm94eQogICAqIEBwYXJhbSBwcm94eSB7IFNvY2tzUHJveHkgfQogICAqLwogIGZ1bmN0aW9uIGlzVmFsaWRTb2Nrc1Byb3h5KHByb3h5KSB7CiAgICByZXR1cm4gcHJveHkgJiYgKHR5cGVvZiBwcm94eS5ob3N0ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgcHJveHkuaXBhZGRyZXNzID09PSAnc3RyaW5nJykgJiYgdHlwZW9mIHByb3h5LnBvcnQgPT09ICdudW1iZXInICYmIHByb3h5LnBvcnQgPj0gMCAmJiBwcm94eS5wb3J0IDw9IDY1NTM1ICYmIChwcm94eS50eXBlID09PSA0IHx8IHByb3h5LnR5cGUgPT09IDUpOwogIH0KICAvKioKICAgKiBWYWxpZGF0ZXMgYSB0aW1lb3V0IHZhbHVlLgogICAqIEBwYXJhbSB2YWx1ZSB7IE51bWJlciB9CiAgICovCiAgZnVuY3Rpb24gaXNWYWxpZFRpbWVvdXRWYWx1ZSh2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgdmFsdWUgPiAwOwogIH0KICBmdW5jdGlvbiBpcHY0VG9JbnQzMihpcCkgewogICAgY29uc3QgYWRkcmVzcyA9IG5ldyBpcF9hZGRyZXNzXzEuQWRkcmVzczQoaXApOwogICAgLy8gQ29udmVydCB0aGUgSVB2NCBhZGRyZXNzIHBhcnRzIHRvIGFuIGludGVnZXIKICAgIHJldHVybiBhZGRyZXNzLnRvQXJyYXkoKS5yZWR1Y2UoKGFjYywgcGFydCkgPT4gKGFjYyA8PCA4KSArIHBhcnQsIDApOwogIH0KICBoZWxwZXJzJDEuaXB2NFRvSW50MzIgPSBpcHY0VG9JbnQzMjsKICBmdW5jdGlvbiBpbnQzMlRvSXB2NChpbnQzMikgewogICAgLy8gRXh0cmFjdCBlYWNoIGJ5dGUgKG9jdGV0KSBmcm9tIHRoZSAzMi1iaXQgaW50ZWdlcgogICAgY29uc3Qgb2N0ZXQxID0gaW50MzIgPj4+IDI0ICYgMHhmZjsKICAgIGNvbnN0IG9jdGV0MiA9IGludDMyID4+PiAxNiAmIDB4ZmY7CiAgICBjb25zdCBvY3RldDMgPSBpbnQzMiA+Pj4gOCAmIDB4ZmY7CiAgICBjb25zdCBvY3RldDQgPSBpbnQzMiAmIDB4ZmY7CiAgICAvLyBDb21iaW5lIHRoZSBvY3RldHMgaW50byBhIHN0cmluZyBpbiBJUHY0IGZvcm1hdAogICAgcmV0dXJuIFtvY3RldDEsIG9jdGV0Miwgb2N0ZXQzLCBvY3RldDRdLmpvaW4oJy4nKTsKICB9CiAgaGVscGVycyQxLmludDMyVG9JcHY0ID0gaW50MzJUb0lwdjQ7CiAgZnVuY3Rpb24gaXBUb0J1ZmZlcihpcCkgewogICAgaWYgKG5ldC5pc0lQdjQoaXApKSB7CiAgICAgIC8vIEhhbmRsZSBJUHY0IGFkZHJlc3NlcwogICAgICBjb25zdCBhZGRyZXNzID0gbmV3IGlwX2FkZHJlc3NfMS5BZGRyZXNzNChpcCk7CiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShhZGRyZXNzLnRvQXJyYXkoKSk7CiAgICB9IGVsc2UgaWYgKG5ldC5pc0lQdjYoaXApKSB7CiAgICAgIC8vIEhhbmRsZSBJUHY2IGFkZHJlc3NlcwogICAgICBjb25zdCBhZGRyZXNzID0gbmV3IGlwX2FkZHJlc3NfMS5BZGRyZXNzNihpcCk7CiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShhZGRyZXNzLmNhbm9uaWNhbEZvcm0oKS5zcGxpdCgnOicpLm1hcChzZWdtZW50ID0+IHNlZ21lbnQucGFkU3RhcnQoNCwgJzAnKSkuam9pbignJyksICdoZXgnKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBJUCBhZGRyZXNzIGZvcm1hdCcpOwogICAgfQogIH0KICBoZWxwZXJzJDEuaXBUb0J1ZmZlciA9IGlwVG9CdWZmZXI7CiAgcmV0dXJuIGhlbHBlcnMkMTsKfQoKdmFyIHJlY2VpdmVidWZmZXIgPSB7fTsKCnZhciBoYXNSZXF1aXJlZFJlY2VpdmVidWZmZXI7CmZ1bmN0aW9uIHJlcXVpcmVSZWNlaXZlYnVmZmVyKCkgewogIGlmIChoYXNSZXF1aXJlZFJlY2VpdmVidWZmZXIpIHJldHVybiByZWNlaXZlYnVmZmVyOwogIGhhc1JlcXVpcmVkUmVjZWl2ZWJ1ZmZlciA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJlY2VpdmVidWZmZXIsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICByZWNlaXZlYnVmZmVyLlJlY2VpdmVCdWZmZXIgPSB2b2lkIDA7CiAgY2xhc3MgUmVjZWl2ZUJ1ZmZlciB7CiAgICBjb25zdHJ1Y3RvcihzaXplID0gNDA5NikgewogICAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShzaXplKTsKICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICB0aGlzLm9yaWdpbmFsU2l6ZSA9IHNpemU7CiAgICB9CiAgICBnZXQgbGVuZ3RoKCkgewogICAgICByZXR1cm4gdGhpcy5vZmZzZXQ7CiAgICB9CiAgICBhcHBlbmQoZGF0YSkgewogICAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihkYXRhKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIGFwcGVuZCBhIG5vbi1idWZmZXIgaW5zdGFuY2UgdG8gUmVjZWl2ZUJ1ZmZlci4nKTsKICAgICAgfQogICAgICBpZiAodGhpcy5vZmZzZXQgKyBkYXRhLmxlbmd0aCA+PSB0aGlzLmJ1ZmZlci5sZW5ndGgpIHsKICAgICAgICBjb25zdCB0bXAgPSB0aGlzLmJ1ZmZlcjsKICAgICAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShNYXRoLm1heCh0aGlzLmJ1ZmZlci5sZW5ndGggKyB0aGlzLm9yaWdpbmFsU2l6ZSwgdGhpcy5idWZmZXIubGVuZ3RoICsgZGF0YS5sZW5ndGgpKTsKICAgICAgICB0bXAuY29weSh0aGlzLmJ1ZmZlcik7CiAgICAgIH0KICAgICAgZGF0YS5jb3B5KHRoaXMuYnVmZmVyLCB0aGlzLm9mZnNldCk7CiAgICAgIHJldHVybiB0aGlzLm9mZnNldCArPSBkYXRhLmxlbmd0aDsKICAgIH0KICAgIHBlZWsobGVuZ3RoKSB7CiAgICAgIGlmIChsZW5ndGggPiB0aGlzLm9mZnNldCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHJlYWQgYmV5b25kIHRoZSBib3VuZHMgb2YgdGhlIG1hbmFnZWQgaW50ZXJuYWwgZGF0YS4nKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5idWZmZXIuc2xpY2UoMCwgbGVuZ3RoKTsKICAgIH0KICAgIGdldChsZW5ndGgpIHsKICAgICAgaWYgKGxlbmd0aCA+IHRoaXMub2Zmc2V0KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gcmVhZCBiZXlvbmQgdGhlIGJvdW5kcyBvZiB0aGUgbWFuYWdlZCBpbnRlcm5hbCBkYXRhLicpOwogICAgICB9CiAgICAgIGNvbnN0IHZhbHVlID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCk7CiAgICAgIHRoaXMuYnVmZmVyLnNsaWNlKDAsIGxlbmd0aCkuY29weSh2YWx1ZSk7CiAgICAgIHRoaXMuYnVmZmVyLmNvcHlXaXRoaW4oMCwgbGVuZ3RoLCBsZW5ndGggKyB0aGlzLm9mZnNldCAtIGxlbmd0aCk7CiAgICAgIHRoaXMub2Zmc2V0IC09IGxlbmd0aDsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH0KICByZWNlaXZlYnVmZmVyLlJlY2VpdmVCdWZmZXIgPSBSZWNlaXZlQnVmZmVyOwogIHJldHVybiByZWNlaXZlYnVmZmVyOwp9Cgp2YXIgaGFzUmVxdWlyZWRTb2Nrc2NsaWVudDsKZnVuY3Rpb24gcmVxdWlyZVNvY2tzY2xpZW50KCkgewogIGlmIChoYXNSZXF1aXJlZFNvY2tzY2xpZW50KSByZXR1cm4gc29ja3NjbGllbnQ7CiAgaGFzUmVxdWlyZWRTb2Nrc2NsaWVudCA9IDE7CiAgKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogICAgdmFyIF9fYXdhaXRlciA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fYXdhaXRlciB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgIHJlc29sdmUodmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzdGVwKGdlbmVyYXRvclsidGhyb3ciXSh2YWx1ZSkpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsKICAgICAgICB9CiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpOwogICAgICB9KTsKICAgIH07CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgIHZhbHVlOiB0cnVlCiAgICB9KTsKICAgIGV4cG9ydHMuU29ja3NDbGllbnRFcnJvciA9IGV4cG9ydHMuU29ja3NDbGllbnQgPSB2b2lkIDA7CiAgICBjb25zdCBldmVudHNfMSA9IHJlcXVpcmUkJDAkMjsKICAgIGNvbnN0IG5ldCA9IHJlcXVpcmUkJDEkNDsKICAgIGNvbnN0IHNtYXJ0X2J1ZmZlcl8xID0gcmVxdWlyZVNtYXJ0YnVmZmVyKCk7CiAgICBjb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmVDb25zdGFudHMkMigpOwogICAgY29uc3QgaGVscGVyc18xID0gcmVxdWlyZUhlbHBlcnMoKTsKICAgIGNvbnN0IHJlY2VpdmVidWZmZXJfMSA9IHJlcXVpcmVSZWNlaXZlYnVmZmVyKCk7CiAgICBjb25zdCB1dGlsXzEgPSByZXF1aXJlVXRpbCgpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJTb2Nrc0NsaWVudEVycm9yIiwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdXRpbF8xLlNvY2tzQ2xpZW50RXJyb3I7CiAgICAgIH0KICAgIH0pOwogICAgY29uc3QgaXBfYWRkcmVzc18xID0gcmVxdWlyZUlwQWRkcmVzcygpOwogICAgY2xhc3MgU29ja3NDbGllbnQgZXh0ZW5kcyBldmVudHNfMS5FdmVudEVtaXR0ZXIgewogICAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTsKICAgICAgICAvLyBWYWxpZGF0ZSBTb2Nrc0NsaWVudE9wdGlvbnMKICAgICAgICAoMCwgaGVscGVyc18xLnZhbGlkYXRlU29ja3NDbGllbnRPcHRpb25zKShvcHRpb25zKTsKICAgICAgICAvLyBEZWZhdWx0IHN0YXRlCiAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkNyZWF0ZWQpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBDcmVhdGVzIGEgbmV3IFNPQ0tTIGNvbm5lY3Rpb24uCiAgICAgICAqCiAgICAgICAqIE5vdGU6IFN1cHBvcnRzIGNhbGxiYWNrcyBhbmQgcHJvbWlzZXMuIE9ubHkgc3VwcG9ydHMgdGhlIGNvbm5lY3QgY29tbWFuZC4KICAgICAgICogQHBhcmFtIG9wdGlvbnMgeyBTb2Nrc0NsaWVudE9wdGlvbnMgfSBPcHRpb25zLgogICAgICAgKiBAcGFyYW0gY2FsbGJhY2sgeyBGdW5jdGlvbiB9IEFuIG9wdGlvbmFsIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICAgKiBAcmV0dXJucyB7IFByb21pc2UgfQogICAgICAgKi8KICAgICAgc3RhdGljIGNyZWF0ZUNvbm5lY3Rpb24ob3B0aW9ucywgY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgLy8gVmFsaWRhdGUgU29ja3NDbGllbnRPcHRpb25zCiAgICAgICAgICB0cnkgewogICAgICAgICAgICAoMCwgaGVscGVyc18xLnZhbGlkYXRlU29ja3NDbGllbnRPcHRpb25zKShvcHRpb25zLCBbJ2Nvbm5lY3QnXSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShlcnIpOyAvLyBSZXNvbHZlcyBwZW5kaW5nIHByb21pc2UgKHByZXZlbnRzIG1lbW9yeSBsZWFrcykuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgU29ja3NDbGllbnQob3B0aW9ucyk7CiAgICAgICAgICBjbGllbnQuY29ubmVjdChvcHRpb25zLmV4aXN0aW5nX3NvY2tldCk7CiAgICAgICAgICBjbGllbnQub25jZSgnZXN0YWJsaXNoZWQnLCBpbmZvID0+IHsKICAgICAgICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgaW5mbyk7CiAgICAgICAgICAgICAgcmVzb2x2ZShpbmZvKTsgLy8gUmVzb2x2ZXMgcGVuZGluZyBwcm9taXNlIChwcmV2ZW50cyBtZW1vcnkgbGVha3MpLgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgLy8gRXJyb3Igb2NjdXJyZWQsIGZhaWxlZCB0byBlc3RhYmxpc2ggY29ubmVjdGlvbi4KICAgICAgICAgIGNsaWVudC5vbmNlKCdlcnJvcicsIGVyciA9PiB7CiAgICAgICAgICAgIGNsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnkKICAgICAgICAgICAgICByZXNvbHZlKGVycik7IC8vIFJlc29sdmVzIHBlbmRpbmcgcHJvbWlzZSAocHJldmVudHMgbWVtb3J5IGxlYWtzKS4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIENyZWF0ZXMgYSBuZXcgU09DS1MgY29ubmVjdGlvbiBjaGFpbiB0byBhIGRlc3RpbmF0aW9uIGhvc3QgdGhyb3VnaCAyIG9yIG1vcmUgU09DS1MgcHJveGllcy4KICAgICAgICoKICAgICAgICogTm90ZTogU3VwcG9ydHMgY2FsbGJhY2tzIGFuZCBwcm9taXNlcy4gT25seSBzdXBwb3J0cyB0aGUgY29ubmVjdCBtZXRob2QuCiAgICAgICAqIE5vdGU6IEltcGxlbWVudGVkIHZpYSBjcmVhdGVDb25uZWN0aW9uKCkgZmFjdG9yeSBmdW5jdGlvbi4KICAgICAgICogQHBhcmFtIG9wdGlvbnMgeyBTb2Nrc0NsaWVudENoYWluT3B0aW9ucyB9IE9wdGlvbnMKICAgICAgICogQHBhcmFtIGNhbGxiYWNrIHsgRnVuY3Rpb24gfSBBbiBvcHRpb25hbCBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAgICogQHJldHVybnMgeyBQcm9taXNlIH0KICAgICAgICovCiAgICAgIHN0YXRpYyBjcmVhdGVDb25uZWN0aW9uQ2hhaW4ob3B0aW9ucywgY2FsbGJhY2spIHsKICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXN5bmMtcHJvbWlzZS1leGVjdXRvcgogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAvLyBWYWxpZGF0ZSBTb2Nrc0NsaWVudENoYWluT3B0aW9ucwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgKDAsIGhlbHBlcnNfMS52YWxpZGF0ZVNvY2tzQ2xpZW50Q2hhaW5PcHRpb25zKShvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueQogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGVycik7IC8vIFJlc29sdmVzIHBlbmRpbmcgcHJvbWlzZSAocHJldmVudHMgbWVtb3J5IGxlYWtzKS4KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIFNodWZmbGUgcHJveGllcwogICAgICAgICAgaWYgKG9wdGlvbnMucmFuZG9taXplQ2hhaW4pIHsKICAgICAgICAgICAgKDAsIHV0aWxfMS5zaHVmZmxlQXJyYXkpKG9wdGlvbnMucHJveGllcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsZXQgc29jazsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHRpb25zLnByb3hpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBuZXh0UHJveHkgPSBvcHRpb25zLnByb3hpZXNbaV07CiAgICAgICAgICAgICAgLy8gSWYgd2UndmUgcmVhY2hlZCB0aGUgbGFzdCBwcm94eSBpbiB0aGUgY2hhaW4sIHRoZSBkZXN0aW5hdGlvbiBpcyB0aGUgYWN0dWFsIGRlc3RpbmF0aW9uLCBvdGhlcndpc2UgaXQncyB0aGUgbmV4dCBwcm94eS4KICAgICAgICAgICAgICBjb25zdCBuZXh0RGVzdGluYXRpb24gPSBpID09PSBvcHRpb25zLnByb3hpZXMubGVuZ3RoIC0gMSA/IG9wdGlvbnMuZGVzdGluYXRpb24gOiB7CiAgICAgICAgICAgICAgICBob3N0OiBvcHRpb25zLnByb3hpZXNbaSArIDFdLmhvc3QgfHwgb3B0aW9ucy5wcm94aWVzW2kgKyAxXS5pcGFkZHJlc3MsCiAgICAgICAgICAgICAgICBwb3J0OiBvcHRpb25zLnByb3hpZXNbaSArIDFdLnBvcnQKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIC8vIENyZWF0ZXMgdGhlIG5leHQgY29ubmVjdGlvbiBpbiB0aGUgY2hhaW4uCiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgU29ja3NDbGllbnQuY3JlYXRlQ29ubmVjdGlvbih7CiAgICAgICAgICAgICAgICBjb21tYW5kOiAnY29ubmVjdCcsCiAgICAgICAgICAgICAgICBwcm94eTogbmV4dFByb3h5LAogICAgICAgICAgICAgICAgZGVzdGluYXRpb246IG5leHREZXN0aW5hdGlvbiwKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3NvY2tldDogc29jawogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIC8vIElmIHNvY2sgaXMgdW5kZWZpbmVkLCBhc3NpZ24gaXQgaGVyZS4KICAgICAgICAgICAgICBzb2NrID0gc29jayB8fCByZXN1bHQuc29ja2V0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB7CiAgICAgICAgICAgICAgICBzb2NrZXQ6IHNvY2sKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXNvbHZlKHsKICAgICAgICAgICAgICAgIHNvY2tldDogc29jawogICAgICAgICAgICAgIH0pOyAvLyBSZXNvbHZlcyBwZW5kaW5nIHByb21pc2UgKHByZXZlbnRzIG1lbW9yeSBsZWFrcykuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZSh7CiAgICAgICAgICAgICAgICBzb2NrZXQ6IHNvY2sKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55CiAgICAgICAgICAgICAgcmVzb2x2ZShlcnIpOyAvLyBSZXNvbHZlcyBwZW5kaW5nIHByb21pc2UgKHByZXZlbnRzIG1lbW9yeSBsZWFrcykuCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIENyZWF0ZXMgYSBTT0NLUyBVRFAgRnJhbWUuCiAgICAgICAqIEBwYXJhbSBvcHRpb25zCiAgICAgICAqLwogICAgICBzdGF0aWMgY3JlYXRlVURQRnJhbWUob3B0aW9ucykgewogICAgICAgIGNvbnN0IGJ1ZmYgPSBuZXcgc21hcnRfYnVmZmVyXzEuU21hcnRCdWZmZXIoKTsKICAgICAgICBidWZmLndyaXRlVUludDE2QkUoMCk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQ4KG9wdGlvbnMuZnJhbWVOdW1iZXIgfHwgMCk7CiAgICAgICAgLy8gSVB2NC9JUHY2L0hvc3RuYW1lCiAgICAgICAgaWYgKG5ldC5pc0lQdjQob3B0aW9ucy5yZW1vdGVIb3N0Lmhvc3QpKSB7CiAgICAgICAgICBidWZmLndyaXRlVUludDgoY29uc3RhbnRzXzEuU29ja3M1SG9zdFR5cGUuSVB2NCk7CiAgICAgICAgICBidWZmLndyaXRlVUludDMyQkUoKDAsIGhlbHBlcnNfMS5pcHY0VG9JbnQzMikob3B0aW9ucy5yZW1vdGVIb3N0Lmhvc3QpKTsKICAgICAgICB9IGVsc2UgaWYgKG5ldC5pc0lQdjYob3B0aW9ucy5yZW1vdGVIb3N0Lmhvc3QpKSB7CiAgICAgICAgICBidWZmLndyaXRlVUludDgoY29uc3RhbnRzXzEuU29ja3M1SG9zdFR5cGUuSVB2Nik7CiAgICAgICAgICBidWZmLndyaXRlQnVmZmVyKCgwLCBoZWxwZXJzXzEuaXBUb0J1ZmZlcikob3B0aW9ucy5yZW1vdGVIb3N0Lmhvc3QpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLkhvc3RuYW1lKTsKICAgICAgICAgIGJ1ZmYud3JpdGVVSW50OChCdWZmZXIuYnl0ZUxlbmd0aChvcHRpb25zLnJlbW90ZUhvc3QuaG9zdCkpOwogICAgICAgICAgYnVmZi53cml0ZVN0cmluZyhvcHRpb25zLnJlbW90ZUhvc3QuaG9zdCk7CiAgICAgICAgfQogICAgICAgIC8vIFBvcnQKICAgICAgICBidWZmLndyaXRlVUludDE2QkUob3B0aW9ucy5yZW1vdGVIb3N0LnBvcnQpOwogICAgICAgIC8vIERhdGEKICAgICAgICBidWZmLndyaXRlQnVmZmVyKG9wdGlvbnMuZGF0YSk7CiAgICAgICAgcmV0dXJuIGJ1ZmYudG9CdWZmZXIoKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogUGFyc2VzIGEgU09DS1MgVURQIGZyYW1lLgogICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgKi8KICAgICAgc3RhdGljIHBhcnNlVURQRnJhbWUoZGF0YSkgewogICAgICAgIGNvbnN0IGJ1ZmYgPSBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlci5mcm9tQnVmZmVyKGRhdGEpOwogICAgICAgIGJ1ZmYucmVhZE9mZnNldCA9IDI7CiAgICAgICAgY29uc3QgZnJhbWVOdW1iZXIgPSBidWZmLnJlYWRVSW50OCgpOwogICAgICAgIGNvbnN0IGhvc3RUeXBlID0gYnVmZi5yZWFkVUludDgoKTsKICAgICAgICBsZXQgcmVtb3RlSG9zdDsKICAgICAgICBpZiAoaG9zdFR5cGUgPT09IGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjQpIHsKICAgICAgICAgIHJlbW90ZUhvc3QgPSAoMCwgaGVscGVyc18xLmludDMyVG9JcHY0KShidWZmLnJlYWRVSW50MzJCRSgpKTsKICAgICAgICB9IGVsc2UgaWYgKGhvc3RUeXBlID09PSBjb25zdGFudHNfMS5Tb2NrczVIb3N0VHlwZS5JUHY2KSB7CiAgICAgICAgICByZW1vdGVIb3N0ID0gaXBfYWRkcmVzc18xLkFkZHJlc3M2LmZyb21CeXRlQXJyYXkoQXJyYXkuZnJvbShidWZmLnJlYWRCdWZmZXIoMTYpKSkuY2Fub25pY2FsRm9ybSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZW1vdGVIb3N0ID0gYnVmZi5yZWFkU3RyaW5nKGJ1ZmYucmVhZFVJbnQ4KCkpOwogICAgICAgIH0KICAgICAgICBjb25zdCByZW1vdGVQb3J0ID0gYnVmZi5yZWFkVUludDE2QkUoKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZnJhbWVOdW1iZXIsCiAgICAgICAgICByZW1vdGVIb3N0OiB7CiAgICAgICAgICAgIGhvc3Q6IHJlbW90ZUhvc3QsCiAgICAgICAgICAgIHBvcnQ6IHJlbW90ZVBvcnQKICAgICAgICAgIH0sCiAgICAgICAgICBkYXRhOiBidWZmLnJlYWRCdWZmZXIoKQogICAgICAgIH07CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEludGVybmFsIHN0YXRlIHNldHRlci4gSWYgdGhlIFNvY2tzQ2xpZW50IGlzIGluIGFuIGVycm9yIHN0YXRlLCBpdCBjYW5ub3QgYmUgY2hhbmdlZCB0byBhIG5vbiBlcnJvciBzdGF0ZS4KICAgICAgICovCiAgICAgIHNldFN0YXRlKG5ld1N0YXRlKSB7CiAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuRXJyb3IpIHsKICAgICAgICAgIHRoaXMuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFN0YXJ0cyB0aGUgY29ubmVjdGlvbiBlc3RhYmxpc2htZW50IHRvIHRoZSBwcm94eSBhbmQgZGVzdGluYXRpb24uCiAgICAgICAqIEBwYXJhbSBleGlzdGluZ1NvY2tldCBDb25uZWN0ZWQgc29ja2V0IHRvIHVzZSBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9uZSAoaW50ZXJuYWwgdXNlKS4KICAgICAgICovCiAgICAgIGNvbm5lY3QoZXhpc3RpbmdTb2NrZXQpIHsKICAgICAgICB0aGlzLm9uRGF0YVJlY2VpdmVkID0gZGF0YSA9PiB0aGlzLm9uRGF0YVJlY2VpdmVkSGFuZGxlcihkYXRhKTsKICAgICAgICB0aGlzLm9uQ2xvc2UgPSAoKSA9PiB0aGlzLm9uQ2xvc2VIYW5kbGVyKCk7CiAgICAgICAgdGhpcy5vbkVycm9yID0gZXJyID0+IHRoaXMub25FcnJvckhhbmRsZXIoZXJyKTsKICAgICAgICB0aGlzLm9uQ29ubmVjdCA9ICgpID0+IHRoaXMub25Db25uZWN0SGFuZGxlcigpOwogICAgICAgIC8vIFN0YXJ0IHRpbWVvdXQgdGltZXIgKGRlZmF1bHRzIHRvIDMwIHNlY29uZHMpCiAgICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMub25Fc3RhYmxpc2hlZFRpbWVvdXQoKSwgdGhpcy5vcHRpb25zLnRpbWVvdXQgfHwgY29uc3RhbnRzXzEuREVGQVVMVF9USU1FT1VUKTsKICAgICAgICAvLyBjaGVjayB3aGV0aGVyIHVucmVmIGlzIGF2YWlsYWJsZSBhcyBpdCBkaWZmZXJzIGZyb20gYnJvd3NlciB0byBOb2RlSlMgKCMzMykKICAgICAgICBpZiAodGltZXIudW5yZWYgJiYgdHlwZW9mIHRpbWVyLnVucmVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aW1lci51bnJlZigpOwogICAgICAgIH0KICAgICAgICAvLyBJZiBhbiBleGlzdGluZyBzb2NrZXQgaXMgcHJvdmlkZWQsIHVzZSBpdCB0byBuZWdvdGlhdGUgU09DS1MgaGFuZHNoYWtlLiBPdGhlcndpc2UgY3JlYXRlIGEgbmV3IFNvY2tldC4KICAgICAgICBpZiAoZXhpc3RpbmdTb2NrZXQpIHsKICAgICAgICAgIHRoaXMuc29ja2V0ID0gZXhpc3RpbmdTb2NrZXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc29ja2V0ID0gbmV3IG5ldC5Tb2NrZXQoKTsKICAgICAgICB9CiAgICAgICAgLy8gQXR0YWNoIFNvY2tldCBlcnJvciBoYW5kbGVycy4KICAgICAgICB0aGlzLnNvY2tldC5vbmNlKCdjbG9zZScsIHRoaXMub25DbG9zZSk7CiAgICAgICAgdGhpcy5zb2NrZXQub25jZSgnZXJyb3InLCB0aGlzLm9uRXJyb3IpOwogICAgICAgIHRoaXMuc29ja2V0Lm9uY2UoJ2Nvbm5lY3QnLCB0aGlzLm9uQ29ubmVjdCk7CiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2RhdGEnLCB0aGlzLm9uRGF0YVJlY2VpdmVkKTsKICAgICAgICB0aGlzLnNldFN0YXRlKGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuQ29ubmVjdGluZyk7CiAgICAgICAgdGhpcy5yZWNlaXZlQnVmZmVyID0gbmV3IHJlY2VpdmVidWZmZXJfMS5SZWNlaXZlQnVmZmVyKCk7CiAgICAgICAgaWYgKGV4aXN0aW5nU29ja2V0KSB7CiAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdjb25uZWN0Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5nZXRTb2NrZXRPcHRpb25zKCkpOwogICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zZXRfdGNwX25vZGVsYXkgIT09IHVuZGVmaW5lZCAmJiB0aGlzLm9wdGlvbnMuc2V0X3RjcF9ub2RlbGF5ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkoISF0aGlzLm9wdGlvbnMuc2V0X3RjcF9ub2RlbGF5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gTGlzdGVuIGZvciBlc3RhYmxpc2hlZCBldmVudCBzbyB3ZSBjYW4gcmUtZW1pdCBhbnkgZXhjZXNzIGRhdGEgcmVjZWl2ZWQgZHVyaW5nIGhhbmRzaGFrZXMuCiAgICAgICAgdGhpcy5wcmVwZW5kT25jZUxpc3RlbmVyKCdlc3RhYmxpc2hlZCcsIGluZm8gPT4gewogICAgICAgICAgc2V0SW1tZWRpYXRlKCgpID0+IHsKICAgICAgICAgICAgaWYgKHRoaXMucmVjZWl2ZUJ1ZmZlci5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgY29uc3QgZXhjZXNzRGF0YSA9IHRoaXMucmVjZWl2ZUJ1ZmZlci5nZXQodGhpcy5yZWNlaXZlQnVmZmVyLmxlbmd0aCk7CiAgICAgICAgICAgICAgaW5mby5zb2NrZXQuZW1pdCgnZGF0YScsIGV4Y2Vzc0RhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZm8uc29ja2V0LnJlc3VtZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLy8gU29ja2V0IG9wdGlvbnMgKGRlZmF1bHRzIGhvc3QvcG9ydCB0byBvcHRpb25zLnByb3h5Lmhvc3Qvb3B0aW9ucy5wcm94eS5wb3J0KQogICAgICBnZXRTb2NrZXRPcHRpb25zKCkgewogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0aW9ucy5zb2NrZXRfb3B0aW9ucyksIHsKICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5wcm94eS5ob3N0IHx8IHRoaXMub3B0aW9ucy5wcm94eS5pcGFkZHJlc3MsCiAgICAgICAgICBwb3J0OiB0aGlzLm9wdGlvbnMucHJveHkucG9ydAogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBIYW5kbGVzIGludGVybmFsIFNvY2tzIHRpbWVvdXQgY2FsbGJhY2suCiAgICAgICAqIE5vdGU6IElmIHRoZSBTb2NrcyBjbGllbnQgaXMgbm90IEJvdW5kV2FpdGluZ0ZvckNvbm5lY3Rpb24gb3IgRXN0YWJsaXNoZWQsIHRoZSBjb25uZWN0aW9uIHdpbGwgYmUgY2xvc2VkLgogICAgICAgKi8KICAgICAgb25Fc3RhYmxpc2hlZFRpbWVvdXQoKSB7CiAgICAgICAgaWYgKHRoaXMuc3RhdGUgIT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuRXN0YWJsaXNoZWQgJiYgdGhpcy5zdGF0ZSAhPT0gY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5Cb3VuZFdhaXRpbmdGb3JDb25uZWN0aW9uKSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGNvbnN0YW50c18xLkVSUk9SUy5Qcm94eUNvbm5lY3Rpb25UaW1lZE91dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBIYW5kbGVzIFNvY2tldCBjb25uZWN0IGV2ZW50LgogICAgICAgKi8KICAgICAgb25Db25uZWN0SGFuZGxlcigpIHsKICAgICAgICB0aGlzLnNldFN0YXRlKGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuQ29ubmVjdGVkKTsKICAgICAgICAvLyBTZW5kIGluaXRpYWwgaGFuZHNoYWtlLgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucHJveHkudHlwZSA9PT0gNCkgewogICAgICAgICAgdGhpcy5zZW5kU29ja3M0SW5pdGlhbEhhbmRzaGFrZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnNlbmRTb2NrczVJbml0aWFsSGFuZHNoYWtlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5TZW50SW5pdGlhbEhhbmRzaGFrZSk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEhhbmRsZXMgU29ja2V0IGRhdGEgZXZlbnQuCiAgICAgICAqIEBwYXJhbSBkYXRhCiAgICAgICAqLwogICAgICBvbkRhdGFSZWNlaXZlZEhhbmRsZXIoZGF0YSkgewogICAgICAgIC8qCiAgICAgICAgICBBbGwgcmVjZWl2ZWQgZGF0YSBpcyBhcHBlbmRlZCB0byBhIFJlY2VpdmVCdWZmZXIuCiAgICAgICAgICBUaGlzIG1ha2VzIHN1cmUgdGhhdCBhbGwgdGhlIGRhdGEgd2UgbmVlZCBpcyByZWNlaXZlZCBiZWZvcmUgd2UgYXR0ZW1wdCB0byBwcm9jZXNzIGl0LgogICAgICAgICovCiAgICAgICAgdGhpcy5yZWNlaXZlQnVmZmVyLmFwcGVuZChkYXRhKTsKICAgICAgICAvLyBQcm9jZXNzIGRhdGEgdGhhdCB3ZSBoYXZlLgogICAgICAgIHRoaXMucHJvY2Vzc0RhdGEoKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogSGFuZGxlcyBwcm9jZXNzaW5nIG9mIHRoZSBkYXRhIHdlIGhhdmUgcmVjZWl2ZWQuCiAgICAgICAqLwogICAgICBwcm9jZXNzRGF0YSgpIHsKICAgICAgICAvLyBJZiB3ZSBoYXZlIGVub3VnaCBkYXRhIHRvIHByb2Nlc3MgdGhlIG5leHQgc3RlcCBpbiB0aGUgU09DS1MgaGFuZHNoYWtlLCBwcm9jZWVkLgogICAgICAgIHdoaWxlICh0aGlzLnN0YXRlICE9PSBjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVzdGFibGlzaGVkICYmIHRoaXMuc3RhdGUgIT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuRXJyb3IgJiYgdGhpcy5yZWNlaXZlQnVmZmVyLmxlbmd0aCA+PSB0aGlzLm5leHRSZXF1aXJlZFBhY2tldEJ1ZmZlclNpemUpIHsKICAgICAgICAgIC8vIFNlbnQgaW5pdGlhbCBoYW5kc2hha2UsIHdhaXRpbmcgZm9yIHJlc3BvbnNlLgogICAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuU2VudEluaXRpYWxIYW5kc2hha2UpIHsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5wcm94eS50eXBlID09PSA0KSB7CiAgICAgICAgICAgICAgLy8gU29ja3MgdjQgb25seSBoYXMgb25lIGhhbmRzaGFrZSByZXNwb25zZS4KICAgICAgICAgICAgICB0aGlzLmhhbmRsZVNvY2tzNEZpbmFsSGFuZHNoYWtlUmVzcG9uc2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBTb2NrcyB2NSBoYXMgdHdvIGhhbmRzaGFrZXMsIGhhbmRsZSBpbml0aWFsIG9uZSBoZXJlLgogICAgICAgICAgICAgIHRoaXMuaGFuZGxlSW5pdGlhbFNvY2tzNUhhbmRzaGFrZVJlc3BvbnNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gU2VudCBhdXRoIHJlcXVlc3QgZm9yIFNvY2tzIHY1LCB3YWl0aW5nIGZvciByZXNwb25zZS4KICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5TZW50QXV0aGVudGljYXRpb24pIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVJbml0aWFsU29ja3M1QXV0aGVudGljYXRpb25IYW5kc2hha2VSZXNwb25zZSgpOwogICAgICAgICAgICAvLyBTZW50IGZpbmFsIFNvY2tzIHY1IGhhbmRzaGFrZSwgd2FpdGluZyBmb3IgZmluYWwgcmVzcG9uc2UuCiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuU2VudEZpbmFsSGFuZHNoYWtlKSB7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlU29ja3M1RmluYWxIYW5kc2hha2VSZXNwb25zZSgpOwogICAgICAgICAgICAvLyBTb2NrcyBCSU5EIGVzdGFibGlzaGVkLiBXYWl0aW5nIGZvciByZW1vdGUgY29ubmVjdGlvbiB2aWEgcHJveHkuCiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc3RhdGUgPT09IGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuQm91bmRXYWl0aW5nRm9yQ29ubmVjdGlvbikgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnByb3h5LnR5cGUgPT09IDQpIHsKICAgICAgICAgICAgICB0aGlzLmhhbmRsZVNvY2tzNEluY29taW5nQ29ubmVjdGlvblJlc3BvbnNlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVTb2NrczVJbmNvbWluZ0Nvbm5lY3Rpb25SZXNwb25zZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGNvbnN0YW50c18xLkVSUk9SUy5JbnRlcm5hbEVycm9yKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBIYW5kbGVzIFNvY2tldCBjbG9zZSBldmVudC4KICAgICAgICogQHBhcmFtIGhhZF9lcnJvcgogICAgICAgKi8KICAgICAgb25DbG9zZUhhbmRsZXIoKSB7CiAgICAgICAgdGhpcy5jbG9zZVNvY2tldChjb25zdGFudHNfMS5FUlJPUlMuU29ja2V0Q2xvc2VkKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogSGFuZGxlcyBTb2NrZXQgZXJyb3IgZXZlbnQuCiAgICAgICAqIEBwYXJhbSBlcnIKICAgICAgICovCiAgICAgIG9uRXJyb3JIYW5kbGVyKGVycikgewogICAgICAgIHRoaXMuY2xvc2VTb2NrZXQoZXJyLm1lc3NhZ2UpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBSZW1vdmVzIGludGVybmFsIGV2ZW50IGxpc3RlbmVycyBvbiB0aGUgdW5kZXJseWluZyBTb2NrZXQuCiAgICAgICAqLwogICAgICByZW1vdmVJbnRlcm5hbFNvY2tldEhhbmRsZXJzKCkgewogICAgICAgIC8vIFBhdXNlcyBkYXRhIGZsb3cgb2YgdGhlIHNvY2tldCAodGhpcyBpcyBpbnRlcm5hbGx5IHJlc3VtZWQgYWZ0ZXIgJ2VzdGFibGlzaGVkJyBpcyBlbWl0dGVkKQogICAgICAgIHRoaXMuc29ja2V0LnBhdXNlKCk7CiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCB0aGlzLm9uRGF0YVJlY2VpdmVkKTsKICAgICAgICB0aGlzLnNvY2tldC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCB0aGlzLm9uQ2xvc2UpOwogICAgICAgIHRoaXMuc29ja2V0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIHRoaXMub25FcnJvcik7CiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Nvbm5lY3QnLCB0aGlzLm9uQ29ubmVjdCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIENsb3NlcyBhbmQgZGVzdHJveXMgdGhlIHVuZGVybHlpbmcgU29ja2V0LiBFbWl0cyBhbiBlcnJvciBldmVudC4KICAgICAgICogQHBhcmFtIGVyciB7IFN0cmluZyB9IEFuIGVycm9yIHN0cmluZyB0byBpbmNsdWRlIGluIGVycm9yIGV2ZW50LgogICAgICAgKi8KICAgICAgY2xvc2VTb2NrZXQoZXJyKSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIG9ubHkgb25lICdlcnJvcicgZXZlbnQgaXMgZmlyZWQgZm9yIHRoZSBsaWZldGltZSBvZiB0aGlzIFNvY2tzQ2xpZW50IGluc3RhbmNlLgogICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSBjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVycm9yKSB7CiAgICAgICAgICAvLyBTZXQgaW50ZXJuYWwgc3RhdGUgdG8gRXJyb3IuCiAgICAgICAgICB0aGlzLnNldFN0YXRlKGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuRXJyb3IpOwogICAgICAgICAgLy8gRGVzdHJveSBTb2NrZXQKICAgICAgICAgIHRoaXMuc29ja2V0LmRlc3Ryb3koKTsKICAgICAgICAgIC8vIFJlbW92ZSBpbnRlcm5hbCBsaXN0ZW5lcnMKICAgICAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxTb2NrZXRIYW5kbGVycygpOwogICAgICAgICAgLy8gRmlyZSAnZXJyb3InIGV2ZW50LgogICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyB1dGlsXzEuU29ja3NDbGllbnRFcnJvcihlcnIsIHRoaXMub3B0aW9ucykpOwogICAgICAgIH0KICAgICAgfQogICAgICAvKioKICAgICAgICogU2VuZHMgaW5pdGlhbCBTb2NrcyB2NCBoYW5kc2hha2UgcmVxdWVzdC4KICAgICAgICovCiAgICAgIHNlbmRTb2NrczRJbml0aWFsSGFuZHNoYWtlKCkgewogICAgICAgIGNvbnN0IHVzZXJJZCA9IHRoaXMub3B0aW9ucy5wcm94eS51c2VySWQgfHwgJyc7CiAgICAgICAgY29uc3QgYnVmZiA9IG5ldyBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlcigpOwogICAgICAgIGJ1ZmYud3JpdGVVSW50OCgweDA0KTsKICAgICAgICBidWZmLndyaXRlVUludDgoY29uc3RhbnRzXzEuU29ja3NDb21tYW5kW3RoaXMub3B0aW9ucy5jb21tYW5kXSk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQxNkJFKHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5wb3J0KTsKICAgICAgICAvLyBTb2NrcyA0IChJUHY0KQogICAgICAgIGlmIChuZXQuaXNJUHY0KHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSkgewogICAgICAgICAgYnVmZi53cml0ZUJ1ZmZlcigoMCwgaGVscGVyc18xLmlwVG9CdWZmZXIpKHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSk7CiAgICAgICAgICBidWZmLndyaXRlU3RyaW5nTlQodXNlcklkKTsKICAgICAgICAgIC8vIFNvY2tzIDRhIChob3N0bmFtZSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDApOwogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDApOwogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDApOwogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDEpOwogICAgICAgICAgYnVmZi53cml0ZVN0cmluZ05UKHVzZXJJZCk7CiAgICAgICAgICBidWZmLndyaXRlU3RyaW5nTlQodGhpcy5vcHRpb25zLmRlc3RpbmF0aW9uLmhvc3QpOwogICAgICAgIH0KICAgICAgICB0aGlzLm5leHRSZXF1aXJlZFBhY2tldEJ1ZmZlclNpemUgPSBjb25zdGFudHNfMS5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMuU29ja3M0UmVzcG9uc2U7CiAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoYnVmZi50b0J1ZmZlcigpKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogSGFuZGxlcyBTb2NrcyB2NCBoYW5kc2hha2UgcmVzcG9uc2UuCiAgICAgICAqIEBwYXJhbSBkYXRhCiAgICAgICAqLwogICAgICBoYW5kbGVTb2NrczRGaW5hbEhhbmRzaGFrZVJlc3BvbnNlKCkgewogICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KDgpOwogICAgICAgIGlmIChkYXRhWzFdICE9PSBjb25zdGFudHNfMS5Tb2NrczRSZXNwb25zZS5HcmFudGVkKSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGAke2NvbnN0YW50c18xLkVSUk9SUy5Tb2NrczRQcm94eVJlamVjdGVkQ29ubmVjdGlvbn0gLSAoJHtjb25zdGFudHNfMS5Tb2NrczRSZXNwb25zZVtkYXRhWzFdXX0pYCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEJpbmQgcmVzcG9uc2UKICAgICAgICAgIGlmIChjb25zdGFudHNfMS5Tb2Nrc0NvbW1hbmRbdGhpcy5vcHRpb25zLmNvbW1hbmRdID09PSBjb25zdGFudHNfMS5Tb2Nrc0NvbW1hbmQuYmluZCkgewogICAgICAgICAgICBjb25zdCBidWZmID0gc21hcnRfYnVmZmVyXzEuU21hcnRCdWZmZXIuZnJvbUJ1ZmZlcihkYXRhKTsKICAgICAgICAgICAgYnVmZi5yZWFkT2Zmc2V0ID0gMjsKICAgICAgICAgICAgY29uc3QgcmVtb3RlSG9zdCA9IHsKICAgICAgICAgICAgICBwb3J0OiBidWZmLnJlYWRVSW50MTZCRSgpLAogICAgICAgICAgICAgIGhvc3Q6ICgwLCBoZWxwZXJzXzEuaW50MzJUb0lwdjQpKGJ1ZmYucmVhZFVJbnQzMkJFKCkpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIElmIGhvc3QgaXMgMC4wLjAuMCwgc2V0IHRvIHByb3h5IGhvc3QuCiAgICAgICAgICAgIGlmIChyZW1vdGVIb3N0Lmhvc3QgPT09ICcwLjAuMC4wJykgewogICAgICAgICAgICAgIHJlbW90ZUhvc3QuaG9zdCA9IHRoaXMub3B0aW9ucy5wcm94eS5pcGFkZHJlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkJvdW5kV2FpdGluZ0ZvckNvbm5lY3Rpb24pOwogICAgICAgICAgICB0aGlzLmVtaXQoJ2JvdW5kJywgewogICAgICAgICAgICAgIHJlbW90ZUhvc3QsCiAgICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQ29ubmVjdCByZXNwb25zZQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVzdGFibGlzaGVkKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbFNvY2tldEhhbmRsZXJzKCk7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXN0YWJsaXNoZWQnLCB7CiAgICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIEhhbmRsZXMgU29ja3MgdjQgaW5jb21pbmcgY29ubmVjdGlvbiByZXF1ZXN0IChCSU5EKQogICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgKi8KICAgICAgaGFuZGxlU29ja3M0SW5jb21pbmdDb25uZWN0aW9uUmVzcG9uc2UoKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMucmVjZWl2ZUJ1ZmZlci5nZXQoOCk7CiAgICAgICAgaWYgKGRhdGFbMV0gIT09IGNvbnN0YW50c18xLlNvY2tzNFJlc3BvbnNlLkdyYW50ZWQpIHsKICAgICAgICAgIHRoaXMuY2xvc2VTb2NrZXQoYCR7Y29uc3RhbnRzXzEuRVJST1JTLlNvY2tzNFByb3h5UmVqZWN0ZWRJbmNvbWluZ0JvdW5kQ29ubmVjdGlvbn0gLSAoJHtjb25zdGFudHNfMS5Tb2NrczRSZXNwb25zZVtkYXRhWzFdXX0pYCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGJ1ZmYgPSBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlci5mcm9tQnVmZmVyKGRhdGEpOwogICAgICAgICAgYnVmZi5yZWFkT2Zmc2V0ID0gMjsKICAgICAgICAgIGNvbnN0IHJlbW90ZUhvc3QgPSB7CiAgICAgICAgICAgIHBvcnQ6IGJ1ZmYucmVhZFVJbnQxNkJFKCksCiAgICAgICAgICAgIGhvc3Q6ICgwLCBoZWxwZXJzXzEuaW50MzJUb0lwdjQpKGJ1ZmYucmVhZFVJbnQzMkJFKCkpCiAgICAgICAgICB9OwogICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVzdGFibGlzaGVkKTsKICAgICAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxTb2NrZXRIYW5kbGVycygpOwogICAgICAgICAgdGhpcy5lbWl0KCdlc3RhYmxpc2hlZCcsIHsKICAgICAgICAgICAgcmVtb3RlSG9zdCwKICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBTZW5kcyBpbml0aWFsIFNvY2tzIHY1IGhhbmRzaGFrZSByZXF1ZXN0LgogICAgICAgKi8KICAgICAgc2VuZFNvY2tzNUluaXRpYWxIYW5kc2hha2UoKSB7CiAgICAgICAgY29uc3QgYnVmZiA9IG5ldyBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlcigpOwogICAgICAgIC8vIEJ5IGRlZmF1bHQgd2UgYWx3YXlzIHN1cHBvcnQgbm8gYXV0aC4KICAgICAgICBjb25zdCBzdXBwb3J0ZWRBdXRoTWV0aG9kcyA9IFtjb25zdGFudHNfMS5Tb2NrczVBdXRoLk5vQXV0aF07CiAgICAgICAgLy8gV2Ugc2hvdWxkIG9ubHkgdGVsbCB0aGUgcHJveHkgd2Ugc3VwcG9ydCB1c2VyL3Bhc3MgYXV0aCBpZiBhdXRoIGluZm8gaXMgYWN0dWFsbHkgcHJvdmlkZWQuCiAgICAgICAgLy8gTm90ZTogQXMgb2YgVG9yIHYwLjMuNS43KywgaWYgdXNlci9wYXNzIGF1dGggaXMgYW4gb3B0aW9uIGZyb20gdGhlIGNsaWVudCwgYnkgZGVmYXVsdCBpdCB3aWxsIGFsd2F5cyB0YWtlIHByaW9yaXR5LgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucHJveHkudXNlcklkIHx8IHRoaXMub3B0aW9ucy5wcm94eS5wYXNzd29yZCkgewogICAgICAgICAgc3VwcG9ydGVkQXV0aE1ldGhvZHMucHVzaChjb25zdGFudHNfMS5Tb2NrczVBdXRoLlVzZXJQYXNzKTsKICAgICAgICB9CiAgICAgICAgLy8gQ3VzdG9tIGF1dGggbWV0aG9kPwogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucHJveHkuY3VzdG9tX2F1dGhfbWV0aG9kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHN1cHBvcnRlZEF1dGhNZXRob2RzLnB1c2godGhpcy5vcHRpb25zLnByb3h5LmN1c3RvbV9hdXRoX21ldGhvZCk7CiAgICAgICAgfQogICAgICAgIC8vIEJ1aWxkIGhhbmRzaGFrZSBwYWNrZXQKICAgICAgICBidWZmLndyaXRlVUludDgoMHgwNSk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQ4KHN1cHBvcnRlZEF1dGhNZXRob2RzLmxlbmd0aCk7CiAgICAgICAgZm9yIChjb25zdCBhdXRoTWV0aG9kIG9mIHN1cHBvcnRlZEF1dGhNZXRob2RzKSB7CiAgICAgICAgICBidWZmLndyaXRlVUludDgoYXV0aE1ldGhvZCk7CiAgICAgICAgfQogICAgICAgIHRoaXMubmV4dFJlcXVpcmVkUGFja2V0QnVmZmVyU2l6ZSA9IGNvbnN0YW50c18xLlNPQ0tTX0lOQ09NSU5HX1BBQ0tFVF9TSVpFUy5Tb2NrczVJbml0aWFsSGFuZHNoYWtlUmVzcG9uc2U7CiAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoYnVmZi50b0J1ZmZlcigpKTsKICAgICAgICB0aGlzLnNldFN0YXRlKGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuU2VudEluaXRpYWxIYW5kc2hha2UpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBIYW5kbGVzIGluaXRpYWwgU29ja3MgdjUgaGFuZHNoYWtlIHJlc3BvbnNlLgogICAgICAgKiBAcGFyYW0gZGF0YQogICAgICAgKi8KICAgICAgaGFuZGxlSW5pdGlhbFNvY2tzNUhhbmRzaGFrZVJlc3BvbnNlKCkgewogICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KDIpOwogICAgICAgIGlmIChkYXRhWzBdICE9PSAweDA1KSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3M1SW50aWFpbEhhbmRzaGFrZVNvY2tzVmVyc2lvbik7CiAgICAgICAgfSBlbHNlIGlmIChkYXRhWzFdID09PSBjb25zdGFudHNfMS5TT0NLUzVfTk9fQUNDRVBUQUJMRV9BVVRIKSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGNvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3M1SW5pdGlhbEhhbmRzaGFrZU5vQWNjZXB0ZWRBdXRoVHlwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIElmIHNlbGVjdGVkIFNvY2tzIHY1IGF1dGggbWV0aG9kIGlzIG5vIGF1dGgsIHNlbmQgZmluYWwgaGFuZHNoYWtlIHJlcXVlc3QuCiAgICAgICAgICBpZiAoZGF0YVsxXSA9PT0gY29uc3RhbnRzXzEuU29ja3M1QXV0aC5Ob0F1dGgpIHsKICAgICAgICAgICAgdGhpcy5zb2NrczVDaG9zZW5BdXRoVHlwZSA9IGNvbnN0YW50c18xLlNvY2tzNUF1dGguTm9BdXRoOwogICAgICAgICAgICB0aGlzLnNlbmRTb2NrczVDb21tYW5kUmVxdWVzdCgpOwogICAgICAgICAgICAvLyBJZiBzZWxlY3RlZCBTb2NrcyB2NSBhdXRoIG1ldGhvZCBpcyB1c2VyL3Bhc3N3b3JkLCBzZW5kIGF1dGggaGFuZHNoYWtlLgogICAgICAgICAgfSBlbHNlIGlmIChkYXRhWzFdID09PSBjb25zdGFudHNfMS5Tb2NrczVBdXRoLlVzZXJQYXNzKSB7CiAgICAgICAgICAgIHRoaXMuc29ja3M1Q2hvc2VuQXV0aFR5cGUgPSBjb25zdGFudHNfMS5Tb2NrczVBdXRoLlVzZXJQYXNzOwogICAgICAgICAgICB0aGlzLnNlbmRTb2NrczVVc2VyUGFzc0F1dGhlbnRpY2F0aW9uKCk7CiAgICAgICAgICAgIC8vIElmIHNlbGVjdGVkIFNvY2tzIHY1IGF1dGggbWV0aG9kIGlzIHRoZSBjdXN0b21fYXV0aF9tZXRob2QsIHNlbmQgY3VzdG9tIGhhbmRzaGFrZS4KICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YVsxXSA9PT0gdGhpcy5vcHRpb25zLnByb3h5LmN1c3RvbV9hdXRoX21ldGhvZCkgewogICAgICAgICAgICB0aGlzLnNvY2tzNUNob3NlbkF1dGhUeXBlID0gdGhpcy5vcHRpb25zLnByb3h5LmN1c3RvbV9hdXRoX21ldGhvZDsKICAgICAgICAgICAgdGhpcy5zZW5kU29ja3M1Q3VzdG9tQXV0aGVudGljYXRpb24oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2xvc2VTb2NrZXQoY29uc3RhbnRzXzEuRVJST1JTLkludmFsaWRTb2NrczVJbml0aWFsSGFuZHNoYWtlVW5rbm93bkF1dGhUeXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFNlbmRzIFNvY2tzIHY1IHVzZXIgJiBwYXNzd29yZCBhdXRoIGhhbmRzaGFrZS4KICAgICAgICoKICAgICAgICogTm90ZTogTm8gYXV0aCBhbmQgdXNlci9wYXNzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkLgogICAgICAgKi8KICAgICAgc2VuZFNvY2tzNVVzZXJQYXNzQXV0aGVudGljYXRpb24oKSB7CiAgICAgICAgY29uc3QgdXNlcklkID0gdGhpcy5vcHRpb25zLnByb3h5LnVzZXJJZCB8fCAnJzsKICAgICAgICBjb25zdCBwYXNzd29yZCA9IHRoaXMub3B0aW9ucy5wcm94eS5wYXNzd29yZCB8fCAnJzsKICAgICAgICBjb25zdCBidWZmID0gbmV3IHNtYXJ0X2J1ZmZlcl8xLlNtYXJ0QnVmZmVyKCk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDEpOwogICAgICAgIGJ1ZmYud3JpdGVVSW50OChCdWZmZXIuYnl0ZUxlbmd0aCh1c2VySWQpKTsKICAgICAgICBidWZmLndyaXRlU3RyaW5nKHVzZXJJZCk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQ4KEJ1ZmZlci5ieXRlTGVuZ3RoKHBhc3N3b3JkKSk7CiAgICAgICAgYnVmZi53cml0ZVN0cmluZyhwYXNzd29yZCk7CiAgICAgICAgdGhpcy5uZXh0UmVxdWlyZWRQYWNrZXRCdWZmZXJTaXplID0gY29uc3RhbnRzXzEuU09DS1NfSU5DT01JTkdfUEFDS0VUX1NJWkVTLlNvY2tzNVVzZXJQYXNzQXV0aGVudGljYXRpb25SZXNwb25zZTsKICAgICAgICB0aGlzLnNvY2tldC53cml0ZShidWZmLnRvQnVmZmVyKCkpOwogICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5TZW50QXV0aGVudGljYXRpb24pOwogICAgICB9CiAgICAgIHNlbmRTb2NrczVDdXN0b21BdXRoZW50aWNhdGlvbigpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgdGhpcy5uZXh0UmVxdWlyZWRQYWNrZXRCdWZmZXJTaXplID0gdGhpcy5vcHRpb25zLnByb3h5LmN1c3RvbV9hdXRoX3Jlc3BvbnNlX3NpemU7CiAgICAgICAgICB0aGlzLnNvY2tldC53cml0ZSh5aWVsZCB0aGlzLm9wdGlvbnMucHJveHkuY3VzdG9tX2F1dGhfcmVxdWVzdF9oYW5kbGVyKCkpOwogICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLlNlbnRBdXRoZW50aWNhdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaGFuZGxlU29ja3M1Q3VzdG9tQXV0aEhhbmRzaGFrZVJlc3BvbnNlKGRhdGEpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMub3B0aW9ucy5wcm94eS5jdXN0b21fYXV0aF9yZXNwb25zZV9oYW5kbGVyKGRhdGEpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGhhbmRsZVNvY2tzNUF1dGhlbnRpY2F0aW9uTm9BdXRoSGFuZHNoYWtlUmVzcG9uc2UoZGF0YSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICByZXR1cm4gZGF0YVsxXSA9PT0gMHgwMDsKICAgICAgICB9KTsKICAgICAgfQogICAgICBoYW5kbGVTb2NrczVBdXRoZW50aWNhdGlvblVzZXJQYXNzSGFuZHNoYWtlUmVzcG9uc2UoZGF0YSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICByZXR1cm4gZGF0YVsxXSA9PT0gMHgwMDsKICAgICAgICB9KTsKICAgICAgfQogICAgICAvKioKICAgICAgICogSGFuZGxlcyBTb2NrcyB2NSBhdXRoIGhhbmRzaGFrZSByZXNwb25zZS4KICAgICAgICogQHBhcmFtIGRhdGEKICAgICAgICovCiAgICAgIGhhbmRsZUluaXRpYWxTb2NrczVBdXRoZW50aWNhdGlvbkhhbmRzaGFrZVJlc3BvbnNlKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICB0aGlzLnNldFN0YXRlKGNvbnN0YW50c18xLlNvY2tzQ2xpZW50U3RhdGUuUmVjZWl2ZWRBdXRoZW50aWNhdGlvblJlc3BvbnNlKTsKICAgICAgICAgIGxldCBhdXRoUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICBpZiAodGhpcy5zb2NrczVDaG9zZW5BdXRoVHlwZSA9PT0gY29uc3RhbnRzXzEuU29ja3M1QXV0aC5Ob0F1dGgpIHsKICAgICAgICAgICAgYXV0aFJlc3VsdCA9IHlpZWxkIHRoaXMuaGFuZGxlU29ja3M1QXV0aGVudGljYXRpb25Ob0F1dGhIYW5kc2hha2VSZXNwb25zZSh0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KDIpKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5zb2NrczVDaG9zZW5BdXRoVHlwZSA9PT0gY29uc3RhbnRzXzEuU29ja3M1QXV0aC5Vc2VyUGFzcykgewogICAgICAgICAgICBhdXRoUmVzdWx0ID0geWllbGQgdGhpcy5oYW5kbGVTb2NrczVBdXRoZW50aWNhdGlvblVzZXJQYXNzSGFuZHNoYWtlUmVzcG9uc2UodGhpcy5yZWNlaXZlQnVmZmVyLmdldCgyKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc29ja3M1Q2hvc2VuQXV0aFR5cGUgPT09IHRoaXMub3B0aW9ucy5wcm94eS5jdXN0b21fYXV0aF9tZXRob2QpIHsKICAgICAgICAgICAgYXV0aFJlc3VsdCA9IHlpZWxkIHRoaXMuaGFuZGxlU29ja3M1Q3VzdG9tQXV0aEhhbmRzaGFrZVJlc3BvbnNlKHRoaXMucmVjZWl2ZUJ1ZmZlci5nZXQodGhpcy5vcHRpb25zLnByb3h5LmN1c3RvbV9hdXRoX3Jlc3BvbnNlX3NpemUpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghYXV0aFJlc3VsdCkgewogICAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGNvbnN0YW50c18xLkVSUk9SUy5Tb2NrczVBdXRoZW50aWNhdGlvbkZhaWxlZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNlbmRTb2NrczVDb21tYW5kUmVxdWVzdCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBTZW5kcyBTb2NrcyB2NSBmaW5hbCBoYW5kc2hha2UgcmVxdWVzdC4KICAgICAgICovCiAgICAgIHNlbmRTb2NrczVDb21tYW5kUmVxdWVzdCgpIHsKICAgICAgICBjb25zdCBidWZmID0gbmV3IHNtYXJ0X2J1ZmZlcl8xLlNtYXJ0QnVmZmVyKCk7CiAgICAgICAgYnVmZi53cml0ZVVJbnQ4KDB4MDUpOwogICAgICAgIGJ1ZmYud3JpdGVVSW50OChjb25zdGFudHNfMS5Tb2Nrc0NvbW1hbmRbdGhpcy5vcHRpb25zLmNvbW1hbmRdKTsKICAgICAgICBidWZmLndyaXRlVUludDgoMHgwMCk7CiAgICAgICAgLy8gaXB2NCwgaXB2NiwgZG9tYWluPwogICAgICAgIGlmIChuZXQuaXNJUHY0KHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSkgewogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjQpOwogICAgICAgICAgYnVmZi53cml0ZUJ1ZmZlcigoMCwgaGVscGVyc18xLmlwVG9CdWZmZXIpKHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSk7CiAgICAgICAgfSBlbHNlIGlmIChuZXQuaXNJUHY2KHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSkgewogICAgICAgICAgYnVmZi53cml0ZVVJbnQ4KGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjYpOwogICAgICAgICAgYnVmZi53cml0ZUJ1ZmZlcigoMCwgaGVscGVyc18xLmlwVG9CdWZmZXIpKHRoaXMub3B0aW9ucy5kZXN0aW5hdGlvbi5ob3N0KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1ZmYud3JpdGVVSW50OChjb25zdGFudHNfMS5Tb2NrczVIb3N0VHlwZS5Ib3N0bmFtZSk7CiAgICAgICAgICBidWZmLndyaXRlVUludDgodGhpcy5vcHRpb25zLmRlc3RpbmF0aW9uLmhvc3QubGVuZ3RoKTsKICAgICAgICAgIGJ1ZmYud3JpdGVTdHJpbmcodGhpcy5vcHRpb25zLmRlc3RpbmF0aW9uLmhvc3QpOwogICAgICAgIH0KICAgICAgICBidWZmLndyaXRlVUludDE2QkUodGhpcy5vcHRpb25zLmRlc3RpbmF0aW9uLnBvcnQpOwogICAgICAgIHRoaXMubmV4dFJlcXVpcmVkUGFja2V0QnVmZmVyU2l6ZSA9IGNvbnN0YW50c18xLlNPQ0tTX0lOQ09NSU5HX1BBQ0tFVF9TSVpFUy5Tb2NrczVSZXNwb25zZUhlYWRlcjsKICAgICAgICB0aGlzLnNvY2tldC53cml0ZShidWZmLnRvQnVmZmVyKCkpOwogICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5TZW50RmluYWxIYW5kc2hha2UpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBIYW5kbGVzIFNvY2tzIHY1IGZpbmFsIGhhbmRzaGFrZSByZXNwb25zZS4KICAgICAgICogQHBhcmFtIGRhdGEKICAgICAgICovCiAgICAgIGhhbmRsZVNvY2tzNUZpbmFsSGFuZHNoYWtlUmVzcG9uc2UoKSB7CiAgICAgICAgLy8gUGVlayBhdCBhdmFpbGFibGUgZGF0YSAod2UgbmVlZCBhdCBsZWFzdCA1IGJ5dGVzIHRvIGdldCB0aGUgaG9zdG5hbWUgbGVuZ3RoKQogICAgICAgIGNvbnN0IGhlYWRlciA9IHRoaXMucmVjZWl2ZUJ1ZmZlci5wZWVrKDUpOwogICAgICAgIGlmIChoZWFkZXJbMF0gIT09IDB4MDUgfHwgaGVhZGVyWzFdICE9PSBjb25zdGFudHNfMS5Tb2NrczVSZXNwb25zZS5HcmFudGVkKSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGAke2NvbnN0YW50c18xLkVSUk9SUy5JbnZhbGlkU29ja3M1RmluYWxIYW5kc2hha2VSZWplY3RlZH0gLSAke2NvbnN0YW50c18xLlNvY2tzNVJlc3BvbnNlW2hlYWRlclsxXV19YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFJlYWQgYWRkcmVzcyB0eXBlCiAgICAgICAgICBjb25zdCBhZGRyZXNzVHlwZSA9IGhlYWRlclszXTsKICAgICAgICAgIGxldCByZW1vdGVIb3N0OwogICAgICAgICAgbGV0IGJ1ZmY7CiAgICAgICAgICAvLyBJUHY0CiAgICAgICAgICBpZiAoYWRkcmVzc1R5cGUgPT09IGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjQpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGNvbnN0IGRhdGFOZWVkZWQgPSBjb25zdGFudHNfMS5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMuU29ja3M1UmVzcG9uc2VJUHY0OwogICAgICAgICAgICBpZiAodGhpcy5yZWNlaXZlQnVmZmVyLmxlbmd0aCA8IGRhdGFOZWVkZWQpIHsKICAgICAgICAgICAgICB0aGlzLm5leHRSZXF1aXJlZFBhY2tldEJ1ZmZlclNpemUgPSBkYXRhTmVlZGVkOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmID0gc21hcnRfYnVmZmVyXzEuU21hcnRCdWZmZXIuZnJvbUJ1ZmZlcih0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KGRhdGFOZWVkZWQpLnNsaWNlKDQpKTsKICAgICAgICAgICAgcmVtb3RlSG9zdCA9IHsKICAgICAgICAgICAgICBob3N0OiAoMCwgaGVscGVyc18xLmludDMyVG9JcHY0KShidWZmLnJlYWRVSW50MzJCRSgpKSwKICAgICAgICAgICAgICBwb3J0OiBidWZmLnJlYWRVSW50MTZCRSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIElmIGdpdmVuIGhvc3QgaXMgMC4wLjAuMCwgYXNzdW1lIHJlbW90ZSBwcm94eSBpcCBpbnN0ZWFkLgogICAgICAgICAgICBpZiAocmVtb3RlSG9zdC5ob3N0ID09PSAnMC4wLjAuMCcpIHsKICAgICAgICAgICAgICByZW1vdGVIb3N0Lmhvc3QgPSB0aGlzLm9wdGlvbnMucHJveHkuaXBhZGRyZXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEhvc3RuYW1lCiAgICAgICAgICB9IGVsc2UgaWYgKGFkZHJlc3NUeXBlID09PSBjb25zdGFudHNfMS5Tb2NrczVIb3N0VHlwZS5Ib3N0bmFtZSkgewogICAgICAgICAgICBjb25zdCBob3N0TGVuZ3RoID0gaGVhZGVyWzRdOwogICAgICAgICAgICBjb25zdCBkYXRhTmVlZGVkID0gY29uc3RhbnRzXzEuU09DS1NfSU5DT01JTkdfUEFDS0VUX1NJWkVTLlNvY2tzNVJlc3BvbnNlSG9zdG5hbWUoaG9zdExlbmd0aCk7IC8vIGhlYWRlciArIGhvc3QgbGVuZ3RoICsgaG9zdCArIHBvcnQKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGlmICh0aGlzLnJlY2VpdmVCdWZmZXIubGVuZ3RoIDwgZGF0YU5lZWRlZCkgewogICAgICAgICAgICAgIHRoaXMubmV4dFJlcXVpcmVkUGFja2V0QnVmZmVyU2l6ZSA9IGRhdGFOZWVkZWQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1ZmYgPSBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlci5mcm9tQnVmZmVyKHRoaXMucmVjZWl2ZUJ1ZmZlci5nZXQoZGF0YU5lZWRlZCkuc2xpY2UoNSkpOwogICAgICAgICAgICByZW1vdGVIb3N0ID0gewogICAgICAgICAgICAgIGhvc3Q6IGJ1ZmYucmVhZFN0cmluZyhob3N0TGVuZ3RoKSwKICAgICAgICAgICAgICBwb3J0OiBidWZmLnJlYWRVSW50MTZCRSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIElQdjYKICAgICAgICAgIH0gZWxzZSBpZiAoYWRkcmVzc1R5cGUgPT09IGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjYpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGNvbnN0IGRhdGFOZWVkZWQgPSBjb25zdGFudHNfMS5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMuU29ja3M1UmVzcG9uc2VJUHY2OwogICAgICAgICAgICBpZiAodGhpcy5yZWNlaXZlQnVmZmVyLmxlbmd0aCA8IGRhdGFOZWVkZWQpIHsKICAgICAgICAgICAgICB0aGlzLm5leHRSZXF1aXJlZFBhY2tldEJ1ZmZlclNpemUgPSBkYXRhTmVlZGVkOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmID0gc21hcnRfYnVmZmVyXzEuU21hcnRCdWZmZXIuZnJvbUJ1ZmZlcih0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KGRhdGFOZWVkZWQpLnNsaWNlKDQpKTsKICAgICAgICAgICAgcmVtb3RlSG9zdCA9IHsKICAgICAgICAgICAgICBob3N0OiBpcF9hZGRyZXNzXzEuQWRkcmVzczYuZnJvbUJ5dGVBcnJheShBcnJheS5mcm9tKGJ1ZmYucmVhZEJ1ZmZlcigxNikpKS5jYW5vbmljYWxGb3JtKCksCiAgICAgICAgICAgICAgcG9ydDogYnVmZi5yZWFkVUludDE2QkUoKQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgLy8gV2UgaGF2ZSBldmVyeXRoaW5nIHdlIG5lZWQKICAgICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5SZWNlaXZlZEZpbmFsUmVzcG9uc2UpOwogICAgICAgICAgLy8gSWYgdXNpbmcgQ09OTkVDVCwgdGhlIGNsaWVudCBpcyBub3cgaW4gdGhlIGVzdGFibGlzaGVkIHN0YXRlLgogICAgICAgICAgaWYgKGNvbnN0YW50c18xLlNvY2tzQ29tbWFuZFt0aGlzLm9wdGlvbnMuY29tbWFuZF0gPT09IGNvbnN0YW50c18xLlNvY2tzQ29tbWFuZC5jb25uZWN0KSB7CiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5Fc3RhYmxpc2hlZCk7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxTb2NrZXRIYW5kbGVycygpOwogICAgICAgICAgICB0aGlzLmVtaXQoJ2VzdGFibGlzaGVkJywgewogICAgICAgICAgICAgIHJlbW90ZUhvc3QsCiAgICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29uc3RhbnRzXzEuU29ja3NDb21tYW5kW3RoaXMub3B0aW9ucy5jb21tYW5kXSA9PT0gY29uc3RhbnRzXzEuU29ja3NDb21tYW5kLmJpbmQpIHsKICAgICAgICAgICAgLyogSWYgdXNpbmcgQklORCwgdGhlIFNvY2tzIGNsaWVudCBpcyBub3cgaW4gQm91bmRXYWl0aW5nRm9yQ29ubmVjdGlvbiBzdGF0ZS4KICAgICAgICAgICAgICAgVGhpcyBtZWFucyB0aGF0IHRoZSByZW1vdGUgcHJveHkgc2VydmVyIGlzIHdhaXRpbmcgZm9yIGEgcmVtb3RlIGNvbm5lY3Rpb24gdG8gdGhlIGJvdW5kIHBvcnQuICovCiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoY29uc3RhbnRzXzEuU29ja3NDbGllbnRTdGF0ZS5Cb3VuZFdhaXRpbmdGb3JDb25uZWN0aW9uKTsKICAgICAgICAgICAgdGhpcy5uZXh0UmVxdWlyZWRQYWNrZXRCdWZmZXJTaXplID0gY29uc3RhbnRzXzEuU09DS1NfSU5DT01JTkdfUEFDS0VUX1NJWkVTLlNvY2tzNVJlc3BvbnNlSGVhZGVyOwogICAgICAgICAgICB0aGlzLmVtaXQoJ2JvdW5kJywgewogICAgICAgICAgICAgIHJlbW90ZUhvc3QsCiAgICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLyoKICAgICAgICAgICAgICBJZiB1c2luZyBBc3NvY2lhdGUsIHRoZSBTb2NrcyBjbGllbnQgaXMgbm93IEVzdGFibGlzaGVkLiBBbmQgdGhlIHByb3h5IHNlcnZlciBpcyBub3cgYWNjZXB0aW5nIFVEUCBwYWNrZXRzIGF0IHRoZQogICAgICAgICAgICAgIGdpdmVuIGJvdW5kIHBvcnQuIFRoaXMgaW5pdGlhbCBTb2NrcyBUQ1AgY29ubmVjdGlvbiBtdXN0IHJlbWFpbiBvcGVuIGZvciB0aGUgVURQIHJlbGF5IHRvIGNvbnRpbnVlIHRvIHdvcmsuCiAgICAgICAgICAgICovCiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnN0YW50c18xLlNvY2tzQ29tbWFuZFt0aGlzLm9wdGlvbnMuY29tbWFuZF0gPT09IGNvbnN0YW50c18xLlNvY2tzQ29tbWFuZC5hc3NvY2lhdGUpIHsKICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVzdGFibGlzaGVkKTsKICAgICAgICAgICAgdGhpcy5yZW1vdmVJbnRlcm5hbFNvY2tldEhhbmRsZXJzKCk7CiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXN0YWJsaXNoZWQnLCB7CiAgICAgICAgICAgICAgcmVtb3RlSG9zdCwKICAgICAgICAgICAgICBzb2NrZXQ6IHRoaXMuc29ja2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvKioKICAgICAgICogSGFuZGxlcyBTb2NrcyB2NSBpbmNvbWluZyBjb25uZWN0aW9uIHJlcXVlc3QgKEJJTkQpLgogICAgICAgKi8KICAgICAgaGFuZGxlU29ja3M1SW5jb21pbmdDb25uZWN0aW9uUmVzcG9uc2UoKSB7CiAgICAgICAgLy8gUGVlayBhdCBhdmFpbGFibGUgZGF0YSAod2UgbmVlZCBhdCBsZWFzdCA1IGJ5dGVzIHRvIGdldCB0aGUgaG9zdG5hbWUgbGVuZ3RoKQogICAgICAgIGNvbnN0IGhlYWRlciA9IHRoaXMucmVjZWl2ZUJ1ZmZlci5wZWVrKDUpOwogICAgICAgIGlmIChoZWFkZXJbMF0gIT09IDB4MDUgfHwgaGVhZGVyWzFdICE9PSBjb25zdGFudHNfMS5Tb2NrczVSZXNwb25zZS5HcmFudGVkKSB7CiAgICAgICAgICB0aGlzLmNsb3NlU29ja2V0KGAke2NvbnN0YW50c18xLkVSUk9SUy5Tb2NrczVQcm94eVJlamVjdGVkSW5jb21pbmdCb3VuZENvbm5lY3Rpb259IC0gJHtjb25zdGFudHNfMS5Tb2NrczVSZXNwb25zZVtoZWFkZXJbMV1dfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBSZWFkIGFkZHJlc3MgdHlwZQogICAgICAgICAgY29uc3QgYWRkcmVzc1R5cGUgPSBoZWFkZXJbM107CiAgICAgICAgICBsZXQgcmVtb3RlSG9zdDsKICAgICAgICAgIGxldCBidWZmOwogICAgICAgICAgLy8gSVB2NAogICAgICAgICAgaWYgKGFkZHJlc3NUeXBlID09PSBjb25zdGFudHNfMS5Tb2NrczVIb3N0VHlwZS5JUHY0KSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIGRhdGEgaXMgYXZhaWxhYmxlLgogICAgICAgICAgICBjb25zdCBkYXRhTmVlZGVkID0gY29uc3RhbnRzXzEuU09DS1NfSU5DT01JTkdfUEFDS0VUX1NJWkVTLlNvY2tzNVJlc3BvbnNlSVB2NDsKICAgICAgICAgICAgaWYgKHRoaXMucmVjZWl2ZUJ1ZmZlci5sZW5ndGggPCBkYXRhTmVlZGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5uZXh0UmVxdWlyZWRQYWNrZXRCdWZmZXJTaXplID0gZGF0YU5lZWRlZDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVmZiA9IHNtYXJ0X2J1ZmZlcl8xLlNtYXJ0QnVmZmVyLmZyb21CdWZmZXIodGhpcy5yZWNlaXZlQnVmZmVyLmdldChkYXRhTmVlZGVkKS5zbGljZSg0KSk7CiAgICAgICAgICAgIHJlbW90ZUhvc3QgPSB7CiAgICAgICAgICAgICAgaG9zdDogKDAsIGhlbHBlcnNfMS5pbnQzMlRvSXB2NCkoYnVmZi5yZWFkVUludDMyQkUoKSksCiAgICAgICAgICAgICAgcG9ydDogYnVmZi5yZWFkVUludDE2QkUoKQogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyBJZiBnaXZlbiBob3N0IGlzIDAuMC4wLjAsIGFzc3VtZSByZW1vdGUgcHJveHkgaXAgaW5zdGVhZC4KICAgICAgICAgICAgaWYgKHJlbW90ZUhvc3QuaG9zdCA9PT0gJzAuMC4wLjAnKSB7CiAgICAgICAgICAgICAgcmVtb3RlSG9zdC5ob3N0ID0gdGhpcy5vcHRpb25zLnByb3h5LmlwYWRkcmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBIb3N0bmFtZQogICAgICAgICAgfSBlbHNlIGlmIChhZGRyZXNzVHlwZSA9PT0gY29uc3RhbnRzXzEuU29ja3M1SG9zdFR5cGUuSG9zdG5hbWUpIHsKICAgICAgICAgICAgY29uc3QgaG9zdExlbmd0aCA9IGhlYWRlcls0XTsKICAgICAgICAgICAgY29uc3QgZGF0YU5lZWRlZCA9IGNvbnN0YW50c18xLlNPQ0tTX0lOQ09NSU5HX1BBQ0tFVF9TSVpFUy5Tb2NrczVSZXNwb25zZUhvc3RuYW1lKGhvc3RMZW5ndGgpOyAvLyBoZWFkZXIgKyBob3N0IGxlbmd0aCArIHBvcnQKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGlmICh0aGlzLnJlY2VpdmVCdWZmZXIubGVuZ3RoIDwgZGF0YU5lZWRlZCkgewogICAgICAgICAgICAgIHRoaXMubmV4dFJlcXVpcmVkUGFja2V0QnVmZmVyU2l6ZSA9IGRhdGFOZWVkZWQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1ZmYgPSBzbWFydF9idWZmZXJfMS5TbWFydEJ1ZmZlci5mcm9tQnVmZmVyKHRoaXMucmVjZWl2ZUJ1ZmZlci5nZXQoZGF0YU5lZWRlZCkuc2xpY2UoNSkpOwogICAgICAgICAgICByZW1vdGVIb3N0ID0gewogICAgICAgICAgICAgIGhvc3Q6IGJ1ZmYucmVhZFN0cmluZyhob3N0TGVuZ3RoKSwKICAgICAgICAgICAgICBwb3J0OiBidWZmLnJlYWRVSW50MTZCRSgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIElQdjYKICAgICAgICAgIH0gZWxzZSBpZiAoYWRkcmVzc1R5cGUgPT09IGNvbnN0YW50c18xLlNvY2tzNUhvc3RUeXBlLklQdjYpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBhdmFpbGFibGUuCiAgICAgICAgICAgIGNvbnN0IGRhdGFOZWVkZWQgPSBjb25zdGFudHNfMS5TT0NLU19JTkNPTUlOR19QQUNLRVRfU0laRVMuU29ja3M1UmVzcG9uc2VJUHY2OwogICAgICAgICAgICBpZiAodGhpcy5yZWNlaXZlQnVmZmVyLmxlbmd0aCA8IGRhdGFOZWVkZWQpIHsKICAgICAgICAgICAgICB0aGlzLm5leHRSZXF1aXJlZFBhY2tldEJ1ZmZlclNpemUgPSBkYXRhTmVlZGVkOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmID0gc21hcnRfYnVmZmVyXzEuU21hcnRCdWZmZXIuZnJvbUJ1ZmZlcih0aGlzLnJlY2VpdmVCdWZmZXIuZ2V0KGRhdGFOZWVkZWQpLnNsaWNlKDQpKTsKICAgICAgICAgICAgcmVtb3RlSG9zdCA9IHsKICAgICAgICAgICAgICBob3N0OiBpcF9hZGRyZXNzXzEuQWRkcmVzczYuZnJvbUJ5dGVBcnJheShBcnJheS5mcm9tKGJ1ZmYucmVhZEJ1ZmZlcigxNikpKS5jYW5vbmljYWxGb3JtKCksCiAgICAgICAgICAgICAgcG9ydDogYnVmZi5yZWFkVUludDE2QkUoKQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zZXRTdGF0ZShjb25zdGFudHNfMS5Tb2Nrc0NsaWVudFN0YXRlLkVzdGFibGlzaGVkKTsKICAgICAgICAgIHRoaXMucmVtb3ZlSW50ZXJuYWxTb2NrZXRIYW5kbGVycygpOwogICAgICAgICAgdGhpcy5lbWl0KCdlc3RhYmxpc2hlZCcsIHsKICAgICAgICAgICAgcmVtb3RlSG9zdCwKICAgICAgICAgICAgc29ja2V0OiB0aGlzLnNvY2tldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGdldCBzb2Nrc0NsaWVudE9wdGlvbnMoKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0aW9ucyk7CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuU29ja3NDbGllbnQgPSBTb2Nrc0NsaWVudDsKICB9KShzb2Nrc2NsaWVudCk7CiAgcmV0dXJuIHNvY2tzY2xpZW50Owp9Cgp2YXIgaGFzUmVxdWlyZWRCdWlsZDsKZnVuY3Rpb24gcmVxdWlyZUJ1aWxkKCkgewogIGlmIChoYXNSZXF1aXJlZEJ1aWxkKSByZXR1cm4gYnVpbGQ7CiAgaGFzUmVxdWlyZWRCdWlsZCA9IDE7CiAgKGZ1bmN0aW9uIChleHBvcnRzKSB7CgogICAgdmFyIF9fY3JlYXRlQmluZGluZyA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobSwgayk7CiAgICAgIGlmICghZGVzYyB8fCAoImdldCIgaW4gZGVzYyA/ICFtLl9fZXNNb2R1bGUgOiBkZXNjLndyaXRhYmxlIHx8IGRlc2MuY29uZmlndXJhYmxlKSkgewogICAgICAgIGRlc2MgPSB7CiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCBkZXNjKTsKICAgIH0gOiBmdW5jdGlvbiAobywgbSwgaywgazIpIHsKICAgICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgICAgb1trMl0gPSBtW2tdOwogICAgfSk7CiAgICB2YXIgX19leHBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19leHBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtLCBleHBvcnRzKSB7CiAgICAgIGZvciAodmFyIHAgaW4gbSkgaWYgKHAgIT09ICJkZWZhdWx0IiAmJiAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGV4cG9ydHMsIHApKSBfX2NyZWF0ZUJpbmRpbmcoZXhwb3J0cywgbSwgcCk7CiAgICB9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICB2YWx1ZTogdHJ1ZQogICAgfSk7CiAgICBfX2V4cG9ydFN0YXIocmVxdWlyZVNvY2tzY2xpZW50KCksIGV4cG9ydHMpOwogIH0pKGJ1aWxkKTsKICByZXR1cm4gYnVpbGQ7Cn0KCnZhciBoYXNSZXF1aXJlZFNvY2tzOwpmdW5jdGlvbiByZXF1aXJlU29ja3MoKSB7CiAgaWYgKGhhc1JlcXVpcmVkU29ja3MpIHJldHVybiBzb2NrczsKICBoYXNSZXF1aXJlZFNvY2tzID0gMTsKICB2YXIgX19jcmVhdGVCaW5kaW5nID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogICAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICAgIGRlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7CiAgfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIG9bazJdID0gbVtrXTsKICB9KTsKICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHYKICAgIH0pOwogIH0gOiBmdW5jdGlvbiAobywgdikgewogICAgb1siZGVmYXVsdCJdID0gdjsKICB9KTsKICB2YXIgX19pbXBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uICgpIHsKICAgIHZhciBvd25LZXlzID0gZnVuY3Rpb24gKG8pIHsKICAgICAgb3duS2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzIHx8IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgdmFyIGFyID0gW107CiAgICAgICAgZm9yICh2YXIgayBpbiBvKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG8sIGspKSBhclthci5sZW5ndGhdID0gazsKICAgICAgICByZXR1cm4gYXI7CiAgICAgIH07CiAgICAgIHJldHVybiBvd25LZXlzKG8pOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAobW9kKSB7CiAgICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaWYgKG1vZCAhPSBudWxsKSBmb3IgKHZhciBrID0gb3duS2V5cyhtb2QpLCBpID0gMDsgaSA8IGsubGVuZ3RoOyBpKyspIGlmIChrW2ldICE9PSAiZGVmYXVsdCIpIF9fY3JlYXRlQmluZGluZyhyZXN1bHQsIG1vZCwga1tpXSk7CiAgICAgIF9fc2V0TW9kdWxlRGVmYXVsdChyZXN1bHQsIG1vZCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0oKTsKICB2YXIgX19pbXBvcnREZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAgICJkZWZhdWx0IjogbW9kCiAgICB9OwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNvY2tzLCAiX19lc01vZHVsZSIsIHsKICAgIHZhbHVlOiB0cnVlCiAgfSk7CiAgc29ja3MuZGVmYXVsdCA9IG9wZW5Tb2NrczsKICBjb25zdCBkZWJ1Z18xID0gX19pbXBvcnREZWZhdWx0KHNyY0V4cG9ydHMpOwogIGNvbnN0IHN0cmVhbV8xID0gcmVxdWlyZSQkMCQ0OwogIGNvbnN0IHNvY2tzXzEgPSByZXF1aXJlQnVpbGQoKTsKICBjb25zdCBkbnMgPSBfX2ltcG9ydFN0YXIocmVxdWlyZSQkMyk7CiAgY29uc3QgdXRpbF8xID0gcmVxdWlyZSQkMSQxOwogIGNvbnN0IGFzc2VydF8xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUkJDUpOwogIGNvbnN0IGRlYnVnID0gKDAsIGRlYnVnXzEuZGVmYXVsdCkoJ21xdHRqczpzb2NrcycpOwogIGNsYXNzIFByb3h5U3RyZWFtIGV4dGVuZHMgc3RyZWFtXzEuRHVwbGV4IHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICBzdXBlcih7CiAgICAgICAgYXV0b0Rlc3Ryb3k6IGZhbHNlCiAgICAgIH0pOwogICAgICB0aGlzLl9mbG93aW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX29uRGF0YSA9IGNodW5rID0+IHsKICAgICAgICAoMCwgYXNzZXJ0XzEuZGVmYXVsdCkodGhpcy5fc29ja2V0KTsKICAgICAgICB0aGlzLl9mbG93aW5nID0gdGhpcy5wdXNoKGNodW5rKTsKICAgICAgICBpZiAoIXRoaXMuX2Zsb3dpbmcpIHRoaXMuX3NvY2tldC5wYXVzZSgpOwogICAgICB9OwogICAgICB0aGlzLl9vbkVuZCA9ICgpID0+IHsKICAgICAgICBkZWJ1ZygncHJveHkgc3RyZWFtIHJlY2VpdmVkIEVPRicpOwogICAgICAgIHRoaXMucHVzaChudWxsKTsKICAgICAgfTsKICAgICAgdGhpcy5fb25DbG9zZSA9ICgpID0+IHsKICAgICAgICBkZWJ1ZygncHJveHkgc3RyZWFtIGNsb3NlZCcpOwogICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICB9OwogICAgICB0aGlzLl9vbkVycm9yID0gZXJyID0+IHsKICAgICAgICBkZWJ1ZygncHJveHkgc3RyZWFtIGRpZWQgd2l0aCBlcnJvciAlcycsIGVycik7CiAgICAgICAgdGhpcy5kZXN0cm95KGVycik7CiAgICAgIH07CiAgICAgIHRoaXMuY29yaygpOwogICAgfQogICAgX3N0YXJ0KHNvY2tldCkgewogICAgICBkZWJ1ZygncHJveHkgc3RyZWFtIHN0YXJ0ZWQnKTsKICAgICAgKDAsIGFzc2VydF8xLmRlZmF1bHQpKCF0aGlzLl9zb2NrZXQpOwogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICBzb2NrZXQuZGVzdHJveSh0aGlzLmVycm9yZWQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9zb2NrZXQgPSBzb2NrZXQ7CiAgICAgIGlmICghdGhpcy5fZmxvd2luZykgc29ja2V0LnBhdXNlKCk7CiAgICAgIHNvY2tldC5vbignZGF0YScsIHRoaXMuX29uRGF0YSk7CiAgICAgIHNvY2tldC5vbignZW5kJywgdGhpcy5fb25FbmQpOwogICAgICBzb2NrZXQub24oJ2Vycm9yJywgdGhpcy5fb25FcnJvcik7CiAgICAgIHNvY2tldC5vbignY2xvc2UnLCB0aGlzLl9vbkNsb3NlKTsKICAgICAgc29ja2V0LmVtaXQoJ2Nvbm5lY3QnKTsKICAgICAgdGhpcy51bmNvcmsoKTsKICAgIH0KICAgIF93cml0ZShjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7CiAgICAgICgwLCBhc3NlcnRfMS5kZWZhdWx0KSh0aGlzLl9zb2NrZXQpOwogICAgICB0aGlzLl9zb2NrZXQud3JpdGUoY2h1bmssIGNhbGxiYWNrKTsKICAgIH0KICAgIF9yZWFkKHNpemUpIHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgdGhpcy5fZmxvd2luZyA9IHRydWU7CiAgICAgIChfYiA9IChfYSA9IHRoaXMuX3NvY2tldCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlc3VtZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmNhbGwoX2EpOwogICAgfQogICAgX2Rlc3Ryb3koZXJyb3IsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBfYSwgX2I7CiAgICAgIChfYiA9IChfYSA9IHRoaXMuX3NvY2tldCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRlc3Ryb3kpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5jYWxsKF9hLCBlcnJvcik7CiAgICAgIGNhbGxiYWNrKGVycm9yKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZmF0YWwoZSkgewogICAgdHJ5IHsKICAgICAgaWYgKGUuY29kZSA9PT0gdW5kZWZpbmVkKSBlLmNvZGUgPSAnU09DS1MnOwogICAgICByZXR1cm4gZTsKICAgIH0gY2F0Y2ggKF9hKSB7CiAgICAgIHJldHVybiBlOwogICAgfQogIH0KICBmdW5jdGlvbiB0eXBlRnJvbVByb3RvY29sKHByb3RvKSB7CiAgICBzd2l0Y2ggKHByb3RvKSB7CiAgICAgIGNhc2UgJ3NvY2tzNWg6JzoKICAgICAgICByZXR1cm4gWzUsIHRydWVdOwogICAgICBjYXNlICdzb2NrczRhOic6CiAgICAgICAgcmV0dXJuIFs0LCB0cnVlXTsKICAgICAgY2FzZSAnc29ja3M1Oic6CiAgICAgICAgcmV0dXJuIFs1LCBmYWxzZV07CiAgICAgIGNhc2UgJ3NvY2tzNDonOgogICAgICAgIHJldHVybiBbNCwgZmFsc2VdOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbdW5kZWZpbmVkLCBmYWxzZV07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBhcnNlU29ja3NVcmwodXJsKSB7CiAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKHVybCk7CiAgICBpZiAocGFyc2VkVXJsLnBhdGhuYW1lIHx8IHBhcnNlZFVybC5oYXNoIHx8IHBhcnNlZFVybC5zZWFyY2gpIHsKICAgICAgdGhyb3cgZmF0YWwobmV3IEVycm9yKCdiYWQgU09DS1MgVVJMJykpOwogICAgfQogICAgY29uc3QgW3R5cGUsIHJlc29sdmVUaHJvdWdoUHJveHldID0gdHlwZUZyb21Qcm90b2NvbChwYXJzZWRVcmwucHJvdG9jb2wpOwogICAgaWYgKCF0eXBlKSB7CiAgICAgIHRocm93IGZhdGFsKG5ldyBFcnJvcignYmFkIFNPQ0tTIFVSTDogaW52YWxpZCBwcm90b2NvbCcpKTsKICAgIH0KICAgIGNvbnN0IHBvcnQgPSBwYXJzZUludChwYXJzZWRVcmwucG9ydCwgMTApOwogICAgaWYgKE51bWJlci5pc05hTihwb3J0KSkgewogICAgICB0aHJvdyBmYXRhbChuZXcgRXJyb3IoJ2JhZCBTT0NLUyBVUkw6IGludmFsaWQgcG9ydCcpKTsKICAgIH0KICAgIGNvbnN0IHByb3h5ID0gewogICAgICBob3N0OiBwYXJzZWRVcmwuaG9zdG5hbWUsCiAgICAgIHBvcnQsCiAgICAgIHR5cGUKICAgIH07CiAgICByZXR1cm4gW3Byb3h5LCByZXNvbHZlVGhyb3VnaFByb3h5XTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gY29ubmVjdFNvY2tzKGRlc3RpbmF0aW9uSG9zdCwgZGVzdGluYXRpb25Qb3J0LCBzb2Nrc1VybCwgc3RyZWFtLCBvcHRpb25zID0ge30pIHsKICAgIHZhciBfYTsKICAgIGNvbnN0IGxvb2t1cCA9IChfYSA9IG9wdGlvbnMubG9va3VwKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAoMCwgdXRpbF8xLnByb21pc2lmeSkoZG5zLmxvb2t1cCk7CiAgICBjb25zdCBbcHJveHksIHJlc29sdmVUaHJvdWdoUHJveHldID0gcGFyc2VTb2Nrc1VybChzb2Nrc1VybCk7CiAgICBpZiAoIXJlc29sdmVUaHJvdWdoUHJveHkpIHsKICAgICAgZGVidWcoJ3Jlc29sdmluZyAlcyBsb2NhbGx5JywgZGVzdGluYXRpb25Ib3N0KTsKICAgICAgZGVzdGluYXRpb25Ib3N0ID0gKGF3YWl0IGxvb2t1cChkZXN0aW5hdGlvbkhvc3QsIHsKICAgICAgICBmYW1pbHk6IHByb3h5LnR5cGUgPT09IDQgPyA0IDogMAogICAgICB9KSkuYWRkcmVzczsKICAgIH0KICAgIGRlYnVnKCdlc3RhYmxpc2hpbmcgU09DS1MlZCBjb25uZWN0aW9uIHRvICVzOiVkIHZpYSAlczolZCcsIHByb3h5LnR5cGUsIGRlc3RpbmF0aW9uSG9zdCwgZGVzdGluYXRpb25Qb3J0LCBwcm94eS5ob3N0LCBwcm94eS5wb3J0KTsKICAgIGNvbnN0IHNvY2tzQ2xpZW50ID0gbmV3IHNvY2tzXzEuU29ja3NDbGllbnQoewogICAgICBjb21tYW5kOiAnY29ubmVjdCcsCiAgICAgIGRlc3RpbmF0aW9uOiB7CiAgICAgICAgaG9zdDogZGVzdGluYXRpb25Ib3N0LAogICAgICAgIHBvcnQ6IGRlc3RpbmF0aW9uUG9ydAogICAgICB9LAogICAgICBwcm94eTogT2JqZWN0LmFzc2lnbih7fSwgcHJveHkpLAogICAgICB0aW1lb3V0OiBvcHRpb25zLnRpbWVvdXQKICAgIH0pOwogICAgc29ja3NDbGllbnQuY29ubmVjdCgpOwogICAgc29ja3NDbGllbnQub24oJ2VzdGFibGlzaGVkJywgKHsKICAgICAgc29ja2V0CiAgICB9KSA9PiBzdHJlYW0uX3N0YXJ0KHNvY2tldCkpOwogICAgc29ja3NDbGllbnQub24oJ2Vycm9yJywgZSA9PiB7CiAgICAgIGRlYnVnKCdTT0NLUyBmYWlsZWQ6ICVzJywgZSk7CiAgICAgIHN0cmVhbS5kZXN0cm95KGZhdGFsKGUpKTsKICAgIH0pOwogIH0KICBmdW5jdGlvbiBvcGVuU29ja3MoZGVzdGluYXRpb25Ib3N0LCBkZXN0aW5hdGlvblBvcnQsIHNvY2tzVXJsLCBvcHRpb25zKSB7CiAgICBkZWJ1ZygnU09DS1MgY29ubmVjdGlvbiB0byAlczolZCB2aWEgJXMnLCBkZXN0aW5hdGlvbkhvc3QsIGRlc3RpbmF0aW9uUG9ydCwgc29ja3NVcmwpOwogICAgY29uc3Qgc3RyZWFtID0gbmV3IFByb3h5U3RyZWFtKCk7CiAgICBjb25uZWN0U29ja3MoZGVzdGluYXRpb25Ib3N0LCBkZXN0aW5hdGlvblBvcnQsIHNvY2tzVXJsLCBzdHJlYW0sIG9wdGlvbnMpLmNhdGNoKGUgPT4gewogICAgICBkZWJ1ZygnU09DS1MgZmFpbGVkOiAlcycsIGUpOwogICAgICBzdHJlYW0uZGVzdHJveShlKTsKICAgIH0pOwogICAgcmV0dXJuIHN0cmVhbTsKICB9CiAgcmV0dXJuIHNvY2tzOwp9Cgp2YXIgaGFzUmVxdWlyZWRUY3A7CmZ1bmN0aW9uIHJlcXVpcmVUY3AoKSB7CiAgaWYgKGhhc1JlcXVpcmVkVGNwKSByZXR1cm4gdGNwOwogIGhhc1JlcXVpcmVkVGNwID0gMTsKICB2YXIgX19pbXBvcnREZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAgICJkZWZhdWx0IjogbW9kCiAgICB9OwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRjcCwgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGNvbnN0IG5ldF8xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUkJDEkNCk7CiAgY29uc3QgZGVidWdfMSA9IF9faW1wb3J0RGVmYXVsdChzcmNFeHBvcnRzKTsKICBjb25zdCBzb2Nrc18xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmVTb2NrcygpKTsKICBjb25zdCBkZWJ1ZyA9ICgwLCBkZWJ1Z18xLmRlZmF1bHQpKCdtcXR0anM6dGNwJyk7CiAgY29uc3QgYnVpbGRTdHJlYW0gPSAoY2xpZW50LCBvcHRzKSA9PiB7CiAgICBvcHRzLnBvcnQgPSBvcHRzLnBvcnQgfHwgMTg4MzsKICAgIG9wdHMuaG9zdG5hbWUgPSBvcHRzLmhvc3RuYW1lIHx8IG9wdHMuaG9zdCB8fCAnbG9jYWxob3N0JzsKICAgIGlmIChvcHRzLnNvY2tzUHJveHkpIHsKICAgICAgcmV0dXJuICgwLCBzb2Nrc18xLmRlZmF1bHQpKG9wdHMuaG9zdG5hbWUsIG9wdHMucG9ydCwgb3B0cy5zb2Nrc1Byb3h5LCB7CiAgICAgICAgdGltZW91dDogb3B0cy5zb2Nrc1RpbWVvdXQKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHBvcnQsCiAgICAgIHBhdGgKICAgIH0gPSBvcHRzOwogICAgY29uc3QgaG9zdCA9IG9wdHMuaG9zdG5hbWU7CiAgICBkZWJ1ZygncG9ydCAlZCBhbmQgaG9zdCAlcycsIHBvcnQsIGhvc3QpOwogICAgcmV0dXJuIG5ldF8xLmRlZmF1bHQuY3JlYXRlQ29ubmVjdGlvbih7CiAgICAgIHBvcnQsCiAgICAgIGhvc3QsCiAgICAgIHBhdGgKICAgIH0pOwogIH07CiAgdGNwLmRlZmF1bHQgPSBidWlsZFN0cmVhbTsKICByZXR1cm4gdGNwOwp9Cgp2YXIgdGxzID0ge307Cgp2YXIgaGFzUmVxdWlyZWRUbHM7CmZ1bmN0aW9uIHJlcXVpcmVUbHMoKSB7CiAgaWYgKGhhc1JlcXVpcmVkVGxzKSByZXR1cm4gdGxzOwogIGhhc1JlcXVpcmVkVGxzID0gMTsKICB2YXIgX19yZXN0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19yZXN0IHx8IGZ1bmN0aW9uIChzLCBlKSB7CiAgICB2YXIgdCA9IHt9OwogICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApICYmIGUuaW5kZXhPZihwKSA8IDApIHRbcF0gPSBzW3BdOwogICAgaWYgKHMgIT0gbnVsbCAmJiB0eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIikgZm9yICh2YXIgaSA9IDAsIHAgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHMpOyBpIDwgcC5sZW5ndGg7IGkrKykgewogICAgICBpZiAoZS5pbmRleE9mKHBbaV0pIDwgMCAmJiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwocywgcFtpXSkpIHRbcFtpXV0gPSBzW3BbaV1dOwogICAgfQogICAgcmV0dXJuIHQ7CiAgfTsKICB2YXIgX19pbXBvcnREZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICAgIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAgICAgICJkZWZhdWx0IjogbW9kCiAgICB9OwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRscywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGNvbnN0IHRsc18xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUkJDQpOwogIGNvbnN0IG5ldF8xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmUkJDEkNCk7CiAgY29uc3QgZGVidWdfMSA9IF9faW1wb3J0RGVmYXVsdChzcmNFeHBvcnRzKTsKICBjb25zdCBzb2Nrc18xID0gX19pbXBvcnREZWZhdWx0KHJlcXVpcmVTb2NrcygpKTsKICBjb25zdCBkZWJ1ZyA9ICgwLCBkZWJ1Z18xLmRlZmF1bHQpKCdtcXR0anM6dGxzJyk7CiAgZnVuY3Rpb24gY29ubmVjdChvcHRzKSB7CiAgICBjb25zdCB7CiAgICAgICAgaG9zdCwKICAgICAgICBwb3J0LAogICAgICAgIHNvY2tzUHJveHkKICAgICAgfSA9IG9wdHMsCiAgICAgIHJlc3QgPSBfX3Jlc3Qob3B0cywgWyJob3N0IiwgInBvcnQiLCAic29ja3NQcm94eSJdKTsKICAgIHJldHVybiB0bHNfMS5kZWZhdWx0LmNvbm5lY3Qoc29ja3NQcm94eSA/IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcmVzdCksIHsKICAgICAgc29ja2V0OiAoMCwgc29ja3NfMS5kZWZhdWx0KShob3N0LCBwb3J0LCBzb2Nrc1Byb3h5LCB7CiAgICAgICAgdGltZW91dDogb3B0cy5zb2Nrc1RpbWVvdXQKICAgICAgfSkKICAgIH0pIDogb3B0cyk7CiAgfQogIGNvbnN0IGJ1aWxkU3RyZWFtID0gKGNsaWVudCwgb3B0cykgPT4gewogICAgb3B0cy5wb3J0ID0gb3B0cy5wb3J0IHx8IDg4ODM7CiAgICBvcHRzLmhvc3QgPSBvcHRzLmhvc3RuYW1lIHx8IG9wdHMuaG9zdCB8fCAnbG9jYWxob3N0JzsKICAgIGlmIChuZXRfMS5kZWZhdWx0LmlzSVAob3B0cy5ob3N0KSA9PT0gMCkgewogICAgICBvcHRzLnNlcnZlcm5hbWUgPSBvcHRzLmhvc3Q7CiAgICB9CiAgICBvcHRzLnJlamVjdFVuYXV0aG9yaXplZCA9IG9wdHMucmVqZWN0VW5hdXRob3JpemVkICE9PSBmYWxzZTsKICAgIGRlbGV0ZSBvcHRzLnBhdGg7CiAgICBkZWJ1ZygncG9ydCAlZCBob3N0ICVzIHJlamVjdFVuYXV0aG9yaXplZCAlYicsIG9wdHMucG9ydCwgb3B0cy5ob3N0LCBvcHRzLnJlamVjdFVuYXV0aG9yaXplZCk7CiAgICBjb25zdCBjb25uZWN0aW9uID0gY29ubmVjdChvcHRzKTsKICAgIGNvbm5lY3Rpb24ub24oJ3NlY3VyZUNvbm5lY3QnLCAoKSA9PiB7CiAgICAgIGlmIChvcHRzLnJlamVjdFVuYXV0aG9yaXplZCAmJiAhY29ubmVjdGlvbi5hdXRob3JpemVkKSB7CiAgICAgICAgY29ubmVjdGlvbi5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignVExTIG5vdCBhdXRob3JpemVkJykpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbm5lY3Rpb24ucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgaGFuZGxlVExTZXJyb3JzKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBoYW5kbGVUTFNlcnJvcnMoZXJyKSB7CiAgICAgIGlmIChvcHRzLnJlamVjdFVuYXV0aG9yaXplZCkgewogICAgICAgIGNsaWVudC5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0KICAgICAgY29ubmVjdGlvbi5lbmQoKTsKICAgIH0KICAgIGNvbm5lY3Rpb24ub24oJ2Vycm9yJywgaGFuZGxlVExTZXJyb3JzKTsKICAgIHJldHVybiBjb25uZWN0aW9uOwogIH07CiAgdGxzLmRlZmF1bHQgPSBidWlsZFN0cmVhbTsKICByZXR1cm4gdGxzOwp9Cgp2YXIgd3gkMSA9IHt9OwoKdmFyIGhhc1JlcXVpcmVkV3g7CmZ1bmN0aW9uIHJlcXVpcmVXeCgpIHsKICBpZiAoaGFzUmVxdWlyZWRXeCkgcmV0dXJuIHd4JDE7CiAgaGFzUmVxdWlyZWRXeCA9IDE7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHd4JDEsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb25zdCBidWZmZXJfMSA9IHJlcXVpcmUkJDAkMzsKICBjb25zdCByZWFkYWJsZV9zdHJlYW1fMSA9IG91cnNFeHBvcnRzOwogIGNvbnN0IEJ1ZmZlcmVkRHVwbGV4XzEgPSByZXF1aXJlQnVmZmVyZWREdXBsZXgoKTsKICBsZXQgc29ja2V0VGFzazsKICBsZXQgcHJveHk7CiAgbGV0IHN0cmVhbTsKICBmdW5jdGlvbiBidWlsZFByb3h5KCkgewogICAgY29uc3QgX3Byb3h5ID0gbmV3IHJlYWRhYmxlX3N0cmVhbV8xLlRyYW5zZm9ybSgpOwogICAgX3Byb3h5Ll93cml0ZSA9IChjaHVuaywgZW5jb2RpbmcsIG5leHQpID0+IHsKICAgICAgc29ja2V0VGFzay5zZW5kKHsKICAgICAgICBkYXRhOiBjaHVuay5idWZmZXIsCiAgICAgICAgc3VjY2VzcygpIHsKICAgICAgICAgIG5leHQoKTsKICAgICAgICB9LAogICAgICAgIGZhaWwoZXJyTXNnKSB7CiAgICAgICAgICBuZXh0KG5ldyBFcnJvcihlcnJNc2cpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIF9wcm94eS5fZmx1c2ggPSBkb25lID0+IHsKICAgICAgc29ja2V0VGFzay5jbG9zZSh7CiAgICAgICAgc3VjY2VzcygpIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIHJldHVybiBfcHJveHk7CiAgfQogIGZ1bmN0aW9uIHNldERlZmF1bHRPcHRzKG9wdHMpIHsKICAgIGlmICghb3B0cy5ob3N0bmFtZSkgewogICAgICBvcHRzLmhvc3RuYW1lID0gJ2xvY2FsaG9zdCc7CiAgICB9CiAgICBpZiAoIW9wdHMucGF0aCkgewogICAgICBvcHRzLnBhdGggPSAnLyc7CiAgICB9CiAgICBpZiAoIW9wdHMud3NPcHRpb25zKSB7CiAgICAgIG9wdHMud3NPcHRpb25zID0ge307CiAgICB9CiAgfQogIGZ1bmN0aW9uIGJ1aWxkVXJsKG9wdHMsIGNsaWVudCkgewogICAgY29uc3QgcHJvdG9jb2wgPSBvcHRzLnByb3RvY29sID09PSAnd3hzJyA/ICd3c3MnIDogJ3dzJzsKICAgIGxldCB1cmwgPSBgJHtwcm90b2NvbH06Ly8ke29wdHMuaG9zdG5hbWV9JHtvcHRzLnBhdGh9YDsKICAgIGlmIChvcHRzLnBvcnQgJiYgb3B0cy5wb3J0ICE9PSA4MCAmJiBvcHRzLnBvcnQgIT09IDQ0MykgewogICAgICB1cmwgPSBgJHtwcm90b2NvbH06Ly8ke29wdHMuaG9zdG5hbWV9OiR7b3B0cy5wb3J0fSR7b3B0cy5wYXRofWA7CiAgICB9CiAgICBpZiAodHlwZW9mIG9wdHMudHJhbnNmb3JtV3NVcmwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdXJsID0gb3B0cy50cmFuc2Zvcm1Xc1VybCh1cmwsIG9wdHMsIGNsaWVudCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0KICBmdW5jdGlvbiBiaW5kRXZlbnRIYW5kbGVyKCkgewogICAgc29ja2V0VGFzay5vbk9wZW4oKCkgPT4gewogICAgICBzdHJlYW0uc29ja2V0UmVhZHkoKTsKICAgIH0pOwogICAgc29ja2V0VGFzay5vbk1lc3NhZ2UocmVzID0+IHsKICAgICAgbGV0IHsKICAgICAgICBkYXRhCiAgICAgIH0gPSByZXM7CiAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIGRhdGEgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShkYXRhKTtlbHNlIGRhdGEgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShkYXRhLCAndXRmOCcpOwogICAgICBwcm94eS5wdXNoKGRhdGEpOwogICAgfSk7CiAgICBzb2NrZXRUYXNrLm9uQ2xvc2UoKCkgPT4gewogICAgICBzdHJlYW0uZW1pdCgnY2xvc2UnKTsKICAgICAgc3RyZWFtLmVuZCgpOwogICAgICBzdHJlYW0uZGVzdHJveSgpOwogICAgfSk7CiAgICBzb2NrZXRUYXNrLm9uRXJyb3IoZXJyb3IgPT4gewogICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoZXJyb3IuZXJyTXNnKTsKICAgICAgc3RyZWFtLmRlc3Ryb3koZXJyKTsKICAgIH0pOwogIH0KICBjb25zdCBidWlsZFN0cmVhbSA9IChjbGllbnQsIG9wdHMpID0+IHsKICAgIG9wdHMuaG9zdG5hbWUgPSBvcHRzLmhvc3RuYW1lIHx8IG9wdHMuaG9zdDsKICAgIGlmICghb3B0cy5ob3N0bmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZXRlcm1pbmUgaG9zdC4gU3BlY2lmeSBob3N0IG1hbnVhbGx5LicpOwogICAgfQogICAgY29uc3Qgd2Vic29ja2V0U3ViUHJvdG9jb2wgPSBvcHRzLnByb3RvY29sSWQgPT09ICdNUUlzZHAnICYmIG9wdHMucHJvdG9jb2xWZXJzaW9uID09PSAzID8gJ21xdHR2My4xJyA6ICdtcXR0JzsKICAgIHNldERlZmF1bHRPcHRzKG9wdHMpOwogICAgY29uc3QgdXJsID0gYnVpbGRVcmwob3B0cywgY2xpZW50KTsKICAgIHNvY2tldFRhc2sgPSB3eC5jb25uZWN0U29ja2V0KHsKICAgICAgdXJsLAogICAgICBwcm90b2NvbHM6IFt3ZWJzb2NrZXRTdWJQcm90b2NvbF0KICAgIH0pOwogICAgcHJveHkgPSBidWlsZFByb3h5KCk7CiAgICBzdHJlYW0gPSBuZXcgQnVmZmVyZWREdXBsZXhfMS5CdWZmZXJlZER1cGxleChvcHRzLCBwcm94eSwgc29ja2V0VGFzayk7CiAgICBzdHJlYW0uX2Rlc3Ryb3kgPSAoZXJyLCBjYikgPT4gewogICAgICBzb2NrZXRUYXNrLmNsb3NlKHsKICAgICAgICBzdWNjZXNzKCkgewogICAgICAgICAgaWYgKGNiKSBjYihlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogICAgY29uc3QgZGVzdHJveVJlZiA9IHN0cmVhbS5kZXN0cm95OwogICAgc3RyZWFtLmRlc3Ryb3kgPSAoZXJyLCBjYikgPT4gewogICAgICBzdHJlYW0uZGVzdHJveSA9IGRlc3Ryb3lSZWY7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHNvY2tldFRhc2suY2xvc2UoewogICAgICAgICAgZmFpbCgpIHsKICAgICAgICAgICAgc3RyZWFtLl9kZXN0cm95KGVyciwgY2IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCAwKTsKICAgICAgcmV0dXJuIHN0cmVhbTsKICAgIH07CiAgICBiaW5kRXZlbnRIYW5kbGVyKCk7CiAgICByZXR1cm4gc3RyZWFtOwogIH07CiAgd3gkMS5kZWZhdWx0ID0gYnVpbGRTdHJlYW07CiAgcmV0dXJuIHd4JDE7Cn0KCnZhciBhbGkgPSB7fTsKCnZhciBoYXNSZXF1aXJlZEFsaTsKZnVuY3Rpb24gcmVxdWlyZUFsaSgpIHsKICBpZiAoaGFzUmVxdWlyZWRBbGkpIHJldHVybiBhbGk7CiAgaGFzUmVxdWlyZWRBbGkgPSAxOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhbGksICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb25zdCBidWZmZXJfMSA9IHJlcXVpcmUkJDAkMzsKICBjb25zdCByZWFkYWJsZV9zdHJlYW1fMSA9IG91cnNFeHBvcnRzOwogIGNvbnN0IEJ1ZmZlcmVkRHVwbGV4XzEgPSByZXF1aXJlQnVmZmVyZWREdXBsZXgoKTsKICBsZXQgbXk7CiAgbGV0IHByb3h5OwogIGxldCBzdHJlYW07CiAgbGV0IGlzSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBidWlsZFByb3h5KCkgewogICAgY29uc3QgX3Byb3h5ID0gbmV3IHJlYWRhYmxlX3N0cmVhbV8xLlRyYW5zZm9ybSgpOwogICAgX3Byb3h5Ll93cml0ZSA9IChjaHVuaywgZW5jb2RpbmcsIG5leHQpID0+IHsKICAgICAgbXkuc2VuZFNvY2tldE1lc3NhZ2UoewogICAgICAgIGRhdGE6IGNodW5rLmJ1ZmZlciwKICAgICAgICBzdWNjZXNzKCkgewogICAgICAgICAgbmV4dCgpOwogICAgICAgIH0sCiAgICAgICAgZmFpbCgpIHsKICAgICAgICAgIG5leHQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogICAgX3Byb3h5Ll9mbHVzaCA9IGRvbmUgPT4gewogICAgICBteS5jbG9zZVNvY2tldCh7CiAgICAgICAgc3VjY2VzcygpIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIHJldHVybiBfcHJveHk7CiAgfQogIGZ1bmN0aW9uIHNldERlZmF1bHRPcHRzKG9wdHMpIHsKICAgIGlmICghb3B0cy5ob3N0bmFtZSkgewogICAgICBvcHRzLmhvc3RuYW1lID0gJ2xvY2FsaG9zdCc7CiAgICB9CiAgICBpZiAoIW9wdHMucGF0aCkgewogICAgICBvcHRzLnBhdGggPSAnLyc7CiAgICB9CiAgICBpZiAoIW9wdHMud3NPcHRpb25zKSB7CiAgICAgIG9wdHMud3NPcHRpb25zID0ge307CiAgICB9CiAgfQogIGZ1bmN0aW9uIGJ1aWxkVXJsKG9wdHMsIGNsaWVudCkgewogICAgY29uc3QgcHJvdG9jb2wgPSBvcHRzLnByb3RvY29sID09PSAnYWxpcycgPyAnd3NzJyA6ICd3cyc7CiAgICBsZXQgdXJsID0gYCR7cHJvdG9jb2x9Oi8vJHtvcHRzLmhvc3RuYW1lfSR7b3B0cy5wYXRofWA7CiAgICBpZiAob3B0cy5wb3J0ICYmIG9wdHMucG9ydCAhPT0gODAgJiYgb3B0cy5wb3J0ICE9PSA0NDMpIHsKICAgICAgdXJsID0gYCR7cHJvdG9jb2x9Oi8vJHtvcHRzLmhvc3RuYW1lfToke29wdHMucG9ydH0ke29wdHMucGF0aH1gOwogICAgfQogICAgaWYgKHR5cGVvZiBvcHRzLnRyYW5zZm9ybVdzVXJsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHVybCA9IG9wdHMudHJhbnNmb3JtV3NVcmwodXJsLCBvcHRzLCBjbGllbnQpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CiAgZnVuY3Rpb24gYmluZEV2ZW50SGFuZGxlcigpIHsKICAgIGlmIChpc0luaXRpYWxpemVkKSByZXR1cm47CiAgICBpc0luaXRpYWxpemVkID0gdHJ1ZTsKICAgIG15Lm9uU29ja2V0T3BlbigoKSA9PiB7CiAgICAgIHN0cmVhbS5zb2NrZXRSZWFkeSgpOwogICAgfSk7CiAgICBteS5vblNvY2tldE1lc3NhZ2UocmVzID0+IHsKICAgICAgaWYgKHR5cGVvZiByZXMuZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBjb25zdCBidWZmZXIgPSBidWZmZXJfMS5CdWZmZXIuZnJvbShyZXMuZGF0YSwgJ2Jhc2U2NCcpOwogICAgICAgIHByb3h5LnB1c2goYnVmZmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgIHJlYWRlci5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gewogICAgICAgICAgbGV0IGRhdGEgPSByZWFkZXIucmVzdWx0OwogICAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgZGF0YSA9IGJ1ZmZlcl8xLkJ1ZmZlci5mcm9tKGRhdGEpO2Vsc2UgZGF0YSA9IGJ1ZmZlcl8xLkJ1ZmZlci5mcm9tKGRhdGEsICd1dGY4Jyk7CiAgICAgICAgICBwcm94eS5wdXNoKGRhdGEpOwogICAgICAgIH0pOwogICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihyZXMuZGF0YSk7CiAgICAgIH0KICAgIH0pOwogICAgbXkub25Tb2NrZXRDbG9zZSgoKSA9PiB7CiAgICAgIHN0cmVhbS5lbmQoKTsKICAgICAgc3RyZWFtLmRlc3Ryb3koKTsKICAgIH0pOwogICAgbXkub25Tb2NrZXRFcnJvcihlcnIgPT4gewogICAgICBzdHJlYW0uZGVzdHJveShlcnIpOwogICAgfSk7CiAgfQogIGNvbnN0IGJ1aWxkU3RyZWFtID0gKGNsaWVudCwgb3B0cykgPT4gewogICAgb3B0cy5ob3N0bmFtZSA9IG9wdHMuaG9zdG5hbWUgfHwgb3B0cy5ob3N0OwogICAgaWYgKCFvcHRzLmhvc3RuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGRldGVybWluZSBob3N0LiBTcGVjaWZ5IGhvc3QgbWFudWFsbHkuJyk7CiAgICB9CiAgICBjb25zdCB3ZWJzb2NrZXRTdWJQcm90b2NvbCA9IG9wdHMucHJvdG9jb2xJZCA9PT0gJ01RSXNkcCcgJiYgb3B0cy5wcm90b2NvbFZlcnNpb24gPT09IDMgPyAnbXF0dHYzLjEnIDogJ21xdHQnOwogICAgc2V0RGVmYXVsdE9wdHMob3B0cyk7CiAgICBjb25zdCB1cmwgPSBidWlsZFVybChvcHRzLCBjbGllbnQpOwogICAgbXkgPSBvcHRzLm15OwogICAgbXkuY29ubmVjdFNvY2tldCh7CiAgICAgIHVybCwKICAgICAgcHJvdG9jb2xzOiB3ZWJzb2NrZXRTdWJQcm90b2NvbAogICAgfSk7CiAgICBwcm94eSA9IGJ1aWxkUHJveHkoKTsKICAgIHN0cmVhbSA9IG5ldyBCdWZmZXJlZER1cGxleF8xLkJ1ZmZlcmVkRHVwbGV4KG9wdHMsIHByb3h5LCBteSk7CiAgICBiaW5kRXZlbnRIYW5kbGVyKCk7CiAgICByZXR1cm4gc3RyZWFtOwogIH07CiAgYWxpLmRlZmF1bHQgPSBidWlsZFN0cmVhbTsKICByZXR1cm4gYWxpOwp9Cgp2YXIgX19pbXBvcnREZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKICByZXR1cm4gbW9kICYmIG1vZC5fX2VzTW9kdWxlID8gbW9kIDogewogICAgImRlZmF1bHQiOiBtb2QKICB9Owp9OwpPYmplY3QuZGVmaW5lUHJvcGVydHkoY29ubmVjdCQxLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKY29ubmVjdCQxLmNvbm5lY3RBc3luYyA9IGNvbm5lY3RBc3luYzsKY29uc3QgZGVidWdfMSA9IF9faW1wb3J0RGVmYXVsdChzcmNFeHBvcnRzKTsKY29uc3QgdXJsXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZSQkNyk7CmNvbnN0IGNsaWVudF8xID0gX19pbXBvcnREZWZhdWx0KGNsaWVudCk7CmNvbnN0IGlzX2Jyb3dzZXJfMSA9IF9faW1wb3J0RGVmYXVsdChpc0Jyb3dzZXIkMSk7CmlmICh0eXBlb2YgKHByb2Nlc3MgPT09IG51bGwgfHwgcHJvY2VzcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcHJvY2Vzcy5uZXh0VGljaykgIT09ICdmdW5jdGlvbicpIHsKICBwcm9jZXNzLm5leHRUaWNrID0gc2V0SW1tZWRpYXRlOwp9CmNvbnN0IGRlYnVnID0gKDAsIGRlYnVnXzEuZGVmYXVsdCkoJ21xdHRqcycpOwpsZXQgcHJvdG9jb2xzID0gbnVsbDsKZnVuY3Rpb24gcGFyc2VBdXRoT3B0aW9ucyhvcHRzKSB7CiAgbGV0IG1hdGNoZXM7CiAgaWYgKG9wdHMuYXV0aCkgewogICAgbWF0Y2hlcyA9IG9wdHMuYXV0aC5tYXRjaCgvXiguKyk6KC4rKSQvKTsKICAgIGlmIChtYXRjaGVzKSB7CiAgICAgIG9wdHMudXNlcm5hbWUgPSBtYXRjaGVzWzFdOwogICAgICBvcHRzLnBhc3N3b3JkID0gbWF0Y2hlc1syXTsKICAgIH0gZWxzZSB7CiAgICAgIG9wdHMudXNlcm5hbWUgPSBvcHRzLmF1dGg7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGNvbm5lY3QoYnJva2VyVXJsLCBvcHRzKSB7CiAgdmFyIF9hLCBfYiwgX2M7CiAgZGVidWcoJ2Nvbm5lY3RpbmcgdG8gYW4gTVFUVCBicm9rZXIuLi4nKTsKICBpZiAodHlwZW9mIGJyb2tlclVybCA9PT0gJ29iamVjdCcgJiYgIW9wdHMpIHsKICAgIG9wdHMgPSBicm9rZXJVcmw7CiAgICBicm9rZXJVcmwgPSAnJzsKICB9CiAgb3B0cyA9IG9wdHMgfHwge307CiAgaWYgKGJyb2tlclVybCAmJiB0eXBlb2YgYnJva2VyVXJsID09PSAnc3RyaW5nJykgewogICAgY29uc3QgcGFyc2VkVXJsID0gdXJsXzEuZGVmYXVsdC5wYXJzZShicm9rZXJVcmwsIHRydWUpOwogICAgY29uc3QgcGFyc2VkT3B0aW9ucyA9IHt9OwogICAgaWYgKHBhcnNlZFVybC5wb3J0ICE9IG51bGwpIHsKICAgICAgcGFyc2VkT3B0aW9ucy5wb3J0ID0gTnVtYmVyKHBhcnNlZFVybC5wb3J0KTsKICAgIH0KICAgIHBhcnNlZE9wdGlvbnMuaG9zdCA9IHBhcnNlZFVybC5ob3N0bmFtZTsKICAgIHBhcnNlZE9wdGlvbnMucXVlcnkgPSBwYXJzZWRVcmwucXVlcnk7CiAgICBwYXJzZWRPcHRpb25zLmF1dGggPSBwYXJzZWRVcmwuYXV0aDsKICAgIHBhcnNlZE9wdGlvbnMucHJvdG9jb2wgPSBwYXJzZWRVcmwucHJvdG9jb2w7CiAgICBwYXJzZWRPcHRpb25zLnBhdGggPSBwYXJzZWRVcmwucGF0aDsKICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZE9wdGlvbnMpLCBvcHRzKTsKICAgIGlmICghb3B0cy5wcm90b2NvbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgcHJvdG9jb2wnKTsKICAgIH0KICAgIG9wdHMucHJvdG9jb2wgPSBvcHRzLnByb3RvY29sLnJlcGxhY2UoLzokLywgJycpOwogIH0KICBvcHRzLnVuaXhTb2NrZXQgPSBvcHRzLnVuaXhTb2NrZXQgfHwgKChfYSA9IG9wdHMucHJvdG9jb2wpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pbmNsdWRlcygnK3VuaXgnKSk7CiAgaWYgKG9wdHMudW5peFNvY2tldCkgewogICAgb3B0cy5wcm90b2NvbCA9IG9wdHMucHJvdG9jb2wucmVwbGFjZSgnK3VuaXgnLCAnJyk7CiAgfSBlbHNlIGlmICghKChfYiA9IG9wdHMucHJvdG9jb2wpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zdGFydHNXaXRoKCd3cycpKSAmJiAhKChfYyA9IG9wdHMucHJvdG9jb2wpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5zdGFydHNXaXRoKCd3eCcpKSkgewogICAgZGVsZXRlIG9wdHMucGF0aDsKICB9CiAgcGFyc2VBdXRoT3B0aW9ucyhvcHRzKTsKICBpZiAob3B0cy5xdWVyeSAmJiB0eXBlb2Ygb3B0cy5xdWVyeS5jbGllbnRJZCA9PT0gJ3N0cmluZycpIHsKICAgIG9wdHMuY2xpZW50SWQgPSBvcHRzLnF1ZXJ5LmNsaWVudElkOwogIH0KICBpZiAoaXNfYnJvd3Nlcl8xLmRlZmF1bHQgfHwgb3B0cy51bml4U29ja2V0KSB7CiAgICBvcHRzLnNvY2tzUHJveHkgPSB1bmRlZmluZWQ7CiAgfSBlbHNlIGlmIChvcHRzLnNvY2tzUHJveHkgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcHJvY2VzcyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIG9wdHMuc29ja3NQcm94eSA9IHByb2Nlc3MuZW52WydNUVRUSlNfU09DS1NfUFJPWFknXTsKICB9CiAgaWYgKG9wdHMuY2VydCAmJiBvcHRzLmtleSkgewogICAgaWYgKG9wdHMucHJvdG9jb2wpIHsKICAgICAgaWYgKFsnbXF0dHMnLCAnd3NzJywgJ3d4cycsICdhbGlzJ10uaW5kZXhPZihvcHRzLnByb3RvY29sKSA9PT0gLTEpIHsKICAgICAgICBzd2l0Y2ggKG9wdHMucHJvdG9jb2wpIHsKICAgICAgICAgIGNhc2UgJ21xdHQnOgogICAgICAgICAgICBvcHRzLnByb3RvY29sID0gJ21xdHRzJzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICd3cyc6CiAgICAgICAgICAgIG9wdHMucHJvdG9jb2wgPSAnd3NzJzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICd3eCc6CiAgICAgICAgICAgIG9wdHMucHJvdG9jb2wgPSAnd3hzJzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdhbGknOgogICAgICAgICAgICBvcHRzLnByb3RvY29sID0gJ2FsaXMnOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBwcm90b2NvbCBmb3Igc2VjdXJlIGNvbm5lY3Rpb246ICIke29wdHMucHJvdG9jb2x9IiFgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBzZWN1cmUgcHJvdG9jb2wga2V5Jyk7CiAgICB9CiAgfQogIGlmICghcHJvdG9jb2xzKSB7CiAgICBwcm90b2NvbHMgPSB7fTsKICAgIGlmICghaXNfYnJvd3Nlcl8xLmRlZmF1bHQgJiYgIW9wdHMuZm9yY2VOYXRpdmVXZWJTb2NrZXQpIHsKICAgICAgcHJvdG9jb2xzLndzID0gcmVxdWlyZVdzKCkuc3RyZWFtQnVpbGRlcjsKICAgICAgcHJvdG9jb2xzLndzcyA9IHJlcXVpcmVXcygpLnN0cmVhbUJ1aWxkZXI7CiAgICAgIHByb3RvY29scy5tcXR0ID0gcmVxdWlyZVRjcCgpLmRlZmF1bHQ7CiAgICAgIHByb3RvY29scy50Y3AgPSByZXF1aXJlVGNwKCkuZGVmYXVsdDsKICAgICAgcHJvdG9jb2xzLnNzbCA9IHJlcXVpcmVUbHMoKS5kZWZhdWx0OwogICAgICBwcm90b2NvbHMudGxzID0gcHJvdG9jb2xzLnNzbDsKICAgICAgcHJvdG9jb2xzLm1xdHRzID0gcmVxdWlyZVRscygpLmRlZmF1bHQ7CiAgICB9IGVsc2UgewogICAgICBwcm90b2NvbHMud3MgPSByZXF1aXJlV3MoKS5icm93c2VyU3RyZWFtQnVpbGRlcjsKICAgICAgcHJvdG9jb2xzLndzcyA9IHJlcXVpcmVXcygpLmJyb3dzZXJTdHJlYW1CdWlsZGVyOwogICAgICBwcm90b2NvbHMud3ggPSByZXF1aXJlV3goKS5kZWZhdWx0OwogICAgICBwcm90b2NvbHMud3hzID0gcmVxdWlyZVd4KCkuZGVmYXVsdDsKICAgICAgcHJvdG9jb2xzLmFsaSA9IHJlcXVpcmVBbGkoKS5kZWZhdWx0OwogICAgICBwcm90b2NvbHMuYWxpcyA9IHJlcXVpcmVBbGkoKS5kZWZhdWx0OwogICAgfQogIH0KICBpZiAoIXByb3RvY29sc1tvcHRzLnByb3RvY29sXSkgewogICAgY29uc3QgaXNTZWN1cmUgPSBbJ21xdHRzJywgJ3dzcyddLmluZGV4T2Yob3B0cy5wcm90b2NvbCkgIT09IC0xOwogICAgb3B0cy5wcm90b2NvbCA9IFsnbXF0dCcsICdtcXR0cycsICd3cycsICd3c3MnLCAnd3gnLCAnd3hzJywgJ2FsaScsICdhbGlzJ10uZmlsdGVyKChrZXksIGluZGV4KSA9PiB7CiAgICAgIGlmIChpc1NlY3VyZSAmJiBpbmRleCAlIDIgPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHR5cGVvZiBwcm90b2NvbHNba2V5XSA9PT0gJ2Z1bmN0aW9uJzsKICAgIH0pWzBdOwogIH0KICBpZiAob3B0cy5jbGVhbiA9PT0gZmFsc2UgJiYgIW9wdHMuY2xpZW50SWQpIHsKICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBjbGllbnRJZCBmb3IgdW5jbGVhbiBjbGllbnRzJyk7CiAgfQogIGlmIChvcHRzLnByb3RvY29sKSB7CiAgICBvcHRzLmRlZmF1bHRQcm90b2NvbCA9IG9wdHMucHJvdG9jb2w7CiAgfQogIGZ1bmN0aW9uIHdyYXBwZXIoY2xpZW50KSB7CiAgICBpZiAob3B0cy5zZXJ2ZXJzKSB7CiAgICAgIGlmICghY2xpZW50Ll9yZWNvbm5lY3RDb3VudCB8fCBjbGllbnQuX3JlY29ubmVjdENvdW50ID09PSBvcHRzLnNlcnZlcnMubGVuZ3RoKSB7CiAgICAgICAgY2xpZW50Ll9yZWNvbm5lY3RDb3VudCA9IDA7CiAgICAgIH0KICAgICAgb3B0cy5ob3N0ID0gb3B0cy5zZXJ2ZXJzW2NsaWVudC5fcmVjb25uZWN0Q291bnRdLmhvc3Q7CiAgICAgIG9wdHMucG9ydCA9IG9wdHMuc2VydmVyc1tjbGllbnQuX3JlY29ubmVjdENvdW50XS5wb3J0OwogICAgICBvcHRzLnByb3RvY29sID0gIW9wdHMuc2VydmVyc1tjbGllbnQuX3JlY29ubmVjdENvdW50XS5wcm90b2NvbCA/IG9wdHMuZGVmYXVsdFByb3RvY29sIDogb3B0cy5zZXJ2ZXJzW2NsaWVudC5fcmVjb25uZWN0Q291bnRdLnByb3RvY29sOwogICAgICBvcHRzLmhvc3RuYW1lID0gb3B0cy5ob3N0OwogICAgICBjbGllbnQuX3JlY29ubmVjdENvdW50Kys7CiAgICB9CiAgICBkZWJ1ZygnY2FsbGluZyBzdHJlYW1idWlsZGVyIGZvcicsIG9wdHMucHJvdG9jb2wpOwogICAgcmV0dXJuIHByb3RvY29sc1tvcHRzLnByb3RvY29sXShjbGllbnQsIG9wdHMpOwogIH0KICBjb25zdCBjbGllbnQgPSBuZXcgY2xpZW50XzEuZGVmYXVsdCh3cmFwcGVyLCBvcHRzKTsKICBjbGllbnQub24oJ2Vycm9yJywgKCkgPT4ge30pOwogIHJldHVybiBjbGllbnQ7Cn0KZnVuY3Rpb24gY29ubmVjdEFzeW5jKGJyb2tlclVybCwgb3B0cywgYWxsb3dSZXRyaWVzID0gdHJ1ZSkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBjb25zdCBjbGllbnQgPSBjb25uZWN0KGJyb2tlclVybCwgb3B0cyk7CiAgICBjb25zdCBwcm9taXNlUmVzb2x1dGlvbkxpc3RlbmVycyA9IHsKICAgICAgY29ubmVjdDogY29ubmFjayA9PiB7CiAgICAgICAgcmVtb3ZlUHJvbWlzZVJlc29sdXRpb25MaXN0ZW5lcnMoKTsKICAgICAgICByZXNvbHZlKGNsaWVudCk7CiAgICAgIH0sCiAgICAgIGVuZDogKCkgPT4gewogICAgICAgIHJlbW92ZVByb21pc2VSZXNvbHV0aW9uTGlzdGVuZXJzKCk7CiAgICAgICAgcmVzb2x2ZShjbGllbnQpOwogICAgICB9LAogICAgICBlcnJvcjogZXJyID0+IHsKICAgICAgICByZW1vdmVQcm9taXNlUmVzb2x1dGlvbkxpc3RlbmVycygpOwogICAgICAgIGNsaWVudC5lbmQoKTsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfQogICAgfTsKICAgIGlmIChhbGxvd1JldHJpZXMgPT09IGZhbHNlKSB7CiAgICAgIHByb21pc2VSZXNvbHV0aW9uTGlzdGVuZXJzLmNsb3NlID0gKCkgPT4gewogICAgICAgIHByb21pc2VSZXNvbHV0aW9uTGlzdGVuZXJzLmVycm9yKG5ldyBFcnJvcigiQ291bGRuJ3QgY29ubmVjdCB0byBzZXJ2ZXIiKSk7CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVQcm9taXNlUmVzb2x1dGlvbkxpc3RlbmVycygpIHsKICAgICAgT2JqZWN0LmtleXMocHJvbWlzZVJlc29sdXRpb25MaXN0ZW5lcnMpLmZvckVhY2goZXZlbnROYW1lID0+IHsKICAgICAgICBjbGllbnQub2ZmKGV2ZW50TmFtZSwgcHJvbWlzZVJlc29sdXRpb25MaXN0ZW5lcnNbZXZlbnROYW1lXSk7CiAgICAgIH0pOwogICAgfQogICAgT2JqZWN0LmtleXMocHJvbWlzZVJlc29sdXRpb25MaXN0ZW5lcnMpLmZvckVhY2goZXZlbnROYW1lID0+IHsKICAgICAgY2xpZW50Lm9uKGV2ZW50TmFtZSwgcHJvbWlzZVJlc29sdXRpb25MaXN0ZW5lcnNbZXZlbnROYW1lXSk7CiAgICB9KTsKICB9KTsKfQpjb25uZWN0JDEuZGVmYXVsdCA9IGNvbm5lY3Q7CgooZnVuY3Rpb24gKGV4cG9ydHMpIHsKCiAgdmFyIF9fY3JlYXRlQmluZGluZyA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fY3JlYXRlQmluZGluZyB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihtLCBrKTsKICAgIGlmICghZGVzYyB8fCAoImdldCIgaW4gZGVzYyA/ICFtLl9fZXNNb2R1bGUgOiBkZXNjLndyaXRhYmxlIHx8IGRlc2MuY29uZmlndXJhYmxlKSkgewogICAgICBkZXNjID0gewogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gbVtrXTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgazIsIGRlc2MpOwogIH0gOiBmdW5jdGlvbiAobywgbSwgaywgazIpIHsKICAgIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7CiAgICBvW2syXSA9IG1ba107CiAgfSk7CiAgdmFyIF9fc2V0TW9kdWxlRGVmYXVsdCA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fc2V0TW9kdWxlRGVmYXVsdCB8fCAoT2JqZWN0LmNyZWF0ZSA/IGZ1bmN0aW9uIChvLCB2KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgImRlZmF1bHQiLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiB2CiAgICB9KTsKICB9IDogZnVuY3Rpb24gKG8sIHYpIHsKICAgIG9bImRlZmF1bHQiXSA9IHY7CiAgfSk7CiAgdmFyIF9faW1wb3J0U3RhciA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9faW1wb3J0U3RhciB8fCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgb3duS2V5cyA9IGZ1bmN0aW9uIChvKSB7CiAgICAgIG93bktleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyB8fCBmdW5jdGlvbiAobykgewogICAgICAgIHZhciBhciA9IFtdOwogICAgICAgIGZvciAodmFyIGsgaW4gbykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvLCBrKSkgYXJbYXIubGVuZ3RoXSA9IGs7CiAgICAgICAgcmV0dXJuIGFyOwogICAgICB9OwogICAgICByZXR1cm4gb3duS2V5cyhvKTsKICAgIH07CiAgICByZXR1cm4gZnVuY3Rpb24gKG1vZCkgewogICAgICBpZiAobW9kICYmIG1vZC5fX2VzTW9kdWxlKSByZXR1cm4gbW9kOwogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGlmIChtb2QgIT0gbnVsbCkgZm9yICh2YXIgayA9IG93bktleXMobW9kKSwgaSA9IDA7IGkgPCBrLmxlbmd0aDsgaSsrKSBpZiAoa1tpXSAhPT0gImRlZmF1bHQiKSBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGtbaV0pOwogICAgICBfX3NldE1vZHVsZURlZmF1bHQocmVzdWx0LCBtb2QpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9KCk7CiAgdmFyIF9fZXhwb3J0U3RhciA9IGNvbW1vbmpzR2xvYmFsICYmIGNvbW1vbmpzR2xvYmFsLl9fZXhwb3J0U3RhciB8fCBmdW5jdGlvbiAobSwgZXhwb3J0cykgewogICAgZm9yICh2YXIgcCBpbiBtKSBpZiAocCAhPT0gImRlZmF1bHQiICYmICFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZXhwb3J0cywgcCkpIF9fY3JlYXRlQmluZGluZyhleHBvcnRzLCBtLCBwKTsKICB9OwogIHZhciBfX2ltcG9ydERlZmF1bHQgPSBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5fX2ltcG9ydERlZmF1bHQgfHwgZnVuY3Rpb24gKG1vZCkgewogICAgcmV0dXJuIG1vZCAmJiBtb2QuX19lc01vZHVsZSA/IG1vZCA6IHsKICAgICAgImRlZmF1bHQiOiBtb2QKICAgIH07CiAgfTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICB2YWx1ZTogdHJ1ZQogIH0pOwogIGV4cG9ydHMuUmVhc29uQ29kZXMgPSBleHBvcnRzLktlZXBhbGl2ZU1hbmFnZXIgPSBleHBvcnRzLlVuaXF1ZU1lc3NhZ2VJZFByb3ZpZGVyID0gZXhwb3J0cy5EZWZhdWx0TWVzc2FnZUlkUHJvdmlkZXIgPSBleHBvcnRzLlN0b3JlID0gZXhwb3J0cy5NcXR0Q2xpZW50ID0gZXhwb3J0cy5jb25uZWN0QXN5bmMgPSBleHBvcnRzLmNvbm5lY3QgPSBleHBvcnRzLkNsaWVudCA9IHZvaWQgMDsKICBjb25zdCBjbGllbnRfMSA9IF9faW1wb3J0RGVmYXVsdChjbGllbnQpOwogIGV4cG9ydHMuTXF0dENsaWVudCA9IGNsaWVudF8xLmRlZmF1bHQ7CiAgY29uc3QgZGVmYXVsdF9tZXNzYWdlX2lkX3Byb3ZpZGVyXzEgPSBfX2ltcG9ydERlZmF1bHQoZGVmYXVsdE1lc3NhZ2VJZFByb3ZpZGVyKTsKICBleHBvcnRzLkRlZmF1bHRNZXNzYWdlSWRQcm92aWRlciA9IGRlZmF1bHRfbWVzc2FnZV9pZF9wcm92aWRlcl8xLmRlZmF1bHQ7CiAgY29uc3QgdW5pcXVlX21lc3NhZ2VfaWRfcHJvdmlkZXJfMSA9IF9faW1wb3J0RGVmYXVsdCh1bmlxdWVNZXNzYWdlSWRQcm92aWRlcik7CiAgZXhwb3J0cy5VbmlxdWVNZXNzYWdlSWRQcm92aWRlciA9IHVuaXF1ZV9tZXNzYWdlX2lkX3Byb3ZpZGVyXzEuZGVmYXVsdDsKICBjb25zdCBzdG9yZV8xID0gX19pbXBvcnREZWZhdWx0KHN0b3JlKTsKICBleHBvcnRzLlN0b3JlID0gc3RvcmVfMS5kZWZhdWx0OwogIGNvbnN0IGNvbm5lY3RfMSA9IF9faW1wb3J0U3Rhcihjb25uZWN0JDEpOwogIGV4cG9ydHMuY29ubmVjdCA9IGNvbm5lY3RfMS5kZWZhdWx0OwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiY29ubmVjdEFzeW5jIiwgewogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gY29ubmVjdF8xLmNvbm5lY3RBc3luYzsKICAgIH0KICB9KTsKICBjb25zdCBLZWVwYWxpdmVNYW5hZ2VyXzEgPSBfX2ltcG9ydERlZmF1bHQoS2VlcGFsaXZlTWFuYWdlciQxKTsKICBleHBvcnRzLktlZXBhbGl2ZU1hbmFnZXIgPSBLZWVwYWxpdmVNYW5hZ2VyXzEuZGVmYXVsdDsKICBleHBvcnRzLkNsaWVudCA9IGNsaWVudF8xLmRlZmF1bHQ7CiAgX19leHBvcnRTdGFyKGNsaWVudCwgZXhwb3J0cyk7CiAgX19leHBvcnRTdGFyKHNoYXJlZCwgZXhwb3J0cyk7CiAgdmFyIGFja18xID0gYWNrOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiUmVhc29uQ29kZXMiLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBhY2tfMS5SZWFzb25Db2RlczsKICAgIH0KICB9KTsKfSkobXF0dCQyKTsKCihmdW5jdGlvbiAoZXhwb3J0cykgewoKICB2YXIgX19jcmVhdGVCaW5kaW5nID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiAgICBpZiAoazIgPT09IHVuZGVmaW5lZCkgazIgPSBrOwogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogICAgaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiAgICAgIGRlc2MgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiBtW2tdOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCBrMiwgZGVzYyk7CiAgfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gazsKICAgIG9bazJdID0gbVtrXTsKICB9KTsKICB2YXIgX19zZXRNb2R1bGVEZWZhdWx0ID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHYKICAgIH0pOwogIH0gOiBmdW5jdGlvbiAobywgdikgewogICAgb1siZGVmYXVsdCJdID0gdjsKICB9KTsKICB2YXIgX19pbXBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uICgpIHsKICAgIHZhciBvd25LZXlzID0gZnVuY3Rpb24gKG8pIHsKICAgICAgb3duS2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzIHx8IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgdmFyIGFyID0gW107CiAgICAgICAgZm9yICh2YXIgayBpbiBvKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG8sIGspKSBhclthci5sZW5ndGhdID0gazsKICAgICAgICByZXR1cm4gYXI7CiAgICAgIH07CiAgICAgIHJldHVybiBvd25LZXlzKG8pOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbiAobW9kKSB7CiAgICAgIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHJldHVybiBtb2Q7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaWYgKG1vZCAhPSBudWxsKSBmb3IgKHZhciBrID0gb3duS2V5cyhtb2QpLCBpID0gMDsgaSA8IGsubGVuZ3RoOyBpKyspIGlmIChrW2ldICE9PSAiZGVmYXVsdCIpIF9fY3JlYXRlQmluZGluZyhyZXN1bHQsIG1vZCwga1tpXSk7CiAgICAgIF9fc2V0TW9kdWxlRGVmYXVsdChyZXN1bHQsIG1vZCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0oKTsKICB2YXIgX19leHBvcnRTdGFyID0gY29tbW9uanNHbG9iYWwgJiYgY29tbW9uanNHbG9iYWwuX19leHBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtLCBleHBvcnRzKSB7CiAgICBmb3IgKHZhciBwIGluIG0pIGlmIChwICE9PSAiZGVmYXVsdCIgJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChleHBvcnRzLCBwKSkgX19jcmVhdGVCaW5kaW5nKGV4cG9ydHMsIG0sIHApOwogIH07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgdmFsdWU6IHRydWUKICB9KTsKICBjb25zdCBtcXR0ID0gX19pbXBvcnRTdGFyKG1xdHQkMik7CiAgZXhwb3J0cy5kZWZhdWx0ID0gbXF0dDsKICBfX2V4cG9ydFN0YXIobXF0dCQyLCBleHBvcnRzKTsKfSkoYnVpbGQkMSk7CnZhciBtcXR0ID0gLypAX19QVVJFX18qL2dldERlZmF1bHRFeHBvcnRGcm9tQ2pzKGJ1aWxkJDEpOwoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYW4gYEFycmF5YCBvYmplY3QuCiAqCiAqIEBzdGF0aWMKICogQG1lbWJlck9mIF8KICogQHNpbmNlIDAuMS4wCiAqIEBjYXRlZ29yeSBMYW5nCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogKiBAZXhhbXBsZQogKgogKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICogLy8gPT4gdHJ1ZQogKgogKiBfLmlzQXJyYXkoZG9jdW1lbnQuYm9keS5jaGlsZHJlbik7CiAqIC8vID0+IGZhbHNlCiAqCiAqIF8uaXNBcnJheSgnYWJjJyk7CiAqIC8vID0+IGZhbHNlCiAqCiAqIF8uaXNBcnJheShfLm5vb3ApOwogKiAvLyA9PiBmYWxzZQogKi8KdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp2YXIgaXNBcnJheSQxID0gaXNBcnJheTsKCi8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZ2xvYmFsYCBmcm9tIE5vZGUuanMuICovCnZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWwgJiYgZ2xvYmFsLk9iamVjdCA9PT0gT2JqZWN0ICYmIGdsb2JhbDsKdmFyIGZyZWVHbG9iYWwkMSA9IGZyZWVHbG9iYWw7CgovKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYHNlbGZgLiAqLwp2YXIgZnJlZVNlbGYgPSB0eXBlb2Ygc2VsZiA9PSAnb2JqZWN0JyAmJiBzZWxmICYmIHNlbGYuT2JqZWN0ID09PSBPYmplY3QgJiYgc2VsZjsKCi8qKiBVc2VkIGFzIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0LiAqLwp2YXIgcm9vdCA9IGZyZWVHbG9iYWwkMSB8fCBmcmVlU2VsZiB8fCBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpOwp2YXIgcm9vdCQxID0gcm9vdDsKCi8qKiBCdWlsdC1pbiB2YWx1ZSByZWZlcmVuY2VzLiAqLwp2YXIgU3ltYm9sJDEgPSByb290JDEuU3ltYm9sOwp2YXIgU3ltYm9sJDIgPSBTeW1ib2wkMTsKCi8qKiBVc2VkIGZvciBidWlsdC1pbiBtZXRob2QgcmVmZXJlbmNlcy4gKi8KdmFyIG9iamVjdFByb3RvJDQgPSBPYmplY3QucHJvdG90eXBlOwoKLyoqIFVzZWQgdG8gY2hlY2sgb2JqZWN0cyBmb3Igb3duIHByb3BlcnRpZXMuICovCnZhciBoYXNPd25Qcm9wZXJ0eSQzID0gb2JqZWN0UHJvdG8kNC5oYXNPd25Qcm9wZXJ0eTsKCi8qKgogKiBVc2VkIHRvIHJlc29sdmUgdGhlCiAqIFtgdG9TdHJpbmdUYWdgXShodHRwOi8vZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy1vYmplY3QucHJvdG90eXBlLnRvc3RyaW5nKQogKiBvZiB2YWx1ZXMuCiAqLwp2YXIgbmF0aXZlT2JqZWN0VG9TdHJpbmckMSA9IG9iamVjdFByb3RvJDQudG9TdHJpbmc7CgovKiogQnVpbHQtaW4gdmFsdWUgcmVmZXJlbmNlcy4gKi8KdmFyIHN5bVRvU3RyaW5nVGFnJDEgPSBTeW1ib2wkMiA/IFN5bWJvbCQyLnRvU3RyaW5nVGFnIDogdW5kZWZpbmVkOwoKLyoqCiAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgYmFzZUdldFRhZ2Agd2hpY2ggaWdub3JlcyBgU3ltYm9sLnRvU3RyaW5nVGFnYCB2YWx1ZXMuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHF1ZXJ5LgogKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSByYXcgYHRvU3RyaW5nVGFnYC4KICovCmZ1bmN0aW9uIGdldFJhd1RhZyh2YWx1ZSkgewogIHZhciBpc093biA9IGhhc093blByb3BlcnR5JDMuY2FsbCh2YWx1ZSwgc3ltVG9TdHJpbmdUYWckMSksCiAgICB0YWcgPSB2YWx1ZVtzeW1Ub1N0cmluZ1RhZyQxXTsKICB0cnkgewogICAgdmFsdWVbc3ltVG9TdHJpbmdUYWckMV0gPSB1bmRlZmluZWQ7CiAgICB2YXIgdW5tYXNrZWQgPSB0cnVlOwogIH0gY2F0Y2ggKGUpIHt9CiAgdmFyIHJlc3VsdCA9IG5hdGl2ZU9iamVjdFRvU3RyaW5nJDEuY2FsbCh2YWx1ZSk7CiAgaWYgKHVubWFza2VkKSB7CiAgICBpZiAoaXNPd24pIHsKICAgICAgdmFsdWVbc3ltVG9TdHJpbmdUYWckMV0gPSB0YWc7CiAgICB9IGVsc2UgewogICAgICBkZWxldGUgdmFsdWVbc3ltVG9TdHJpbmdUYWckMV07CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8qKiBVc2VkIGZvciBidWlsdC1pbiBtZXRob2QgcmVmZXJlbmNlcy4gKi8KdmFyIG9iamVjdFByb3RvJDMgPSBPYmplY3QucHJvdG90eXBlOwoKLyoqCiAqIFVzZWQgdG8gcmVzb2x2ZSB0aGUKICogW2B0b1N0cmluZ1RhZ2BdKGh0dHA6Ly9lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLW9iamVjdC5wcm90b3R5cGUudG9zdHJpbmcpCiAqIG9mIHZhbHVlcy4KICovCnZhciBuYXRpdmVPYmplY3RUb1N0cmluZyA9IG9iamVjdFByb3RvJDMudG9TdHJpbmc7CgovKioKICogQ29udmVydHMgYHZhbHVlYCB0byBhIHN0cmluZyB1c2luZyBgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZ2AuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbnZlcnQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBzdHJpbmcuCiAqLwpmdW5jdGlvbiBvYmplY3RUb1N0cmluZyh2YWx1ZSkgewogIHJldHVybiBuYXRpdmVPYmplY3RUb1N0cmluZy5jYWxsKHZhbHVlKTsKfQoKLyoqIGBPYmplY3QjdG9TdHJpbmdgIHJlc3VsdCByZWZlcmVuY2VzLiAqLwp2YXIgbnVsbFRhZyA9ICdbb2JqZWN0IE51bGxdJywKICB1bmRlZmluZWRUYWcgPSAnW29iamVjdCBVbmRlZmluZWRdJzsKCi8qKiBCdWlsdC1pbiB2YWx1ZSByZWZlcmVuY2VzLiAqLwp2YXIgc3ltVG9TdHJpbmdUYWcgPSBTeW1ib2wkMiA/IFN5bWJvbCQyLnRvU3RyaW5nVGFnIDogdW5kZWZpbmVkOwoKLyoqCiAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBnZXRUYWdgIHdpdGhvdXQgZmFsbGJhY2tzIGZvciBidWdneSBlbnZpcm9ubWVudHMuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHF1ZXJ5LgogKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBgdG9TdHJpbmdUYWdgLgogKi8KZnVuY3Rpb24gYmFzZUdldFRhZyh2YWx1ZSkgewogIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/IHVuZGVmaW5lZFRhZyA6IG51bGxUYWc7CiAgfQogIHJldHVybiBzeW1Ub1N0cmluZ1RhZyAmJiBzeW1Ub1N0cmluZ1RhZyBpbiBPYmplY3QodmFsdWUpID8gZ2V0UmF3VGFnKHZhbHVlKSA6IG9iamVjdFRvU3RyaW5nKHZhbHVlKTsKfQoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIG9iamVjdC1saWtlLiBBIHZhbHVlIGlzIG9iamVjdC1saWtlIGlmIGl0J3Mgbm90IGBudWxsYAogKiBhbmQgaGFzIGEgYHR5cGVvZmAgcmVzdWx0IG9mICJvYmplY3QiLgogKgogKiBAc3RhdGljCiAqIEBtZW1iZXJPZiBfCiAqIEBzaW5jZSA0LjAuMAogKiBAY2F0ZWdvcnkgTGFuZwogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgb2JqZWN0LWxpa2UsIGVsc2UgYGZhbHNlYC4KICogQGV4YW1wbGUKICoKICogXy5pc09iamVjdExpa2Uoe30pOwogKiAvLyA9PiB0cnVlCiAqCiAqIF8uaXNPYmplY3RMaWtlKFsxLCAyLCAzXSk7CiAqIC8vID0+IHRydWUKICoKICogXy5pc09iamVjdExpa2UoXy5ub29wKTsKICogLy8gPT4gZmFsc2UKICoKICogXy5pc09iamVjdExpa2UobnVsbCk7CiAqIC8vID0+IGZhbHNlCiAqLwpmdW5jdGlvbiBpc09iamVjdExpa2UodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCc7Cn0KCi8qKiBgT2JqZWN0I3RvU3RyaW5nYCByZXN1bHQgcmVmZXJlbmNlcy4gKi8KdmFyIHN5bWJvbFRhZyA9ICdbb2JqZWN0IFN5bWJvbF0nOwoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgU3ltYm9sYCBwcmltaXRpdmUgb3Igb2JqZWN0LgogKgogKiBAc3RhdGljCiAqIEBtZW1iZXJPZiBfCiAqIEBzaW5jZSA0LjAuMAogKiBAY2F0ZWdvcnkgTGFuZwogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBzeW1ib2wsIGVsc2UgYGZhbHNlYC4KICogQGV4YW1wbGUKICoKICogXy5pc1N5bWJvbChTeW1ib2wuaXRlcmF0b3IpOwogKiAvLyA9PiB0cnVlCiAqCiAqIF8uaXNTeW1ib2woJ2FiYycpOwogKiAvLyA9PiBmYWxzZQogKi8KZnVuY3Rpb24gaXNTeW1ib2wodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzeW1ib2wnIHx8IGlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgYmFzZUdldFRhZyh2YWx1ZSkgPT0gc3ltYm9sVGFnOwp9CgovKiogVXNlZCB0byBtYXRjaCBwcm9wZXJ0eSBuYW1lcyB3aXRoaW4gcHJvcGVydHkgcGF0aHMuICovCnZhciByZUlzRGVlcFByb3AgPSAvXC58XFsoPzpbXltcXV0qfChbIiddKSg/Oig/IVwxKVteXFxdfFxcLikqP1wxKVxdLywKICByZUlzUGxhaW5Qcm9wID0gL15cdyokLzsKCi8qKgogKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHByb3BlcnR5IG5hbWUgYW5kIG5vdCBhIHByb3BlcnR5IHBhdGguCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byBxdWVyeSBrZXlzIG9uLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHByb3BlcnR5IG5hbWUsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIGlzS2V5KHZhbHVlLCBvYmplY3QpIHsKICBpZiAoaXNBcnJheSQxKHZhbHVlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICBpZiAodHlwZSA9PSAnbnVtYmVyJyB8fCB0eXBlID09ICdzeW1ib2wnIHx8IHR5cGUgPT0gJ2Jvb2xlYW4nIHx8IHZhbHVlID09IG51bGwgfHwgaXNTeW1ib2wodmFsdWUpKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIHJlSXNQbGFpblByb3AudGVzdCh2YWx1ZSkgfHwgIXJlSXNEZWVwUHJvcC50ZXN0KHZhbHVlKSB8fCBvYmplY3QgIT0gbnVsbCAmJiB2YWx1ZSBpbiBPYmplY3Qob2JqZWN0KTsKfQoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHRoZQogKiBbbGFuZ3VhZ2UgdHlwZV0oaHR0cDovL3d3dy5lY21hLWludGVybmF0aW9uYWwub3JnL2VjbWEtMjYyLzcuMC8jc2VjLWVjbWFzY3JpcHQtbGFuZ3VhZ2UtdHlwZXMpCiAqIG9mIGBPYmplY3RgLiAoZS5nLiBhcnJheXMsIGZ1bmN0aW9ucywgb2JqZWN0cywgcmVnZXhlcywgYG5ldyBOdW1iZXIoMClgLCBhbmQgYG5ldyBTdHJpbmcoJycpYCkKICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgMC4xLjAKICogQGNhdGVnb3J5IExhbmcKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogKiBAZXhhbXBsZQogKgogKiBfLmlzT2JqZWN0KHt9KTsKICogLy8gPT4gdHJ1ZQogKgogKiBfLmlzT2JqZWN0KFsxLCAyLCAzXSk7CiAqIC8vID0+IHRydWUKICoKICogXy5pc09iamVjdChfLm5vb3ApOwogKiAvLyA9PiB0cnVlCiAqCiAqIF8uaXNPYmplY3QobnVsbCk7CiAqIC8vID0+IGZhbHNlCiAqLwpmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogIHZhciB0eXBlID0gdHlwZW9mIHZhbHVlOwogIHJldHVybiB2YWx1ZSAhPSBudWxsICYmICh0eXBlID09ICdvYmplY3QnIHx8IHR5cGUgPT0gJ2Z1bmN0aW9uJyk7Cn0KCi8qKiBgT2JqZWN0I3RvU3RyaW5nYCByZXN1bHQgcmVmZXJlbmNlcy4gKi8KdmFyIGFzeW5jVGFnID0gJ1tvYmplY3QgQXN5bmNGdW5jdGlvbl0nLAogIGZ1bmNUYWcgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogIGdlblRhZyA9ICdbb2JqZWN0IEdlbmVyYXRvckZ1bmN0aW9uXScsCiAgcHJveHlUYWcgPSAnW29iamVjdCBQcm94eV0nOwoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGNsYXNzaWZpZWQgYXMgYSBgRnVuY3Rpb25gIG9iamVjdC4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgMC4xLjAKICogQGNhdGVnb3J5IExhbmcKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICogQGV4YW1wbGUKICoKICogXy5pc0Z1bmN0aW9uKF8pOwogKiAvLyA9PiB0cnVlCiAqCiAqIF8uaXNGdW5jdGlvbigvYWJjLyk7CiAqIC8vID0+IGZhbHNlCiAqLwpmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgaWYgKCFpc09iamVjdCh2YWx1ZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgLy8gVGhlIHVzZSBvZiBgT2JqZWN0I3RvU3RyaW5nYCBhdm9pZHMgaXNzdWVzIHdpdGggdGhlIGB0eXBlb2ZgIG9wZXJhdG9yCiAgLy8gaW4gU2FmYXJpIDkgd2hpY2ggcmV0dXJucyAnb2JqZWN0JyBmb3IgdHlwZWQgYXJyYXlzIGFuZCBvdGhlciBjb25zdHJ1Y3RvcnMuCiAgdmFyIHRhZyA9IGJhc2VHZXRUYWcodmFsdWUpOwogIHJldHVybiB0YWcgPT0gZnVuY1RhZyB8fCB0YWcgPT0gZ2VuVGFnIHx8IHRhZyA9PSBhc3luY1RhZyB8fCB0YWcgPT0gcHJveHlUYWc7Cn0KCi8qKiBVc2VkIHRvIGRldGVjdCBvdmVycmVhY2hpbmcgY29yZS1qcyBzaGltcy4gKi8KdmFyIGNvcmVKc0RhdGEgPSByb290JDFbJ19fY29yZS1qc19zaGFyZWRfXyddOwp2YXIgY29yZUpzRGF0YSQxID0gY29yZUpzRGF0YTsKCi8qKiBVc2VkIHRvIGRldGVjdCBtZXRob2RzIG1hc3F1ZXJhZGluZyBhcyBuYXRpdmUuICovCnZhciBtYXNrU3JjS2V5ID0gZnVuY3Rpb24gKCkgewogIHZhciB1aWQgPSAvW14uXSskLy5leGVjKGNvcmVKc0RhdGEkMSAmJiBjb3JlSnNEYXRhJDEua2V5cyAmJiBjb3JlSnNEYXRhJDEua2V5cy5JRV9QUk9UTyB8fCAnJyk7CiAgcmV0dXJuIHVpZCA/ICdTeW1ib2woc3JjKV8xLicgKyB1aWQgOiAnJzsKfSgpOwoKLyoqCiAqIENoZWNrcyBpZiBgZnVuY2AgaGFzIGl0cyBzb3VyY2UgbWFza2VkLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGBmdW5jYCBpcyBtYXNrZWQsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIGlzTWFza2VkKGZ1bmMpIHsKICByZXR1cm4gISFtYXNrU3JjS2V5ICYmIG1hc2tTcmNLZXkgaW4gZnVuYzsKfQoKLyoqIFVzZWQgZm9yIGJ1aWx0LWluIG1ldGhvZCByZWZlcmVuY2VzLiAqLwp2YXIgZnVuY1Byb3RvJDEgPSBGdW5jdGlvbi5wcm90b3R5cGU7CgovKiogVXNlZCB0byByZXNvbHZlIHRoZSBkZWNvbXBpbGVkIHNvdXJjZSBvZiBmdW5jdGlvbnMuICovCnZhciBmdW5jVG9TdHJpbmckMSA9IGZ1bmNQcm90byQxLnRvU3RyaW5nOwoKLyoqCiAqIENvbnZlcnRzIGBmdW5jYCB0byBpdHMgc291cmNlIGNvZGUuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGNvbnZlcnQuCiAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHNvdXJjZSBjb2RlLgogKi8KZnVuY3Rpb24gdG9Tb3VyY2UoZnVuYykgewogIGlmIChmdW5jICE9IG51bGwpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBmdW5jVG9TdHJpbmckMS5jYWxsKGZ1bmMpOwogICAgfSBjYXRjaCAoZSkge30KICAgIHRyeSB7CiAgICAgIHJldHVybiBmdW5jICsgJyc7CiAgICB9IGNhdGNoIChlKSB7fQogIH0KICByZXR1cm4gJyc7Cn0KCi8qKgogKiBVc2VkIHRvIG1hdGNoIGBSZWdFeHBgCiAqIFtzeW50YXggY2hhcmFjdGVyc10oaHR0cDovL2VjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtcGF0dGVybnMpLgogKi8KdmFyIHJlUmVnRXhwQ2hhciA9IC9bXFxeJC4qKz8oKVtcXXt9fF0vZzsKCi8qKiBVc2VkIHRvIGRldGVjdCBob3N0IGNvbnN0cnVjdG9ycyAoU2FmYXJpKS4gKi8KdmFyIHJlSXNIb3N0Q3RvciA9IC9eXFtvYmplY3QgLis/Q29uc3RydWN0b3JcXSQvOwoKLyoqIFVzZWQgZm9yIGJ1aWx0LWluIG1ldGhvZCByZWZlcmVuY2VzLiAqLwp2YXIgZnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlLAogIG9iamVjdFByb3RvJDIgPSBPYmplY3QucHJvdG90eXBlOwoKLyoqIFVzZWQgdG8gcmVzb2x2ZSB0aGUgZGVjb21waWxlZCBzb3VyY2Ugb2YgZnVuY3Rpb25zLiAqLwp2YXIgZnVuY1RvU3RyaW5nID0gZnVuY1Byb3RvLnRvU3RyaW5nOwoKLyoqIFVzZWQgdG8gY2hlY2sgb2JqZWN0cyBmb3Igb3duIHByb3BlcnRpZXMuICovCnZhciBoYXNPd25Qcm9wZXJ0eSQyID0gb2JqZWN0UHJvdG8kMi5oYXNPd25Qcm9wZXJ0eTsKCi8qKiBVc2VkIHRvIGRldGVjdCBpZiBhIG1ldGhvZCBpcyBuYXRpdmUuICovCnZhciByZUlzTmF0aXZlID0gUmVnRXhwKCdeJyArIGZ1bmNUb1N0cmluZy5jYWxsKGhhc093blByb3BlcnR5JDIpLnJlcGxhY2UocmVSZWdFeHBDaGFyLCAnXFwkJicpLnJlcGxhY2UoL2hhc093blByb3BlcnR5fChmdW5jdGlvbikuKj8oPz1cXFwoKXwgZm9yIC4rPyg/PVxcXF0pL2csICckMS4qPycpICsgJyQnKTsKCi8qKgogKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc05hdGl2ZWAgd2l0aG91dCBiYWQgc2hpbSBjaGVja3MuCiAqCiAqIEBwcml2YXRlCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIG5hdGl2ZSBmdW5jdGlvbiwKICogIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIGJhc2VJc05hdGl2ZSh2YWx1ZSkgewogIGlmICghaXNPYmplY3QodmFsdWUpIHx8IGlzTWFza2VkKHZhbHVlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgcGF0dGVybiA9IGlzRnVuY3Rpb24odmFsdWUpID8gcmVJc05hdGl2ZSA6IHJlSXNIb3N0Q3RvcjsKICByZXR1cm4gcGF0dGVybi50ZXN0KHRvU291cmNlKHZhbHVlKSk7Cn0KCi8qKgogKiBHZXRzIHRoZSB2YWx1ZSBhdCBga2V5YCBvZiBgb2JqZWN0YC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHtPYmplY3R9IFtvYmplY3RdIFRoZSBvYmplY3QgdG8gcXVlcnkuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgcHJvcGVydHkgdG8gZ2V0LgogKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgcHJvcGVydHkgdmFsdWUuCiAqLwpmdW5jdGlvbiBnZXRWYWx1ZShvYmplY3QsIGtleSkgewogIHJldHVybiBvYmplY3QgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdFtrZXldOwp9CgovKioKICogR2V0cyB0aGUgbmF0aXZlIGZ1bmN0aW9uIGF0IGBrZXlgIG9mIGBvYmplY3RgLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgbWV0aG9kIHRvIGdldC4KICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZ1bmN0aW9uIGlmIGl0J3MgbmF0aXZlLCBlbHNlIGB1bmRlZmluZWRgLgogKi8KZnVuY3Rpb24gZ2V0TmF0aXZlKG9iamVjdCwga2V5KSB7CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWUob2JqZWN0LCBrZXkpOwogIHJldHVybiBiYXNlSXNOYXRpdmUodmFsdWUpID8gdmFsdWUgOiB1bmRlZmluZWQ7Cn0KCi8qIEJ1aWx0LWluIG1ldGhvZCByZWZlcmVuY2VzIHRoYXQgYXJlIHZlcmlmaWVkIHRvIGJlIG5hdGl2ZS4gKi8KdmFyIG5hdGl2ZUNyZWF0ZSA9IGdldE5hdGl2ZShPYmplY3QsICdjcmVhdGUnKTsKdmFyIG5hdGl2ZUNyZWF0ZSQxID0gbmF0aXZlQ3JlYXRlOwoKLyoqCiAqIFJlbW92ZXMgYWxsIGtleS12YWx1ZSBlbnRyaWVzIGZyb20gdGhlIGhhc2guCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGNsZWFyCiAqIEBtZW1iZXJPZiBIYXNoCiAqLwpmdW5jdGlvbiBoYXNoQ2xlYXIoKSB7CiAgdGhpcy5fX2RhdGFfXyA9IG5hdGl2ZUNyZWF0ZSQxID8gbmF0aXZlQ3JlYXRlJDEobnVsbCkgOiB7fTsKICB0aGlzLnNpemUgPSAwOwp9CgovKioKICogUmVtb3ZlcyBga2V5YCBhbmQgaXRzIHZhbHVlIGZyb20gdGhlIGhhc2guCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGRlbGV0ZQogKiBAbWVtYmVyT2YgSGFzaAogKiBAcGFyYW0ge09iamVjdH0gaGFzaCBUaGUgaGFzaCB0byBtb2RpZnkuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gcmVtb3ZlLgogKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGVudHJ5IHdhcyByZW1vdmVkLCBlbHNlIGBmYWxzZWAuCiAqLwpmdW5jdGlvbiBoYXNoRGVsZXRlKGtleSkgewogIHZhciByZXN1bHQgPSB0aGlzLmhhcyhrZXkpICYmIGRlbGV0ZSB0aGlzLl9fZGF0YV9fW2tleV07CiAgdGhpcy5zaXplIC09IHJlc3VsdCA/IDEgOiAwOwogIHJldHVybiByZXN1bHQ7Cn0KCi8qKiBVc2VkIHRvIHN0YW5kLWluIGZvciBgdW5kZWZpbmVkYCBoYXNoIHZhbHVlcy4gKi8KdmFyIEhBU0hfVU5ERUZJTkVEJDEgPSAnX19sb2Rhc2hfaGFzaF91bmRlZmluZWRfXyc7CgovKiogVXNlZCBmb3IgYnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMuICovCnZhciBvYmplY3RQcm90byQxID0gT2JqZWN0LnByb3RvdHlwZTsKCi8qKiBVc2VkIHRvIGNoZWNrIG9iamVjdHMgZm9yIG93biBwcm9wZXJ0aWVzLiAqLwp2YXIgaGFzT3duUHJvcGVydHkkMSA9IG9iamVjdFByb3RvJDEuaGFzT3duUHJvcGVydHk7CgovKioKICogR2V0cyB0aGUgaGFzaCB2YWx1ZSBmb3IgYGtleWAuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGdldAogKiBAbWVtYmVyT2YgSGFzaAogKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHZhbHVlIHRvIGdldC4KICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGVudHJ5IHZhbHVlLgogKi8KZnVuY3Rpb24gaGFzaEdldChrZXkpIHsKICB2YXIgZGF0YSA9IHRoaXMuX19kYXRhX187CiAgaWYgKG5hdGl2ZUNyZWF0ZSQxKSB7CiAgICB2YXIgcmVzdWx0ID0gZGF0YVtrZXldOwogICAgcmV0dXJuIHJlc3VsdCA9PT0gSEFTSF9VTkRFRklORUQkMSA/IHVuZGVmaW5lZCA6IHJlc3VsdDsKICB9CiAgcmV0dXJuIGhhc093blByb3BlcnR5JDEuY2FsbChkYXRhLCBrZXkpID8gZGF0YVtrZXldIDogdW5kZWZpbmVkOwp9CgovKiogVXNlZCBmb3IgYnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMuICovCnZhciBvYmplY3RQcm90byA9IE9iamVjdC5wcm90b3R5cGU7CgovKiogVXNlZCB0byBjaGVjayBvYmplY3RzIGZvciBvd24gcHJvcGVydGllcy4gKi8KdmFyIGhhc093blByb3BlcnR5ID0gb2JqZWN0UHJvdG8uaGFzT3duUHJvcGVydHk7CgovKioKICogQ2hlY2tzIGlmIGEgaGFzaCB2YWx1ZSBmb3IgYGtleWAgZXhpc3RzLgogKgogKiBAcHJpdmF0ZQogKiBAbmFtZSBoYXMKICogQG1lbWJlck9mIEhhc2gKICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBlbnRyeSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFuIGVudHJ5IGZvciBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIGhhc2hIYXMoa2V5KSB7CiAgdmFyIGRhdGEgPSB0aGlzLl9fZGF0YV9fOwogIHJldHVybiBuYXRpdmVDcmVhdGUkMSA/IGRhdGFba2V5XSAhPT0gdW5kZWZpbmVkIDogaGFzT3duUHJvcGVydHkuY2FsbChkYXRhLCBrZXkpOwp9CgovKiogVXNlZCB0byBzdGFuZC1pbiBmb3IgYHVuZGVmaW5lZGAgaGFzaCB2YWx1ZXMuICovCnZhciBIQVNIX1VOREVGSU5FRCA9ICdfX2xvZGFzaF9oYXNoX3VuZGVmaW5lZF9fJzsKCi8qKgogKiBTZXRzIHRoZSBoYXNoIGBrZXlgIHRvIGB2YWx1ZWAuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIHNldAogKiBAbWVtYmVyT2YgSGFzaAogKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHZhbHVlIHRvIHNldC4KICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LgogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBoYXNoIGluc3RhbmNlLgogKi8KZnVuY3Rpb24gaGFzaFNldChrZXksIHZhbHVlKSB7CiAgdmFyIGRhdGEgPSB0aGlzLl9fZGF0YV9fOwogIHRoaXMuc2l6ZSArPSB0aGlzLmhhcyhrZXkpID8gMCA6IDE7CiAgZGF0YVtrZXldID0gbmF0aXZlQ3JlYXRlJDEgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCA/IEhBU0hfVU5ERUZJTkVEIDogdmFsdWU7CiAgcmV0dXJuIHRoaXM7Cn0KCi8qKgogKiBDcmVhdGVzIGEgaGFzaCBvYmplY3QuCiAqCiAqIEBwcml2YXRlCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0FycmF5fSBbZW50cmllc10gVGhlIGtleS12YWx1ZSBwYWlycyB0byBjYWNoZS4KICovCmZ1bmN0aW9uIEhhc2goZW50cmllcykgewogIHZhciBpbmRleCA9IC0xLAogICAgbGVuZ3RoID0gZW50cmllcyA9PSBudWxsID8gMCA6IGVudHJpZXMubGVuZ3RoOwogIHRoaXMuY2xlYXIoKTsKICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgdmFyIGVudHJ5ID0gZW50cmllc1tpbmRleF07CiAgICB0aGlzLnNldChlbnRyeVswXSwgZW50cnlbMV0pOwogIH0KfQoKLy8gQWRkIG1ldGhvZHMgdG8gYEhhc2hgLgpIYXNoLnByb3RvdHlwZS5jbGVhciA9IGhhc2hDbGVhcjsKSGFzaC5wcm90b3R5cGVbJ2RlbGV0ZSddID0gaGFzaERlbGV0ZTsKSGFzaC5wcm90b3R5cGUuZ2V0ID0gaGFzaEdldDsKSGFzaC5wcm90b3R5cGUuaGFzID0gaGFzaEhhczsKSGFzaC5wcm90b3R5cGUuc2V0ID0gaGFzaFNldDsKCi8qKgogKiBSZW1vdmVzIGFsbCBrZXktdmFsdWUgZW50cmllcyBmcm9tIHRoZSBsaXN0IGNhY2hlLgogKgogKiBAcHJpdmF0ZQogKiBAbmFtZSBjbGVhcgogKiBAbWVtYmVyT2YgTGlzdENhY2hlCiAqLwpmdW5jdGlvbiBsaXN0Q2FjaGVDbGVhcigpIHsKICB0aGlzLl9fZGF0YV9fID0gW107CiAgdGhpcy5zaXplID0gMDsKfQoKLyoqCiAqIFBlcmZvcm1zIGEKICogW2BTYW1lVmFsdWVaZXJvYF0oaHR0cDovL2VjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtc2FtZXZhbHVlemVybykKICogY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlIGVxdWl2YWxlbnQuCiAqCiAqIEBzdGF0aWMKICogQG1lbWJlck9mIF8KICogQHNpbmNlIDQuMC4wCiAqIEBjYXRlZ29yeSBMYW5nCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEBwYXJhbSB7Kn0gb3RoZXIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdmFsdWVzIGFyZSBlcXVpdmFsZW50LCBlbHNlIGBmYWxzZWAuCiAqIEBleGFtcGxlCiAqCiAqIHZhciBvYmplY3QgPSB7ICdhJzogMSB9OwogKiB2YXIgb3RoZXIgPSB7ICdhJzogMSB9OwogKgogKiBfLmVxKG9iamVjdCwgb2JqZWN0KTsKICogLy8gPT4gdHJ1ZQogKgogKiBfLmVxKG9iamVjdCwgb3RoZXIpOwogKiAvLyA9PiBmYWxzZQogKgogKiBfLmVxKCdhJywgJ2EnKTsKICogLy8gPT4gdHJ1ZQogKgogKiBfLmVxKCdhJywgT2JqZWN0KCdhJykpOwogKiAvLyA9PiBmYWxzZQogKgogKiBfLmVxKE5hTiwgTmFOKTsKICogLy8gPT4gdHJ1ZQogKi8KZnVuY3Rpb24gZXEodmFsdWUsIG90aGVyKSB7CiAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCB2YWx1ZSAhPT0gdmFsdWUgJiYgb3RoZXIgIT09IG90aGVyOwp9CgovKioKICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGBrZXlgIGlzIGZvdW5kIGluIGBhcnJheWAgb2Yga2V5LXZhbHVlIHBhaXJzLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaW5zcGVjdC4KICogQHBhcmFtIHsqfSBrZXkgVGhlIGtleSB0byBzZWFyY2ggZm9yLgogKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSwgZWxzZSBgLTFgLgogKi8KZnVuY3Rpb24gYXNzb2NJbmRleE9mKGFycmF5LCBrZXkpIHsKICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogIHdoaWxlIChsZW5ndGgtLSkgewogICAgaWYgKGVxKGFycmF5W2xlbmd0aF1bMF0sIGtleSkpIHsKICAgICAgcmV0dXJuIGxlbmd0aDsKICAgIH0KICB9CiAgcmV0dXJuIC0xOwp9CgovKiogVXNlZCBmb3IgYnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMuICovCnZhciBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlOwoKLyoqIEJ1aWx0LWluIHZhbHVlIHJlZmVyZW5jZXMuICovCnZhciBzcGxpY2UgPSBhcnJheVByb3RvLnNwbGljZTsKCi8qKgogKiBSZW1vdmVzIGBrZXlgIGFuZCBpdHMgdmFsdWUgZnJvbSB0aGUgbGlzdCBjYWNoZS4KICoKICogQHByaXZhdGUKICogQG5hbWUgZGVsZXRlCiAqIEBtZW1iZXJPZiBMaXN0Q2FjaGUKICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byByZW1vdmUuCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZW50cnkgd2FzIHJlbW92ZWQsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIGxpc3RDYWNoZURlbGV0ZShrZXkpIHsKICB2YXIgZGF0YSA9IHRoaXMuX19kYXRhX18sCiAgICBpbmRleCA9IGFzc29jSW5kZXhPZihkYXRhLCBrZXkpOwogIGlmIChpbmRleCA8IDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGxhc3RJbmRleCA9IGRhdGEubGVuZ3RoIC0gMTsKICBpZiAoaW5kZXggPT0gbGFzdEluZGV4KSB7CiAgICBkYXRhLnBvcCgpOwogIH0gZWxzZSB7CiAgICBzcGxpY2UuY2FsbChkYXRhLCBpbmRleCwgMSk7CiAgfQogIC0tdGhpcy5zaXplOwogIHJldHVybiB0cnVlOwp9CgovKioKICogR2V0cyB0aGUgbGlzdCBjYWNoZSB2YWx1ZSBmb3IgYGtleWAuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGdldAogKiBAbWVtYmVyT2YgTGlzdENhY2hlCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gZ2V0LgogKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZW50cnkgdmFsdWUuCiAqLwpmdW5jdGlvbiBsaXN0Q2FjaGVHZXQoa2V5KSB7CiAgdmFyIGRhdGEgPSB0aGlzLl9fZGF0YV9fLAogICAgaW5kZXggPSBhc3NvY0luZGV4T2YoZGF0YSwga2V5KTsKICByZXR1cm4gaW5kZXggPCAwID8gdW5kZWZpbmVkIDogZGF0YVtpbmRleF1bMV07Cn0KCi8qKgogKiBDaGVja3MgaWYgYSBsaXN0IGNhY2hlIHZhbHVlIGZvciBga2V5YCBleGlzdHMuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGhhcwogKiBAbWVtYmVyT2YgTGlzdENhY2hlCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgZW50cnkgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbiBlbnRyeSBmb3IgYGtleWAgZXhpc3RzLCBlbHNlIGBmYWxzZWAuCiAqLwpmdW5jdGlvbiBsaXN0Q2FjaGVIYXMoa2V5KSB7CiAgcmV0dXJuIGFzc29jSW5kZXhPZih0aGlzLl9fZGF0YV9fLCBrZXkpID4gLTE7Cn0KCi8qKgogKiBTZXRzIHRoZSBsaXN0IGNhY2hlIGBrZXlgIHRvIGB2YWx1ZWAuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIHNldAogKiBAbWVtYmVyT2YgTGlzdENhY2hlCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gc2V0LgogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuCiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGxpc3QgY2FjaGUgaW5zdGFuY2UuCiAqLwpmdW5jdGlvbiBsaXN0Q2FjaGVTZXQoa2V5LCB2YWx1ZSkgewogIHZhciBkYXRhID0gdGhpcy5fX2RhdGFfXywKICAgIGluZGV4ID0gYXNzb2NJbmRleE9mKGRhdGEsIGtleSk7CiAgaWYgKGluZGV4IDwgMCkgewogICAgKyt0aGlzLnNpemU7CiAgICBkYXRhLnB1c2goW2tleSwgdmFsdWVdKTsKICB9IGVsc2UgewogICAgZGF0YVtpbmRleF1bMV0gPSB2YWx1ZTsKICB9CiAgcmV0dXJuIHRoaXM7Cn0KCi8qKgogKiBDcmVhdGVzIGFuIGxpc3QgY2FjaGUgb2JqZWN0LgogKgogKiBAcHJpdmF0ZQogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtBcnJheX0gW2VudHJpZXNdIFRoZSBrZXktdmFsdWUgcGFpcnMgdG8gY2FjaGUuCiAqLwpmdW5jdGlvbiBMaXN0Q2FjaGUoZW50cmllcykgewogIHZhciBpbmRleCA9IC0xLAogICAgbGVuZ3RoID0gZW50cmllcyA9PSBudWxsID8gMCA6IGVudHJpZXMubGVuZ3RoOwogIHRoaXMuY2xlYXIoKTsKICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgdmFyIGVudHJ5ID0gZW50cmllc1tpbmRleF07CiAgICB0aGlzLnNldChlbnRyeVswXSwgZW50cnlbMV0pOwogIH0KfQoKLy8gQWRkIG1ldGhvZHMgdG8gYExpc3RDYWNoZWAuCkxpc3RDYWNoZS5wcm90b3R5cGUuY2xlYXIgPSBsaXN0Q2FjaGVDbGVhcjsKTGlzdENhY2hlLnByb3RvdHlwZVsnZGVsZXRlJ10gPSBsaXN0Q2FjaGVEZWxldGU7Ckxpc3RDYWNoZS5wcm90b3R5cGUuZ2V0ID0gbGlzdENhY2hlR2V0OwpMaXN0Q2FjaGUucHJvdG90eXBlLmhhcyA9IGxpc3RDYWNoZUhhczsKTGlzdENhY2hlLnByb3RvdHlwZS5zZXQgPSBsaXN0Q2FjaGVTZXQ7CgovKiBCdWlsdC1pbiBtZXRob2QgcmVmZXJlbmNlcyB0aGF0IGFyZSB2ZXJpZmllZCB0byBiZSBuYXRpdmUuICovCnZhciBNYXAkMSA9IGdldE5hdGl2ZShyb290JDEsICdNYXAnKTsKdmFyIE1hcCQyID0gTWFwJDE7CgovKioKICogUmVtb3ZlcyBhbGwga2V5LXZhbHVlIGVudHJpZXMgZnJvbSB0aGUgbWFwLgogKgogKiBAcHJpdmF0ZQogKiBAbmFtZSBjbGVhcgogKiBAbWVtYmVyT2YgTWFwQ2FjaGUKICovCmZ1bmN0aW9uIG1hcENhY2hlQ2xlYXIoKSB7CiAgdGhpcy5zaXplID0gMDsKICB0aGlzLl9fZGF0YV9fID0gewogICAgJ2hhc2gnOiBuZXcgSGFzaCgpLAogICAgJ21hcCc6IG5ldyAoTWFwJDIgfHwgTGlzdENhY2hlKSgpLAogICAgJ3N0cmluZyc6IG5ldyBIYXNoKCkKICB9Owp9CgovKioKICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgc3VpdGFibGUgZm9yIHVzZSBhcyB1bmlxdWUgb2JqZWN0IGtleS4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIHN1aXRhYmxlLCBlbHNlIGBmYWxzZWAuCiAqLwpmdW5jdGlvbiBpc0tleWFibGUodmFsdWUpIHsKICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICByZXR1cm4gdHlwZSA9PSAnc3RyaW5nJyB8fCB0eXBlID09ICdudW1iZXInIHx8IHR5cGUgPT0gJ3N5bWJvbCcgfHwgdHlwZSA9PSAnYm9vbGVhbicgPyB2YWx1ZSAhPT0gJ19fcHJvdG9fXycgOiB2YWx1ZSA9PT0gbnVsbDsKfQoKLyoqCiAqIEdldHMgdGhlIGRhdGEgZm9yIGBtYXBgLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge09iamVjdH0gbWFwIFRoZSBtYXAgdG8gcXVlcnkuCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIHJlZmVyZW5jZSBrZXkuCiAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtYXAgZGF0YS4KICovCmZ1bmN0aW9uIGdldE1hcERhdGEobWFwLCBrZXkpIHsKICB2YXIgZGF0YSA9IG1hcC5fX2RhdGFfXzsKICByZXR1cm4gaXNLZXlhYmxlKGtleSkgPyBkYXRhW3R5cGVvZiBrZXkgPT0gJ3N0cmluZycgPyAnc3RyaW5nJyA6ICdoYXNoJ10gOiBkYXRhLm1hcDsKfQoKLyoqCiAqIFJlbW92ZXMgYGtleWAgYW5kIGl0cyB2YWx1ZSBmcm9tIHRoZSBtYXAuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGRlbGV0ZQogKiBAbWVtYmVyT2YgTWFwQ2FjaGUKICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSB2YWx1ZSB0byByZW1vdmUuCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZW50cnkgd2FzIHJlbW92ZWQsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIG1hcENhY2hlRGVsZXRlKGtleSkgewogIHZhciByZXN1bHQgPSBnZXRNYXBEYXRhKHRoaXMsIGtleSlbJ2RlbGV0ZSddKGtleSk7CiAgdGhpcy5zaXplIC09IHJlc3VsdCA/IDEgOiAwOwogIHJldHVybiByZXN1bHQ7Cn0KCi8qKgogKiBHZXRzIHRoZSBtYXAgdmFsdWUgZm9yIGBrZXlgLgogKgogKiBAcHJpdmF0ZQogKiBAbmFtZSBnZXQKICogQG1lbWJlck9mIE1hcENhY2hlCiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgdmFsdWUgdG8gZ2V0LgogKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZW50cnkgdmFsdWUuCiAqLwpmdW5jdGlvbiBtYXBDYWNoZUdldChrZXkpIHsKICByZXR1cm4gZ2V0TWFwRGF0YSh0aGlzLCBrZXkpLmdldChrZXkpOwp9CgovKioKICogQ2hlY2tzIGlmIGEgbWFwIHZhbHVlIGZvciBga2V5YCBleGlzdHMuCiAqCiAqIEBwcml2YXRlCiAqIEBuYW1lIGhhcwogKiBAbWVtYmVyT2YgTWFwQ2FjaGUKICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBlbnRyeSB0byBjaGVjay4KICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFuIGVudHJ5IGZvciBga2V5YCBleGlzdHMsIGVsc2UgYGZhbHNlYC4KICovCmZ1bmN0aW9uIG1hcENhY2hlSGFzKGtleSkgewogIHJldHVybiBnZXRNYXBEYXRhKHRoaXMsIGtleSkuaGFzKGtleSk7Cn0KCi8qKgogKiBTZXRzIHRoZSBtYXAgYGtleWAgdG8gYHZhbHVlYC4KICoKICogQHByaXZhdGUKICogQG5hbWUgc2V0CiAqIEBtZW1iZXJPZiBNYXBDYWNoZQogKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgb2YgdGhlIHZhbHVlIHRvIHNldC4KICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LgogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBtYXAgY2FjaGUgaW5zdGFuY2UuCiAqLwpmdW5jdGlvbiBtYXBDYWNoZVNldChrZXksIHZhbHVlKSB7CiAgdmFyIGRhdGEgPSBnZXRNYXBEYXRhKHRoaXMsIGtleSksCiAgICBzaXplID0gZGF0YS5zaXplOwogIGRhdGEuc2V0KGtleSwgdmFsdWUpOwogIHRoaXMuc2l6ZSArPSBkYXRhLnNpemUgPT0gc2l6ZSA/IDAgOiAxOwogIHJldHVybiB0aGlzOwp9CgovKioKICogQ3JlYXRlcyBhIG1hcCBjYWNoZSBvYmplY3QgdG8gc3RvcmUga2V5LXZhbHVlIHBhaXJzLgogKgogKiBAcHJpdmF0ZQogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtBcnJheX0gW2VudHJpZXNdIFRoZSBrZXktdmFsdWUgcGFpcnMgdG8gY2FjaGUuCiAqLwpmdW5jdGlvbiBNYXBDYWNoZShlbnRyaWVzKSB7CiAgdmFyIGluZGV4ID0gLTEsCiAgICBsZW5ndGggPSBlbnRyaWVzID09IG51bGwgPyAwIDogZW50cmllcy5sZW5ndGg7CiAgdGhpcy5jbGVhcigpOwogIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICB2YXIgZW50cnkgPSBlbnRyaWVzW2luZGV4XTsKICAgIHRoaXMuc2V0KGVudHJ5WzBdLCBlbnRyeVsxXSk7CiAgfQp9CgovLyBBZGQgbWV0aG9kcyB0byBgTWFwQ2FjaGVgLgpNYXBDYWNoZS5wcm90b3R5cGUuY2xlYXIgPSBtYXBDYWNoZUNsZWFyOwpNYXBDYWNoZS5wcm90b3R5cGVbJ2RlbGV0ZSddID0gbWFwQ2FjaGVEZWxldGU7Ck1hcENhY2hlLnByb3RvdHlwZS5nZXQgPSBtYXBDYWNoZUdldDsKTWFwQ2FjaGUucHJvdG90eXBlLmhhcyA9IG1hcENhY2hlSGFzOwpNYXBDYWNoZS5wcm90b3R5cGUuc2V0ID0gbWFwQ2FjaGVTZXQ7CgovKiogRXJyb3IgbWVzc2FnZSBjb25zdGFudHMuICovCnZhciBGVU5DX0VSUk9SX1RFWFQgPSAnRXhwZWN0ZWQgYSBmdW5jdGlvbic7CgovKioKICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgbWVtb2l6ZXMgdGhlIHJlc3VsdCBvZiBgZnVuY2AuIElmIGByZXNvbHZlcmAgaXMKICogcHJvdmlkZWQsIGl0IGRldGVybWluZXMgdGhlIGNhY2hlIGtleSBmb3Igc3RvcmluZyB0aGUgcmVzdWx0IGJhc2VkIG9uIHRoZQogKiBhcmd1bWVudHMgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUgZmlyc3QgYXJndW1lbnQKICogcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIG1hcCBjYWNoZSBrZXkuIFRoZSBgZnVuY2AKICogaXMgaW52b2tlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uCiAqCiAqICoqTm90ZToqKiBUaGUgY2FjaGUgaXMgZXhwb3NlZCBhcyB0aGUgYGNhY2hlYCBwcm9wZXJ0eSBvbiB0aGUgbWVtb2l6ZWQKICogZnVuY3Rpb24uIEl0cyBjcmVhdGlvbiBtYXkgYmUgY3VzdG9taXplZCBieSByZXBsYWNpbmcgdGhlIGBfLm1lbW9pemUuQ2FjaGVgCiAqIGNvbnN0cnVjdG9yIHdpdGggb25lIHdob3NlIGluc3RhbmNlcyBpbXBsZW1lbnQgdGhlCiAqIFtgTWFwYF0oaHR0cDovL2VjbWEtaW50ZXJuYXRpb25hbC5vcmcvZWNtYS0yNjIvNy4wLyNzZWMtcHJvcGVydGllcy1vZi10aGUtbWFwLXByb3RvdHlwZS1vYmplY3QpCiAqIG1ldGhvZCBpbnRlcmZhY2Ugb2YgYGNsZWFyYCwgYGRlbGV0ZWAsIGBnZXRgLCBgaGFzYCwgYW5kIGBzZXRgLgogKgogKiBAc3RhdGljCiAqIEBtZW1iZXJPZiBfCiAqIEBzaW5jZSAwLjEuMAogKiBAY2F0ZWdvcnkgRnVuY3Rpb24KICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBbcmVzb2x2ZXJdIFRoZSBmdW5jdGlvbiB0byByZXNvbHZlIHRoZSBjYWNoZSBrZXkuCiAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemVkIGZ1bmN0aW9uLgogKiBAZXhhbXBsZQogKgogKiB2YXIgb2JqZWN0ID0geyAnYSc6IDEsICdiJzogMiB9OwogKiB2YXIgb3RoZXIgPSB7ICdjJzogMywgJ2QnOiA0IH07CiAqCiAqIHZhciB2YWx1ZXMgPSBfLm1lbW9pemUoXy52YWx1ZXMpOwogKiB2YWx1ZXMob2JqZWN0KTsKICogLy8gPT4gWzEsIDJdCiAqCiAqIHZhbHVlcyhvdGhlcik7CiAqIC8vID0+IFszLCA0XQogKgogKiBvYmplY3QuYSA9IDI7CiAqIHZhbHVlcyhvYmplY3QpOwogKiAvLyA9PiBbMSwgMl0KICoKICogLy8gTW9kaWZ5IHRoZSByZXN1bHQgY2FjaGUuCiAqIHZhbHVlcy5jYWNoZS5zZXQob2JqZWN0LCBbJ2EnLCAnYiddKTsKICogdmFsdWVzKG9iamVjdCk7CiAqIC8vID0+IFsnYScsICdiJ10KICoKICogLy8gUmVwbGFjZSBgXy5tZW1vaXplLkNhY2hlYC4KICogXy5tZW1vaXplLkNhY2hlID0gV2Vha01hcDsKICovCmZ1bmN0aW9uIG1lbW9pemUoZnVuYywgcmVzb2x2ZXIpIHsKICBpZiAodHlwZW9mIGZ1bmMgIT0gJ2Z1bmN0aW9uJyB8fCByZXNvbHZlciAhPSBudWxsICYmIHR5cGVvZiByZXNvbHZlciAhPSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKEZVTkNfRVJST1JfVEVYVCk7CiAgfQogIHZhciBtZW1vaXplZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICBrZXkgPSByZXNvbHZlciA/IHJlc29sdmVyLmFwcGx5KHRoaXMsIGFyZ3MpIDogYXJnc1swXSwKICAgICAgY2FjaGUgPSBtZW1vaXplZC5jYWNoZTsKICAgIGlmIChjYWNoZS5oYXMoa2V5KSkgewogICAgICByZXR1cm4gY2FjaGUuZ2V0KGtleSk7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzLCBhcmdzKTsKICAgIG1lbW9pemVkLmNhY2hlID0gY2FjaGUuc2V0KGtleSwgcmVzdWx0KSB8fCBjYWNoZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICBtZW1vaXplZC5jYWNoZSA9IG5ldyAobWVtb2l6ZS5DYWNoZSB8fCBNYXBDYWNoZSkoKTsKICByZXR1cm4gbWVtb2l6ZWQ7Cn0KCi8vIEV4cG9zZSBgTWFwQ2FjaGVgLgptZW1vaXplLkNhY2hlID0gTWFwQ2FjaGU7CgovKiogVXNlZCBhcyB0aGUgbWF4aW11bSBtZW1vaXplIGNhY2hlIHNpemUuICovCnZhciBNQVhfTUVNT0laRV9TSVpFID0gNTAwOwoKLyoqCiAqIEEgc3BlY2lhbGl6ZWQgdmVyc2lvbiBvZiBgXy5tZW1vaXplYCB3aGljaCBjbGVhcnMgdGhlIG1lbW9pemVkIGZ1bmN0aW9uJ3MKICogY2FjaGUgd2hlbiBpdCBleGNlZWRzIGBNQVhfTUVNT0laRV9TSVpFYC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBtZW1vaXplZCBmdW5jdGlvbi4KICovCmZ1bmN0aW9uIG1lbW9pemVDYXBwZWQoZnVuYykgewogIHZhciByZXN1bHQgPSBtZW1vaXplKGZ1bmMsIGZ1bmN0aW9uIChrZXkpIHsKICAgIGlmIChjYWNoZS5zaXplID09PSBNQVhfTUVNT0laRV9TSVpFKSB7CiAgICAgIGNhY2hlLmNsZWFyKCk7CiAgICB9CiAgICByZXR1cm4ga2V5OwogIH0pOwogIHZhciBjYWNoZSA9IHJlc3VsdC5jYWNoZTsKICByZXR1cm4gcmVzdWx0Owp9CgovKiogVXNlZCB0byBtYXRjaCBwcm9wZXJ0eSBuYW1lcyB3aXRoaW4gcHJvcGVydHkgcGF0aHMuICovCnZhciByZVByb3BOYW1lID0gL1teLltcXV0rfFxbKD86KC0/XGQrKD86XC5cZCspPyl8KFsiJ10pKCg/Oig/IVwyKVteXFxdfFxcLikqPylcMilcXXwoPz0oPzpcLnxcW1xdKSg/OlwufFxbXF18JCkpL2c7CgovKiogVXNlZCB0byBtYXRjaCBiYWNrc2xhc2hlcyBpbiBwcm9wZXJ0eSBwYXRocy4gKi8KdmFyIHJlRXNjYXBlQ2hhciA9IC9cXChcXCk/L2c7CgovKioKICogQ29udmVydHMgYHN0cmluZ2AgdG8gYSBwcm9wZXJ0eSBwYXRoIGFycmF5LgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gY29udmVydC4KICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIHRoZSBwcm9wZXJ0eSBwYXRoIGFycmF5LgogKi8KdmFyIHN0cmluZ1RvUGF0aCA9IG1lbW9pemVDYXBwZWQoZnVuY3Rpb24gKHN0cmluZykgewogIHZhciByZXN1bHQgPSBbXTsKICBpZiAoc3RyaW5nLmNoYXJDb2RlQXQoMCkgPT09IDQ2IC8qIC4gKi8pIHsKICAgIHJlc3VsdC5wdXNoKCcnKTsKICB9CiAgc3RyaW5nLnJlcGxhY2UocmVQcm9wTmFtZSwgZnVuY3Rpb24gKG1hdGNoLCBudW1iZXIsIHF1b3RlLCBzdWJTdHJpbmcpIHsKICAgIHJlc3VsdC5wdXNoKHF1b3RlID8gc3ViU3RyaW5nLnJlcGxhY2UocmVFc2NhcGVDaGFyLCAnJDEnKSA6IG51bWJlciB8fCBtYXRjaCk7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfSk7CnZhciBzdHJpbmdUb1BhdGgkMSA9IHN0cmluZ1RvUGF0aDsKCi8qKgogKiBBIHNwZWNpYWxpemVkIHZlcnNpb24gb2YgYF8ubWFwYCBmb3IgYXJyYXlzIHdpdGhvdXQgc3VwcG9ydCBmb3IgaXRlcmF0ZWUKICogc2hvcnRoYW5kcy4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZSBUaGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBtYXBwZWQgYXJyYXkuCiAqLwpmdW5jdGlvbiBhcnJheU1hcChhcnJheSwgaXRlcmF0ZWUpIHsKICB2YXIgaW5kZXggPSAtMSwKICAgIGxlbmd0aCA9IGFycmF5ID09IG51bGwgPyAwIDogYXJyYXkubGVuZ3RoLAogICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgcmVzdWx0W2luZGV4XSA9IGl0ZXJhdGVlKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoqIFVzZWQgYXMgcmVmZXJlbmNlcyBmb3IgdmFyaW91cyBgTnVtYmVyYCBjb25zdGFudHMuICovCnZhciBJTkZJTklUWSQyID0gMSAvIDA7CgovKiogVXNlZCB0byBjb252ZXJ0IHN5bWJvbHMgdG8gcHJpbWl0aXZlcyBhbmQgc3RyaW5ncy4gKi8KdmFyIHN5bWJvbFByb3RvID0gU3ltYm9sJDIgPyBTeW1ib2wkMi5wcm90b3R5cGUgOiB1bmRlZmluZWQsCiAgc3ltYm9sVG9TdHJpbmcgPSBzeW1ib2xQcm90byA/IHN5bWJvbFByb3RvLnRvU3RyaW5nIDogdW5kZWZpbmVkOwoKLyoqCiAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnRvU3RyaW5nYCB3aGljaCBkb2Vzbid0IGNvbnZlcnQgbnVsbGlzaAogKiB2YWx1ZXMgdG8gZW1wdHkgc3RyaW5ncy4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvY2Vzcy4KICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nLgogKi8KZnVuY3Rpb24gYmFzZVRvU3RyaW5nKHZhbHVlKSB7CiAgLy8gRXhpdCBlYXJseSBmb3Igc3RyaW5ncyB0byBhdm9pZCBhIHBlcmZvcm1hbmNlIGhpdCBpbiBzb21lIGVudmlyb25tZW50cy4KICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmIChpc0FycmF5JDEodmFsdWUpKSB7CiAgICAvLyBSZWN1cnNpdmVseSBjb252ZXJ0IHZhbHVlcyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpLgogICAgcmV0dXJuIGFycmF5TWFwKHZhbHVlLCBiYXNlVG9TdHJpbmcpICsgJyc7CiAgfQogIGlmIChpc1N5bWJvbCh2YWx1ZSkpIHsKICAgIHJldHVybiBzeW1ib2xUb1N0cmluZyA/IHN5bWJvbFRvU3RyaW5nLmNhbGwodmFsdWUpIDogJyc7CiAgfQogIHZhciByZXN1bHQgPSB2YWx1ZSArICcnOwogIHJldHVybiByZXN1bHQgPT0gJzAnICYmIDEgLyB2YWx1ZSA9PSAtSU5GSU5JVFkkMiA/ICctMCcgOiByZXN1bHQ7Cn0KCi8qKgogKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGEgc3RyaW5nLiBBbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQgZm9yIGBudWxsYAogKiBhbmQgYHVuZGVmaW5lZGAgdmFsdWVzLiBUaGUgc2lnbiBvZiBgLTBgIGlzIHByZXNlcnZlZC4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgNC4wLjAKICogQGNhdGVnb3J5IExhbmcKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY29udmVydC4KICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgY29udmVydGVkIHN0cmluZy4KICogQGV4YW1wbGUKICoKICogXy50b1N0cmluZyhudWxsKTsKICogLy8gPT4gJycKICoKICogXy50b1N0cmluZygtMCk7CiAqIC8vID0+ICctMCcKICoKICogXy50b1N0cmluZyhbMSwgMiwgM10pOwogKiAvLyA9PiAnMSwyLDMnCiAqLwpmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSA9PSBudWxsID8gJycgOiBiYXNlVG9TdHJpbmcodmFsdWUpOwp9CgovKioKICogQ2FzdHMgYHZhbHVlYCB0byBhIHBhdGggYXJyYXkgaWYgaXQncyBub3Qgb25lLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byBxdWVyeSBrZXlzIG9uLgogKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIGNhc3QgcHJvcGVydHkgcGF0aCBhcnJheS4KICovCmZ1bmN0aW9uIGNhc3RQYXRoKHZhbHVlLCBvYmplY3QpIHsKICBpZiAoaXNBcnJheSQxKHZhbHVlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICByZXR1cm4gaXNLZXkodmFsdWUsIG9iamVjdCkgPyBbdmFsdWVdIDogc3RyaW5nVG9QYXRoJDEodG9TdHJpbmcodmFsdWUpKTsKfQoKLyoqIFVzZWQgYXMgcmVmZXJlbmNlcyBmb3IgdmFyaW91cyBgTnVtYmVyYCBjb25zdGFudHMuICovCnZhciBJTkZJTklUWSQxID0gMSAvIDA7CgovKioKICogQ29udmVydHMgYHZhbHVlYCB0byBhIHN0cmluZyBrZXkgaWYgaXQncyBub3QgYSBzdHJpbmcgb3Igc3ltYm9sLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogKiBAcmV0dXJucyB7c3RyaW5nfHN5bWJvbH0gUmV0dXJucyB0aGUga2V5LgogKi8KZnVuY3Rpb24gdG9LZXkodmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnIHx8IGlzU3ltYm9sKHZhbHVlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICB2YXIgcmVzdWx0ID0gdmFsdWUgKyAnJzsKICByZXR1cm4gcmVzdWx0ID09ICcwJyAmJiAxIC8gdmFsdWUgPT0gLUlORklOSVRZJDEgPyAnLTAnIDogcmVzdWx0Owp9CgovKioKICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZ2V0YCB3aXRob3V0IHN1cHBvcnQgZm9yIGRlZmF1bHQgdmFsdWVzLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gcXVlcnkuCiAqIEBwYXJhbSB7QXJyYXl8c3RyaW5nfSBwYXRoIFRoZSBwYXRoIG9mIHRoZSBwcm9wZXJ0eSB0byBnZXQuCiAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSByZXNvbHZlZCB2YWx1ZS4KICovCmZ1bmN0aW9uIGJhc2VHZXQob2JqZWN0LCBwYXRoKSB7CiAgcGF0aCA9IGNhc3RQYXRoKHBhdGgsIG9iamVjdCk7CiAgdmFyIGluZGV4ID0gMCwKICAgIGxlbmd0aCA9IHBhdGgubGVuZ3RoOwogIHdoaWxlIChvYmplY3QgIT0gbnVsbCAmJiBpbmRleCA8IGxlbmd0aCkgewogICAgb2JqZWN0ID0gb2JqZWN0W3RvS2V5KHBhdGhbaW5kZXgrK10pXTsKICB9CiAgcmV0dXJuIGluZGV4ICYmIGluZGV4ID09IGxlbmd0aCA/IG9iamVjdCA6IHVuZGVmaW5lZDsKfQoKLyoqCiAqIEdldHMgdGhlIHZhbHVlIGF0IGBwYXRoYCBvZiBgb2JqZWN0YC4gSWYgdGhlIHJlc29sdmVkIHZhbHVlIGlzCiAqIGB1bmRlZmluZWRgLCB0aGUgYGRlZmF1bHRWYWx1ZWAgaXMgcmV0dXJuZWQgaW4gaXRzIHBsYWNlLgogKgogKiBAc3RhdGljCiAqIEBtZW1iZXJPZiBfCiAqIEBzaW5jZSAzLjcuMAogKiBAY2F0ZWdvcnkgT2JqZWN0CiAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBxdWVyeS4KICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IHBhdGggVGhlIHBhdGggb2YgdGhlIHByb3BlcnR5IHRvIGdldC4KICogQHBhcmFtIHsqfSBbZGVmYXVsdFZhbHVlXSBUaGUgdmFsdWUgcmV0dXJuZWQgZm9yIGB1bmRlZmluZWRgIHJlc29sdmVkIHZhbHVlcy4KICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogKiBAZXhhbXBsZQogKgogKiB2YXIgb2JqZWN0ID0geyAnYSc6IFt7ICdiJzogeyAnYyc6IDMgfSB9XSB9OwogKgogKiBfLmdldChvYmplY3QsICdhWzBdLmIuYycpOwogKiAvLyA9PiAzCiAqCiAqIF8uZ2V0KG9iamVjdCwgWydhJywgJzAnLCAnYicsICdjJ10pOwogKiAvLyA9PiAzCiAqCiAqIF8uZ2V0KG9iamVjdCwgJ2EuYi5jJywgJ2RlZmF1bHQnKTsKICogLy8gPT4gJ2RlZmF1bHQnCiAqLwpmdW5jdGlvbiBnZXQob2JqZWN0LCBwYXRoLCBkZWZhdWx0VmFsdWUpIHsKICB2YXIgcmVzdWx0ID0gb2JqZWN0ID09IG51bGwgPyB1bmRlZmluZWQgOiBiYXNlR2V0KG9iamVjdCwgcGF0aCk7CiAgcmV0dXJuIHJlc3VsdCA9PT0gdW5kZWZpbmVkID8gZGVmYXVsdFZhbHVlIDogcmVzdWx0Owp9CgovKioNCiAqIOWIpOaWt+aYr+WQpueCuuWtl+S4sg0KICoNCiAqIFVuaXQgVGVzdDoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS95dWRhLWx5dS93c2VtaS9ibG9iL21hc3Rlci90ZXN0L2lzc3RyLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc3N0cigwKSkNCiAqIC8vID0+IGZhbHNlDQogKg0KICogY29uc29sZS5sb2coaXNzdHIoJzAnKSkNCiAqIC8vID0+IHRydWUNCiAqDQogKiBjb25zb2xlLmxvZyhpc3N0cignJykpDQogKiAvLyA9PiB0cnVlDQogKg0KICovCmZ1bmN0aW9uIGlzc3RyKHYpIHsKICBsZXQgYyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2KTsKICByZXR1cm4gYyA9PT0gJ1tvYmplY3QgU3RyaW5nXSc7Cn0KCi8qKg0KICog5Yik5pa35piv5ZCm54K65pyJ5pWI5a2X5LiyDQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvaXNlc3RyLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc2VzdHIoJzEuMjUnKSkNCiAqIC8vID0+IHRydWUNCiAqDQogKiBjb25zb2xlLmxvZyhpc2VzdHIoMTI1KSkNCiAqIC8vID0+IGZhbHNlDQogKg0KICogY29uc29sZS5sb2coaXNlc3RyKCcnKSkNCiAqIC8vID0+IGZhbHNlDQogKg0KICovCmZ1bmN0aW9uIGlzZXN0cih2KSB7CiAgLy9jaGVjawogIGlmIChpc3N0cih2KSkgewogICAgaWYgKHYgIT09ICcnKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8qKiBVc2VkIHRvIG1hdGNoIGEgc2luZ2xlIHdoaXRlc3BhY2UgY2hhcmFjdGVyLiAqLwp2YXIgcmVXaGl0ZXNwYWNlID0gL1xzLzsKCi8qKgogKiBVc2VkIGJ5IGBfLnRyaW1gIGFuZCBgXy50cmltRW5kYCB0byBnZXQgdGhlIGluZGV4IG9mIHRoZSBsYXN0IG5vbi13aGl0ZXNwYWNlCiAqIGNoYXJhY3RlciBvZiBgc3RyaW5nYC4KICoKICogQHByaXZhdGUKICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGluc3BlY3QuCiAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBsYXN0IG5vbi13aGl0ZXNwYWNlIGNoYXJhY3Rlci4KICovCmZ1bmN0aW9uIHRyaW1tZWRFbmRJbmRleChzdHJpbmcpIHsKICB2YXIgaW5kZXggPSBzdHJpbmcubGVuZ3RoOwogIHdoaWxlIChpbmRleC0tICYmIHJlV2hpdGVzcGFjZS50ZXN0KHN0cmluZy5jaGFyQXQoaW5kZXgpKSkge30KICByZXR1cm4gaW5kZXg7Cn0KCi8qKiBVc2VkIHRvIG1hdGNoIGxlYWRpbmcgd2hpdGVzcGFjZS4gKi8KdmFyIHJlVHJpbVN0YXJ0ID0gL15ccysvOwoKLyoqCiAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnRyaW1gLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gdHJpbS4KICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdHJpbW1lZCBzdHJpbmcuCiAqLwpmdW5jdGlvbiBiYXNlVHJpbShzdHJpbmcpIHsKICByZXR1cm4gc3RyaW5nID8gc3RyaW5nLnNsaWNlKDAsIHRyaW1tZWRFbmRJbmRleChzdHJpbmcpICsgMSkucmVwbGFjZShyZVRyaW1TdGFydCwgJycpIDogc3RyaW5nOwp9CgovKiogVXNlZCBhcyByZWZlcmVuY2VzIGZvciB2YXJpb3VzIGBOdW1iZXJgIGNvbnN0YW50cy4gKi8KdmFyIE5BTiA9IDAgLyAwOwoKLyoqIFVzZWQgdG8gZGV0ZWN0IGJhZCBzaWduZWQgaGV4YWRlY2ltYWwgc3RyaW5nIHZhbHVlcy4gKi8KdmFyIHJlSXNCYWRIZXggPSAvXlstK10weFswLTlhLWZdKyQvaTsKCi8qKiBVc2VkIHRvIGRldGVjdCBiaW5hcnkgc3RyaW5nIHZhbHVlcy4gKi8KdmFyIHJlSXNCaW5hcnkgPSAvXjBiWzAxXSskL2k7CgovKiogVXNlZCB0byBkZXRlY3Qgb2N0YWwgc3RyaW5nIHZhbHVlcy4gKi8KdmFyIHJlSXNPY3RhbCA9IC9eMG9bMC03XSskL2k7CgovKiogQnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMgd2l0aG91dCBhIGRlcGVuZGVuY3kgb24gYHJvb3RgLiAqLwp2YXIgZnJlZVBhcnNlSW50ID0gcGFyc2VJbnQ7CgovKioKICogQ29udmVydHMgYHZhbHVlYCB0byBhIG51bWJlci4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgNC4wLjAKICogQGNhdGVnb3J5IExhbmcKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvY2Vzcy4KICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbnVtYmVyLgogKiBAZXhhbXBsZQogKgogKiBfLnRvTnVtYmVyKDMuMik7CiAqIC8vID0+IDMuMgogKgogKiBfLnRvTnVtYmVyKE51bWJlci5NSU5fVkFMVUUpOwogKiAvLyA9PiA1ZS0zMjQKICoKICogXy50b051bWJlcihJbmZpbml0eSk7CiAqIC8vID0+IEluZmluaXR5CiAqCiAqIF8udG9OdW1iZXIoJzMuMicpOwogKiAvLyA9PiAzLjIKICovCmZ1bmN0aW9uIHRvTnVtYmVyKHZhbHVlKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJykgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoaXNTeW1ib2wodmFsdWUpKSB7CiAgICByZXR1cm4gTkFOOwogIH0KICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICB2YXIgb3RoZXIgPSB0eXBlb2YgdmFsdWUudmFsdWVPZiA9PSAnZnVuY3Rpb24nID8gdmFsdWUudmFsdWVPZigpIDogdmFsdWU7CiAgICB2YWx1ZSA9IGlzT2JqZWN0KG90aGVyKSA/IG90aGVyICsgJycgOiBvdGhlcjsKICB9CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgewogICAgcmV0dXJuIHZhbHVlID09PSAwID8gdmFsdWUgOiArdmFsdWU7CiAgfQogIHZhbHVlID0gYmFzZVRyaW0odmFsdWUpOwogIHZhciBpc0JpbmFyeSA9IHJlSXNCaW5hcnkudGVzdCh2YWx1ZSk7CiAgcmV0dXJuIGlzQmluYXJ5IHx8IHJlSXNPY3RhbC50ZXN0KHZhbHVlKSA/IGZyZWVQYXJzZUludCh2YWx1ZS5zbGljZSgyKSwgaXNCaW5hcnkgPyAyIDogOCkgOiByZUlzQmFkSGV4LnRlc3QodmFsdWUpID8gTkFOIDogK3ZhbHVlOwp9CgovKiogVXNlZCBhcyByZWZlcmVuY2VzIGZvciB2YXJpb3VzIGBOdW1iZXJgIGNvbnN0YW50cy4gKi8KdmFyIElORklOSVRZID0gMSAvIDAsCiAgTUFYX0lOVEVHRVIgPSAxLjc5NzY5MzEzNDg2MjMxNTdlKzMwODsKCi8qKgogKiBDb252ZXJ0cyBgdmFsdWVgIHRvIGEgZmluaXRlIG51bWJlci4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgNC4xMi4wCiAqIEBjYXRlZ29yeSBMYW5nCiAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNvbnZlcnQuCiAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGNvbnZlcnRlZCBudW1iZXIuCiAqIEBleGFtcGxlCiAqCiAqIF8udG9GaW5pdGUoMy4yKTsKICogLy8gPT4gMy4yCiAqCiAqIF8udG9GaW5pdGUoTnVtYmVyLk1JTl9WQUxVRSk7CiAqIC8vID0+IDVlLTMyNAogKgogKiBfLnRvRmluaXRlKEluZmluaXR5KTsKICogLy8gPT4gMS43OTc2OTMxMzQ4NjIzMTU3ZSszMDgKICoKICogXy50b0Zpbml0ZSgnMy4yJyk7CiAqIC8vID0+IDMuMgogKi8KZnVuY3Rpb24gdG9GaW5pdGUodmFsdWUpIHsKICBpZiAoIXZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT09IDAgPyB2YWx1ZSA6IDA7CiAgfQogIHZhbHVlID0gdG9OdW1iZXIodmFsdWUpOwogIGlmICh2YWx1ZSA9PT0gSU5GSU5JVFkgfHwgdmFsdWUgPT09IC1JTkZJTklUWSkgewogICAgdmFyIHNpZ24gPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICByZXR1cm4gc2lnbiAqIE1BWF9JTlRFR0VSOwogIH0KICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwp9CgovKioKICogQ29udmVydHMgYHZhbHVlYCB0byBhbiBpbnRlZ2VyLgogKgogKiAqKk5vdGU6KiogVGhpcyBtZXRob2QgaXMgbG9vc2VseSBiYXNlZCBvbgogKiBbYFRvSW50ZWdlcmBdKGh0dHA6Ly93d3cuZWNtYS1pbnRlcm5hdGlvbmFsLm9yZy9lY21hLTI2Mi83LjAvI3NlYy10b2ludGVnZXIpLgogKgogKiBAc3RhdGljCiAqIEBtZW1iZXJPZiBfCiAqIEBzaW5jZSA0LjAuMAogKiBAY2F0ZWdvcnkgTGFuZwogKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjb252ZXJ0LgogKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjb252ZXJ0ZWQgaW50ZWdlci4KICogQGV4YW1wbGUKICoKICogXy50b0ludGVnZXIoMy4yKTsKICogLy8gPT4gMwogKgogKiBfLnRvSW50ZWdlcihOdW1iZXIuTUlOX1ZBTFVFKTsKICogLy8gPT4gMAogKgogKiBfLnRvSW50ZWdlcihJbmZpbml0eSk7CiAqIC8vID0+IDEuNzk3NjkzMTM0ODYyMzE1N2UrMzA4CiAqCiAqIF8udG9JbnRlZ2VyKCczLjInKTsKICogLy8gPT4gMwogKi8KZnVuY3Rpb24gdG9JbnRlZ2VyKHZhbHVlKSB7CiAgdmFyIHJlc3VsdCA9IHRvRmluaXRlKHZhbHVlKSwKICAgIHJlbWFpbmRlciA9IHJlc3VsdCAlIDE7CiAgcmV0dXJuIHJlc3VsdCA9PT0gcmVzdWx0ID8gcmVtYWluZGVyID8gcmVzdWx0IC0gcmVtYWluZGVyIDogcmVzdWx0IDogMDsKfQoKLyoqCiAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGludGVnZXIuCiAqCiAqICoqTm90ZToqKiBUaGlzIG1ldGhvZCBpcyBiYXNlZCBvbgogKiBbYE51bWJlci5pc0ludGVnZXJgXShodHRwczovL21kbi5pby9OdW1iZXIvaXNJbnRlZ2VyKS4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgNC4wLjAKICogQGNhdGVnb3J5IExhbmcKICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGFuIGludGVnZXIsIGVsc2UgYGZhbHNlYC4KICogQGV4YW1wbGUKICoKICogXy5pc0ludGVnZXIoMyk7CiAqIC8vID0+IHRydWUKICoKICogXy5pc0ludGVnZXIoTnVtYmVyLk1JTl9WQUxVRSk7CiAqIC8vID0+IGZhbHNlCiAqCiAqIF8uaXNJbnRlZ2VyKEluZmluaXR5KTsKICogLy8gPT4gZmFsc2UKICoKICogXy5pc0ludGVnZXIoJzMnKTsKICogLy8gPT4gZmFsc2UKICovCmZ1bmN0aW9uIGlzSW50ZWdlcih2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ251bWJlcicgJiYgdmFsdWUgPT0gdG9JbnRlZ2VyKHZhbHVlKTsKfQoKLyoqDQogKiDliKTmlrfmmK/lkKbngrrmlbjlrZcNCiAqDQogKiBVbml0IFRlc3Q6IHtAbGluayBodHRwczovL2dpdGh1Yi5jb20veXVkYS1seXUvd3NlbWkvYmxvYi9tYXN0ZXIvdGVzdC9pc25ici50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBwYXJhbSB7Kn0gdiDovLjlhaXku7vmhI/os4fmlpkNCiAqIEByZXR1cm5zIHtCb29sZWFufSDlm57lgrPliKTmlrfluIPmnpflgLwNCiAqIEBleGFtcGxlDQogKg0KICogY29uc29sZS5sb2coaXNuYnIoMS4yNSkpDQogKiAvLyA9PiB0cnVlDQogKg0KICogY29uc29sZS5sb2coaXNuYnIoJzEuMjUnKSkNCiAqIC8vID0+IGZhbHNlDQogKg0KICovCmZ1bmN0aW9uIGlzbmJyKHYpIHsKICBsZXQgYyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2KTsKICByZXR1cm4gYyA9PT0gJ1tvYmplY3QgTnVtYmVyXSc7Cn0KCi8vIGltcG9ydCBpc05hTiBmcm9tICdsb2Rhc2gtZXMvaXNOYU4uanMnCgovKioNCiAqIOWIpOaWt+aYr+WQpueCuk5hTg0KICoNCiAqIFVuaXQgVGVzdDoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS95dWRhLWx5dS93c2VtaS9ibG9iL21hc3Rlci90ZXN0L2lzbmFuLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc25hbihOYU4pKQ0KICogLy8gPT4gdHJ1ZQ0KICoNCiAqLwpmdW5jdGlvbiBpc25hbih2KSB7CiAgLy8gcmV0dXJuIGlzTmFOKHYpCiAgcmV0dXJuIHYgIT09IHY7Cn0KCi8qKg0KICog5Yik5pa35piv5ZCm54K65pW45a2XDQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvaXNudW0udGVzdC5tanMgR2l0aHVifQ0KICogQG1lbWJlck9mIHdzZW1pDQogKiBAcGFyYW0geyp9IHYg6Ly45YWl5Lu75oSP6LOH5paZDQogKiBAcmV0dXJucyB7Qm9vbGVhbn0g5Zue5YKz5Yik5pa35biD5p6X5YC8DQogKiBAZXhhbXBsZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzbnVtKDApKQ0KICogLy8gPT4gdHJ1ZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzbnVtKDEuMjUpKQ0KICogLy8gPT4gdHJ1ZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzbnVtKCctMTI1JykpDQogKiAvLyA9PiB0cnVlDQogKg0KICovCmZ1bmN0aW9uIGlzbnVtKHYpIHsKICBsZXQgYiA9IGZhbHNlOwogIGlmIChpc2VzdHIodikpIHsKICAgIGIgPSAhaXNOYU4oTnVtYmVyKHYpKTsKICB9IGVsc2UgaWYgKGlzbmJyKHYpKSB7CiAgICAvL+azqOaEj05hTueCuk51bWJlciwg5pWFaXNuYnLlm57lgrN0cnVlCiAgICBpZiAoaXNuYW4odikpIHsKICAgICAgcmV0dXJuIGZhbHNlOyAvL+atpOiZleWIpOWumueCuuacieaViOaVuOWtlywg5pWFTmFO6aCI5YmU6ZmkCiAgICB9IGVsc2UgewogICAgICBiID0gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGI7Cn0KCi8qKg0KICog5pW45a2X5oiW5a2X5Liy6L2J5rWu6bue5pW4DQogKiDoi6XovLjlhaXpnZ7mlbjlrZfliYflm57lgrMwDQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvY2RibC50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBwYXJhbSB7TnVtYmVyfFN0cmluZ30gdiDovLjlhaXmlbjlrZfmiJblrZfkuLINCiAqIEByZXR1cm5zIHtOdW1iZXJ9IOWbnuWCs+aVuOWtlw0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhjZGJsKCcyNScpKQ0KICogLy8gPT4gMjUNCiAqDQogKi8KZnVuY3Rpb24gY2RibCh2KSB7CiAgLy9jaGVjawogIGlmICghaXNudW0odikpIHsKICAgIHJldHVybiAwOwogIH0KICBsZXQgciA9IHRvRmluaXRlKHYpOwogIHJldHVybiByOwp9CgovKioNCiAqIOWIpOaWt+aYr+WQpueCuuaVtOaVuA0KICoNCiAqIFVuaXQgVGVzdDoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS95dWRhLWx5dS93c2VtaS9ibG9iL21hc3Rlci90ZXN0L2lzaW50LnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc2ludCgnMS4yNScpKQ0KICogLy8gPT4gZmFsc2UNCiAqDQogKiBjb25zb2xlLmxvZyhpc2ludCgnMTI1JykpDQogKiAvLyA9PiB0cnVlDQogKg0KICogY29uc29sZS5sb2coaXNpbnQoMS4yNSkpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzaW50KDEyNSkpDQogKiAvLyA9PiB0cnVlDQogKg0KICovCmZ1bmN0aW9uIGlzaW50KHYpIHsKICBpZiAoaXNudW0odikpIHsKICAgIHYgPSBjZGJsKHYpOwogICAgcmV0dXJuIGlzSW50ZWdlcih2KTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKLyogQnVpbHQtaW4gbWV0aG9kIHJlZmVyZW5jZXMgZm9yIHRob3NlIHdpdGggdGhlIHNhbWUgbmFtZSBhcyBvdGhlciBgbG9kYXNoYCBtZXRob2RzLiAqLwp2YXIgbmF0aXZlSXNGaW5pdGUgPSByb290JDEuaXNGaW5pdGUsCiAgbmF0aXZlTWluID0gTWF0aC5taW47CgovKioKICogQ3JlYXRlcyBhIGZ1bmN0aW9uIGxpa2UgYF8ucm91bmRgLgogKgogKiBAcHJpdmF0ZQogKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kTmFtZSBUaGUgbmFtZSBvZiB0aGUgYE1hdGhgIG1ldGhvZCB0byB1c2Ugd2hlbiByb3VuZGluZy4KICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcm91bmQgZnVuY3Rpb24uCiAqLwpmdW5jdGlvbiBjcmVhdGVSb3VuZChtZXRob2ROYW1lKSB7CiAgdmFyIGZ1bmMgPSBNYXRoW21ldGhvZE5hbWVdOwogIHJldHVybiBmdW5jdGlvbiAobnVtYmVyLCBwcmVjaXNpb24pIHsKICAgIG51bWJlciA9IHRvTnVtYmVyKG51bWJlcik7CiAgICBwcmVjaXNpb24gPSBwcmVjaXNpb24gPT0gbnVsbCA/IDAgOiBuYXRpdmVNaW4odG9JbnRlZ2VyKHByZWNpc2lvbiksIDI5Mik7CiAgICBpZiAocHJlY2lzaW9uICYmIG5hdGl2ZUlzRmluaXRlKG51bWJlcikpIHsKICAgICAgLy8gU2hpZnQgd2l0aCBleHBvbmVudGlhbCBub3RhdGlvbiB0byBhdm9pZCBmbG9hdGluZy1wb2ludCBpc3N1ZXMuCiAgICAgIC8vIFNlZSBbTUROXShodHRwczovL21kbi5pby9yb3VuZCNFeGFtcGxlcykgZm9yIG1vcmUgZGV0YWlscy4KICAgICAgdmFyIHBhaXIgPSAodG9TdHJpbmcobnVtYmVyKSArICdlJykuc3BsaXQoJ2UnKSwKICAgICAgICB2YWx1ZSA9IGZ1bmMocGFpclswXSArICdlJyArICgrcGFpclsxXSArIHByZWNpc2lvbikpOwogICAgICBwYWlyID0gKHRvU3RyaW5nKHZhbHVlKSArICdlJykuc3BsaXQoJ2UnKTsKICAgICAgcmV0dXJuICsocGFpclswXSArICdlJyArICgrcGFpclsxXSAtIHByZWNpc2lvbikpOwogICAgfQogICAgcmV0dXJuIGZ1bmMobnVtYmVyKTsKICB9Owp9CgovKioKICogQ29tcHV0ZXMgYG51bWJlcmAgcm91bmRlZCB0byBgcHJlY2lzaW9uYC4KICoKICogQHN0YXRpYwogKiBAbWVtYmVyT2YgXwogKiBAc2luY2UgMy4xMC4wCiAqIEBjYXRlZ29yeSBNYXRoCiAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIgVGhlIG51bWJlciB0byByb3VuZC4KICogQHBhcmFtIHtudW1iZXJ9IFtwcmVjaXNpb249MF0gVGhlIHByZWNpc2lvbiB0byByb3VuZCB0by4KICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgcm91bmRlZCBudW1iZXIuCiAqIEBleGFtcGxlCiAqCiAqIF8ucm91bmQoNC4wMDYpOwogKiAvLyA9PiA0CiAqCiAqIF8ucm91bmQoNC4wMDYsIDIpOwogKiAvLyA9PiA0LjAxCiAqCiAqIF8ucm91bmQoNDA2MCwgLTIpOwogKiAvLyA9PiA0MTAwCiAqLwp2YXIgcm91bmQgPSBjcmVhdGVSb3VuZCgncm91bmQnKTsKdmFyIHJvdW5kJDEgPSByb3VuZDsKCi8qKg0KICog5pW45a2X5oiW5a2X5Liy5Zub5o2o5LqU5YWl6L2J5pW05pW4DQogKiDoi6XovLjlhaXpnZ7mlbjlrZfliYflm57lgrMwDQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvY2ludC50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBwYXJhbSB7TnVtYmVyfFN0cmluZ30gdiDovLjlhaXmlbjlrZfmiJblrZfkuLINCiAqIEByZXR1cm5zIHtJbnRlZ2VyfSDlm57lgrPlm5vmjajkupTlhaXlvozmlbTmlbgNCiAqIEBleGFtcGxlDQogKg0KICogY29uc29sZS5sb2coY2ludCgnMS41JykpDQogKiAvLyA9PiAyDQogKg0KICogY29uc29sZS5sb2coY2ludCgnLTEuNScpKQ0KICogLy8gPT4gLTENCiAqDQogKi8KZnVuY3Rpb24gY2ludCh2KSB7CiAgLy9jaGVjawogIGlmICghaXNudW0odikpIHsKICAgIHJldHVybiAwOwogIH0KICB2ID0gY2RibCh2KTsKICBsZXQgciA9IHJvdW5kJDEodik7CgogIC8vY2hlY2sgLTAKICBpZiAoU3RyaW5nKHIpID09PSAnMCcpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gcjsKfQoKLyoqDQogKiDliKTmlrfmmK/lkKbngrrmraPmlbTmlbgNCiAqIOato+aVtOaVuOS4jeWMheWQqzDvvIzngrrlpKfmlrww55qE5pW05pW4DQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvaXNwaW50LnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc3BpbnQoMCkpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzcGludCgnMCcpKQ0KICogLy8gPT4gZmFsc2UNCiAqDQogKiBjb25zb2xlLmxvZyhpc3BpbnQoMTI1KSkNCiAqIC8vID0+IHRydWUNCiAqDQogKiBjb25zb2xlLmxvZyhpc3BpbnQoMS4yNSkpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzcGludCgnMTI1JykpDQogKiAvLyA9PiB0cnVlDQogKg0KICogY29uc29sZS5sb2coaXNwaW50KCcxLjI1JykpDQogKiAvLyA9PiBmYWxzZQ0KDQogKiBjb25zb2xlLmxvZyhpc3BpbnQoLTEyNSkpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzcGludCgtMS4yNSkpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzcGludCgnLTEyNScpKQ0KICogLy8gPT4gZmFsc2UNCiAqDQogKiBjb25zb2xlLmxvZyhpc3BpbnQoJy0xLjI1JykpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqLwpmdW5jdGlvbiBpc3BpbnQodikgewogIC8vY2hlY2sKICBpZiAoIWlzaW50KHYpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGxldCByID0gY2ludCh2KSA+IDA7CiAgcmV0dXJuIHI7Cn0KCi8qKg0KICoganNvbuaWh+Wtl+i9ieS7u+aEj+izh+aWmQ0KICoNCiAqIFVuaXQgVGVzdDoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS95dWRhLWx5dS93c2VtaS9ibG9iL21hc3Rlci90ZXN0L2oyby50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBwYXJhbSB7U3RyaW5nfSB2IOi8uOWFpWpzb27moLzlvI/lrZfkuLINCiAqIEByZXR1cm5zIHsqfSDlm57lgrPku7vmhI/os4fmlpkNCiAqIEBleGFtcGxlDQogKg0KICogY29uc29sZS5sb2coajJvKCdbMSwiMyIsImFiYyJdJykpDQogKiAvLyA9PiBbMSwgJzMnLCAnYWJjJ10NCiAqDQogKiBjb25zb2xlLmxvZyhqMm8oJ3siYSI6MTIuMzQsImIiOiJhYmMifScpKQ0KICogLy8gPT4geyBhOiAxMi4zNCwgYjogJ2FiYycgfQ0KICoNCiAqLwpmdW5jdGlvbiBqMm8odikgewogIC8vY2hlY2sKICBpZiAoIWlzZXN0cih2KSkgewogICAgcmV0dXJuIHt9OwogIH0KICBsZXQgYyA9IHt9OwogIHRyeSB7CiAgICBjID0gSlNPTi5wYXJzZSh2KTsKICB9IGNhdGNoIChlcnIpIHsKICAgIGMgPSB7fTsKICB9CiAgcmV0dXJuIGM7Cn0KCnZhciBldmVudGVtaXR0ZXIzID0ge2V4cG9ydHM6IHt9fTsKCihmdW5jdGlvbiAobW9kdWxlKSB7CgogIHZhciBoYXMgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LAogICAgcHJlZml4ID0gJ34nOwoKICAvKioKICAgKiBDb25zdHJ1Y3RvciB0byBjcmVhdGUgYSBzdG9yYWdlIGZvciBvdXIgYEVFYCBvYmplY3RzLgogICAqIEFuIGBFdmVudHNgIGluc3RhbmNlIGlzIGEgcGxhaW4gb2JqZWN0IHdob3NlIHByb3BlcnRpZXMgYXJlIGV2ZW50IG5hbWVzLgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBFdmVudHMoKSB7fQoKICAvLwogIC8vIFdlIHRyeSB0byBub3QgaW5oZXJpdCBmcm9tIGBPYmplY3QucHJvdG90eXBlYC4gSW4gc29tZSBlbmdpbmVzIGNyZWF0aW5nIGFuCiAgLy8gaW5zdGFuY2UgaW4gdGhpcyB3YXkgaXMgZmFzdGVyIHRoYW4gY2FsbGluZyBgT2JqZWN0LmNyZWF0ZShudWxsKWAgZGlyZWN0bHkuCiAgLy8gSWYgYE9iamVjdC5jcmVhdGUobnVsbClgIGlzIG5vdCBzdXBwb3J0ZWQgd2UgcHJlZml4IHRoZSBldmVudCBuYW1lcyB3aXRoIGEKICAvLyBjaGFyYWN0ZXIgdG8gbWFrZSBzdXJlIHRoYXQgdGhlIGJ1aWx0LWluIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSBub3QKICAvLyBvdmVycmlkZGVuIG9yIHVzZWQgYXMgYW4gYXR0YWNrIHZlY3Rvci4KICAvLwogIGlmIChPYmplY3QuY3JlYXRlKSB7CiAgICBFdmVudHMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgICAvLwogICAgLy8gVGhpcyBoYWNrIGlzIG5lZWRlZCBiZWNhdXNlIHRoZSBgX19wcm90b19fYCBwcm9wZXJ0eSBpcyBzdGlsbCBpbmhlcml0ZWQgaW4KICAgIC8vIHNvbWUgb2xkIGJyb3dzZXJzIGxpa2UgQW5kcm9pZCA0LCBpUGhvbmUgNS4xLCBPcGVyYSAxMSBhbmQgU2FmYXJpIDUuCiAgICAvLwogICAgaWYgKCFuZXcgRXZlbnRzKCkuX19wcm90b19fKSBwcmVmaXggPSBmYWxzZTsKICB9CgogIC8qKgogICAqIFJlcHJlc2VudGF0aW9uIG9mIGEgc2luZ2xlIGV2ZW50IGxpc3RlbmVyLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7Kn0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguCiAgICogQHBhcmFtIHtCb29sZWFufSBbb25jZT1mYWxzZV0gU3BlY2lmeSBpZiB0aGUgbGlzdGVuZXIgaXMgYSBvbmUtdGltZSBsaXN0ZW5lci4KICAgKiBAY29uc3RydWN0b3IKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEVFKGZuLCBjb250ZXh0LCBvbmNlKSB7CiAgICB0aGlzLmZuID0gZm47CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgdGhpcy5vbmNlID0gb25jZSB8fCBmYWxzZTsKICB9CgogIC8qKgogICAqIEFkZCBhIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS4KICAgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7Kn0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbnZva2UgdGhlIGxpc3RlbmVyIHdpdGguCiAgICogQHBhcmFtIHtCb29sZWFufSBvbmNlIFNwZWNpZnkgaWYgdGhlIGxpc3RlbmVyIGlzIGEgb25lLXRpbWUgbGlzdGVuZXIuCiAgICogQHJldHVybnMge0V2ZW50RW1pdHRlcn0KICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGFkZExpc3RlbmVyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaGUgbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksCiAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICBpZiAoIWVtaXR0ZXIuX2V2ZW50c1tldnRdKSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IGxpc3RlbmVyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrO2Vsc2UgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XS5mbikgZW1pdHRlci5fZXZlbnRzW2V2dF0ucHVzaChsaXN0ZW5lcik7ZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXJdOwogICAgcmV0dXJuIGVtaXR0ZXI7CiAgfQoKICAvKioKICAgKiBDbGVhciBldmVudCBieSBuYW1lLgogICAqCiAgICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgUmVmZXJlbmNlIHRvIHRoZSBgRXZlbnRFbWl0dGVyYCBpbnN0YW5jZS4KICAgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZ0IFRoZSBFdmVudCBuYW1lLgogICAqIEBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY2xlYXJFdmVudChlbWl0dGVyLCBldnQpIHsKICAgIGlmICgtLWVtaXR0ZXIuX2V2ZW50c0NvdW50ID09PSAwKSBlbWl0dGVyLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7ZWxzZSBkZWxldGUgZW1pdHRlci5fZXZlbnRzW2V2dF07CiAgfQoKICAvKioKICAgKiBNaW5pbWFsIGBFdmVudEVtaXR0ZXJgIGludGVyZmFjZSB0aGF0IGlzIG1vbGRlZCBhZ2FpbnN0IHRoZSBOb2RlLmpzCiAgICogYEV2ZW50RW1pdHRlcmAgaW50ZXJmYWNlLgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHB1YmxpYwogICAqLwogIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICB9CgogIC8qKgogICAqIFJldHVybiBhbiBhcnJheSBsaXN0aW5nIHRoZSBldmVudHMgZm9yIHdoaWNoIHRoZSBlbWl0dGVyIGhhcyByZWdpc3RlcmVkCiAgICogbGlzdGVuZXJzLgogICAqCiAgICogQHJldHVybnMge0FycmF5fQogICAqIEBwdWJsaWMKICAgKi8KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmV2ZW50TmFtZXMgPSBmdW5jdGlvbiBldmVudE5hbWVzKCkgewogICAgdmFyIG5hbWVzID0gW10sCiAgICAgIGV2ZW50cywKICAgICAgbmFtZTsKICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgZm9yIChuYW1lIGluIGV2ZW50cyA9IHRoaXMuX2V2ZW50cykgewogICAgICBpZiAoaGFzLmNhbGwoZXZlbnRzLCBuYW1lKSkgbmFtZXMucHVzaChwcmVmaXggPyBuYW1lLnNsaWNlKDEpIDogbmFtZSk7CiAgICB9CiAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICByZXR1cm4gbmFtZXMuY29uY2F0KE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZXZlbnRzKSk7CiAgICB9CiAgICByZXR1cm4gbmFtZXM7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJuIHRoZSBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgYSBnaXZlbiBldmVudC4KICAgKgogICAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSByZWdpc3RlcmVkIGxpc3RlbmVycy4KICAgKiBAcHVibGljCiAgICovCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnQpIHsKICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LAogICAgICBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgaWYgKCFoYW5kbGVycykgcmV0dXJuIFtdOwogICAgaWYgKGhhbmRsZXJzLmZuKSByZXR1cm4gW2hhbmRsZXJzLmZuXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICBlZVtpXSA9IGhhbmRsZXJzW2ldLmZuOwogICAgfQogICAgcmV0dXJuIGVlOwogIH07CgogIC8qKgogICAqIFJldHVybiB0aGUgbnVtYmVyIG9mIGxpc3RlbmVycyBsaXN0ZW5pbmcgdG8gYSBnaXZlbiBldmVudC4KICAgKgogICAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS4KICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtYmVyIG9mIGxpc3RlbmVycy4KICAgKiBAcHVibGljCiAgICovCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24gbGlzdGVuZXJDb3VudChldmVudCkgewogICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQsCiAgICAgIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgaWYgKGxpc3RlbmVycy5mbikgcmV0dXJuIDE7CiAgICByZXR1cm4gbGlzdGVuZXJzLmxlbmd0aDsKICB9OwoKICAvKioKICAgKiBDYWxscyBlYWNoIG9mIHRoZSBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgYSBnaXZlbiBldmVudC4KICAgKgogICAqIEBwYXJhbSB7KFN0cmluZ3xTeW1ib2wpfSBldmVudCBUaGUgZXZlbnQgbmFtZS4KICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gYHRydWVgIGlmIHRoZSBldmVudCBoYWQgbGlzdGVuZXJzLCBlbHNlIGBmYWxzZWAuCiAgICogQHB1YmxpYwogICAqLwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gZmFsc2U7CiAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sCiAgICAgIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgIGFyZ3MsCiAgICAgIGk7CiAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgIGlmIChsaXN0ZW5lcnMub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzLmZuLCB1bmRlZmluZWQsIHRydWUpOwogICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCksIHRydWU7CiAgICAgICAgY2FzZSAyOgogICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSksIHRydWU7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgIGNhc2UgNDoKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMyksIHRydWU7CiAgICAgICAgY2FzZSA1OgogICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCksIHRydWU7CiAgICAgICAgY2FzZSA2OgogICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICB9CiAgICAgIGZvciAoaSA9IDEsIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7IGkgPCBsZW47IGkrKykgewogICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICB9CiAgICAgIGxpc3RlbmVycy5mbi5hcHBseShsaXN0ZW5lcnMuY29udGV4dCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aCwKICAgICAgICBqOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAobGlzdGVuZXJzW2ldLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyc1tpXS5mbiwgdW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEsIGEyLCBhMyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgaWYgKCFhcmdzKSBmb3IgKGogPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uYXBwbHkobGlzdGVuZXJzW2ldLmNvbnRleHQsIGFyZ3MpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuCiAgICoKICAgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gZXZlbnQgVGhlIGV2ZW50IG5hbWUuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7Kn0gW2NvbnRleHQ9dGhpc10gVGhlIGNvbnRleHQgdG8gaW52b2tlIHRoZSBsaXN0ZW5lciB3aXRoLgogICAqIEByZXR1cm5zIHtFdmVudEVtaXR0ZXJ9IGB0aGlzYC4KICAgKiBAcHVibGljCiAgICovCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIG9uKGV2ZW50LCBmbiwgY29udGV4dCkgewogICAgcmV0dXJuIGFkZExpc3RlbmVyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgZmFsc2UpOwogIH07CgogIC8qKgogICAqIEFkZCBhIG9uZS10aW1lIGxpc3RlbmVyIGZvciBhIGdpdmVuIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBsaXN0ZW5lciBmdW5jdGlvbi4KICAgKiBAcGFyYW0geyp9IFtjb250ZXh0PXRoaXNdIFRoZSBjb250ZXh0IHRvIGludm9rZSB0aGUgbGlzdGVuZXIgd2l0aC4KICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuCiAgICogQHB1YmxpYwogICAqLwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uIG9uY2UoZXZlbnQsIGZuLCBjb250ZXh0KSB7CiAgICByZXR1cm4gYWRkTGlzdGVuZXIodGhpcywgZXZlbnQsIGZuLCBjb250ZXh0LCB0cnVlKTsKICB9OwoKICAvKioKICAgKiBSZW1vdmUgdGhlIGxpc3RlbmVycyBvZiBhIGdpdmVuIGV2ZW50LgogICAqCiAgICogQHBhcmFtIHsoU3RyaW5nfFN5bWJvbCl9IGV2ZW50IFRoZSBldmVudCBuYW1lLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIE9ubHkgcmVtb3ZlIHRoZSBsaXN0ZW5lcnMgdGhhdCBtYXRjaCB0aGlzIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7Kn0gY29udGV4dCBPbmx5IHJlbW92ZSB0aGUgbGlzdGVuZXJzIHRoYXQgaGF2ZSB0aGlzIGNvbnRleHQuCiAgICogQHBhcmFtIHtCb29sZWFufSBvbmNlIE9ubHkgcmVtb3ZlIG9uZS10aW1lIGxpc3RlbmVycy4KICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuCiAgICogQHB1YmxpYwogICAqLwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudCwgZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwogICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICBpZiAoIWZuKSB7CiAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CiAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4gPT09IGZuICYmICghb25jZSB8fCBsaXN0ZW5lcnMub25jZSkgJiYgKCFjb250ZXh0IHx8IGxpc3RlbmVycy5jb250ZXh0ID09PSBjb250ZXh0KSkgewogICAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50cyA9IFtdLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICBldmVudHMucHVzaChsaXN0ZW5lcnNbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8KICAgICAgLy8gUmVzZXQgdGhlIGFycmF5LCBvciByZW1vdmUgaXQgY29tcGxldGVseSBpZiB3ZSBoYXZlIG5vIG1vcmUgbGlzdGVuZXJzLgogICAgICAvLwogICAgICBpZiAoZXZlbnRzLmxlbmd0aCkgdGhpcy5fZXZlbnRzW2V2dF0gPSBldmVudHMubGVuZ3RoID09PSAxID8gZXZlbnRzWzBdIDogZXZlbnRzO2Vsc2UgY2xlYXJFdmVudCh0aGlzLCBldnQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBsaXN0ZW5lcnMsIG9yIHRob3NlIG9mIHRoZSBzcGVjaWZpZWQgZXZlbnQuCiAgICoKICAgKiBAcGFyYW0geyhTdHJpbmd8U3ltYm9sKX0gW2V2ZW50XSBUaGUgZXZlbnQgbmFtZS4KICAgKiBAcmV0dXJucyB7RXZlbnRFbWl0dGVyfSBgdGhpc2AuCiAgICogQHB1YmxpYwogICAqLwogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICB2YXIgZXZ0OwogICAgaWYgKGV2ZW50KSB7CiAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICh0aGlzLl9ldmVudHNbZXZ0XSkgY2xlYXJFdmVudCh0aGlzLCBldnQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLwogIC8vIEFsaWFzIG1ldGhvZHMgbmFtZXMgYmVjYXVzZSBwZW9wbGUgcm9sbCBsaWtlIHRoYXQuCiAgLy8KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9mZiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXI7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUub247CgogIC8vCiAgLy8gRXhwb3NlIHRoZSBwcmVmaXguCiAgLy8KICBFdmVudEVtaXR0ZXIucHJlZml4ZWQgPSBwcmVmaXg7CgogIC8vCiAgLy8gQWxsb3cgYEV2ZW50RW1pdHRlcmAgdG8gYmUgaW1wb3J0ZWQgYXMgbW9kdWxlIG5hbWVzcGFjZS4KICAvLwogIEV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CgogIC8vCiAgLy8gRXhwb3NlIHRoZSBtb2R1bGUuCiAgLy8KICB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKICB9Cn0pKGV2ZW50ZW1pdHRlcjMpOwp2YXIgZXZlbnRlbWl0dGVyM0V4cG9ydHMgPSBldmVudGVtaXR0ZXIzLmV4cG9ydHM7CnZhciBFdmVudEVtaXR0ZXIgPSAvKkBfX1BVUkVfXyovZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMoZXZlbnRlbWl0dGVyM0V4cG9ydHMpOwoKLyoqDQogKiBFdmVudEVtaXR0ZXIgZnJvbSBldmVudGVtaXR0ZXIzDQogKg0KICogU2VlOiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3ByaW11cy9ldmVudGVtaXR0ZXIzIGV2ZW50ZW1pdHRlcjN9DQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvZXZlbS50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBleGFtcGxlDQogKg0KICogbGV0IGV2ID0gd3NlbWkuZXZlbSgpDQogKiBldi5vbignZXZOYW1lJyxmdW5jdGlvbihtc2cpew0KICogICAgIGNvbnNvbGUubG9nKG1zZykNCiAqICAgICAvLyA9PiB7YWJjOiAxMi4zNH0NCiAqIH0pDQogKiBsZXQgZGF0YSA9IHthYmM6MTIuMzR9DQogKiBldi5lbWl0KCdldk5hbWUnLGRhdGEpDQogKg0KICovCmZ1bmN0aW9uIGV2ZW0oKSB7CiAgcmV0dXJuIG5ldyBFdmVudEVtaXR0ZXIoKTsKfQoKbGV0IGNoYXJzID0gJzAxMjM0NTY3ODlBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6Jy5zcGxpdCgnJyk7CmxldCByYWRpeCA9IGNoYXJzLmxlbmd0aDsKCi8qKg0KICog55Si55Sf6Zqo5qmfaWQNCiAqDQogKiBVbml0IFRlc3Q6IHtAbGluayBodHRwczovL2dpdGh1Yi5jb20veXVkYS1seXUvd3NlbWkvYmxvYi9tYXN0ZXIvdGVzdC9nZW5JRC50ZXN0Lm1qcyBHaXRodWJ9DQogKiBAbWVtYmVyT2Ygd3NlbWkNCiAqIEBwYXJhbSB7SW50ZWdlcn0gW2xlbj0zMl0g6Ly45YWldXVpZOmVt+W6pu+8jOeCuuato+aVtOaVuO+8jOmgkOiorTMyDQogKiBAcmV0dXJucyB7U3RyaW5nfSDlm57lgrN1dWlk5a2X5LiyDQogKiBAZXhhbXBsZQ0KICoNCiAqIGNvbnNvbGUubG9nKGdlbklEKCkpDQogKiAvLyA9PiBJczFOeUltVTNBOWZ5cUZ5WUJXdUp1NGl2WFhjR1pBYiAoaXMgcmFuZG9tKQ0KICoNCiAqLwpmdW5jdGlvbiBnZW5JRChsZW4gPSAzMikgewogIGxldCB1dWlkID0gW107CgogIC8vY2hlY2sKICBpZiAoaXNwaW50KGxlbikpIHsKICAgIGxlbiA9IGNpbnQobGVuKTsKICB9IGVsc2UgewogICAgbGVuID0gMzI7CiAgfQoKICAvL3V1aWQKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB1dWlkW2ldID0gY2hhcnNbMCB8IE1hdGgucmFuZG9tKCkgKiByYWRpeF07CgogIC8vcmZjNDEyMiwgdmVyc2lvbiA0IGZvcm0KICAvLyAvL3JlcXVpcmVzIHRoZXNlIGNoYXJhY3RlcnMKICAvLyB1dWlkWzhdID0gdXVpZFsxM10gPSB1dWlkWzE4XSA9IHV1aWRbMjNdID0gJy0nCiAgLy8gdXVpZFsxNF0gPSAnNCcKICAvLyAvL2ZpbGwgaW4gcmFuZG9tIGRhdGEuICBBdCBpPT0xOSBzZXQgdGhlIGhpZ2ggYml0cyBvZiBjbG9jayBzZXF1ZW5jZSBhcyBwZXIgcmZjNDEyMiwgc2VjLiA0LjEuNQogIC8vIGxldCByCiAgLy8gZm9yIChpID0gMDsgaSA8IDM2OyBpKyspIHsKICAvLyAgICAgaWYgKCF1dWlkW2ldKSB7CiAgLy8gICAgICAgICByID0gMCB8IE1hdGgucmFuZG9tKCkgKiAxNgogIC8vICAgICAgICAgdXVpZFtpXSA9IGNoYXJzWyhpID09PSAxOSkgPyAociAmIDB4MykgfCAweDggOiByXQogIC8vICAgICB9CiAgLy8gfQoKICBsZXQgciA9IHV1aWQuam9pbignJyk7CiAgcmV0dXJuIHI7Cn0KCi8qKg0KICog55Si55SfUHJvbWlzZeeJqeS7tu+8jOWFt+WCmemPiOW8j3Jlc29sdmXoiIdyZWplY3QNCiAqIOS4u+imgeWPl2pRdWVyeSBEZWZlcnJlZOamguW/teWVn+eZvA0KICoNCiAqIFVuaXQgVGVzdDoge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS95dWRhLWx5dS93c2VtaS9ibG9iL21hc3Rlci90ZXN0L2dlblBtLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHJldHVybnMge09iamVjdH0g5Zue5YKzUHJvbWlzZeeJqeS7tg0KICogQGV4YW1wbGUNCiAqDQogKiBhc3luYyBmdW5jdGlvbiB0b3BBc3luYygpIHsNCiAqDQogKiAgICAgZnVuY3Rpb24gdGVzdDEoKSB7DQogKiAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogKiAgICAgICAgICAgICBsZXQgbXMgPSBbXQ0KICoNCiAqICAgICAgICAgICAgIGxldCBmbiA9IGZ1bmN0aW9uKG5hbWUpIHsNCiAqICAgICAgICAgICAgICAgICBsZXQgcG0gPSBnZW5QbSgpDQogKiAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAqICAgICAgICAgICAgICAgICAgICAgbXMucHVzaCgncmVzb2x2ZTogJyArIG5hbWUpDQogKiAgICAgICAgICAgICAgICAgICAgIHBtLnJlc29sdmUoJ3Jlc29sdmU6ICcgKyBuYW1lKQ0KICogICAgICAgICAgICAgICAgIH0sIDEpDQogKiAgICAgICAgICAgICAgICAgcmV0dXJuIHBtDQogKiAgICAgICAgICAgICB9DQogKg0KICogICAgICAgICAgICAgZm4oJ2FiYycpDQogKiAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24obXNnKSB7DQogKiAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd0MSB0aGVuJywgbXNnKQ0KICogICAgICAgICAgICAgICAgICAgICBtcy5wdXNoKCd0MSB0aGVuOiAnICsgbXNnKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKiAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKG1zZykgew0KICogICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndDEgY2F0Y2gnLCBtc2cpDQogKiAgICAgICAgICAgICAgICAgICAgIG1zLnB1c2goJ3QxIGNhdGNoOiAnICsgbXNnKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKiAgICAgICAgICAgICAgICAgLmZpbmFsbHkoKCkgPT4gew0KICogICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG1zKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKg0KICogICAgICAgICB9KQ0KICogICAgIH0NCiAqICAgICBjb25zb2xlLmxvZygndGVzdDEnKQ0KICogICAgIGxldCByMSA9IGF3YWl0IHRlc3QxKCkNCiAqICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyMSkpDQogKiAgICAgLy8gdGVzdDENCiAqICAgICAvLyB0MSB0aGVuIHJlc29sdmU6IGFiYw0KICogICAgIC8vIFsicmVzb2x2ZTogYWJjIiwidDEgdGhlbjogcmVzb2x2ZTogYWJjIl0NCiAqDQogKiAgICAgZnVuY3Rpb24gdGVzdDIoKSB7DQogKiAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogKiAgICAgICAgICAgICBsZXQgbXMgPSBbXQ0KICoNCiAqICAgICAgICAgICAgIGxldCBmbiA9IGZ1bmN0aW9uKG5hbWUpIHsNCiAqICAgICAgICAgICAgICAgICBsZXQgcG0gPSBnZW5QbSgpDQogKiAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAqICAgICAgICAgICAgICAgICAgICAgbXMucHVzaCgncmVqZWN0OiAnICsgbmFtZSkNCiAqICAgICAgICAgICAgICAgICAgICAgcG0ucmVqZWN0KCdyZWplY3Q6ICcgKyBuYW1lKQ0KICogICAgICAgICAgICAgICAgIH0sIDEpDQogKiAgICAgICAgICAgICAgICAgcmV0dXJuIHBtDQogKiAgICAgICAgICAgICB9DQogKg0KICogICAgICAgICAgICAgZm4oJ2FiYycpDQogKiAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24obXNnKSB7DQogKiAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd0MSB0aGVuJywgbXNnKQ0KICogICAgICAgICAgICAgICAgICAgICBtcy5wdXNoKCd0MSB0aGVuOiAnICsgbXNnKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKiAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKG1zZykgew0KICogICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndDEgY2F0Y2gnLCBtc2cpDQogKiAgICAgICAgICAgICAgICAgICAgIG1zLnB1c2goJ3QxIGNhdGNoOiAnICsgbXNnKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKiAgICAgICAgICAgICAgICAgLmZpbmFsbHkoKCkgPT4gew0KICogICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG1zKQ0KICogICAgICAgICAgICAgICAgIH0pDQogKg0KICogICAgICAgICB9KQ0KICogICAgIH0NCiAqICAgICBjb25zb2xlLmxvZygndGVzdDInKQ0KICogICAgIGxldCByMiA9IGF3YWl0IHRlc3QyKCkNCiAqICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyMikpDQogKiAgICAgLy8gdGVzdDINCiAqICAgICAvLyB0MSBjYXRjaCByZWplY3Q6IGFiYw0KICogICAgIC8vIFsicmVqZWN0OiBhYmMiLCJ0MSBjYXRjaDogcmVqZWN0OiBhYmMiXQ0KICoNCiAqIH0NCiAqIHRvcEFzeW5jKCkuY2F0Y2goKCkgPT4ge30pDQogKg0KICovCmZ1bmN0aW9uIGdlblBtKCkgewogIGxldCByZXNvbHZlOwogIGxldCByZWplY3Q7CiAgbGV0IHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAoKSB7CiAgICByZXNvbHZlID0gYXJndW1lbnRzWzBdOwogICAgcmVqZWN0ID0gYXJndW1lbnRzWzFdOwogIH0pOwogIHAucmVzb2x2ZSA9IHJlc29sdmU7CiAgcC5yZWplY3QgPSByZWplY3Q7CiAgcmV0dXJuIHA7Cn0KCi8qKg0KICog5Yik5pa35piv5ZCm54K65Ye95pW4DQogKg0KICogVW5pdCBUZXN0OiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3l1ZGEtbHl1L3dzZW1pL2Jsb2IvbWFzdGVyL3Rlc3QvaXNmdW4udGVzdC5tanMgR2l0aHVifQ0KICogQG1lbWJlck9mIHdzZW1pDQogKiBAcGFyYW0geyp9IHYg6Ly45YWl5Lu75oSP6LOH5paZDQogKiBAcmV0dXJucyB7Qm9vbGVhbn0g5Zue5YKz5Yik5pa35biD5p6X5YC8DQogKiBAZXhhbXBsZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzZnVuKCcxLjI1JykpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzZnVuKGZ1bmN0aW9uKCkge30pKQ0KICogLy8gPT4gdHJ1ZQ0KICoNCiAqLwpmdW5jdGlvbiBpc2Z1bih2KSB7CiAgbGV0IGMgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodik7CiAgcmV0dXJuIGMgPT09ICdbb2JqZWN0IEZ1bmN0aW9uXScgfHwgYyA9PT0gJ1tvYmplY3QgQXN5bmNGdW5jdGlvbl0nOwp9CgovKioNCiAqIOWIpOaWt+aYr+WQpueCulByb21pc2UNCiAqDQogKiBVbml0IFRlc3Q6IHtAbGluayBodHRwczovL2dpdGh1Yi5jb20veXVkYS1seXUvd3NlbWkvYmxvYi9tYXN0ZXIvdGVzdC9pc3BtLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHsqfSB2IOi8uOWFpeS7u+aEj+izh+aWmQ0KICogQHJldHVybnMge0Jvb2xlYW59IOWbnuWCs+WIpOaWt+W4g+ael+WAvA0KICogQGV4YW1wbGUNCiAqDQogKiBjb25zb2xlLmxvZyhpc3BtKCcxLjI1JykpDQogKiAvLyA9PiBmYWxzZQ0KICoNCiAqIGNvbnNvbGUubG9nKGlzcG0obmV3IFByb21pc2UoZnVuY3Rpb24oKSB7fSkpKQ0KICogLy8gPT4gdHJ1ZQ0KICoNCiAqLwpmdW5jdGlvbiBpc3BtKHYpIHsKICBsZXQgYjsKICBsZXQgYyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2KTsKICBiID0gYyA9PT0gJ1tvYmplY3QgUHJvbWlzZV0nOwogIGlmIChiKSB7CiAgICByZXR1cm4gdHJ1ZTsgLy/oi6Xngrpbb2JqZWN0IFByb21pc2Vd5YmH55u05o6l5Zue5YKzdHJ1ZQogIH0KICBpZiAoYyAhPT0gJ1tvYmplY3QgRnVuY3Rpb25dJykgewogICAgcmV0dXJuIGZhbHNlOyAvL+iLpeS4jeaYr1tvYmplY3QgUHJvbWlzZV3kuZ/kuI3mmK9bb2JqZWN0IEZ1bmN0aW9uXeWJh+ebtOaOpeWbnuWCs2ZhbHNlCiAgfQogIHRyeSB7CiAgICBiID0gdHlwZW9mIHYuc3Vic2NyaWJlICE9PSAnZnVuY3Rpb24nICYmIHR5cGVvZiB2LnRoZW4gPT09ICdmdW5jdGlvbic7IC8v5Y+v5YG15risYXN5bmMgZnVuY3Rpb24KICB9IGNhdGNoIChlcnIpIHt9CiAgcmV0dXJuIGI7Cn0KCi8qKg0KICog562J5b6FZuWHveaVuOWbnuWCs3RydWUNCiAqDQogKiBVbml0IFRlc3Q6IHtAbGluayBodHRwczovL2dpdGh1Yi5jb20veXVkYS1seXUvd3NlbWkvYmxvYi9tYXN0ZXIvdGVzdC93YWl0RnVuLnRlc3QubWpzIEdpdGh1Yn0NCiAqIEBtZW1iZXJPZiB3c2VtaQ0KICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuIOi8uOWFpeWIpOaWt+eUqOWHveaVuA0KICogQHBhcmFtIHtPYmplY3R9IG9wdCDovLjlhaXoqK3lrprnianku7bvvIzpoJDoqK17fQ0KICogQHBhcmFtIHtJbnRlZ2VyfSBbb3B0LmF0dGVtcHROdW09MjAwXSDovLjlhaXmnIDlpKflmJfoqabmrKHmlbjvvIzngrrmraPmlbTmlbjvvIzpoJDoqK0yMDANCiAqIEBwYXJhbSB7SW50ZWdlcn0gW29wdC50aW1lSW50ZXJ2YWw9MTAwMF0g6Ly45YWl5ZiX6Kmm5pmC6ZaT6YCx5pyf77yM54K65q2j5pW05pW477yM5Zau5L2N54K6bXPvvIzpoJDoqK0xMDAwDQogKiBAcmV0dXJucyB7UHJvbWlzZX0g5Zue5YKzUHJvbWlzZe+8jHJlc29sdmXlm57lgrPngrrnqbrku6Pooahm5Ye95pW45Zue5YKzdHJ1ZeaIlui2hemBjuacgOWkp+WYl+ippuasoeaVuO+8jHJlamVjdOWbnuWCs+mMr+iqpOioiuaBrw0KICogQGV4YW1wbGUNCiAqDQogKiBhc3luYyBmdW5jdGlvbiB0b3BBc3luYygpIHsNCiAqDQogKiAgICAgZnVuY3Rpb24gdGVzdDEoKSB7DQogKiAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogKiAgICAgICAgICAgICBsZXQgbXMgPSBbXQ0KICoNCiAqICAgICAgICAgICAgIGxldCBpID0gMA0KICogICAgICAgICAgICAgd2FpdEZ1bihmdW5jdGlvbigpIHsNCiAqICAgICAgICAgICAgICAgICBpKysNCiAqICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnd2FpdGluZzogJyArIGkpDQogKiAgICAgICAgICAgICAgICAgbXMucHVzaCgnd2FpdGluZzogJyArIGkpDQogKiAgICAgICAgICAgICAgICAgcmV0dXJuIGkgPj0gMg0KICogICAgICAgICAgICAgfSkNCiAqICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsNCiAqICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3Rlc3QxIHRoZW4nKQ0KICogICAgICAgICAgICAgICAgICAgICBtcy5wdXNoKCd0ZXN0MSB0aGVuJykNCiAqICAgICAgICAgICAgICAgICB9KQ0KICoNCiAqICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogKiAgICAgICAgICAgICAgICAgcmVzb2x2ZShtcykNCiAqICAgICAgICAgICAgIH0sIDExMDApDQogKg0KICogICAgICAgICB9KQ0KICogICAgIH0NCiAqICAgICBjb25zb2xlLmxvZygndGVzdDEnKQ0KICogICAgIGxldCByMSA9IGF3YWl0IHRlc3QxKCkNCiAqICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyMSkpDQogKiAgICAgLy8gdGVzdDENCiAqICAgICAvLyB3YWl0aW5nOiAxDQogKiAgICAgLy8gd2FpdGluZzogMg0KICogICAgIC8vIHRlc3QxIHRoZW4NCiAqICAgICAvLyBbIndhaXRpbmc6IDEiLCJ3YWl0aW5nOiAyIiwidGVzdDEgdGhlbiJdDQogKg0KICogICAgIGZ1bmN0aW9uIHRlc3QyKCkgew0KICogICAgICAgICBsZXQgbXMgPSBbXQ0KICogICAgICAgICBsZXQgaSA9IDANCiAqDQogKiAgICAgICAgIGxldCBmID0gKCkgPT4gew0KICogICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAqICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KICogICAgICAgICAgICAgICAgICAgICBpKysNCiAqICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3dhaXRpbmc6ICcgKyBpKQ0KICogICAgICAgICAgICAgICAgICAgICBtcy5wdXNoKCd3YWl0aW5nOiAnICsgaSkNCiAqICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShpID49IDIpDQogKiAgICAgICAgICAgICAgICAgfSwgMTEwMCkNCiAqICAgICAgICAgICAgIH0pDQogKiAgICAgICAgIH0NCiAqDQogKiAgICAgICAgIHJldHVybiB3YWl0RnVuKGYpDQogKiAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsNCiAqICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndGVzdDIgdGhlbicpDQogKiAgICAgICAgICAgICAgICAgbXMucHVzaCgndGVzdDIgdGhlbicpDQogKiAgICAgICAgICAgICAgICAgcmV0dXJuIG1zDQogKiAgICAgICAgICAgICB9KQ0KICoNCiAqICAgICB9DQogKiAgICAgY29uc29sZS5sb2coJ3Rlc3QyJykNCiAqICAgICBsZXQgcjIgPSBhd2FpdCB0ZXN0MigpDQogKiAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocjIpKQ0KICogICAgIC8vIHRlc3QyDQogKiAgICAgLy8gd2FpdGluZzogMQ0KICogICAgIC8vIHdhaXRpbmc6IDINCiAqICAgICAvLyB0ZXN0MiB0aGVuDQogKiAgICAgLy8gWyJ3YWl0aW5nOiAxIiwid2FpdGluZzogMiIsInRlc3QyIHRoZW4iXQ0KICogICAgIC8vIHdhaXRpbmc6IDMNCiAqDQogKiB9DQogKiB0b3BBc3luYygpLmNhdGNoKCgpID0+IHt9KQ0KICoNCiAqLwphc3luYyBmdW5jdGlvbiB3YWl0RnVuKGZ1biwgb3B0ID0ge30pIHsKICBsZXQgciA9IG51bGw7CgogIC8vcG0KICBsZXQgcG0gPSBnZW5QbSgpOwoKICAvL2NoZWNrCiAgaWYgKCFpc2Z1bihmdW4pKSB7CiAgICBwbS5yZWplY3QoJ3dhaXRmdW5jdGlvbumcgOi8uOWFpeWHveaVuGYnKTsKICAgIHJldHVybiBwbTsKICB9CgogIC8vZnVuYwogIGxldCBmdW5jID0gYXN5bmMgKCkgPT4gewogICAgbGV0IHIgPSBmdW4oKTsKICAgIGlmIChpc3BtKHIpKSB7CiAgICAgIHIgPSBhd2FpdCByOwogICAgfQogICAgcmV0dXJuIHI7CiAgfTsKCiAgLy9pbW1lZGlhdGUgY2FsbAogIHIgPSBhd2FpdCBmdW5jKCk7CiAgaWYgKHIgPT09IHRydWUpIHsKICAgIHBtLnJlc29sdmUoKTsKICAgIHJldHVybiBwbTsKICB9CgogIC8vYXR0ZW1wdE51bQogIGxldCBhdHRlbXB0TnVtID0gZ2V0KG9wdCwgJ2F0dGVtcHROdW0nLCBudWxsKTsKICBpZiAoIWlzcGludChhdHRlbXB0TnVtKSkgewogICAgYXR0ZW1wdE51bSA9IDIwMDsKICB9CgogIC8vdGltZUludGVydmFsCiAgbGV0IHRpbWVJbnRlcnZhbCA9IGdldChvcHQsICd0aW1lSW50ZXJ2YWwnLCBudWxsKTsKICBpZiAoIWlzcGludCh0aW1lSW50ZXJ2YWwpKSB7CiAgICB0aW1lSW50ZXJ2YWwgPSAxMDAwOwogIH0KCiAgLy9zZXRJbnRlcnZhbAogIGxldCBuID0gMDsKICBsZXQgdCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHsKICAgIG4gKz0gMTsKICAgIC8vY29uc29sZS5sb2coJ3dhaXRGdW46ICcsIG4pCgogICAgciA9IGF3YWl0IGZ1bmMoKTsKICAgIGlmIChyID09PSB0cnVlKSB7CiAgICAgIC8vY29uc29sZS5sb2coJ3Jlc29sdmUnLCBuKQogICAgICBjbGVhckludGVydmFsKHQpOwogICAgICBwbS5yZXNvbHZlKCk7CiAgICB9CiAgICBpZiAobiA+IGF0dGVtcHROdW0pIHsKICAgICAgLy9jb25zb2xlLmxvZygncmVqZWN0JywgbiwgYXR0ZW1wdE51bSkKICAgICAgY2xlYXJJbnRlcnZhbCh0KTsKICAgICAgcG0ucmVqZWN0KGBleGNlZWRlZCBhdHRlbXB0TnVtWyR7YXR0ZW1wdE51bX1dYCk7IC8v5bey6LaF6YGO5pyA5aSn5qyh5pW4CiAgICB9CiAgfSwgdGltZUludGVydmFsKTsKICByZXR1cm4gcG07Cn0KCi8qKg0KICog5bu656uL5LiA5YCLIE1RVFQg5a6i5oi256uv77yM5pSv5o+05oyB5LmF6YCj57ea44CBVG9rZW4g6amX6K2J44CB6Ieq5YuV6YeN6YCj44CB6KiC6Zax6IiH55m85L2I5Yqf6IO944CCDQogKg0KICogQHBhcmFtIHtPYmplY3R9IFtvcHQ9e31dIC0g6Kit5a6a6YG46aCFDQogKiBAcGFyYW0ge3N0cmluZ30gW29wdC51cmw9J21xdHQ6Ly9sb2NhbGhvc3QnXSAtIE1RVFQgYnJva2VyIOmAo+e3miBVUkwNCiAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0LnBvcnQ9ODA4MF0gLSBCcm9rZXIg6YCj57eaIHBvcnQNCiAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0LnRva2VuPScnXSAtIOmAo+e3muaZgueUqOS+humpl+itieeahCBUb2tlbg0KICogQHBhcmFtIHtzdHJpbmd9IFtvcHQuY2xpZW50SWRdIC0g5oyH5a6aIENsaWVudCBJRO+8jOiLpeacquaMh+WumuWJh+iHquWLleeUoueUnw0KICogQHBhcmFtIHtudW1iZXJ9IFtvcHQudGltZVJlY29ubmVjdD0yMDAwXSAtIOaWt+e3muW+jOmHjeaWsOmAo+e3mueahOmWk+malOaZgumWk++8iOavq+enku+8iQ0KICogQHJldHVybnMge09iamVjdH0gLSDlgrPlm57kuIDlgIvlhbfmnIkgYHN1YnNjcmliZWDjgIFgcHVibGlzaGAg5pa55rOV6IiH5LqL5Lu255qE54mp5Lu2IChFdmVudEVtaXR0ZXItbGlrZSkNCiAqIEBleGFtcGxlDQogKg0KICogaW1wb3J0IHcgZnJvbSAnd3NlbWknDQogKiBpbXBvcnQgV1B1YnN1YkNsaWVudCBmcm9tICcuL3NyYy9XUHVic3ViQ2xpZW50Lm1qcycNCiAqIC8vIGltcG9ydCBXUHVic3ViQ2xpZW50IGZyb20gJy4vZGlzdC93LXB1YnN1Yi1jbGllbnQudW1kLmpzJw0KICogLy8gaW1wb3J0IFdQdWJzdWJDbGllbnQgZnJvbSAnLi9kaXN0L3ctcHVic3ViLWNsaWVudC53ay51bWQuanMnDQogKg0KICogbGV0IHRlc3QgPSBhc3luYyAoKSA9PiB7DQogKiAgICAgbGV0IHBtID0gdy5nZW5QbSgpDQogKg0KICogICAgIGxldCBtcyA9IFtdDQogKg0KICogICAgIGxldCBjbGllbnRJZCA9ICdpZC1mb3ItY2xpZW50Jw0KICoNCiAqICAgICBsZXQgb3B0ID0gew0KICogICAgICAgICBwb3J0OiA4MDgwLA0KICogICAgICAgICB0b2tlbjogJ3Rva2VuLWZvci10ZXN0JywNCiAqICAgICAgICAgY2xpZW50SWQsDQogKiAgICAgfQ0KICogICAgIGxldCB3cGMgPSBuZXcgV1B1YnN1YkNsaWVudChvcHQpDQogKiAgICAgLy8gY29uc29sZS5sb2coJ3dwYycsIHdwYykNCiAqDQogKiAgICAgbGV0IHRvcGljID0gJ3Rhc2snDQogKg0KICogICAgIHdwYy5vbignY29ubmVjdCcsICgpID0+IHsNCiAqICAgICAgICAgY29uc29sZS5sb2coJ2Nvbm5lY3QnKQ0KICogICAgICAgICBtcy5wdXNoKHsgY2xpZW50SWQ6IGBjb25uZWN0YCB9KQ0KICogICAgIH0pDQogKiAgICAgd3BjLm9uKCdyZWNvbm5lY3QnLCAoKSA9PiB7DQogKiAgICAgICAgIGNvbnNvbGUubG9nKCdyZWNvbm5lY3QnKQ0KICogICAgIH0pDQogKiAgICAgd3BjLm9uKCdvZmZsaW5lJywgKCkgPT4gew0KICogICAgICAgICBjb25zb2xlLmxvZygnb2ZmbGluZScpDQogKiAgICAgfSkNCiAqICAgICAvLyB3cGMub24odG9waWMsIChtc2cpID0+IHsNCiAqICAgICAvLyAgICAgY29uc29sZS5sb2coYHRvcGljWyR7dG9waWN9XWAsIG1zZy50b1N0cmluZygpKQ0KICogICAgIC8vICAgICBtcy5wdXNoKHsgY2xpZW50SWQ6IGByZWNlaXZlIHRvcGljWyR7dG9waWN9XWAgfSkNCiAqICAgICAvLyB9KQ0KICogICAgIHdwYy5vbignbWVzc2FnZScsICh7IHRvcGljLCBtZXNzYWdlIH0pID0+IHsNCiAqICAgICAgICAgY29uc29sZS5sb2coYG1lc3NhZ2VgLCB0b3BpYywgbWVzc2FnZSwgbWVzc2FnZS50b1N0cmluZygpKQ0KICogICAgICAgICBtcy5wdXNoKHsgY2xpZW50SWQ6IGByZWNlaXZlIHRvcGljWyR7dG9waWN9XSwgbWVzc2FnZVske21lc3NhZ2UudG9TdHJpbmcoKX1dYCB9KQ0KICogICAgIH0pDQogKiAgICAgd3BjLm9uKCdjbG9zZScsICgpID0+IHsNCiAqICAgICAgICAgY29uc29sZS5sb2coJ2Nsb3NlJykNCiAqICAgICAgICAgbXMucHVzaCh7IGNsaWVudElkOiBgY2xvc2VgIH0pDQogKiAgICAgfSkNCiAqICAgICB3cGMub24oJ2VuZCcsICgpID0+IHsNCiAqICAgICAgICAgY29uc29sZS5sb2coJ2VuZCcpDQogKiAgICAgfSkNCiAqICAgICB3cGMub24oJ2Vycm9yJywgKGVycikgPT4gew0KICogICAgICAgICBjb25zb2xlLmxvZygnZXJyb3InLCBlcnIpDQogKiAgICAgfSkNCiAqDQogKiAgICAgYXdhaXQgd3BjLnN1YnNjcmliZSh0b3BpYywgMikNCiAqICAgICAgICAgLnRoZW4oKHJlcykgPT4gew0KICogICAgICAgICAgICAgY29uc29sZS5sb2coJ3N1YnNjcmliZSB0aGVuJywgcmVzKQ0KICogICAgICAgICAgICAgbXMucHVzaCh7IGNsaWVudElkOiBgc3Vic2NyaWJlYCwgc3Vic2NyaXB0aW9uczogSlNPTi5zdHJpbmdpZnkocmVzKSB9KQ0KICogICAgICAgICB9KQ0KICogICAgICAgICAuY2F0Y2goKGVycikgPT4gew0KICogICAgICAgICAgICAgY29uc29sZS5sb2coJ3N1YnNjcmliZSBjYXRjaCcsIGVycikNCiAqICAgICAgICAgfSkNCiAqDQogKiAgICAgYXdhaXQgd3BjLnB1Ymxpc2godG9waWMsICdyZXN1bHQnLCAyKQ0KICogICAgICAgICAudGhlbigocmVzKSA9PiB7DQogKiAgICAgICAgICAgICBjb25zb2xlLmxvZygncHVibGlzaCB0aGVuJywgcmVzKQ0KICogICAgICAgICAgICAgbXMucHVzaCh7IGNsaWVudElkOiBgcHVibGlzaGAsIHJlcyB9KQ0KICogICAgICAgICB9KQ0KICogICAgICAgICAuY2F0Y2goKGVycikgPT4gew0KICogICAgICAgICAgICAgY29uc29sZS5sb2coJ3B1Ymxpc2ggY2F0Y2gnLCBlcnIpDQogKiAgICAgICAgIH0pDQogKg0KICogICAgIHNldFRpbWVvdXQoYXN5bmMoKSA9PiB7DQogKiAgICAgICAgIGF3YWl0IHdwYy5jbGVhcigpDQogKiAgICAgICAgIHRyeSB7IC8v5L2/55Sod29ya2Vy54mI5pmC6KaB5Y+m5aSW5ZG85Y+rdGVybWluYXRl5Lit5q2iDQogKiAgICAgICAgICAgICB3cGMudGVybWluYXRlKCkNCiAqICAgICAgICAgfQ0KICogICAgICAgICBjYXRjaCAoZXJyKSB7fQ0KICogICAgICAgICBjb25zb2xlLmxvZygnbXMnLCBtcykNCiAqICAgICAgICAgcG0ucmVzb2x2ZShtcykNCiAqICAgICB9LCA1MDAwKQ0KICoNCiAqICAgICByZXR1cm4gcG0NCiAqIH0NCiAqIGF3YWl0IHRlc3QoKQ0KICogICAgIC5jYXRjaCgoZXJyKSA9PiB7DQogKiAgICAgICAgIGNvbnNvbGUubG9nKGVycikNCiAqICAgICB9KQ0KICogLy8gPT4gbXMgWw0KICogLy8gICB7IGNsaWVudElkOiAnY29ubmVjdCcgfSwNCiAqIC8vICAgew0KICogLy8gICAgIGNsaWVudElkOiAnc3Vic2NyaWJlJywNCiAqIC8vICAgICBzdWJzY3JpcHRpb25zOiAnW3sidG9waWMiOiJ0YXNrIiwicW9zIjoyfV0nDQogKiAvLyAgIH0sDQogKiAvLyAgIHsgY2xpZW50SWQ6ICdwdWJsaXNoJywgcmVzOiAnZG9uZScgfSwNCiAqIC8vICAgeyBjbGllbnRJZDogJ3JlY2VpdmUgdG9waWNbdGFza10nIH0sDQogKiAvLyAgIHsgY2xpZW50SWQ6ICdjbG9zZScgfQ0KICogLy8gXQ0KICoNCiAqLwpmdW5jdGlvbiBXUHVic3ViQ2xpZW50KG9wdCA9IHt9KSB7CiAgLy9rZXlNc2cKICBsZXQga2V5TXNnID0gJ19fbXNnX18nOwoKICAvL3VybAogIGxldCB1cmwgPSBnZXQob3B0LCAndXJsJyk7CiAgaWYgKCFpc2VzdHIodXJsKSkgewogICAgdXJsID0gJ21xdHQ6Ly9sb2NhbGhvc3QnOwogIH0KCiAgLy9wb3J0CiAgbGV0IHBvcnQgPSBnZXQob3B0LCAncG9ydCcpOwogIGlmICghaXNwaW50KHBvcnQpKSB7CiAgICBwb3J0ID0gODA4MDsKICB9CiAgcG9ydCA9IGNpbnQocG9ydCk7CgogIC8vdG9rZW4KICBsZXQgdG9rZW4gPSBnZXQob3B0LCAndG9rZW4nKTsKICBpZiAoIWlzZXN0cih0b2tlbikpIHsKICAgIHRva2VuID0gJyc7CiAgfQoKICAvL2NsaWVudElkCiAgbGV0IGNsaWVudElkID0gZ2V0KG9wdCwgJ2NsaWVudElkJyk7CiAgaWYgKCFpc2VzdHIoY2xpZW50SWQpKSB7CiAgICBjbGllbnRJZCA9IGBjbC0ke2dlbklEKCl9YDsKICB9CgogIC8vdGltZVJlY29ubmVjdAogIGxldCB0aW1lUmVjb25uZWN0ID0gZ2V0KG9wdCwgJ3RpbWVSZWNvbm5lY3QnKTsKICBpZiAoIWlzcGludCh0aW1lUmVjb25uZWN0KSkgewogICAgdGltZVJlY29ubmVjdCA9IDIwMDA7CiAgfQogIHRpbWVSZWNvbm5lY3QgPSBjaW50KHRpbWVSZWNvbm5lY3QpOwoKICAvL3VybEJyb2tlcgogIGxldCB1cmxCcm9rZXIgPSBgJHt1cmx9OiR7cG9ydH1gOwoKICAvL2NsaWVudAogIGxldCBjbGllbnQgPSBtcXR0LmNvbm5lY3QodXJsQnJva2VyLCB7CiAgICBjbGllbnRJZCwKICAgIHVzZXJuYW1lOiB0b2tlbiwKICAgIC8v5o+Q5L6bdG9rZW7pqZforYkKICAgIHBhc3N3b3JkOiAnJywKICAgIC8v5LiN5o+Q5L6bCiAgICBjbGVhbjogZmFsc2UsCiAgICAvL+ioreWumuaMgeS5hVNlc3Npb24o6Zui57ea6KOc5pS2KQogICAgcmVjb25uZWN0UGVyaW9kOiB0aW1lUmVjb25uZWN0IC8v5pa357ea5b6M6Ieq5YuV6YeN6YCj5pmC6ZaTCiAgfSk7CgogIC8vZXYKICBsZXQgZXYgPSBldmVtKCk7CgogIC8vb25saW5lCiAgbGV0IG9ubGluZSA9IGZhbHNlOwoKICAvL2Nvbm5lY3QKICBjbGllbnQub24oJ2Nvbm5lY3QnLCAoKSA9PiB7CiAgICAvLyBjb25zb2xlLmxvZyhgY2xpZW50IGluYCwgY2xpZW50SWQpCiAgICBvbmxpbmUgPSB0cnVlOwogICAgZXYuZW1pdCgnY29ubmVjdCcpOwogIH0pOwoKICAvL3JlY29ubmVjdCwg6Ieq5YuV6YeN6YCj5pyf6ZaT5q+P5qyhcmV0cnnpg73mnIPop7jnmbzkuIDmrKEKICBjbGllbnQub24oJ3JlY29ubmVjdCcsICgpID0+IHsKICAgIC8vIGNvbnNvbGUubG9nKGBjbGllbnQgcmVjb25uZWN0YCwgY2xpZW50SWQpCiAgICBldi5lbWl0KCdyZWNvbm5lY3QnKTsKICB9KTsKCiAgLy9zdWJzY3JpYmUKICBsZXQgc3Vic2NyaWJlID0gYXN5bmMgKHRvcGljLCBxb3MgPSAyKSA9PiB7CiAgICAvL3FvczoKICAgIC8vMCwg5pyA5aSa6YCB5LiA5qyhCiAgICAvLzEsIOiHs+WwkemAgeS4gOasoSwg5L+d6K2J6YCB5Yiw5L2G5Y+v6IO96YeN6KSH6YCBCiAgICAvLzIsIOWJm+WlvemAgeS4gOasoSwg5L+d6K2J5Y+q6YCB5LiA5qyh5LiU5LiN6YeN6KSHCgogICAgLy9wbQogICAgbGV0IHBtID0gZ2VuUG0oKTsKCiAgICAvL3dhaXQgb25saW5lCiAgICBhd2FpdCB3YWl0RnVuKCgpID0+IHsKICAgICAgcmV0dXJuIG9ubGluZTsKICAgIH0pOwoKICAgIC8v6KiC6Zax5Li76aGMCiAgICBjbGllbnQuc3Vic2NyaWJlKHRvcGljLCB7CiAgICAgIHFvcwogICAgfSwgKGVyciwgZ3JhbnRlZCkgPT4gewogICAgICAvLyBncmFudGVkID0+IFsKICAgICAgLy8gICB7IHRvcGljOiAnZ2VuZXJhdGUvcmVwb3J0JywgcW9zOiAyIH0sCiAgICAgIC8vICAgeyB0b3BpYzogJ25ld3MvdXBkYXRlJywgcW9zOiAxIH0KICAgICAgLy8gXQogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcG0ucmVqZWN0KGVycik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcG0ucmVzb2x2ZShncmFudGVkKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcG07CiAgfTsKCiAgLy91bnN1YnNjcmliZQogIGxldCB1bnN1YnNjcmliZSA9IGFzeW5jIHRvcGljID0+IHsKICAgIC8vcG0KICAgIGxldCBwbSA9IGdlblBtKCk7CgogICAgLy/lj5bmtojoqILplrHkuLvpoYwKICAgIGNsaWVudC51bnN1YnNjcmliZSh0b3BpYywgZXJyID0+IHsKICAgICAgaWYgKGVycikgewogICAgICAgIHBtLnJlamVjdChlcnIpOwogICAgICB9IGVsc2UgewogICAgICAgIHBtLnJlc29sdmUoKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcG07CiAgfTsKCiAgLy9wdWJsaXNoCiAgbGV0IHB1Ymxpc2ggPSBhc3luYyAodG9waWMsIG1zZywgcW9zID0gMikgPT4gewogICAgLy9xb3M6CiAgICAvLzAsIOacgOWkmumAgeS4gOasoQogICAgLy8xLCDoh7PlsJHpgIHkuIDmrKEsIOS/neitiemAgeWIsOS9huWPr+iDvemHjeikh+mAgQogICAgLy8yLCDliZvlpb3pgIHkuIDmrKEsIOS/neitieWPqumAgeS4gOasoeS4lOS4jemHjeikhwoKICAgIC8vcGF5bG9hZCwg5Z6L5Yil5Y+v5pSv5o+0OiBTdHJpbmcsIEJ1ZmZlciwgVWludDhBcnJheSwgTnVtYmVyLCBPYmplY3Qo6KaBSlNPTi5zdHJpbmdpZnkpCiAgICBsZXQgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KHsKICAgICAgW2tleU1zZ106IG1zZwogICAgfSk7IC8v5bCB6KOd6IezbXNn5Y+v57Ch5YyW5L2/55So5Z6L5YilLCDlg4XmlK/mj7RPYmplY3QsIFN0cmluZywgTnVtYmVyLCBCb29sZWFuCiAgICAvLyBjb25zb2xlLmxvZygnbXNnJywgbXNnKQogICAgLy8gY29uc29sZS5sb2coJ3BheWxvYWQnLCBwYXlsb2FkKQoKICAgIC8vcG0KICAgIGxldCBwbSA9IGdlblBtKCk7CgogICAgLy/nmbzluIPkuLvpoYwKICAgIGNsaWVudC5wdWJsaXNoKHRvcGljLCBwYXlsb2FkLCB7CiAgICAgIHFvcwogICAgfSwgZXJyID0+IHsKICAgICAgaWYgKGVycikgewogICAgICAgIHBtLnJlamVjdChlcnIpOwogICAgICB9IGVsc2UgewogICAgICAgIHBtLnJlc29sdmUoJ2RvbmUnKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcG07CiAgfTsKCiAgLy9tZXNzYWdlCiAgY2xpZW50Lm9uKCdtZXNzYWdlJywgKHRvcGljLCBtZXNzYWdlKSA9PiB7CiAgICAvLyBjb25zb2xlLmxvZyhgY2xpZW50IHJlY2VpdmVgLCBjbGllbnRJZCwgdG9waWMsIG1lc3NhZ2UpCiAgICBsZXQgX21lc3NhZ2UgPSAnJzsKICAgIHRyeSB7CiAgICAgIGxldCBqID0gbWVzc2FnZS50b1N0cmluZygpOyAvL21xdHTmjqXmlLZtZXNzYWdl5pmC5pyD6K6K5oiQQnVmZmVyLCDlvpfovYltZXNzYWdlLnRvU3RyaW5nKCkKICAgICAgLy8gY29uc29sZS5sb2coJ21lc3NhZ2UgaicsIGopCiAgICAgIGxldCBvID0gajJvKGopOwogICAgICAvLyBjb25zb2xlLmxvZygnbWVzc2FnZSBvJywgbykKICAgICAgX21lc3NhZ2UgPSBnZXQobywga2V5TXNnLCAnJyk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgY29uc29sZS5sb2coZXJyKTsKICAgIH0KICAgIGV2LmVtaXQoJ21lc3NhZ2UnLCB7CiAgICAgIHRvcGljLAogICAgICBtZXNzYWdlOiBfbWVzc2FnZQogICAgfSk7CiAgfSk7CgogIC8vIC8vc2ltcGxpZnlFcnJvcgogIC8vIGxldCBzaW1wbGlmeUVycm9yID0gKGVycikgPT4gewogIC8vICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQWdncmVnYXRlRXJyb3IgJiYgQXJyYXkuaXNBcnJheShlcnIuZXJyb3JzKSkgewogIC8vICAgICAgICAgcmV0dXJuIGVyci5lcnJvcnMubWFwKGUgPT4gYFske2UuYWRkcmVzc306JHtlLnBvcnR9XSAke2UuY29kZX1gKS5qb2luKCcgfCAnKQogIC8vICAgICB9CiAgLy8gICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikgewogIC8vICAgICAgICAgcmV0dXJuIGVyci5tZXNzYWdlIHx8IFN0cmluZyhlcnIpCiAgLy8gICAgIH0KICAvLyAgICAgcmV0dXJuIFN0cmluZyhlcnIpCiAgLy8gfQoKICAvL2Vycm9yCiAgY2xpZW50Lm9uKCdlcnJvcicsIGVyciA9PiB7CiAgICAvLyBjb25zb2xlLmxvZyhgY2xpZW50IGVycm9yYCwgY2xpZW50SWQsIGVyci5tZXNzYWdlKQogICAgZXYuZW1pdCgnZXJyb3InLCBlcnIpOwogICAgLy8gZXYuZW1pdCgnZXJyb3InLCBzaW1wbGlmeUVycm9yKGVyciksIGVycikKICB9KTsKCiAgLy9vZmZsaW5lLCBjbGllbnTliKTlrprlt7Lpm6Lnt5rnhKHms5Xlho3oiIdicm9rZXLmup3pgJrmmYLop7jnmbwKICBjbGllbnQub24oJ29mZmxpbmUnLCAoKSA9PiB7CiAgICAvLyBjb25zb2xlLmxvZyhgY2xpZW50IG9mZmxpbmVgLCBjbGllbnRJZCkKICAgIG9ubGluZSA9IGZhbHNlOwogICAgZXYuZW1pdCgnb2ZmbGluZScpOwogIH0pOwoKICAvL2Nsb3NlCiAgY2xpZW50Lm9uKCdjbG9zZScsICgpID0+IHsKICAgIC8vIGNvbnNvbGUubG9nKGBjbGllbnQgY2xvc2VgLCBjbGllbnRJZCkKICAgIG9ubGluZSA9IGZhbHNlOwogICAgZXYuZW1pdCgnY2xvc2UnKTsKICB9KTsKCiAgLy9lbmQsIOWRvOWPq2NsaWVudC5lbmQoKeW+jOinuOeZvAogIGNsaWVudC5vbignZW5kJywgKCkgPT4gewogICAgLy8gY29uc29sZS5sb2coYGNsaWVudCBlbmRgLCBjbGllbnRJZCkKICAgIG9ubGluZSA9IGZhbHNlOwogICAgZXYuZW1pdCgnZW5kJyk7CiAgfSk7CgogIC8vY2xlYXIKICBsZXQgY2xlYXIgPSAoKSA9PiB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICBjbGllbnQuZW5kKGZhbHNlLCB7fSwgZXJyID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgfQogICAgICAgIHJlc29sdmUoKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvL3NhdmUKICBldi5zdWJzY3JpYmUgPSBzdWJzY3JpYmU7CiAgZXYudW5zdWJzY3JpYmUgPSB1bnN1YnNjcmliZTsKICBldi5wdWJsaXNoID0gcHVibGlzaDsKICBldi5jbGVhciA9IGNsZWFyOwogIHJldHVybiBldjsKfQoKCgpsZXQgaW5zdGFuY2UgPSBudWxsCmZ1bmN0aW9uIGluaXQoaW5wdXQpewoKICAgIC8vaW5pdAogICAgbGV0IHIKICAgIAogICAgICAgIHIgPSBXUHVic3ViQ2xpZW50KC4uLmlucHV0KQogICAgICAgIAoKICAgIC8vb24KICAgIAoKICAgIHIub24oJ2Nvbm5lY3QnLChtc2cpID0+IHsKCiAgICAgICAgLy9zZW5kTWVzc2FnZQogICAgICAgIGxldCByZXMgPSB7CiAgICAgICAgICAgIG1vZGU6ICdlbWl0JywKICAgICAgICAgICAgZXZOYW1lOiAnY29ubmVjdCcsCiAgICAgICAgICAgIG1zZywKICAgICAgICB9CiAgICAgICAgc2VuZE1lc3NhZ2UocmVzKQoKICAgIH0pCgoKCiAgICByLm9uKCdyZWNvbm5lY3QnLChtc2cpID0+IHsKCiAgICAgICAgLy9zZW5kTWVzc2FnZQogICAgICAgIGxldCByZXMgPSB7CiAgICAgICAgICAgIG1vZGU6ICdlbWl0JywKICAgICAgICAgICAgZXZOYW1lOiAncmVjb25uZWN0JywKICAgICAgICAgICAgbXNnLAogICAgICAgIH0KICAgICAgICBzZW5kTWVzc2FnZShyZXMpCgogICAgfSkKCgoKICAgIHIub24oJ21lc3NhZ2UnLChtc2cpID0+IHsKCiAgICAgICAgLy9zZW5kTWVzc2FnZQogICAgICAgIGxldCByZXMgPSB7CiAgICAgICAgICAgIG1vZGU6ICdlbWl0JywKICAgICAgICAgICAgZXZOYW1lOiAnbWVzc2FnZScsCiAgICAgICAgICAgIG1zZywKICAgICAgICB9CiAgICAgICAgc2VuZE1lc3NhZ2UocmVzKQoKICAgIH0pCgoKCiAgICByLm9uKCdlcnJvcicsKG1zZykgPT4gewoKICAgICAgICAvL3NlbmRNZXNzYWdlCiAgICAgICAgbGV0IHJlcyA9IHsKICAgICAgICAgICAgbW9kZTogJ2VtaXQnLAogICAgICAgICAgICBldk5hbWU6ICdlcnJvcicsCiAgICAgICAgICAgIG1zZywKICAgICAgICB9CiAgICAgICAgc2VuZE1lc3NhZ2UocmVzKQoKICAgIH0pCgoKCiAgICByLm9uKCdvZmZsaW5lJywobXNnKSA9PiB7CgogICAgICAgIC8vc2VuZE1lc3NhZ2UKICAgICAgICBsZXQgcmVzID0gewogICAgICAgICAgICBtb2RlOiAnZW1pdCcsCiAgICAgICAgICAgIGV2TmFtZTogJ29mZmxpbmUnLAogICAgICAgICAgICBtc2csCiAgICAgICAgfQogICAgICAgIHNlbmRNZXNzYWdlKHJlcykKCiAgICB9KQoKCgogICAgci5vbignY2xvc2UnLChtc2cpID0+IHsKCiAgICAgICAgLy9zZW5kTWVzc2FnZQogICAgICAgIGxldCByZXMgPSB7CiAgICAgICAgICAgIG1vZGU6ICdlbWl0JywKICAgICAgICAgICAgZXZOYW1lOiAnY2xvc2UnLAogICAgICAgICAgICBtc2csCiAgICAgICAgfQogICAgICAgIHNlbmRNZXNzYWdlKHJlcykKCiAgICB9KQoKCgogICAgci5vbignZW5kJywobXNnKSA9PiB7CgogICAgICAgIC8vc2VuZE1lc3NhZ2UKICAgICAgICBsZXQgcmVzID0gewogICAgICAgICAgICBtb2RlOiAnZW1pdCcsCiAgICAgICAgICAgIGV2TmFtZTogJ2VuZCcsCiAgICAgICAgICAgIG1zZywKICAgICAgICB9CiAgICAgICAgc2VuZE1lc3NhZ2UocmVzKQoKICAgIH0pCgoKCiAgICAvL3NhdmUKICAgIGluc3RhbmNlID0gcgoKfQoKZnVuY3Rpb24gc2VuZE1lc3NhZ2UoZGF0YSkgewogICAgCiAgICAgICAgcGFyZW50UG9ydC5wb3N0TWVzc2FnZShkYXRhKQogICAgICAgIAp9Cgphc3luYyBmdW5jdGlvbiBydW4oZGF0YSkgewogICAgLy8gY29uc29sZS5sb2coJ2lubmVyIHdvcmtlciBydW4nLGRhdGEpCgogICAgLy9tb2RlCiAgICBsZXQgbW9kZSA9IGRhdGEubW9kZQoKICAgIC8vY2hlY2sKICAgIGlmKG1vZGUgIT09ICdpbml0JyAmJiBtb2RlICE9PSAnY2FsbCcpewogICAgICAgIHJldHVybgogICAgfQoKICAgIC8vaW5pdAogICAgaWYobW9kZSA9PT0gJ2luaXQnKXsKICAgICAgICAKICAgICAgICB0cnl7CgogICAgICAgICAgICAvL3R5cGUKICAgICAgICAgICAgbGV0IHR5cGUgPSBkYXRhLnR5cGUKCiAgICAgICAgICAgIC8vaW5wdXQKICAgICAgICAgICAgbGV0IGlucHV0ID0gZGF0YS5pbnB1dAogICAgCiAgICAgICAgICAgIC8vaW5zdGFuY2UKICAgICAgICAgICAgaWYodHlwZSA9PT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgICAgICBpbml0KC4uLmlucHV0KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYodHlwZSA9PT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBXUHVic3ViQ2xpZW50CiAgICAgICAgICAgIH0KCiAgICAgICAgfQogICAgICAgIGNhdGNoKGVycil7CiAgICAgICAgCiAgICAgICAgICAgIC8vc2VuZE1lc3NhZ2UKICAgICAgICAgICAgbGV0IHJlcyA9IHsKICAgICAgICAgICAgICAgIG1vZGU6ICdlbWl0JywKICAgICAgICAgICAgICAgIGV2TmFtZTogJ2Vycm9yJywKICAgICAgICAgICAgICAgIG1zZzogZXJyLAogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbmRNZXNzYWdlKHJlcykKCiAgICAgICAgfQogICAgICAgICAgICAKICAgIH0KCiAgICAvL2NoZWNrCiAgICBpZihtb2RlID09PSAnY2FsbCcpewogICAgICAgIGxldCBzdGF0ZSA9ICcnCiAgICAgICAgbGV0IG1zZyA9IG51bGwKCiAgICAgICAgdHJ5ewoKICAgICAgICAgICAgLy9mdW4KICAgICAgICAgICAgbGV0IGZ1biA9IGluc3RhbmNlW2RhdGEuZnVuXQoKICAgICAgICAgICAgLy9pbnB1dAogICAgICAgICAgICBsZXQgaW5wdXQgPSBkYXRhLmlucHV0CgogICAgICAgICAgICAvL2V4ZWMKICAgICAgICAgICAgYXdhaXQgZnVuKC4uLmlucHV0KQogICAgICAgICAgICAgICAgLnRoZW4oKHN1YykgPT4gewogICAgICAgICAgICAgICAgICAgIHN0YXRlPSdzdWNjZXNzJwogICAgICAgICAgICAgICAgICAgIG1zZz1zdWMKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgICAgICAgICAgIHN0YXRlPSdlcnJvcicKICAgICAgICAgICAgICAgICAgICBtc2c9ZXJyCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICB9CiAgICAgICAgY2F0Y2goZXJyKXsKICAgICAgICAgICAgc3RhdGUgPSAnZXJyb3InCiAgICAgICAgICAgIG1zZyA9IGVycgogICAgICAgIH0KICAgICAgICAKICAgICAgICAvL3NlbmRNZXNzYWdlCiAgICAgICAgbGV0IHJlcyA9IHsKICAgICAgICAgICAgbW9kZTogJ3JldHVybicsCiAgICAgICAgICAgIGlkOiBkYXRhLmlkLAogICAgICAgICAgICBmdW46IGRhdGEuZnVuLAogICAgICAgICAgICBzdGF0ZSwKICAgICAgICAgICAgbXNnLAogICAgICAgIH0KICAgICAgICBzZW5kTWVzc2FnZShyZXMpCgogICAgfQoKfQoKZnVuY3Rpb24gcmVjdk1lc3NhZ2UoZGF0YSkgewogICAgLy8gY29uc29sZS5sb2coJ2lubmVyIHdvcmtlciByZWN2OicsIGRhdGEpCgogICAgLy9kYXRhUmVjdgogICAgbGV0IGRhdGFSZWN2ID0gZGF0YQoKICAgIC8vcnVuCiAgICBydW4oZGF0YVJlY3YpCgp9CgoKICAgICAgICBwYXJlbnRQb3J0Lm9uKCdtZXNzYWdlJywgcmVjdk1lc3NhZ2UpCiAgICAgICAgCgp0cnl7CiAgICBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAoZXJyKSA9PiB7CiAgICAgICAgY29uc29sZS5sb2coJ2lubmVyOnVuaGFuZGxlZFJlamVjdGlvbicsIGVycikKICAgIH0pCiAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnIpID0+IHsKICAgICAgICBjb25zb2xlLmxvZygnaW5uZXI6dW5jYXVnaHRFeGNlcHRpb24nLCBlcnIpCiAgICB9KQogICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb25Nb25pdG9yJywgKGVycikgPT4gewogICAgICAgIGNvbnNvbGUubG9nKCdpbm5lcjp1bmNhdWdodEV4Y2VwdGlvbk1vbml0b3InLCBlcnIpCiAgICB9KQp9CmNhdGNoKGVycil7fQoK`;//code
	let code=b642str(codeB64);function wrapWorker(){//evem
	let ev=evem();function genWorker(code){//new Worker
	try{return new worker_threads.Worker(code,{eval:true});}catch(err){emitError(err);}}//genWorker
	let wk=genWorker(code);//check, 於瀏覽器端可能會遭遇IE11安全性問題, 或被CSP的worker-src或script-src設定阻擋
	if(!wk){emitError('invalid worker');return null;}function terminate(){if(wk){wk.terminate();wk=undefined;}else {emitError('worker has been terminated');}}function init(){//dataSend
	let dataSend={mode:'init',type:'function',input:[...arguments]//若直接用arguments會無法轉譯
	};//postMessage
	wk.postMessage(dataSend);}function subscribe(){//pm
	let pm=genPm();//id
	let id=genID();//dataSend
	let dataSend={mode:'call',id,fun:'subscribe',input:[...arguments]//若直接用arguments會無法轉譯
	};//postMessage
	wk.postMessage(dataSend);//once
	ev.once(id,res=>{if(res.state==='success'){pm.resolve(res.msg);}else {pm.reject(res.msg);}});return pm;}function unsubscribe(){//pm
	let pm=genPm();//id
	let id=genID();//dataSend
	let dataSend={mode:'call',id,fun:'unsubscribe',input:[...arguments]//若直接用arguments會無法轉譯
	};//postMessage
	wk.postMessage(dataSend);//once
	ev.once(id,res=>{if(res.state==='success'){pm.resolve(res.msg);}else {pm.reject(res.msg);}});return pm;}function publish(){//pm
	let pm=genPm();//id
	let id=genID();//dataSend
	let dataSend={mode:'call',id,fun:'publish',input:[...arguments]//若直接用arguments會無法轉譯
	};//postMessage
	wk.postMessage(dataSend);//once
	ev.once(id,res=>{if(res.state==='success'){pm.resolve(res.msg);}else {pm.reject(res.msg);}});return pm;}function clear(){//pm
	let pm=genPm();//id
	let id=genID();//dataSend
	let dataSend={mode:'call',id,fun:'clear',input:[...arguments]//若直接用arguments會無法轉譯
	};//postMessage
	wk.postMessage(dataSend);//once
	ev.once(id,res=>{if(res.state==='success'){pm.resolve(res.msg);}else {pm.reject(res.msg);}});return pm;}function recvMessage(data){// console.log('outer worker recv:', data)
	//dataRecv
	let dataRecv=data;//mode
	let mode=dataRecv.mode;//check
	if(mode!=='emit'&&mode!=='return'){return;}//emit
	if(mode==='emit'){//emit
	ev.emit(dataRecv.evName,dataRecv.msg);}//return
	if(mode==='return'){//emit
	ev.emit(dataRecv.id,dataRecv);}}//bind recvMessage
	wk.on('message',recvMessage);function emitError(err){ev.emit('error',err);}//bind emitError
	wk.on('error',emitError);//bind emitError for special condition
	wk.on('exit',code=>{//The 'exit' event is emitted once the worker has stopped. If the worker exited by calling process.exit(), the exitCode parameter is the passed exit code. If the worker was terminated, the exitCode parameter is 1.
	if(code!==1){emitError('exit code['+code+'] !== 1');}});//init
	init([...arguments]);//若直接用arguments會無法轉譯
	ev.subscribe=subscribe;ev.unsubscribe=unsubscribe;ev.publish=publish;ev.clear=clear;ev.terminate=terminate;return ev;}//set ww
	ww=wrapWorker;}protectShell();try{process.on('unhandledRejection',err=>{console.log('outer:unhandledRejection',err);});process.on('uncaughtException',err=>{console.log('outer:uncaughtException',err);});process.on('uncaughtExceptionMonitor',err=>{console.log('outer:uncaughtExceptionMonitor',err);});}catch(err){}var ww$1=ww;return ww$1;});})(tempBVTuoBQIcnHc3zLrftD75om4yvwaTDTMNw);var tempBVTuoBQIcnHc3zLrftD75om4yvwaTDTMNwExports=tempBVTuoBQIcnHc3zLrftD75om4yvwaTDTMNw.exports;var nw = /*@__PURE__*/getDefaultExportFromCjs(tempBVTuoBQIcnHc3zLrftD75om4yvwaTDTMNwExports);

	return nw;

}));
