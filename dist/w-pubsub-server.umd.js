/*!
 * w-pubsub-server v1.0.0
 * (c) 2018-2021 yuda-lyu(semisphere)
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("aedes"),require("aedes-persistence-level"),require("net"),require("level")):"function"==typeof define&&define.amd?define(["aedes","aedes-persistence-level","net","level"],e):(t="undefined"!=typeof globalThis?globalThis:t||self)["w-pubsub-server"]=e(t.aedes,t["aedes-persistence-level"],t.net,t.level)}(this,(function(t,e,n,r){"use strict";var o=Array.isArray,i="object"==typeof global&&global&&global.Object===Object&&global,u="object"==typeof self&&self&&self.Object===Object&&self,c=i||u||Function("return this")(),a=c.Symbol,f=Object.prototype,s=f.hasOwnProperty,l=f.toString,p=a?a.toStringTag:void 0;var v=Object.prototype.toString;var h=a?a.toStringTag:void 0;function y(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":h&&h in Object(t)?function(t){var e=s.call(t,p),n=t[p];try{t[p]=void 0;var r=!0}catch(t){}var o=l.call(t);return r&&(e?t[p]=n:delete t[p]),o}(t):function(t){return v.call(t)}(t)}function d(t){return null!=t&&"object"==typeof t}function _(t){return"symbol"==typeof t||d(t)&&"[object Symbol]"==y(t)}var b=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,g=/^\w*$/;function j(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function w(t){if(!j(t))return!1;var e=y(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}var O,m=c["__core-js_shared__"],x=(O=/[^.]+$/.exec(m&&m.keys&&m.keys.IE_PROTO||""))?"Symbol(src)_1."+O:"";var S=Function.prototype.toString;function P(t){if(null!=t){try{return S.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var k=/^\[object .+?Constructor\]$/,z=Function.prototype,A=Object.prototype,C=z.toString,$=A.hasOwnProperty,E=RegExp("^"+C.call($).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function N(t){return!(!j(t)||(e=t,x&&x in e))&&(w(t)?E:k).test(P(t));var e}function M(t,e){var n=function(t,e){return null==t?void 0:t[e]}(t,e);return N(n)?n:void 0}var T=M(Object,"create");var F=Object.prototype.hasOwnProperty;var L=Object.prototype.hasOwnProperty;function q(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function R(t,e){for(var n,r,o=t.length;o--;)if((n=t[o][0])===(r=e)||n!=n&&r!=r)return o;return-1}q.prototype.clear=function(){this.__data__=T?T(null):{},this.size=0},q.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},q.prototype.get=function(t){var e=this.__data__;if(T){var n=e[t];return"__lodash_hash_undefined__"===n?void 0:n}return F.call(e,t)?e[t]:void 0},q.prototype.has=function(t){var e=this.__data__;return T?void 0!==e[t]:L.call(e,t)},q.prototype.set=function(t,e){var n=this.__data__;return this.size+=this.has(t)?0:1,n[t]=T&&void 0===e?"__lodash_hash_undefined__":e,this};var D=Array.prototype.splice;function I(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}I.prototype.clear=function(){this.__data__=[],this.size=0},I.prototype.delete=function(t){var e=this.__data__,n=R(e,t);return!(n<0)&&(n==e.length-1?e.pop():D.call(e,n,1),--this.size,!0)},I.prototype.get=function(t){var e=this.__data__,n=R(e,t);return n<0?void 0:e[n][1]},I.prototype.has=function(t){return R(this.__data__,t)>-1},I.prototype.set=function(t,e){var n=this.__data__,r=R(n,t);return r<0?(++this.size,n.push([t,e])):n[r][1]=e,this};var U=M(c,"Map");function V(t,e){var n,r,o=t.__data__;return("string"==(r=typeof(n=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof e?"string":"hash"]:o.map}function W(t){var e=-1,n=null==t?0:t.length;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}W.prototype.clear=function(){this.size=0,this.__data__={hash:new q,map:new(U||I),string:new q}},W.prototype.delete=function(t){var e=V(this,t).delete(t);return this.size-=e?1:0,e},W.prototype.get=function(t){return V(this,t).get(t)},W.prototype.has=function(t){return V(this,t).has(t)},W.prototype.set=function(t,e){var n=V(this,t),r=n.size;return n.set(t,e),this.size+=n.size==r?0:1,this};function B(t,e){if("function"!=typeof t||null!=e&&"function"!=typeof e)throw new TypeError("Expected a function");var n=function(){var r=arguments,o=e?e.apply(this,r):r[0],i=n.cache;if(i.has(o))return i.get(o);var u=t.apply(this,r);return n.cache=i.set(o,u)||i,u};return n.cache=new(B.Cache||W),n}B.Cache=W;var G,H,J,K=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Q=/\\(\\)?/g,X=(G=function(t){var e=[];return 46===t.charCodeAt(0)&&e.push(""),t.replace(K,(function(t,n,r,o){e.push(r?o.replace(Q,"$1"):n||t)})),e},H=B(G,(function(t){return 500===J.size&&J.clear(),t})),J=H.cache,H),Y=X;var Z=a?a.prototype:void 0,tt=Z?Z.toString:void 0;function et(t){if("string"==typeof t)return t;if(o(t))return function(t,e){for(var n=-1,r=null==t?0:t.length,o=Array(r);++n<r;)o[n]=e(t[n],n,t);return o}(t,et)+"";if(_(t))return tt?tt.call(t):"";var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}function nt(t){return null==t?"":et(t)}function rt(t,e){return o(t)?t:function(t,e){if(o(t))return!1;var n=typeof t;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=t&&!_(t))||g.test(t)||!b.test(t)||null!=e&&t in Object(e)}(t,e)?[t]:Y(nt(t))}function ot(t){if("string"==typeof t||_(t))return t;var e=t+"";return"0"==e&&1/t==-1/0?"-0":e}function it(t,e,n){var r=null==t?void 0:function(t,e){for(var n=0,r=(e=rt(e,t)).length;null!=t&&n<r;)t=t[ot(e[n++])];return n&&n==r?t:void 0}(t,e);return void 0===r?n:r}var ut=Object.prototype;var ct=function(t,e){return function(n){return t(e(n))}}(Object.keys,Object),at=ct,ft=Object.prototype.hasOwnProperty;function st(t){if(n=(e=t)&&e.constructor,e!==("function"==typeof n&&n.prototype||ut))return at(t);var e,n,r=[];for(var o in Object(t))ft.call(t,o)&&"constructor"!=o&&r.push(o);return r}var lt=M(c,"DataView"),pt=M(c,"Promise"),vt=M(c,"Set"),ht=M(c,"WeakMap"),yt="[object Map]",dt="[object Promise]",_t="[object Set]",bt="[object WeakMap]",gt="[object DataView]",jt=P(lt),wt=P(U),Ot=P(pt),mt=P(vt),xt=P(ht),St=y;(lt&&St(new lt(new ArrayBuffer(1)))!=gt||U&&St(new U)!=yt||pt&&St(pt.resolve())!=dt||vt&&St(new vt)!=_t||ht&&St(new ht)!=bt)&&(St=function(t){var e=y(t),n="[object Object]"==e?t.constructor:void 0,r=n?P(n):"";if(r)switch(r){case jt:return gt;case wt:return yt;case Ot:return dt;case mt:return _t;case xt:return bt}return e});var Pt=St;var kt,zt=(kt="length",function(t){return null==t?void 0:t[kt]}),At=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var Ct="\\ud800-\\udfff",$t="["+Ct+"]",Et="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Nt="\\ud83c[\\udffb-\\udfff]",Mt="[^"+Ct+"]",Tt="(?:\\ud83c[\\udde6-\\uddff]){2}",Ft="[\\ud800-\\udbff][\\udc00-\\udfff]",Lt="(?:"+Et+"|"+Nt+")"+"?",qt="[\\ufe0e\\ufe0f]?",Rt=qt+Lt+("(?:\\u200d(?:"+[Mt,Tt,Ft].join("|")+")"+qt+Lt+")*"),Dt="(?:"+[Mt+Et+"?",Et,Tt,Ft,$t].join("|")+")",It=RegExp(Nt+"(?="+Nt+")|"+Dt+Rt,"g");function Ut(t){return function(t){return At.test(t)}(t)?function(t){for(var e=It.lastIndex=0;It.test(t);)++e;return e}(t):zt(t)}function Vt(t){if(null==t)return 0;if(null!=(e=t)&&function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991}(e.length)&&!w(e))return function(t){return"string"==typeof t||!o(t)&&d(t)&&"[object String]"==y(t)}(t)?Ut(t):t.length;var e,n=Pt(t);return"[object Map]"==n||"[object Set]"==n?t.size:st(t).length}function Wt(t){return"[object String]"===Object.prototype.toString.call(t)}function Bt(t){return!(!Wt(t)||""===t)}function Gt(t){return"[object Object]"===Object.prototype.toString.call(t)}function Ht(t){if(Gt(t)){for(let e in t)return!0;return!1}return!1}var Jt=/\s/;var Kt=/^\s+/;function Qt(t){return t?t.slice(0,function(t){for(var e=t.length;e--&&Jt.test(t.charAt(e)););return e}(t)+1).replace(Kt,""):t}var Xt=/^[-+]0x[0-9a-f]+$/i,Yt=/^0b[01]+$/i,Zt=/^0o[0-7]+$/i,te=parseInt;function ee(t){if("number"==typeof t)return t;if(_(t))return NaN;if(j(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=j(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=Qt(t);var n=Yt.test(t);return n||Zt.test(t)?te(t.slice(2),n?2:8):Xt.test(t)?NaN:+t}var ne=1/0;function re(t){return t?(t=ee(t))===ne||t===-1/0?17976931348623157e292*(t<0?-1:1):t==t?t:0:0===t?t:0}function oe(t){var e=re(t),n=e%1;return e==e?n?e-n:e:0}function ie(t){return t!=t}function ue(t){let e=!1;if(Bt(t))e=!isNaN(Number(t));else if(function(t){return"[object Number]"===Object.prototype.toString.call(t)}(t)){if(ie(t))return!1;e=!0}return e}function ce(t){if(!ue(t))return 0;return re(t)}function ae(t){return!!ue(t)&&(t=ce(t),"number"==typeof(e=t)&&e==oe(e));var e}var fe=c.isFinite,se=Math.min;var le=function(t){var e=Math[t];return function(t,n){if(t=ee(t),(n=null==n?0:se(oe(n),292))&&fe(t)){var r=(nt(t)+"e").split("e");return+((r=(nt(e(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return e(t)}}("round"),pe=le;function ve(t){if(!ue(t))return 0;t=ce(t);let e=pe(t);return"0"===String(e)?0:e}function he(t){return"[object Array]"===Object.prototype.toString.call(t)}function ye(t){return!!function(t){return"[object Undefined]"===Object.prototype.toString.call(t)}(t)||(!!function(t){return"[object Null]"===Object.prototype.toString.call(t)}(t)||(!!function(t){if(Gt(t)){for(let e in t)return!1;return!0}return!1}(t)||(!!function(t){return!(!Wt(t)||""!==t)}(t)||(!!function(t){return!!he(t)&&0===t.length}(t)||!!ie(t)))))}function de(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var _e={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}function o(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function i(t,e,r,i,u){if("function"!=typeof r)throw new TypeError("The listener must be a function");var c=new o(r,i||t,u),a=n?n+e:e;return t._events[a]?t._events[a].fn?t._events[a]=[t._events[a],c]:t._events[a].push(c):(t._events[a]=c,t._eventsCount++),t}function u(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function c(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),c.prototype.eventNames=function(){var t,r,o=[];if(0===this._eventsCount)return o;for(r in t=this._events)e.call(t,r)&&o.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},c.prototype.listeners=function(t){var e=n?n+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,u=new Array(i);o<i;o++)u[o]=r[o].fn;return u},c.prototype.listenerCount=function(t){var e=n?n+t:t,r=this._events[e];return r?r.fn?1:r.length:0},c.prototype.emit=function(t,e,r,o,i,u){var c=n?n+t:t;if(!this._events[c])return!1;var a,f,s=this._events[c],l=arguments.length;if(s.fn){switch(s.once&&this.removeListener(t,s.fn,void 0,!0),l){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,e),!0;case 3:return s.fn.call(s.context,e,r),!0;case 4:return s.fn.call(s.context,e,r,o),!0;case 5:return s.fn.call(s.context,e,r,o,i),!0;case 6:return s.fn.call(s.context,e,r,o,i,u),!0}for(f=1,a=new Array(l-1);f<l;f++)a[f-1]=arguments[f];s.fn.apply(s.context,a)}else{var p,v=s.length;for(f=0;f<v;f++)switch(s[f].once&&this.removeListener(t,s[f].fn,void 0,!0),l){case 1:s[f].fn.call(s[f].context);break;case 2:s[f].fn.call(s[f].context,e);break;case 3:s[f].fn.call(s[f].context,e,r);break;case 4:s[f].fn.call(s[f].context,e,r,o);break;default:if(!a)for(p=1,a=new Array(l-1);p<l;p++)a[p-1]=arguments[p];s[f].fn.apply(s[f].context,a)}}return!0},c.prototype.on=function(t,e,n){return i(this,t,e,n,!1)},c.prototype.once=function(t,e,n){return i(this,t,e,n,!0)},c.prototype.removeListener=function(t,e,r,o){var i=n?n+t:t;if(!this._events[i])return this;if(!e)return u(this,i),this;var c=this._events[i];if(c.fn)c.fn!==e||o&&!c.once||r&&c.context!==r||u(this,i);else{for(var a=0,f=[],s=c.length;a<s;a++)(c[a].fn!==e||o&&!c[a].once||r&&c[a].context!==r)&&f.push(c[a]);f.length?this._events[i]=1===f.length?f[0]:f:u(this,i)}return this},c.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&u(this,e)):(this._events=new r,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=n,c.EventEmitter=c,t.exports=c}(_e);var be=de(_e.exports);return function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=it(o,"port");var u;ae(u=i)&&ve(u)>0||(i=8080),i=ve(i);let c=it(o,"storage");Bt(c)||(c="./data");let a=it(o,"tokens");(function(t){return!(!he(t)||0===t.length||1===t.length&&ye(t[0]))})(a)||(a=[]);let f=new Set(a),s=new r.Level(c),l=e(s),p=t({persistence:l,authenticate:(t,e,n,r)=>{if(0===Vt(a))return r(null,!0);if(!Bt(e)){let t=new Error("missing token");return t.returnCode=4,r(t,!1)}let o=function(t){if(!Bt(t)&&!ue(t)&&!_(t))return"";let e="";try{e=String(t)}catch(t){}try{e=t.toString()}catch(t){}return e}(e);if(f.has(o))return r(null,!0);let i=new Error("invalid token");return i.returnCode=4,r(i,!1)}}),v=n.createServer(p.handle);v.listen(i,(()=>{h.emit("server-listen",{port:i})})),v.on("error",(t=>{h.emit("server-error",t)}));let h=new be;return p.on("client",(t=>{h.emit("client-in",t.id),t.on("error",(e=>{h.emit("client-error",t.id,e)}))})),p.on("subscribe",((t,e)=>{Ht(e)&&h.emit("subscribe",e.id,t)})),p.on("publish",((t,e)=>{Ht(e)&&h.emit("publish",e.id,t.topic,t.payload,t.qos)})),p.on("clientDisconnect",(t=>{h.emit("client-out",t.id)})),p.on("error",(t=>{h.emit("broker-error",t)})),h.clear=async()=>{await new Promise(((t,e)=>{p.close((n=>{if(n)return e(n);t()}))})),await new Promise(((t,e)=>{v.close((n=>{if(n)return e(n);t()}))}))},h}}));
//# sourceMappingURL=w-pubsub-server.umd.js.map
